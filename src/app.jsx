// CritterTrack Frontend Application
import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import { useParams, useNavigate, useLocation, Routes, Route, Link as RouterLink } from 'react-router-dom';
import axios from 'axios';
import { LogOut, Cat, UserPlus, LogIn, ChevronLeft, ChevronUp, ChevronDown, Trash2, Edit, Save, PlusCircle, Plus, ArrowLeft, Loader2, RefreshCw, User, Users, ClipboardList, BookOpen, Settings, Mail, Globe, Bean, Milk, Search, X, Mars, Venus, Eye, EyeOff, Heart, HeartOff, HeartHandshake, Bell, XCircle, CheckCircle, Download, FileText, Link, AlertCircle, DollarSign, Archive, ArrowLeftRight, RotateCcw, Info, Hourglass, MessageSquare, Ban, Flag, Scissors, VenusAndMars, Circle, Shield, Lock, AlertTriangle, ShoppingBag, Check, Star, Moon, MoonStar, Calculator, Network, LayoutGrid, Home, Utensils, Wrench, Activity, ScrollText, Package, Calendar } from 'lucide-react';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import 'flag-icons/css/flag-icons.min.css';
import { formatDate, formatDateShort } from './utils/dateFormatter';
import MouseGeneticsCalculator from './components/MouseGeneticsCalculator';
import GeneticCodeBuilder from './components/GeneticCodeBuilder';
import BudgetingTab from './components/BudgetingTab';
import TermsOfService from './components/TermsOfService';
import PrivacyPolicy from './components/PrivacyPolicy';
import InstallPWA from './components/InstallPWA';
import AdminPanel from './components/EnhancedAdminPanel';
import MaintenanceMode from './MaintenanceMode';
import { TUTORIAL_LESSONS } from './data/tutorialLessonsNew';
import DatePicker from './components/DatePicker';
import InfoTab from './components/InfoTab';
import WelcomeGuideModal from './components/WelcomeGuideModal';
import ReportButton from './components/ReportButton';
import ModerationAuthModal from './components/moderation/ModerationAuthModal';
import ModOversightPanel from './components/moderation/ModOversightPanel';
import ModeratorActionSidebar from './components/moderation/ModeratorActionSidebar';
import Marketplace from './components/Marketplace';
import FamilyTree from './components/FamilyTree';
import AnimalTree from './components/AnimalTree';

// const API_BASE_URL = 'http://localhost:5000/api'; // Local development
// const API_BASE_URL = 'https://crittertrack-pedigree-production.up.railway.app/api'; // Direct Railway (for testing)
const API_BASE_URL = '/api'; // Production via Vercel proxy - v2

// App version for cache invalidation - increment to force cache clear
const APP_VERSION = '7.0.3';

const GENDER_OPTIONS = ['Male', 'Female', 'Intersex', 'Unknown'];
const STATUS_OPTIONS = ['Pet', 'Breeder', 'Available', 'Booked', 'Sold', 'Retired', 'Deceased', 'Rehomed', 'Unknown']; 

const DEFAULT_SPECIES_OPTIONS = ['Fancy Mouse', 'Fancy Rat', 'Russian Dwarf Hamster', 'Campbells Dwarf Hamster', 'Chinese Dwarf Hamster', 'Syrian Hamster', 'Guinea Pig'];

// Helper function to get plural/display names for species
const getSpeciesEmoji = (speciesName) => {
    const emojiMap = {
        // Small mammals
        'Fancy Mouse': '🐭', 'Mouse': '🐭',
        'Fancy Rat': '🐀', 'Rat': '🐀',
        'Syrian Hamster': '🐹', 'Roborovski Dwarf Hamster': '🐹',
        'Russian Dwarf Hamster': '🐹', 'Campbells Dwarf Hamster': '🐹', 'Chinese Dwarf Hamster': '🐹', 'Hamster': '🐹',
        'Guinea Pig': '🐾', 'Gerbil': '🐭', 'Fat-tailed Gerbil': '🐭', 'Fat-tailed gerbil': '🐭',
        'Degu': '🐾', 'Chinchilla': '🐭', 'African Pygmy Mouse': '🐭', 'African Pygmy Dormouse': '🐭',
        // Full mammals
        'Rabbit': '🐰', 'Ferret': '🦦', 'Hedgehog': '🦔', 'Sugar Glider': '🐿️',
        'Prairie Dog': '🐾', 'Cat': '🐱', 'Dog': '🐶',
        // Reptiles
        'Leopard Gecko': '🦎', 'Crested Gecko': '🦎', 'Gargoyle Gecko': '🦎',
        'Bearded Dragon': '🦎', 'Blue-Tongued Skink': '🦎', 'Chameleon': '🦎',
        'Ball Python': '🐍', 'Corn Snake': '🐍', 'Cape African House Snake': '🐍',
        'Red-Eared Slider': '🐢', 'Russian Tortoise': '🐢',
        // Birds
        'Budgie': '🦜', 'Budgerigar': '🦜', 'Cockatiel': '🦜', 'Lovebird': '🦜',
        'Conure': '🦜', 'African Grey Parrot': '🦜', 'Macaw': '🦜', 'Cockatoo': '🦜',
        'Canary': '🐦', 'Zebra Finch': '🐦', 'Dove': '🕊️',
        // Amphibians
        'Axolotl': '🐾', 'Pacman Frog': '🐸', 'Dart Poison Frog': '🐸',
        "White's Tree Frog": '🐸', 'Fire-Bellied Toad': '🐸', 'Tomato Frog': '🐸', 'Tiger Salamander': '🦎',
        // Fish
        'Betta Fish': '🐠', 'Guppy': '🐠', 'Platy': '🐠',
        'Fancy Goldfish': '🐟', 'Koi': '🐟', 'Discus': '🐟', 'Angelfish': '🐟', 'Corydoras': '🐟', 'Oscar': '🐟',
        // Invertebrates
        'Tarantula': '🕷️', 'Jumping Spider': '🕷️', 'Scorpion': '🦂',
        'Giant African Millipede': '🐛', 'Praying Mantis': '🦗', 'Stick Insect': '🦗',
        'Hissing Cockroach': '🦗', 'Hermit Crab': '🦀', 'Land Snail': '🐌',
        'Honey Bee': '🐝', 'Bumble Bee': '🐝',
        // Default
        'Other': '🐾',
    };
    return emojiMap[speciesName] || '🐾';
};

const getSpeciesDisplayName = (species) => {
    const displayNames = {
        'Fancy Mouse': 'Fancy Mice',
        'Mouse': 'Fancy Mice', // Backwards compatibility
        'Fancy Rat': 'Fancy Rats',
        'Rat': 'Fancy Rats', // Backwards compatibility
        'Russian Dwarf Hamster': 'Russian Dwarf Hamsters',
        'Campbells Dwarf Hamster': 'Campbells Dwarf Hamsters',
        'Chinese Dwarf Hamster': 'Chinese Dwarf Hamsters',
        'Syrian Hamster': 'Syrian Hamsters',
        'Hamster': 'Hamsters', // Backwards compatibility
        'Guinea Pig': 'Guinea Pigs'
    };
    return displayNames[species] || species;
};

// Map species to their latin names for display
const getSpeciesLatinName = (species) => {
    const latinNames = {
        'Fancy Mouse': 'Mus musculus',
        'Mouse': 'Mus musculus',
        'Fancy Rat': 'Rattus norvegicus',
        'Rat': 'Rattus norvegicus',
        'Russian Dwarf Hamster': 'Phodopus sungorus',
        'Campbells Dwarf Hamster': 'Phodopus campbelli',
        'Chinese Dwarf Hamster': 'Cricetulus barabensis',
        'Syrian Hamster': 'Mesocricetus auratus',
        'Guinea Pig': 'Cavia porcellus'
    };
    return latinNames[species] || null;
};

// Helper function to get flag class from country code (for flag-icons library)
const getCountryFlag = (countryCode) => {
    if (!countryCode || countryCode.length !== 2) return '';
    return `fi fi-${countryCode.toLowerCase()}`;
};

// Get country name from code
const getCountryName = (countryCode) => {
    const countryNames = {
        'US': 'United States', 'CA': 'Canada', 'GB': 'United Kingdom', 'AU': 'Australia',
        'NZ': 'New Zealand', 'DE': 'Germany', 'FR': 'France', 'IT': 'Italy',
        'ES': 'Spain', 'NL': 'Netherlands', 'SE': 'Sweden', 'NO': 'Norway',
        'DK': 'Denmark', 'CH': 'Switzerland', 'BE': 'Belgium', 'AT': 'Austria',
        'PL': 'Poland', 'CZ': 'Czech Republic', 'IE': 'Ireland', 'PT': 'Portugal',
        'GR': 'Greece', 'RU': 'Russia', 'JP': 'Japan', 'KR': 'South Korea',
        'CN': 'China', 'IN': 'India', 'BR': 'Brazil', 'MX': 'Mexico',
        'ZA': 'South Africa', 'SG': 'Singapore', 'HK': 'Hong Kong', 'MY': 'Malaysia', 'TH': 'Thailand'
    };
    return countryNames[countryCode] || countryCode;
};

const US_STATES = [
    {code:'AL',name:'Alabama'},{code:'AK',name:'Alaska'},{code:'AZ',name:'Arizona'},{code:'AR',name:'Arkansas'},
    {code:'CA',name:'California'},{code:'CO',name:'Colorado'},{code:'CT',name:'Connecticut'},{code:'DE',name:'Delaware'},
    {code:'FL',name:'Florida'},{code:'GA',name:'Georgia'},{code:'HI',name:'Hawaii'},{code:'ID',name:'Idaho'},
    {code:'IL',name:'Illinois'},{code:'IN',name:'Indiana'},{code:'IA',name:'Iowa'},{code:'KS',name:'Kansas'},
    {code:'KY',name:'Kentucky'},{code:'LA',name:'Louisiana'},{code:'ME',name:'Maine'},{code:'MD',name:'Maryland'},
    {code:'MA',name:'Massachusetts'},{code:'MI',name:'Michigan'},{code:'MN',name:'Minnesota'},{code:'MS',name:'Mississippi'},
    {code:'MO',name:'Missouri'},{code:'MT',name:'Montana'},{code:'NE',name:'Nebraska'},{code:'NV',name:'Nevada'},
    {code:'NH',name:'New Hampshire'},{code:'NJ',name:'New Jersey'},{code:'NM',name:'New Mexico'},{code:'NY',name:'New York'},
    {code:'NC',name:'North Carolina'},{code:'ND',name:'North Dakota'},{code:'OH',name:'Ohio'},{code:'OK',name:'Oklahoma'},
    {code:'OR',name:'Oregon'},{code:'PA',name:'Pennsylvania'},{code:'RI',name:'Rhode Island'},{code:'SC',name:'South Carolina'},
    {code:'SD',name:'South Dakota'},{code:'TN',name:'Tennessee'},{code:'TX',name:'Texas'},{code:'UT',name:'Utah'},
    {code:'VT',name:'Vermont'},{code:'VA',name:'Virginia'},{code:'WA',name:'Washington'},{code:'WV',name:'West Virginia'},
    {code:'WI',name:'Wisconsin'},{code:'WY',name:'Wyoming'},{code:'DC',name:'Washington D.C.'}
];
const getStateName = (stateCode) => {
    if (!stateCode) return '';
    const found = US_STATES.find(s => s.code === stateCode);
    return found ? found.name : stateCode;
};

// Get currency symbol from currency code
const getCurrencySymbol = (currencyCode) => {
    const currencySymbols = {
        'USD': '$', 'EUR': '�', 'GBP': '�', 'JPY': '�', 'CNY': '�', 'KRW': '?',
        'CAD': 'C$', 'AUD': 'A$', 'CHF': 'CHF', 'SEK': 'kr', 'NOK': 'kr', 'DKK': 'kr',
        'PLN': 'zl', 'CZK': 'Kc', 'HUF': 'Ft', 'RON': 'lei', 'BGN': 'лв', 'HRK': 'kn',
        'RUB': '₽', 'UAH': '₴', 'TRY': '₺', 'ILS': '₪', 'AED': 'د.إ', 'SAR': '﷼',
        'INR': '₹', 'PKR': '₨', 'BDT': '৳', 'LKR': 'Rs', 'THB': '฿', 'VND': '₫',
        'IDR': 'Rp', 'MYR': 'RM', 'SGD': 'S$', 'PHP': '₱', 'HKD': 'HK$', 'TWD': 'NT$',
        'NZD': 'NZ$', 'ZAR': 'R', 'EGP': 'E�', 'NGN': '?', 'KES': 'Sh', 'GHS': '?',
        'BRL': 'R$', 'ARS': '$', 'CLP': '$', 'COP': '$', 'PEN': 'S/', 'MXN': '$'
    };
    return currencySymbols[currencyCode] || currencyCode || '';
};

// Helper function to get donation badge for a user
const getDonationBadge = (user) => {
    if (!user) return null;
    
    const now = new Date();
    
    // Check for monthly subscription (diamond badge)
    if (user.monthlyDonationActive) {
        return {
            type: 'diamond',
            icon: '💎',
            title: 'Monthly Supporter',
            className: 'bg-gradient-to-r from-blue-400 to-purple-500 text-white'
        };
    }
    
    // Check for one-time donation within last 31 days (gift badge)
    if (user.lastDonationDate) {
        const lastDonation = new Date(user.lastDonationDate);
        const daysSince = Math.floor((now - lastDonation) / (1000 * 60 * 60 * 24));
        
        if (daysSince <= 31) {
            return {
                type: 'gift',
                icon: '💎',
                title: 'Recent Supporter',
                className: 'bg-gradient-to-r from-green-400 to-blue-500 text-white'
            };
        }
    }
    
    return null;
};

// Donation Badge Component
const DonationBadge = ({ user, size = 'sm' }) => {
    const badge = getDonationBadge(user);
    if (!badge) return null;
    
    const sizeClasses = {
        xs: 'text-xs px-1 py-0.5',
        sm: 'text-xs px-1.5 py-0.5', 
        md: 'text-sm px-2 py-1',
        lg: 'text-base px-2 py-1'
    };
    
    return (
        <span 
            className={`inline-flex items-center gap-1 rounded-full font-medium shadow-sm ${badge.className} ${sizeClasses[size]}`}
            title={badge.title}
        >
            <span>{badge.icon}</span>
            {size === 'lg' && <span>{badge.title}</span>}
        </span>
    );
};

const IDLE_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes in milliseconds

// Helper function to format date strings for display
const formatDateDisplay = (dateString) => {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        return formatDateShort(date);
    } catch (e) {
        return dateString; // Return as-is if parsing fails
    }
};

// Formats a date/ISO string as a relative time phrase (e.g. "2 hours ago")
const formatTimeAgo = (dateStr) => {
    if (!dateStr) return '';
    const now = new Date();
    const then = new Date(dateStr);
    if (isNaN(then.getTime())) return '';
    const diffMs = now - then;
    const diffSec = Math.floor(diffMs / 1000);
    if (diffSec < 60) return 'just now';
    const diffMin = Math.floor(diffSec / 60);
    if (diffMin < 60) return `${diffMin}m ago`;
    const diffHr = Math.floor(diffMin / 60);
    if (diffHr < 24) return `${diffHr}h ago`;
    const diffDays = Math.floor(diffHr / 24);
    if (diffDays < 30) return `${diffDays}d ago`;
    const diffMo = Math.floor(diffDays / 30);
    if (diffMo < 12) return `${diffMo}mo ago`;
    return `${Math.floor(diffMo / 12)}y ago`;
};

// Maps an activity action code to a human-readable label
const getActionLabel = (action) => {
    const labels = {
        login: 'Logged in',
        logout: 'Logged out',
        password_change: 'Changed password',
        profile_update: 'Updated profile',
        profile_image_change: 'Changed profile photo',
        privacy_settings_change: 'Updated privacy settings',
        animal_create: 'Added a new animal',
        animal_update: 'Updated animal',
        animal_delete: 'Deleted animal',
        animal_image_upload: 'Uploaded animal photo',
        animal_image_delete: 'Deleted animal photo',
        animal_visibility_change: 'Changed animal visibility',
        animal_transfer_initiate: 'Initiated animal transfer',
        animal_transfer_accept: 'Accepted animal transfer',
        animal_transfer_reject: 'Rejected animal transfer',
        litter_create: 'Recorded a new litter',
        litter_update: 'Updated litter',
        litter_delete: 'Deleted litter',
        message_send: 'Sent a message',
        message_delete: 'Deleted a message',
        report_submit: 'Submitted a report',
        transaction_create: 'Added a budget transaction',
        transaction_delete: 'Deleted a budget transaction',
    };
    return labels[action] || action?.replace(/_/g, ' ') || 'Unknown action';
};

// Maps an activity action code to a Tailwind bg color class for indicator dots
const getActionColor = (action) => {
    if (!action) return 'bg-gray-300';
    if (action.startsWith('animal_')) return 'bg-accent';
    if (action.startsWith('litter_')) return 'bg-purple-400';
    if (action.startsWith('litter_')) return 'bg-purple-400';
    if (action.startsWith('transaction_')) return 'bg-emerald-400';
    if (action.startsWith('message_')) return 'bg-blue-400';
    if (action === 'login' || action === 'logout') return 'bg-gray-400';
    if (action.startsWith('profile_') || action.startsWith('privacy_')) return 'bg-yellow-400';
    if (action === 'report_submit') return 'bg-red-400';
    return 'bg-gray-300';
};

const ModalMessage = ({ title, message, onClose }) => (
  <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
      <h3 className="text-xl font-bold text-gray-800 mb-3">{title}</h3>
      <p className="text-gray-600 mb-6">{message}</p>
      <button 
        onClick={onClose} 
        className="w-full bg-primary hover:bg-primary/80 text-black font-semibold py-2 rounded-lg transition duration-150 shadow-md"
      >
        Close
      </button>
    </div>
  </div>
);

const CustomAppLogo = ({ size = "w-10 h-10" }) => (
  <div className="relative inline-block">
    <img 
      src="/logo.png" 
      alt="Crittertrack Logo" 
      className={`${size} shadow-md`} 
    />
    <div className="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow-lg transform rotate-12">
      BETA
    </div>
  </div>
);

const LoadingSpinner = () => (
  <div className="flex items-center justify-center p-8">
    <Loader2 className="animate-spin text-primary-dark mr-2" size={24} />
    <span className="text-gray-600">Loading...</span>
  </div>
);

// Reusable animal image component with error handling
const AnimalImage = ({ src, alt = "Animal", className = "w-full h-full object-cover", iconSize = 24 }) => {
    const [imageError, setImageError] = useState(false);
    const [imageSrc, setImageSrc] = useState(src);

    useEffect(() => {
        setImageSrc(src);
        setImageError(false);
    }, [src]);

    const handleError = () => {
        console.warn('Image failed to load:', imageSrc);
        setImageError(true);
    };

    if (!imageSrc || imageError) {
        return <Cat size={iconSize} className="text-gray-400" />;
    }

    return (
        <img 
            src={imageSrc} 
            alt={alt} 
            className={className}
            onError={handleError}
            loading="lazy"
        />
    );
};

// Conflict Resolution Modal Component
const ConflictResolutionModal = ({ conflicts, litter, onResolve, onCancel }) => {
    const [resolutions, setResolutions] = useState({});

    useEffect(() => {
        // Initialize resolutions with default 'breeding' choice for all conflicts
        const initialResolutions = {};
        conflicts.forEach(conflict => {
            initialResolutions[conflict.field] = 'breeding';
        });
        setResolutions(initialResolutions);
    }, [conflicts]);

    const handleResolutionChange = (field, choice) => {
        setResolutions(prev => ({
            ...prev,
            [field]: choice
        }));
    };

    const handleResolve = () => {
        const resolutionArray = Object.entries(resolutions).map(([field, choice]) => ({
            field,
            choice
        }));
        onResolve(resolutionArray);
    };

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-96 overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-gray-800">Resolve Data Conflicts</h3>
                    <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                    </button>
                </div>
                
                <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p className="text-yellow-800 text-sm">
                        <strong>Linking to Litter:</strong> {litter.litter_id_public}
                    </p>
                    <p className="text-yellow-800 text-sm">
                        Some data conflicts were found between your breeding record and the litter. Please choose which values to keep.
                    </p>
                </div>

                <div className="space-y-4">
                    {conflicts.map((conflict) => (
                        <div key={conflict.field} className="border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-gray-700 mb-3">{conflict.label}</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                        type="radio"
                                        name={conflict.field}
                                        value="breeding"
                                        checked={resolutions[conflict.field] === 'breeding'}
                                        onChange={() => handleResolutionChange(conflict.field, 'breeding')}
                                        className="text-blue-600"
                                    />
                                    <div className="flex-1">
                                        <div className="text-sm font-medium text-blue-600">Keep Breeding Record Value</div>
                                        <div className="text-sm text-gray-600">{conflict.breedingValue}</div>
                                    </div>
                                </label>
                                <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                        type="radio"
                                        name={conflict.field}
                                        value="litter"
                                        checked={resolutions[conflict.field] === 'litter'}
                                        onChange={() => handleResolutionChange(conflict.field, 'litter')}
                                        className="text-green-600"
                                    />
                                    <div className="flex-1">
                                        <div className="text-sm font-medium text-green-600">Use Litter Value</div>
                                        <div className="text-sm text-gray-600">{conflict.litterValue}</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    ))}
                </div>
                
                <div className="flex gap-4 mt-6">
                    <button 
                        type="button" 
                        onClick={onCancel}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition"
                    >
                        Cancel
                    </button>
                    <button 
                        type="button" 
                        onClick={handleResolve}
                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition"
                    >
                        Resolve Conflicts & Link
                    </button>
                </div>
            </div>
        </div>
    );
};

// Pedigree Chart Component
const PedigreeChart = ({ animalId, animalData, onClose, API_BASE_URL, authToken = null }) => {
    const [pedigreeData, setPedigreeData] = useState(null);
    const [ownerProfile, setOwnerProfile] = useState(null);
    const [loading, setLoading] = useState(true);
    const [imagesLoaded, setImagesLoaded] = useState(false);
    const [stackedPedigree, setStackedPedigree] = useState(null); // For nested pedigree viewing
    const pedigreeRef = useRef(null);

    useEffect(() => {
        const fetchPedigreeData = async () => {
            setLoading(true);
            try {
                // Enhanced recursive function to fetch animal, ancestors, and descendants
                // resultCache: Map<id, data> ? avoids redundant API calls but allows the same
                //   ancestor to appear in *multiple* pedigree positions (inbreeding).
                // pathIds: Set of IDs in the current call-chain ? detects true circular loops only.
                const resultCache = new Map();
                const fetchAnimalWithFamily = async (id, depth = 0, pathIds = new Set()) => {
                    if (!id || depth > 4) return null;
                    if (pathIds.has(id)) return null; // circular reference ? stop this branch

                    // Return cached result so the same ancestor shows in multiple pedigree
                    // positions (inbreeding) without redundant API calls
                    if (resultCache.has(id)) return resultCache.get(id);

                    let animalInfo = null;

                    // Try to fetch from owned animals first if authToken is available
                    if (authToken) {
                        try {
                            // First try /animals endpoint for owned animals (includes private)
                            const response = await axios.get(`${API_BASE_URL}/animals/${id}`, {
                                headers: { Authorization: `Bearer ${authToken}` }
                            });
                            animalInfo = response.data;
                        } catch (error) {
                            // Not owned, try /animals/any endpoint for related/accessible animals
                            try {
                                const response = await axios.get(`${API_BASE_URL}/animals/any/${id}`, {
                                    headers: { Authorization: `Bearer ${authToken}` }
                                });
                                animalInfo = response.data;
                            } catch (error2) {
                                console.log(`Animal ${id} not accessible via owned or related endpoints:`, error2.message);
                            }
                        }
                    }

                    // If not found in owned, try public database
                    if (!animalInfo) {
                        try {
                            const publicResponse = await axios.get(`${API_BASE_URL}/public/global/animals?id_public=${id}`);
                            if (publicResponse.data && publicResponse.data.length > 0) {
                                animalInfo = publicResponse.data[0];
                            }
                        } catch (error) {
                            console.log(`Animal ${id} not found in public database:`, error.message);
                            // Don't return null here - continue to check if we should show hidden marker
                        }
                    }

                    // If animal exists but is not public/accessible (has ID but no data), return hidden marker
                    // This ensures parents always show even if they're private
                    if (!animalInfo && id) {
                        return { isHidden: true, id_public: id };
                    }
                    
                    if (!animalInfo) return null;

                    // Use manual breeder name if available, otherwise fetch breeder profile
                    if (animalInfo.manualBreederName) {
                        animalInfo.breederName = animalInfo.manualBreederName;
                    } else if (animalInfo.breederId_public) {
                        try {
                            const breederResponse = await axios.get(
                                `${API_BASE_URL}/public/profiles/search?query=${animalInfo.breederId_public}&limit=1`
                            );
                            if (breederResponse.data && breederResponse.data.length > 0) {
                                const breeder = breederResponse.data[0];
                                const showPersonalName = breeder.showPersonalName ?? false;
                                const showBreederName = breeder.showBreederName ?? false;
                                
                                // Determine breeder display name based on privacy settings
                                let breederName;
                                if (showBreederName && showPersonalName && breeder.personalName && breeder.breederName) {
                                    breederName = `${breeder.personalName} (${breeder.breederName})`;
                                } else if (showBreederName && breeder.breederName) {
                                    breederName = breeder.breederName;
                                } else if (showPersonalName && breeder.personalName) {
                                    breederName = breeder.personalName;
                                } else {
                                    breederName = 'Anonymous Breeder';
                                }
                                animalInfo.breederName = breederName;
                            }
                        } catch (error) {
                            console.error(`Failed to fetch breeder for animal ${id}:`, error);
                        }
                    }

                    // Recursively fetch parents ? each branch gets its own path copy so that
                    // an ancestor appearing on BOTH sides (inbreeding) isn't blocked.
                    const fatherId = animalInfo.fatherId_public || animalInfo.sireId_public;
                    const motherId = animalInfo.motherId_public || animalInfo.damId_public;
                    const childPath = new Set([...pathIds, id]);

                    const father = fatherId ? await fetchAnimalWithFamily(fatherId, depth + 1, childPath) : null;
                    const mother = motherId ? await fetchAnimalWithFamily(motherId, depth + 1, childPath) : null;

                    // Fetch offspring (children) if user is authenticated and depth allows
                    let offspring = [];
                    if (authToken && depth < 3) { // Limit offspring fetching to prevent too deep trees
                        try {
                            const offspringResponse = await axios.get(
                                `${API_BASE_URL}/animals/${id}/offspring`,
                                { headers: { Authorization: `Bearer ${authToken}` } }
                            );
                            
                            if (offspringResponse.data && offspringResponse.data.length > 0) {
                                // Recursively fetch offspring details but limit depth to prevent infinite expansion
                                for (const child of offspringResponse.data.slice(0, 15)) { // Limit to first 15 offspring per animal to accommodate larger mouse litters
                                    const childData = await fetchAnimalWithFamily(child.id_public, depth + 1, childPath);
                                    if (childData) {
                                        offspring.push(childData);
                                    }
                                }
                            }
                        } catch (error) {
                            console.log(`No offspring data available for ${id}:`, error.message);
                        }
                    }

                    const result = {
                        ...animalInfo,
                        father,
                        mother,
                        offspring: offspring.length > 0 ? offspring : undefined
                    };
                    resultCache.set(id, result);
                    return result;
                };

                const data = await fetchAnimalWithFamily(animalId || animalData?.id_public);
                setPedigreeData(data);

                // Fetch owner profile for the main animal
                if (data?.ownerId_public || data?.breederId_public) {
                    try {
                        const ownerId = data.ownerId_public || data.breederId_public;
                        console.log('[PEDIGREE] Fetching owner profile for ID:', ownerId);
                        const ownerResponse = await axios.get(
                            `${API_BASE_URL}/public/profiles/search?query=${ownerId}&limit=1`
                        );
                        console.log('[PEDIGREE] Owner profile response:', ownerResponse.data);
                        if (ownerResponse.data && ownerResponse.data.length > 0) {
                            const profile = ownerResponse.data[0];
                            console.log('[PEDIGREE] Owner profile data:', {
                                personalName: profile.personalName,
                                breederName: profile.breederName,
                                showBreederName: profile.showBreederName,
                                profileImage: profile.profileImage,
                                profileImageUrl: profile.profileImageUrl,
                                id_public: profile.id_public
                            });
                            setOwnerProfile(profile);
                        }
                    } catch (error) {
                        console.error('Failed to fetch owner profile:', error);
                    }
                }
            } catch (error) {
                console.error('Error fetching pedigree data:', error);
            } finally {
                setLoading(false);
            }
        };

        fetchPedigreeData();
    }, [animalId, animalData, API_BASE_URL, authToken]);

    // Check when all images are loaded
    useEffect(() => {
        if (!pedigreeRef.current || loading) return;

        const checkImagesLoaded = () => {
            const images = pedigreeRef.current.querySelectorAll('img');
            const allLoaded = Array.from(images).every(img => img.complete);
            setImagesLoaded(allLoaded);
        };

        // Initial check
        checkImagesLoaded();

        // Listen for image load events
        const images = pedigreeRef.current.querySelectorAll('img');
        const handleImageLoad = () => checkImagesLoaded();
        
        images.forEach(img => {
            img.addEventListener('load', handleImageLoad);
            img.addEventListener('error', handleImageLoad);
        });

        return () => {
            images.forEach(img => {
                img.removeEventListener('load', handleImageLoad);
                img.removeEventListener('error', handleImageLoad);
            });
        };
    }, [loading, pedigreeData]);

    const downloadPDF = async () => {
        if (!pedigreeRef.current) return;

        try {
            // Store original styles
            const originalWidth = pedigreeRef.current.style.width;
            const originalHeight = pedigreeRef.current.style.height;
            const originalAspectRatio = pedigreeRef.current.style.aspectRatio;
            const originalMinHeight = pedigreeRef.current.style.minHeight;
            const originalPadding = pedigreeRef.current.style.padding;

            // Set fixed dimensions for PDF generation
            pedigreeRef.current.style.width = '1400px';
            pedigreeRef.current.style.height = '1000px';
            pedigreeRef.current.style.aspectRatio = 'unset';
            pedigreeRef.current.style.minHeight = 'unset';
            pedigreeRef.current.style.overflow = 'visible';
            pedigreeRef.current.style.padding = '70px 20px 20px 20px'; // More top padding for vertical centering

            // Wait for layout to stabilize and images to load
            await new Promise(resolve => setTimeout(resolve, 500));

            const canvas = await html2canvas(pedigreeRef.current, {
                scale: 3,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                letterRendering: true,
                windowWidth: 1400,
                windowHeight: 1000,
                imageTimeout: 15000,
                removeContainer: true,
                scrollX: 0,
                scrollY: 0
            });

            // Restore original styles
            pedigreeRef.current.style.width = originalWidth;
            pedigreeRef.current.style.height = originalHeight;
            pedigreeRef.current.style.aspectRatio = originalAspectRatio;
            pedigreeRef.current.style.minHeight = originalMinHeight;
            pedigreeRef.current.style.padding = originalPadding;

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [1400, 1000]
            });

            // Add image at exact dimensions without scaling
            pdf.addImage(imgData, 'PNG', 0, 0, 1400, 1000);
            pdf.save(`pedigree-${pedigreeData?.name || 'chart'}.pdf`);
        } catch (error) {
            console.error('Error generating PDF:', error);
            // Restore images even if there's an error
            const imageContainers = pedigreeRef.current?.querySelectorAll('.hide-for-pdf');
            imageContainers?.forEach(el => el.style.display = '');
        }
    };

    // Render card for main animal (larger with image)
    const renderMainAnimalCard = (animal) => {
        if (!animal) return null;
        
        const imgSrc = animal.imageUrl || animal.photoUrl || null;
        const colorCoat = [animal.color, animal.coatPattern, animal.coat].filter(Boolean).join(' ') || 'N/A';
        
        // Determine gender-based styling
        const isMale = animal.gender === 'Male';
        const bgColor = isMale ? 'bg-[#d4f1f5]' : 'bg-[#f8e8ee]';
        const GenderIcon = isMale ? Mars : Venus;
        
        return (
            <div className={`border border-gray-700 rounded-lg p-2 ${bgColor} relative flex gap-3 items-center`} style={{height: window.innerWidth < 640 ? '140px' : '160px'}}>
                {/* Image */}
                <div className="hide-for-pdf w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center flex-shrink-0 border-2 border-gray-900">
                    {imgSrc ? (
                        <AnimalImage src={imgSrc} alt={animal.name} className="w-full h-full object-cover" iconSize={window.innerWidth < 640 ? 24 : 32} />
                    ) : (
                        <Cat size={window.innerWidth < 640 ? 24 : 32} className="text-gray-400" />
                    )}
                </div>
                
                {/* Info */}
                <div className="flex-1 min-w-0 flex flex-col justify-start gap-2 py-2">
                    {/* Name */}
                    <div className="text-sm text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-bold">Name: </span>{animal.prefix && `${animal.prefix} `}{animal.name}{animal.suffix && ` ${animal.suffix}`}
                    </div>
                    
                    {/* Variety */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Variety: </span>
                        {colorCoat}
                    </div>
                    
                    {/* Genetic Code */}
                    {animal.geneticCode && (
                        <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                            <span className="font-semibold">Code: </span>
                            {animal.geneticCode}
                        </div>
                    )}
                    
                    {/* Birth Date */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Birthdate: </span>
                        {animal.birthDate ? formatDate(animal.birthDate) : 'N/A'}
                    </div>
                    
                    {/* Breeder Info */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Breeder: </span>
                        {animal.breederName || 'N/A'}
                    </div>
                </div>
                
                {/* Gender Icon - Top Right */}
                <div className="absolute top-2 right-2">
                    <GenderIcon size={24} className="text-gray-900" strokeWidth={2.5} />
                </div>
                
                {/* CT ID - Bottom Right */}
                <div className="absolute bottom-2 right-2 text-xs font-mono text-gray-700">
                    {animal.id_public}
                </div>
            </div>
        );
    };

    // Render card for parents (medium with image)
    const renderParentCard = (animal, isSire, onClick = null) => {
        const bgColor = isSire ? 'bg-[#d4f1f5]' : 'bg-[#f8e8ee]';
        const GenderIcon = isSire ? Mars : Venus;
        
        // Get border color based on actual gender
        const getBorderColor = (animal) => {
            if (!animal || !animal.gender) return 'border-gray-700';
            return animal.gender === 'Male' ? 'border-blue-500' : 'border-pink-500';
        };
        
        // Direct parents always show - either full data, "Unknown", or "Hidden" (private)
        if (!animal) {
            return (
                <div className={`border ${getBorderColor(null)} rounded p-2 ${bgColor} relative h-full flex items-center justify-center`}>
                    <div className="text-center">
                        <Cat size={32} className="hide-for-pdf text-gray-300 mx-auto mb-2" />
                        <div className="text-xs text-gray-400">Unknown</div>
                    </div>
                    <div className="absolute top-2 right-2">
                        <GenderIcon size={24} className="text-gray-900" strokeWidth={2.5} />
                    </div>
                </div>
            );
        }
        
        if (animal.isHidden) {
            return (
                <div className={`border ${getBorderColor(animal)} rounded p-2 ${bgColor} relative h-full flex items-center justify-center`}>
                    <div className="text-center">
                        <EyeOff size={32} className="hide-for-pdf text-gray-500 mx-auto mb-2" />
                        <div className="text-xs text-gray-600 font-semibold">Hidden</div>
                        <div className="text-xs text-gray-500 mt-1">Private Profile</div>
                    </div>
                    <div className="absolute top-2 right-2">
                        <GenderIcon size={24} className="text-gray-900" strokeWidth={2.5} />
                    </div>
                </div>
            );
        }
        
        const imgSrc = animal.imageUrl || animal.photoUrl || null;
        const colorCoat = [animal.color, animal.coatPattern, animal.coat].filter(Boolean).join(' ') || 'N/A';
        
        return (
            <div 
                className={`border ${getBorderColor(animal)} rounded p-1.5 ${bgColor} relative flex gap-2 h-full items-center ${onClick ? 'cursor-pointer hover:opacity-80 transition' : ''}`}
                onClick={onClick ? () => onClick(animal) : undefined}
            >
                {/* Image - 1/3 width */}
                <div className="hide-for-pdf w-1/3 aspect-square bg-gray-100 rounded-lg border-2 border-gray-900 overflow-hidden flex items-center justify-center flex-shrink-0 pointer-events-none">
                    {imgSrc ? (
                        <AnimalImage src={imgSrc} alt={animal.name} className="w-full h-full object-cover" iconSize={window.innerWidth < 640 ? 24 : 32} />
                    ) : (
                        <Cat size={window.innerWidth < 640 ? 24 : 32} className="text-gray-400" />
                    )}
                </div>
                
                {/* Info */}
                <div className="flex-1 min-w-0 flex flex-col justify-start gap-1.5 py-1 pointer-events-none">
                    {/* Name */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Name: </span>{animal.prefix && `${animal.prefix} `}{animal.name}{animal.suffix && ` ${animal.suffix}`}
                    </div>
                    
                    {/* Variety */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Variety: </span>
                        {colorCoat}
                    </div>
                    
                    {/* Genetic Code */}
                    {animal.geneticCode && (
                        <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                            <span className="font-semibold">Genotype: </span>
                            {animal.geneticCode}
                        </div>
                    )}
                    
                    {/* Birth Date */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Birthdate: </span>
                        {animal.birthDate ? formatDate(animal.birthDate) : 'N/A'}
                    </div>
                    
                    {/* Breeder */}
                    <div className="text-xs text-gray-900 leading-tight" style={{lineHeight: '1.2'}}>
                        <span className="font-semibold">Breeder: </span>
                        {animal.breederName || 'N/A'}
                    </div>
                </div>
                
                {/* Gender Icon - Top Right */}
                <div className="absolute top-2 right-2 pointer-events-none">
                    <GenderIcon size={20} className="text-gray-900" strokeWidth={2.5} />
                </div>
                
                {/* CT ID - Bottom Right */}
                <div className="absolute bottom-2 right-2 text-xs font-mono text-gray-700 pointer-events-none">
                    {animal.id_public}
                </div>
            </div>
        );
    };

    // Render card for grandparents (with image)
    const renderGrandparentCard = (animal, isSire, onClick = null) => {
        const bgColor = isSire ? 'bg-[#d4f1f5]' : 'bg-[#f8e8ee]';
        const GenderIcon = isSire ? Mars : Venus;
        
        // Get border color based on actual gender
        const getBorderColor = (animal) => {
            if (!animal || !animal.gender) return 'border-gray-700';
            return animal.gender === 'Male' ? 'border-blue-500' : 'border-pink-500';
        };
        
        if (!animal) {
            return (
                <div className={`border ${getBorderColor(null)} rounded p-1.5 ${bgColor} flex gap-1.5 h-full items-center relative`}>
                    {/* Image placeholder - 1/4 width */}
                    <div className="hide-for-pdf w-1/4 aspect-square bg-gray-100 rounded-lg border-2 border-gray-900 overflow-hidden flex items-center justify-center flex-shrink-0">
                        <Cat size={18} className="text-gray-400" />
                    </div>
                    {/* Text */}
                    <div className="flex-1 flex items-center justify-start">
                        <span className="text-xs text-gray-400">Unknown</span>
                    </div>
                    <div className="absolute top-1 right-1">
                        <GenderIcon size={14} className="text-gray-900" strokeWidth={2.5} />
                    </div>
                </div>
            );
        }
        
        if (animal.isHidden) {
            return (
                <div className={`border ${getBorderColor(animal)} rounded p-1.5 ${bgColor} flex gap-1.5 h-full items-center relative`}>
                    {/* Icon placeholder - 1/4 width */}
                    <div className="hide-for-pdf w-1/4 aspect-square bg-gray-100 rounded-lg border-2 border-gray-900 overflow-hidden flex items-center justify-center flex-shrink-0">
                        <EyeOff size={18} className="text-gray-500" />
                    </div>
                    {/* Text */}
                    <div className="flex-1 flex items-center justify-start">
                        <span className="text-xs text-gray-600 font-semibold">Hidden</span>
                    </div>
                    <div className="absolute top-1 right-1">
                        <GenderIcon size={14} className="text-gray-900" strokeWidth={2.5} />
                    </div>
                </div>
            );
        }
        
        const imgSrc = animal.imageUrl || animal.photoUrl || null;
        const colorCoat = [animal.color, animal.coatPattern, animal.coat].filter(Boolean).join(' ') || 'N/A';
        
        return (
            <div 
                className={`border ${getBorderColor(animal)} rounded p-1 ${bgColor} relative flex gap-1.5 h-full items-center ${onClick ? 'cursor-pointer hover:opacity-80 transition' : ''}`}
                onClick={onClick ? () => onClick(animal) : undefined}
            >
                {/* Image - 1/4 width */}
                <div className="hide-for-pdf w-1/4 aspect-square bg-gray-100 rounded-lg border-2 border-gray-900 overflow-hidden flex items-center justify-center flex-shrink-0 pointer-events-none">
                    {imgSrc ? (
                        <AnimalImage src={imgSrc} alt={animal.name} className="w-full h-full object-cover" iconSize={18} />
                    ) : (
                        <Cat size={20} className="text-gray-400" />
                    )}
                </div>
                
                {/* Info */}
                <div className="flex-1 min-w-0 flex flex-col justify-start gap-1 py-0.5 pointer-events-none">
                    {/* Name */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.2'}}>
                        <span className="font-semibold">Name: </span>{animal.prefix && `${animal.prefix} `}{animal.name}{animal.suffix && ` ${animal.suffix}`}
                    </div>
                    
                    {/* Variety */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.2'}}>
                        <span className="font-semibold">Variety: </span>
                        {colorCoat}
                    </div>
                    
                    {/* Genetic Code */}
                    {animal.geneticCode && (
                        <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.2'}}>
                            <span className="font-semibold">Genotype: </span>
                            {animal.geneticCode}
                        </div>
                    )}
                    
                    {/* Birth Date */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.2'}}>
                        <span className="font-semibold">Birthdate: </span>
                        {animal.birthDate ? formatDate(animal.birthDate) : 'N/A'}
                    </div>
                    
                    {/* Breeder */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.2'}}>
                        <span className="font-semibold">Breeder: </span>
                        {animal.breederName || 'N/A'}
                    </div>
                </div>
                
                {/* Gender Icon - Top Right */}
                <div className="absolute top-1 right-1 pointer-events-none">
                    <GenderIcon size={14} className="text-gray-900" strokeWidth={2.5} />
                </div>
                
                {/* CT ID - Bottom Right */}
                <div className="absolute bottom-2 right-1 text-xs font-mono text-gray-700 pointer-events-none">
                    {animal.id_public}
                </div>
            </div>
        );
    };

    // Render card for great-grandparents (text only, no image)
    const renderGreatGrandparentCard = (animal, isSire, onClick = null) => {
        const bgColor = isSire ? 'bg-[#d4f1f5]' : 'bg-[#f8e8ee]';
        const GenderIcon = isSire ? Mars : Venus;
        
        // Get border color based on actual gender
        const getBorderColor = (animal) => {
            if (!animal || !animal.gender) return 'border-gray-700';
            return animal.gender === 'Male' ? 'border-blue-500' : 'border-pink-500';
        };
        
        if (!animal) {
            return (
                <div className={`border ${getBorderColor(null)} rounded p-1 ${bgColor} flex items-center justify-center h-full relative`}>
                    <span className="text-xs text-gray-400">Unknown</span>
                    <div className="absolute top-0.5 right-0.5">
                        <GenderIcon size={12} className="text-gray-900" strokeWidth={2.5} />
                    </div>
                </div>
            );
        }
        
        if (animal.isHidden) {
            return (
                <div className={`border ${getBorderColor(animal)} rounded p-1 ${bgColor} flex gap-1 h-full items-center relative`}>
                    {/* Icon placeholder */}
                    <div className="hide-for-pdf w-8 h-8 bg-gray-100 rounded-lg border border-gray-900 overflow-hidden flex items-center justify-center flex-shrink-0">
                        <EyeOff size={12} className="text-gray-500" />
                    </div>
                    {/* Text */}
                    <div className="flex-1 flex items-center justify-start">
                        <span className="text-xs text-gray-600 font-semibold">Hidden</span>
                    </div>
                    <div className="absolute top-0.5 right-0.5">
                        <GenderIcon size={12} className="text-gray-900" strokeWidth={2.5} />
                    </div>
                </div>
            );
        }
        
        const imgSrc = animal.imageUrl || animal.photoUrl || null;
        const colorCoat = [animal.color, animal.coatPattern, animal.coat].filter(Boolean).join(' ') || 'N/A';
        
        return (
            <div 
                className={`border ${getBorderColor(animal)} rounded p-1 ${bgColor} relative h-full flex gap-1 items-center ${onClick ? 'cursor-pointer hover:opacity-80 transition' : ''}`}
                onClick={onClick ? () => onClick(animal) : undefined}
            >
                {/* Image */}
                <div className="hide-for-pdf w-8 h-8 bg-gray-100 rounded-lg border border-gray-900 overflow-hidden flex items-center justify-center flex-shrink-0 pointer-events-none">
                    {imgSrc ? (
                        <AnimalImage src={imgSrc} alt={animal.name} className="w-full h-full object-cover" iconSize={12} />
                    ) : (
                        <Cat size={12} className="text-gray-400" />
                    )}
                </div>
                
                {/* Info */}
                <div className="flex-1 min-w-0 flex flex-col justify-start gap-0.5 py-0.5 pointer-events-none">
                    {/* Name - inline */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.3'}}>
                        <span className="font-semibold">Name: </span>{animal.prefix && `${animal.prefix} `}{animal.name}{animal.suffix && ` ${animal.suffix}`}
                    </div>
                
                    {/* Variety */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.3'}}>
                        <span className="font-semibold">Variety: </span>
                        {colorCoat}
                    </div>
                    
                    {/* Breeder */}
                    <div className="text-gray-900 leading-tight" style={{fontSize: '0.65rem', lineHeight: '1.3'}}>
                        <span className="font-semibold">Breeder: </span>
                        {animal.breederName || 'N/A'}
                    </div>
                </div>
                
                {/* Gender Icon - Top Right */}
                <div className="absolute top-0.5 right-0.5 pointer-events-none">
                    <GenderIcon size={12} className="text-gray-900" strokeWidth={2.5} />
                </div>
                
                {/* CT ID - Bottom Right */}
                <div className="absolute bottom-1.5 right-0.5 text-xs font-mono text-gray-700 pointer-events-none">
                    {animal.id_public}
                </div>
            </div>
        );
    };

    const renderPedigreeTree = (animal) => {
        if (!animal) return null;

        // Handler for clicking on pedigree cards
        const handleCardClick = (clickedAnimal) => {
            if (clickedAnimal && clickedAnimal.id_public) {
                setStackedPedigree(clickedAnimal);
            }
        };

        // Generation 1 (parents)
        const father = animal.father;
        const mother = animal.mother;

        // Generation 2 (grandparents)
        const paternalGrandfather = father?.father;
        const paternalGrandmother = father?.mother;
        const maternalGrandfather = mother?.father;
        const maternalGrandmother = mother?.mother;

        // Generation 3 (great-grandparents)
        const pgfFather = paternalGrandfather?.father;
        const pgfMother = paternalGrandfather?.mother;
        const pgmFather = paternalGrandmother?.father;
        const pgmMother = paternalGrandmother?.mother;
        const mgfFather = maternalGrandfather?.father;
        const mgfMother = maternalGrandfather?.mother;
        const mgmFather = maternalGrandmother?.father;
        const mgmMother = maternalGrandmother?.mother;

        // Responsive heights - reasonable mobile sizing
        const isMobile = window.innerWidth < 640; // sm breakpoint
        const contentHeight = isMobile ? 450 : 600; // Increased height to fit text
        const gap = isMobile ? 4 : 8; // gap-1 = 4px, gap-2 = 8px
        const gapClass = isMobile ? 'gap-1' : 'gap-2';
        
        // Calculate card heights accounting for gaps to ensure equal total column heights
        const parentHeight = (contentHeight - gap) / 2; // 2 cards, 1 gap
        const grandparentHeight = (contentHeight - (3 * gap)) / 4; // 4 cards, 3 gaps
        const greatGrandparentHeight = (contentHeight - (7 * gap)) / 8; // 8 cards, 7 gaps

        return (
            <div className={`flex ${gapClass} w-full`} style={{height: `${contentHeight}px`, minWidth: isMobile ? '600px' : 'auto'}}>
                    {/* Column 1: Parents (2 rows, each takes 1/2 height) */}
                    <div className={`w-1/3 flex flex-col ${gapClass}`}>
                        <div style={{height: `${parentHeight}px`}}>
                            {renderParentCard(father, true, handleCardClick)}
                        </div>
                        <div style={{height: `${parentHeight}px`}}>
                            {renderParentCard(mother, false, handleCardClick)}
                        </div>
                    </div>

                    {/* Column 2: Grandparents (4 rows, each takes 1/4 height) */}
                    <div className={`w-1/3 flex flex-col ${gapClass}`}>
                        <div style={{height: `${grandparentHeight}px`}}>
                            {renderGrandparentCard(paternalGrandfather, true, handleCardClick)}
                        </div>
                        <div style={{height: `${grandparentHeight}px`}}>
                            {renderGrandparentCard(paternalGrandmother, false, handleCardClick)}
                        </div>
                        <div style={{height: `${grandparentHeight}px`}}>
                            {renderGrandparentCard(maternalGrandfather, true, handleCardClick)}
                        </div>
                        <div style={{height: `${grandparentHeight}px`}}>
                            {renderGrandparentCard(maternalGrandmother, false, handleCardClick)}
                        </div>
                    </div>

                    {/* Column 3: Great-Grandparents (8 rows, each takes 1/8 height) */}
                    <div className={`w-1/3 flex flex-col ${gapClass}`}>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(pgfFather, true, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(pgfMother, false, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(pgmFather, true, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(pgmMother, false, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(mgfFather, true, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(mgfMother, false, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(mgmFather, true, handleCardClick)}
                        </div>
                        <div style={{height: `${greatGrandparentHeight}px`}}>
                            {renderGreatGrandparentCard(mgmMother, false, handleCardClick)}
                        </div>
                    </div>
                </div>
        );
    };

    if (loading) {
        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-6xl w-full">
                    <LoadingSpinner />
                </div>
            </div>
        );
    }

    // Top right - 3 lines (Personal Name, Breeder Name, CTID)
    const getOwnerDisplayInfoTopRight = () => {
        if (!ownerProfile) return { lines: ['Unknown Owner'], userId: null };
        
        const userId = ownerProfile.id_public || pedigreeData?.ownerId_public || pedigreeData?.breederId_public;
        const lines = [];
        
        const showPersonalName = ownerProfile.showPersonalName ?? false;
        const showBreederName = ownerProfile.showBreederName ?? false;
        
        // Add personal name if privacy allows and available
        if (showPersonalName && ownerProfile.personalName) {
            lines.push(ownerProfile.personalName);
        }
        
        // Add breeder name if it's public and available
        if (showBreederName && ownerProfile.breederName) {
            lines.push(ownerProfile.breederName);
        }
        
        return { 
            lines: lines.length > 0 ? lines : [userId || 'Anonymous Breeder'], 
            userId 
        };
    };
    
    // Bottom left - 1 line (CTID - Personal Name - Breeder Name)
    const getOwnerDisplayInfoBottomLeft = () => {
        if (!ownerProfile) return 'Unknown Owner';
        
        const userId = ownerProfile.id_public || pedigreeData?.ownerId_public || pedigreeData?.breederId_public;
        const parts = [];
        
        const showPersonalName = ownerProfile.showPersonalName ?? false;
        const showBreederName = ownerProfile.showBreederName ?? false;
        
        // Add CTID first
        if (userId) {
            parts.push(userId);
        }
        
        // Add personal name if privacy allows and available
        if (showPersonalName && ownerProfile.personalName) {
            parts.push(ownerProfile.personalName);
        }
        
        // Add breeder name if it's public and available
        if (showBreederName && ownerProfile.breederName) {
            parts.push(ownerProfile.breederName);
        }
        
        return parts.length > 0 ? parts.join(' - ') : 'Anonymous Breeder';
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
            <div className="min-h-screen flex justify-center pt-2 sm:pt-4 pb-2 sm:pb-4 px-2 sm:px-4">
                <div className="bg-white rounded-xl shadow-2xl h-fit w-full max-w-[98vw] sm:max-w-[95vw]">
                    {/* Header */}
                    <div className="flex justify-between items-center px-2 sm:px-6 py-2 sm:py-4 border-b border-gray-200 bg-gray-50 rounded-t-xl">
                        <h2 className="text-lg sm:text-2xl font-bold text-gray-800 flex items-center">
                            <FileText className="mr-1 sm:mr-2" size={18} />
                            <span className="hidden sm:inline">Pedigree Chart</span>
                            <span className="sm:hidden">🌳 Pedigree</span>
                        </h2>
                        <div className="flex items-center gap-1 sm:gap-2">
                            <button
                                onClick={downloadPDF}
                                disabled={!imagesLoaded}
                                data-tutorial-target="download-pdf-btn"
                                className={`flex items-center gap-1 sm:gap-2 px-2 sm:px-4 py-1.5 sm:py-2 font-semibold rounded-lg transition text-xs sm:text-base ${
                                    imagesLoaded 
                                        ? 'bg-primary hover:bg-primary/90 text-black cursor-pointer' 
                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`}
                                title={!imagesLoaded ? 'Waiting for images to load...' : 'Download PDF'}
                            >
                                <Download size={16} />
                                <span className="hidden sm:inline">{imagesLoaded ? 'Download PDF' : 'Loading...'}</span>
                                <span className="sm:hidden">{imagesLoaded ? 'PDF' : '...'}</span>
                            </button>
                            <button
                                onClick={onClose}
                                className="p-1.5 sm:p-2 hover:bg-gray-100 rounded-lg transition"
                            >
                                <X size={20} />
                            </button>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="p-1 sm:p-6" style={{paddingBottom: window.innerWidth < 640 ? '80px' : '1.5rem'}}>

                {/* Pedigree Chart - Responsive on mobile, fixed aspect ratio for PDF */}
                <div ref={pedigreeRef} className="bg-white p-1 sm:p-6 rounded-lg border-2 border-gray-300 relative w-full" style={{minHeight: window.innerWidth < 640 ? '320px' : '400px'}}>
                    {/* Entire content scrollable horizontally inside the white container */}
                    <div className="overflow-x-auto overflow-y-visible sm:overflow-hidden" style={{minWidth: 'auto'}}>
                        <div style={{minWidth: window.innerWidth < 640 ? '800px' : 'auto'}}>
                            {/* Top Row: 3 columns - Main Animal | Species | Owner */}
                            <div className="flex gap-0.5 sm:gap-2 mb-0.5 sm:mb-2 items-start">
                                {/* Left: Main Animal - Same width as parent cards */}
                                <div className="w-1/3">
                                    {pedigreeData && renderMainAnimalCard(pedigreeData)}
                                </div>

                                {/* Species */}
                                <div className="w-1/3 flex items-center justify-center">
                                    <div className="text-center">
                                        <h3 className="text-xs sm:text-lg font-bold text-gray-800">{pedigreeData?.species || 'Unknown Species'}</h3>
                                        {pedigreeData?.species && getSpeciesLatinName(pedigreeData.species) && (
                                            <p className="text-xs sm:text-sm italic text-gray-600">{getSpeciesLatinName(pedigreeData.species)}</p>
                                        )}
                                    </div>
                                </div>

                                {/* Owner Profile */}
                                <div className="w-1/3 flex items-center justify-end gap-0.5 sm:gap-3">
                                    <div className="text-right">
                                        {(() => {
                                            const ownerInfo = getOwnerDisplayInfoTopRight();
                                            return (
                                                <>
                                                    {ownerInfo.lines.map((line, idx) => (
                                                        <div key={idx} className="text-xs sm:text-base font-semibold text-gray-800 leading-tight">{line}</div>
                                                    ))}
                                                    {ownerInfo.userId && (
                                                        <div className="text-xs text-gray-600 mt-1">{ownerInfo.userId}</div>
                                                    )}
                                                </>
                                            );
                                        })()}
                                    </div>
                                    <div className="hide-for-pdf w-6 h-6 sm:w-16 sm:h-16 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
                                        {(ownerProfile?.profileImage || ownerProfile?.profileImageUrl) ? (
                                            <img src={ownerProfile.profileImage || ownerProfile.profileImageUrl} alt="Owner" className="w-full h-full object-cover" />
                                        ) : (
                                            <User size={12} className="text-gray-400 sm:w-8 sm:h-8" />
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Pedigree Tree */}
                            <div>
                                {renderPedigreeTree(pedigreeData)}
                            </div>

                            {/* Footer - Inside scrollable content */}
                            <div className="mt-4 pt-3 pb-4 border-t-2 border-gray-300 flex justify-between items-center text-sm text-gray-600">
                                <div>
                                    {getOwnerDisplayInfoBottomLeft()}
                                </div>
                                <div>{formatDate(new Date())}</div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>

            {/* Stacked Pedigree Modal - Higher z-index to appear above main pedigree */}
            {stackedPedigree && (
                <div className="fixed inset-0 z-[90]">
                    <PedigreeChart
                        animalId={stackedPedigree.id_public}
                        animalData={stackedPedigree}
                        onClose={() => setStackedPedigree(null)}
                        API_BASE_URL={API_BASE_URL}
                        authToken={authToken}
                    />
                </div>
            )}
        </div>
        </div>
    );
};

// (Removed unused `AnimalListItem` component to reduce redundancy)

const BreederDirectorySettings = ({ authToken, API_BASE_URL, showModalMessage, userProfile }) => {
    const [breedingStatus, setBreedingStatus] = useState({});
    const [loading, setLoading] = useState(false);
    const [loadingStatus, setLoadingStatus] = useState(true);
    const [userAnimals, setUserAnimals] = useState([]);

    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        try {
            // Fetch user's animals
            const animalsResponse = await axios.get(`${API_BASE_URL}/animals`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setUserAnimals(animalsResponse.data || []);

            // Fetch breeding status
            const statusResponse = await axios.get(`${API_BASE_URL}/users/breeding-status`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setBreedingStatus(statusResponse.data.breedingStatus || {});
        } catch (error) {
            console.error('Error fetching data:', error);
        } finally {
            setLoadingStatus(false);
        }
    };

    // Get unique species from user's animals
    const userSpecies = [...new Set(userAnimals.map(animal => animal.species))];
    
    // Get species that are marked as breeder or retired (even if no animals)
    const markedSpecies = Object.keys(breedingStatus).filter(
        species => breedingStatus[species] === 'breeder' || breedingStatus[species] === 'retired'
    );
    
    // Combine: species with animals + species marked as breeder/retired
    const displaySpecies = [...new Set([...userSpecies, ...markedSpecies])].sort();

    const handleStatusChange = (species, status) => {
        setBreedingStatus(prev => {
            const updated = { ...prev };
            if (status === 'owner' || status === '') {
                // Remove from object if set to owner (default)
                delete updated[species];
            } else {
                updated[species] = status;
            }
            return updated;
        });
    };

    const handleSave = async () => {
        setLoading(true);
        try {
            await axios.put(
                `${API_BASE_URL}/users/breeding-status`,
                { breedingStatus },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            showModalMessage('Success', 'Breeding status updated successfully.');
        } catch (error) {
            console.error('Error updating breeding status:', error);
            showModalMessage('Error', 'Failed to update breeding status.');
        } finally {
            setLoading(false);
        }
    };

    if (loadingStatus) {
        return (
            <div className="mb-8 p-4 sm:p-6 border rounded-lg bg-gray-50">
                <div className="flex items-center justify-center py-8">
                    <Loader2 className="animate-spin mr-2" size={24} />
                    <span>Loading breeding status...</span>
                </div>
            </div>
        );
    }

    if (displaySpecies.length === 0) {
        return (
            <div className="mb-8 p-4 sm:p-6 border rounded-lg bg-gray-50 overflow-x-hidden">
                <h3 className="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Species & Breeding Status</h3>
                <p className="text-sm text-gray-600">
                    Add some animals to your collection to manage your breeding status and appear in the Breeders Registry.
                </p>
            </div>
        );
    }

    return (
        <div className="mb-8 p-4 sm:p-6 border rounded-lg bg-gray-50 overflow-x-hidden" data-tutorial-target="breeding-status-section">
            <h3 className="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Species & Breeding Status</h3>
            <p className="text-sm text-gray-600 mb-1">
                Set your breeding status for each species. Marking yourself as an <strong>Active Breeder</strong> or <strong>Retired Breeder</strong> will make you visible in the Breeders Registry.
            </p>
            <p className="text-xs text-gray-500 mb-4">
                Note: Species marked as Active or Retired will remain in your list even if you have no animals of that species.
            </p>

            <div className="space-y-3 mb-4">
                {displaySpecies.map(species => {
                    const animalCount = userAnimals.filter(a => a.species === species).length;
                    const currentStatus = breedingStatus[species] || 'owner';
                    
                    return (
                        <div key={species} className="flex items-center justify-between py-2 border-b border-gray-200">
                            <div className="flex flex-col">
                                <span className="text-sm font-medium text-gray-700">{species}</span>
                                <span className="text-xs text-gray-500">{animalCount} animal{animalCount !== 1 ? 's' : ''}</span>
                            </div>
                            <select
                                value={currentStatus}
                                onChange={(e) => handleStatusChange(species, e.target.value)}
                                className="px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                disabled={loading}
                            >
                                <option value="owner">🏠 Owner</option>
                                <option value="breeder">⭐ Active Breeder</option>
                                <option value="retired">🌙 Retired Breeder</option>
                            </select>
                        </div>
                    );
                })}
            </div>

            <div className="flex justify-end pt-2">
                <button
                    onClick={handleSave}
                    disabled={loading}
                    className="bg-accent hover:bg-accent/90 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center disabled:opacity-50"
                >
                    {loading ? <Loader2 className="animate-spin mr-2" size={20} /> : <Save size={20} className="mr-2" />}
                    Save Breeding Status
                </button>
            </div>
        </div>
    );
};

const ProfileImagePlaceholder = ({ url, onFileChange, disabled }) => (
    <div className="flex flex-col items-center space-y-3">
        <div 
            className="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 overflow-hidden shadow-inner cursor-pointer" 
            onClick={() => !disabled && document.getElementById('profileImageInput').click()}
        >
            {url ? (
                <img src={url} alt="Profile" className="w-full h-full object-cover" />
            ) : (
                <User size={50} />
            )}
        </div>
        <input 
            id="profileImageInput" 
            type="file" 
            accept="image/*" 
            hidden 
            onChange={onFileChange} 
            disabled={disabled}
        />
        <button 
            type="button" 
            onClick={() => !disabled && document.getElementById('profileImageInput').click()}
            disabled={disabled}
            className="text-sm text-primary hover:text-primary-dark transition duration-150 disabled:opacity-50"
        >
            {url ? "Change Image" : "Upload Image"}
        </button>
    </div>
);


const ParentSearchModal = ({ 
    title, 
    currentId, 
    onSelect, 
    onClose, 
    authToken, 
    showModalMessage, 
    API_BASE_URL, 
    X, 
    Search, 
    Loader2, 
    LoadingSpinner,
    requiredGender, // Filter: e.g., 'Male' or 'Female'
    birthDate,      // Filter: Date of the animal being bred
    species         // Filter: Species of the animal being bred
}) => {
    const [searchTerm, setSearchTerm] = useState('');
        const [hasSearched, setHasSearched] = useState(false);
    const [localAnimals, setLocalAnimals] = useState([]);
    const [globalAnimals, setGlobalAnimals] = useState([]);
    const [loadingLocal, setLoadingLocal] = useState(false);
    const [loadingGlobal, setLoadingGlobal] = useState(false);
    const [scope, setScope] = useState('both'); // 'local' | 'global' | 'both'
    
    // Simple component to render a list item
    const SearchResultItem = ({ animal, isGlobal }) => {
        const imgSrc = animal.imageUrl || animal.photoUrl || null;
        
        return (
            <div 
                className="flex items-center space-x-3 p-3 border-b hover:bg-gray-50 cursor-pointer" 
                onClick={() => onSelect(animal)}
            >
                {/* Thumbnail */}
                <div className="w-16 h-16 bg-gray-100 rounded-md overflow-hidden flex-shrink-0 flex items-center justify-center">
                    <AnimalImage src={imgSrc} alt={animal.name} className="w-full h-full object-cover" iconSize={24} />
                </div>
                
                {/* Info */}
                <div className="flex-grow">
                    <p className="font-semibold text-gray-800">
                        {animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}
                    </p>
                    <p className="text-xs text-gray-500">{animal.id_public}</p>
                    <p className="text-sm text-gray-600">
                        {animal.species} &bull; {animal.gender} &bull; {animal.status || 'Unknown'}
                    </p>
                    {getSpeciesLatinName(animal.species) && (
                        <p className="text-xs italic text-gray-500">{getSpeciesLatinName(animal.species)}</p>
                    )}
                </div>
                
                {/* Badge */}
                {isGlobal && <span className="text-xs text-black bg-primary px-2 py-1 rounded-full flex-shrink-0">Global</span>}
            </div>
        );
    };

        const handleSearch = async () => {
            setHasSearched(true);
        const trimmedSearchTerm = searchTerm.trim();

        if (!trimmedSearchTerm || trimmedSearchTerm.length < 1) {
            setLocalAnimals([]);
            setGlobalAnimals([]);
            showModalMessage('Search Info', 'Please enter a name or ID to search.');
            return;
        }

        // Detect ID searches (CTC1234, CT1234, or 1234)
        const idMatch = trimmedSearchTerm.match(/^\s*(?:CTC?[- ]?)?(\d+)\s*$/i);
        const isIdSearch = !!idMatch;
        // Send full CTC format (CTC1234) instead of just numeric portion (1234)
        const idValue = isIdSearch ? `CTC${idMatch[1]}` : null;

        // --- CONSTRUCT FILTER QUERIES ---
        const genderQuery = requiredGender 
            ? (Array.isArray(requiredGender) 
                ? `&gender=${requiredGender.map(g => encodeURIComponent(g)).join('&gender=')}`
                : `&gender=${requiredGender}`)
            : '';
        const birthdateQuery = birthDate ? `&birthdateBefore=${birthDate}` : '';
        const speciesQuery = species ? `&species=${encodeURIComponent(species)}` : '';

        // Prepare promises depending on scope
        setLoadingLocal(scope === 'local' || scope === 'both');
        setLoadingGlobal(scope === 'global' || scope === 'both');

        // Local search
        if (scope === 'local' || scope === 'both') {
            try {
                const localUrl = isIdSearch
                    ? `${API_BASE_URL}/animals?id_public=${encodeURIComponent(idValue)}`
                    : `${API_BASE_URL}/animals?name=${encodeURIComponent(trimmedSearchTerm)}${genderQuery}${birthdateQuery}${speciesQuery}`;

                const localResponse = await axios.get(localUrl, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                // Filter out current animal and females deceased before offspring birth date
                const filteredLocal = localResponse.data.filter(a => {
                    if (a.id_public === currentId) return false;
                    // Only check deceased date for females (dams must be alive at offspring birth)
                    // Males (sires) can be deceased as long as they mated before death
                    if (birthDate && a.deceasedDate && (a.gender === 'Female' || a.gender === 'Intersex')) {
                        const offspringBirth = new Date(birthDate);
                        const parentDeceased = new Date(a.deceasedDate);
                        if (parentDeceased < offspringBirth) return false; // Dam died before offspring born
                    }
                    return true;
                });
                setLocalAnimals(filteredLocal);
            } catch (error) {
                console.error('Local Search Error:', error);
                showModalMessage('Search Error', 'Failed to search your animals.');
                setLocalAnimals([]);
            } finally {
                setLoadingLocal(false);
            }
        } else {
            setLocalAnimals([]);
            setLoadingLocal(false);
        }

        // Global search
        if (scope === 'global' || scope === 'both') {
            try {
                const globalUrl = isIdSearch
                    ? `${API_BASE_URL}/public/global/animals?id_public=${encodeURIComponent(idValue)}`
                    : `${API_BASE_URL}/public/global/animals?name=${encodeURIComponent(trimmedSearchTerm)}${genderQuery}${birthdateQuery}${speciesQuery}`;

                const globalResponse = await axios.get(globalUrl);
                // Filter out current animal and females deceased before offspring birth date
                const filteredGlobal = globalResponse.data.filter(a => {
                    if (a.id_public === currentId) return false;
                    // Only check deceased date for females (dams must be alive at offspring birth)
                    // Males (sires) can be deceased as long as they mated before death
                    if (birthDate && a.deceasedDate && (a.gender === 'Female' || a.gender === 'Intersex')) {
                        const offspringBirth = new Date(birthDate);
                        const parentDeceased = new Date(a.deceasedDate);
                        if (parentDeceased < offspringBirth) return false; // Dam died before offspring born
                    }
                    return true;
                });
                setGlobalAnimals(filteredGlobal);
            } catch (error) {
                console.error('Global Search Error:', error);
                setGlobalAnimals([]);
            } finally {
                setLoadingGlobal(false);
            }
        } else {
            setGlobalAnimals([]);
            setLoadingGlobal(false);
        }
    };

        return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 className="text-xl font-bold text-gray-800">{title} Selector</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={24} /></button>
                </div>

                {/* Scope Toggle + Search Bar (Manual Search) */}
                <div className="mb-3">
                    <div className="flex items-center space-x-2 mb-2">
                        <span className="text-sm font-medium text-gray-600">Search Scope:</span>
                        {['local','global','both'].map(s => (
                            <button key={s} onClick={() => setScope(s)}
                                className={`px-3 py-1.5 text-sm font-semibold rounded-lg transition duration-150 ${scope === s ? 'bg-primary text-black' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                {s === 'both' ? 'Local + Global' : (s === 'local' ? 'Local' : 'Global')}
                            </button>
                        ))}
                    </div>
                    <div className="flex space-x-2">
                        <input
                            type="text"
                            placeholder={`Search by Name or ID (e.g., Minnie or CT2468)...`}
                            value={searchTerm}
                            onChange={(e) => { setSearchTerm(e.target.value); setHasSearched(false); }}
                            className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition"
                        />
                        <button
                            onClick={handleSearch}
                            disabled={((scope === 'local' || scope === 'both') && loadingLocal) || ((scope === 'global' || scope === 'both') && loadingGlobal) || searchTerm.trim().length < 1}
                            className="bg-primary hover:bg-primary/90 text-black font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center disabled:opacity-50"
                        >
                            { (loadingLocal || loadingGlobal) ? <Loader2 className="animate-spin" size={20} /> : <Search size={20} /> }
                        </button>
                    </div>
                </div>
                
                {/* Results Area */}
                <div className="flex-grow overflow-y-auto space-y-4">
                    {/* Local Results */}
                    {loadingLocal ? <LoadingSpinner message="Searching your animals..." /> : localAnimals.length > 0 && (
                        <div className="border p-3 rounded-lg bg-white shadow-sm">
                            <h4 className="font-bold text-gray-700 mb-2 border-b pb-1">Your Animals ({localAnimals.length})</h4>
                            {localAnimals.map(animal => <SearchResultItem key={animal.id_public} animal={animal} isGlobal={false} />)}
                        </div>
                    )}
                    
                    {/* Global Results */}
                    {loadingGlobal ? <LoadingSpinner message="Searching global animals..." /> : globalAnimals.length > 0 && (
                        <div className="border p-3 rounded-lg bg-white shadow-sm">
                            <h4 className="font-bold text-gray-700 mb-2 border-b pb-1">Global Display Animals ({globalAnimals.length})</h4>
                            {globalAnimals.map(animal => <SearchResultItem key={animal.id_public} animal={animal} isGlobal={true} />)}
                        </div>
                    )}
                    
                    {/* Updated no results check */}
                    {hasSearched && searchTerm.trim().length >= 1 && localAnimals.length === 0 && globalAnimals.length === 0 && !loadingLocal && !loadingGlobal && (
                        <p className="text-center text-gray-500 py-4">No animals found matching your search term or filters.</p>
                    )}
                </div>

                <div className="mt-4 pt-4 border-t">
                    <button 
                        onClick={() => onSelect(null)} 
                        className="w-full text-sm text-gray-500 hover:text-red-500 transition"
                    >
                        Clear {title} ID
                    </button>
                </div>
            </div>
        </div>
    );
};


const LocalAnimalSearchModal = ({ title, currentId, onSelect, onClose, authToken, showModalMessage, API_BASE_URL, X, Search, Loader2, LoadingSpinner, genderFilter }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [hasSearched, setHasSearched] = useState(false);
    const [localAnimals, setLocalAnimals] = useState([]);
    const [loadingLocal, setLoadingLocal] = useState(false);
    
    // Simple component to render a list item (No isGlobal tag needed)
    const SearchResultItem = ({ animal }) => (
        <div 
            className="flex justify-between items-center p-3 border-b hover:bg-gray-50 cursor-pointer" 
            onClick={() => onSelect(animal)}
        >
            <div>
                <p className="font-semibold text-gray-800">{animal.prefix} {animal.name}{animal.suffix && ` ${animal.suffix}`} ({animal.id_public})</p>
                <p className="text-sm text-gray-600">
                    {animal.species} | {animal.gender} | {animal.status}
                </p>
                {getSpeciesLatinName(animal.species) && (
                    <p className="text-xs italic text-gray-500">{getSpeciesLatinName(animal.species)}</p>
                )}
            </div>
        </div>
    );

    const handleSearch = async () => {
        setHasSearched(true);
        const trimmedSearchTerm = searchTerm.trim();
        
        if (!trimmedSearchTerm || trimmedSearchTerm.length < 3) {
            setLocalAnimals([]);
            showModalMessage('Search Info', 'Please enter at least 3 characters to search.');
            return;
        }

        // --- Search Local Animals Only ---
        setLoadingLocal(true);
        try {
            const localResponse = await axios.get(`${API_BASE_URL}/animals?name=${trimmedSearchTerm}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            let filteredLocal = localResponse.data.filter(a => a.id_public !== currentId);
            
            // Apply gender filter if specified
            if (genderFilter) {
                if (Array.isArray(genderFilter)) {
                    filteredLocal = filteredLocal.filter(a => genderFilter.includes(a.gender));
                } else {
                    filteredLocal = filteredLocal.filter(a => a.gender === genderFilter);
                }
            }
            
            setLocalAnimals(filteredLocal);
        } catch (error) {
            console.error('Local Search Error:', error);
            showModalMessage('Search Error', 'Failed to search your animals.');
            setLocalAnimals([]);
        } finally {
            setLoadingLocal(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 className="text-xl font-bold text-gray-800">{title} Selector</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={24} /></button>
                </div>

                {/* Search Bar (Manual Search) */}
                <div className="flex space-x-2 mb-4">
                    <input
                        type="text"
                        placeholder="Search your animals by Name (min 3 chars)..."
                        value={searchTerm}
                        onChange={(e) => { setSearchTerm(e.target.value); setHasSearched(false); }}
                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition"
                    />
                    <button
                        onClick={handleSearch}
                        disabled={loadingLocal || searchTerm.trim().length < 3}
                        className="bg-primary hover:bg-primary/90 text-black font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center disabled:opacity-50"
                    >
                        {loadingLocal ? <Loader2 className="animate-spin" size={20} /> : <Search size={20} />}
                    </button>
                </div>
                
                {/* Results Area */}
                <div className="flex-grow overflow-y-auto space-y-4">
                    {/* Local Results */}
                    {loadingLocal ? <LoadingSpinner message="Searching your animals..." /> : localAnimals.length > 0 ? (
                        <div className="border p-3 rounded-lg bg-white shadow-sm">
                            <h4 className="font-bold text-gray-700 mb-2 border-b pb-1">Your Animals ({localAnimals.length})</h4>
                            {localAnimals.map(animal => <SearchResultItem key={animal.id_public} animal={animal} />)}
                        </div>
                    ) : (
                        hasSearched && searchTerm.trim().length >= 3 && !loadingLocal && (
                            <p className="text-center text-gray-500 py-4">No local animals found matching your search term.</p>
                        )
                    )}
                </div>

                <div className="mt-4 pt-4 border-t">
                    <button 
                        onClick={() => onSelect(null)} 
                        className="w-full text-sm text-gray-500 hover:text-red-500 transition"
                    >
                        Clear {title} ID
                    </button>
                </div>
            </div>
        </div>
    );
};



const UserSearchModal = ({ onClose, showModalMessage, onSelectUser, API_BASE_URL, modalTarget, userProfile }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [searchType, setSearchType] = useState('users'); // 'users' or 'animals'
    const [userResults, setUserResults] = useState([]);
    const [animalResults, setAnimalResults] = useState([]);
    const [loading, setLoading] = useState(false);
    const [hasSearched, setHasSearched] = useState(false);

    const handleSearch = async () => {
        if (!searchTerm || searchTerm.trim().length < 2) {
            setUserResults([]);
            setAnimalResults([]);
            setHasSearched(false);
            return;
        }

        setHasSearched(true);
        setLoading(true);
        
        try {
            if (searchType === 'users') {
                // Search for users
                const url = `${API_BASE_URL}/public/profiles/search?query=${encodeURIComponent(searchTerm.trim())}&limit=50`;
                console.log('Fetching users from:', url);
                const response = await axios.get(url);
                console.log('User search response:', response.data);
                if (response.data && response.data.length > 0) {
                    console.log('First user object keys:', Object.keys(response.data[0]));
                    console.log('First user object:', response.data[0]);
                }
                setUserResults(response.data || []);
                setAnimalResults([]);
            } else {
                // Search for animals globally
                const idMatch = searchTerm.trim().match(/^\s*(?:CT[- ]?)?(\d+)\s*$/i);
                const url = idMatch
                    ? `${API_BASE_URL}/public/global/animals?id_public=${encodeURIComponent(idMatch[1])}`
                    : `${API_BASE_URL}/public/global/animals?name=${encodeURIComponent(searchTerm.trim())}`;
                console.log('Fetching animals from:', url);
                const response = await axios.get(url);
                console.log('Animal search response:', response.data);
                if (response.data && response.data.length > 0) {
                    console.log('First animal object keys:', Object.keys(response.data[0]));
                    console.log('First animal object:', response.data[0]);
                }
                setAnimalResults(response.data || []);
                setUserResults([]);
            }
        } catch (error) {
            console.error('Search error:', error);
            showModalMessage('Search Error', 'Failed to search. Please try again.');
            setUserResults([]);
            setAnimalResults([]);
        } finally {
            setLoading(false);
        }
    };

    const UserResultCard = ({ user }) => {
        const memberSince = user.createdAt 
            ? new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(user.createdAt))
            : (user.updatedAt ? new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(user.updatedAt)) : null);
        
        // Determine display name(s) - respect privacy settings
        const showPersonalName = user.showPersonalName ?? false;
        const showBreederName = user.showBreederName ?? false;
        
        let displayName;
        if (showBreederName && showPersonalName && user.personalName && user.breederName) {
            displayName = `${user.personalName} (${user.breederName})`;
        } else if (showBreederName && user.breederName) {
            displayName = user.breederName;
        } else if (showPersonalName && user.personalName) {
            displayName = user.personalName;
        } else {
            displayName = 'Anonymous Breeder';
        }
        
        return (
            <div 
                className="p-4 border-b last:border-b-0 hover:bg-gray-50 transition duration-150 cursor-pointer"
                onClick={() => {
                    if (onSelectUser) onSelectUser(user);
                }}
            >
                <div className="flex items-start space-x-3">
                    {user.profileImage ? (
                        <img src={user.profileImage} alt={displayName} className="w-12 h-12 rounded-lg object-cover" />
                    ) : (
                        <div className="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                            <User size={24} className="text-gray-400" />
                        </div>
                    )}
                    <div className="flex-grow">
                        <p className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                            {displayName}
                            <DonationBadge badge={getDonationBadge(user)} size="sm" />
                        </p>
                        <p className="text-sm text-gray-600">
                            Public ID: <span className="font-mono text-accent">{user.id_public}</span>
                        </p>
                        {memberSince && (
                            <p className="text-xs text-gray-500 mt-1">
                                Member since {memberSince}
                            </p>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const AnimalResultCard = ({ animal }) => (
        <div 
            className="p-4 border-b last:border-b-0 hover:bg-gray-50 transition duration-150 cursor-pointer"
            onClick={() => {
                // Will open view-only animal detail modal
                if (window.handleViewPublicAnimal) {
                    window.handleViewPublicAnimal(animal);
                }
            }}
        >
            <div className="flex items-start space-x-3">
                <div className="w-12 h-12 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
                    <AnimalImage src={animal.imageUrl || animal.photoUrl} alt={animal.name} className="w-full h-full object-cover" iconSize={24} />
                </div>
                <div className="flex-grow">
                    <div className="flex items-center gap-2">
                        <p className="text-lg font-semibold text-gray-800">
                            {animal.prefix && `${animal.prefix} `}{animal.name}{animal.suffix && ` ${animal.suffix}`}
                        </p>
                        {animal.ownerUser && <DonationBadge user={animal.ownerUser} size="xs" />}
                    </div>
                    <p className="text-sm text-gray-600">
                        {animal.species} &bull; {animal.gender} &bull; <span className="font-mono">{animal.id_public}</span>
                    </p>
                    {animal.color && <p className="text-xs text-gray-500 mt-1">{animal.color}</p>}
                    {(animal.manualBreederName || animal.breederName) && (
                        <p className="text-xs text-gray-500 mt-1 flex items-center gap-2">
                            <span>Breeder: {animal.manualBreederName || animal.breederName}</span>
                            {animal.breederUser && <DonationBadge user={animal.breederUser} size="xs" />}
                        </p>
                    )}
                </div>
            </div>
        </div>
    );

    const results = searchType === 'users' ? userResults : animalResults;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 className="text-xl font-bold text-gray-800">Global Search 🔎</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={24} /></button>
                </div>

                {/* Search Type Toggle - only show for pedigree (sire/dam), not for breeder */}
                {modalTarget !== 'breeder' && (
                    <div className="flex space-x-2 mb-4">
                        <button
                            onClick={() => { setSearchType('users'); setUserResults([]); setAnimalResults([]); setHasSearched(false); }}
                            className={`flex-1 py-2 px-4 rounded-lg font-semibold transition ${
                                searchType === 'users' 
                                    ? 'bg-primary text-black' 
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            <User size={16} className="inline mr-2" />
                            Users
                        </button>
                        <button
                            onClick={() => { setSearchType('animals'); setUserResults([]); setAnimalResults([]); setHasSearched(false); }}
                            className={`flex-1 py-2 px-4 rounded-lg font-semibold transition ${
                                searchType === 'animals' 
                                    ? 'bg-primary text-black' 
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            <Cat size={16} className="inline mr-2" />
                            Animals
                        </button>
                    </div>
                )}

                <div className="flex space-x-2 mb-4">
                    <input
                        type="text"
                        placeholder={searchType === 'users' 
                            ? "Search by Name or ID (e.g., CT2468)..." 
                            : "Search by Name or ID (e.g., CT123)..."}
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition"
                        onKeyDown={(e) => {
                            if (e.key === 'Enter') handleSearch();
                        }}
                    />
                    <button
                        onClick={handleSearch}
                        disabled={loading || searchTerm.trim().length < 2}
                        className="bg-primary hover:bg-primary-dark text-black font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center disabled:opacity-50"
                    >
                        {loading ? <Loader2 className="animate-spin" size={20} /> : <Search size={20} />}
                    </button>
                </div>
                
                <div className="flex-grow overflow-y-auto space-y-4 divide-y divide-gray-100">
                    {modalTarget === 'breeder' && userProfile && (
                        <div className="border rounded-lg bg-white shadow-sm mb-4">
                            <h4 className="font-bold text-gray-700 p-3 bg-primary/20 border-b">
                                Your Profile
                            </h4>
                            <UserResultCard user={userProfile} />
                        </div>
                    )}
                    {loading ? <LoadingSpinner /> : results.length > 0 ? (
                        <div className="border rounded-lg bg-white shadow-sm">
                            <h4 className="font-bold text-gray-700 p-3 bg-gray-50 border-b">
                                {searchType === 'users' ? `Users (${results.length})` : `Animals (${results.length})`}
                            </h4>
                            {searchType === 'users' 
                                ? results.map(user => <UserResultCard key={user.id_public} user={user} />)
                                : results.map(animal => <AnimalResultCard key={animal.id_public} animal={animal} />)
                            }
                        </div>
                    ) : hasSearched && !loading ? (
                        <p className="text-center text-gray-500 py-4">
                            No {searchType === 'users' ? 'users' : 'animals'} found matching your search.
                        </p>
                    ) : (
                        <p className="text-center text-gray-500 py-4">
                            Enter a name or ID to search for {searchType === 'users' ? 'users' : 'animals'}.
                        </p>
                    )}
                </div>
            </div>
        </div>
    );
};

// Public Profile View Component - Shows a breeder's public animals
const PublicProfileView = ({ profile, onBack, onViewAnimal, API_BASE_URL, onStartMessage, authToken, setModCurrentContext }) => {
    const [animals, setAnimals] = useState([]);
    const [loading, setLoading] = useState(true);
    const [copySuccess, setCopySuccess] = useState(false);
    const [speciesFilter, setSpeciesFilter] = useState('');
    const [genderFilters, setGenderFilters] = useState({ Male: true, Female: true, Intersex: true, Unknown: true });
    const [statusFilter, setStatusFilter] = useState('');
    const [freshProfile, setFreshProfile] = useState(profile);
    
    // Set moderator context when viewing this profile
    useEffect(() => {
        if (setModCurrentContext && profile) {
            setModCurrentContext({
                type: 'profile',
                id: profile.id_public,
                name: profile.personalName || profile.breederName,
                userId: profile.userId_backend
            });
        }
        return () => {
            if (setModCurrentContext) {
                setModCurrentContext(null);
            }
        };
    }, [profile, setModCurrentContext]);
    
    // Force-refetch latest public profile to ensure flags like allowMessages are current
    useEffect(() => {
        const fetchProfile = async () => {
            if (!profile?.id_public) return;
            try {
                const resp = await axios.get(`${API_BASE_URL}/public/profile/${profile.id_public}`);
                setFreshProfile(resp.data || profile);
            } catch (err) {
                console.warn('Failed to refresh public profile, using provided profile', err);
                setFreshProfile(profile);
            }
        };
        fetchProfile();
    }, [profile?.id_public, profile, API_BASE_URL]);
    
    const handleShare = () => {
        const url = `${window.location.origin}/user/${(freshProfile?.id_public || profile.id_public)}`;
        navigator.clipboard.writeText(url).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        });
    };

    useEffect(() => {
        const fetchPublicAnimals = async () => {
            try {
                setLoading(true);
                const response = await axios.get(`${API_BASE_URL}/public/animals/${profile.id_public}`);
                setAnimals(response.data || []);
            } catch (error) {
                console.error('Error fetching public animals:', error);
                setAnimals([]);
            } finally {
                setLoading(false);
            }
        };

        if (profile) {
            fetchPublicAnimals();
        }
    }, [profile, API_BASE_URL]);

    const memberSince = (freshProfile?.createdAt || profile.createdAt)
        ? new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(freshProfile?.createdAt || profile.createdAt))
        : ((freshProfile?.updatedAt || profile.updatedAt) ? new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(freshProfile?.updatedAt || profile.updatedAt)) : 'Unknown');

    // Determine display name(s) - respect privacy settings
    const showPersonalName = (freshProfile?.showPersonalName ?? profile.showPersonalName ?? false);
    const showBreederName = (freshProfile?.showBreederName ?? profile.showBreederName ?? false);
    
    const showBothNames = showPersonalName && showBreederName && profile.personalName && profile.breederName;
    const displayName = showBothNames 
        ? `${(freshProfile?.personalName || profile.personalName)} (${(freshProfile?.breederName || profile.breederName)})`
        : (showBreederName && (freshProfile?.breederName || profile.breederName) 
            ? (freshProfile?.breederName || profile.breederName)
            : (showPersonalName && (freshProfile?.personalName || profile.personalName) 
                ? (freshProfile?.personalName || profile.personalName)
                : 'Anonymous Breeder'));

    // Apply filters
    const filteredAnimals = animals.filter(animal => {
        if (speciesFilter && animal.species !== speciesFilter) return false;
        // Show nothing if both genders are unchecked
        if (!genderFilters.Male && !genderFilters.Female) return false;
        // Filter by selected genders
        if (!genderFilters[animal.gender]) return false;
        if (statusFilter && animal.status !== statusFilter) return false;
        return true;
    });

    const groupedAnimals = filteredAnimals.reduce((groups, animal) => {
        const species = animal.species || 'Unspecified';
        if (!groups[species]) groups[species] = [];
        groups[species].push(animal);
        return groups;
    }, {});

    const sortedSpecies = Object.keys(groupedAnimals).sort((a, b) => {
        const order = ['Mouse', 'Rat', 'Hamster'];
        const aIndex = order.indexOf(a);
        const bIndex = order.indexOf(b);
        
        // If both are in the base order, sort by their position
        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
        // If only a is in base order, it comes first
        if (aIndex !== -1) return -1;
        // If only b is in base order, it comes first
        if (bIndex !== -1) return 1;
        // Otherwise, alphabetical sort
        return a.localeCompare(b);
    });

    return (
        <div className="w-full max-w-6xl bg-white p-6 rounded-xl shadow-lg">
            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-6">
                <button 
                    onClick={onBack} 
                    className="flex items-center text-gray-600 hover:text-gray-800 transition"
                >
                    <ArrowLeft size={18} className="mr-1" /> Back
                </button>
                <div className="flex gap-2 flex-wrap">
                    {onStartMessage && freshProfile?.allowMessages === true && (
                        <button
                            onClick={onStartMessage}
                            data-tutorial-target="profile-message-btn"
                            className="px-3 py-1.5 bg-accent hover:bg-accent/80 text-white font-semibold rounded-lg transition flex items-center gap-2"
                        >
                            <MessageSquare size={16} />
                            Message
                        </button>
                    )}
                    <button
                        onClick={handleShare}
                        className="px-3 py-1.5 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-2"
                    >
                        <Link size={16} />
                        {copySuccess ? 'Link Copied!' : 'Share Profile'}
                    </button>
                    <ReportButton
                        contentType="profile"
                        contentId={profile.id_public}
                        contentOwnerId={profile.userId_backend}
                        authToken={authToken}
                        API_BASE_URL={API_BASE_URL}
                        tooltipText="Report this profile"
                    />
                </div>
            </div>

            {/* Profile Header */}
            <div className="flex flex-col sm:flex-row sm:items-center gap-4 mb-6 pb-6 border-b">
                {profile.profileImage ? (
                    <img src={profile.profileImage} alt={displayName} className="w-24 h-24 rounded-lg object-cover shadow-md flex-shrink-0" />
                ) : (
                    <div className="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center shadow-md flex-shrink-0">
                        <User size={48} className="text-gray-400" />
                    </div>
                )}
                <div className="min-w-0 flex-1">
                    <div className="flex items-center gap-3 mb-2">
                        <h2 className="text-2xl sm:text-3xl font-bold text-gray-900 break-words">{displayName}</h2>
                        <DonationBadge user={freshProfile || profile} size="md" />
                    </div>
                    <p className="text-gray-600">Public ID: <span className="font-mono text-accent">{freshProfile?.id_public || profile.id_public}</span></p>
                    <p className="text-sm text-gray-500 mt-1">Member since {memberSince}</p>
                    
                    {/* Country - Show if available */}
                    {(freshProfile?.country || profile.country) && (
                        <p className="text-sm text-gray-600 mt-1 flex items-center gap-2">
                            <span className={`${getCountryFlag(freshProfile?.country || profile.country)} inline-block h-5 w-7 flex-shrink-0`}></span>
                            <span>{getCountryName(freshProfile?.country || profile.country)}{(freshProfile?.country || profile.country) === 'US' && (freshProfile?.state || profile.state) ? `, ${getStateName(freshProfile?.state || profile.state)}` : ''}</span>
                        </p>
                    )}
                    
                    {/* Bio - Show if available and public */}
                    {(freshProfile?.showBio ?? profile.showBio ?? true) && (freshProfile?.bio || profile.bio) && (
                        <p className="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200 whitespace-pre-wrap break-words">
                            {freshProfile?.bio || profile.bio}
                        </p>
                    )}
                    
                    {/* Email - Show if public */}
                    {(freshProfile?.showEmailPublic ?? profile.showEmailPublic) && (freshProfile?.email || profile.email) && (
                        <p className="text-sm text-gray-700 mt-2 flex items-center gap-2 break-all">
                            <Mail size={16} className="text-accent flex-shrink-0" />
                            <a href={`mailto:${freshProfile?.email || profile.email}`} className="hover:text-accent transition underline break-all">
                                {freshProfile?.email || profile.email}
                            </a>
                        </p>
                    )}
                    
                    {/* Website - Show if public */}
                    {(freshProfile?.showWebsiteURL ?? profile.showWebsiteURL) && (freshProfile?.websiteURL || profile.websiteURL) && (
                        <p className="text-sm text-gray-700 mt-2 flex items-start gap-2 break-all">
                            <Globe size={16} className="text-accent flex-shrink-0 mt-0.5" />
                            <a href={freshProfile?.websiteURL || profile.websiteURL} target="_blank" rel="noopener noreferrer" className="hover:text-accent transition underline break-all">
                                {freshProfile?.websiteURL || profile.websiteURL}
                            </a>
                        </p>
                    )}
                </div>
            </div>

            {/* Public Animals */}
            <h3 className="text-2xl font-bold text-gray-800 mb-4">Public Animals ({filteredAnimals.length})</h3>
            
            {/* Filters */}
            <div className="mb-6 p-4 border rounded-lg bg-gray-50">
                    {/* Species dropdown, Gender icons, and Status dropdown - all in one row */}
                    <div className="flex flex-col sm:flex-row gap-3 justify-between">
                        <div className="flex gap-3 items-center flex-wrap">
                            {/* Species dropdown */}
                            <div className="flex gap-2 items-center" data-tutorial-target="species-filter">
                                <span className='text-sm font-medium text-gray-700 whitespace-nowrap'>Species:</span>
                                <select 
                                    value={speciesFilter}
                                    onChange={(e) => setSpeciesFilter(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition min-w-[150px]"
                                >
                                    <option value="">All Species</option>
                                    {sortedSpecies.map(species => (
                                        <option key={species} value={species}>{getSpeciesDisplayName(species)}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Gender filter with icons */}
                            <div className="flex gap-2 items-center" data-tutorial-target="gender-filter">
                                <span className='text-sm font-medium text-gray-700 whitespace-nowrap'>Gender:</span>
                                <button 
                                    onClick={() => setGenderFilters(prev => ({ ...prev, Male: !prev.Male }))}
                                    className={`p-2 rounded-lg transition duration-150 shadow-sm ${
                                        genderFilters.Male ? 'bg-primary' : 'bg-gray-300 hover:bg-gray-400'
                                    }`}
                                    title="Male"
                                >
                                    <Mars size={18} className="text-black" />
                                </button>
                                <button 
                                    onClick={() => setGenderFilters(prev => ({ ...prev, Female: !prev.Female }))}
                                    className={`p-2 rounded-lg transition duration-150 shadow-sm ${
                                        genderFilters.Female ? 'bg-pink-400' : 'bg-gray-300 hover:bg-gray-400'
                                    }`}
                                    title="Female"
                                >
                                    <Venus size={18} className="text-black" />
                                </button>
                                <button 
                                    onClick={() => setGenderFilters(prev => ({ ...prev, Intersex: !prev.Intersex }))}
                                    className={`p-2 rounded-lg transition duration-150 shadow-sm ${
                                        genderFilters.Intersex ? 'bg-purple-400' : 'bg-gray-300 hover:bg-gray-400'
                                    }`}
                                    title="Intersex"
                                >
                                    <VenusAndMars size={18} className="text-black" />
                                </button>
                                <button 
                                    onClick={() => setGenderFilters(prev => ({ ...prev, Unknown: !prev.Unknown }))}
                                    className={`p-2 rounded-lg transition duration-150 shadow-sm ${
                                        genderFilters.Unknown ? 'bg-teal-400' : 'bg-gray-300 hover:bg-gray-400'
                                    }`}
                                    title="Unknown"
                                >
                                    <Circle size={18} className="text-black" />
                                </button>
                            </div>
                        </div>
                        
                        {/* Status dropdown on right */}
                        <div className="flex gap-2 items-center" data-tutorial-target="status-filter">
                            <span className='text-sm font-medium text-gray-700 whitespace-nowrap'>Status:</span>
                            <select 
                                value={statusFilter} 
                                onChange={(e) => setStatusFilter(e.target.value)} 
                                className="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition min-w-[150px]"
                            >
                                <option value="">All</option>
                                {STATUS_OPTIONS.map(status => (
                                    <option key={status} value={status}>{status}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                </div>
            
            {loading ? (
                <LoadingSpinner />
            ) : filteredAnimals.length === 0 && animals.length > 0 ? (
                <div className="text-center py-12 text-gray-500">
                    <Cat size={48} className="mx-auto mb-4 text-gray-300" />
                    <p>No animals match the selected filters.</p>
                </div>
            ) : animals.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                    <Cat size={48} className="mx-auto mb-4 text-gray-300" />
                    <p>This breeder has no public animals.</p>
                </div>
            ) : (
                <div className="space-y-6">
                    {sortedSpecies.map(species => (
                        <div key={species} className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                                <Cat size={20} className="mr-2" /> {getSpeciesDisplayName(species)}
                            </h4>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                {groupedAnimals[species].map(animal => {
                                    const birth = animal.birthDate ? formatDate(animal.birthDate) : '';
                                    const imgSrc = animal.imageUrl || animal.photoUrl || null;
                                    
                                    return (
                                        <div key={animal.id_public} className="w-full flex justify-center">
                                            <div
                                                onClick={() => onViewAnimal(animal)}
                                                className="relative bg-white rounded-xl shadow-sm w-44 h-56 flex flex-col items-center overflow-hidden cursor-pointer hover:shadow-md transition border-2 border-gray-300 pt-3"
                                            >
                                                {/* Birthdate top-left */}
                                                {birth && (
                                                    <div className="absolute top-2 left-2 text-xs text-gray-600 bg-white/80 px-2 py-0.5 rounded">
                                                        {birth}
                                                    </div>
                                                )}

                                                {/* Gender badge top-right */}
                                                {animal.gender && (
                                                    <div className="absolute top-2 right-2" title={animal.gender}>
                                                        {animal.gender === 'Male' ? <Mars size={16} strokeWidth={2.5} className="text-primary" /> : animal.gender === 'Female' ? <Venus size={16} strokeWidth={2.5} className="text-accent" /> : animal.gender === 'Intersex' ? <VenusAndMars size={16} strokeWidth={2.5} className="text-purple-500" /> : <Circle size={16} strokeWidth={2.5} className="text-gray-500" />}
                                                    </div>
                                                )}

                                                {/* Centered profile image */}
                                                <div className="flex items-center justify-center w-full px-2 mt-1 h-28">
                                                    {imgSrc ? (
                                                        <img src={imgSrc} alt={animal.name} className="max-w-24 max-h-24 w-auto h-auto object-contain rounded-md" />
                                                    ) : (
                                                        <div className="w-24 h-24 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                            <Cat size={36} />
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {/* Icon row */}
                                                <div className="w-full flex justify-center items-center space-x-2 py-1">
                                                    {/* No icons for public profile - they don't apply */}
                                                </div>
                                                
                                                {/* Prefix / Name under image */}
                                                <div className="w-full text-center px-2 pb-1">
                                                    <div className="text-sm font-semibold text-gray-800 line-clamp-2">{animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}</div>
                                                </div>

                                                {/* ID bottom-right */}
                                                <div className="w-full px-2 pb-2 flex justify-end">
                                                    <div className="text-xs text-gray-500">{animal.id_public}</div>
                                                </div>
                                                
                                                {/* Status bar at bottom */}
                                                <div className="w-full bg-gray-100 py-1 text-center border-t border-gray-300 mt-auto">
                                                    <div className="text-xs font-medium text-gray-700">{animal.status || 'Unknown'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

// ==================== DETAIL VIEW TEMPLATE HOOK ====================
// Custom hook for template-aware labels in all detail views
const useDetailFieldTemplate = (species, API_BASE_URL) => {
    const [fieldTemplate, setFieldTemplate] = useState(null);
    useEffect(() => {
        if (!species || !API_BASE_URL) return;
        axios.get(`${API_BASE_URL}/species/with-template/${encodeURIComponent(species)}`)
            .then(res => setFieldTemplate(res.data?.fieldTemplate || null))
            .catch(() => setFieldTemplate(null));
    }, [species, API_BASE_URL]);
    const getLabel = (fieldName, defaultLabel) =>
        fieldTemplate?.fields?.[fieldName]?.label || defaultLabel;
    return { fieldTemplate, getLabel };
};

// ==================== DETAIL VIEW HELPERS ====================
const parseJsonField = (data) => {
    if (!data) return [];
    if (Array.isArray(data)) return data;
    try { return JSON.parse(data); } catch { return []; }
};

const DetailJsonList = ({ label, data, renderItem }) => {
    const items = parseJsonField(data);
    if (!items.length) return null;
    return (
        <div>
            <strong className="text-sm text-gray-700">{label}:</strong>
            <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                {items.map((item, i) => <li key={i} className="text-gray-700">{renderItem(item)}</li>)}
            </ul>
        </div>
    );
};

// ==================== PRIVATE ANIMAL DETAIL (OWNER VIEW) ====================
// Shows ALL data for animal owners viewing their own animals (ignores privacy toggles)
// Accessed from: MY ANIMALS LIST
const PrivateAnimalDetail = ({ animal, onClose, onCloseAll, onEdit, API_BASE_URL, authToken, setShowImageModal, setEnlargedImageUrl, onUpdateAnimal, onHideAnimal, showModalMessage, onTransfer, onViewAnimal, onToggleOwned, userProfile }) => {
    const [breederInfo, setBreederInfo] = useState(null);
    const [showPedigree, setShowPedigree] = useState(false);
    const [detailViewTab, setDetailViewTab] = useState(1);
    const [copySuccess, setCopySuccess] = useState(false);
    const [enclosureInfo, setEnclosureInfo] = useState(null);
    const [animalLogs, setAnimalLogs] = useState(null); // null = not yet fetched
    const [animalLogsLoading, setAnimalLogsLoading] = useState(false);
    const [animalCOI, setAnimalCOI] = useState(null);
    const [loadingCOI, setLoadingCOI] = useState(false);
    const [collapsedHealthSections, setCollapsedHealthSections] = useState({});
    const [breedingRecordOffspring, setBreedingRecordOffspring] = useState({});
    const [breedingRecordLitters, setBreedingRecordLitters] = useState({});
    const [expandedBreedingRecords, setExpandedBreedingRecords] = useState({});
    const [showCreateLitterModal, setShowCreateLitterModal] = useState(false);
    const [showLinkLitterModal, setShowLinkLitterModal] = useState(false);
    const [breedingRecordForLitter, setBreedingRecordForLitter] = useState(null);
    const { fieldTemplate, getLabel } = useDetailFieldTemplate(animal?.species, API_BASE_URL);

    // Fetch offspring for breeding records with linked litters (on expand)
    React.useEffect(() => {
        if (!animal?.breedingRecords?.length || !authToken) return;
        const expanded = Object.entries(expandedBreedingRecords);
        expanded.forEach(([idxStr, isExpanded]) => {
            if (!isExpanded) return;
            const idx = parseInt(idxStr);
            const record = animal.breedingRecords[idx];
            if (!record?.litterId || breedingRecordOffspring[record.litterId] !== undefined) return;
            const fetch = async () => {
                try {
                    const [littersRes, animalsRes] = await Promise.all([
                        axios.get(`${API_BASE_URL}/litters`, { headers: { Authorization: `Bearer ${authToken}` } }),
                        axios.get(`${API_BASE_URL}/animals`, { headers: { Authorization: `Bearer ${authToken}` } })
                    ]);
                    const litter = littersRes.data.find(l => l.litter_id_public === record.litterId);
                    if (litter) setBreedingRecordLitters(prev => ({ ...prev, [record.litterId]: litter }));
                    if (!litter?.offspringIds_public?.length) {
                        setBreedingRecordOffspring(prev => ({ ...prev, [record.litterId]: [] }));
                        return;
                    }
                    const offspring = animalsRes.data.filter(a => litter.offspringIds_public.includes(a.id_public));
                    setBreedingRecordOffspring(prev => ({ ...prev, [record.litterId]: offspring }));
                } catch (e) {
                    setBreedingRecordOffspring(prev => ({ ...prev, [record.litterId]: [] }));
                }
            };
            fetch();
        });
    }, [expandedBreedingRecords, animal?.breedingRecords, authToken, API_BASE_URL]);


    // Fetch assigned enclosure info
    React.useEffect(() => {
        if (!animal?.enclosureId || !authToken) { setEnclosureInfo(null); return; }
        axios.get(`${API_BASE_URL}/enclosures`, { headers: { Authorization: `Bearer ${authToken}` } })
            .then(res => setEnclosureInfo(res.data.find(e => e._id === animal.enclosureId) || null))
            .catch(() => setEnclosureInfo(null));
    }, [animal?.enclosureId, authToken, API_BASE_URL]);

    // Fetch logs when Logs tab is opened (lazy, once per animal)
    React.useEffect(() => {
        if (detailViewTab !== 14 || animalLogs !== null || !animal?.id_public || !authToken) return;
        setAnimalLogsLoading(true);
        axios.get(`${API_BASE_URL}/animals/${animal.id_public}/logs`, { headers: { Authorization: `Bearer ${authToken}` } })
            .then(res => setAnimalLogs(res.data || []))
            .catch(() => setAnimalLogs([]))
            .finally(() => setAnimalLogsLoading(false));
    }, [detailViewTab, animal?.id_public, authToken, API_BASE_URL, animalLogs]);
    
    // Fetch COI when component mounts or animal changes (if animal has both parents)
    React.useEffect(() => {
        const fetchCOI = async () => {
            const sireId = animal?.fatherId_public || animal?.sireId_public;
            const damId = animal?.motherId_public || animal?.damId_public;
            
            if (animal?.id_public && sireId && damId) {
                setLoadingCOI(true);
                try {
                    const response = await axios.get(
                        `${API_BASE_URL}/animals/${animal.id_public}/inbreeding`,
                        { headers: { Authorization: `Bearer ${authToken}` } }
                    );
                    if (response.data && response.data.inbreedingCoefficient != null) {
                        setAnimalCOI(response.data.inbreedingCoefficient);
                    }
                } catch (error) {
                    console.error('Failed to fetch COI:', error);
                    setAnimalCOI(null);
                } finally {
                    setLoadingCOI(false);
                }
            } else {
                setAnimalCOI(null);
            }
        };
        fetchCOI();
    }, [animal?.id_public, animal?.fatherId_public, animal?.sireId_public, animal?.motherId_public, animal?.damId_public, API_BASE_URL, authToken]);
    
    const handleShare = () => {
        const url = `${window.location.origin}/animal/${animal.id_public}`;
        navigator.clipboard.writeText(url).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        });
    };
    
    // Fetch breeder info when component mounts or animal changes
    React.useEffect(() => {
        const fetchBreeder = async () => {
            if (animal?.breederId_public) {
                try {
                    const response = await axios.get(
                        `${API_BASE_URL}/public/profiles/search?query=${animal.breederId_public}&limit=1`
                    );
                    if (response.data && response.data.length > 0) {
                        setBreederInfo(response.data[0]);
                    }
                } catch (error) {
                    console.error('Failed to fetch breeder info:', error);
                    setBreederInfo(null);
                }
            } else {
                setBreederInfo(null);
            }
        };
        fetchBreeder();
    }, [animal?.breederId_public, API_BASE_URL]);
    
    if (!animal) return null;

    return (
        <div className="fixed inset-0 bg-accent/10 flex items-center justify-center p-2 sm:p-4 z-[70] overflow-y-auto">
            <div className="bg-primary rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto overflow-x-hidden">
                {/* Header */}
                <div className="bg-white rounded-t-lg p-2 sm:p-4 border-b border-gray-300 mt-12 sm:mt-0">
                    {/* Mobile layout: stacked */}
                    <div className="sm:hidden">
                        <div className="flex justify-between items-center mb-2">
                            <button 
                                onClick={onClose} 
                                className="flex items-center text-gray-600 hover:text-gray-800 transition text-sm"
                            >
                                <ArrowLeft size={16} className="mr-1" /> Back
                            </button>
                            <span className="text-[10px] bg-green-100 text-green-800 px-1.5 py-0.5 rounded font-medium">
                                 OWNER
                            </span>
                            <button onClick={onCloseAll || onClose} className="text-gray-500 hover:text-gray-800">
                                <X size={24} />
                            </button>
                        </div>
                        <div className="flex justify-center gap-1.5 flex-wrap">
                            <button
                                onClick={handleShare}
                                className="px-2 py-1 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-1 text-xs"
                                title="Copy public link"
                            >
                                <Link size={14} />
                                Share
                            </button>
                            {onEdit && (
                                <button
                                    onClick={() => onEdit(animal)}
                                    className="px-2 py-1 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-1 text-xs"
                                >
                                    <Edit size={14} />
                                    Edit
                                </button>
                            )}
                            {onTransfer && (() => {
                                const iWasTransferredThisAnimal = animal.originalOwnerId && animal.breederId_public && animal.breederId_public !== userProfile?.id_public && animal.ownerId_public === userProfile?.id_public;
                                if (iWasTransferredThisAnimal) {
                                    return (
                                        <button
                                            onClick={async () => {
                                                if (window.confirm(`Return ${animal.name} to ${animal.breederName || 'the breeder'}? This will remove the animal from your account.`)) {
                                                    try {
                                                        await axios.post(`${API_BASE_URL}/animals/${animal.id_public}/return`, {}, {
                                                            headers: { Authorization: `Bearer ${authToken}` }
                                                        });
                                                        onClose();
                                                        showModalMessage('Success', `Animal has been returned to ${animal.breederName || 'the breeder'}.`);
                                                    } catch (error) {
                                                        console.error('Failed to return animal:', error);
                                                        showModalMessage('Error', `Failed to return animal: ${error.response?.data?.message || error.message}`);
                                                    }
                                                }
                                            }}
                                            className="px-2 py-1 bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold rounded-lg transition flex items-center gap-1 text-xs"
                                            title="Return to breeder"
                                        >
                                            <RotateCcw size={14} />
                                            Return
                                        </button>
                                    );
                                }
                                return (
                                    <button
                                        onClick={() => onTransfer(animal)}
                                        className="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold rounded-lg transition flex items-center gap-1 text-xs"
                                        title="Transfer"
                                    >
                                        <ArrowLeftRight size={14} />
                                        Transfer
                                    </button>
                                );
                            })()}
                        </div>
                    </div>
                    
                    {/* Desktop layout: single row */}
                    <div className="hidden sm:flex justify-between items-center">
                        <button 
                            onClick={onClose} 
                            className="flex items-center text-gray-600 hover:text-gray-800 transition"
                        >
                            <ArrowLeft size={18} className="mr-1" /> Back
                        </button>
                        <div className="flex items-center gap-2">
                            <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-medium">
                                👁️ OWNER VIEW - All Data Visible
                            </span>
                            <button
                                onClick={handleShare}
                                className="px-3 py-1.5 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-2"
                                title="Copy public link to clipboard"
                            >
                                <Link size={16} />
                                {copySuccess ? 'Link Copied!' : 'Share'}
                            </button>
                            {onEdit && (
                                <button
                                    onClick={() => onEdit(animal)}
                                    data-tutorial-target="edit-animal-btn"
                                    className="px-3 py-1.5 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-2"
                                >
                                    <Edit size={16} />
                                    Edit
                                </button>
                            )}
                            {onTransfer && (() => {
                                const iWasTransferredThisAnimal = animal.originalOwnerId && animal.breederId_public && animal.breederId_public !== userProfile?.id_public && animal.ownerId_public === userProfile?.id_public;
                                if (iWasTransferredThisAnimal) {
                                    return (
                                        <button
                                            onClick={async () => {
                                                if (window.confirm(`Return ${animal.name} to ${animal.breederName || 'the breeder'}? This will remove the animal from your account.`)) {
                                                    try {
                                                        await axios.post(`${API_BASE_URL}/animals/${animal.id_public}/return`, {}, {
                                                            headers: { Authorization: `Bearer ${authToken}` }
                                                        });
                                                        onClose();
                                                        showModalMessage('Success', `Animal has been returned to ${animal.breederName || 'the breeder'}.`);
                                                    } catch (error) {
                                                        console.error('Failed to return animal:', error);
                                                        showModalMessage('Error', `Failed to return animal: ${error.response?.data?.message || error.message}`);
                                                    }
                                                }
                                            }}
                                            className="px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold rounded-lg transition flex items-center gap-2"
                                            title="Return to breeder"
                                        >
                                            <RotateCcw size={16} />
                                            Return Animal
                                        </button>
                                    );
                                }
                                return (
                                    <button
                                        onClick={() => onTransfer(animal)}
                                        className="px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold rounded-lg transition flex items-center gap-2"
                                        title="Transfer this animal"
                                    >
                                        <ArrowLeftRight size={16} />
                                        Transfer
                                    </button>
                                );
                            })()}
                            <button onClick={onCloseAll || onClose} className="text-gray-500 hover:text-gray-800">
                                <X size={28} />
                            </button>
                        </div>
                    </div>
                </div>

                {/* Tabs - ALL 11 TABS */}
                <div className="bg-white border-b border-gray-300 px-2 sm:px-6 pt-2 sm:pt-4">
                    <div className="flex flex-wrap gap-1 sm:gap-1 pb-2 sm:pb-4">
                        {[
                            { id: 1, label: 'Overview', icon: '📋' },
                            { id: 2, label: 'Status & Privacy', icon: '🔒' },
                            { id: 3, label: 'Physical', icon: '🎨' },
                            { id: 4, label: 'Identification', icon: '🏷️' },
                            { id: 5, label: 'Lineage', icon: '🌳' },
                            { id: 6, label: 'Breeding', icon: '🥚' },
                            { id: 7, label: 'Health', icon: '🏥' },
                            { id: 8, label: 'Animal Care', icon: '🏠' },
                            { id: 9, label: 'Behavior', icon: '🧠' },
                            { id: 10, label: 'Records', icon: '📝' },
                            { id: 11, label: 'End of Life', icon: '⚖️' },
                            { id: 12, label: 'Show', icon: '🏆' },
                            { id: 13, label: 'Legal', icon: '📄' },
                            { id: 14, label: 'Logs', icon: '📜' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                type="button"
                                onClick={() => setDetailViewTab(tab.id)}
                                className={`flex-shrink-0 px-2.5 sm:px-3 py-2 sm:py-2 text-base sm:text-sm font-medium rounded border transition-colors ${
                                    detailViewTab === tab.id 
                                        ? 'bg-primary text-black border-gray-400' 
                                        : 'bg-gray-50 text-gray-600 hover:text-gray-800 border-gray-300'
                                }`}
                                title={tab.label}
                            >
                                <span className="sm:mr-1">{tab.icon}</span>
                                <span className="hidden lg:inline">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Tab Content */}
                <div className="bg-white border border-t-0 border-gray-300 rounded-b-lg p-3 sm:p-6 overflow-y-auto max-h-[calc(95vh-160px)] sm:max-h-[calc(90vh-180px)]">
                    {/* Tab 1: Overview */}
                    {detailViewTab === 1 && (
                        <div className="space-y-4">
                            <div className="bg-white border-2 border-gray-300 rounded-lg overflow-hidden">
                                <div className="flex flex-col md:flex-row relative">
                                    <div className="w-full md:w-1/3 p-4 sm:p-6 flex flex-col items-center justify-center relative min-h-60 md:min-h-80">
                                        <div className="absolute top-2 left-2 text-xs text-gray-600 bg-white/80 px-2 py-0.5 rounded">
                                            {animal.birthDate ? formatDate(animal.birthDate) : ''}
                                        </div>
                                        <div className="absolute top-2 right-2">
                                            {animal.gender === 'Male' ? <Mars size={20} strokeWidth={2.5} className="text-blue-600" /> : animal.gender === 'Female' ? <Venus size={20} strokeWidth={2.5} className="text-pink-600" /> : animal.gender === 'Intersex' ? <VenusAndMars size={20} strokeWidth={2.5} className="text-purple-500" /> : <Circle size={20} strokeWidth={2.5} className="text-gray-500" />}
                                        </div>
                                        <div className="flex items-center justify-center h-40 w-full">
                                            {(animal.imageUrl || animal.photoUrl) ? (
                                                <img 
                                                    src={animal.imageUrl || animal.photoUrl} 
                                                    alt={animal.name} 
                                                    className="max-w-32 max-h-32 w-auto h-auto object-contain rounded-md cursor-pointer hover:opacity-80 transition"
                                                    onClick={() => {
                                                        if (setEnlargedImageUrl && setShowImageModal) {
                                                            setEnlargedImageUrl(animal.imageUrl || animal.photoUrl);
                                                            setShowImageModal(true);
                                                        }
                                                    }}
                                                />
                                            ) : (
                                                <div className="w-32 h-32 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                    <Cat size={48} />
                                                </div>
                                            )}
                                        </div>
                                        <div className="text-sm font-medium text-gray-700 mt-2">
                                            {animal.status || 'Unknown'}
                                        </div>
                                    </div>

                                    <div className="w-full md:w-2/3 p-4 sm:p-6 flex flex-col border-t md:border-t-0 md:border-l border-gray-300 space-y-3">
                                        {/* Species/Breed/Strain/CTC + Toggle Controls - same row */}
                                        <div className="flex items-center justify-between gap-2">
                                            <p className="text-sm text-gray-600">
                                                {animal.species || 'Unknown'}
                                                {animal.breed && ` � ${animal.breed}`}
                                                {animal.strain && ` � ${animal.strain}`}
                                                {animal.id_public && ` � ${animal.id_public}`}
                                            </p>
                                            <div className="flex gap-2 shrink-0">
                                            {/* Owned Toggle */}
                                            <button
                                                onClick={() => {
                                                    onToggleOwned && onToggleOwned(animal.id_public, !animal.isOwned);
                                                }}
                                                className={`flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg font-medium text-sm transition ${
                                                    animal.isOwned 
                                                        ? 'bg-red-100 text-red-800 hover:bg-red-200' 
                                                        : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                                                }`}
                                                title="Toggle owned status"
                                                data-tutorial-target="detail-owned-toggle"
                                            >
                                                {animal.isOwned ? <Heart size={16} /> : <HeartOff size={16} />}
                                                <span>{animal.isOwned ? 'Owned' : 'Not Owned'}</span>
                                            </button>

                                            {/* Public Profile Toggle */}
                                            <button
                                                onClick={() => {
                                                    const newIsDisplay = !animal.isDisplay;
                                                    axios.put(`${API_BASE_URL}/animals/${animal.id_public}`, { isDisplay: newIsDisplay }, {
                                                        headers: { Authorization: `Bearer ${authToken}` }
                                                    }).then(() => {
                                                        // Update animal state directly without closing modal
                                                        if (onUpdateAnimal) {
                                                            onUpdateAnimal({ ...animal, isDisplay: newIsDisplay });
                                                        }
                                                    }).catch(err => {
                                                        console.error('Failed to update isDisplay:', err);
                                                    });
                                                }}
                                                data-tutorial-target="detail-private-toggle"
                                                className={`flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg font-medium text-sm transition ${animal.isDisplay ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                                                title="Toggle public profile visibility"
                                            >
                                                {animal.isDisplay ? <Eye size={16} /> : <EyeOff size={16} />}
                                                <span>{animal.isDisplay ? 'Public' : 'Private'}</span>
                                            </button>
                                            </div>
                                        </div>

                                        {/* Full Name */}
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            {animal.prefix ? `${animal.prefix} ` : ''}
                                            {animal.name}
                                            {animal.suffix ? ` ${animal.suffix}` : ''}
                                        </h2>

                                        {/* For Sale Badge */}
                                        {animal.isForSale && (
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                                                <span className="text-lg">🏷️</span>
                                                <div>
                                                    <p className="text-sm font-semibold text-gray-700">For Sale</p>
                                                    <p className="text-sm text-gray-600">
                                                        {animal.salePriceCurrency === 'Negotiable' || !animal.salePriceAmount ? 'Negotiable' : `${getCurrencySymbol(animal.salePriceCurrency)}${animal.salePriceAmount ? ` ${animal.salePriceAmount}` : ''}`}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* For Stud Badge */}
                                        {animal.availableForBreeding && (
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-2">
                                                <span className="text-lg">🏷️</span>
                                                <div>
                                                    <p className="text-sm font-semibold text-gray-700">Available for Stud</p>
                                                    <p className="text-sm text-gray-600">
                                                        {animal.studFeeCurrency === 'Negotiable' || !animal.studFeeAmount ? 'Negotiable' : `${getCurrencySymbol(animal.studFeeCurrency)}${animal.studFeeAmount ? ` ${animal.studFeeAmount}` : ''}`}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* Variety */}
                                        <p className="text-sm text-gray-700">
                                            <span className="font-semibold">Variety:</span> {[
                                                animal.color,
                                                animal.coatPattern,
                                                animal.coat,
                                                animal.earset,
                                                animal.phenotype,
                                                animal.morph,
                                                animal.markings,
                                                animal.eyeColor,
                                                animal.nailColor,
                                                animal.carrierTraits,
                                                animal.size
                                            ].filter(Boolean).join(' ') || ''}
                                        </p>

                                        {/* Genetic Code */}
                                        {animal.geneticCode && (
                                            <p className="text-sm text-gray-700">
                                                <span className="font-semibold">Genetic Code:</span> <code className="bg-gray-100 px-1 rounded font-mono">{animal.geneticCode}</code>
                                            </p>
                                        )}

                                        {/* Date of Birth and Age/Deceased */}
                                        <div className="text-sm text-gray-700 space-y-1">
                                            <p>
                                                <span className="font-semibold">Date of Birth:</span> {animal.birthDate ? `${formatDate(animal.birthDate)} (~${(() => {
                                                    const birth = new Date(animal.birthDate);
                                                    const endDate = animal.deceasedDate ? new Date(animal.deceasedDate) : new Date();
                                                    let years = endDate.getFullYear() - birth.getFullYear();
                                                    let months = endDate.getMonth() - birth.getMonth();
                                                    let days = endDate.getDate() - birth.getDate();
                                                    
                                                    if (days < 0) {
                                                        months--;
                                                        const prevMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                                                        days += prevMonth.getDate();
                                                    }
                                                    if (months < 0) {
                                                        years--;
                                                        months += 12;
                                                    }
                                                    
                                                    if (years > 0) {
                                                        return `${years}y ${months}m ${days}d`;
                                                    } else if (months > 0) {
                                                        return `${months}m ${days}d`;
                                                    } else {
                                                        return `${days}d`;
                                                    }
                                                })()})` : ''}
                                            </p>
                                            {animal.deceasedDate && (
                                                <p className="text-red-600 font-semibold">
                                                    Deceased: {formatDate(animal.deceasedDate)}
                                                </p>
                                            )}
                                        </div>

                                        {/* Remarks */}
                                        {animal.remarks && (
                                            <div className="text-sm text-gray-700">
                                                <span className="font-semibold">Remarks:</span>
                                                <strong className="block mt-0.5 whitespace-pre-wrap">{animal.remarks}</strong>
                                            </div>
                                        )}

                                        {/* Tags - Bottom Right */}
                                        {animal.tags && animal.tags.length > 0 && (
                                            <div className="absolute bottom-4 right-4 flex flex-wrap gap-1.5 justify-end max-w-xs">
                                                {animal.tags.map((tag, idx) => (
                                                    <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                        {tag}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Breeder Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">⭐ Breeder</h3>
                                <p className="text-gray-700">
                                    {breederInfo ? (() => {
                                        const showPersonal = breederInfo.showPersonalName ?? false;
                                        const showBreeder = breederInfo.showBreederName ?? false;
                                        let bDisplayName;
                                        if (showPersonal && showBreeder && breederInfo.personalName && breederInfo.breederName) {
                                            bDisplayName = `${breederInfo.personalName} (${breederInfo.breederName})`;
                                        } else if (showBreeder && breederInfo.breederName) {
                                            bDisplayName = breederInfo.breederName;
                                        } else if (showPersonal && breederInfo.personalName) {
                                            bDisplayName = breederInfo.personalName;
                                        } else {
                                            bDisplayName = 'Unknown Breeder';
                                        }
                                        return <RouterLink to={`/user/${breederInfo.id_public}`} className="text-blue-600 hover:underline font-semibold">{bDisplayName}</RouterLink>;
                                    })() : ((animal.manualBreederName || animal.breederId_public) ? <span className="font-mono text-accent">{animal.manualBreederName || animal.breederId_public}</span> : '')}
                                </p>
                            </div>

                            {/* Identification Numbers Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🔢 Identification Numbers</h3>
                                <div className="space-y-2 text-sm">
                                    <p><span className="text-gray-600">CritterTrack ID:</span> <strong>{animal.id_public || ''}</strong></p>
                                    {animal.breederAssignedId && <p><span className="text-gray-600">Identification:</span> <strong>{animal.breederAssignedId}</strong></p>}
                                    {animal.microchipNumber && <p><span className="text-gray-600">Microchip:</span> <strong>{animal.microchipNumber}</strong></p>}
                                    {animal.pedigreeRegistrationId && <p><span className="text-gray-600">Pedigree Reg ID:</span> <strong>{animal.pedigreeRegistrationId}</strong></p>}
                                </div>
                            </div>

                            {/* Genetic Code Display Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🧬 Genetic Code</h3>
                                <p className="text-gray-700 font-mono text-sm break-all">{animal.geneticCode || ''}</p>
                            </div>

                            {/* Parents Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div className="flex items-center justify-between border-b pb-2 mb-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🌳 Parents</h3>
                                    {animalCOI != null && (
                                        <div className="text-sm text-gray-800">
                                            <span className="font-medium">COI:</span> {animalCOI.toFixed(2)}%
                                        </div>
                                    )}
                                    {loadingCOI && (
                                        <div className="text-xs text-gray-400">Calculating...</div>
                                    )}
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <ViewOnlyParentCard 
                                        parentId={animal.fatherId_public || animal.sireId_public} 
                                        parentType="Sire"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                    <ViewOnlyParentCard 
                                        parentId={animal.motherId_public || animal.damId_public} 
                                        parentType="Dam"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 2: Status & Privacy */}
                    {detailViewTab === 2 && (
                        <div className="space-y-6">
                            {/* 1st Section: Ownership */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">👥 Ownership</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Currently Owned:</span>
                                        <strong>{animal.isOwned ? 'Yes' : 'No'}</strong>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Breeder:</span>
                                        {breederInfo
                                            ? <RouterLink to={`/user/${breederInfo.id_public}`} className="text-blue-600 hover:underline font-semibold">{breederInfo.breederName || breederInfo.personalName || 'Unknown'}</RouterLink>
                                            : <strong>{animal.manualBreederName || animal.breederId_public || ''}</strong>}
                                    </div>
                                </div>
                            </div>

                            {/* 2nd Section: Current Owner */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🏠 Keeper</h3>
                                <div className="text-sm space-y-2">
                                    {(animal.keeperName || animal.isOwned) && (
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Keeper Name:</span>
                                        <strong>{animal.keeperName || (animal.isOwned ? 'Me' : '')}</strong>
                                    </div>
                                    )}
                                    {animal.coOwnership && (
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-600">Co-Ownership:</span>
                                            <strong>{animal.coOwnership}</strong>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 3rd Section: Keeper History */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">?? Keeper History</h3>
                                {(animal.keeperHistory || []).length === 0 ? (
                                    <p className="text-sm text-gray-400 italic">No entries yet</p>
                                ) : (
                                    <div className="space-y-2">
                                        {(animal.keeperHistory || []).map((entry, idx) => (
                                            <div key={idx} className="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-semibold text-gray-800">{entry.name || 'Unknown'}</p>
                                                    {entry.userId_public && <p className="text-xs text-gray-400 font-mono">{entry.userId_public}</p>}
                                                </div>
                                                {entry.country && (
                                                    <div className="flex items-center gap-1 flex-shrink-0">
                                                        <span className={`${getCountryFlag(entry.country)} inline-block h-4 w-6`}></span>
                                                        <span className="text-xs text-gray-500">{getCountryName(entry.country)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* 4th Section: Availability for Sale or Stud */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🏷️🥚 Availability for Sale or Stud</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">For Sale:</span>
                                        <strong>{animal.isForSale ? `Yes - ${getCurrencySymbol(animal.salePriceCurrency)} ${animal.salePriceAmount || 'Negotiable'}`.trim() : 'No'}</strong>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">For Stud:</span>
                                        <strong>{animal.availableForBreeding ? `Yes - ${getCurrencySymbol(animal.studFeeCurrency)} ${animal.studFeeAmount || 'Negotiable'}`.trim() : 'No'}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 3: Physical */}
                    {detailViewTab === 3 && (
                        <div className="space-y-6">
                            {/* Appearance - Always show */}
                            {(() => {
                                const fields = [
                                    { key: 'color', label: 'Color' },
                                    { key: 'coatPattern', label: 'Pattern' },
                                    { key: 'coat', label: 'Coat Type' },
                                    { key: 'earset', label: 'Earset' },
                                    { key: 'phenotype', label: 'Phenotype' },
                                    { key: 'morph', label: 'Morph' },
                                    { key: 'markings', label: 'Markings' },
                                    { key: 'eyeColor', label: 'Eye Color' },
                                    { key: 'nailColor', label: 'Nail/Claw Color' },
                                    { key: 'size', label: 'Size' },
                                    { key: 'carrierTraits', label: 'Carrier Traits' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">✨ Appearance</h3>
                                        {fields.length > 0 ? (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                {fields.map(f => (
                                                    <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-sm text-gray-500">No appearance data recorded yet.</div>
                                        )}
                                    </div>
                                );
                            })()}

                            {/* Genetic Code - Always show */}
                            {fieldTemplate?.fields?.geneticCode?.enabled !== false && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">{getLabel('geneticCode', 'Genetic Code')}</h3>
                                    <p className="text-gray-700 font-mono text-sm break-all">{animal.geneticCode || 'Not specified'}</p>
                                </div>
                            )}

                            {/* Life Stage - Always show */}
                            {fieldTemplate?.fields?.lifeStage?.enabled !== false && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">{getLabel('lifeStage', 'Life Stage')}</h3>
                                    <p className="text-gray-700 text-sm">{animal.lifeStage || 'Not specified'}</p>
                                </div>
                            )}

                            {/* Current Measurements & Growth Tracking - Always show */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📏 Measurements & Growth Tracking</h3>
                                {(() => {
                                    let growthRecords = animal.growthRecords;
                                    if (typeof growthRecords === 'string') {
                                        try { growthRecords = JSON.parse(growthRecords); } catch (e) { growthRecords = []; }
                                    }
                                    if (!Array.isArray(growthRecords)) growthRecords = [];
                                    
                                    if (growthRecords.length > 0) {
                                        const sorted = [...growthRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                                        const latest = sorted[0];
                                        return (
                                            <div className="text-sm space-y-1">
                                                <p><span className="text-gray-600">Latest Weight:</span> <strong>{latest.weight} {animal.measurementUnits?.weight || 'g'}</strong></p>
                                                {latest.length && <p><span className="text-gray-600">Latest Length:</span> <strong>{latest.length} {animal.measurementUnits?.length || 'cm'}</strong></p>}
                                                {latest.height && <p><span className="text-gray-600">Latest Height:</span> <strong>{latest.height} {animal.measurementUnits?.length || 'cm'}</strong></p>}
                                                <p className="text-gray-600 text-xs mt-2">Total measurements: {growthRecords.length} entries</p>
                                            </div>
                                        );
                                    }
                                    
                                    const mFields = [
                                        { key: 'bodyWeight', label: 'Weight' },
                                        { key: 'bodyLength', label: 'Body Length' },
                                        { key: 'heightAtWithers', label: 'Height at Withers' },
                                        { key: 'chestGirth', label: 'Chest Girth' },
                                        { key: 'adultWeight', label: 'Adult Weight' },
                                        { key: 'bodyConditionScore', label: 'Body Condition Score' },
                                        { key: 'length', label: 'Length' },
                                    ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                    
                                    return mFields.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            {mFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-sm text-gray-500">No measurements recorded yet.</div>
                                    );
                                })()}
                            </div>

                            {/* Growth Curve Charts */}
                            {(() => {
                                let growthRecords = animal.growthRecords;
                                if (typeof growthRecords === 'string') {
                                    try { growthRecords = JSON.parse(growthRecords); } catch (e) { growthRecords = []; }
                                }
                                if (!Array.isArray(growthRecords)) growthRecords = [];
                                
                                if (growthRecords.length < 1) return null;
                                
                                const sorted = [...growthRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                                const weights = sorted.map(r => parseFloat(r.weight) || 0).filter(w => w > 0);
                                const lengths = sorted
                                    .filter(record => record.length && !isNaN(parseFloat(record.length)))
                                    .map(record => parseFloat(record.length));
                                const heights = sorted
                                    .filter(record => record.height && !isNaN(parseFloat(record.height)))
                                    .map(record => parseFloat(record.height));
                                
                                if (weights.length < 1) return null;
                                
                                const width = 500;
                                const height = 250;
                                const margin = { top: 20, right: 30, bottom: 50, left: 70 };
                                const graphWidth = width - margin.left - margin.right;
                                const graphHeight = height - margin.top - margin.bottom;
                                
                                // Weight chart setup
                                const minWeight = Math.min(...weights);
                                const maxWeight = Math.max(...weights);
                                const weightPadding = (maxWeight - minWeight) * 0.1 || 5;
                                const weightChartMin = Math.max(0, minWeight - weightPadding);
                                const weightChartMax = maxWeight + weightPadding;
                                const weightRange = weightChartMax - weightChartMin;
                                
                                // Length chart setup
                                const hasLengthData = lengths.length >= 1;
                                let minLength, maxLength, lengthRange, lengthChartMin, lengthChartMax;
                                if (hasLengthData) {
                                    minLength = Math.min(...lengths);
                                    maxLength = Math.max(...lengths);
                                    const lengthPadding = (maxLength - minLength) * 0.1 || 1;
                                    lengthChartMin = Math.max(0, minLength - lengthPadding);
                                    lengthChartMax = maxLength + lengthPadding;
                                    lengthRange = lengthChartMax - lengthChartMin;
                                }
                                
                                // Height chart setup
                                const hasHeightData = heights.length >= 1;
                                let minHeight, maxHeight, heightRange, heightChartMin, heightChartMax;
                                if (hasHeightData) {
                                    minHeight = Math.min(...heights);
                                    maxHeight = Math.max(...heights);
                                    const heightPadding = (maxHeight - minHeight) * 0.1 || 1;
                                    heightChartMin = Math.max(0, minHeight - heightPadding);
                                    heightChartMax = maxHeight + heightPadding;
                                    heightRange = heightChartMax - heightChartMin;
                                }
                                
                                // Create points for weight
                                const weightPoints = sorted.map((record, idx) => ({
                                    x: margin.left + (idx / Math.max(1, sorted.length - 1)) * graphWidth,
                                    y: margin.top + graphHeight - ((parseFloat(record.weight) - weightChartMin) / weightRange) * graphHeight,
                                    weight: record.weight,
                                    length: record.length,
                                    height: record.height,
                                    bcs: record.bcs,
                                    notes: record.notes,
                                    date: record.date
                                }));
                                
                                // Create points for length
                                const lengthPoints = hasLengthData ? sorted.filter(r => r.length).map((record, idx) => ({
                                    x: margin.left + (sorted.indexOf(record) / Math.max(1, sorted.length - 1)) * graphWidth,
                                    y: margin.top + graphHeight - ((parseFloat(record.length) - lengthChartMin) / lengthRange) * graphHeight,
                                    weight: record.weight,
                                    length: record.length,
                                    height: record.height,
                                    bcs: record.bcs,
                                    notes: record.notes,
                                    date: record.date
                                })) : [];
                                
                                // Create points for height
                                const heightPoints = hasHeightData ? sorted.filter(r => r.height).map((record, idx) => ({
                                    x: margin.left + (sorted.indexOf(record) / Math.max(1, sorted.length - 1)) * graphWidth,
                                    y: margin.top + graphHeight - ((parseFloat(record.height) - heightChartMin) / heightRange) * graphHeight,
                                    weight: record.weight,
                                    length: record.length,
                                    height: record.height,
                                    bcs: record.bcs,
                                    notes: record.notes,
                                    date: record.date
                                })) : [];
                                
                                const weightPathData = weightPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                const lengthPathData = lengthPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                const heightPathData = heightPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                
                                const renderChart = (points, label, color, pathData, chartMin, chartMax) => {
                                    const range = chartMax - chartMin;
                                    return (
                                        <svg key={`chart-${label}`} width="100%" height="300" viewBox={`0 0 ${width} ${height}`} style={{ maxWidth: '100%' }} preserveAspectRatio="xMidYMid meet">
                                            {/* Grid lines */}
                                            {[0, 0.25, 0.5, 0.75, 1].map((ratio, i) => {
                                                const y = margin.top + graphHeight * (1 - ratio);
                                                const axisLabel = (chartMin + range * ratio).toFixed(1);
                                                return (
                                                    <g key={`grid-${i}`}>
                                                        <line x1={margin.left} y1={y} x2={width - margin.right} y2={y} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4" />
                                                        <text x={margin.left - 12} y={y} textAnchor="end" dy="0.3em" fontSize="11" fill="#666">{axisLabel}</text>
                                                    </g>
                                                );
                                            })}
                                            
                                            {/* Axes */}
                                            <line x1={margin.left} y1={margin.top} x2={margin.left} y2={height - margin.bottom} stroke={color} strokeWidth="2" />
                                            <line x1={margin.left} y1={height - margin.bottom} x2={width - margin.right} y2={height - margin.bottom} stroke="#333" strokeWidth="2" />
                                            
                                            {/* Y-axis label */}
                                            <text x={20} y={margin.top + graphHeight / 2} textAnchor="middle" fontSize="12" fill={color} fontWeight="600" transform={`rotate(-90 20 ${margin.top + graphHeight / 2})`}>
                                                {label} ({label === 'Weight' ? (animal.measurementUnits?.weight || 'g') : (animal.measurementUnits?.length || 'cm')})
                                            </text>
                                            
                                            {/* X-axis label */}
                                            <text x={margin.left + graphWidth / 2} y={height - 8} textAnchor="middle" fontSize="12" fill="#333" fontWeight="600">
                                                Date
                                            </text>
                                            
                                            {/* X-axis date labels */}
                                            {points.map((p, i) => (
                                                i % Math.max(1, Math.floor(points.length / 5)) === 0 && (
                                                    <text key={`date-${i}`} x={p.x} y={height - margin.bottom + 25} textAnchor="middle" fontSize="10" fill="#666">
                                                        {formatDate(p.date)}
                                                    </text>
                                                )
                                            ))}
                                            
                                            {/* Curve */}
                                            <path d={pathData} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                            
                                            {/* Points */}
                                            {points.map((p, i) => {
                                                // Color gradient from green (earliest) to red (latest)
                                                const colorRatio = points.length > 1 ? i / (points.length - 1) : 0;
                                                let dotColor;
                                                if (colorRatio < 0.5) {
                                                    const t = colorRatio * 2;
                                                    const r = Math.round(144 + (255 - 144) * t);
                                                    const g = 191;
                                                    const b = Math.round(71 + (0 - 71) * t);
                                                    dotColor = `rgb(${r}, ${g}, ${b})`;
                                                } else {
                                                    const t = (colorRatio - 0.5) * 2;
                                                    const r = 255;
                                                    const g = Math.round(191 - (191) * t);
                                                    const b = 0;
                                                    dotColor = `rgb(${r}, ${g}, ${b})`;
                                                }
                                                
                                                return (
                                                    <circle key={`point-${i}`} cx={p.x} cy={p.y} r="5" fill={dotColor} stroke="#fff" strokeWidth="2">
                                                        <title>{`Date: ${formatDate(p.date)}\nWeight: ${p.weight} ${animal.measurementUnits?.weight || 'g'}${p.length ? `\nLength: ${p.length} ${animal.measurementUnits?.length || 'cm'}` : ''}${p.bcs ? `\nBCS: ${p.bcs}` : ''}${p.notes ? `\nNotes: ${p.notes}` : ''}`}</title>
                                                    </circle>
                                                );
                                            })}
                                        </svg>
                                    );
                                };
                                
                                return (
                                    <div className="space-y-4">
                                        {/* Weight Chart */}
                                        <div className="bg-white p-4 rounded-lg border border-gray-200">
                                            <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                <span className="inline-block w-3 h-1 bg-blue-500 rounded"></span>
                                                Weight Growth Curve
                                            </h4>
                                            {renderChart(weightPoints, 'Weight', '#3b82f6', weightPathData, weightChartMin, weightChartMax)}
                                            <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                        </div>
                                        
                                        {/* Length Chart */}
                                        {hasLengthData && (
                                            <div className="bg-white p-4 rounded-lg border border-gray-200">
                                                <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                    <span className="inline-block w-3 h-1 bg-orange-500 rounded"></span>
                                                    Body Length Growth Curve
                                                </h4>
                                                {renderChart(lengthPoints, 'Length', '#ff8c42', lengthPathData, lengthChartMin, lengthChartMax)}
                                                <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                            </div>
                                        )}
                                        
                                        {/* Height Chart */}
                                        {hasHeightData && (
                                            <div className="bg-white p-4 rounded-lg border border-gray-200">
                                                <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                    <span className="inline-block w-3 h-1 bg-purple-500 rounded"></span>
                                                    Height Growth Curve
                                                </h4>
                                                {renderChart(heightPoints, 'Height', '#9333ea', heightPathData, heightChartMin, heightChartMax)}
                                                <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* Tab 4: Identification */}
                    {detailViewTab === 4 && (
                        <div className="space-y-6">
                            {/* Identification Numbers */}
                            {(() => {
                                const idFields = [
                                    { key: 'breederAssignedId', label: 'Identification' },
                                    { key: 'microchipNumber', label: 'Microchip Number' },
                                    { key: 'pedigreeRegistrationId', label: 'Pedigree Registration ID' },
                                    { key: 'colonyId', label: 'Colony ID' },
                                    { key: 'rabiesTagNumber', label: 'Rabies Tag Number' },
                                    { key: 'tattooId', label: 'Tattoo ID' },
                                    { key: 'akcRegistrationNumber', label: 'AKC Registration #' },
                                    { key: 'fciRegistrationNumber', label: 'FCI Registration #' },
                                    { key: 'cfaRegistrationNumber', label: 'CFA Registration #' },
                                    { key: 'workingRegistryIds', label: 'Working Registry IDs' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">🔢 Identification Numbers</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div><span className="text-gray-600">CritterTrack ID:</span> <strong>{animal.id_public || ''}</strong></div>
                                            {idFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Classification */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🗂️ Classification</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Species:</span> <strong>{animal.species || ''}</strong></div>
                                    {fieldTemplate?.fields?.breed?.enabled !== false && animal.breed && (
                                        <div><span className="text-gray-600">{getLabel('breed', 'Breed')}:</span> <strong>{animal.breed}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.strain?.enabled !== false && animal.strain && (
                                        <div><span className="text-gray-600">{getLabel('strain', 'Strain')}:</span> <strong>{animal.strain}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* Origin */}
                            {animal.origin && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌍 Origin</h3>
                                <p className="text-sm text-gray-700">{animal.origin}</p>
                            </div>
                            )}
                            {/* Tags */}
                            {animal.tags && animal.tags.length > 0 && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🏷️ Tags</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {animal.tags.map((tag, idx) => (
                                            <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">{tag}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 5: Lineage */}
                    {detailViewTab === 5 && (
                        <div className="space-y-6">
                            {/* 1st Section: Pedigree */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-semibold text-gray-700">🌳 Pedigree: Sire and Dam</h3>
                                    <button
                                        onClick={() => setShowPedigree(true)}
                                        data-tutorial-target="pedigree-btn"
                                        className="px-3 py-1 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition text-sm"
                                    >
                                        View Pedigree Chart
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <ViewOnlyParentCard 
                                        parentId={animal.fatherId_public || animal.sireId_public} 
                                        parentType="Sire"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                    <ViewOnlyParentCard 
                                        parentId={animal.motherId_public || animal.damId_public} 
                                        parentType="Dam"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                </div>
                            </div>

                            {/* 2nd Section: Breeding Records - Accordion View */}
                            {animal.breedingRecords && animal.breedingRecords.length > 0 && (
                                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200 space-y-3">
                                    <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-purple-600 mr-2">📊</span>Breeding Records</h3>
                                    <div className="space-y-2">
                                        {animal.breedingRecords.map((record, idx) => {
                                            const isSireOnly = animal.gender === 'Male' || (animal.gender === 'Unknown' && animal.breedingRole === 'sire');
                                            const isDamOnly = animal.gender === 'Female' || (animal.gender === 'Unknown' && animal.breedingRole === 'dam');
                                            const isBoth = animal.gender === 'Intersex' || (animal.gender === 'Unknown' && animal.breedingRole === 'both');
                                            const isExpanded = expandedBreedingRecords[idx];
                                            const countSummary = [
                                                record.litterSizeBorn !== null && `${record.litterSizeBorn} born`,
                                                record.stillbornCount && `${record.stillbornCount} stillborn`,
                                                record.litterSizeWeaned !== null && `${record.litterSizeWeaned} weaned`
                                            ].filter(Boolean).join(' � ') || 'No counts';
                                            return (
                                                <div key={idx} className={`bg-white rounded border transition-all ${isExpanded ? 'border-purple-300 shadow-md' : 'border-purple-100'}`}>
                                                    <div 
                                                        onClick={() => setExpandedBreedingRecords({...expandedBreedingRecords, [idx]: !isExpanded})}
                                                        className="p-3 flex items-center justify-between cursor-pointer hover:bg-purple-50 transition rounded"
                                                    >
                                                        <div className="flex items-center gap-3 flex-1">
                                                            <span className={`text-lg transition-transform ${isExpanded ? 'rotate-90' : ''}`}>▶️</span>
                                                            {record.litterName ? (
                                                                <>
                                                                    <span className="px-2 py-0.5 rounded text-xs font-bold bg-purple-700 text-white flex-shrink-0">{record.litterName}</span>
                                                                    {record.litterId && <span className="text-xs font-mono text-gray-400 flex-shrink-0">{record.litterId}</span>}
                                                                </>
                                                            ) : record.litterId ? (
                                                                <span className="font-mono px-2 py-0.5 rounded text-xs font-semibold flex-shrink-0 bg-purple-300 text-purple-800">{record.litterId}</span>
                                                            ) : null}
                                                            <div className="text-sm text-gray-700 flex items-center gap-2 flex-wrap">
                                                                {record.birthEventDate && <><span>{formatDate(record.birthEventDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                {!record.birthEventDate && formatDate(record.matingDate) && <><span>{formatDate(record.matingDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                {record.mate && <><span>{record.mate}</span><span className="text-gray-400">&bull;</span></>}
                                                                <span className="text-purple-700 font-medium">{countSummary}</span>
                                                            </div>
                                                        </div>
                                                        {!record.litterId && !isExpanded && (
                                                            <div className="flex gap-1 ml-2">
                                                                <button onClick={(e) => { e.stopPropagation(); setBreedingRecordForLitter(record); setShowCreateLitterModal(true); }} className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200" title="Create new litter from this record">Create</button>
                                                                <button onClick={(e) => { e.stopPropagation(); setBreedingRecordForLitter(record); setShowLinkLitterModal(true); }} className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200" title="Link existing litter">Link</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    {isExpanded && (
                                                        <div className="border-t border-purple-100 p-4 bg-purple-50 space-y-4">
                                                            {/* CTL ID + Litter Name */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                <div><div className="text-gray-600 text-xs">CTL ID</div><div className="font-mono text-xs font-semibold text-gray-700">{record.litterId || 'Not Linked'}</div></div>
                                                                {record.litterName && <div><div className="text-gray-600 text-xs">Litter Name</div><div className="font-semibold text-purple-800">{record.litterName}</div></div>}
                                                            </div>
                                                            {/* Mate, Dates, Method, Condition, Outcome */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                {record.mate && (<div><div className="text-gray-600 text-xs">Mate / Other Parent</div><div className="font-semibold text-gray-800">{record.mate}</div></div>)}
                                                                <div><div className="text-gray-600 text-xs">Mating Date</div><div className="font-semibold text-gray-800">{formatDate(record.matingDate) || '�'}</div></div>
                                                                {record.breedingMethod && (<div><div className="text-gray-600 text-xs">Breeding Method</div><div className="font-semibold text-gray-800">{record.breedingMethod}</div></div>)}
                                                                {record.breedingConditionAtTime && (<div><div className="text-gray-600 text-xs">Breeding Condition</div><div className="font-semibold text-gray-800">{record.breedingConditionAtTime}</div></div>)}
                                                                {record.outcome && (<div><div className="text-gray-600 text-xs">Outcome</div><div className={`font-semibold ${record.outcome === 'Successful' ? 'text-green-600' : record.outcome === 'Unsuccessful' ? 'text-red-600' : 'text-gray-600'}`}>{record.outcome}</div></div>)}
                                                                {(isDamOnly || isBoth) && (<div><div className="text-gray-600 text-xs">Birth Date</div><div className="font-semibold text-gray-800">{formatDate(record.birthEventDate) || '�'}</div></div>)}
                                                                {record.birthMethod && (<div><div className="text-gray-600 text-xs">Birth Method</div><div className="font-semibold text-gray-800">{record.birthMethod}</div></div>)}
                                                            </div>
                                                            {/* Notes */}
                                                            {record.notes && (<div className="bg-white p-3 rounded border border-purple-100"><div className="text-sm font-semibold text-gray-700 mb-2">Notes</div><div className="text-sm text-gray-700 italic">{record.notes}</div></div>)}
                                                            {/* Offspring Counts */}
                                                            <div className="bg-white p-3 rounded border border-purple-100">
                                                                <div className="text-sm font-semibold text-gray-700 mb-3">Offspring Counts</div>
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                                    <div><div className="text-gray-600 text-xs">Total Born</div><div className="text-2xl font-bold text-purple-600">{record.litterSizeBorn !== null ? record.litterSizeBorn : '�'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Stillborn</div><div className="text-2xl font-bold text-gray-600">{record.stillbornCount || '0'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Weaned</div><div className="text-2xl font-bold text-green-600">{record.litterSizeWeaned !== null ? record.litterSizeWeaned : '�'}</div></div>
                                                                    {breedingRecordLitters?.[record.litterId]?.maleCount != null && <div><div className="text-gray-600 text-xs">Males</div><div className="text-2xl font-bold text-blue-500">{breedingRecordLitters[record.litterId].maleCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.femaleCount != null && <div><div className="text-gray-600 text-xs">Females</div><div className="text-2xl font-bold text-pink-500">{breedingRecordLitters[record.litterId].femaleCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.unknownCount != null && breedingRecordLitters[record.litterId].unknownCount > 0 && <div><div className="text-gray-600 text-xs">Unknown / Intersex</div><div className="text-2xl font-bold text-gray-600">{breedingRecordLitters[record.litterId].unknownCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.inbreedingCoefficient != null && <div><div className="text-gray-600 text-xs">COI</div><div className="text-xl font-bold text-orange-600">{breedingRecordLitters[record.litterId].inbreedingCoefficient.toFixed(2)}%</div></div>}
                                                                </div>
                                                            </div>
                                                            {/* Linked Offspring */}
                                                            {record.litterId && breedingRecordOffspring[record.litterId] && breedingRecordOffspring[record.litterId].length > 0 && (
                                                                <div className="bg-white p-3 rounded border border-purple-100">
                                                                    <div className="text-sm font-semibold text-gray-700 mb-3">Offspring ({breedingRecordOffspring[record.litterId].length})</div>
                                                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                                                        {breedingRecordOffspring[record.litterId].map(offspring => (
                                                                            <div key={offspring.id_public} onClick={() => onViewAnimal && onViewAnimal(offspring)} className="border border-gray-200 rounded-lg p-2 hover:shadow-md transition cursor-pointer">
                                                                                <div className="flex items-center space-x-2">
                                                                                    <div className="w-10 h-10 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                                                                                        <AnimalImage src={offspring.imageUrl || offspring.photoUrl} alt={offspring.name} className="w-full h-full object-cover" iconSize={16} />
                                                                                    </div>
                                                                                    <div className="flex-1 min-w-0">
                                                                                        <div className="text-xs font-semibold text-gray-800 truncate">{offspring.prefix && `${offspring.prefix} `}{offspring.name}{offspring.suffix && ` ${offspring.suffix}`}</div>
                                                                                        <div className="text-[10px] text-gray-500 font-mono">{offspring.id_public}</div>
                                                                                        <div className="text-[10px] text-gray-600">{offspring.gender}</div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            <div className="flex gap-2 pt-2">
                                                                {!record.litterId && (
                                                                    <>
                                                                        <button onClick={() => { setBreedingRecordForLitter(record); setShowCreateLitterModal(true); }} className="flex-1 px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium">Create Litter</button>
                                                                        <button onClick={() => { setBreedingRecordForLitter(record); setShowLinkLitterModal(true); }} className="flex-1 px-3 py-2 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium">Link Litter</button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                        </div>
                    )}

                    {/* Tab 6: Breeding */}
                    {detailViewTab === 6 && (
                        <div className="space-y-6">
                            {/* 1st Section: Reproductive Status */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌿 Reproductive Status</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Neutered/Spayed:</span> <strong>{animal.isNeutered ? 'Yes' : 'No'}</strong></div>
                                    <div><span className="text-gray-600">Infertile:</span> <strong>{animal.isInfertile ? 'Yes' : 'No'}</strong></div>
                                    {!animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">In Mating:</span> <strong>{animal.isInMating ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && !animal.isNeutered && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('isPregnant', 'Pregnant')}:</span> <strong>{animal.isPregnant ? 'Yes' : 'No'}</strong></div>
                                            <div><span className="text-gray-600">{getLabel('isNursing', 'Nursing')}:</span> <strong>{animal.isNursing ? 'Yes' : 'No'}</strong></div>
                                        </>
                                    )}
                                    {animal.gender === 'Male' && !animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">Stud Animal:</span> <strong>{animal.isStudAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {animal.gender === 'Female' && !animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">Breeding Dam:</span> <strong>{animal.isDamAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* 2nd Section: Estrus/Cycle (Female/Intersex/Unknown only) */}
                            {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && !animal.isNeutered && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🔄 Estrus/Cycle</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Heat Status:</span> <strong>{animal.heatStatus || ''}</strong></div>
                                        <div><span className="text-gray-600">Last Heat Date:</span> <strong>{animal.lastHeatDate ? formatDate(animal.lastHeatDate) : ''}</strong></div>
                                        <div><span className="text-gray-600">{getLabel('ovulationDate', 'Ovulation Date')}:</span> <strong>{animal.ovulationDate ? formatDate(animal.ovulationDate) : ''}</strong></div>
                                        {animal.estrusCycleLength && (
                                            <div><span className="text-gray-600">Estrus Cycle Length:</span> <strong>{`${animal.estrusCycleLength} days`}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* 4th Section: Stud Information */}
                            {!animal.isNeutered && !animal.isInfertile && (animal.gender === 'Male' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♂️ Sire Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Fertility Status:</span> <strong>{animal.fertilityStatus || ''}</strong></div>
                                    </div>
                                    {animal.fertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animal.fertilityNotes}</strong></div>
                                    )}
                                    {animal.reproductiveClearances && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveClearances}</strong></div>
                                    )}
                                    {animal.reproductiveComplications && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveComplications}</strong></div>
                                    )}
                                </div>
                            )}

                            {/* 5th Section: Dam Information */}
                            {!animal.isNeutered && !animal.isInfertile && (animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♀️ Dam Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">{getLabel('damFertilityStatus', 'Dam Fertility Status')}:</span> <strong>{animal.damFertilityStatus || animal.fertilityStatus || ''}</strong></div>
                                        {animal.gestationLength && (
                                            <div><span className="text-gray-600">{getLabel('gestationLength', 'Gestation Length')}:</span> <strong>{`${animal.gestationLength} days`}</strong></div>
                                        )}
                                        {animal.deliveryMethod && (
                                            <div><span className="text-gray-600">{getLabel('deliveryMethod', 'Delivery Method')}:</span> <strong>{animal.deliveryMethod}</strong></div>
                                        )}
                                        {animal.whelpingDate && (
                                            <div><span className="text-gray-600">{getLabel('whelpingDate', 'Whelping Date')}:</span> <strong>{formatDate(animal.whelpingDate)}</strong></div>
                                        )}
                                        {animal.queeningDate && (
                                            <div><span className="text-gray-600">{getLabel('queeningDate', 'Queening Date')}:</span> <strong>{formatDate(animal.queeningDate)}</strong></div>
                                        )}
                                    </div>
                                    {animal.damFertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animal.damFertilityNotes}</strong></div>
                                    )}
                                    {animal.reproductiveClearances && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveClearances}</strong></div>
                                    )}
                                    {animal.reproductiveComplications && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveComplications}</strong></div>
                                    )}
                                </div>
                            )}

                        </div>
                    )}

                    {/* Tab 7: Health */}
                    {detailViewTab === 7 && (
                        <div className="space-y-6">
                            {/* 1st Section: Preventive Care */}
                            {(animal.vaccinations || animal.dewormingRecords || animal.parasiteControl || animal.parasitePreventionSchedule) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, preventiveCare: !p.preventiveCare}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🛡️ Preventive Care</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.preventiveCare ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.preventiveCare && (<div className="space-y-4 mt-4">
                                    {animal.vaccinations && (
                                        <DetailJsonList
                                            label={getLabel('vaccinations', 'Vaccinations')}
                                            data={animal.vaccinations}
                                            renderItem={v => <>{v.name} {v.date && `(${formatDate(v.date)})`}{v.notes && <span className="text-gray-600"> - {v.notes}</span>}</>}
                                        />
                                    )}
                                    {animal.dewormingRecords && (
                                        <DetailJsonList
                                            label="Deworming Records"
                                            data={animal.dewormingRecords}
                                            renderItem={r => <>{r.medication} {r.date && `(${formatDate(r.date)})`}{r.notes && <span className="text-gray-600"> - {r.notes}</span>}</>}
                                        />
                                    )}
                                    {animal.parasiteControl && (
                                        <DetailJsonList
                                            label="Parasite Control"
                                            data={animal.parasiteControl}
                                            renderItem={r => <>{r.treatment} {r.date && `(${formatDate(r.date)})`}{r.notes && <span className="text-gray-600"> - {r.notes}</span>}</>}
                                        />
                                    )}
                                    {fieldTemplate?.fields?.parasitePreventionSchedule?.enabled !== false && animal.parasitePreventionSchedule && (
                                        <div className="text-sm">
                                            <span className="text-gray-600">{getLabel('parasitePreventionSchedule', 'Parasite Prevention Schedule')}:</span>
                                            <strong className="whitespace-pre-wrap">{animal.parasitePreventionSchedule}</strong>
                                        </div>
                                    )}
                                </div>)}
                            </div>
                            )}

                            {/* 2nd Section: Procedures & Diagnostics */}
                            {(animal.medicalProcedures || animal.labResults || animal.laboratoryResults) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, proceduresDiagnostics: !p.proceduresDiagnostics}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🔬 Procedures & Diagnostics</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.proceduresDiagnostics ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.proceduresDiagnostics && (<div className="space-y-4 mt-4">
                                    {animal.medicalProcedures && (
                                        <DetailJsonList
                                            label="Medical Procedures"
                                            data={animal.medicalProcedures}
                                            renderItem={p => <>{p.name} {p.date && `(${formatDate(p.date)})`}{p.notes && <span className="text-gray-600"> - {p.notes}</span>}</>}
                                        />
                                    )}
                                    {(animal.labResults || animal.laboratoryResults) && (
                                        <DetailJsonList
                                            label="Laboratory Results"
                                            data={animal.labResults || animal.laboratoryResults}
                                            renderItem={r => <>{r.testName} - {r.result} {r.date && `(${formatDate(r.date)})`}{r.notes && <span className="text-gray-600"> - {r.notes}</span>}</>}
                                        />
                                    )}
                                </div>)}
                            </div>
                            )}

                            {/* 3rd Section: Active Medical Records */}
                            {(animal.medicalConditions || animal.allergies || animal.medications) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, activeMedical: !p.activeMedical}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🩹💊 Active Medical Records</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.activeMedical ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.activeMedical && (<div className="space-y-3 mt-4">
                                    {animal.medicalConditions && (() => {
                                        const d = animal.medicalConditions;
                                        const parsed = typeof d === 'string' ? (() => { try { return JSON.parse(d); } catch { return null; } })() : Array.isArray(d) ? d : null;
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <span className="text-gray-600 text-sm font-semibold">Medical Conditions:</span>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((item, i) => (
                                                        <li key={i} className="text-gray-700">
                                                            {item.condition || item.name}
                                                            {item.notes && <span className="text-gray-500"> � {item.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : <div><span className="text-gray-600 text-sm font-semibold">Medical Conditions:</span><strong className="text-sm whitespace-pre-wrap">{d}</strong></div>;
                                    })()}
                                    {animal.allergies && (() => {
                                        const d = animal.allergies;
                                        const parsed = typeof d === 'string' ? (() => { try { return JSON.parse(d); } catch { return null; } })() : Array.isArray(d) ? d : null;
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <span className="text-gray-600 text-sm font-semibold">Allergies:</span>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((item, i) => (
                                                        <li key={i} className="text-gray-700">
                                                            {item.allergen || item.name}
                                                            {item.notes && <span className="text-gray-500"> � {item.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : <div><span className="text-gray-600 text-sm font-semibold">Allergies:</span><strong className="text-sm whitespace-pre-wrap">{d}</strong></div>;
                                    })()}
                                    {animal.medications && (() => {
                                        const d = animal.medications;
                                        const parsed = typeof d === 'string' ? (() => { try { return JSON.parse(d); } catch { return null; } })() : Array.isArray(d) ? d : null;
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <span className="text-gray-600 text-sm font-semibold">Current Medications:</span>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((item, i) => (
                                                        <li key={i} className="text-gray-700">
                                                            {item.medication || item.name}
                                                            {item.notes && <span className="text-gray-500"> � {item.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : <div><span className="text-gray-600 text-sm font-semibold">Current Medications:</span><strong className="text-sm whitespace-pre-wrap">{d}</strong></div>;
                                    })()}
                                </div>)}
                            </div>
                            )}

                            {/* 4th Section: Health Clearances & Screening */}
                            {(() => {
                                const clearanceFields = [
                                    { key: 'heartwormStatus', label: 'Heartworm Status' },
                                    { key: 'hipElbowScores', label: 'Hip/Elbow Scores' },
                                    { key: 'eyeClearance', label: 'Eye Clearance' },
                                    { key: 'cardiacClearance', label: 'Cardiac Clearance' },
                                    { key: 'dentalRecords', label: 'Dental Records' },
                                    { key: 'geneticTestResults', label: 'Genetic Test Results' },
                                    { key: 'chronicConditions', label: 'Chronic Conditions' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                const spayDate = fieldTemplate?.fields?.spayNeuterDate?.enabled !== false && animal.spayNeuterDate;
                                return (clearanceFields.length > 0 || spayDate) && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, healthClearances: !p.healthClearances}))} className="w-full flex items-center justify-between text-left group">
                                            <h3 className="text-lg font-semibold text-gray-700">🏥 Health Clearances & Screening</h3>
                                            <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.healthClearances ? '▶' : '▼'}</span>
                                        </button>
                                        {!collapsedHealthSections.healthClearances && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4">
                                            {spayDate && <div><span className="text-gray-600">{getLabel('spayNeuterDate', 'Spay/Neuter Date')}:</span> <strong>{formatDate(animal.spayNeuterDate)}</strong></div>}
                                            {clearanceFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>)}
                                    </div>
                                );
                            })()}

                            {/* 5th Section: Veterinary Care */}
                            {(animal.primaryVet || animal.vetVisits) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, vetCare: !p.vetCare}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🩺 Veterinary Care</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.vetCare ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.vetCare && (<div className="space-y-4 text-sm mt-4">
                                    {animal.primaryVet && <div><span className="text-gray-600">Primary Veterinarian:</span> <strong>{animal.primaryVet}</strong></div>}
                                    {animal.vetVisits && (
                                        <DetailJsonList
                                            label="Veterinary Visits"
                                            data={animal.vetVisits}
                                            renderItem={v => <>{v.reason} {v.date && `(${formatDate(v.date)})`}{v.notes && <span className="text-gray-600"> - {v.notes}</span>}</>}
                                        />
                                    )}
                                </div>)}
                            </div>
                            )}
                        </div>
                    )}

                    {/* Tab 8: Husbandry */}
                    {detailViewTab === 8 && (
                        <div className="space-y-6">
                            {/* 1st Section: Nutrition */}
                            {(animal.dietType || animal.feedingSchedule || animal.supplements) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🍽️ Nutrition</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.dietType && <div><span className="text-gray-600">Diet Type:</span> <strong>{animal.dietType}</strong></div>}
                                    {animal.feedingSchedule && <div><span className="text-gray-600">Feeding Schedule:</span> <strong>{animal.feedingSchedule}</strong></div>}
                                    {animal.supplements && <div><span className="text-gray-600">Supplements:</span> <strong>{animal.supplements}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 2nd Section: Housing & Enclosure */}
                            {(animal.enclosureId || animal.housingType || animal.bedding || animal.enrichment || animal.careTasks?.length > 0) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🏡 Housing & Enclosure</h3>
                                <div className="space-y-3 text-sm">
                                    {enclosureInfo && (<div><span className="text-gray-600">Enclosure:</span> <strong>{enclosureInfo.name}</strong></div>)}
                                    {fieldTemplate?.fields?.housingType?.enabled !== false && animal.housingType && <div><span className="text-gray-600">{getLabel('housingType', 'Housing Type')}:</span> <strong>{animal.housingType}</strong></div>}
                                    {fieldTemplate?.fields?.bedding?.enabled !== false && animal.bedding && <div><span className="text-gray-600">{getLabel('bedding', 'Bedding')}:</span> <strong>{animal.bedding}</strong></div>}
                                    {animal.enrichment && <div><span className="text-gray-600">Enrichment:</span> <strong>{animal.enrichment}</strong></div>}
                                </div>
                                {animal.careTasks && animal.careTasks.length > 0 && (
                                    <div className="mt-3 pt-3 border-t border-gray-200">
                                        <div className="text-sm font-semibold text-gray-700 mb-2">Enclosure Care Tasks</div>
                                        <div className="space-y-1">
                                            {animal.careTasks.map((task, idx) => (
                                                <div key={idx} className="flex items-center justify-between text-xs bg-white px-2 py-1.5 rounded border border-gray-200">
                                                    <span className="font-medium text-gray-700">{task.taskName}</span>
                                                    <div className="flex items-center gap-3 text-gray-500">
                                                        {task.frequencyDays && <span>Every {task.frequencyDays}d</span>}
                                                        {task.lastDoneDate && <span>Last: {formatDate(task.lastDoneDate)}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            )}

                            {/* 3rd Section: Animal Care */}
                            {(animal.animalCareTasks?.length > 0 || animal.handlingNotes || animal.socializationNotes || animal.specialCareRequirements) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🧴 Animal Care</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.animalCareTasks && animal.animalCareTasks.length > 0 && (
                                        <div>
                                            <div className="text-sm font-semibold text-gray-700 mb-2">Animal Care Tasks</div>
                                            <div className="space-y-1">
                                                {animal.animalCareTasks.map((task, idx) => (
                                                    <div key={idx} className="flex items-center justify-between text-xs bg-white px-2 py-1.5 rounded border border-gray-200">
                                                        <span className="font-medium text-gray-700">{task.taskName}</span>
                                                        <div className="flex items-center gap-3 text-gray-500">
                                                            {task.frequencyDays && <span>Every {task.frequencyDays}d</span>}
                                                            {task.lastDoneDate && <span>Last: {formatDate(task.lastDoneDate)}</span>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {animal.handlingNotes && <div className="flex items-baseline gap-1"><span className="text-gray-600 font-semibold shrink-0">Handling Notes:</span><strong className="whitespace-pre-wrap">{animal.handlingNotes}</strong></div>}
                                    {animal.socializationNotes && <div className="flex items-baseline gap-1"><span className="text-gray-600 font-semibold shrink-0">Socialization Notes:</span><strong className="whitespace-pre-wrap">{animal.socializationNotes}</strong></div>}
                                    {animal.specialCareRequirements && <div className="flex items-baseline gap-1"><span className="text-gray-600 font-semibold shrink-0">Special Care Requirements:</span><strong className="whitespace-pre-wrap">{animal.specialCareRequirements}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 3rd Section: Environment */}
                            {(animal.temperatureRange || animal.humidity || animal.lighting || animal.noise) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌡️ Environment</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {animal.temperatureRange && <div><span className="text-gray-600">Temperature Range:</span> <strong>{animal.temperatureRange}</strong></div>}
                                    {fieldTemplate?.fields?.humidity?.enabled !== false && animal.humidity && <div><span className="text-gray-600">{getLabel('humidity', 'Humidity')}:</span> <strong>{animal.humidity}</strong></div>}
                                    {animal.lighting && <div><span className="text-gray-600">Lighting:</span> <strong>{animal.lighting}</strong></div>}
                                    {fieldTemplate?.fields?.noise?.enabled !== false && animal.noise && <div><span className="text-gray-600">{getLabel('noise', 'Noise Level')}:</span> <strong>{animal.noise}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 4th Section: Exercise & Grooming */}
                            {(() => {
                                const egFields = [
                                    { key: 'exerciseRequirements', label: 'Exercise Requirements' },
                                    { key: 'dailyExerciseMinutes', label: 'Daily Exercise (min)' },
                                    { key: 'groomingNeeds', label: 'Grooming Needs' },
                                    { key: 'sheddingLevel', label: 'Shedding Level' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                const trainFlags = [
                                    { key: 'crateTrained', label: 'Crate Trained' },
                                    { key: 'litterTrained', label: 'Litter Trained' },
                                    { key: 'leashTrained', label: 'Leash Trained' },
                                    { key: 'freeFlightTrained', label: 'Free Flight Trained' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return (egFields.length > 0 || trainFlags.length > 0) && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">✂️ Grooming</h3>
                                        {egFields.length > 0 && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                {egFields.map(f => (
                                                    <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                                ))}
                                            </div>
                                        )}
                                        {trainFlags.length > 0 && (
                                            <div className="flex flex-wrap gap-3 text-sm">
                                                {trainFlags.map(f => (
                                                    <span key={f.key} className="inline-flex items-center bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">&#x2713; {getLabel(f.key, f.label)}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* Tab 9: Behavior */}
                    {detailViewTab === 9 && (
                        <div className="space-y-6">
                            {/* 1st Section: Behavior */}
                            {(animal.temperament || animal.handlingTolerance || animal.socialStructure) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">💭 Behavior</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.temperament && <div><span className="text-gray-600">Temperament:</span> <strong>{animal.temperament}</strong></div>}
                                    {fieldTemplate?.fields?.handlingTolerance?.enabled !== false && animal.handlingTolerance && <div><span className="text-gray-600">{getLabel('handlingTolerance', 'Handling Tolerance')}:</span> <strong>{animal.handlingTolerance}</strong></div>}
                                    {animal.socialStructure && <div><span className="text-gray-600">Social Structure:</span> <strong>{animal.socialStructure}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 2nd Section: Activity */}
                            {(animal.activityCycle || animal.exerciseRequirements || animal.dailyExerciseMinutes || animal.trainingLevel || animal.trainingDisciplines || animal.workingRole || animal.certifications || animal.crateTrained || animal.litterTrained || animal.leashTrained || animal.freeFlightTrained) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌓🏃 Activity</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {animal.activityCycle && <div><span className="text-gray-600">Activity Cycle:</span> <strong>{animal.activityCycle}</strong></div>}
                                    {fieldTemplate?.fields?.exerciseRequirements?.enabled !== false && animal.exerciseRequirements && <div><span className="text-gray-600">{getLabel('exerciseRequirements', 'Exercise Requirements')}:</span> <strong>{animal.exerciseRequirements}</strong></div>}
                                    {fieldTemplate?.fields?.dailyExerciseMinutes?.enabled !== false && animal.dailyExerciseMinutes && <div><span className="text-gray-600">{getLabel('dailyExerciseMinutes', 'Daily Exercise (min)')}:</span> <strong>{animal.dailyExerciseMinutes}</strong></div>}
                                    {fieldTemplate?.fields?.trainingLevel?.enabled !== false && animal.trainingLevel && <div><span className="text-gray-600">{getLabel('trainingLevel', 'Training Level')}:</span> <strong>{animal.trainingLevel}</strong></div>}
                                    {fieldTemplate?.fields?.trainingDisciplines?.enabled !== false && animal.trainingDisciplines && <div><span className="text-gray-600">{getLabel('trainingDisciplines', 'Training Disciplines')}:</span> <strong>{animal.trainingDisciplines}</strong></div>}
                                    {fieldTemplate?.fields?.workingRole?.enabled !== false && animal.workingRole && <div><span className="text-gray-600">{getLabel('workingRole', 'Working Role')}:</span> <strong>{animal.workingRole}</strong></div>}
                                    {fieldTemplate?.fields?.certifications?.enabled !== false && animal.certifications && <div className="col-span-2"><span className="text-gray-600">{getLabel('certifications', 'Certifications')}:</span> <strong>{animal.certifications}</strong></div>}
                                </div>
                                {(animal.crateTrained || animal.litterTrained || animal.leashTrained || animal.freeFlightTrained) && (
                                    <div className="flex flex-wrap gap-3 text-sm pt-2">
                                        {fieldTemplate?.fields?.crateTrained?.enabled !== false && animal.crateTrained && <span className="inline-flex items-center bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">✓ {getLabel('crateTrained', 'Crate Trained')}</span>}
                                        {fieldTemplate?.fields?.litterTrained?.enabled !== false && animal.litterTrained && <span className="inline-flex items-center bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">✓ {getLabel('litterTrained', 'Litter Trained')}</span>}
                                        {fieldTemplate?.fields?.leashTrained?.enabled !== false && animal.leashTrained && <span className="inline-flex items-center bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">✓ {getLabel('leashTrained', 'Leash Trained')}</span>}
                                        {fieldTemplate?.fields?.freeFlightTrained?.enabled !== false && animal.freeFlightTrained && <span className="inline-flex items-center bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">✓ {getLabel('freeFlightTrained', 'Free Flight Trained')}</span>}
                                    </div>
                                )}
                            </div>
                            )}

                            {/* 3rd Section: Known Issues */}
                            {(animal.behavioralIssues || animal.biteHistory || animal.reactivityNotes) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">⚠️ Known Issues</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {fieldTemplate?.fields?.behavioralIssues?.enabled !== false && animal.behavioralIssues && <div className="flex items-baseline gap-1"><span className="text-gray-600 shrink-0">{getLabel('behavioralIssues', 'Behavioral Issues')}:</span><strong className="whitespace-pre-wrap">{animal.behavioralIssues}</strong></div>}
                                    {fieldTemplate?.fields?.biteHistory?.enabled !== false && animal.biteHistory && <div className="flex items-baseline gap-1"><span className="text-gray-600 shrink-0">{getLabel('biteHistory', 'Bite History')}:</span><strong className="whitespace-pre-wrap">{animal.biteHistory}</strong></div>}
                                    {fieldTemplate?.fields?.reactivityNotes?.enabled !== false && animal.reactivityNotes && <div className="col-span-2 flex items-baseline gap-1"><span className="text-gray-600 shrink-0">{getLabel('reactivityNotes', 'Reactivity Notes')}:</span><strong className="whitespace-pre-wrap">{animal.reactivityNotes}</strong></div>}
                                </div>
                            </div>
                            )}
                        </div>
                    )}

                    {/* Tab 10: Records */}
                    {detailViewTab === 10 && (
                        <div className="space-y-6">
                            {/* 1st Section: Remarks & Notes */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📝 Remarks & Notes</h3>
                                <strong className="block text-sm text-gray-700 whitespace-pre-wrap">{animal.remarks || ''}</strong>
                            </div>
                        </div>
                    )}                    {/* Tab 11: End of Life */}
                    {detailViewTab === 11 && (
                        <div className="space-y-6">
                            {/* End of Life */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🕊️ Information</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Deceased Date:</span> <strong>{animal.deceasedDate ? formatDate(animal.deceasedDate) : ''}</strong></div>
                                    <div><span className="text-gray-600">Cause of Death:</span> <strong>{animal.causeOfDeath || ''}</strong></div>
                                    <div><span className="text-gray-600">Necropsy Results:</span> <strong>{animal.necropsyResults || ''}</strong></div>
                                    {animal.endOfLifeCareNotes && (
                                        <div><span className="text-gray-600">{getLabel('endOfLifeCareNotes', 'End of Life Care Notes')}:</span> <strong className="whitespace-pre-wrap">{animal.endOfLifeCareNotes}</strong></div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 12: Show */}
                    {detailViewTab === 12 && (
                        <div className="space-y-6">
                            {/* Show Titles & Ratings */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🥇 Show Titles & Ratings</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Titles:</span> <strong>{animal.showTitles || ''}</strong></div>
                                    <div><span className="text-gray-600">Ratings:</span> <strong>{animal.showRatings || ''}</strong></div>
                                    <div><span className="text-gray-600">Judge Comments:</span> <strong className="whitespace-pre-wrap">{animal.judgeComments || ''}</strong></div>
                                </div>
                            </div>

                            {/* Working Titles & Performance */}
                            {(animal.workingTitles || animal.performanceScores) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🎯 Working & Performance</h3>
                                    <div className="space-y-3 text-sm">
                                        <div><span className="text-gray-600">Working Titles:</span> <strong>{animal.workingTitles || ''}</strong></div>
                                        <div><span className="text-gray-600">Performance Scores:</span> <strong>{animal.performanceScores || ''}</strong></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 13: Legal & Documentation */}
                    {detailViewTab === 13 && (
                        <div className="space-y-6">
                            {/* Licensing & Permits */}
                            {(animal.licenseNumber || animal.licenseJurisdiction) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🔑 Licensing & Permits</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {fieldTemplate?.fields?.licenseNumber?.enabled !== false && animal.licenseNumber && (
                                        <div><span className="text-gray-600">{getLabel('licenseNumber', 'License Number')}:</span> <strong>{animal.licenseNumber}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.licenseJurisdiction?.enabled !== false && animal.licenseJurisdiction && (
                                        <div><span className="text-gray-600">{getLabel('licenseJurisdiction', 'License Jurisdiction')}:</span> <strong>{animal.licenseJurisdiction}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* Legal / Administrative */}
                            {(animal.insurance || animal.legalStatus) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📋 Legal / Administrative</h3>
                                <div className="space-y-3 text-sm">
                                    {fieldTemplate?.fields?.insurance?.enabled !== false && animal.insurance && (
                                        <div><span className="text-gray-600">{getLabel('insurance', 'Insurance')}:</span> <strong className="whitespace-pre-wrap">{animal.insurance}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.legalStatus?.enabled !== false && animal.legalStatus && (
                                        <div><span className="text-gray-600">{getLabel('legalStatus', 'Legal Status')}:</span> <strong className="whitespace-pre-wrap">{animal.legalStatus}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* Restrictions */}
                            {(animal.breedingRestrictions || animal.exportRestrictions) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🚫 Restrictions</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.breedingRestrictions && (
                                        <div><span className="text-gray-600">{getLabel('breedingRestrictions', 'Breeding Restrictions')}:</span> <strong className="whitespace-pre-wrap">{animal.breedingRestrictions}</strong></div>
                                    )}
                                    {animal.exportRestrictions && (
                                        <div><span className="text-gray-600">{getLabel('exportRestrictions', 'Export Restrictions')}:</span> <strong className="whitespace-pre-wrap">{animal.exportRestrictions}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* No data fallback */}
                            {!animal.licenseNumber && !animal.licenseJurisdiction && !animal.insurance && !animal.legalStatus && !animal.breedingRestrictions && !animal.exportRestrictions && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center text-gray-500">
                                    <p>No legal or documentation records</p>
                                </div>
                            )}
                        </div>
                    )}

                {/* -- TAB 14 ? Logs --------------------------------------------------- */}
                {detailViewTab === 14 && (
                    <div className="space-y-6 p-1">
                        {animalLogsLoading ? (
                            <div className="flex items-center justify-center py-12 text-gray-400 gap-2">
                                <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                                Loading logs...
                            </div>
                        ) : !animalLogs || animalLogs.length === 0 ? (
                            <div className="text-center py-12 text-gray-400 text-sm">No changes recorded yet. Logs are created when you edit or feed this animal.</div>
                        ) : (() => {
                            const feedingLogs = animalLogs.filter(l => l.category === 'feeding');
                            const careLogs    = animalLogs.filter(l => l.category === 'care');
                            const fieldLogs   = animalLogs.filter(l => l.category === 'field');
                            const fmtVal = v => v === null || v === undefined ? '?' : typeof v === 'boolean' ? (v ? 'Yes' : 'No') : String(v).slice(0, 80);
                            return (
                                <>
                                    {/* Feeding History */}
                                    {feedingLogs.length > 0 && (
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-2 pb-1 border-b border-green-200">
                                                <span className="text-base">✏️</span>
                                                <h3 className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Feeding History</h3>
                                                <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{feedingLogs.length}</span>
                                            </div>
                                            {feedingLogs.map(log => {
                                                const ev = log.changes?.[0]?.newValue || {};
                                                const foodLabel = ev.supplyName
                                                    ? `${ev.supplyName}${ev.feederType ? ` (${ev.feederType}${ev.feederSize ? ` � ${ev.feederSize}` : ''})` : ''}`
                                                    : null;
                                                const qtyLabel = ev.quantity != null ? `${ev.quantity}${ev.unit ? ` ${ev.unit}` : ''}` : null;
                                                return (
                                                    <div key={log._id} className="bg-green-50 border border-green-100 rounded-lg p-3">
                                                        <div className="flex items-center justify-between gap-2 flex-wrap">
                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                <span className="text-green-600 font-medium text-sm">✅ Fed</span>
                                                                {foodLabel && <span className="text-gray-700 text-sm font-medium">{foodLabel}</span>}
                                                                {qtyLabel && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">?{qtyLabel}</span>}
                                                            </div>
                                                            <span className="text-xs text-gray-400">{new Date(log.createdAt).toLocaleString()}</span>
                                                        </div>
                                                        {!foodLabel && <p className="text-xs text-gray-400 mt-1">No food recorded</p>}
                                                        {ev.notes && <p className="text-xs text-gray-500 mt-1 italic">"{ev.notes}"</p>}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {/* Care Schedule Updates */}
                                    {careLogs.length > 0 && (
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-2 pb-1 border-b border-blue-200">
                                                <span className="text-base">✏️</span>
                                                <h3 className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Care Schedule Updates</h3>
                                                <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{careLogs.length}</span>
                                            </div>
                                            {careLogs.map(log => (
                                                <div key={log._id} className="bg-blue-50 border border-blue-100 rounded-lg p-3 space-y-1.5">
                                                    <span className="text-xs font-medium text-blue-500">{new Date(log.createdAt).toLocaleString()}</span>
                                                    {log.changes.map((c, i) => (
                                                        <div key={i} className="text-sm">
                                                            <span className="font-medium text-gray-700">{c.label}:</span>{' '}
                                                            {c.field === 'careTasks' ? (
                                                                <span className="text-gray-500">Task list updated</span>
                                                            ) : c.field === 'careTaskDone' ? (
                                                                <span className="text-green-600">✅ Completed: {c.newValue}</span>
                                                            ) : (
                                                                <span className="text-gray-500">
                                                                    {c.oldValue != null ? <span className="line-through text-red-400 mr-1">{fmtVal(c.oldValue)}</span> : <span className="text-gray-400 mr-1">none</span>}
                                                                    ➡️ <span className="text-green-600">{fmtVal(c.newValue)}</span>
                                                                </span>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* Field Edits */}
                                    {fieldLogs.length > 0 && (
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-2 pb-1 border-b border-gray-200">
                                                <span className="text-base">✏️</span>
                                                <h3 className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Field Edits</h3>
                                                <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{fieldLogs.length}</span>
                                            </div>
                                            {fieldLogs.map(log => (
                                                <div key={log._id} className="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-1.5">
                                                    <span className="text-xs font-medium text-gray-500">{new Date(log.createdAt).toLocaleString()}</span>
                                                    {log.changes.map((c, i) => (
                                                        <div key={i} className="text-sm flex items-start gap-1.5 flex-wrap">
                                                            <span className="font-medium text-gray-700 shrink-0">{c.label}:</span>
                                                            <span className="text-gray-500">
                                                                {c.oldValue != null ? <span className="line-through text-red-400 mr-1">{fmtVal(c.oldValue)}</span> : <span className="text-gray-400 mr-1">→</span>}
                                                                ➡️ <span className="text-green-600">{fmtVal(c.newValue)}</span>
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </>
                            );
                        })()}
                    </div>
                )}

                {/* Pedigree Chart Modal */}
                {showPedigree && (
                    <PedigreeChart
                        animalId={animal.id_public}
                        API_BASE_URL={API_BASE_URL}
                        authToken={authToken}
                        onClose={() => setShowPedigree(false)}
                    />
                )}
            </div>
        </div>
    </div>
    );
};

// ==================== VIEW-ONLY PRIVATE ANIMAL DETAIL (SOLD/TRANSFERRED) ====================
// Identical to PrivateAnimalDetail but without edit/delete and privacy controls
// Used for animals you have view-only access to (sold, transferred, purchased)
const ViewOnlyPrivateAnimalDetail = ({ animal, onClose, onCloseAll, API_BASE_URL, authToken, setShowImageModal, setEnlargedImageUrl, onHideAnimal, showModalMessage, onViewAnimal }) => {
    const [breederInfo, setBreederInfo] = useState(null);
    const [showPedigree, setShowPedigree] = useState(false);
    const [detailViewTab, setDetailViewTab] = useState(1);
    const [enclosureInfo, setEnclosureInfo] = useState(null);
    const [collapsedHealthSections, setCollapsedHealthSections] = useState({});
    const [breedingRecordLitters, setBreedingRecordLitters] = useState({});
    const [expandedBreedingRecords, setExpandedBreedingRecords] = useState({});
    const [showCreateLitterModal, setShowCreateLitterModal] = useState(false);
    const [showLinkLitterModal, setShowLinkLitterModal] = useState(false);
    const [breedingRecordForLitter, setBreedingRecordForLitter] = useState(null);
    const { fieldTemplate, getLabel } = useDetailFieldTemplate(animal?.species, API_BASE_URL);

    // Fetch litter data when breeding records expand (for male/female counts and COI)
    React.useEffect(() => {
        if (!animal?.breedingRecords?.length || !authToken) return;
        Object.entries(expandedBreedingRecords).forEach(([idxStr, isExpanded]) => {
            if (!isExpanded) return;
            const idx = parseInt(idxStr);
            const record = animal.breedingRecords[idx];
            if (!record?.litterId || breedingRecordLitters[record.litterId] !== undefined) return;
            axios.get(`${API_BASE_URL}/litters`, { headers: { Authorization: `Bearer ${authToken}` } })
                .then(res => {
                    const litter = res.data.find(l => l.litter_id_public === record.litterId);
                    if (litter) setBreedingRecordLitters(prev => ({ ...prev, [record.litterId]: litter }));
                })
                .catch(() => {});
        });
    }, [expandedBreedingRecords, animal?.breedingRecords, authToken, API_BASE_URL]);

    // Fetch assigned enclosure info
    React.useEffect(() => {
        if (!animal?.enclosureId || !authToken) { setEnclosureInfo(null); return; }
        axios.get(`${API_BASE_URL}/enclosures`, { headers: { Authorization: `Bearer ${authToken}` } })
            .then(res => setEnclosureInfo(res.data.find(e => e._id === animal.enclosureId) || null))
            .catch(() => setEnclosureInfo(null));
    }, [animal?.enclosureId, authToken, API_BASE_URL]);
    
    // Fetch breeder info when component mounts or animal changes
    React.useEffect(() => {
        const fetchBreeder = async () => {
            if (animal?.breederId_public) {
                try {
                    const response = await axios.get(
                        `${API_BASE_URL}/public/profiles/search?query=${animal.breederId_public}&limit=1`
                    );
                    if (response.data && response.data.length > 0) {
                        setBreederInfo(response.data[0]);
                    }
                } catch (error) {
                    console.error('Failed to fetch breeder info:', error);
                    setBreederInfo(null);
                }
            } else {
                setBreederInfo(null);
            }
        };
        fetchBreeder();
    }, [animal?.breederId_public, API_BASE_URL]);
    
    if (!animal) return null;

    return (
        <div className="fixed inset-0 bg-accent/10 flex items-center justify-center p-2 sm:p-4 z-[70] overflow-y-auto">
            <div className="bg-primary rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto overflow-x-hidden">
                {/* Header */}
                <div className="bg-white rounded-t-lg p-2 sm:p-4 border-b border-gray-300 mt-12 sm:mt-0">
                    {/* Mobile layout: stacked */}
                    <div className="sm:hidden">
                        <div className="flex justify-between items-center mb-2">
                            <button 
                                onClick={onClose} 
                                className="flex items-center text-gray-600 hover:text-gray-800 transition text-sm"
                            >
                                <ArrowLeft size={16} className="mr-1" /> Back
                            </button>
                            <span className="text-[10px] bg-orange-100 text-orange-800 px-1.5 py-0.5 rounded font-medium">
                                🔒 VIEW-ONLY
                            </span>
                            <button onClick={onCloseAll || onClose} className="text-gray-500 hover:text-gray-800">
                                <X size={24} />
                            </button>
                        </div>
                        <div className="flex justify-center gap-1.5 flex-wrap">
                            {onHideAnimal && (
                                <button
                                    onClick={() => {
                                        if (window.confirm(`Hide ${animal.name || 'this animal'}? You can restore it anytime from the hidden animals section.`)) {
                                            onHideAnimal(animal.id_public);
                                            onClose();
                                        }
                                    }}
                                    className="px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold rounded-lg transition flex items-center gap-1"
                                    title="Hide this animal - move to hidden section"
                                >
                                    <Eye size={14} />
                                    Hide
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Desktop layout: single row */}
                    <div className="hidden sm:flex justify-between items-center">
                        <button 
                            onClick={onClose} 
                            className="flex items-center text-gray-600 hover:text-gray-800 transition"
                        >
                            <ArrowLeft size={18} className="mr-1" /> Back
                        </button>
                        <div className="flex items-center gap-2">
                            <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-medium">
                                🔒 VIEW-ONLY - Read Only Access
                            </span>
                            {onHideAnimal && (
                                <button
                                    onClick={() => {
                                        if (window.confirm(`Hide ${animal.name || 'this animal'}? You can restore it anytime from the hidden animals section.`)) {
                                            onHideAnimal(animal.id_public);
                                            onClose();
                                        }
                                    }}
                                    className="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition flex items-center gap-2"
                                    title="Hide this animal - move to hidden section"
                                >
                                    <Eye size={16} />
                                    Hide
                                </button>
                            )}
                            <button onClick={onCloseAll || onClose} className="text-gray-500 hover:text-gray-800">
                                <X size={28} />
                            </button>
                        </div>
                    </div>
                </div>

                {/* Tabs - ALL 11 TABS (same as PrivateAnimalDetail) */}
                <div className="bg-white border-b border-gray-300 px-6 pt-4">
                    <div className="flex flex-wrap gap-1 pb-4">
                        {[
                            { id: 1, label: 'Overview', icon: '📋' },
                            { id: 2, label: 'Status & Privacy', icon: '🔒' },
                            { id: 3, label: 'Physical', icon: '🎨' },
                            { id: 4, label: 'Identification', icon: '🏷️' },
                            { id: 5, label: 'Lineage', icon: '🌳' },
                            { id: 6, label: 'Breeding', icon: '🥚' },
                            { id: 7, label: 'Health', icon: '🏥' },
                            { id: 8, label: 'Animal Care', icon: '🏠' },
                            { id: 9, label: 'Behavior', icon: '🧠' },
                            { id: 10, label: 'Records', icon: '📝' },
                            { id: 11, label: 'End of Life', icon: '⚖️' },
                            { id: 12, label: 'Show', icon: '🏆' },
                            { id: 13, label: 'Legal', icon: '📄' },
                            { id: 14, label: 'Logs', icon: '📜' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                type="button"
                                onClick={() => setDetailViewTab(tab.id)}
                                className={`flex-shrink-0 px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium rounded border transition-colors ${
                                    detailViewTab === tab.id 
                                        ? 'bg-primary text-black border-gray-400' 
                                        : 'bg-gray-50 text-gray-600 hover:text-gray-800 border-gray-300'
                                }`}
                                title={tab.label}
                            >
                                <span className="mr-1">{tab.icon}</span>
                                <span className="hidden lg:inline">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Tab Content - COPY OF PRIVATE DETAIL (no edit/delete/privacy toggle in Tab 1) */}
                <div className="bg-white border border-t-0 border-gray-300 rounded-b-lg p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                    {/* Tab 1: Overview - NO PRIVACY TOGGLE */}
                    {detailViewTab === 1 && (
                        <div className="space-y-4">
                            <div className="bg-white border-2 border-gray-300 rounded-lg overflow-hidden">
                                <div className="flex flex-col md:flex-row relative">
                                    <div className="w-full md:w-1/3 p-4 sm:p-6 flex flex-col items-center justify-center relative min-h-60 md:min-h-80">
                                        <div className="absolute top-2 left-2 text-xs text-gray-600 bg-white/80 px-2 py-0.5 rounded">
                                            {animal.birthDate ? formatDate(animal.birthDate) : ''}
                                        </div>
                                        <div className="absolute top-2 right-2">
                                            {animal.gender === 'Male' ? <Mars size={20} strokeWidth={2.5} className="text-blue-600" /> : animal.gender === 'Female' ? <Venus size={20} strokeWidth={2.5} className="text-pink-600" /> : animal.gender === 'Intersex' ? <VenusAndMars size={20} strokeWidth={2.5} className="text-purple-500" /> : <Circle size={20} strokeWidth={2.5} className="text-gray-500" />}
                                        </div>
                                        <div className="flex items-center justify-center h-40 w-full">
                                            {(animal.imageUrl || animal.photoUrl) ? (
                                                <img 
                                                    src={animal.imageUrl || animal.photoUrl} 
                                                    alt={animal.name} 
                                                    className="max-w-32 max-h-32 w-auto h-auto object-contain rounded-md cursor-pointer hover:opacity-80 transition"
                                                    onClick={() => {
                                                        if (setEnlargedImageUrl && setShowImageModal) {
                                                            setEnlargedImageUrl(animal.imageUrl || animal.photoUrl);
                                                            setShowImageModal(true);
                                                        }
                                                    }}
                                                />
                                            ) : (
                                                <div className="w-32 h-32 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                    <Cat size={48} />
                                                </div>
                                            )}
                                        </div>
                                        <div className="text-sm font-medium mt-2">
                                            {animal.breederId_public && animal.ownerId_public && animal.breederId_public !== animal.ownerId_public ? (
                                                <div className="space-y-1">
                                                    <div className="text-gray-700">Sold</div>
                                                    {animal.status && <div className="text-gray-700">{animal.status}</div>}
                                                </div>
                                            ) : (
                                                <span className="text-gray-700">{animal.status || 'Unknown'}</span>
                                            )}
                                        </div>
                                    </div>

                                    <div className="w-full md:w-2/3 p-4 sm:p-6 flex flex-col border-t md:border-t-0 md:border-l border-gray-300 space-y-3">
                                        {/* Species/Breed/Strain/CTC - At Top (NO PRIVACY TOGGLE) */}
                                        <p className="text-sm text-gray-600">
                                            {animal.species || 'Unknown'}
                                            {animal.breed && ` � ${animal.breed}`}
                                            {animal.strain && ` � ${animal.strain}`}
                                            {animal.id_public && ` � ${animal.id_public}`}
                                        </p>

                                        {/* Full Name */}
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            {animal.prefix ? `${animal.prefix} ` : ''}
                                            {animal.name}
                                            {animal.suffix ? ` ${animal.suffix}` : ''}
                                        </h2>

                                        {/* For Sale Badge */}
                                        {animal.isForSale && (
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                                                <span className="text-lg">🏷️</span>
                                                <div>
                                                    <p className="text-sm font-semibold text-gray-700">For Sale</p>
                                                    <p className="text-sm text-gray-600">
                                                        {animal.salePriceCurrency === 'Negotiable' || !animal.salePriceAmount ? 'Negotiable' : `${getCurrencySymbol(animal.salePriceCurrency)}${animal.salePriceAmount ? ` ${animal.salePriceAmount}` : ''}`}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* For Stud Badge */}
                                        {animal.availableForBreeding && (
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-2">
                                                <span className="text-lg">🏷️</span>
                                                <div>
                                                    <p className="text-sm font-semibold text-gray-700">Available for Stud</p>
                                                    <p className="text-sm text-gray-600">
                                                        {animal.studFeeCurrency === 'Negotiable' || !animal.studFeeAmount ? 'Negotiable' : `${getCurrencySymbol(animal.studFeeCurrency)}${animal.studFeeAmount ? ` ${animal.studFeeAmount}` : ''}`}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* Variety */}
                                        <p className="text-sm text-gray-700">
                                            <span className="font-semibold">Variety:</span> {[
                                                animal.color,
                                                animal.coatPattern,
                                                animal.coat,
                                                animal.earset,
                                                animal.phenotype,
                                                animal.morph,
                                                animal.markings,
                                                animal.eyeColor,
                                                animal.nailColor,
                                                animal.carrierTraits,
                                                animal.size
                                            ].filter(Boolean).join(' ') || ''}
                                        </p>

                                        {/* Genetic Code */}
                                        {animal.geneticCode && (
                                            <p className="text-sm text-gray-700">
                                                <span className="font-semibold">Genetic Code:</span> <code className="bg-gray-100 px-1 rounded font-mono">{animal.geneticCode}</code>
                                            </p>
                                        )}

                                        {/* Date of Birth and Age/Deceased */}
                                        <div className="text-sm text-gray-700 space-y-1">
                                            <p>
                                                <span className="font-semibold">Date of Birth:</span> {animal.birthDate ? `${formatDate(animal.birthDate)} (~${(() => {
                                                    const birth = new Date(animal.birthDate);
                                                    const endDate = animal.deceasedDate ? new Date(animal.deceasedDate) : new Date();
                                                    let years = endDate.getFullYear() - birth.getFullYear();
                                                    let months = endDate.getMonth() - birth.getMonth();
                                                    let days = endDate.getDate() - birth.getDate();
                                                    
                                                    if (days < 0) {
                                                        months--;
                                                        const prevMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                                                        days += prevMonth.getDate();
                                                    }
                                                    if (months < 0) {
                                                        years--;
                                                        months += 12;
                                                    }
                                                    
                                                    if (years > 0) {
                                                        return `${years}y ${months}m ${days}d`;
                                                    } else if (months > 0) {
                                                        return `${months}m ${days}d`;
                                                    } else {
                                                        return `${days}d`;
                                                    }
                                                })()})` : ''}
                                            </p>
                                            {animal.deceasedDate && (
                                                <p className="text-red-600 font-semibold">
                                                    Deceased: {formatDate(animal.deceasedDate)}
                                                </p>
                                            )}
                                        </div>

                                        {/* Remarks */}
                                        {animal.remarks && (
                                            <div className="text-sm text-gray-700">
                                                <span className="font-semibold">Remarks:</span>
                                                <strong className="block mt-0.5 whitespace-pre-wrap">{animal.remarks}</strong>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Breeder Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">⭐ Breeder</h3>
                                <p className="text-gray-700">
                                    {breederInfo ? (() => {
                                        const showPersonal = breederInfo.showPersonalName ?? false;
                                        const showBreeder = breederInfo.showBreederName ?? false;
                                        let bDisplayName;
                                        if (showPersonal && showBreeder && breederInfo.personalName && breederInfo.breederName) {
                                            bDisplayName = `${breederInfo.personalName} (${breederInfo.breederName})`;
                                        } else if (showBreeder && breederInfo.breederName) {
                                            bDisplayName = breederInfo.breederName;
                                        } else if (showPersonal && breederInfo.personalName) {
                                            bDisplayName = breederInfo.personalName;
                                        } else {
                                            bDisplayName = 'Unknown Breeder';
                                        }
                                        return <RouterLink to={`/user/${breederInfo.id_public}`} className="text-blue-600 hover:underline font-semibold">{bDisplayName}</RouterLink>;
                                    })() : ((animal.manualBreederName || animal.breederId_public) ? <span className="font-mono text-accent">{animal.manualBreederName || animal.breederId_public}</span> : '')}
                                </p>
                            </div>

                            {/* Identification Numbers Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🔢 Identification Numbers</h3>
                                <div className="space-y-2 text-sm">
                                    <p><span className="text-gray-600">CritterTrack ID:</span> <strong>{animal.id_public || ''}</strong></p>
                                    {animal.breederAssignedId && <p><span className="text-gray-600">Identification:</span> <strong>{animal.breederAssignedId}</strong></p>}
                                    {animal.microchipNumber && <p><span className="text-gray-600">Microchip:</span> <strong>{animal.microchipNumber}</strong></p>}
                                    {animal.pedigreeRegistrationId && <p><span className="text-gray-600">Pedigree Reg ID:</span> <strong>{animal.pedigreeRegistrationId}</strong></p>}
                                </div>
                            </div>

                            {/* Genetic Code Display Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🧬 Genetic Code</h3>
                                <p className="text-gray-700 font-mono text-sm break-all">{animal.geneticCode || ''}</p>
                            </div>

                            {/* Parents Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">🌳 Parents</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <ViewOnlyParentCard 
                                        parentId={animal.fatherId_public || animal.sireId_public} 
                                        parentType="Sire"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                    <ViewOnlyParentCard 
                                        parentId={animal.motherId_public || animal.damId_public} 
                                        parentType="Dam"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 2: Status & Privacy */}
                    {detailViewTab === 2 && (
                        <div className="space-y-6">
                            {/* 1st Section: Ownership */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">👥 Ownership</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Currently Owned:</span>
                                        <strong>{animal.isOwned ? 'Yes' : 'No'}</strong>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Breeder:</span>
                                        {breederInfo
                                            ? <RouterLink to={`/user/${breederInfo.id_public}`} className="text-blue-600 hover:underline font-semibold">{breederInfo.breederName || breederInfo.personalName || 'Unknown'}</RouterLink>
                                            : <strong>{animal.manualBreederName || animal.breederId_public || ''}</strong>}
                                    </div>
                                </div>
                            </div>

                            {/* 2nd Section: Current Owner */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🏠 Keeper</h3>
                                <div className="text-sm space-y-2">
                                    {(animal.keeperName || animal.isOwned) && (
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Keeper Name:</span>
                                        <strong>{animal.keeperName || (animal.isOwned ? 'Me' : '')}</strong>
                                    </div>
                                    )}
                                    {animal.coOwnership && (
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-600">Co-Ownership:</span>
                                            <strong>{animal.coOwnership}</strong>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 3rd Section: Keeper History */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">?? Keeper History</h3>
                                {(animal.keeperHistory || []).length === 0 ? (
                                    <p className="text-sm text-gray-400 italic">No entries yet</p>
                                ) : (
                                    <div className="space-y-2">
                                        {(animal.keeperHistory || []).map((entry, idx) => (
                                            <div key={idx} className="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-semibold text-gray-800">{entry.name || 'Unknown'}</p>
                                                    {entry.userId_public && <p className="text-xs text-gray-400 font-mono">{entry.userId_public}</p>}
                                                </div>
                                                {entry.country && (
                                                    <div className="flex items-center gap-1 flex-shrink-0">
                                                        <span className={`${getCountryFlag(entry.country)} inline-block h-4 w-6`}></span>
                                                        <span className="text-xs text-gray-500">{getCountryName(entry.country)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* 4th Section: Availability for Sale or Stud */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🏷️🥚 Availability for Sale or Stud</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">For Sale:</span>
                                        <strong>{animal.isForSale ? `Yes - ${animal.salePriceCurrency || ''} ${animal.salePriceAmount || 'Negotiable'}`.trim() : 'No'}</strong>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">For Stud:</span>
                                        <strong>{animal.availableForBreeding ? `Yes - ${animal.studFeeCurrency || ''} ${animal.studFeeAmount || 'Negotiable'}`.trim() : 'No'}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 3: Physical */}
                    {detailViewTab === 3 && (
                        <div className="space-y-6">
                            {/* Appearance */}
                            {(() => {
                                const fields = [
                                    { key: 'color', label: 'Color' },
                                    { key: 'coatPattern', label: 'Pattern' },
                                    { key: 'coat', label: 'Coat Type' },
                                    { key: 'earset', label: 'Earset' },
                                    { key: 'phenotype', label: 'Phenotype' },
                                    { key: 'morph', label: 'Morph' },
                                    { key: 'markings', label: 'Markings' },
                                    { key: 'eyeColor', label: 'Eye Color' },
                                    { key: 'nailColor', label: 'Nail/Claw Color' },
                                    { key: 'size', label: 'Size' },
                                    { key: 'carrierTraits', label: 'Carrier Traits' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return fields.length > 0 && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">✨ Appearance</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            {fields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Genetic Code */}
                            {fieldTemplate?.fields?.geneticCode?.enabled !== false && animal.geneticCode && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">{getLabel('geneticCode', 'Genetic Code')}</h3>
                                    <p className="text-gray-700 font-mono text-sm break-all">{animal.geneticCode}</p>
                                </div>
                            )}

                            {/* Life Stage */}
                            {fieldTemplate?.fields?.lifeStage?.enabled !== false && animal.lifeStage && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">{getLabel('lifeStage', 'Life Stage')}</h3>
                                    <p className="text-gray-700 text-sm">{animal.lifeStage}</p>
                                </div>
                            )}

                            {/* Measurements */}
                            {(() => {
                                const mFields = [
                                    { key: 'bodyWeight', label: 'Weight' },
                                    { key: 'bodyLength', label: 'Body Length' },
                                    { key: 'heightAtWithers', label: 'Height at Withers' },
                                    { key: 'chestGirth', label: 'Chest Girth' },
                                    { key: 'adultWeight', label: 'Adult Weight' },
                                    { key: 'bodyConditionScore', label: 'Body Condition Score' },
                                    { key: 'length', label: 'Length' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return mFields.length > 0 && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">📏 Measurements</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            {mFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* Tab 4: Identification */}
                    {detailViewTab === 4 && (
                        <div className="space-y-6">
                            {/* Identification Numbers */}
                            {(() => {
                                const idFields = [
                                    { key: 'breederAssignedId', label: 'Identification' },
                                    { key: 'microchipNumber', label: 'Microchip Number' },
                                    { key: 'pedigreeRegistrationId', label: 'Pedigree Registration ID' },
                                    { key: 'colonyId', label: 'Colony ID' },
                                    { key: 'rabiesTagNumber', label: 'Rabies Tag Number' },
                                    { key: 'tattooId', label: 'Tattoo ID' },
                                    { key: 'akcRegistrationNumber', label: 'AKC Registration #' },
                                    { key: 'fciRegistrationNumber', label: 'FCI Registration #' },
                                    { key: 'cfaRegistrationNumber', label: 'CFA Registration #' },
                                    { key: 'workingRegistryIds', label: 'Working Registry IDs' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">🔢 Identification Numbers</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div><span className="text-gray-600">CritterTrack ID:</span> <strong>{animal.id_public || ''}</strong></div>
                                            {idFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Classification */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🗂️ Classification</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Species:</span> <strong>{animal.species || ''}</strong></div>
                                    {fieldTemplate?.fields?.breed?.enabled !== false && animal.breed && (
                                        <div><span className="text-gray-600">{getLabel('breed', 'Breed')}:</span> <strong>{animal.breed}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.strain?.enabled !== false && animal.strain && (
                                        <div><span className="text-gray-600">{getLabel('strain', 'Strain')}:</span> <strong>{animal.strain}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* Tags */}
                            {animal.tags && animal.tags.length > 0 && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🏷️ Tags</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {animal.tags.map((tag, idx) => (
                                            <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">{tag}</span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Origin */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌍 Origin</h3>
                                <p className="text-sm text-gray-700">{animal.origin || ''}</p>
                            </div>
                        </div>
                    )}

                    {/* Tab 5: Lineage */}
                    {detailViewTab === 5 && (
                        <div className="space-y-6">
                            {/* 1st Section: Pedigree */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-semibold text-gray-700">🌳 Pedigree: Sire and Dam</h3>
                                    <button
                                        onClick={() => setShowPedigree(true)}
                                        data-tutorial-target="pedigree-btn"
                                        className="px-3 py-1 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition text-sm"
                                    >
                                        View Pedigree Chart
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <ViewOnlyParentCard 
                                        parentId={animal.fatherId_public || animal.sireId_public} 
                                        parentType="Sire"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                    <ViewOnlyParentCard 
                                        parentId={animal.motherId_public || animal.damId_public} 
                                        parentType="Dam"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                </div>
                            </div>

                            {/* 2nd Section: Keeper History */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">?? Keeper History</h3>
                                {(animal.keeperHistory || []).length === 0 ? (
                                    <p className="text-sm text-gray-400 italic">No entries yet</p>
                                ) : (
                                    <div className="space-y-2">
                                        {(animal.keeperHistory || []).map((entry, idx) => (
                                            <div key={idx} className="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-semibold text-gray-800">{entry.name || 'Unknown'}</p>
                                                    {entry.userId_public && <p className="text-xs text-gray-400 font-mono">{entry.userId_public}</p>}
                                                </div>
                                                {entry.country && (
                                                    <div className="flex items-center gap-1 flex-shrink-0">
                                                        <span className={`${getCountryFlag(entry.country)} inline-block h-4 w-6`}></span>
                                                        <span className="text-xs text-gray-500">{getCountryName(entry.country)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* 3rd Section: Breeding Records - Accordion View */}
                            {animal.breedingRecords && animal.breedingRecords.length > 0 && (
                                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200 space-y-3">
                                    <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-purple-600 mr-2">📊</span>Breeding Records</h3>
                                    <div className="space-y-2">
                                        {animal.breedingRecords.map((record, idx) => {
                                            const isSireOnly = animal.gender === 'Male' || (animal.gender === 'Unknown' && animal.breedingRole === 'sire');
                                            const isDamOnly = animal.gender === 'Female' || (animal.gender === 'Unknown' && animal.breedingRole === 'dam');
                                            const isBoth = animal.gender === 'Intersex' || (animal.gender === 'Unknown' && animal.breedingRole === 'both');
                                            const isExpanded = expandedBreedingRecords[idx];
                                            const countSummary = [
                                                record.litterSizeBorn !== null && `${record.litterSizeBorn} born`,
                                                record.stillbornCount && `${record.stillbornCount} stillborn`,
                                                record.litterSizeWeaned !== null && `${record.litterSizeWeaned} weaned`
                                            ].filter(Boolean).join(' � ') || 'No counts';
                                            return (
                                                <div key={idx} className={`bg-white rounded border transition-all ${isExpanded ? 'border-purple-300 shadow-md' : 'border-purple-100'}`}>
                                                    <div 
                                                        onClick={() => setExpandedBreedingRecords({...expandedBreedingRecords, [idx]: !isExpanded})}
                                                        className="p-3 flex items-center justify-between cursor-pointer hover:bg-purple-50 transition rounded"
                                                    >
                                                        <div className="flex items-center gap-3 flex-1">
                                                            <span className={`text-lg transition-transform ${isExpanded ? 'rotate-90' : ''}`}>▶️</span>
                                                            {record.litterName ? (
                                                                <>
                                                                    <span className="px-2 py-0.5 rounded text-xs font-bold bg-purple-700 text-white flex-shrink-0">{record.litterName}</span>
                                                                    {record.litterId && <span className="text-xs font-mono text-gray-400 flex-shrink-0">{record.litterId}</span>}
                                                                </>
                                                            ) : record.litterId ? (
                                                                <span className="font-mono px-2 py-0.5 rounded text-xs font-semibold flex-shrink-0 bg-purple-300 text-purple-800">{record.litterId}</span>
                                                            ) : null}
                                                            <div className="text-sm text-gray-700 flex items-center gap-2 flex-wrap">
                                                                {record.birthEventDate && <><span>{formatDate(record.birthEventDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                {!record.birthEventDate && formatDate(record.matingDate) && <><span>{formatDate(record.matingDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                {record.mate && <><span>{record.mate}</span><span className="text-gray-400">&bull;</span></>}
                                                                <span className="text-purple-700 font-medium">{countSummary}</span>
                                                            </div>
                                                        </div>
                                                        {!record.litterId && !isExpanded && (
                                                            <div className="flex gap-1 ml-2">
                                                                <button onClick={(e) => { e.stopPropagation(); setBreedingRecordForLitter(record); setShowCreateLitterModal(true); }} className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200" title="Create new litter from this record">Create</button>
                                                                <button onClick={(e) => { e.stopPropagation(); setBreedingRecordForLitter(record); setShowLinkLitterModal(true); }} className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200" title="Link existing litter">Link</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    {isExpanded && (
                                                        <div className="border-t border-purple-100 p-4 bg-purple-50 space-y-4">
                                                            {/* CTL ID + Litter Name */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                <div><div className="text-gray-600 text-xs">CTL ID</div><div className="font-mono text-xs font-semibold text-gray-700">{record.litterId || 'Not Linked'}</div></div>
                                                                {record.litterName && <div><div className="text-gray-600 text-xs">Litter Name</div><div className="font-semibold text-purple-800">{record.litterName}</div></div>}
                                                            </div>
                                                            {/* Mate, Dates, Method, Condition, Outcome */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                {record.mate && (<div><div className="text-gray-600 text-xs">Mate / Other Parent</div><div className="font-semibold text-gray-800">{record.mate}</div></div>)}
                                                                <div><div className="text-gray-600 text-xs">Mating Date</div><div className="font-semibold text-gray-800">{formatDate(record.matingDate) || '�'}</div></div>
                                                                {record.breedingMethod && (<div><div className="text-gray-600 text-xs">Breeding Method</div><div className="font-semibold text-gray-800">{record.breedingMethod}</div></div>)}
                                                                {record.breedingConditionAtTime && (<div><div className="text-gray-600 text-xs">Breeding Condition</div><div className="font-semibold text-gray-800">{record.breedingConditionAtTime}</div></div>)}
                                                                {record.outcome && (<div><div className="text-gray-600 text-xs">Outcome</div><div className={`font-semibold ${record.outcome === 'Successful' ? 'text-green-600' : record.outcome === 'Unsuccessful' ? 'text-red-600' : 'text-gray-600'}`}>{record.outcome}</div></div>)}
                                                                {(isDamOnly || isBoth) && (<div><div className="text-gray-600 text-xs">Birth Date</div><div className="font-semibold text-gray-800">{formatDate(record.birthEventDate) || '�'}</div></div>)}
                                                                {record.birthMethod && (<div><div className="text-gray-600 text-xs">Birth Method</div><div className="font-semibold text-gray-800">{record.birthMethod}</div></div>)}
                                                            </div>
                                                            {/* Notes */}
                                                            {record.notes && (<div className="bg-white p-3 rounded border border-purple-100"><div className="text-sm font-semibold text-gray-700 mb-2">Notes</div><div className="text-sm text-gray-700 italic">{record.notes}</div></div>)}
                                                            {/* Offspring Counts */}
                                                            <div className="bg-white p-3 rounded border border-purple-100">
                                                                <div className="text-sm font-semibold text-gray-700 mb-3">Offspring Counts</div>
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                                    <div><div className="text-gray-600 text-xs">Total Born</div><div className="text-2xl font-bold text-purple-600">{record.litterSizeBorn !== null ? record.litterSizeBorn : '�'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Stillborn</div><div className="text-2xl font-bold text-gray-600">{record.stillbornCount || '0'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Weaned</div><div className="text-2xl font-bold text-green-600">{record.litterSizeWeaned !== null ? record.litterSizeWeaned : '�'}</div></div>
                                                                    {breedingRecordLitters?.[record.litterId]?.maleCount != null && <div><div className="text-gray-600 text-xs">Males</div><div className="text-2xl font-bold text-blue-500">{breedingRecordLitters[record.litterId].maleCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.femaleCount != null && <div><div className="text-gray-600 text-xs">Females</div><div className="text-2xl font-bold text-pink-500">{breedingRecordLitters[record.litterId].femaleCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.unknownCount != null && breedingRecordLitters[record.litterId].unknownCount > 0 && <div><div className="text-gray-600 text-xs">Unknown / Intersex</div><div className="text-2xl font-bold text-gray-600">{breedingRecordLitters[record.litterId].unknownCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.inbreedingCoefficient != null && <div><div className="text-gray-600 text-xs">COI</div><div className="text-xl font-bold text-orange-600">{breedingRecordLitters[record.litterId].inbreedingCoefficient.toFixed(2)}%</div></div>}
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2 pt-2">
                                                                {!record.litterId && (
                                                                    <>
                                                                        <button onClick={() => { setBreedingRecordForLitter(record); setShowCreateLitterModal(true); }} className="flex-1 px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium">Create Litter</button>
                                                                        <button onClick={() => { setBreedingRecordForLitter(record); setShowLinkLitterModal(true); }} className="flex-1 px-3 py-2 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium">Link Litter</button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* 4th Section: Offspring */}
                            <OffspringSection animalId={animal.id_public} API_BASE_URL={API_BASE_URL} authToken={authToken} onViewAnimal={onViewAnimal} />
                        </div>
                    )}

                    {/* Tab 6: Breeding */}
                    {detailViewTab === 6 && (
                        <div className="space-y-6">
                            {/* 1st Section: Reproductive Status */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌿 Reproductive Status</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Neutered/Spayed:</span> <strong>{animal.isNeutered ? 'Yes' : 'No'}</strong></div>
                                    <div><span className="text-gray-600">Infertile:</span> <strong>{animal.isInfertile ? 'Yes' : 'No'}</strong></div>
                                    {!animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">In Mating:</span> <strong>{animal.isInMating ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && !animal.isNeutered && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('isPregnant', 'Pregnant')}:</span> <strong>{animal.isPregnant ? 'Yes' : 'No'}</strong></div>
                                            <div><span className="text-gray-600">{getLabel('isNursing', 'Nursing')}:</span> <strong>{animal.isNursing ? 'Yes' : 'No'}</strong></div>
                                        </>
                                    )}
                                    {animal.gender === 'Male' && !animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">Stud Animal:</span> <strong>{animal.isStudAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {animal.gender === 'Female' && !animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">Breeding Dam:</span> <strong>{animal.isDamAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* 2nd Section: Estrus/Cycle (Female/Intersex/Unknown only) */}
                            {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && !animal.isNeutered && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🔄 Estrus/Cycle</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Heat Status:</span> <strong>{animal.heatStatus || ''}</strong></div>
                                        <div><span className="text-gray-600">Last Heat Date:</span> <strong>{animal.lastHeatDate ? formatDate(animal.lastHeatDate) : ''}</strong></div>
                                        <div><span className="text-gray-600">{getLabel('ovulationDate', 'Ovulation Date')}:</span> <strong>{animal.ovulationDate ? formatDate(animal.ovulationDate) : ''}</strong></div>
                                        {animal.estrusCycleLength && (
                                            <div><span className="text-gray-600">Estrus Cycle Length:</span> <strong>{`${animal.estrusCycleLength} days`}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* 4th Section: Stud Information */}
                            {!animal.isNeutered && !animal.isInfertile && (animal.gender === 'Male' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♂️ Sire Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Fertility Status:</span> <strong>{animal.fertilityStatus || ''}</strong></div>
                                    </div>
                                    {animal.fertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animal.fertilityNotes}</strong></div>
                                    )}
                                    {animal.reproductiveClearances && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveClearances}</strong></div>
                                    )}
                                    {animal.reproductiveComplications && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveComplications}</strong></div>
                                    )}
                                </div>
                            )}

                            {/* 5th Section: Dam Information */}
                            {!animal.isNeutered && !animal.isInfertile && (animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♀️ Dam Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">{getLabel('damFertilityStatus', 'Dam Fertility Status')}:</span> <strong>{animal.damFertilityStatus || animal.fertilityStatus || ''}</strong></div>
                                        {animal.gestationLength && (
                                            <div><span className="text-gray-600">{getLabel('gestationLength', 'Gestation Length')}:</span> <strong>{`${animal.gestationLength} days`}</strong></div>
                                        )}
                                        {animal.deliveryMethod && (
                                            <div><span className="text-gray-600">{getLabel('deliveryMethod', 'Delivery Method')}:</span> <strong>{animal.deliveryMethod}</strong></div>
                                        )}
                                        {animal.whelpingDate && (
                                            <div><span className="text-gray-600">{getLabel('whelpingDate', 'Whelping Date')}:</span> <strong>{formatDate(animal.whelpingDate)}</strong></div>
                                        )}
                                        {animal.queeningDate && (
                                            <div><span className="text-gray-600">{getLabel('queeningDate', 'Queening Date')}:</span> <strong>{formatDate(animal.queeningDate)}</strong></div>
                                        )}
                                    </div>
                                    {animal.damFertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animal.damFertilityNotes}</strong></div>
                                    )}
                                    {animal.reproductiveClearances && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveClearances}</strong></div>
                                    )}
                                    {animal.reproductiveComplications && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveComplications}</strong></div>
                                    )}
                                </div>
                            )}

                            {/* 6th Section: Breeding History */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-blue-600 mr-2">📊</span>Breeding History</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {(animal.gender === 'Male' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('lastMatingDate', 'Last Mating Date')}:</span> <strong>{animal.lastMatingDate ? formatDate(animal.lastMatingDate) : ''}</strong></div>
                                            </>
                                    )}
                                    {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('lastPregnancyDate', 'Last Pregnancy Date')}:</span> <strong>{animal.lastPregnancyDate ? formatDate(animal.lastPregnancyDate) : ''}</strong></div>
                                            <div><span className="text-gray-600">{getLabel('litterCount', 'Litter Count')}:</span> <strong>{animal.litterCount || ''}</strong></div>
                                        </>
                                    )}
                                    <div><span className="text-gray-600">Total Offspring:</span> <strong>{animal.offspringCount || ''}</strong></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 7: Health */}
                    {detailViewTab === 7 && (
                        <div className="space-y-6">
                            {/* 1st Section: Preventive Care */}
                            {(animal.vaccinations || animal.dewormingRecords || animal.parasiteControl || animal.parasitePreventionSchedule) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, preventiveCare: !p.preventiveCare}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🛡️ Preventive Care</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.preventiveCare ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.preventiveCare && (<div className="space-y-4 mt-4">
                                    {animal.vaccinations && (
                                        <DetailJsonList
                                            label={getLabel('vaccinations', 'Vaccinations')}
                                            data={animal.vaccinations}
                                            renderItem={v => <>{v.name} {v.date && `(${formatDate(v.date)})`}{v.notes && <span className="text-gray-600"> - {v.notes}</span>}</>}
                                        />
                                    )}
                                    {animal.dewormingRecords && (
                                        <DetailJsonList
                                            label="Deworming Records"
                                            data={animal.dewormingRecords}
                                            renderItem={r => <>{r.medication} {r.date && `(${formatDate(r.date)})`}{r.notes && <span className="text-gray-600"> - {r.notes}</span>}</>}
                                        />
                                    )}
                                    {animal.parasiteControl && (
                                        <DetailJsonList
                                            label="Parasite Control"
                                            data={animal.parasiteControl}
                                            renderItem={r => <>{r.treatment} {r.date && `(${formatDate(r.date)})`}{r.notes && <span className="text-gray-600"> - {r.notes}</span>}</>}
                                        />
                                    )}
                                    {fieldTemplate?.fields?.parasitePreventionSchedule?.enabled !== false && animal.parasitePreventionSchedule && (
                                        <div className="text-sm">
                                            <span className="text-gray-600">{getLabel('parasitePreventionSchedule', 'Parasite Prevention Schedule')}:</span>
                                            <strong className="whitespace-pre-wrap">{animal.parasitePreventionSchedule}</strong>
                                        </div>
                                    )}
                                </div>)}
                            </div>
                            )}

                            {/* 2nd Section: Procedures & Diagnostics */}
                            {(animal.medicalProcedures || animal.labResults || animal.laboratoryResults) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, proceduresDiagnostics: !p.proceduresDiagnostics}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🔬 Procedures & Diagnostics</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.proceduresDiagnostics ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.proceduresDiagnostics && (<div className="space-y-4 mt-4">
                                    {animal.medicalProcedures && (
                                        <DetailJsonList
                                            label="Medical Procedures"
                                            data={animal.medicalProcedures}
                                            renderItem={p => <>{p.name} {p.date && `(${formatDate(p.date)})`}{p.notes && <span className="text-gray-600"> - {p.notes}</span>}</>}
                                        />
                                    )}
                                    {(animal.labResults || animal.laboratoryResults) && (
                                        <DetailJsonList
                                            label="Laboratory Results"
                                            data={animal.labResults || animal.laboratoryResults}
                                            renderItem={r => <>{r.testName} - {r.result} {r.date && `(${formatDate(r.date)})`}{r.notes && <span className="text-gray-600"> - {r.notes}</span>}</>}
                                        />
                                    )}
                                </div>)}
                            </div>
                            )}

                            {/* 3rd Section: Active Medical Records */}
                            {(animal.medicalConditions || animal.allergies || animal.medications) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, activeMedical: !p.activeMedical}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🩹💊 Active Medical Records</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.activeMedical ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.activeMedical && (<div className="space-y-3 mt-4">
                                    {animal.medicalConditions && (() => {
                                        const d = animal.medicalConditions;
                                        const parsed = typeof d === 'string' ? (() => { try { return JSON.parse(d); } catch { return null; } })() : Array.isArray(d) ? d : null;
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <span className="text-gray-600 text-sm font-semibold">Medical Conditions:</span>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((item, i) => (
                                                        <li key={i} className="text-gray-700">
                                                            {item.condition || item.name}
                                                            {item.notes && <span className="text-gray-500"> � {item.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : <div><span className="text-gray-600 text-sm font-semibold">Medical Conditions:</span><strong className="text-sm whitespace-pre-wrap">{d}</strong></div>;
                                    })()}
                                    {animal.allergies && (() => {
                                        const d = animal.allergies;
                                        const parsed = typeof d === 'string' ? (() => { try { return JSON.parse(d); } catch { return null; } })() : Array.isArray(d) ? d : null;
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <span className="text-gray-600 text-sm font-semibold">Allergies:</span>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((item, i) => (
                                                        <li key={i} className="text-gray-700">
                                                            {item.allergen || item.name}
                                                            {item.notes && <span className="text-gray-500"> � {item.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : <div><span className="text-gray-600 text-sm font-semibold">Allergies:</span><strong className="text-sm whitespace-pre-wrap">{d}</strong></div>;
                                    })()}
                                    {animal.medications && (() => {
                                        const d = animal.medications;
                                        const parsed = typeof d === 'string' ? (() => { try { return JSON.parse(d); } catch { return null; } })() : Array.isArray(d) ? d : null;
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <span className="text-gray-600 text-sm font-semibold">Current Medications:</span>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((item, i) => (
                                                        <li key={i} className="text-gray-700">
                                                            {item.medication || item.name}
                                                            {item.notes && <span className="text-gray-500"> � {item.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : <div><span className="text-gray-600 text-sm font-semibold">Current Medications:</span><strong className="text-sm whitespace-pre-wrap">{d}</strong></div>;
                                    })()}
                                </div>)}
                            </div>
                            )}

                            {/* 4th Section: Health Clearances & Screening */}
                            {(() => {
                                const clearanceFields = [
                                    { key: 'heartwormStatus', label: 'Heartworm Status' },
                                    { key: 'hipElbowScores', label: 'Hip/Elbow Scores' },
                                    { key: 'eyeClearance', label: 'Eye Clearance' },
                                    { key: 'cardiacClearance', label: 'Cardiac Clearance' },
                                    { key: 'dentalRecords', label: 'Dental Records' },
                                    { key: 'geneticTestResults', label: 'Genetic Test Results' },
                                    { key: 'chronicConditions', label: 'Chronic Conditions' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                const spayDate = fieldTemplate?.fields?.spayNeuterDate?.enabled !== false && animal.spayNeuterDate;
                                return (clearanceFields.length > 0 || spayDate) && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, healthClearances: !p.healthClearances}))} className="w-full flex items-center justify-between text-left group">
                                            <h3 className="text-lg font-semibold text-gray-700">🏥 Health Clearances & Screening</h3>
                                            <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.healthClearances ? '▶' : '▼'}</span>
                                        </button>
                                        {!collapsedHealthSections.healthClearances && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4">
                                            {spayDate && <div><span className="text-gray-600">{getLabel('spayNeuterDate', 'Spay/Neuter Date')}:</span> <strong>{formatDate(animal.spayNeuterDate)}</strong></div>}
                                            {clearanceFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>)}
                                    </div>
                                );
                            })()}

                            {/* 5th Section: Veterinary Care */}
                            {(animal.primaryVet || animal.vetVisits) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, vetCare: !p.vetCare}))} className="w-full flex items-center justify-between text-left group">
                                    <h3 className="text-lg font-semibold text-gray-700">🩺 Veterinary Care</h3>
                                    <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.vetCare ? '▶' : '▼'}</span>
                                </button>
                                {!collapsedHealthSections.vetCare && (<div className="space-y-4 text-sm mt-4">
                                    {animal.primaryVet && <div><span className="text-gray-600">Primary Veterinarian:</span> <strong>{animal.primaryVet}</strong></div>}
                                    {animal.vetVisits && (
                                        <DetailJsonList
                                            label="Veterinary Visits"
                                            data={animal.vetVisits}
                                            renderItem={v => <>{v.reason} {v.date && `(${formatDate(v.date)})`}{v.notes && <span className="text-gray-600"> - {v.notes}</span>}</>}
                                        />
                                    )}
                                </div>)}
                            </div>
                            )}
                        </div>
                    )}

                    {/* Tab 8: Husbandry */}
                    {detailViewTab === 8 && (
                        <div className="space-y-6">
                            {/* 1st Section: Nutrition */}
                            {(animal.dietType || animal.feedingSchedule || animal.supplements) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🍽️ Nutrition</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.dietType && <div><span className="text-gray-600">Diet Type:</span> <strong>{animal.dietType}</strong></div>}
                                    {animal.feedingSchedule && <div><span className="text-gray-600">Feeding Schedule:</span> <strong>{animal.feedingSchedule}</strong></div>}
                                    {animal.supplements && <div><span className="text-gray-600">Supplements:</span> <strong>{animal.supplements}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 2nd Section: Husbandry */}
                            {(animal.enclosureId || animal.housingType || animal.bedding || animal.enrichment) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🧴 Animal Care</h3>
                                <div className="space-y-3 text-sm">
                                    {enclosureInfo && (<div><span className="text-gray-600">Enclosure:</span> <strong>{enclosureInfo.name}</strong></div>)}
                                    {fieldTemplate?.fields?.housingType?.enabled !== false && animal.housingType && <div><span className="text-gray-600">{getLabel('housingType', 'Housing Type')}:</span> <strong>{animal.housingType}</strong></div>}
                                    {fieldTemplate?.fields?.bedding?.enabled !== false && animal.bedding && <div><span className="text-gray-600">{getLabel('bedding', 'Bedding')}:</span> <strong>{animal.bedding}</strong></div>}
                                    {animal.enrichment && <div><span className="text-gray-600">Enrichment:</span> <strong>{animal.enrichment}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 3rd Section: Environment */}
                            {(animal.temperatureRange || animal.humidity || animal.lighting || animal.noise) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌡️ Environment</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {animal.temperatureRange && <div><span className="text-gray-600">Temperature Range:</span> <strong>{animal.temperatureRange}</strong></div>}
                                    {fieldTemplate?.fields?.humidity?.enabled !== false && animal.humidity && <div><span className="text-gray-600">{getLabel('humidity', 'Humidity')}:</span> <strong>{animal.humidity}</strong></div>}
                                    {animal.lighting && <div><span className="text-gray-600">Lighting:</span> <strong>{animal.lighting}</strong></div>}
                                    {fieldTemplate?.fields?.noise?.enabled !== false && animal.noise && <div><span className="text-gray-600">{getLabel('noise', 'Noise Level')}:</span> <strong>{animal.noise}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 4th Section: Exercise & Grooming */}
                            {(() => {
                                const egFields = [
                                    { key: 'exerciseRequirements', label: 'Exercise Requirements' },
                                    { key: 'dailyExerciseMinutes', label: 'Daily Exercise (min)' },
                                    { key: 'groomingNeeds', label: 'Grooming Needs' },
                                    { key: 'sheddingLevel', label: 'Shedding Level' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                const trainFlags = [
                                    { key: 'crateTrained', label: 'Crate Trained' },
                                    { key: 'litterTrained', label: 'Litter Trained' },
                                    { key: 'leashTrained', label: 'Leash Trained' },
                                    { key: 'freeFlightTrained', label: 'Free Flight Trained' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return (egFields.length > 0 || trainFlags.length > 0) && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">✂️ Grooming</h3>
                                        {egFields.length > 0 && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                {egFields.map(f => (
                                                    <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                                ))}
                                            </div>
                                        )}
                                        {trainFlags.length > 0 && (
                                            <div className="flex flex-wrap gap-3 text-sm">
                                                {trainFlags.map(f => (
                                                    <span key={f.key} className="inline-flex items-center bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">&#x2713; {getLabel(f.key, f.label)}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* Tab 9: Behavior */}
                    {detailViewTab === 9 && (
                        <div className="space-y-6">
                            {/* 1st Section: Behavior */}
                            {(animal.temperament || animal.handlingTolerance || animal.socialStructure) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">💭 Behavior</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.temperament && <div><span className="text-gray-600">Temperament:</span> <strong>{animal.temperament}</strong></div>}
                                    {fieldTemplate?.fields?.handlingTolerance?.enabled !== false && animal.handlingTolerance && <div><span className="text-gray-600">{getLabel('handlingTolerance', 'Handling Tolerance')}:</span> <strong>{animal.handlingTolerance}</strong></div>}
                                    {animal.socialStructure && <div><span className="text-gray-600">Social Structure:</span> <strong>{animal.socialStructure}</strong></div>}
                                </div>
                            </div>
                            )}

                            {/* 2nd Section: Activity */}
                            {animal.activityCycle && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌓🏃 Activity</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Activity Cycle:</span> <strong>{animal.activityCycle}</strong></div>
                                </div>
                            </div>
                            )}

                            {/* 3rd Section: Training & Working */}
                            {(() => {
                                const trainFields = [
                                    { key: 'trainingLevel', label: 'Training Level' },
                                    { key: 'trainingDisciplines', label: 'Training Disciplines' },
                                    { key: 'workingRole', label: 'Working Role' },
                                    { key: 'certifications', label: 'Certifications' },
                                    { key: 'behavioralIssues', label: 'Behavioral Issues' },
                                    { key: 'biteHistory', label: 'Bite History' },
                                    { key: 'reactivityNotes', label: 'Reactivity Notes' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return trainFields.length > 0 && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">🌓🏃 Training & Working</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            {trainFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* Tab 10: Records */}
                    {detailViewTab === 10 && (
                        <div className="space-y-6">
                            {/* 1st Section: Remarks & Notes */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📝 Remarks & Notes</h3>
                                <strong className="block text-sm text-gray-700 whitespace-pre-wrap">{animal.remarks || ''}</strong>
                            </div>
                        </div>
                    )}                    {/* Tab 11: End of Life */}
                    {detailViewTab === 11 && (
                        <div className="space-y-6">
                            {/* End of Life */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🕊️ Information</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Deceased Date:</span> <strong>{animal.deceasedDate ? formatDate(animal.deceasedDate) : ''}</strong></div>
                                    <div><span className="text-gray-600">Cause of Death:</span> <strong>{animal.causeOfDeath || ''}</strong></div>
                                    <div><span className="text-gray-600">Necropsy Results:</span> <strong>{animal.necropsyResults || ''}</strong></div>
                                    {animal.endOfLifeCareNotes && (
                                        <div><span className="text-gray-600">{getLabel('endOfLifeCareNotes', 'End of Life Care Notes')}:</span> <strong className="whitespace-pre-wrap">{animal.endOfLifeCareNotes}</strong></div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 12: Show */}
                    {detailViewTab === 12 && (
                        <div className="space-y-6">
                            {/* Show Titles & Ratings */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🥇 Show Titles & Ratings</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Titles:</span> <strong>{animal.showTitles || ''}</strong></div>
                                    <div><span className="text-gray-600">Ratings:</span> <strong>{animal.showRatings || ''}</strong></div>
                                    <div><span className="text-gray-600">Judge Comments:</span> <strong className="whitespace-pre-wrap">{animal.judgeComments || ''}</strong></div>
                                </div>
                            </div>

                            {/* Working Titles & Performance */}
                            {(animal.workingTitles || animal.performanceScores) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🎯 Working & Performance</h3>
                                    <div className="space-y-3 text-sm">
                                        <div><span className="text-gray-600">Working Titles:</span> <strong>{animal.workingTitles || ''}</strong></div>
                                        <div><span className="text-gray-600">Performance Scores:</span> <strong>{animal.performanceScores || ''}</strong></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 13: Legal & Documentation */}
                    {detailViewTab === 13 && (
                        <div className="space-y-6">
                            {/* Licensing & Permits */}
                            {(animal.licenseNumber || animal.licenseJurisdiction) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🔑 Licensing & Permits</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {fieldTemplate?.fields?.licenseNumber?.enabled !== false && animal.licenseNumber && (
                                        <div><span className="text-gray-600">{getLabel('licenseNumber', 'License Number')}:</span> <strong>{animal.licenseNumber}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.licenseJurisdiction?.enabled !== false && animal.licenseJurisdiction && (
                                        <div><span className="text-gray-600">{getLabel('licenseJurisdiction', 'License Jurisdiction')}:</span> <strong>{animal.licenseJurisdiction}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* Legal / Administrative */}
                            {(animal.insurance || animal.legalStatus) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📋 Legal / Administrative</h3>
                                <div className="space-y-3 text-sm">
                                    {fieldTemplate?.fields?.insurance?.enabled !== false && animal.insurance && (
                                        <div><span className="text-gray-600">{getLabel('insurance', 'Insurance')}:</span> <strong className="whitespace-pre-wrap">{animal.insurance}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.legalStatus?.enabled !== false && animal.legalStatus && (
                                        <div><span className="text-gray-600">{getLabel('legalStatus', 'Legal Status')}:</span> <strong className="whitespace-pre-wrap">{animal.legalStatus}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* Restrictions */}
                            {(animal.breedingRestrictions || animal.exportRestrictions) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🚫 Restrictions</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.breedingRestrictions && (
                                        <div><span className="text-gray-600">{getLabel('breedingRestrictions', 'Breeding Restrictions')}:</span> <strong className="whitespace-pre-wrap">{animal.breedingRestrictions}</strong></div>
                                    )}
                                    {animal.exportRestrictions && (
                                        <div><span className="text-gray-600">{getLabel('exportRestrictions', 'Export Restrictions')}:</span> <strong className="whitespace-pre-wrap">{animal.exportRestrictions}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* No data fallback */}
                            {!animal.licenseNumber && !animal.licenseJurisdiction && !animal.insurance && !animal.legalStatus && !animal.breedingRestrictions && !animal.exportRestrictions && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center text-gray-500">
                                    <p>No legal or documentation records</p>
                                </div>
                            )}
                        </div>
                    )}

                {/* Pedigree Chart Modal */}
                {showPedigree && (
                    <PedigreeChart
                        animalId={animal.id_public}
                        API_BASE_URL={API_BASE_URL}
                        authToken={authToken}
                        onClose={() => setShowPedigree(false)}
                    />
                )}
            </div>
        </div>
    </div>
    );
};

// ==================== PUBLIC ANIMAL DETAIL (VIEW-ONLY FOR OTHERS) ====================
// Respects privacy toggles - only shows public sections
// Accessed from: Global search, user profiles, offspring links
const ViewOnlyAnimalDetail = ({ animal, onClose, onCloseAll, API_BASE_URL, onViewProfile, onViewAnimal, authToken, setModCurrentContext, setShowImageModal, setEnlargedImageUrl }) => {
    const [breederInfo, setBreederInfo] = useState(null);
    const [showPedigree, setShowPedigree] = useState(false);
    const [copySuccess, setCopySuccess] = useState(false);
    const [detailViewTab, setDetailViewTab] = useState(1);
    const [animalCOI, setAnimalCOI] = useState(null);
    const [loadingCOI, setLoadingCOI] = useState(false);
    const [breedingRecordLitters, setBreedingRecordLitters] = useState({});
    const [expandedBreedingRecords, setExpandedBreedingRecords] = useState({});
    const [showCreateLitterModal, setShowCreateLitterModal] = useState(false);
    const [showLinkLitterModal, setShowLinkLitterModal] = useState(false);
    const [breedingRecordForLitter, setBreedingRecordForLitter] = useState(null);
    const { fieldTemplate, getLabel } = useDetailFieldTemplate(animal?.species, API_BASE_URL);

    // Fetch litter data when breeding records expand (for male/female counts and COI)
    React.useEffect(() => {
        if (!animal?.breedingRecords?.length || !authToken) return;
        Object.entries(expandedBreedingRecords).forEach(([idxStr, isExpanded]) => {
            if (!isExpanded) return;
            const idx = parseInt(idxStr);
            const record = animal.breedingRecords[idx];
            if (!record?.litterId || breedingRecordLitters[record.litterId] !== undefined) return;
            axios.get(`${API_BASE_URL}/litters`, { headers: { Authorization: `Bearer ${authToken}` } })
                .then(res => {
                    const litter = res.data.find(l => l.litter_id_public === record.litterId);
                    if (litter) setBreedingRecordLitters(prev => ({ ...prev, [record.litterId]: litter }));
                })
                .catch(() => {});
        });
    }, [expandedBreedingRecords, animal?.breedingRecords, authToken, API_BASE_URL]);

    // Get section privacy settings from animal data (default to true/public if not set)
    // Note: All sections now follow the main animal's public/private status
    // Individual section privacy has been removed for simplicity
    
    console.log('ViewOnlyAnimalDetail rendering', { 
        animalId: animal.id_public,
        animalName: animal.name,
        detailViewTab,
        hasRemarks: !!animal.remarks,
        hasGeneticCode: !!animal.geneticCode
    });
    
    // Set moderator context when viewing this animal
    useEffect(() => {
        if (setModCurrentContext && animal) {
            setModCurrentContext({
                type: 'animal',
                id: animal.id_public,
                name: animal.name,
                ownerId: animal.ownerId
            });
        }
        return () => {
            if (setModCurrentContext) {
                setModCurrentContext(null);
            }
        };
    }, [animal, setModCurrentContext]);
    
    // Helper function to parse health records from JSON strings
    const parseHealthRecords = (data) => {
        if (!data) return [];
        if (typeof data === 'string') {
            try {
                return JSON.parse(data);
            } catch (e) {
                console.error('Failed to parse health records:', e);
                return [];
            }
        }
        return Array.isArray(data) ? data : [];
    };
    const handleShare = () => {
        const url = `${window.location.origin}/animal/${animal.id_public}`;
        navigator.clipboard.writeText(url).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        });
    };
    
    // Fetch breeder info when component mounts or animal changes
    React.useEffect(() => {
        const fetchBreeder = async () => {
            if (animal?.breederId_public) {
                try {
                    const response = await axios.get(
                        `${API_BASE_URL}/public/profiles/search?query=${animal.breederId_public}&limit=1`
                    );
                    if (response.data && response.data.length > 0) {
                        setBreederInfo(response.data[0]);
                    }
                } catch (error) {
                    console.error('Failed to fetch breeder info:', error);
                    setBreederInfo(null);
                }
            } else {
                setBreederInfo(null);
            }
        };
        fetchBreeder();
    }, [animal?.breederId_public, API_BASE_URL]);
    
    // Fetch COI when component mounts or animal changes (if animal has both parents)
    React.useEffect(() => {
        const fetchCOI = async () => {
            const sireId = animal?.fatherId_public || animal?.sireId_public;
            const damId = animal?.motherId_public || animal?.damId_public;
            
            if (animal?.id_public && sireId && damId) {
                setLoadingCOI(true);
                try {
                    const response = await axios.get(
                        `${API_BASE_URL}/animals/${animal.id_public}/inbreeding`
                    );
                    if (response.data && response.data.inbreedingCoefficient != null) {
                        setAnimalCOI(response.data.inbreedingCoefficient);
                    }
                } catch (error) {
                    console.error('Failed to fetch COI:', error);
                    setAnimalCOI(null);
                } finally {
                    setLoadingCOI(false);
                }
            } else {
                setAnimalCOI(null);
            }
        };
        fetchCOI();
    }, [animal?.id_public, animal?.fatherId_public, animal?.sireId_public, animal?.motherId_public, animal?.damId_public, API_BASE_URL]);
    
    if (!animal) return null;

    // All sections are now publicly visible if the animal is public
    // Privacy is controlled at the animal level, not per-section
    
    console.log('ViewOnlyAnimalDetail rendering animal:', { 
        animalId: animal.id_public,
        animalName: animal.name,
        detailViewTab,
        hasRemarks: !!animal.remarks,
        hasGeneticCode: !!animal.geneticCode
    });

    return (
        <div className="fixed inset-0 bg-accent/10 flex items-center justify-center p-2 sm:p-4 z-50 overflow-y-auto">
            <div className="bg-primary rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto my-2 sm:my-0">
                {/* Header */}
                <div className="bg-white rounded-t-lg p-4 border-b border-gray-300">
                    <div className="flex justify-between items-center">
                        <button 
                            onClick={onClose} 
                            className="flex items-center text-gray-600 hover:text-gray-800 transition"
                        >
                            <ArrowLeft size={18} className="mr-1" /> Back
                        </button>
                        <div className="flex items-center gap-2">
                            <button
                                onClick={handleShare}
                                className="px-3 py-1.5 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-2"
                            >
                                <Link size={16} />
                                {copySuccess ? 'Link Copied!' : 'Share'}
                            </button>
                            <ReportButton
                                contentType="animal"
                                contentId={animal.id_public}
                                contentOwnerId={animal.ownerId}
                                authToken={authToken}
                                tooltipText="Report this animal"
                            />
                            <button onClick={onCloseAll || onClose} className="text-gray-500 hover:text-gray-800">
                                <X size={28} />
                            </button>
                        </div>
                    </div>
                </div>

                {/* Tabs - PUBLIC VIEW: 8 tabs (Records + End of Life combined) */}
                <div className="bg-white border-b border-gray-300">
                    <div className="flex flex-wrap">
                        {[
                            { id: 1, label: 'Overview', icon: '📋' },
                            { id: 3, label: 'Physical', icon: '🎨' },
                            { id: 4, label: 'Identification', icon: '🏷️' },
                            { id: 5, label: 'Lineage', icon: '🌳' },
                            { id: 6, label: 'Breeding', icon: '🥚' },
                            { id: 7, label: 'Health', icon: '🏥' },
                            { id: 8, label: 'Animal Care', icon: '🏠' },
                            { id: 9, label: 'Behavior', icon: '🧠' },
                            { id: 10, label: 'Records', icon: '📝' },
                            { id: 11, label: 'End of Life', icon: '⚖️' },
                            { id: 12, label: 'Show', icon: '🏆' },
                            { id: 13, label: 'Legal', icon: '📄' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setDetailViewTab(tab.id)}
                                className={`flex-1 basis-1/2 sm:basis-1/3 md:basis-1/4 lg:basis-1/5 px-3 py-3 text-sm font-medium whitespace-nowrap text-center transition ${
                                    detailViewTab === tab.id
                                        ? 'border-b-2 border-primary text-primary'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                <span className="mr-1">{tab.icon}</span>{tab.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Tab Content */}
                <div className="bg-white border border-t-0 border-gray-300 rounded-b-lg p-3 sm:p-6 overflow-y-auto max-h-[calc(95vh-160px)] sm:max-h-[calc(90vh-180px)] pb-8">
                    {/* Tab 1: Overview */}
                    {detailViewTab === 1 && (
                        <div className="space-y-4">
                            {/* Main Animal Card - 2 Column Layout */}
                            <div className="bg-white border-2 border-gray-300 rounded-lg overflow-hidden">
                                <div className="flex flex-col md:flex-row relative">
                                    {/* Left Column - Image (1/3 on desktop, full width on mobile) */}
                                    <div className="w-full md:w-1/3 p-4 sm:p-6 flex flex-col items-center justify-center relative min-h-60 md:min-h-80">
                                        {/* Birthdate badge */}
                                        {animal.birthDate && (
                                            <div className="absolute top-2 left-2 text-xs text-gray-600 bg-white/80 px-2 py-0.5 rounded">
                                                {formatDate(animal.birthDate)}
                                            </div>
                                        )}

                                        {/* Gender badge */}
                                        <div className="absolute top-2 right-2">
                                            {animal.gender === 'Male' ? <Mars size={20} strokeWidth={2.5} className="text-blue-600" /> : animal.gender === 'Female' ? <Venus size={20} strokeWidth={2.5} className="text-pink-600" /> : animal.gender === 'Intersex' ? <VenusAndMars size={20} strokeWidth={2.5} className="text-purple-500" /> : <Circle size={20} strokeWidth={2.5} className="text-gray-500" />}
                                        </div>

                                        {/* Profile Image */}
                                        <div className="flex items-center justify-center h-40 w-full">
                                            {(animal.imageUrl || animal.photoUrl) ? (
                                                <img 
                                                    src={animal.imageUrl || animal.photoUrl} 
                                                    alt={animal.name} 
                                                    className="max-w-32 max-h-32 w-auto h-auto object-contain rounded-md cursor-pointer hover:opacity-80 transition"
                                                    onClick={() => {
                                                        if (setEnlargedImageUrl && setShowImageModal) {
                                                            setEnlargedImageUrl(animal.imageUrl || animal.photoUrl);
                                                            setShowImageModal(true);
                                                        }
                                                    }}
                                                />
                                            ) : (
                                                <div className="w-32 h-32 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                    <Cat size={48} />
                                                </div>
                                            )}
                                        </div>

                                        {/* Status text */}
                                        <div className="text-sm font-medium text-gray-700 mt-2">
                                            {animal.status || 'Unknown'}
                                        </div>
                                    </div>

                                    {/* Right Column - Info (2/3 on desktop, full width on mobile) */}
                                    <div className="w-full md:w-2/3 p-4 sm:p-6 flex flex-col border-t md:border-t-0 md:border-l border-gray-300 space-y-3">
                                        {/* Species/Breed/Strain/CTC - At Top */}
                                        <p className="text-sm text-gray-600">
                                            {animal.species}
                                            {animal.breed && ` � ${animal.breed}`}
                                            {animal.strain && ` � ${animal.strain}`}
                                            {animal.id_public && ` � ${animal.id_public}`}
                                        </p>

                                        {/* Full Name */}
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            {animal.prefix ? `${animal.prefix} ` : ''}
                                            {animal.name}
                                            {animal.suffix ? ` ${animal.suffix}` : ''}
                                        </h2>

                                        {/* For Sale Badge */}
                                        {animal.isForSale && (animal.salePriceCurrency || animal.salePriceAmount) && (
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                                                <span className="text-lg">🏷️</span>
                                                <div>
                                                    <p className="text-sm font-semibold text-gray-700">For Sale</p>
                                                    <p className="text-sm text-gray-600">
                                                        {animal.salePriceCurrency === 'Negotiable' ? 'Negotiable' : `${getCurrencySymbol(animal.salePriceCurrency)}${animal.salePriceAmount ? ` ${animal.salePriceAmount}` : ''}`}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* For Stud Badge */}
                                        {animal.availableForBreeding && (animal.studFeeCurrency || animal.studFeeAmount) && (
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-2">
                                                <span className="text-lg">🏷️</span>
                                                <div>
                                                    <p className="text-sm font-semibold text-gray-700">Available for Stud</p>
                                                    <p className="text-sm text-gray-600">
                                                        {animal.studFeeCurrency === 'Negotiable' ? 'Negotiable' : `${getCurrencySymbol(animal.studFeeCurrency)}${animal.studFeeAmount ? ` ${animal.studFeeAmount}` : ''}`}
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* Variety */}
                        {(animal.color || animal.coat || animal.coatPattern || animal.earset) && (
                            <p className="text-sm text-gray-700">
                                <span className="font-semibold">Variety:</span> {[
                                    animal.color,
                                    animal.coatPattern,
                                    animal.coat,
                                                animal.earset,
                                                animal.phenotype,
                                                animal.morph,
                                                animal.markings,
                                                animal.eyeColor,
                                                animal.nailColor,
                                                animal.carrierTraits,
                                                animal.size
                                            ].filter(Boolean).join(' ')}
                            </p>
                        )}

                                        {/* Date of Birth and Age/Deceased */}
                                        {animal.birthDate && (
                                            <div className="text-sm text-gray-700 space-y-1">
                                                <p>
                                                    <span className="font-semibold">Date of Birth:</span> {formatDate(animal.birthDate)} (~{(() => {
                                                        const birth = new Date(animal.birthDate);
                                                        const endDate = animal.deceasedDate ? new Date(animal.deceasedDate) : new Date();
                                                        let years = endDate.getFullYear() - birth.getFullYear();
                                                        let months = endDate.getMonth() - birth.getMonth();
                                                        let days = endDate.getDate() - birth.getDate();
                                                        
                                                        if (days < 0) {
                                                            months--;
                                                            const prevMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                                                            days += prevMonth.getDate();
                                                        }
                                                        if (months < 0) {
                                                            years--;
                                                            months += 12;
                                                        }
                                                        
                                                        if (years > 0) {
                                                            return `${years}y ${months}m ${days}d`;
                                                        } else if (months > 0) {
                                                            return `${months}m ${days}d`;
                                                        } else {
                                                            return `${days}d`;
                                                        }
                                                    })()})
                                                </p>
                                                {animal.deceasedDate && (
                                                    <p className="text-red-600 font-semibold">
                                                        Deceased: {formatDate(animal.deceasedDate)}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Breeder Section */}
                            {animal.breederId_public && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">⭐ Breeder</h3>
                                    <p className="text-gray-700 flex items-center gap-2">
                                        {breederInfo ? (
                                            <>
                                                <button
                                                    onClick={() => onViewProfile && onViewProfile(breederInfo)}
                                                    className="text-primary hover:underline font-medium"
                                                >
                                                    {(() => {
                                                        const showPersonal = breederInfo.showPersonalName ?? false;
                                                        const showBreeder = breederInfo.showBreederName ?? false;
                                                        if (showPersonal && showBreeder && breederInfo.personalName && breederInfo.breederName) {
                                                            return `${breederInfo.personalName} (${breederInfo.breederName})`;
                                                        } else if (showBreeder && breederInfo.breederName) {
                                                            return breederInfo.breederName;
                                                        } else if (showPersonal && breederInfo.personalName) {
                                                            return breederInfo.personalName;
                                                        } else {
                                                            return 'Unknown Breeder';
                                                        }
                                                    })()}
                                                </button>
                                                <DonationBadge badge={getDonationBadge(breederInfo)} size="xs" />
                                            </>
                                        ) : (
                                            <span className="font-mono text-accent">{animal.breederId_public}</span>
                                        )}
                                    </p>
                                </div>
                            )}

                            {/* Current Owner Section */}
                            {(animal.keeperName) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🏠 Keeper</h3>
                                    <p className="text-gray-700">{animal.keeperName}</p>
                                    {animal.coOwnership && (
                                        <p className="text-gray-700 mt-2"><span className="text-gray-600">Co-Ownership:</span> {animal.coOwnership}</p>
                                    )}
                                </div>
                            )}

                            {/* Identification Numbers Section */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🔢 Identification Numbers</h3>
                                <div className="space-y-2 text-sm">
                                    <p><span className="text-gray-600">CritterTrack ID:</span> <strong>{animal.id_public || ''}</strong></p>
                                    {animal.breederAssignedId && <p><span className="text-gray-600">Identification:</span> <strong>{animal.breederAssignedId}</strong></p>}
                                    {animal.microchipNumber && <p><span className="text-gray-600">Microchip:</span> <strong>{animal.microchipNumber}</strong></p>}
                                    {animal.pedigreeRegistrationId && <p><span className="text-gray-600">Pedigree Reg ID:</span> <strong>{animal.pedigreeRegistrationId}</strong></p>}
                                </div>
                            </div>
                            {/* Genetic Code Display Section */}
                            {animal.geneticCode && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🧬 Genetic Code</h3>
                                    <p className="text-gray-700 font-mono text-sm break-all">{animal.geneticCode || ''}</p>
                                </div>
                            )}
                            {/* Medical Information Section */}
                            {(animal.allergies || animal.medications || animal.medicalConditions) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">Medical Information</h3>
                                    <div className="space-y-3">
                                        {animal.allergies && (() => {
                                            const parsed = parseHealthRecords(animal.allergies);
                                            return parsed && parsed.length > 0 ? (
                                                <div>
                                                    <strong className="text-sm">Allergies:</strong>
                                                    <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                        {parsed.map((allergy, idx) => (
                                                            <li key={idx} className="text-gray-700">
                                                                {allergy.allergen || allergy.name}
                                                                {allergy.notes && <span className="text-gray-600"> - {allergy.notes}</span>}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ) : null;
                                        })()}
                                        {animal.medications && (() => {
                                            const parsed = parseHealthRecords(animal.medications);
                                            return parsed && parsed.length > 0 ? (
                                                <div>
                                                    <strong className="text-sm">Medications:</strong>
                                                    <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                        {parsed.map((med, idx) => (
                                                            <li key={idx} className="text-gray-700">
                                                                {med.medication || med.name}
                                                                {med.notes && <span className="text-gray-600"> - {med.notes}</span>}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ) : null;
                                        })()}
                                        {animal.medicalConditions && (() => {
                                            const parsed = parseHealthRecords(animal.medicalConditions);
                                            return parsed && parsed.length > 0 ? (
                                                <div>
                                                    <strong className="text-sm">Medical Conditions:</strong>
                                                    <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                        {parsed.map((condition, idx) => (
                                                            <li key={idx} className="text-gray-700">
                                                                {condition.condition || condition.name}
                                                                {condition.notes && <span className="text-gray-600"> - {condition.notes}</span>}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ) : null;
                                        })()}
                                    </div>
                                </div>
                            )}

                            {/* Parents Section */}
                            {(animal.fatherId_public || animal.sireId_public || animal.motherId_public || animal.damId_public) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <div className="flex items-center justify-between border-b pb-2 mb-4">
                                        <h3 className="text-lg font-semibold text-gray-700">🌳 Parents</h3>
                                        {animalCOI != null && (
                                            <div className="text-sm text-gray-800">
                                                <span className="font-medium">COI:</span> {animalCOI.toFixed(2)}%
                                            </div>
                                        )}
                                        {loadingCOI && (
                                            <div className="text-xs text-gray-400">Calculating...</div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <ViewOnlyParentCard 
                                            parentId={animal.fatherId_public || animal.sireId_public} 
                                            parentType="Sire"
                                            API_BASE_URL={API_BASE_URL}
                                            onViewAnimal={onViewAnimal}
                                            authToken={authToken}
                                        />
                                        <ViewOnlyParentCard 
                                            parentId={animal.motherId_public || animal.damId_public} 
                                            parentType="Dam"
                                            API_BASE_URL={API_BASE_URL}
                                            onViewAnimal={onViewAnimal}
                                            authToken={authToken}
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 3: Physical */}
                    {detailViewTab === 3 && (
                        <div className="space-y-6">
                            {/* Appearance */}
                            {(() => {
                                const fields = [
                                    { key: 'color', label: 'Color' },
                                    { key: 'coatPattern', label: 'Pattern' },
                                    { key: 'coat', label: 'Coat Type' },
                                    { key: 'earset', label: 'Earset' },
                                    { key: 'phenotype', label: 'Phenotype' },
                                    { key: 'morph', label: 'Morph' },
                                    { key: 'markings', label: 'Markings' },
                                    { key: 'eyeColor', label: 'Eye Color' },
                                    { key: 'nailColor', label: 'Nail/Claw Color' },
                                    { key: 'size', label: 'Size' },
                                    { key: 'carrierTraits', label: 'Carrier Traits' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return fields.length > 0 && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">✨ Appearance</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            {fields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Genetic Code */}
                            {fieldTemplate?.fields?.geneticCode?.enabled !== false && animal.geneticCode && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">{getLabel('geneticCode', 'Genetic Code')}</h3>
                                    <p className="text-gray-700 font-mono text-sm break-all">{animal.geneticCode}</p>
                                </div>
                            )}

                            {/* Life Stage */}
                            {fieldTemplate?.fields?.lifeStage?.enabled !== false && animal.lifeStage && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">{getLabel('lifeStage', 'Life Stage')}</h3>
                                    <p className="text-gray-700 text-sm">{animal.lifeStage}</p>
                                </div>
                            )}

                            {/* Measurements */}
                            {(() => {
                                const mFields = [
                                    { key: 'bodyWeight', label: 'Weight' },
                                    { key: 'bodyLength', label: 'Body Length' },
                                    { key: 'heightAtWithers', label: 'Height at Withers' },
                                    { key: 'chestGirth', label: 'Chest Girth' },
                                    { key: 'adultWeight', label: 'Adult Weight' },
                                    { key: 'bodyConditionScore', label: 'Body Condition Score' },
                                    { key: 'length', label: 'Length' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return mFields.length > 0 && (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">📏 Measurements</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            {mFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {/* Tab 4: Identification */}
                    {detailViewTab === 4 && (
                        <div className="space-y-6">
                            {/* Identification Numbers */}
                            {(() => {
                                const idFields = [
                                    { key: 'breederAssignedId', label: 'Identification' },
                                    { key: 'microchipNumber', label: 'Microchip Number' },
                                    { key: 'pedigreeRegistrationId', label: 'Pedigree Registration ID' },
                                    { key: 'colonyId', label: 'Colony ID' },
                                    { key: 'rabiesTagNumber', label: 'Rabies Tag Number' },
                                    { key: 'tattooId', label: 'Tattoo ID' },
                                    { key: 'akcRegistrationNumber', label: 'AKC Registration #' },
                                    { key: 'fciRegistrationNumber', label: 'FCI Registration #' },
                                    { key: 'cfaRegistrationNumber', label: 'CFA Registration #' },
                                    { key: 'workingRegistryIds', label: 'Working Registry IDs' },
                                ].filter(f => fieldTemplate?.fields?.[f.key]?.enabled !== false && animal[f.key]);
                                return (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                        <h3 className="text-lg font-semibold text-gray-700">🔢 Identification Numbers</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div><span className="text-gray-600">CritterTrack ID:</span> <strong>{animal.id_public || ''}</strong></div>
                                            {idFields.map(f => (
                                                <div key={f.key}><span className="text-gray-600">{getLabel(f.key, f.label)}:</span> <strong>{animal[f.key]}</strong></div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Classification */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🗂️ Classification</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Species:</span> <strong>{animal.species || ''}</strong></div>
                                    {fieldTemplate?.fields?.breed?.enabled !== false && animal.breed && (
                                        <div><span className="text-gray-600">{getLabel('breed', 'Breed')}:</span> <strong>{animal.breed}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.strain?.enabled !== false && animal.strain && (
                                        <div><span className="text-gray-600">{getLabel('strain', 'Strain')}:</span> <strong>{animal.strain}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* Tags */}
                            {animal.tags && animal.tags.length > 0 && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🏷️ Tags</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {animal.tags.map((tag, idx) => (
                                            <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">{tag}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 5: Lineage */}
                    {detailViewTab === 5 && (
                        <div className="space-y-6">
                            {/* 1st Section: Pedigree */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-semibold text-gray-700">🌳 Pedigree</h3>
                                    <button
                                        onClick={() => setShowPedigree(true)}
                                        data-tutorial-target="pedigree-btn"
                                        className="px-3 py-1 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition text-sm"
                                    >
                                        View Pedigree Chart
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <ViewOnlyParentCard 
                                        parentId={animal.fatherId_public || animal.sireId_public} 
                                        parentType="Sire"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                    <ViewOnlyParentCard 
                                        parentId={animal.motherId_public || animal.damId_public} 
                                        parentType="Dam"
                                        API_BASE_URL={API_BASE_URL}
                                        onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                                </div>
                            </div>

                            {/* 2nd Section: Origin */}
                            {animal.origin && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌍 Origin</h3>
                                <p className="text-gray-700">{animal.origin || ''}</p>
                            </div>
                            )}

                            {/* 3rd Section: Breeding Records - Accordion View */}
                            {animal.breedingRecords && animal.breedingRecords.length > 0 && (
                                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200 space-y-3">
                                    <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-purple-600 mr-2">📊</span>Breeding Records</h3>
                                    <div className="space-y-2">
                                        {animal.breedingRecords.map((record, idx) => {
                                            const isExpanded = expandedBreedingRecords[idx];
                                            const countSummary = [
                                                record.litterSizeBorn !== null && `${record.litterSizeBorn} born`,
                                                record.stillbornCount && `${record.stillbornCount} stillborn`,
                                                record.litterSizeWeaned !== null && `${record.litterSizeWeaned} weaned`
                                            ].filter(Boolean).join(' � ') || 'No counts';
                                            return (
                                                <div key={idx} className={`bg-white rounded border transition-all ${isExpanded ? 'border-purple-300 shadow-md' : 'border-purple-100'}`}>
                                                    <div 
                                                        onClick={() => setExpandedBreedingRecords({...expandedBreedingRecords, [idx]: !isExpanded})}
                                                        className="p-3 flex items-center justify-between cursor-pointer hover:bg-purple-50 transition rounded"
                                                    >
                                                        <div className="flex items-center gap-3 flex-1">
                                                            <span className={`text-lg transition-transform ${isExpanded ? 'rotate-90' : ''}`}>▶️</span>
                                                            {record.litterName ? (
                                                                <>
                                                                    <span className="px-2 py-0.5 rounded text-xs font-bold bg-purple-700 text-white flex-shrink-0">{record.litterName}</span>
                                                                    {record.litterId && <span className="text-xs font-mono text-gray-400 flex-shrink-0">{record.litterId}</span>}
                                                                </>
                                                            ) : record.litterId ? (
                                                                <span className="font-mono px-2 py-0.5 rounded text-xs font-semibold flex-shrink-0 bg-purple-300 text-purple-800">{record.litterId}</span>
                                                            ) : null}
                                                            <div className="text-sm text-gray-700 flex items-center gap-2 flex-wrap">
                                                                {record.birthEventDate && <><span>{formatDate(record.birthEventDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                {!record.birthEventDate && formatDate(record.matingDate) && <><span>{formatDate(record.matingDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                {record.mate && <><span>{record.mate}</span><span className="text-gray-400">&bull;</span></>}
                                                                <span className="text-purple-700 font-medium">{countSummary}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {isExpanded && (
                                                        <div className="border-t border-purple-100 p-4 bg-purple-50 space-y-4">
                                                            {/* CTL ID + Litter Name */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                <div><div className="text-gray-600 text-xs">CTL ID</div><div className="font-mono text-xs font-semibold text-gray-700">{record.litterId || 'Not Linked'}</div></div>
                                                                {record.litterName && <div><div className="text-gray-600 text-xs">Litter Name</div><div className="font-semibold text-purple-800">{record.litterName}</div></div>}
                                                            </div>
                                                            {/* Mate, Dates, Method, Condition, Outcome */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                {record.mate && (<div><div className="text-gray-600 text-xs">Mate / Other Parent</div><div className="font-semibold text-gray-800">{record.mate}</div></div>)}
                                                                <div><div className="text-gray-600 text-xs">Mating Date</div><div className="font-semibold text-gray-800">{formatDate(record.matingDate) || '�'}</div></div>
                                                                {record.breedingMethod && (<div><div className="text-gray-600 text-xs">Breeding Method</div><div className="font-semibold text-gray-800">{record.breedingMethod}</div></div>)}
                                                                {record.breedingConditionAtTime && (<div><div className="text-gray-600 text-xs">Breeding Condition</div><div className="font-semibold text-gray-800">{record.breedingConditionAtTime}</div></div>)}
                                                                {record.outcome && (<div><div className="text-gray-600 text-xs">Outcome</div><div className={`font-semibold ${record.outcome === 'Successful' ? 'text-green-600' : record.outcome === 'Unsuccessful' ? 'text-red-600' : 'text-gray-600'}`}>{record.outcome}</div></div>)}
                                                                {record.birthEventDate && (<div><div className="text-gray-600 text-xs">Birth Date</div><div className="font-semibold text-gray-800">{formatDate(record.birthEventDate) || '�'}</div></div>)}
                                                                {record.birthMethod && (<div><div className="text-gray-600 text-xs">Birth Method</div><div className="font-semibold text-gray-800">{record.birthMethod}</div></div>)}
                                                            </div>
                                                            {/* Notes */}
                                                            {record.notes && (<div className="bg-white p-3 rounded border border-purple-100"><div className="text-sm font-semibold text-gray-700 mb-2">Notes</div><div className="text-sm text-gray-700 italic">{record.notes}</div></div>)}
                                                            {/* Offspring Counts */}
                                                            <div className="bg-white p-3 rounded border border-purple-100">
                                                                <div className="text-sm font-semibold text-gray-700 mb-3">Offspring Counts</div>
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                                    <div><div className="text-gray-600 text-xs">Total Born</div><div className="text-2xl font-bold text-purple-600">{record.litterSizeBorn !== null ? record.litterSizeBorn : '�'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Stillborn</div><div className="text-2xl font-bold text-gray-600">{record.stillbornCount || '0'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Weaned</div><div className="text-2xl font-bold text-green-600">{record.litterSizeWeaned !== null ? record.litterSizeWeaned : '�'}</div></div>
                                                                    {breedingRecordLitters?.[record.litterId]?.maleCount != null && <div><div className="text-gray-600 text-xs">Males</div><div className="text-2xl font-bold text-blue-500">{breedingRecordLitters[record.litterId].maleCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.femaleCount != null && <div><div className="text-gray-600 text-xs">Females</div><div className="text-2xl font-bold text-pink-500">{breedingRecordLitters[record.litterId].femaleCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.unknownCount != null && breedingRecordLitters[record.litterId].unknownCount > 0 && <div><div className="text-gray-600 text-xs">Unknown / Intersex</div><div className="text-2xl font-bold text-gray-600">{breedingRecordLitters[record.litterId].unknownCount}</div></div>}
                                                                    {breedingRecordLitters?.[record.litterId]?.inbreedingCoefficient != null && <div><div className="text-gray-600 text-xs">COI</div><div className="text-xl font-bold text-orange-600">{breedingRecordLitters[record.litterId].inbreedingCoefficient.toFixed(2)}%</div></div>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* 4th Section: Offspring */}
                            <OffspringSection
                                animalId={animal.id_public}
                                API_BASE_URL={API_BASE_URL}
                                authToken={authToken}
                                onViewAnimal={onViewAnimal}
                            />
                        </div>
                    )}                    {/* Tab 6: Breeding */}
                    {detailViewTab === 6 && (
                        <div className="space-y-6">
                            {/* 1st Section: Reproductive Status */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌿 Reproductive Status</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Neutered/Spayed:</span> <strong>{animal.isNeutered ? 'Yes' : 'No'}</strong></div>
                                    <div><span className="text-gray-600">Infertile:</span> <strong>{animal.isInfertile ? 'Yes' : 'No'}</strong></div>
                                    {!animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">In Mating:</span> <strong>{animal.isInMating ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && !animal.isNeutered && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('isPregnant', 'Pregnant')}:</span> <strong>{animal.isPregnant ? 'Yes' : 'No'}</strong></div>
                                            <div><span className="text-gray-600">{getLabel('isNursing', 'Nursing')}:</span> <strong>{animal.isNursing ? 'Yes' : 'No'}</strong></div>
                                        </>
                                    )}
                                    {animal.gender === 'Male' && !animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">Stud Animal:</span> <strong>{animal.isStudAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {animal.gender === 'Female' && !animal.isNeutered && !animal.isInfertile && (
                                        <div><span className="text-gray-600">Breeding Dam:</span> <strong>{animal.isDamAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* 2nd Section: Estrus/Cycle (Female/Intersex/Unknown only) */}
                            {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && !animal.isNeutered && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🔄 Estrus/Cycle</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Heat Status:</span> <strong>{animal.heatStatus || ''}</strong></div>
                                        <div><span className="text-gray-600">Last Heat Date:</span> <strong>{animal.lastHeatDate ? formatDate(animal.lastHeatDate) : ''}</strong></div>
                                        <div><span className="text-gray-600">{getLabel('ovulationDate', 'Ovulation Date')}:</span> <strong>{animal.ovulationDate ? formatDate(animal.ovulationDate) : ''}</strong></div>
                                        {animal.estrusCycleLength && (
                                            <div><span className="text-gray-600">Estrus Cycle Length:</span> <strong>{`${animal.estrusCycleLength} days`}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* 4th Section: Stud Information */}
                            {!animal.isNeutered && !animal.isInfertile && (animal.gender === 'Male' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♂️ Sire Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Fertility Status:</span> <strong>{animal.fertilityStatus || ''}</strong></div>
                                    </div>
                                    {animal.fertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animal.fertilityNotes}</strong></div>
                                    )}
                                    {animal.reproductiveClearances && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveClearances}</strong></div>
                                    )}
                                    {animal.reproductiveComplications && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveComplications}</strong></div>
                                    )}
                                </div>
                            )}

                            {/* 5th Section: Dam Information */}
                            {!animal.isNeutered && !animal.isInfertile && (animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♀️ Dam Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">{getLabel('damFertilityStatus', 'Dam Fertility Status')}:</span> <strong>{animal.damFertilityStatus || animal.fertilityStatus || ''}</strong></div>
                                        {animal.gestationLength && (
                                            <div><span className="text-gray-600">{getLabel('gestationLength', 'Gestation Length')}:</span> <strong>{`${animal.gestationLength} days`}</strong></div>
                                        )}
                                        {animal.deliveryMethod && (
                                            <div><span className="text-gray-600">{getLabel('deliveryMethod', 'Delivery Method')}:</span> <strong>{animal.deliveryMethod}</strong></div>
                                        )}
                                        {animal.whelpingDate && (
                                            <div><span className="text-gray-600">{getLabel('whelpingDate', 'Whelping Date')}:</span> <strong>{formatDate(animal.whelpingDate)}</strong></div>
                                        )}
                                        {animal.queeningDate && (
                                            <div><span className="text-gray-600">{getLabel('queeningDate', 'Queening Date')}:</span> <strong>{formatDate(animal.queeningDate)}</strong></div>
                                        )}
                                    </div>
                                    {animal.damFertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animal.damFertilityNotes}</strong></div>
                                    )}
                                    {animal.reproductiveClearances && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveClearances}</strong></div>
                                    )}
                                    {animal.reproductiveComplications && (
                                        <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animal.reproductiveComplications}</strong></div>
                                    )}
                                </div>
                            )}

                            {/* 6th Section: Breeding History */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-blue-600 mr-2">📊</span>Breeding History</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {(animal.gender === 'Male' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('lastMatingDate', 'Last Mating Date')}:</span> <strong>{animal.lastMatingDate ? formatDate(animal.lastMatingDate) : ''}</strong></div>
                                            </>
                                    )}
                                    {(animal.gender === 'Female' || animal.gender === 'Intersex' || animal.gender === 'Unknown') && (
                                        <>
                                            <div><span className="text-gray-600">{getLabel('lastPregnancyDate', 'Last Pregnancy Date')}:</span> <strong>{animal.lastPregnancyDate ? formatDate(animal.lastPregnancyDate) : ''}</strong></div>
                                            <div><span className="text-gray-600">{getLabel('litterCount', 'Litter Count')}:</span> <strong>{animal.litterCount || ''}</strong></div>
                                        </>
                                    )}
                                    <div><span className="text-gray-600">Total Offspring:</span> <strong>{animal.offspringCount || ''}</strong></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 7: Health */}
                    {detailViewTab === 7 && (
                        <div className="space-y-6">
                            {/* 1st Section: Preventive Care */}
                            {/* 1st Section: Preventive Care */}
                            {(animal.vaccinations || animal.dewormingRecords || animal.parasiteControl) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🛡️ Preventive Care</h3>
                                    {animal.vaccinations && (
                                        <div>
                                            <strong className="text-sm">{getLabel('vaccinations', 'Vaccinations')}:</strong>
                                            <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                {(() => {
                                                    const data = animal.vaccinations;
                                                    const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                    return parsed.map((vacc, idx) => (
                                                        <li key={idx} className="text-gray-700">
                                                            {vacc.name} {vacc.date && `(${formatDate(vacc.date)})`}
                                                            {vacc.notes && <span className="text-gray-600"> - {vacc.notes}</span>}
                                                        </li>
                                                    ));
                                                })()}
                                            </ul>
                                        </div>
                                    )}
                                    {animal.dewormingRecords && (
                                        <div>
                                            <strong className="text-sm">Deworming Records:</strong>
                                            <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                {(() => {
                                                    const data = animal.dewormingRecords;
                                                    const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                    return parsed.map((record, idx) => (
                                                        <li key={idx} className="text-gray-700">
                                                            {record.medication} {record.date && `(${formatDate(record.date)})`}
                                                            {record.notes && <span className="text-gray-600"> - {record.notes}</span>}
                                                        </li>
                                                    ));
                                                })()}
                                            </ul>
                                        </div>
                                    )}
                                    {animal.parasiteControl && (
                                        <div>
                                            <strong className="text-sm">Parasite Control:</strong>
                                            <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                {(() => {
                                                    const data = animal.parasiteControl;
                                                    const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                    return parsed.map((record, idx) => (
                                                        <li key={idx} className="text-gray-700">
                                                            {record.treatment} {record.date && `(${formatDate(record.date)})`}
                                                            {record.notes && <span className="text-gray-600"> - {record.notes}</span>}
                                                        </li>
                                                    ));
                                                })()}
                                            </ul>
                                        </div>
                                    )}
                                {!animal.vaccinations && !animal.dewormingRecords && !animal.parasiteControl && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}

                            {/* 2nd Section: Procedures & Diagnostics */}
                            {(animal.medicalProcedures || animal.laboratoryResults) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🔬 Procedures & Diagnostics</h3>
                                {animal.medicalProcedures && (
                                    <div>
                                        <strong className="text-sm">Medical Procedures:</strong>
                                        <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                            {(() => {
                                                const data = animal.medicalProcedures;
                                                const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                return parsed.map((proc, idx) => (
                                                    <li key={idx} className="text-gray-700">
                                                        {proc.name} {proc.date && `(${formatDate(proc.date)})`}
                                                        {proc.notes && <span className="text-gray-600"> - {proc.notes}</span>}
                                                    </li>
                                                ));
                                            })()}
                                        </ul>
                                    </div>
                                )}
                                {animal.laboratoryResults && <div><strong className="text-sm">Laboratory Results:</strong> <p className="text-sm mt-1">{animal.laboratoryResults}</p></div>}
                                {!animal.medicalProcedures && !animal.laboratoryResults && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}

                            {/* 3rd Section: Active Medical Records */}
                            {(animal.medicalConditions || animal.allergies || animal.medications) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🩹💊 Active Medical Records</h3>
                                    {animal.medicalConditions && (() => {
                                        const parsed = parseHealthRecords(animal.medicalConditions);
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <strong className="text-sm">Medical Conditions:</strong>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((condition, idx) => (
                                                        <li key={idx} className="text-gray-700">
                                                            {condition.condition || condition.name}
                                                            {condition.notes && <span className="text-gray-600"> - {condition.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : null;
                                    })()}
                                    {animal.allergies && (() => {
                                        const parsed = parseHealthRecords(animal.allergies);
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <strong className="text-sm">Allergies:</strong>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((allergy, idx) => (
                                                        <li key={idx} className="text-gray-700">
                                                            {allergy.allergen || allergy.name}
                                                            {allergy.notes && <span className="text-gray-600"> - {allergy.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : null;
                                    })()}
                                    {animal.medications && (() => {
                                        const parsed = parseHealthRecords(animal.medications);
                                        return parsed && parsed.length > 0 ? (
                                            <div>
                                                <strong className="text-sm">Current Medications:</strong>
                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                    {parsed.map((med, idx) => (
                                                        <li key={idx} className="text-gray-700">
                                                            {med.medication || med.name}
                                                            {med.notes && <span className="text-gray-600"> - {med.notes}</span>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ) : null;
                                    })()}
                                    {!animal.medicalConditions && !animal.allergies && !animal.medications && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}

                            {/* 4th Section: Veterinary Care */}
                            {(animal.primaryVet || animal.vetVisits) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🩺 Veterinary Care</h3>
                                {animal.primaryVet && <div><strong className="text-sm">Primary Veterinarian:</strong> <p className="text-sm mt-1">{animal.primaryVet}</p></div>}
                                {animal.vetVisits && (
                                    <div>
                                        <strong className="text-sm">Veterinary Visits:</strong>
                                        <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                            {(() => {
                                                const data = animal.vetVisits;
                                                const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                return parsed.map((visit, idx) => (
                                                    <li key={idx} className="text-gray-700">
                                                        {visit.reason} {visit.date && `(${formatDate(visit.date)})`}
                                                        {visit.notes && <span className="text-gray-600"> - {visit.notes}</span>}
                                                    </li>
                                                ));
                                            })()}
                                        </ul>
                                    </div>
                                )}
                                {!animal.primaryVet && !animal.vetVisits && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}
                        </div>
                    )}

                    {/* Tab 8: Husbandry */}
                    {detailViewTab === 8 && (
                        <div className="space-y-6">
                            {/* 1st Section: Nutrition */}
                            {(animal.dietType || animal.feedingSchedule || animal.supplements) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🍽️ Nutrition</h3>
                                {animal.dietType && <div><strong className="text-sm">Diet Type:</strong> <p className="text-sm mt-1">{animal.dietType}</p></div>}
                                {animal.feedingSchedule && <div><strong className="text-sm">Feeding Schedule:</strong> <p className="text-sm mt-1">{animal.feedingSchedule}</p></div>}
                                {animal.supplements && <div><strong className="text-sm">Supplements:</strong> <p className="text-sm mt-1">{animal.supplements}</p></div>}
                                {!animal.dietType && !animal.feedingSchedule && !animal.supplements && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}

                            {/* 2nd Section: Housing & Enclosure */}
                            {(animal.housingType || animal.bedding || animal.enrichment || (animal.careTasks && animal.careTasks.length > 0)) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🏡 Housing & Enclosure</h3>
                                {animal.housingType && <div><strong className="text-sm">{getLabel('housingType', 'Housing Type')}:</strong> <p className="text-sm mt-1">{animal.housingType}</p></div>}
                                {animal.bedding && <div><strong className="text-sm">{getLabel('bedding', 'Bedding')}:</strong> <p className="text-sm mt-1">{animal.bedding}</p></div>}
                                {animal.enrichment && <div><strong className="text-sm">Enrichment:</strong> <p className="text-sm mt-1">{animal.enrichment}</p></div>}
                                {!animal.housingType && !animal.bedding && !animal.enrichment && <p className="text-sm text-gray-600"></p>}
                                {animal.careTasks && animal.careTasks.length > 0 && (
                                    <div className="mt-4 pt-3 border-t border-gray-300">
                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">Enclosure Care Tasks</h4>
                                        <div className="space-y-1">
                                            {animal.careTasks.map((task, idx) => (
                                                <div key={idx} className="flex items-center justify-between text-xs bg-white px-2 py-1.5 rounded border border-gray-200">
                                                    <span className="font-medium text-gray-700">{task.taskName}</span>
                                                    <div className="flex items-center gap-2 text-gray-500">
                                                        {task.frequencyDays && <span>Every {task.frequencyDays}d</span>}
                                                        {task.lastDoneDate && <span>Last: {formatDateShort(task.lastDoneDate)}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            )}

                            {/* 3rd Section: Animal Care */}
                            {(animal.animalCareTasks && animal.animalCareTasks.length > 0) || animal.handlingNotes || animal.socializationNotes || animal.specialCareRequirements ? (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🧴 Animal Care</h3>
                                {animal.animalCareTasks && animal.animalCareTasks.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">Animal Care Tasks</h4>
                                        <div className="space-y-1">
                                            {animal.animalCareTasks.map((task, idx) => (
                                                <div key={idx} className="flex items-center justify-between text-xs bg-white px-2 py-1.5 rounded border border-gray-200">
                                                    <span className="font-medium text-gray-700">{task.taskName}</span>
                                                    <div className="flex items-center gap-2 text-gray-500">
                                                        {task.frequencyDays && <span>Every {task.frequencyDays}d</span>}
                                                        {task.lastDoneDate && <span>Last: {formatDateShort(task.lastDoneDate)}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="space-y-3 text-sm">
                                    {animal.handlingNotes && <div><strong className="text-sm">Handling Notes:</strong> <strong className="text-sm whitespace-pre-wrap">{animal.handlingNotes}</strong></div>}
                                    {animal.socializationNotes && <div><strong className="text-sm">Socialization Notes:</strong> <strong className="text-sm whitespace-pre-wrap">{animal.socializationNotes}</strong></div>}
                                    {animal.specialCareRequirements && <div><strong className="text-sm">Special Care Requirements:</strong> <strong className="text-sm whitespace-pre-wrap">{animal.specialCareRequirements}</strong></div>}
                                </div>
                            </div>
                            ) : null}

                            {/* 4th Section: Environment */}
                            {(animal.temperatureRange || animal.humidity || animal.lighting || animal.noise) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌡️ Environment</h3>
                                {animal.temperatureRange && <div><strong className="text-sm">Temperature Range:</strong> <p className="text-sm mt-1">{animal.temperatureRange}</p></div>}
                                {animal.humidity && <div><strong className="text-sm">{getLabel('humidity', 'Humidity')}:</strong> <p className="text-sm mt-1">{animal.humidity}</p></div>}
                                {animal.lighting && <div><strong className="text-sm">Lighting:</strong> <p className="text-sm mt-1">{animal.lighting}</p></div>}
                                {animal.noise && <div><strong className="text-sm">{getLabel('noise', 'Noise Level')}:</strong> <p className="text-sm mt-1">{animal.noise}</p></div>}
                                {!animal.temperatureRange && !animal.humidity && !animal.lighting && !animal.noise && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}
                        </div>
                    )}

                    {/* Tab 9: Behavior */}
                    {detailViewTab === 9 && (
                        <div className="space-y-6">
                            {/* 1st Section: Behavior */}
                            {(animal.temperament || animal.handlingTolerance || animal.socialStructure) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">💭 Behavior</h3>
                                {animal.temperament && <div><strong className="text-sm">Temperament:</strong> <p className="text-sm mt-1">{animal.temperament}</p></div>}
                                {animal.handlingTolerance && <div><strong className="text-sm">{getLabel('handlingTolerance', 'Handling Tolerance')}:</strong> <p className="text-sm mt-1">{animal.handlingTolerance}</p></div>}
                                {animal.socialStructure && <div><strong className="text-sm">Social Structure:</strong> <p className="text-sm mt-1">{animal.socialStructure}</p></div>}
                                {!animal.temperament && !animal.handlingTolerance && !animal.socialStructure && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}

                            {/* 2nd Section: Activity */}
                            {animal.activityCycle && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌓🏃 Activity</h3>
                                {animal.activityCycle && <div><strong className="text-sm">Activity Cycle:</strong> <p className="text-sm mt-1">{animal.activityCycle}</p></div>}
                                {!animal.activityCycle && <p className="text-sm text-gray-600"></p>}
                            </div>
                            )}
                        </div>
                    )}

                    {/* Tab 10: Records */}
                    {detailViewTab === 10 && (
                        <div className="space-y-6">
                            {/* Remarks & Notes */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📝 Remarks & Notes</h3>
                                <strong className="block text-sm text-gray-700 whitespace-pre-wrap">{animal.remarks || ''}</strong>
                            </div>
                        </div>
                    )}

                    {/* Tab 11: End of Life */}
                    {detailViewTab === 11 && (
                        <div className="space-y-6">
                            {/* End of Life */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🕊️ Information</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Deceased Date:</span> <strong>{animal.deceasedDate ? formatDate(animal.deceasedDate) : ''}</strong></div>
                                    <div><span className="text-gray-600">Cause of Death:</span> <strong>{animal.causeOfDeath || ''}</strong></div>
                                    <div><span className="text-gray-600">Necropsy Results:</span> <strong>{animal.necropsyResults || ''}</strong></div>
                                    {animal.endOfLifeCareNotes && (
                                        <div><span className="text-gray-600">{getLabel('endOfLifeCareNotes', 'End of Life Care Notes')}:</span> <strong className="whitespace-pre-wrap">{animal.endOfLifeCareNotes}</strong></div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 12: Show */}
                    {detailViewTab === 12 && (
                        <div className="space-y-6">
                            {/* Show Titles & Ratings */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🥇 Show Titles & Ratings</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.showTitles && <div><span className="text-gray-600">Titles:</span> <strong>{animal.showTitles}</strong></div>}
                                    {animal.showRatings && <div><span className="text-gray-600">Ratings:</span> <strong>{animal.showRatings}</strong></div>}
                                    {animal.judgeComments && <div><span className="text-gray-600">Judge Comments:</span> <strong className="whitespace-pre-wrap">{animal.judgeComments}</strong></div>}
                                </div>
                            </div>

                            {/* Working Titles & Performance */}
                            {(animal.workingTitles || animal.performanceScores) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🎯 Working & Performance</h3>
                                    <div className="space-y-3 text-sm">
                                        {animal.workingTitles && <div><span className="text-gray-600">Working Titles:</span> <strong>{animal.workingTitles}</strong></div>}
                                        {animal.performanceScores && <div><span className="text-gray-600">Performance Scores:</span> <strong>{animal.performanceScores}</strong></div>}
                                    </div>
                                </div>
                            )}

                            {/* Show message if no data */}
                            {!animal.showTitles && !animal.showRatings && !animal.judgeComments && !(animal.workingTitles || animal.performanceScores) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center text-gray-500">
                                    <p>No show information available</p>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 13: Legal & Documentation */}
                    {detailViewTab === 13 && (
                        <div className="space-y-6">
                            {/* Licensing & Permits */}
                            {(animal.licenseNumber || animal.licenseJurisdiction) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🔑 Licensing & Permits</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {fieldTemplate?.fields?.licenseNumber?.enabled !== false && animal.licenseNumber && (
                                        <div><span className="text-gray-600">{getLabel('licenseNumber', 'License Number')}:</span> <strong>{animal.licenseNumber}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.licenseJurisdiction?.enabled !== false && animal.licenseJurisdiction && (
                                        <div><span className="text-gray-600">{getLabel('licenseJurisdiction', 'License Jurisdiction')}:</span> <strong>{animal.licenseJurisdiction}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* Legal / Administrative */}
                            {(animal.insurance || animal.legalStatus) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📋 Legal / Administrative</h3>
                                <div className="space-y-3 text-sm">
                                    {fieldTemplate?.fields?.insurance?.enabled !== false && animal.insurance && (
                                        <div><span className="text-gray-600">{getLabel('insurance', 'Insurance')}:</span> <strong className="whitespace-pre-wrap">{animal.insurance}</strong></div>
                                    )}
                                    {fieldTemplate?.fields?.legalStatus?.enabled !== false && animal.legalStatus && (
                                        <div><span className="text-gray-600">{getLabel('legalStatus', 'Legal Status')}:</span> <strong className="whitespace-pre-wrap">{animal.legalStatus}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* Restrictions */}
                            {(animal.breedingRestrictions || animal.exportRestrictions) && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🚫 Restrictions</h3>
                                <div className="space-y-3 text-sm">
                                    {animal.breedingRestrictions && (
                                        <div><span className="text-gray-600">{getLabel('breedingRestrictions', 'Breeding Restrictions')}:</span> <strong className="whitespace-pre-wrap">{animal.breedingRestrictions}</strong></div>
                                    )}
                                    {animal.exportRestrictions && (
                                        <div><span className="text-gray-600">{getLabel('exportRestrictions', 'Export Restrictions')}:</span> <strong className="whitespace-pre-wrap">{animal.exportRestrictions}</strong></div>
                                    )}
                                </div>
                            </div>
                            )}

                            {/* No data fallback */}
                            {!animal.licenseNumber && !animal.licenseJurisdiction && !animal.insurance && !animal.legalStatus && !animal.breedingRestrictions && !animal.exportRestrictions && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center text-gray-500">
                                    <p>No legal or documentation records</p>
                                </div>
                            )}
                        </div>
                    )}

                {/* Pedigree Chart Modal */}
                {showPedigree && (
                    <PedigreeChart
                        animalId={animal.id_public}
                        onClose={() => setShowPedigree(false)}
                        API_BASE_URL={API_BASE_URL}
                        authToken={authToken}
                    />
                )}
            </div>
        </div>
    </div>
);
};

// View-Only Parent Card Component
const ViewOnlyParentCard = ({ parentId, parentType, API_BASE_URL, onViewAnimal, authToken }) => {
    const [parentData, setParentData] = useState(null);
    const [loading, setLoading] = useState(false);
    const [notFound, setNotFound] = useState(false);

    React.useEffect(() => {
        if (!parentId) {
            setParentData(null);
            setNotFound(false);
            return;
        }

        const fetchParent = async () => {
            setLoading(true);
            setNotFound(false);
            try {
                // If authToken is available, try fetching from owned animals first
                if (authToken) {
                    try {
                        const ownedResponse = await axios.get(`${API_BASE_URL}/animals/${parentId}`, {
                            headers: { Authorization: `Bearer ${authToken}` }
                        });
                        if (ownedResponse.data) {
                            setParentData(ownedResponse.data);
                            setLoading(false);
                            return;
                        }
                    } catch (ownedError) {
                        // Not in owned animals, try public database
                        console.log(`${parentType} not in owned animals, checking public database`);
                    }
                }

                // Try fetching from global public animals database
                const publicResponse = await axios.get(`${API_BASE_URL}/public/global/animals?id_public=${parentId}`);
                if (publicResponse.data && publicResponse.data.length > 0) {
                    setParentData(publicResponse.data[0]);
                } else {
                    setNotFound(true);
                    setParentData(null);
                }
            } catch (error) {
                console.error(`Error fetching ${parentType}:`, error);
                setNotFound(true);
                setParentData(null);
            } finally {
                setLoading(false);
            }
        };

        fetchParent();
    }, [parentId, parentType, API_BASE_URL, authToken]);

    if (!parentId || notFound) {
        return (
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                <p className="text-gray-500 text-sm">No {parentType.toLowerCase()} recorded</p>
            </div>
        );
    }

    if (loading) {
        return (
            <div className="border-2 border-gray-300 rounded-lg p-4 flex justify-center items-center">
                <Loader2 size={24} className="animate-spin text-gray-400" />
            </div>
        );
    }

    if (!parentData) {
        return (
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                <p className="text-gray-500 text-sm">Loading {parentType.toLowerCase()} data...</p>
            </div>
        );
    }

    const imgSrc = parentData.imageUrl || parentData.photoUrl || null;

    return (
        <div 
            className="border-2 border-gray-300 rounded-lg overflow-hidden cursor-pointer hover:shadow-md transition-shadow"
            onClick={() => onViewAnimal && onViewAnimal(parentData)}
        >
            <div className="bg-gray-50 px-3 py-2 border-b border-gray-300">
                <p className="text-xs font-semibold text-gray-600">{parentType}</p>
            </div>
            <div className="p-4">
                <div className="flex items-start space-x-3">
                    {imgSrc ? (
                        <img src={imgSrc} alt={parentData.name} className="w-16 h-16 rounded-lg object-cover" />
                    ) : (
                        <div className="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                            <Cat size={32} className="text-gray-400" />
                        </div>
                    )}
                    <div className="flex-grow">
                        <p className="font-semibold text-gray-800">
                            {parentData.prefix && `${parentData.prefix} `}{parentData.name}
                        </p>
                        <p className="text-xs text-gray-600 font-mono">{parentData.id_public}</p>
                        {parentData.status && (
                            <p className="text-xs text-gray-500 mt-1">{parentData.status}</p>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// Parent Mini Card Component for Offspring Section
const ParentMiniCard = ({ parent, label, onViewAnimal }) => {
    if (!parent) {
        return (
            <div className="flex items-center space-x-2 bg-gray-50 rounded-lg p-2 border border-gray-200" style={{ width: 'auto', minWidth: '180px' }}>
                <div className="w-10 h-10 bg-gray-200 rounded-md flex items-center justify-center flex-shrink-0">
                    <Cat size={20} className="text-gray-400" />
                </div>
                <div className="flex-grow">
                    <p className="text-xs text-gray-500 italic">{label} unknown</p>
                </div>
            </div>
        );
    }

    // Determine if the parent is clickable (owned by user or public)
    const isClickable = !parent.isHidden;

    return (
        <div 
            className={`flex items-center space-x-2 bg-gray-50 rounded-lg p-2 border border-gray-200 ${isClickable ? 'cursor-pointer hover:bg-gray-100' : 'opacity-75'} transition`}
            style={{ width: 'auto', minWidth: '180px' }}
            onClick={isClickable ? (() => onViewAnimal && onViewAnimal(parent)) : undefined}
        >
            <div className="w-10 h-10 bg-gray-200 rounded-md overflow-hidden flex items-center justify-center flex-shrink-0">
                {parent.imageUrl || parent.photoUrl ? (
                    <img 
                        src={parent.imageUrl || parent.photoUrl} 
                        alt={parent.name}
                        className="w-full h-full object-cover"
                    />
                ) : (
                    <Cat size={20} className="text-gray-400" />
                )}
            </div>
            <div className="flex items-center space-x-1 flex-grow">
                {parent.gender && (
                    <div>
                        {parent.gender === 'Male' 
                            ? <Mars size={12} strokeWidth={2.5} className="text-primary" /> 
                            : <Venus size={12} strokeWidth={2.5} className="text-accent" />
                        }
                    </div>
                )}
                <div className="flex-grow min-w-0">
                    <p className="text-xs font-semibold text-gray-800 truncate">
                        {parent.prefix && `${parent.prefix} `}
                        {parent.name}
                    </p>
                    <p className="text-xs text-gray-600 font-mono">
                        {parent.id_public}
                    </p>
                </div>
            </div>
        </div>
    );
};

// Offspring Section Component - shows offspring grouped by litter
const OffspringSection = ({ animalId, API_BASE_URL, authToken = null, onViewAnimal }) => {
    const [offspring, setOffspring] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentAnimal, setCurrentAnimal] = useState(null);

    useEffect(() => {
        const fetchData = async () => {
            if (!animalId) return;
            
            setLoading(true);
            try {
                const headers = authToken ? { Authorization: `Bearer ${authToken}` } : {};
                
                // Fetch offspring - only available for authenticated users
                if (authToken) {
                    const offspringEndpoint = `${API_BASE_URL}/animals/${animalId}/offspring`;
                    const offspringResponse = await axios.get(offspringEndpoint, { headers });
                    setOffspring(offspringResponse.data || []);
                    
                    // Fetch current animal to know which parent we are
                    try {
                        const animalResponse = await axios.get(
                            `${API_BASE_URL}/animals/any/${animalId}`,
                            { headers }
                        );
                        setCurrentAnimal(animalResponse.data);
                    } catch (err) {
                        console.error('Error fetching current animal:', err);
                    }
                } else {
                    // For unauthenticated users, offspring data is not available via API
                    // The backend doesn't expose a public offspring endpoint for privacy reasons
                    setOffspring([]);
                    
                    // Still fetch the current animal for display
                    try {
                        const publicResponse = await axios.get(
                            `${API_BASE_URL}/public/global/animals?id_public=${animalId}`
                        );
                        setCurrentAnimal(publicResponse.data?.[0] || null);
                    } catch (err) {
                        console.error('Error fetching current animal:', err);
                    }
                }
            } catch (error) {
                console.error('Error fetching offspring:', error);
                setOffspring([]);
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [animalId, API_BASE_URL, authToken]);

    return (
        <div className="bg-white border-2 border-gray-300 rounded-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">Offspring</h3>
            {loading ? (
                <div className="flex justify-center py-8">
                    <Loader2 size={24} className="animate-spin text-gray-400" />
                </div>
            ) : (!offspring || offspring.length === 0) ? (
                <p className="text-gray-500 text-sm italic">Offspring are not public or no offspring recorded.</p>
            ) : (
                <div className="space-y-6">
                    {offspring.map((litter, index) => (
                    <div key={litter.litterId || index} className="border-2 border-gray-200 rounded-lg p-4">
                        {/* Parent Cards at Top - Centered on desktop, stacked on mobile */}
                        <div className="flex flex-col sm:flex-row items-center gap-3 mb-3 justify-center">
                            {/* Father Card */}
                            {(litter.sireId_public || litter.otherParentType === 'sire') && (
                                <ParentMiniCard 
                                    parent={litter.otherParentType === 'sire' ? litter.otherParent : currentAnimal}
                                    label="Father"
                                    onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                            )}
                            
                            {/* Mother Card */}
                            {(litter.damId_public || litter.otherParentType === 'dam') && (
                                <ParentMiniCard 
                                    parent={litter.otherParentType === 'dam' ? litter.otherParent : currentAnimal}
                                    label="Mother"
                                    onViewAnimal={onViewAnimal}
                                        authToken={authToken}
                                    />
                            )}
                        </div>

                        {/* Litter Info - Centered */}
                        <div className="flex justify-center mb-4">
                            <div className="bg-gray-50 rounded-lg px-4 py-2 border border-gray-200 inline-block">
                                {litter.litter_id_public && (
                                    <p className="text-xs font-mono bg-gray-300 text-gray-800 px-2 py-1 rounded mb-2 text-center">
                                        {litter.litter_id_public}
                                    </p>
                                )}
                                {litter.litterName && (
                                    <p className="text-sm font-semibold text-gray-800 text-center mb-1">
                                        {litter.litterName}
                                    </p>
                                )}
                                <div className="flex items-center gap-3 text-sm text-gray-600">
                                    <span>Born: {formatDate(litter.birthDate)}</span>
                                    {litter.numberBorn && (
                                        <>
                                            <span></span>
                                            <span>{litter.numberBorn} born</span>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Offspring Animals */}
                        {litter.offspring && litter.offspring.length > 0 ? (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                {litter.offspring.map((animal) => (
                                    <div
                                        key={animal.id_public}
                                        onClick={() => onViewAnimal && onViewAnimal(animal)}
                                        className="relative bg-white rounded-lg shadow-sm h-52 flex flex-col items-center overflow-hidden cursor-pointer hover:shadow-md transition border border-gray-300 pt-2"
                                    >
                                        {/* Birthdate top-left */}
                                        {animal.birthDate && (
                                            <div className="absolute top-1.5 left-1.5 text-xs text-gray-600 bg-white/80 px-1.5 py-0.5 rounded">
                                                {formatDate(animal.birthDate)}
                                            </div>
                                        )}

                                        {/* Gender badge top-right */}
                                        {animal.gender && (
                                            <div className="absolute top-1.5 right-1.5">
                                                {animal.gender === 'Male' 
                                                    ? <Mars size={14} strokeWidth={2.5} className="text-primary" /> 
                                                    : <Venus size={14} strokeWidth={2.5} className="text-accent" />
                                                }
                                            </div>
                                        )}

                                        {/* Profile image */}
                                        <div className="flex-1 flex items-center justify-center w-full px-2 mt-1">
                                            {animal.imageUrl || animal.photoUrl ? (
                                                <img 
                                                    src={animal.imageUrl || animal.photoUrl} 
                                                    alt={animal.name} 
                                                    className="w-20 h-20 object-cover rounded-md" 
                                                />
                                            ) : (
                                                <div className="w-20 h-20 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                    <Cat size={32} />
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Icon row - only show if authenticated (local view) */}
                                        {authToken && (
                                            <div className="w-full flex justify-center items-center space-x-2 py-1">
                                                {animal.isOwned ? (
                                                    <Heart size={12} className="text-black" />
                                                ) : (
                                                    <HeartOff size={12} className="text-black" />
                                                )}
                                                {/* Show Eye icon if showOnPublicProfile is true, or if the animal is from PublicAnimal collection (has no showOnPublicProfile field) */}
                                                {(animal.showOnPublicProfile !== undefined ? animal.showOnPublicProfile : true) ? (
                                                    <Eye size={12} className="text-black" />
                                                ) : (
                                                    <EyeOff size={12} className="text-black" />
                                                )}
                                                {animal.isInMating && <Hourglass size={12} className="text-black" />}
                                                {animal.isPregnant && <Bean size={12} className="text-black" />}
                                                {animal.isNursing && <Milk size={12} className="text-black" />}
                                            </div>
                                        )}
                                        
                                        {/* Name */}
                                        <div className="w-full text-center px-2 pb-1">
                                            <div className="text-sm font-semibold text-gray-800 truncate">
                                                {animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}
                                            </div>
                                        </div>

                                        {/* ID bottom-right */}
                                        <div className="w-full px-2 pb-2 flex justify-end">
                                            <div className="text-xs text-gray-500">{animal.id_public}</div>
                                        </div>
                                        
                                        {/* Status bar */}
                                        <div className="w-full bg-gray-100 py-1 text-center border-t border-gray-300 mt-auto">
                                            <div className="text-xs font-medium text-gray-700">{animal.status || 'Unknown'}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="text-sm text-gray-500 italic">No offspring recorded in this litter.</p>
                        )}
                    </div>
                ))}
                </div>
            )}
        </div>
    );
};

// Litter Management Component
const LitterManagement = ({ authToken, API_BASE_URL, userProfile, showModalMessage, onViewAnimal, formDataRef, onFormOpenChange }) => {
    const [litters, setLitters] = useState([]);
    const [myAnimals, setMyAnimals] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showAddForm, setShowAddForm] = useState(false);
    const [formData, setFormData] = useState({
        breedingPairCodeName: '',
        sireId_public: '',
        damId_public: '',
        birthDate: '',
        maleCount: null,
        femaleCount: null,
        unknownCount: null,
        notes: '',
        linkedOffspringIds: [],
        // Enhanced breeding record fields
        breedingMethod: 'Unknown',
        breedingConditionAtTime: '',
        matingDate: '',
        outcome: 'Unknown',
        birthMethod: '',
        litterSizeBorn: null,
        litterSizeWeaned: null,
        stillbornCount: null
    });
    const [createOffspringCounts, setCreateOffspringCounts] = useState({
        males: 0,
        females: 0,
        unknown: 0
    });
    // Search filters for parent selection (UI not yet implemented)
    // const [sireSearch, setSireSearch] = useState('');
    // const [damSearch, setDamSearch] = useState('');
    // const [sireSpeciesFilter, setSireSpeciesFilter] = useState('');
    // const [damSpeciesFilter, setDamSpeciesFilter] = useState('');
    const [linkingAnimals, setLinkingAnimals] = useState(false);
    const [availableToLink, setAvailableToLink] = useState({ litter: null, animals: [] });
    const [expandedLitter, setExpandedLitter] = useState(null);
    const [editingLitter, setEditingLitter] = useState(null);
    const [modalTarget, setModalTarget] = useState(null);
    const [searchQuery, setSearchQuery] = useState('');
    const [speciesFilter, setSpeciesFilter] = useState('');
    const [yearFilter, setYearFilter] = useState('');
    // COI calculation state
    const [predictedCOI, setPredictedCOI] = useState(null);
    const [calculatingCOI, setCalculatingCOI] = useState(false);
    const [addingOffspring, setAddingOffspring] = useState(null);
    const [newOffspringData, setNewOffspringData] = useState({
        name: '',
        gender: '',
        color: '',
        coat: '',
        remarks: ''
    });
    const [bulkDeleteMode, setBulkDeleteMode] = useState({});
    const [selectedOffspring, setSelectedOffspring] = useState({});

    useEffect(() => {
        const loadData = async () => {
            setLoading(true);
            try {
                // Fetch animals and litters - they return immediately after setting data
                await Promise.all([fetchMyAnimals(), fetchLitters()]);
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                setLoading(false);
            }
        };
        loadData();
    }, []); // eslint-disable-line react-hooks/exhaustive-deps

    // Update parent ref with current form data for tutorial tracking
    useEffect(() => {
        if (formDataRef) {
            formDataRef.current = formData;
        }
    }, [formData, formDataRef]);

    // Notify parent when form open state changes
    useEffect(() => {
        if (onFormOpenChange) {
            onFormOpenChange(showAddForm);
        }
    }, [showAddForm, onFormOpenChange]);

    // Calculate predicted COI when both parents are selected
    useEffect(() => {
        const calculatePredictedCOI = async () => {
            if (formData.sireId_public && formData.damId_public && showAddForm) {
                setCalculatingCOI(true);
                try {
                    console.log('[Predicted COI] Calculating for sire:', formData.sireId_public, 'dam:', formData.damId_public);
                    const coiResponse = await axios.get(`${API_BASE_URL}/animals/inbreeding/pairing`, {
                        params: {
                            sireId: formData.sireId_public,
                            damId: formData.damId_public,
                            generations: 50
                        },
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    console.log('[Predicted COI] Response:', coiResponse.data);
                    const coiValue = coiResponse.data.inbreedingCoefficient;
                    setPredictedCOI(coiValue != null ? coiValue : 0);
                } catch (error) {
                    console.error('[Predicted COI] Error calculating:', error);
                    console.error('[Predicted COI] Error response:', error.response?.data);
                    setPredictedCOI(0); // Default to 0 if calculation fails
                } finally {
                    setCalculatingCOI(false);
                }
            } else {
                setPredictedCOI(null);
            }
        };
        
        calculatePredictedCOI();
    }, [formData.sireId_public, formData.damId_public, showAddForm, authToken, API_BASE_URL]);

    const toggleBulkDeleteMode = (litterId) => {
        setBulkDeleteMode(prev => ({ ...prev, [litterId]: !prev[litterId] }));
        setSelectedOffspring(prev => ({ ...prev, [litterId]: [] }));
    };

    const toggleOffspringSelection = (litterId, animalId) => {
        setSelectedOffspring(prev => {
            const current = prev[litterId] || [];
            const updated = current.includes(animalId)
                ? current.filter(id => id !== animalId)
                : [...current, animalId];
            return { ...prev, [litterId]: updated };
        });
    };

    const handleBulkDeleteOffspring = async (litterId) => {
        const selectedIds = selectedOffspring[litterId] || [];
        if (selectedIds.length === 0) {
            showModalMessage('No Selection', 'Please select at least one offspring to delete.');
            return;
        }

        const confirmDelete = window.confirm(`Are you sure you want to delete ${selectedIds.length} offspring animal(s)? This action cannot be undone.`);
        if (!confirmDelete) return;

        try {
            setLoading(true);
            for (const id of selectedIds) {
                await axios.delete(`${API_BASE_URL}/animals/${id}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
            }
            showModalMessage('Success', `Successfully deleted ${selectedIds.length} offspring animal(s).`);
            setBulkDeleteMode(prev => ({ ...prev, [litterId]: false }));
            setSelectedOffspring(prev => ({ ...prev, [litterId]: [] }));
            await fetchLitters();
            await fetchMyAnimals();
        } catch (error) {
            console.error('Error deleting offspring:', error);
            showModalMessage('Error', 'Failed to delete some offspring. Please try again.');
        } finally {
            setLoading(false);
        }
    };

    const fetchLitters = async () => {
        try {
            const response = await axios.get(`${API_BASE_URL}/litters`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            const littersData = response.data || [];
            
            // Set litters immediately so UI can render
            setLitters(littersData);
            
            // Calculate COI for each litter in background
            Promise.resolve().then(async () => {
                let needsUpdate = false;
                for (const litter of littersData) {
                    // Always recalculate to ensure COI stays accurate
                    if (litter.sireId_public && litter.damId_public) {
                        try {
                            const coiResponse = await axios.get(`${API_BASE_URL}/animals/inbreeding/pairing`, {
                                params: {
                                    sireId: litter.sireId_public,
                                    damId: litter.damId_public,
                                    generations: 50
                                },
                                headers: { Authorization: `Bearer ${authToken}` }
                            });

                            if (coiResponse.data.inbreedingCoefficient != null) {
                                litter.inbreedingCoefficient = coiResponse.data.inbreedingCoefficient;
                                needsUpdate = true;
                                
                                // Update database
                                await axios.put(`${API_BASE_URL}/litters/${litter._id}`, {
                                    inbreedingCoefficient: coiResponse.data.inbreedingCoefficient
                                }, {
                                    headers: { Authorization: `Bearer ${authToken}` }
                                });
                            }
                        } catch (error) {
                            console.log(`Could not update COI for litter ${litter._id}:`, error);
                        }
                    }
                }
                // Update state if any COI values were calculated
                if (needsUpdate) {
                    setLitters([...littersData]);
                }
            });
        } catch (error) {
            console.error('Error fetching litters:', error);
            setLitters([]);
        }
    };

    const fetchMyAnimals = async () => {
        try {
            const response = await axios.get(`${API_BASE_URL}/animals`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            const animalsData = response.data || [];
            
            console.log('[fetchMyAnimals] Raw response:', animalsData.length, 'animals');
            
            // Debug: Log health records for animals that have them
            animalsData.forEach((animal, idx) => {
                if (animal.vaccinations || animal.dewormingRecords || animal.parasiteControl) {
                    console.log(`[fetchMyAnimals] Animal ${animal.id_public} has health records:`, {
                        vaccinations: animal.vaccinations ? `${animal.vaccinations.length} bytes` : 'null',
                        dewormingRecords: animal.dewormingRecords ? `${animal.dewormingRecords.length} bytes` : 'null',
                        parasiteControl: animal.parasiteControl ? `${animal.parasiteControl.length} bytes` : 'null'
                    });
                }
            });
            
            // Set animals immediately so UI can render
            setMyAnimals(animalsData);
            
            // Start COI calculations in background without blocking
            Promise.resolve().then(async () => {
                for (const animal of animalsData) {
                    if ((animal.fatherId_public || animal.motherId_public || animal.sireId_public || animal.damId_public)) {
                        try {
                            const coiResponse = await axios.get(`${API_BASE_URL}/animals/${animal.id_public}/inbreeding`, {
                                params: { generations: 50 },
                                headers: { Authorization: `Bearer ${authToken}` }
                            });
                            animal.inbreedingCoefficient = coiResponse.data.inbreedingCoefficient;
                        } catch (error) {
                            console.log(`Could not update COI for animal ${animal.id_public}:`, error);
                        }
                    } else {
                        animal.inbreedingCoefficient = 0;
                    }
                }
                setMyAnimals([...animalsData]);
            });
        } catch (error) {
            console.error('Error fetching animals:', error);
            setMyAnimals([]);
        }
    };

    const handleSelectOtherParentForLitter = (animal) => {
        if (modalTarget === 'sire-litter') {
            setFormData({...formData, sireId_public: animal.id_public});
        } else if (modalTarget === 'dam-litter') {
            setFormData({...formData, damId_public: animal.id_public});
        } else if (modalTarget === 'other-parent1-litter') {
            setFormData({...formData, otherParent1Id_public: animal.id_public});
        } else if (modalTarget === 'other-parent2-litter') {
            setFormData({...formData, otherParent2Id_public: animal.id_public});
        }
        setModalTarget(null);
    };

    // Migration function to set isDisplay to true for all existing animals
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!formData.sireId_public || !formData.damId_public) {
            showModalMessage('Error', 'Please select both a Sire and a Dam');
            return;
        }

        try {
            // Get parent details
            const sire = myAnimals.find(a => a.id_public === formData.sireId_public);
            const dam = myAnimals.find(a => a.id_public === formData.damId_public);

            if (!sire || !dam) {
                showModalMessage('Error', 'Selected parents not found');
                return;
            }

            if (sire.species !== dam.species) {
                showModalMessage('Error', 'Parents must be the same species');
                return;
            }

            // Validate dam was alive at litter birth date (only females need to be alive at birth)
            if (formData.birthDate) {
                const litterBirthDate = new Date(formData.birthDate);
                
                // Only validate dam (female) - sires (males) can be deceased
                if (dam.deceasedDate) {
                    const damDeceasedDate = new Date(dam.deceasedDate);
                    if (damDeceasedDate < litterBirthDate) {
                        showModalMessage('Error', `Dam (${dam.name}) was deceased before the litter birth date`);
                        return;
                    }
                }
            }

            // Create litter with optional tracking counts
            // Preserve null for unspecified counts, don't convert to 0
            const maleCountNum = formData.maleCount !== null && formData.maleCount !== '' ? parseInt(formData.maleCount) : null;
            const femaleCountNum = formData.femaleCount !== null && formData.femaleCount !== '' ? parseInt(formData.femaleCount) : null;
            const totalCount = (maleCountNum || 0) + (femaleCountNum || 0);
            
            const litterPayload = {
                breedingPairCodeName: formData.breedingPairCodeName || null,
                sireId_public: formData.sireId_public,
                damId_public: formData.damId_public,
                birthDate: formData.birthDate || null,
                numberBorn: totalCount > 0 ? totalCount : (formData.linkedOffspringIds?.length || 0),
                maleCount: maleCountNum,
                femaleCount: femaleCountNum,
                unknownCount: formData.unknownCount,
                notes: formData.notes || '',
                offspringIds_public: formData.linkedOffspringIds || [],
                // Enhanced breeding record fields
                breedingMethod: formData.breedingMethod || 'Unknown',
                breedingConditionAtTime: formData.breedingConditionAtTime || null,
                matingDate: formData.matingDate || null,
                outcome: formData.outcome || 'Unknown',
                birthMethod: formData.birthMethod || null,
                litterSizeBorn: formData.litterSizeBorn || null,
                litterSizeWeaned: formData.litterSizeWeaned || null,
                stillbornCount: formData.stillbornCount || null
            };

            const litterResponse = await axios.post(`${API_BASE_URL}/litters`, litterPayload, {
                headers: { Authorization: `Bearer ${authToken}` }
            });

            const litterId = litterResponse.data.litterId_backend;

            // Calculate inbreeding coefficient for this pairing
            try {
                const coiResponse = await axios.get(`${API_BASE_URL}/animals/inbreeding/pairing`, {
                    params: {
                        sireId: formData.sireId_public,
                        damId: formData.damId_public,
                        generations: 50
                    },
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                if (coiResponse.data.inbreedingCoefficient != null) {
                    await axios.put(`${API_BASE_URL}/litters/${litterId}`, {
                        inbreedingCoefficient: coiResponse.data.inbreedingCoefficient
                    }, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                }
            } catch (coiError) {
                console.log('Could not calculate COI for litter:', coiError);
            }

            // Create offspring animals if requested
            const offspringPromises = [];
            const totalToCreate = parseInt(createOffspringCounts.males || 0) + parseInt(createOffspringCounts.females || 0) + parseInt(createOffspringCounts.unknown || 0);
            
            if (totalToCreate > 0) {
                // Need birthdate to create animals
                if (!formData.birthDate) {
                    showModalMessage('Error', 'Birth date is required to create new offspring animals');
                    return;
                }
                
                // Create males
                for (let i = 1; i <= parseInt(createOffspringCounts.males || 0); i++) {
                    offspringPromises.push(axios.post(`${API_BASE_URL}/animals`, { name: `M${i}`, species: sire.species, gender: 'Male', birthDate: formData.birthDate, status: 'Pet', fatherId_public: formData.sireId_public, motherId_public: formData.damId_public, isOwned: true, breederId_public: userProfile.id_public, ownerId_public: userProfile.id_public }, { headers: { Authorization: `Bearer ${authToken}` } }));
                }
                
                // Create females
                for (let i = 1; i <= parseInt(createOffspringCounts.females || 0); i++) {
                    offspringPromises.push(axios.post(`${API_BASE_URL}/animals`, { name: `F${i}`, species: sire.species, gender: 'Female', birthDate: formData.birthDate, status: 'Pet', fatherId_public: formData.sireId_public, motherId_public: formData.damId_public, isOwned: true, breederId_public: userProfile.id_public, ownerId_public: userProfile.id_public }, { headers: { Authorization: `Bearer ${authToken}` } }));
                }

                // Create unknown/intersex
                for (let i = 1; i <= parseInt(createOffspringCounts.unknown || 0); i++) {
                    offspringPromises.push(axios.post(`${API_BASE_URL}/animals`, { name: `U${i}`, species: sire.species, gender: 'Unknown', birthDate: formData.birthDate, status: 'Pet', fatherId_public: formData.sireId_public, motherId_public: formData.damId_public, isOwned: true, breederId_public: userProfile.id_public, ownerId_public: userProfile.id_public }, { headers: { Authorization: `Bearer ${authToken}` } }));
                }
            }
            
            const createdAnimals = await Promise.all(offspringPromises);

            // Extract the IDs from created animals
            const newOffspringIds = createdAnimals.map(response => response.data.id_public);
            
            // Combine created and linked offspring IDs
            const allOffspringIds = [...newOffspringIds, ...(formData.linkedOffspringIds || [])];
            
            // Calculate inbreeding for each NEW offspring
            for (const animalId of newOffspringIds) {
                try {
                    await axios.get(`${API_BASE_URL}/animals/${animalId}/inbreeding`, {
                        params: { generations: 50 },
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                } catch (coiError) {
                    console.log(`Could not calculate COI for animal ${animalId}:`, coiError);
                }
            }
            
            // Update litter with all offspring
            await axios.put(`${API_BASE_URL}/litters/${litterId}`, {
                offspringIds_public: allOffspringIds,
                numberBorn: allOffspringIds.length
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });

            // Recalculate litter COI after adding offspring
            try {
                const coiResponse = await axios.get(`${API_BASE_URL}/animals/inbreeding/pairing`, {
                    params: {
                        sireId: formData.sireId_public,
                        damId: formData.damId_public,
                        generations: 50
                    },
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                if (coiResponse.data.inbreedingCoefficient != null) {
                    await axios.put(`${API_BASE_URL}/litters/${litterId}`, {
                        inbreedingCoefficient: coiResponse.data.inbreedingCoefficient
                    }, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                }
            } catch (coiError) {
                console.log('Could not calculate COI for litter:', coiError);
            }

            const createdCount = newOffspringIds.length;
            const linkedCount = formData.linkedOffspringIds?.length || 0;
            const trackingMales = formData.maleCount ? parseInt(formData.maleCount) : 0;
            const trackingFemales = formData.femaleCount ? parseInt(formData.femaleCount) : 0;
            
            let successMsg = 'Litter created successfully!';
            const parts = [];
            if (createdCount > 0) parts.push(`${createdCount} new animal(s) created`);
            if (linkedCount > 0) parts.push(`${linkedCount} animal(s) linked`);
            if (trackingMales > 0 || trackingFemales > 0) {
                parts.push(`tracking ${trackingMales}M/${trackingFemales}F`);
            }
            if (parts.length > 0) {
                successMsg = `Litter created with ${parts.join(', ')}!`;
            }
            
            showModalMessage('Success', successMsg);
            setShowAddForm(false);
            setFormData({
                breedingPairCodeName: '',
                sireId_public: '',
                damId_public: '',
                birthDate: '',
                maleCount: null,
                femaleCount: null,
                unknownCount: null,
                notes: '',
                linkedOffspringIds: [],
                // Enhanced breeding record fields
                breedingMethod: 'Unknown',
                breedingConditionAtTime: '',
                matingDate: '',
                outcome: 'Unknown',
                birthMethod: '',
                litterSizeBorn: null,
                litterSizeWeaned: null,
                stillbornCount: null
            });
            setCreateOffspringCounts({ males: 0, females: 0, unknown: 0 });
            // setSireSearch('');
            // setDamSearch('');
            // setSireSpeciesFilter('');
            // setDamSpeciesFilter('');
            setPredictedCOI(null);
            fetchLitters();
            fetchMyAnimals();
        } catch (error) {
            console.error('Error creating litter:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to create litter');
        }
    };

    const handleLinkAnimals = async (litter) => {
        try {
            // Search for animals with matching parents and birthdate
            // Require birthdate to be set first
            if (!litter.birthDate) {
                showModalMessage('Required', 'Please enter a birth date for the litter before linking animals.');
                return;
            }

            const response = await axios.get(`${API_BASE_URL}/animals`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            // Get offspring IDs already in this litter
            const linkedIds = litter.offspringIds_public || [];
            
            const matching = response.data.filter(animal => {
                // Skip if already linked to this litter
                if (linkedIds.includes(animal.id_public)) return false;
                
                const matchesSire = animal.fatherId_public === litter.sireId_public || animal.sireId_public === litter.sireId_public;
                const matchesDam = animal.motherId_public === litter.damId_public || animal.damId_public === litter.damId_public;
                const matchesBirthDate = animal.birthDate && new Date(animal.birthDate).toDateString() === new Date(litter.birthDate).toDateString();
                return matchesSire && matchesDam && matchesBirthDate;
            });

            setAvailableToLink({ litter, animals: matching });
            setLinkingAnimals(true);
        } catch (error) {
            console.error('Error finding matching animals:', error);
            showModalMessage('Error', 'Failed to search for matching animals');
        }
    };

    const handleAddToLitter = async (animalId) => {
        try {
            const updatedOffspringIds = [...(availableToLink.litter.offspringIds_public || []), animalId];
            
            await axios.put(`${API_BASE_URL}/litters/${availableToLink.litter._id}`, {
                offspringIds_public: updatedOffspringIds,
                numberBorn: updatedOffspringIds.length
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            showModalMessage('Success', 'Animal linked to litter!');
            
            // Remove from available list
            setAvailableToLink({
                ...availableToLink,
                animals: availableToLink.animals.filter(a => a.id_public !== animalId)
            });
            
            // Refresh litters to show updated count
            fetchLitters();
        } catch (error) {
            console.error('Error linking animal to litter:', error);
            showModalMessage('Error', 'Failed to link animal to litter');
        }
    };

    const handleAddAllToLitter = async () => {
        try {
            if (!availableToLink.animals || availableToLink.animals.length === 0) return;
            
            // Get all animal IDs to add
            const animalIdsToAdd = availableToLink.animals.map(a => a.id_public);
            const updatedOffspringIds = [...(availableToLink.litter.offspringIds_public || []), ...animalIdsToAdd];
            
            await axios.put(`${API_BASE_URL}/litters/${availableToLink.litter._id}`, {
                offspringIds_public: updatedOffspringIds,
                numberBorn: updatedOffspringIds.length
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            showModalMessage('Success', `${animalIdsToAdd.length} animal(s) linked to litter!`);
            
            // Clear available list
            setAvailableToLink({
                ...availableToLink,
                animals: []
            });
            
            // Refresh litters to show updated count
            fetchLitters();
        } catch (error) {
            console.error('Error linking animals to litter:', error);
            showModalMessage('Error', 'Failed to link animals to litter');
        }
    };

    const handleDeleteLitter = async (litterId) => {
        if (!window.confirm('Are you sure you want to delete this litter? This will not delete the animals, only the litter record.')) {
            return;
        }

        try {
            await axios.delete(`${API_BASE_URL}/litters/${litterId}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            showModalMessage('Success', 'Litter deleted successfully!');
            fetchLitters();
        } catch (error) {
            console.error('Error deleting litter:', error);
            showModalMessage('Error', 'Failed to delete litter');
        }
    };

    const handleRecalculateOffspringCounts = async () => {
        if (!window.confirm('This will recalculate offspring counts for all litters based on linked animals. Continue?')) {
            return;
        }

        try {
            setLoading(true);
            let updatedCount = 0;

            for (const litter of litters) {
                const correctCount = litter.offspringIds_public?.length || 0;
                
                // Only update if count is different
                if (litter.numberBorn !== correctCount) {
                    await axios.put(`${API_BASE_URL}/litters/${litter._id}`, {
                        numberBorn: correctCount
                    }, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    updatedCount++;
                }
            }

            showModalMessage('Success', `Recalculated offspring counts for ${updatedCount} litter(s)!`);
            fetchLitters();
        } catch (error) {
            console.error('Error recalculating offspring counts:', error);
            showModalMessage('Error', 'Failed to recalculate offspring counts');
        } finally {
            setLoading(false);
        }
    };

    const handleEditLitter = (litter) => {
        // Format birthDate and matingDate for date inputs
        // Date inputs expect YYYY-MM-DD format
        const formatDateForInput = (dateString) => {
            if (!dateString) return '';
            try {
                // If it's already in YYYY-MM-DD format, return as-is
                if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}/)) {
                    return dateString.split('T')[0];
                }
                // Otherwise parse and format
                const date = new Date(dateString);
                return date.toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        };

        setEditingLitter(litter._id);
        setFormData({
            breedingPairCodeName: litter.breedingPairCodeName || '',
            sireId_public: litter.sireId_public,
            damId_public: litter.damId_public,
            birthDate: formatDateForInput(litter.birthDate),
            maleCount: litter.maleCount || null,
            femaleCount: litter.femaleCount || null,
            unknownCount: litter.unknownCount || null,
            notes: litter.notes || '',
            linkedOffspringIds: litter.offspringIds_public || [],
            // Enhanced breeding record fields
            breedingMethod: litter.breedingMethod || 'Unknown',
            breedingConditionAtTime: litter.breedingConditionAtTime || '',
            matingDate: litter.matingDate || litter.pairingDate,
            outcome: litter.outcome || 'Unknown',
            birthMethod: litter.birthMethod || '',
            litterSizeBorn: litter.litterSizeBorn || litter.numberBorn || null,
            litterSizeWeaned: litter.litterSizeWeaned || litter.numberWeaned || null,
            stillbornCount: litter.stillbornCount || litter.stillborn || null
        });
        setShowAddForm(true);
        setExpandedLitter(null);
    };

    const handleUpdateLitter = async (e) => {
        e.preventDefault();
        
        if (!formData.sireId_public || !formData.damId_public) {
            showModalMessage('Error', 'Please select both a Sire and a Dam');
            return;
        }

        try {
            // Get parent details
            // eslint-disable-next-line no-unused-vars
            const sire = myAnimals.find(a => a.id_public === formData.sireId_public);
            // eslint-disable-next-line no-unused-vars  
            const dam = myAnimals.find(a => a.id_public === formData.damId_public);

            // Create offspring animals if requested
            const offspringPromises = [];
            const totalToCreate = parseInt(createOffspringCounts.males || 0) + parseInt(createOffspringCounts.females || 0) + parseInt(createOffspringCounts.unknown || 0);
            
            if (totalToCreate > 0) {
                // Need birthdate to create animals
                if (!formData.birthDate) {
                    showModalMessage('Error', 'Birth date is required to create new offspring animals');
                    return;
                }
                
                for (let i = 1; i <= parseInt(createOffspringCounts.males || 0); i++) {
                    offspringPromises.push(axios.post(`${API_BASE_URL}/animals`, { name: `M${i}`, species: sire.species, gender: 'Male', birthDate: formData.birthDate, status: 'Pet', fatherId_public: formData.sireId_public, motherId_public: formData.damId_public, isOwned: true, breederId_public: userProfile.id_public, ownerId_public: userProfile.id_public }, { headers: { Authorization: `Bearer ${authToken}` } }));
                }
                for (let i = 1; i <= parseInt(createOffspringCounts.females || 0); i++) {
                    offspringPromises.push(axios.post(`${API_BASE_URL}/animals`, { name: `F${i}`, species: sire.species, gender: 'Female', birthDate: formData.birthDate, status: 'Pet', fatherId_public: formData.sireId_public, motherId_public: formData.damId_public, isOwned: true, breederId_public: userProfile.id_public, ownerId_public: userProfile.id_public }, { headers: { Authorization: `Bearer ${authToken}` } }));
                }
                for (let i = 1; i <= parseInt(createOffspringCounts.unknown || 0); i++) {
                    offspringPromises.push(axios.post(`${API_BASE_URL}/animals`, { name: `U${i}`, species: sire.species, gender: 'Unknown', birthDate: formData.birthDate, status: 'Pet', fatherId_public: formData.sireId_public, motherId_public: formData.damId_public, isOwned: true, breederId_public: userProfile.id_public, ownerId_public: userProfile.id_public }, { headers: { Authorization: `Bearer ${authToken}` } }));
                }
            }
            
            const createdAnimals = await Promise.all(offspringPromises);
            const newOffspringIds = createdAnimals.map(response => response.data.id_public);
            const allOffspringIds = [...newOffspringIds, ...(formData.linkedOffspringIds || [])];

            await axios.put(`${API_BASE_URL}/litters/${editingLitter}`, {
                breedingPairCodeName: formData.breedingPairCodeName,
                sireId_public: formData.sireId_public,
                damId_public: formData.damId_public,
                birthDate: formData.birthDate,
                maleCount: formData.maleCount,
                femaleCount: formData.femaleCount,
                unknownCount: formData.unknownCount,
                notes: formData.notes,
                offspringIds_public: allOffspringIds,
                numberBorn: allOffspringIds.length,
                // Enhanced breeding record fields
                breedingMethod: formData.breedingMethod,
                breedingConditionAtTime: formData.breedingConditionAtTime,
                matingDate: formData.matingDate,
                outcome: formData.outcome,
                birthMethod: formData.birthMethod,
                litterSizeBorn: formData.litterSizeBorn,
                litterSizeWeaned: formData.litterSizeWeaned,
                stillbornCount: formData.stillbornCount
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });

            showModalMessage('Success', 'Litter updated successfully!');
            setShowAddForm(false);
            setEditingLitter(null);
            setFormData({
                breedingPairCodeName: '',
                sireId_public: '',
                damId_public: '',
                otherParent1Id_public: '',
                otherParent1Role: '',
                birthDate: '',
                maleCount: null,
                femaleCount: null,
                notes: '',
                linkedOffspringIds: [],
                // Enhanced breeding record fields
                breedingMethod: 'Unknown',
                breedingConditionAtTime: '',
                matingDate: '',
                outcome: 'Unknown',
                birthMethod: '',
                litterSizeBorn: null,
                litterSizeWeaned: null,
                stillbornCount: null
            });
            setCreateOffspringCounts({ males: 0, females: 0, unknown: 0 });
            // setSireSearch('');
            // setDamSearch('');
            // setSireSpeciesFilter('');
            // setDamSpeciesFilter('');
            setPredictedCOI(null);
            fetchLitters();
            fetchMyAnimals();
        } catch (error) {
            console.error('Error updating litter:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to update litter');
        }
    };

    const handleAddOffspringToLitter = (litter) => {
        const sire = myAnimals.find(a => a.id_public === litter.sireId_public);
        setAddingOffspring(litter);
        setNewOffspringData({
            name: '',
            gender: '',
            color: '',
            coat: '',
            remarks: ''
        });
    };

    const handleSaveNewOffspring = async () => {
        if (!newOffspringData.name || !newOffspringData.gender) {
            showModalMessage('Error', 'Name and gender are required');
            return;
        }

        try {
            const sire = myAnimals.find(a => a.id_public === addingOffspring.sireId_public);
            
            const animalData = {
                name: newOffspringData.name,
                species: sire.species,
                gender: newOffspringData.gender,
                birthDate: addingOffspring.birthDate,
                status: 'Pet',
                fatherId_public: addingOffspring.sireId_public,
                motherId_public: addingOffspring.damId_public,
                color: newOffspringData.color || null,
                coat: newOffspringData.coat || null,
                remarks: newOffspringData.remarks || null,
                isOwned: true,
                breederId_public: userProfile.id_public,
                ownerId_public: userProfile.id_public
            };

            const response = await axios.post(`${API_BASE_URL}/animals`, animalData, {
                headers: { Authorization: `Bearer ${authToken}` }
            });

            const newAnimalId = response.data.id_public;

            // Calculate inbreeding coefficient
            try {
                await axios.get(`${API_BASE_URL}/animals/${newAnimalId}/inbreeding`, {
                    params: { generations: 50 },
                    headers: { Authorization: `Bearer ${authToken}` }
                });
            } catch (coiError) {
                console.log('Could not calculate COI for new offspring:', coiError);
            }

            // Link to litter
            const updatedOffspringIds = [...(addingOffspring.offspringIds_public || []), newAnimalId];
            await axios.put(`${API_BASE_URL}/litters/${addingOffspring._id}`, {
                offspringIds_public: updatedOffspringIds,
                numberBorn: updatedOffspringIds.length
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });

            showModalMessage('Success', 'Offspring added to litter!');
            setAddingOffspring(null);
            fetchLitters();
            fetchMyAnimals();
        } catch (error) {
            console.error('Error adding offspring:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to add offspring');
        }
    };

    // Debug logging for animal filtering
    console.log('[LitterManagement] Total myAnimals:', myAnimals.length);
    console.log('[LitterManagement] Animals data:', myAnimals.map(a => ({ 
        id: a.id_public, 
        name: a.name, 
        gender: a.gender,
        species: a.species 
    })));
    
    const maleAnimals = myAnimals.filter(a => a.gender === 'Male');
    const femaleAnimals = myAnimals.filter(a => a.gender === 'Female');
    const availableYears = useMemo(() => {
        const years = litters
            .map(litter => litter.birthDate || litter.matingDate || litter.pairingDate)
            .filter(Boolean)
            .map(dateStr => {
                const parsedDate = new Date(dateStr);
                return Number.isNaN(parsedDate.getTime()) ? null : parsedDate.getFullYear();
            })
            .filter(Boolean);
        const uniqueYears = [...new Set(years)];
        uniqueYears.sort((a, b) => b - a);
        return uniqueYears;
    }, [litters]);
    
    // Filtered animals are handled directly in the render sections below
    
    // Get unique species from all animals (currently for debugging)
    // const allSpecies = [...new Set(myAnimals.map(a => a.species).filter(Boolean))].sort();
    
    console.log('[LitterManagement] Male animals:', maleAnimals.length);
    console.log('[LitterManagement] Female animals:', femaleAnimals.length);

    // Filter litters based on search query and species
    const filteredLitters = litters.filter(litter => {
        const sire = myAnimals.find(a => a.id_public === litter.sireId_public);
        const dam = myAnimals.find(a => a.id_public === litter.damId_public);
        
        // Species filter
        if (speciesFilter) {
            if (sire?.species !== speciesFilter) return false;
        }

        // Year filter (birthDate fallback to matingDate/pairingDate)
        if (yearFilter) {
            const referenceDate = litter.birthDate || litter.matingDate || litter.pairingDate;
            if (!referenceDate) return false;
            const parsedDate = new Date(referenceDate);
            const litterYear = Number.isNaN(parsedDate.getTime()) ? null : parsedDate.getFullYear();
            if (!litterYear || litterYear.toString() !== yearFilter) return false;
        }
        
        // Search filter
        if (!searchQuery) return true;
        
        const query = searchQuery.toLowerCase();
        
        // Search by CTL-ID
        if (litter.litter_id_public && litter.litter_id_public.toLowerCase().includes(query)) return true;
        
        // Search by litter name
        if (litter.breedingPairCodeName && litter.breedingPairCodeName.toLowerCase().includes(query)) return true;
        
        // Search by sire name or ID
        if (sire && sire.name.toLowerCase().includes(query)) return true;
        if (sire && sire.id_public.toString().includes(query)) return true;
        if (litter.sireId_public.toString().includes(query)) return true;
        
        // Search by dam name or ID
        if (dam && dam.name.toLowerCase().includes(query)) return true;
        if (dam && dam.id_public.toString().includes(query)) return true;
        if (litter.damId_public.toString().includes(query)) return true;
        
        return false;
    });

    if (loading) {
        return (
            <div className="w-full max-w-6xl bg-white p-6 rounded-xl shadow-lg">
                <div className="flex justify-center items-center py-12">
                    <Loader2 className="animate-spin" size={48} />
                </div>
            </div>
        );
    }

    return (
        <div className="w-full max-w-6xl bg-white p-3 sm:p-6 rounded-xl shadow-lg">
            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-3 mb-4 sm:mb-6">
                <h2 className="text-xl sm:text-3xl font-bold text-gray-800 flex items-center">
                    <BookOpen className="w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3 text-primary-dark" />
                    Litter Management
                </h2>
                <div className="flex gap-2">
                    <button
                        onClick={handleRecalculateOffspringCounts}
                        className="bg-primary hover:bg-primary/90 text-black font-semibold py-1.5 sm:py-2 px-2 sm:px-3 rounded-lg flex items-center"
                        title="Recalculate offspring counts for all litters"
                    >
                        <RefreshCw className="w-4 h-4 sm:w-5 sm:h-5" />
                    </button>
                    <button
                        onClick={() => {
                            if (showAddForm) {
                                // Clear search filters and editing state when closing form
                                // setSireSearch('');
                                // setDamSearch('');
                                // setSireSpeciesFilter('');
                                // setDamSpeciesFilter('');
                                setEditingLitter(null);
                                setPredictedCOI(null);
                                setFormData({
                                    breedingPairCodeName: '',
                                    sireId_public: '',
                                    damId_public: '',
                                    otherParent1Id_public: '',
                                    otherParent1Role: '',
                                    otherParent2Id_public: '',
                                    otherParent2Role: '',
                                    birthDate: '',
                                    maleCount: '',
                                    femaleCount: '',
                                    notes: '',
                                    linkedOffspringIds: []
                                });
                            }
                            setShowAddForm(!showAddForm);
                        }}
                        data-tutorial-target="new-litter-btn"
                        className="bg-primary hover:bg-primary/90 text-black font-semibold py-1.5 sm:py-2 px-3 sm:px-4 rounded-lg flex items-center gap-1 sm:gap-2 text-sm sm:text-base"
                    >
                        {showAddForm ? <X className="w-4 h-4 sm:w-5 sm:h-5" /> : <Plus className="w-4 h-4 sm:w-5 sm:h-5" />}
                        <span className="hidden sm:inline">{showAddForm ? 'Cancel' : 'New Litter'}</span>
                        <span className="sm:hidden">{showAddForm ? '' : 'New'}</span>
                    </button>
                </div>
            </div>

            {/* Create/Edit Litter Modal */}
            {showAddForm && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center border-b p-4">
                            <h3 className="text-xl font-bold text-gray-800">{editingLitter ? 'Edit Litter' : 'Create New Litter'}</h3>
                            <button 
                                onClick={() => {
                                    setShowAddForm(false);
                                    setEditingLitter(null);
                                }}
                                className="text-gray-500 hover:text-gray-800"
                            >
                                <X size={24} />
                            </button>
                        </div>

                        <div className="flex-grow overflow-y-auto p-4">
                            <form onSubmit={editingLitter ? handleUpdateLitter : handleSubmit} id="litter-form" className="space-y-4">
                                {/* Auto-assigned CTL-ID (read-only) */}
                                {editingLitter && editingLitter.litter_id_public && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            System Litter ID (CTL-ID)
                                        </label>
                                        <input
                                            type="text"
                                            value={editingLitter.litter_id_public}
                                            disabled
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 font-mono"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Auto-assigned for system linkage</p>
                                    </div>
                                )}
                                
                                {/* Litter Name - Full Width */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Litter Name/ID
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.breedingPairCodeName}
                                        onChange={(e) => setFormData({...formData, breedingPairCodeName: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="e.g., Summer 2025 Litter A, Disney's Hakuna Matata"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Your custom name for this breeding pair</p>
                                </div>

                                {/* Sire & Dam Selection */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {/* Sire Selection */}
                                    <div data-tutorial-target="sire-dam-section">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Sire (Father) <span className="text-red-500">*</span>
                                        </label>
                                        <button
                                            type="button"
                                            onClick={() => setModalTarget('sire-litter')}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 text-left transition focus:ring-2 focus:ring-primary focus:border-transparent"
                                        >
                                            {formData.sireId_public ? (
                                                <div>
                                                    <div className="font-medium">
                                                        {myAnimals.find(a => a.id_public === formData.sireId_public)?.name || 'Unknown'}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        {formData.sireId_public}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-gray-400">Select Sire...</div>
                                            )}
                                        </button>
                                    </div>

                                    {/* Dam Selection */}
                                    <div data-tutorial-target="sire-dam-section">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Dam (Mother) <span className="text-red-500">*</span>
                                        </label>
                                        <button
                                            type="button"
                                            onClick={() => setModalTarget('dam-litter')}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 text-left transition focus:ring-2 focus:ring-primary focus:border-transparent"
                                        >
                                            {formData.damId_public ? (
                                                <div>
                                                    <div className="font-medium">
                                                        {myAnimals.find(a => a.id_public === formData.damId_public)?.name || 'Unknown'}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        {formData.damId_public}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-gray-400">Select Dam...</div>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                {/* Predicted COI Display */}
                                {(formData.sireId_public && formData.damId_public) && (
                                    <div className="mb-4 p-3 rounded-lg border bg-gray-50 flex items-center gap-2">
                                        <span className="text-sm font-medium text-gray-700">Predicted COI for this pairing:</span>
                                        {calculatingCOI ? (
                                            <span className="text-sm text-gray-500 flex items-center gap-1">
                                                <Loader2 className="w-4 h-4 animate-spin" /> Calculating...
                                            </span>
                                        ) : predictedCOI != null ? (
                                            <span className="text-sm font-bold text-gray-800">
                                                {predictedCOI.toFixed(2)}%
                                            </span>
                                        ) : (
                                            <span className="text-sm text-gray-400 italic">N/A</span>
                                        )}
                                    </div>
                                )}

                                {/* Breeding Information */}
                                <div className="mb-6 p-4 border border-purple-200 rounded-lg bg-purple-50">
                                    <h4 className="text-md font-semibold text-gray-700 mb-4 flex items-center">
                                        <span className="text-purple-600 mr-2">🧬</span>Breeding Information
                                    </h4>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        {/* Breeding Method */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Breeding Method
                                            </label>
                                            <select
                                                value={formData.breedingMethod || 'Unknown'}
                                                onChange={(e) => setFormData({...formData, breedingMethod: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            >
                                                <option value="Natural">Natural</option>
                                                <option value="AI">Artificial Insemination</option>
                                                <option value="Assisted">Assisted</option>
                                                <option value="Unknown">Unknown</option>
                                            </select>
                                        </div>

                                        {/* Breeding Condition */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Breeding Condition
                                            </label>
                                            <select
                                                value={formData.breedingConditionAtTime || ''}
                                                onChange={(e) => setFormData({...formData, breedingConditionAtTime: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            >
                                                <option value="">Select Condition...</option>
                                                <option value="Good">Good</option>
                                                <option value="Okay">Okay</option>
                                                <option value="Poor">Poor</option>
                                            </select>
                                        </div>

                                        {/* Outcome Status */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Breeding Outcome
                                            </label>
                                            <select
                                                value={formData.outcome || 'Unknown'}
                                                onChange={(e) => setFormData({...formData, outcome: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            >
                                                <option value="Successful">Successful</option>
                                                <option value="Unsuccessful">Unsuccessful</option>
                                                <option value="Unknown">Unknown</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Mating Date */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Mating Date
                                            </label>
                                            <DatePicker
                                                value={formData.matingDate || ''}
                                                onChange={(e) => setFormData({...formData, matingDate: e.target.value})}
                                                className="px-3 py-2"
                                            />
                                        </div>

                                        {/* Birth Method */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Birth Method
                                            </label>
                                            <select
                                                value={formData.birthMethod || ''}
                                                onChange={(e) => setFormData({...formData, birthMethod: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            >
                                                <option value="">Select Method...</option>
                                                <option value="Natural">Natural</option>
                                                <option value="C-Section">C-Section</option>
                                                <option value="Assisted">Assisted</option>
                                                <option value="Induced">Induced</option>
                                                <option value="Unknown">Unknown</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Birth Date & Offspring Counts */}
                                <div className="mb-6 p-4 border border-green-200 rounded-lg bg-green-50">
                                    <h4 className="text-md font-semibold text-gray-700 mb-4 flex items-center">
                                        <span className="text-green-600 mr-2">👶</span>Birth & Offspring Details
                                    </h4>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4" data-tutorial-target="litter-dates-counts">
                                        {/* Birth Date */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Birth Date (Optional)
                                            </label>
                                            <DatePicker
                                                value={formData.birthDate}
                                                onChange={(e) => setFormData({...formData, birthDate: e.target.value})}
                                                maxDate={new Date()}
                                                className="px-3 py-2"
                                            />
                                        </div>

                                        {/* Total Born - auto-computed from male + female + unknown */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Total Born <span className="text-xs text-gray-400 font-normal">(auto)</span>
                                            </label>
                                            <input
                                                type="number"
                                                value={typeof formData.litterSizeBorn === 'number' ? formData.litterSizeBorn : (formData.litterSizeBorn || '')}
                                                readOnly
                                                className="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                                placeholder="Set counts below"
                                            />
                                        </div>

                                        {/* Stillborn Count */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Stillborn
                                            </label>
                                            <input
                                                type="number"
                                                value={typeof formData.stillbornCount === 'number' ? formData.stillbornCount : (formData.stillbornCount || '')}
                                                onChange={(e) => setFormData({...formData, stillbornCount: e.target.value ? parseInt(e.target.value) : null})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                min="0"
                                            />
                                        </div>

                                        {/* Total Weaned */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Total Weaned
                                            </label>
                                            <input
                                                type="number"
                                                value={typeof formData.litterSizeWeaned === 'number' ? formData.litterSizeWeaned : (formData.litterSizeWeaned || '')}
                                                onChange={(e) => setFormData({...formData, litterSizeWeaned: e.target.value ? parseInt(e.target.value) : null})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                min="0"
                                            />
                                        </div>
                                    </div>

                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {/* Male Count */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Number of Males</label>
                                            <input
                                                type="number"
                                                value={typeof formData.maleCount === 'number' ? formData.maleCount : (formData.maleCount || '')}
                                                onChange={(e) => {
                                                    const v = e.target.value ? parseInt(e.target.value) : null;
                                                    const f = formData.femaleCount || 0;
                                                    const u = formData.unknownCount || 0;
                                                    setFormData({...formData, maleCount: v, litterSizeBorn: (v || 0) + f + u || null});
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                min={myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && a.gender === 'Male').length || 0}
                                            />
                                            {(() => { const lm = myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && a.gender === 'Male').length; return lm > 0 && (formData.maleCount || 0) < lm ? (<p className="text-xs text-red-600 mt-1">? {lm} male{lm > 1 ? 's' : ''} linked � can't be below {lm}</p>) : lm > 0 ? (<p className="text-xs text-gray-500 mt-1">{lm} male{lm > 1 ? 's' : ''} linked</p>) : null; })()}
                                        </div>

                                        {/* Female Count */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Number of Females</label>
                                            <input
                                                type="number"
                                                value={typeof formData.femaleCount === 'number' ? formData.femaleCount : (formData.femaleCount || '')}
                                                onChange={(e) => {
                                                    const v = e.target.value ? parseInt(e.target.value) : null;
                                                    const m = formData.maleCount || 0;
                                                    const u = formData.unknownCount || 0;
                                                    setFormData({...formData, femaleCount: v, litterSizeBorn: m + (v || 0) + u || null});
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                min={myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && a.gender === 'Female').length || 0}
                                            />
                                            {(() => { const lf = myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && a.gender === 'Female').length; return lf > 0 && (formData.femaleCount || 0) < lf ? (<p className="text-xs text-red-600 mt-1">? {lf} female{lf > 1 ? 's' : ''} linked � can't be below {lf}</p>) : lf > 0 ? (<p className="text-xs text-gray-500 mt-1">{lf} female{lf > 1 ? 's' : ''} linked</p>) : null; })()}
                                        </div>

                                        {/* Unknown/Intersex Count */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Unknown / Intersex</label>
                                            <input
                                                type="number"
                                                value={typeof formData.unknownCount === 'number' ? formData.unknownCount : (formData.unknownCount || '')}
                                                onChange={(e) => {
                                                    const v = e.target.value ? parseInt(e.target.value) : null;
                                                    const m = formData.maleCount || 0;
                                                    const f = formData.femaleCount || 0;
                                                    setFormData({...formData, unknownCount: v, litterSizeBorn: m + f + (v || 0) || null});
                                                }}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                min={myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && (a.gender === 'Unknown' || a.gender === 'Intersex' || !a.gender)).length || 0}
                                            />
                                            {(() => { const lu = myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && (a.gender === 'Unknown' || a.gender === 'Intersex' || !a.gender)).length; return lu > 0 && (formData.unknownCount || 0) < lu ? (<p className="text-xs text-red-600 mt-1">? {lu} unknown linked � can't be below {lu}</p>) : lu > 0 ? (<p className="text-xs text-gray-500 mt-1">{lu} unknown linked</p>) : null; })()}
                                        </div>
                                    </div>

                                    {/* Total Born (auto-computed) */}
                                    {formData.litterSizeBorn > 0 && (
                                        <div className="mt-2 p-2 rounded-md bg-green-50 border border-green-200">
                                            <p className="text-xs text-green-800">? <strong>Total Born auto-set to {formData.litterSizeBorn}</strong> ({formData.maleCount || 0}M + {formData.femaleCount || 0}F + {formData.unknownCount || 0}U)</p>
                                        </div>
                                    )}
                                </div>

                                {/* Link Existing Offspring */}
                                {formData.sireId_public && formData.damId_public && (
                                    <div className="mb-4 border-t pt-4" data-tutorial-target="litter-offspring-sections">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Link Existing Animals as Offspring
                                        </label>
                                        <div className="bg-gray-50 p-3 rounded-lg">
                                            <p className="text-xs text-gray-600 mb-3">
                                                Select animals with matching parents to link them to this litter. {formData.birthDate ? 'Only animals with matching birth date are shown.' : 'Birth date will be filled automatically from selected animals.'}
                                            </p>
                                            <div className="space-y-2">
                                                {myAnimals
                                                    .filter(animal => {
                                                        const matchesSire = animal.fatherId_public === formData.sireId_public || animal.sireId_public === formData.sireId_public;
                                                        const matchesDam = animal.motherId_public === formData.damId_public || animal.damId_public === formData.damId_public;
                                                        
                                                        // If litter has birthdate, only show animals with matching birthdate
                                                        if (formData.birthDate && animal.birthDate) {
                                                            const litterDate = formData.birthDate.split('T')[0];
                                                            const animalDate = animal.birthDate.split('T')[0];
                                                            return matchesSire && matchesDam && litterDate === animalDate;
                                                        }
                                                        
                                                        return matchesSire && matchesDam;
                                                    })
                                                    .map(animal => (
                                                        <label key={animal.id_public} className="flex items-center space-x-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={formData.linkedOffspringIds?.includes(animal.id_public)}
                                                                onChange={(e) => {
                                                                    if (e.target.checked) {
                                                                        // Check if litter has a birthdate and animal has a different birthdate
                                                                        if (formData.birthDate && animal.birthDate) {
                                                                            const litterDate = formData.birthDate.split('T')[0];
                                                                            const animalDate = animal.birthDate.split('T')[0];
                                                                            
                                                                            if (litterDate !== animalDate) {
                                                                                const confirmChange = window.confirm(
                                                                                    `This animal has a different birth date (${animalDate}) than the litter (${litterDate}).\n\n` +
                                                                                    `Click OK to update the litter birth date to match the animal's date, or Cancel to abort linking.`
                                                                                );
                                                                                
                                                                                if (!confirmChange) {
                                                                                    // User cancelled, abort the link
                                                                                    return;
                                                                                }
                                                                                
                                                                                // User accepted, update litter birthdate and link the animal
                                                                                setFormData({
                                                                                    ...formData,
                                                                                    birthDate: animalDate,
                                                                                    linkedOffspringIds: [...(formData.linkedOffspringIds || []), animal.id_public]
                                                                                });
                                                                                return;
                                                                            }
                                                                        }
                                                                        
                                                                        // Normal linking flow
                                                                        const newLinked = [...(formData.linkedOffspringIds || []), animal.id_public];
                                                                        const newFormData = { ...formData, linkedOffspringIds: newLinked };
                                                                        
                                                                        // Auto-fill birthdate from offspring if litter has no birthdate
                                                                        if (!formData.birthDate && animal.birthDate) {
                                                                            newFormData.birthDate = animal.birthDate.split('T')[0];
                                                                        }
                                                                        
                                                                        setFormData(newFormData);
                                                                    } else {
                                                                        // Unlinking
                                                                        const newLinked = (formData.linkedOffspringIds || []).filter(id => id !== animal.id_public);
                                                                        setFormData({ ...formData, linkedOffspringIds: newLinked });
                                                                    }
                                                                }}
                                                                className="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary"
                                                            />
                                                            <span className="text-sm text-gray-800">
                                                                {animal.prefix && `${animal.prefix} `}{animal.name}{animal.suffix && ` ${animal.suffix}`} - {animal.id_public} ({animal.gender}{animal.birthDate ? `, ${new Date(animal.birthDate).toLocaleDateString()}` : ''})
                                                            </span>
                                                        </label>
                                                    ))
                                                }
                                                {myAnimals.filter(animal => {
                                                    const matchesSire = animal.fatherId_public === formData.sireId_public || animal.sireId_public === formData.sireId_public;
                                                    const matchesDam = animal.motherId_public === formData.damId_public || animal.damId_public === formData.damId_public;
                                                    
                                                    // If litter has birthdate, only show animals with matching birthdate
                                                    if (formData.birthDate && animal.birthDate) {
                                                        const litterDate = formData.birthDate.split('T')[0];
                                                        const animalDate = animal.birthDate.split('T')[0];
                                                        return matchesSire && matchesDam && litterDate === animalDate;
                                                    }
                                                    
                                                    return matchesSire && matchesDam;
                                                }).length === 0 && (
                                                    <p className="text-xs text-gray-500 italic">No matching animals found</p>
                                                )}
                                                {formData.linkedOffspringIds?.length > 0 && (
                                                    <p className="text-xs text-green-600 font-semibold mt-2">
                                                        {formData.linkedOffspringIds.length} animal(s) selected
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Create New Offspring */}
                                {formData.sireId_public && formData.damId_public && formData.birthDate && (
                                    <div className="mb-4 border-t pt-4" data-tutorial-target="litter-offspring-sections">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Create New Offspring Animals
                                        </label>
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <p className="text-xs text-blue-800 mb-3">
                                                <strong>Create placeholder animals:</strong> Created with names M1, M2� / F1, F2� You can edit names and details after saving.
                                            </p>
                                            {(() => {
                                                const linkedMales = myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && a.gender === 'Male').length;
                                                const linkedFemales = myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && a.gender === 'Female').length;
                                                const linkedUnknown = myAnimals.filter(a => formData.linkedOffspringIds?.includes(a.id_public) && (a.gender === 'Unknown' || a.gender === 'Intersex' || !a.gender)).length;
                                                const totalMales = formData.maleCount || 0;
                                                const totalFemales = formData.femaleCount || 0;
                                                const totalUnknown = formData.unknownCount || 0;
                                                const remainingMales = Math.max(0, totalMales - linkedMales);
                                                const remainingFemales = Math.max(0, totalFemales - linkedFemales);
                                                const remainingUnknown = Math.max(0, totalUnknown - linkedUnknown);
                                                const hasCountInfo = totalMales > 0 || totalFemales > 0 || totalUnknown > 0;
                                                return (
                                                    <>
                                                        {hasCountInfo && (
                                                            <div className="grid grid-cols-2 gap-3 mb-3">
                                                                {totalMales > 0 && (
                                                                    <div className="bg-white rounded-lg border border-blue-200 p-3">
                                                                        <div className="flex items-center gap-1 mb-1">
                                                                            <span className="text-blue-600 font-bold text-sm">? Males</span>
                                                                        </div>
                                                                        <div className="text-xs text-gray-600 space-y-0.5">
                                                                            <div>Total set: <span className="font-semibold">{totalMales}</span></div>
                                                                            <div>Already linked: <span className="font-semibold">{linkedMales}</span></div>
                                                                            <div>Remaining: <span className={`font-bold ${remainingMales > 0 ? 'text-blue-600' : 'text-green-600'}`}>{remainingMales}</span></div>
                                                                        </div>
                                                                        {remainingMales > 0 && (
                                                                            <button
                                                                                type="button"
                                                                                onClick={() => setCreateOffspringCounts(c => ({...c, males: remainingMales.toString()}))}
                                                                                className="mt-2 w-full px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs font-semibold rounded transition"
                                                                            >
                                                                                + Add {remainingMales} remaining male{remainingMales > 1 ? 's' : ''}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {totalFemales > 0 && (
                                                                    <div className="bg-white rounded-lg border border-pink-200 p-3">
                                                                        <div className="flex items-center gap-1 mb-1">
                                                                            <span className="text-pink-600 font-bold text-sm">? Females</span>
                                                                        </div>
                                                                        <div className="text-xs text-gray-600 space-y-0.5">
                                                                            <div>Total set: <span className="font-semibold">{totalFemales}</span></div>
                                                                            <div>Already linked: <span className="font-semibold">{linkedFemales}</span></div>
                                                                            <div>Remaining: <span className={`font-bold ${remainingFemales > 0 ? 'text-pink-600' : 'text-green-600'}`}>{remainingFemales}</span></div>
                                                                        </div>
                                                                        {remainingFemales > 0 && (
                                                                            <button
                                                                                type="button"
                                                                                onClick={() => setCreateOffspringCounts(c => ({...c, females: remainingFemales.toString()}))}
                                                                                className="mt-2 w-full px-2 py-1 bg-pink-100 hover:bg-pink-200 text-pink-800 text-xs font-semibold rounded transition"
                                                                            >
                                                                                + Add {remainingFemales} remaining female{remainingFemales > 1 ? 's' : ''}
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                        {hasCountInfo && (remainingMales > 0 || remainingFemales > 0 || remainingUnknown > 0) && (
                                                            <button
                                                                type="button"
                                                                onClick={() => setCreateOffspringCounts({ males: remainingMales.toString(), females: remainingFemales.toString(), unknown: remainingUnknown.toString() })}
                                                                className="w-full mb-3 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded-lg transition"
                                                            >
                                                                Fill all remaining ({remainingMales}M + {remainingFemales}F + {remainingUnknown}U = {remainingMales + remainingFemales + remainingUnknown} animals)
                                                            </button>
                                                        )}
                                                        {!hasCountInfo && (
                                                            <p className="text-xs text-gray-500 italic">Set the male, female, and unknown counts above to see smart creation options.</p>
                                                        )}
                                                        {hasCountInfo && remainingMales === 0 && remainingFemales === 0 && remainingUnknown === 0 && (
                                                            <p className="text-xs text-green-600 font-semibold">? All offspring are accounted for via linked animals.</p>
                                                        )}
                                                        {(parseInt(createOffspringCounts.males || 0) > 0 || parseInt(createOffspringCounts.females || 0) > 0 || parseInt(createOffspringCounts.unknown || 0) > 0) && (
                                                            <p className="text-xs text-green-600 font-semibold mt-2">
                                                                Will create {(parseInt(createOffspringCounts.males || 0)) + (parseInt(createOffspringCounts.females || 0)) + (parseInt(createOffspringCounts.unknown || 0))} new animal(s)
                                                            </p>
                                                        )}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                )}

                                {/* Notes */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Notes
                                    </label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                        rows="3"
                                        placeholder="Additional notes about this litter..."
                                    />
                                </div>
                            </form>
                    </div>

                    <div className="border-t p-4 flex gap-3 justify-end">
                        <button
                            type="button"
                            onClick={() => {
                                setShowAddForm(false);
                                setEditingLitter(null);
                            }}
                            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            form="litter-form"
                            data-tutorial-target="create-litter-btn"
                            className="bg-primary hover:bg-primary/90 text-black font-bold py-2 px-6 rounded-lg"
                        >
                            {editingLitter ? 'Update Litter' : 'Create Litter'}
                        </button>
                    </div>
                </div>
            </div>
            )}

            {/* Litter List */}
            <div className="space-y-4">
                {/* Search Bar */}
                {litters.length > 0 && (
                    <div className="bg-gray-50 p-2 sm:p-4 rounded-lg border-2 border-gray-200 space-y-2 sm:space-y-3">
                        <div className="relative">
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4 sm:w-5 sm:h-5" />
                            <input
                                type="text"
                                placeholder="Search litters..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-1.5 sm:py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            />
                        </div>
                        
                        {/* Species filter */}
                        <div className="flex flex-wrap gap-3 items-center pt-2 border-t border-gray-200">
                            <div className="flex items-center gap-2">
                                <label htmlFor="litter-species-filter" className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Species:</label>
                                <select
                                    id="litter-species-filter"
                                    value={speciesFilter}
                                    onChange={(e) => setSpeciesFilter(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
                                >
                                    <option value="">All Species</option>
                                    {DEFAULT_SPECIES_OPTIONS.map(species => (
                                        <option key={species} value={species}>
                                            {getSpeciesDisplayName(species)}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                <label htmlFor="litter-year-filter" className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Year:</label>
                                <select
                                    id="litter-year-filter"
                                    value={yearFilter}
                                    onChange={(e) => setYearFilter(e.target.value)}
                                    className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
                                    disabled={availableYears.length === 0}
                                >
                                    <option value="">All Years</option>
                                    {availableYears.map(year => (
                                        <option key={year} value={year.toString()}>
                                            {year}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>
                )}

                {filteredLitters.length === 0 && litters.length > 0 ? (
                    <div className="text-center py-12 bg-gray-50 rounded-lg">
                        <Search size={48} className="text-gray-400 mx-auto mb-4" />
                        <p className="text-gray-600">No litters match your search.</p>
                    </div>
                ) : filteredLitters.length === 0 ? (
                    <div className="text-center py-12 bg-gray-50 rounded-lg">
                        <BookOpen size={48} className="text-gray-400 mx-auto mb-4" />
                        <p className="text-gray-600">No litters yet. Create your first litter above!</p>
                    </div>
                ) : (
                    filteredLitters.map(litter => {
                        // Use parent data from litter object (includes transferred/hidden animals)
                        const sire = litter.sire || myAnimals.find(a => a.id_public === litter.sireId_public);
                        const dam = litter.dam || myAnimals.find(a => a.id_public === litter.damId_public);
                        const isExpanded = expandedLitter === litter._id;
                        const offspringList = myAnimals.filter(a => 
                            litter.offspringIds_public && litter.offspringIds_public.includes(a.id_public)
                        );
                        
                        return (
                            <div key={litter._id} className="border-2 border-gray-200 rounded-lg bg-white hover:shadow-md transition" data-tutorial-target="litter-card">
                                {/* Compact Header - Always Visible */}
                                <div 
                                    className="p-2 sm:p-3 cursor-pointer flex items-center justify-between hover:bg-gray-50"
                                    onClick={() => setExpandedLitter(isExpanded ? null : litter._id)}
                                >
                                    {/* Mobile layout: stacked info */}
                                    <div className="flex-1 sm:hidden">
                                        <div className="flex justify-between items-start mb-1">
                                            <div className="flex-1">
                                                <p className="font-bold text-gray-800 text-sm">
                                                    {litter.litter_id_public && <span className="text-xs font-mono bg-gray-100 px-1.5 py-0.5 rounded mr-2">{litter.litter_id_public}</span>}
                                                    {litter.breedingPairCodeName && <span className="truncate">{litter.breedingPairCodeName}</span>}
                                                    {!litter.breedingPairCodeName && !litter.litter_id_public && <span>Unnamed Litter</span>}
                                                </p>
                                            </div>
                                            <span className="text-xs font-semibold text-gray-700 ml-2">{litter.numberBorn} pups</span>
                                        </div>
                                        <div className="flex gap-3 text-xs text-gray-600">
                                            <span><span className="font-medium">S:</span> {sire ? `${sire.prefix ? `${sire.prefix} ` : ''}${sire.name}${sire.suffix ? ` ${sire.suffix}` : ''}` : litter.sireId_public}</span>
                                            <span><span className="font-medium">D:</span> {dam ? `${dam.prefix ? `${dam.prefix} ` : ''}${dam.name}${dam.suffix ? ` ${dam.suffix}` : ''}` : litter.damId_public}</span>
                                        </div>
                                        <p className="text-[10px] text-gray-500 mt-0.5">
                                            {formatDate(litter.birthDate)}
                                        </p>
                                        {litter.inbreedingCoefficient != null && (
                                            <p className="text-[10px] text-gray-500 mt-0.5">
                                                <span className="font-medium">COI:</span> {litter.inbreedingCoefficient.toFixed(2)}%
                                            </p>
                                        )}
                                    </div>
                                    
                                    {/* Desktop layout: grid */}
                                    <div className="hidden sm:grid flex-1 grid-cols-3 md:grid-cols-5 gap-2 items-center">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                {litter.litter_id_public && <span className="text-xs font-mono bg-gray-100 px-2 py-1 rounded">{litter.litter_id_public}</span>}
                                                <p className="font-bold text-gray-800 text-base truncate">
                                                    {litter.breedingPairCodeName || (litter.litter_id_public ? '' : 'Unnamed Litter')}
                                                </p>
                                            </div>
                                            <p className="text-xs text-gray-500">
                                                {formatDate(litter.birthDate)}
                                            </p>
                                        </div>
                                        <div className="text-sm truncate">
                                            <span className="text-gray-600">Sire:</span> {sire ? `${sire.prefix ? `${sire.prefix} ` : ''}${sire.name}${sire.suffix ? ` ${sire.suffix}` : ''}` : litter.sireId_public}
                                        </div>
                                        <div className="text-sm truncate">
                                            <span className="text-gray-600">Dam:</span> {dam ? `${dam.prefix ? `${dam.prefix} ` : ''}${dam.name}${dam.suffix ? ` ${dam.suffix}` : ''}` : litter.damId_public}
                                        </div>
                                        <div className="text-sm font-semibold text-gray-700">
                                            {litter.numberBorn} offspring
                                        </div>
                                        <div className="text-sm">
                                            <span className="text-gray-600">COI:</span> {litter.inbreedingCoefficient != null ? `${litter.inbreedingCoefficient.toFixed(2)}%` : 'N/A'}
                                        </div>
                                    </div>
                                    <ChevronLeft 
                                        size={20} 
                                        className={`text-gray-400 transition-transform flex-shrink-0 ml-2 ${isExpanded ? '-rotate-90' : 'rotate-180'}`}
                                    />
                                </div>

                                {/* Expanded Details */}
                                {isExpanded && (
                                    <div className="border-t-2 border-gray-200 p-2 sm:p-4 bg-gray-50">
                                        <div className="flex flex-wrap justify-end gap-1 sm:gap-2 mb-3 sm:mb-4">
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleEditLitter(litter);
                                                }}
                                                className="flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold px-2 sm:px-3 py-1 sm:py-2 rounded-lg text-xs sm:text-sm"
                                            >
                                                <Edit className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                <span className="hidden sm:inline">Edit</span>
                                            </button>
                                            <button
                                                onClick={() => handleLinkAnimals(litter)}
                                                data-tutorial-target="link-animals-btn"
                                                className="flex items-center gap-1 bg-primary hover:bg-primary/90 text-black font-semibold px-2 sm:px-3 py-1 sm:py-2 rounded-lg text-xs sm:text-sm"
                                            >
                                                <Link className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                <span className="hidden sm:inline">Link</span>
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDeleteLitter(litter._id);
                                                }}
                                                className="flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white font-semibold px-2 sm:px-3 py-1 sm:py-2 rounded-lg text-xs sm:text-sm"
                                            >
                                                <Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                <span className="hidden sm:inline">Delete</span>
                                            </button>
                                        </div>

                                        {/* Litter Info Grid */}
                                        {((litter.matingDate || litter.pairingDate) || litter.breedingMethod || litter.breedingCondition || litter.breedingConditionAtTime || litter.outcome || litter.maleCount != null || litter.femaleCount != null) && (
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-4">
                                                {(litter.matingDate || litter.pairingDate) && (<div><div className="text-gray-500 text-xs">Mating Date</div><div className="font-semibold text-gray-800">{formatDate(litter.matingDate || litter.pairingDate)}</div></div>)}
                                                {litter.breedingMethod && (<div><div className="text-gray-500 text-xs">Breeding Method</div><div className="font-semibold text-gray-800">{litter.breedingMethod}</div></div>)}
                                                {(litter.breedingCondition || litter.breedingConditionAtTime) && (<div><div className="text-gray-500 text-xs">Breeding Condition</div><div className="font-semibold text-gray-800">{litter.breedingCondition || litter.breedingConditionAtTime}</div></div>)}
                                                {litter.outcome && (<div><div className="text-gray-500 text-xs">Outcome</div><div className={`font-semibold ${litter.outcome === 'Successful' ? 'text-green-600' : litter.outcome === 'Unsuccessful' ? 'text-red-600' : 'text-gray-800'}`}>{litter.outcome}</div></div>)}
                                                {litter.maleCount != null && (<div><div className="text-gray-500 text-xs">Males</div><div className="font-semibold text-blue-600">{litter.maleCount}</div></div>)}
                                                {litter.femaleCount != null && (<div><div className="text-gray-500 text-xs">Females</div><div className="font-semibold text-pink-600">{litter.femaleCount}</div></div>)}
                                                {litter.unknownCount != null && litter.unknownCount > 0 && (<div><div className="text-gray-500 text-xs">Unknown / Intersex</div><div className="font-semibold text-gray-700">{litter.unknownCount}</div></div>)}
                                            </div>
                                        )}

                                        {litter.notes && (
                                            <div className="bg-white rounded-lg p-3 mb-4 border border-gray-200">
                                                <p className="text-sm font-semibold text-gray-700 mb-1">Notes</p>
                                                <p className="text-sm text-gray-600 italic">{litter.notes}</p>
                                            </div>
                                        )}

                                        {/* Parent Cards */}
                                        <div className="mb-4">
                                            <h4 className="text-sm font-bold text-gray-700 mb-2">Parents</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {/* Sire Card */}
                                                {sire && (
                                                    <div 
                                                        onClick={sire.isTransferred ? undefined : () => onViewAnimal(sire)}
                                                        className={`relative bg-white rounded-lg shadow-sm border border-gray-300 p-3 flex items-center gap-3 ${sire.isTransferred ? 'opacity-75' : 'cursor-pointer hover:shadow-md'} transition`}
                                                    >
                                                        <div className="w-20 h-20 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
                                                            {sire.imageUrl || sire.photoUrl ? (
                                                                <img src={sire.imageUrl || sire.photoUrl} alt={sire.name} className="w-full h-full object-cover" />
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                                    <Cat size={32} />
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-1 mb-1">
                                                                <Mars size={14} className="text-primary flex-shrink-0" />
                                                                <p className="font-bold text-gray-800 truncate">
                                                                    {sire.prefix ? `${sire.prefix} ` : ''}{sire.name}{sire.suffix ? ` ${sire.suffix}` : ''}
                                                                </p>
                                                            </div>
                                                            <p className="text-xs text-gray-500">{sire.id_public}</p>
                                                            <p className="text-xs text-gray-600">{sire.species}</p>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Dam Card */}
                                                {dam && (
                                                    <div 
                                                        onClick={dam.isTransferred ? undefined : () => onViewAnimal(dam)}
                                                        className={`relative bg-white rounded-lg shadow-sm border border-gray-300 p-3 flex items-center gap-3 ${dam.isTransferred ? 'opacity-75' : 'cursor-pointer hover:shadow-md'} transition`}
                                                    >
                                                        <div className="w-20 h-20 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
                                                            {dam.imageUrl || dam.photoUrl ? (
                                                                <img src={dam.imageUrl || dam.photoUrl} alt={dam.name} className="w-full h-full object-cover" />
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                                    <Cat size={32} />
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-1 mb-1">
                                                                <Venus size={14} className="text-accent flex-shrink-0" />
                                                                <p className="font-bold text-gray-800 truncate">
                                                                    {dam.prefix ? `${dam.prefix} ` : ''}{dam.name}{dam.suffix ? ` ${dam.suffix}` : ''}
                                                                </p>
                                                            </div>
                                                            <p className="text-xs text-gray-500">{dam.id_public}</p>
                                                            <p className="text-xs text-gray-600">{dam.species}</p>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Offspring Cards */}
                                        {offspringList.length > 0 && (
                                            <div className="mb-4">
                                                <div className="flex items-center justify-between mb-2">
                                                    <h4 className="text-sm font-bold text-gray-700">Offspring ({offspringList.length})</h4>
                                                    <div className="flex items-center gap-2">
                                                        {bulkDeleteMode[litter._id] && (
                                                            <>
                                                                <span className="text-sm text-gray-600">
                                                                    {(selectedOffspring[litter._id] || []).length} selected
                                                                </span>
                                                                <button
                                                                    onClick={() => handleBulkDeleteOffspring(litter._id)}
                                                                    disabled={(selectedOffspring[litter._id] || []).length === 0}
                                                                    className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                                                                >
                                                                    Delete Selected
                                                                </button>
                                                                <button
                                                                    onClick={() => toggleBulkDeleteMode(litter._id)}
                                                                    className="px-3 py-1 bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold rounded-lg transition"
                                                                >
                                                                    Cancel
                                                                </button>
                                                            </>
                                                        )}
                                                        {!bulkDeleteMode[litter._id] && (
                                                            <button
                                                                onClick={() => toggleBulkDeleteMode(litter._id)}
                                                                className="p-2 hover:bg-gray-200 rounded-lg transition"
                                                                title="Delete Multiple"
                                                            >
                                                                <Trash2 size={18} className="text-red-500" />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                                    {offspringList.map(animal => {
                                                        const isBulkMode = bulkDeleteMode[litter._id] || false;
                                                        const isSelected = (selectedOffspring[litter._id] || []).includes(animal.id_public);
                                                        
                                                        return (
                                                        <div
                                                            key={animal.id_public}
                                                            onClick={() => {
                                                                if (isBulkMode) {
                                                                    toggleOffspringSelection(litter._id, animal.id_public);
                                                                } else {
                                                                    onViewAnimal(animal);
                                                                }
                                                            }}
                                                            className={`relative bg-white rounded-lg shadow-sm h-52 flex flex-col items-center overflow-hidden cursor-pointer hover:shadow-md transition border-2 pt-2 ${
                                                                isSelected ? 'border-red-500' : 'border-gray-300'
                                                            }`}
                                                        >
                                                            {isBulkMode && (
                                                                <div className="absolute top-2 left-2 z-10" onClick={(e) => e.stopPropagation()}>
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={isSelected}
                                                                        onChange={() => toggleOffspringSelection(litter._id, animal.id_public)}
                                                                        className="w-5 h-5 cursor-pointer"
                                                                    />
                                                                </div>
                                                            )}
                                                            {/* Gender badge top-right */}
                                                            {animal.gender && (
                                                                <div className="absolute top-1.5 right-1.5">
                                                                    {animal.gender === 'Male' 
                                                                        ? <Mars size={14} strokeWidth={2.5} className="text-primary" /> 
                                                                        : <Venus size={14} strokeWidth={2.5} className="text-accent" />
                                                                    }
                                                                </div>
                                                            )}

                                                            {/* Profile image */}
                                                            <div className="flex-1 flex items-center justify-center w-full px-2 mt-1">
                                                                {animal.imageUrl || animal.photoUrl ? (
                                                                    <img 
                                                                        src={animal.imageUrl || animal.photoUrl} 
                                                                        alt={animal.name} 
                                                                        className="w-20 h-20 object-cover rounded-md" 
                                                                    />
                                                                ) : (
                                                                    <div className="w-20 h-20 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                                        <Cat size={32} />
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Icon row */}
                                                            <div className="w-full flex justify-center items-center space-x-2 py-1">
                                                                {animal.isOwned ? (
                                                                    <Heart size={12} className="text-black" />
                                                                ) : (
                                                                    <HeartOff size={12} className="text-black" />
                                                                )}
                                                                {animal.showOnPublicProfile || animal.isDisplay ? (
                                                                    <Eye size={12} className="text-black" />
                                                                ) : (
                                                                    <EyeOff size={12} className="text-black" />
                                                                )}
                                                                {animal.isInMating && <Hourglass size={12} className="text-black" />}
                                                                {animal.isPregnant && <Bean size={12} className="text-black" />}
                                                                {animal.isNursing && <Milk size={12} className="text-black" />}
                                                            </div>
                                                            
                                                            {/* Name */}
                                                            <div className="w-full text-center px-2 pb-1">
                                                                <div className="text-sm font-semibold text-gray-800 truncate">
                                                                    {animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}
                                                                </div>
                                                            </div>

                                                            {/* ID bottom-right */}
                                                            <div className="w-full px-2 pb-2 flex justify-end">
                                                                <div className="text-xs text-gray-500">{animal.id_public}</div>
                                                            </div>
                                                            
                                                            {/* Status bar */}
                                                            <div className="w-full bg-gray-100 py-1 text-center border-t border-gray-300 mt-auto">
                                                                <div className="text-xs font-medium text-gray-700">{animal.status || 'Unknown'}</div>
                                                            </div>
                                                        </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}

                                        {/* Add Offspring Section */}
                                        {addingOffspring && addingOffspring._id === litter._id ? (
                                            <div className="bg-white rounded-lg border-2 border-primary p-4">
                                                <h4 className="text-sm font-bold text-gray-700 mb-3">Add New Offspring</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Name *</label>
                                                        <input
                                                            type="text"
                                                            value={newOffspringData.name}
                                                            onChange={(e) => setNewOffspringData({...newOffspringData, name: e.target.value})}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                            placeholder="Enter name"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Gender *</label>
                                                        <select
                                                            value={newOffspringData.gender}
                                                            onChange={(e) => setNewOffspringData({...newOffspringData, gender: e.target.value})}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                        >
                                                            <option value="">Select gender</option>
                                                            <option value="Male">Male</option>
                                                            <option value="Female">Female</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Color</label>
                                                        <input
                                                            type="text"
                                                            value={newOffspringData.color}
                                                            onChange={(e) => setNewOffspringData({...newOffspringData, color: e.target.value})}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                            placeholder="Optional"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Coat</label>
                                                        <input
                                                            type="text"
                                                            value={newOffspringData.coat}
                                                            onChange={(e) => setNewOffspringData({...newOffspringData, coat: e.target.value})}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                            placeholder="Optional"
                                                        />
                                                    </div>
                                                    <div className="md:col-span-2">
                                                        <label className="block text-sm font-semibold text-gray-700 mb-1">Remarks</label>
                                                        <textarea
                                                            value={newOffspringData.remarks}
                                                            onChange={(e) => setNewOffspringData({...newOffspringData, remarks: e.target.value})}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                                                            rows="2"
                                                            placeholder="Optional notes"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="text-xs text-gray-500 mb-3">
                                                    Autofilled: Species ({sire?.species}), Birth Date ({formatDate(litter.birthDate)}), Parents ({litter.sireId_public} � {litter.damId_public})
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={handleSaveNewOffspring}
                                                        className="flex items-center gap-1 bg-primary hover:bg-primary/90 text-black font-semibold px-4 py-2 rounded-lg"
                                                    >
                                                        <Plus size={16} />
                                                        Save Offspring
                                                    </button>
                                                    <button
                                                        onClick={() => setAddingOffspring(null)}
                                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => handleAddOffspringToLitter(litter)}
                                                className="flex items-center gap-1 bg-accent hover:bg-accent/90 text-white font-semibold px-3 py-2 rounded-lg text-sm"
                                            >
                                                <Plus size={16} />
                                                Add Offspring
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })
                )}
            </div>

            {/* Link Animals Modal */}
            {linkingAnimals && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center border-b p-4">
                            <h3 className="text-xl font-bold text-gray-800">Link Animals to Litter</h3>
                            <button onClick={() => setLinkingAnimals(false)} className="text-gray-500 hover:text-gray-800">
                                <X size={24} />
                            </button>
                        </div>

                        <div className="flex-grow overflow-y-auto p-4">
                            {availableToLink.animals && availableToLink.animals.length === 0 ? (
                                <p className="text-center text-gray-500 py-8">No unlinked animals found with matching parents and birth date.</p>
                            ) : (
                                <div className="space-y-2">
                                    <p className="text-sm text-gray-600 mb-4">
                                        Found {availableToLink.animals?.length || 0} unlinked animal(s) with matching parents and birth date:
                                    </p>
                                    {availableToLink.animals?.map(animal => (
                                        <div key={animal.id_public} className="border rounded-lg p-3 flex justify-between items-center">
                                            <div>
                                                <p className="font-semibold">
                                                    {animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}
                                                </p>
                                                <p className="text-sm text-gray-600">
                                                    {animal.id_public} &bull; {animal.gender} &bull; {animal.species}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => handleAddToLitter(animal.id_public)}
                                                className="bg-primary hover:bg-primary/90 text-black font-semibold px-3 py-1 rounded text-sm"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 space-y-2">
                            {availableToLink.animals && availableToLink.animals.length > 0 && (
                                <button
                                    onClick={handleAddAllToLitter}
                                    className="w-full bg-primary hover:bg-primary/90 text-black font-semibold py-2 px-4 rounded-lg"
                                >
                                    Add All ({availableToLink.animals.length})
                                </button>
                            )}
                            <button
                                onClick={() => setLinkingAnimals(false)}
                                className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Sire Modal */}
            {modalTarget === 'sire-litter' && (
                <LocalAnimalSearchModal
                    title="Select Sire"
                    onSelect={handleSelectOtherParentForLitter}
                    onClose={() => setModalTarget(null)}
                    authToken={authToken}
                    showModalMessage={showModalMessage}
                    API_BASE_URL={API_BASE_URL}
                    X={X}
                    Search={Search}
                    Loader2={Loader2}
                    LoadingSpinner={LoadingSpinner}
                    genderFilter={['Male', 'Intersex', 'Unknown']}
                />
            )}

            {/* Dam Modal */}
            {modalTarget === 'dam-litter' && (
                <LocalAnimalSearchModal
                    title="Select Dam"
                    onSelect={handleSelectOtherParentForLitter}
                    onClose={() => setModalTarget(null)}
                    authToken={authToken}
                    showModalMessage={showModalMessage}
                    API_BASE_URL={API_BASE_URL}
                    X={X}
                    Search={Search}
                    Loader2={Loader2}
                    LoadingSpinner={LoadingSpinner}
                    genderFilter={['Female', 'Intersex', 'Unknown']}
                />
            )}
        </div>
    );
};


const SpeciesManager = ({ speciesOptions, setSpeciesOptions, onCancel, showModalMessage, authToken, API_BASE_URL }) => {
    const [newSpeciesName, setNewSpeciesName] = useState('');
    const [newSpeciesLatinName, setNewSpeciesLatinName] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('Other');
    const [searchTerm, setSearchTerm] = useState('');
    const [categoryFilter, setCategoryFilter] = useState('All');
    const [loading, setLoading] = useState(false);
    const [showFeedbackModal, setShowFeedbackModal] = useState(false);
    const [feedbackSpecies, setFeedbackSpecies] = useState('');
    const [feedbackText, setFeedbackText] = useState('');
    const [feedbackSubmitting, setFeedbackSubmitting] = useState(false);
    
    const categories = ['Mammal', 'Reptile', 'Bird', 'Amphibian', 'Fish', 'Invertebrate', 'Other'];
    
    // const customSpecies = speciesOptions.filter(s => !s.isDefault);
    // const defaultSpecies = speciesOptions.filter(s => s.isDefault);
    
    // Filter species by category and search
    const filteredSpecies = speciesOptions.filter(s => {
        const matchesCategory = categoryFilter === 'All' || (s.category && s.category === categoryFilter);
        const matchesSearch = !searchTerm || (s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase()));
        return matchesCategory && matchesSearch;
    });
    
    const handleAddSpecies = async (e) => {
        e.preventDefault();
        const trimmedName = newSpeciesName.trim();
        if (!trimmedName) return;
        
        setLoading(true);
        try {
            const response = await axios.post(
                `${API_BASE_URL}/species`,
                { 
                    name: trimmedName, 
                    latinName: newSpeciesLatinName.trim() || null,
                    category: selectedCategory 
                },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            // Add to local state
            setSpeciesOptions(prev => [...prev, response.data.species]);
            setNewSpeciesName('');
            setNewSpeciesLatinName('');
            showModalMessage('Success', `Species "${trimmedName}" added and is now available to all users!`);
        } catch (error) {
            if (error.response?.status === 409) {
                showModalMessage('Already Exists', `Species "${error.response.data.existing?.name || trimmedName}" already exists.`);
            } else {
                console.error('Failed to add species:', error);
                showModalMessage('Error', 'Failed to add species. Please try again.');
            }
        } finally {
            setLoading(false);
        }
    };

    const handleSubmitFeedback = async (e) => {
        e.preventDefault();
        if (!feedbackSpecies || !feedbackText.trim()) return;
        
        setFeedbackSubmitting(true);
        try {
            await axios.post(
                `${API_BASE_URL}/feedback/species`,
                {
                    species: feedbackSpecies,
                    feedback: feedbackText.trim(),
                    type: 'species-customization'
                },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            showModalMessage('Feedback Sent', 'Thank you! Your feedback will help us improve species customization.');
            setShowFeedbackModal(false);
            setFeedbackSpecies('');
            setFeedbackText('');
        } catch (error) {
            console.error('Failed to submit feedback:', error);
            showModalMessage('Error', 'Failed to submit feedback. Please try again.');
        } finally {
            setFeedbackSubmitting(false);
        }
    };

    return (
        <div className="w-full max-w-3xl bg-white p-6 rounded-xl shadow-lg">
            <div className="flex justify-between items-start mb-6">
                <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                    <Settings size={20} className="mr-2 text-primary-dark" />
                    Manage Species (Global for All Users)
                </h2>
                <button
                    onClick={onCancel}
                    data-tutorial-target="back-to-selector-btn"
                    className="flex items-center text-gray-600 hover:text-gray-800 transition"
                >
                    <ArrowLeft size={18} className="mr-1" /> Back
                </button>
            </div>

            <form onSubmit={handleAddSpecies} className="mb-6 p-3 sm:p-4 border rounded-lg bg-gray-50 space-y-3 overflow-x-hidden">
                <div className="flex flex-col space-y-2 min-w-0">
                    <div className="flex flex-col sm:flex-row gap-2 sm:space-x-3">
                        <input
                            type="text"
                            placeholder="Enter species name..."
                            value={newSpeciesName}
                            onChange={(e) => setNewSpeciesName(e.target.value)}
                            required
                            disabled={loading}
                            data-tutorial-target="species-name-input"
                            className="flex-grow p-2 border border-gray-300 rounded-lg box-border min-w-0"
                        />
                        <select
                            value={selectedCategory}
                            onChange={(e) => setSelectedCategory(e.target.value)}
                            disabled={loading}
                            data-tutorial-target="species-category-dropdown"
                            className="p-2 border border-gray-300 rounded-lg box-border sm:flex-shrink-0 sm:w-auto w-full"
                        >
                            {categories.map(cat => (
                                <option key={cat} value={cat}>{cat}</option>
                            ))}
                        </select>
                    </div>
                    <input
                        type="text"
                        placeholder="Enter latin/scientific name... (optional, e.g., Mus musculus)"
                        value={newSpeciesLatinName}
                        onChange={(e) => setNewSpeciesLatinName(e.target.value)}
                        disabled={loading}
                        data-tutorial-target="species-latin-input"
                        className="w-full p-2 border border-gray-300 rounded-lg"
                    />
                </div>
                <div className="flex gap-3">
                    <button
                        type="submit"
                        disabled={loading}
                        className="bg-primary hover:bg-primary-dark text-black font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center disabled:opacity-50"
                    >
                        {loading ? <Loader2 className="animate-spin" size={18} /> : <PlusCircle size={18} className="mr-2" />}
                        {loading ? 'Adding...' : 'Add'}
                    </button>
                </div>
                <p className="text-xs text-gray-500">🌍 Species you add will be available to all users globally! Include the scientific name if known. </p>
            </form>

            <div className="mb-4 flex flex-col sm:flex-row gap-2 sm:space-x-3 overflow-x-hidden">
                <input
                    type="text"
                    placeholder="Search species..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-grow p-2 border border-gray-300 rounded-lg box-border min-w-0"
                />
                <select
                    value={categoryFilter}
                    onChange={(e) => setCategoryFilter(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg box-border sm:flex-shrink-0 sm:w-auto w-full"
                >
                    <option value="All">All Categories</option>
                    {categories.map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                    ))}
                </select>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto">
                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">Available Species ({filteredSpecies.length})</h3>
                
                {filteredSpecies.length === 0 ? (
                    <p className="text-sm text-gray-500 p-2">No species found matching your filters.</p>
                ) : (
                    filteredSpecies.map(species => (
                        <div key={species._id || species.name} className="flex justify-between items-center p-3 border rounded-lg bg-white shadow-sm">
                            <div>
                                <span className="font-medium text-gray-800">{species.name}</span>
                                {species.latinName && (
                                    <div className="text-xs italic text-gray-600">{species.latinName}</div>
                                )}
                                <span className="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">{species.category}</span>
                                {species.isDefault && <span className="ml-2 text-xs bg-primary text-black px-2 py-1 rounded">Default</span>}
                            </div>
                            {species.isDefault ? (
                                <span className="text-sm text-gray-400">🔒 Locked</span>
                            ) : (
                                <span className="text-xs text-gray-500">Added by community</span>
                            )}
                        </div>
                    ))
                )}
            </div>
            
            <div className="mt-6 border-t pt-4">
                <button
                    onClick={() => setShowFeedbackModal(true)}
                    className="flex items-center text-purple-600 hover:text-purple-700 transition font-medium"
                >
                    <Mail size={18} className="mr-1" /> Request Species Customization
                </button>
            </div>

            {/* Feedback Modal */}
            {showFeedbackModal && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">Request Species Customization</h3>
                        <p className="text-sm text-gray-600 mb-4">
                            Let us know if a species needs different or additional fields (e.g., "Morph" instead of "Color/Coat" for snakes, or missing fields like "Pattern")
                        </p>
                        
                        <form onSubmit={handleSubmitFeedback} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Species</label>
                                <select
                                    value={feedbackSpecies}
                                    onChange={(e) => setFeedbackSpecies(e.target.value)}
                                    required
                                    className="w-full p-2 border border-gray-300 rounded-lg"
                                >
                                    <option value="">Select a species...</option>
                                    {speciesOptions.map(s => (
                                        <option key={s._id || s.name} value={s.name}>{s.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    What fields need to be different or added?
                                </label>
                                <textarea
                                    value={feedbackText}
                                    onChange={(e) => setFeedbackText(e.target.value)}
                                    required
                                    rows={4}
                                    placeholder='Example: For snakes, replace "Color" and "Coat" with "Morph", and add a "Pattern" field'
                                    className="w-full p-2 border border-gray-300 rounded-lg"
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setShowFeedbackModal(false);
                                        setFeedbackSpecies('');
                                        setFeedbackText('');
                                    }}
                                    className="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={feedbackSubmitting}
                                    className="flex-1 px-4 py-2 bg-accent hover:bg-accent/80 text-white rounded-lg transition disabled:opacity-50 flex items-center justify-center"
                                >
                                    {feedbackSubmitting ? <Loader2 className="animate-spin mr-2" size={18} /> : <Mail size={18} className="mr-2" />}
                                    {feedbackSubmitting ? 'Sending...' : 'Send Feedback'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};

const SpeciesSelector = ({ speciesOptions, onSelectSpecies, onManageSpecies, searchTerm, setSearchTerm, categoryFilter, setCategoryFilter }) => {
    const categories = ['All', 'Mammal', 'Reptile', 'Bird', 'Amphibian', 'Fish', 'Invertebrate', 'Other'];
    
    // Filter species by category and search
    const filteredSpecies = speciesOptions.filter(s => {
        const matchesCategory = categoryFilter === 'All' || s.category === categoryFilter;
        const matchesSearch = !searchTerm || s.name.toLowerCase().includes(searchTerm.toLowerCase());
        return matchesCategory && matchesSearch;
    });
    
    // Sort: defaults first, then alphabetical
    const sortedSpecies = [...filteredSpecies].sort((a, b) => {
        if (a.isDefault && !b.isDefault) return -1;
        if (!a.isDefault && b.isDefault) return 1;
        return a.name.localeCompare(b.name);
    });
    
    return (
        <div className="w-full max-w-5xl bg-white p-6 rounded-xl shadow-lg" data-tutorial-target="species-selector">
            <h2 className="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <Cat size={24} className="mr-3 text-primary-dark" />
                Select Species for New Animal
            </h2>
            
            <div className="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
                <p className="text-sm text-yellow-800">
                    <span className="font-semibold">🚧 Work in Progress:</span> Some default species are intentionally broad ? for example, <span className="italic">Theraphosidae sp.</span> covers the family as a whole. We encourage adding and using your specific species where possible: e.g. <span className="italic">(Theraphosidae) Poecilotheria metallica</span> or <span className="italic">(Theraphosidae) Brachypelma hamorii</span>. Don't see fields you need? You can request them to be added through the species customisomisation!
                </p>
            </div>
            
            <div className="mb-4 flex space-x-3" data-tutorial-target="species-search-section">
                <input
                    type="text"
                    placeholder="Search species..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 p-2 border border-gray-300 rounded-lg"
                    data-tutorial-target="species-search-input"
                />
                <select
                    value={categoryFilter}
                    onChange={(e) => setCategoryFilter(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg w-40 flex-shrink-0"
                >
                    {categories.map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                    ))}
                </select>
            </div>
            
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6 max-h-96 overflow-y-auto" data-tutorial-target="default-species-section">
                {sortedSpecies.length === 0 ? (
                    <p className="col-span-full text-center text-gray-500 p-4">No species found matching your filters.</p>
                ) : (
                    sortedSpecies.map(species => (
                        <button
                            key={species._id || species.name}
                            onClick={() => onSelectSpecies(species.name)}
                            data-tutorial-target={species.name === 'Fancy Mouse' ? 'species-fancy-mouse' : undefined}
                            className={`p-6 border-2 text-lg font-semibold rounded-lg transition duration-150 shadow-md relative text-center ${
                                species.isDefault 
                                    ? 'border-primary-dark bg-primary text-gray-800 hover:bg-primary/80' 
                                    : 'border-accent bg-accent text-white hover:bg-accent/80'
                            }`}
                        >
                            {species.name}
                            {species.latinName && (
                                <p className={`text-xs italic mt-1 ${species.isDefault ? 'text-gray-600' : 'text-white/80'}`}>{species.latinName}</p>
                            )}
                            {species.isDefault && (
                                <span className="absolute top-1 right-1 text-base leading-none">{getSpeciesEmoji(species.name)}</span>
                            )}
                        </button>
                    ))
                )}
            </div>

            <div className="mt-8 border-t pt-4 flex justify-between items-center">
                <p className="text-sm text-gray-500">
                    <span className="font-semibold">{sortedSpecies.length}</span> species available
                </p>
                <button
                    data-tutorial-target="add-species-btn"
                    onClick={onManageSpecies}
                    className="text-primary-dark hover:text-primary transition duration-150 font-medium flex items-center"
                >
                    <Settings size={18} className="mr-2" /> Add New Species
                </button>
            </div>
        </div>
    );
};


// Small helper component for animal image selection/preview
const AnimalImageUpload = ({ imageUrl, onFileChange, onDeleteImage, disabled = false, Trash2 }) => (
    <div data-tutorial-target="animal-image-upload" className="flex items-center space-x-4">
        <div className="w-28 h-28 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center border">
            <AnimalImage src={imageUrl} alt="Animal" className="w-full h-full object-cover" iconSize={36} />
        </div>
        <div className="flex-1">
            <div className="flex items-center space-x-2">
                <label className={`inline-flex items-center px-4 py-2 bg-primary text-black rounded-md cursor-pointer ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-primary/90'}`}>
                    Change Photo
                    <input type="file" accept="image/*" onChange={onFileChange} disabled={disabled} className="hidden" />
                </label>
                {imageUrl && onDeleteImage && Trash2 && (
                    <button
                        type="button"
                        onClick={onDeleteImage}
                        disabled={disabled}
                        className={`inline-flex items-center px-4 py-2 bg-red-500 text-white rounded-md ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-600'}`}
                        title="Delete Image"
                    >
                        <Trash2 size={18} />
                    </button>
                )}
            </div>
            <p className="text-sm text-gray-500 mt-2">Images are automatically compressed for upload.</p>
        </div>
    </div>
);


// Compress an image File in the browser by resizing it to fit within max dimensions
// and re-encoding to JPEG (or PNG for original PNG files). GIFs are returned as-is.
// Returns a Promise that resolves to a Blob.
async function compressImageFile(file, { maxWidth = 1200, maxHeight = 1200, quality = 0.8 } = {}) {
    if (!file || !file.type || !file.type.startsWith('image/')) throw new Error('Not an image file');
    // Reject GIFs (animations not allowed) ? the server accepts PNG/JPEG only
    if (file.type === 'image/gif') throw new Error('GIF_NOT_ALLOWED');

    const img = await new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const image = new Image();
        image.onload = () => { URL.revokeObjectURL(url); resolve(image); };
        image.onerror = (e) => { URL.revokeObjectURL(url); reject(new Error('Failed to load image for compression')); };
        image.src = url;
    });

    const origWidth = img.width;
    const origHeight = img.height;
    let targetWidth = origWidth;
    let targetHeight = origHeight;

    // Calculate target size preserving aspect ratio
    if (origWidth > maxWidth || origHeight > maxHeight) {
        const widthRatio = maxWidth / origWidth;
        const heightRatio = maxHeight / origHeight;
        const ratio = Math.min(widthRatio, heightRatio);
        targetWidth = Math.round(origWidth * ratio);
        targetHeight = Math.round(origHeight * ratio);
    }

    const canvas = document.createElement('canvas');
    canvas.width = targetWidth;
    canvas.height = targetHeight;
    const ctx = canvas.getContext('2d');
    // Fill background white for JPEG to avoid black background on transparent PNGs
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, targetWidth, targetHeight);
    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

    // Always output JPEG for better compatibility (especially with mobile browsers)
    const outputType = 'image/jpeg';
    const blob = await new Promise((resolve) => canvas.toBlob(resolve, outputType, quality));
    return blob || file;
}

// Compress an image File to be under `maxBytes` if possible.
// Tries decreasing quality first, then scales down dimensions and retries.
// Returns a Blob (best-effort). Throws if input isn't an image.
async function compressImageToMaxSize(file, maxBytes = 200 * 1024, opts = {}) {
    if (!file || !file.type || !file.type.startsWith('image/')) throw new Error('Not an image file');
    // Reject GIFs (animations not allowed) ? the server accepts PNG/JPEG only
    if (file.type === 'image/gif') throw new Error('GIF_NOT_ALLOWED');

    console.log('[COMPRESSION DEBUG] Starting compression:', {
        fileName: file.name,
        fileSize: file.size,
        fileType: file.type,
        targetMaxBytes: maxBytes
    });

    // Start with original dimensions limits from opts or defaults
    let { maxWidth = 1200, maxHeight = 1200, startQuality = 0.85, minQuality = 0.35, qualityStep = 0.05, minDimension = 200 } = opts;

    // Load original image to get dimensions
    const image = await new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(new Error('Failed to load image for compression')); };
        img.src = url;
    });

    console.log('[COMPRESSION DEBUG] Original image dimensions:', {
        width: image.width,
        height: image.height,
        aspectRatio: (image.width / image.height).toFixed(3)
    });

    let targetW = Math.min(image.width, maxWidth);
    let targetH = Math.min(image.height, maxHeight);

    // Helper to run compression with given dims and quality
    const tryCompress = async (w, h, quality) => {
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(image, 0, 0, w, h);
        const outputType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
        const blob = await new Promise((resolve) => canvas.toBlob(resolve, outputType, quality));
        return blob;
    };

    // First pass: try with decreasing quality at initial dimensions
    let quality = startQuality;
    while (quality >= minQuality) {
        const blob = await tryCompress(targetW, targetH, quality);
        if (!blob) break;
        console.log('[COMPRESSION DEBUG] Quality pass:', { quality: quality.toFixed(2), blobSize: blob.size, targetW, targetH });
        if (blob.size <= maxBytes) {
            console.log('[COMPRESSION DEBUG] ? Success with quality reduction. Final:', { width: targetW, height: targetH, size: blob.size, quality: quality.toFixed(2) });
            return blob;
        }
        quality -= qualityStep;
    }

    // Second pass: gradually reduce dimensions while preserving aspect ratio
    const aspectRatio = image.width / image.height;
    console.log('[COMPRESSION DEBUG] Entering dimension reduction loop. AspectRatio:', aspectRatio.toFixed(3));
    while (Math.max(targetW, targetH) > minDimension) {
        // Reduce dimensions proportionally to maintain aspect ratio
        const scale = 0.8;
        targetW = Math.round(targetW * scale);
        targetH = Math.round(targetH * scale);
        
        console.log('[COMPRESSION DEBUG] Scaled down to:', { targetW, targetH });
        
        // Ensure neither dimension goes below minDimension while preserving aspect ratio
        if (Math.max(targetW, targetH) < minDimension) {
            if (aspectRatio >= 1) {
                targetW = minDimension;
                targetH = Math.round(minDimension / aspectRatio);
            } else {
                targetH = minDimension;
                targetW = Math.round(minDimension * aspectRatio);
            }
            console.log('[COMPRESSION DEBUG] Hit minimum, adjusted to:', { targetW, targetH });
        }
        
        quality = startQuality;
        while (quality >= minQuality) {
            const blob = await tryCompress(targetW, targetH, quality);
            if (!blob) break;
            if (blob.size <= maxBytes) {
                console.log('[COMPRESSION DEBUG] ? Success with dimension reduction. Final:', { width: targetW, height: targetH, size: blob.size, quality: quality.toFixed(2) });
                return blob;
            }
            quality -= qualityStep;
        }
    }

    // As a last resort, return the smallest we could create (use minQuality and minimum dimensions while preserving aspect ratio)
    const finalW = aspectRatio >= 1 ? minDimension : Math.round(minDimension * aspectRatio);
    const finalH = aspectRatio <= 1 ? minDimension : Math.round(minDimension / aspectRatio);
    console.log('[COMPRESSION DEBUG] ? Using fallback dimensions:', { finalW, finalH, aspectRatio: aspectRatio.toFixed(3) });
    const finalBlob = await tryCompress(finalW, finalH, minQuality);
    console.log('[COMPRESSION DEBUG] Final result:', { width: finalW, height: finalH, size: finalBlob?.size });
    return finalBlob || file;
}

// Attempt to compress an image in a Web Worker (public/imageWorker.js).
// Returns a Blob on success, or null if worker not available or reports an error.
const compressImageWithWorker = (file, maxBytes = 200 * 1024, opts = {}) => {
    return new Promise((resolve, reject) => {
        // Try to create a worker pointing to the public folder path
        let worker;
        try {
            worker = new Worker('/imageWorker.js');
        } catch (e) {
            resolve(null); // Worker couldn't be created (e.g., bundler/public path issue)
            return;
        }

        const id = Math.random().toString(36).slice(2);

        const onMessage = (ev) => {
            if (!ev.data || ev.data.id !== id) return;
            if (ev.data.error) {
                worker.removeEventListener('message', onMessage);
                worker.terminate();
                resolve(null);
                return;
            }
            // Received blob
            const blob = ev.data.blob;
            worker.removeEventListener('message', onMessage);
            worker.terminate();
            resolve(blob);
        };

        worker.addEventListener('message', onMessage);

        // Post file (structured clone) to worker
        try {
            worker.postMessage({ id, file, maxBytes, opts });
        } catch (e) {
            worker.removeEventListener('message', onMessage);
            worker.terminate();
            resolve(null);
        }
    });
};

const CommunityGeneticsModal = ({ species, onClose, authToken, API_BASE_URL, showModalMessage }) => {
    const [formData, setFormData] = useState({
        genes: '',
        alleles: '',
        phenotypeInfo: '',
        references: '',
        contactEmail: ''
    });
    const [submitting, setSubmitting] = useState(false);
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        setSubmitting(true);
        
        try {
            await axios.post(
                `${API_BASE_URL}/api/species-genetics-feedback`,
                {
                    species,
                    ...formData,
                    submittedAt: new Date().toISOString()
                },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            showModalMessage('Thank you for your contribution! Our team will review your submission.');
            onClose();
        } catch (error) {
            console.error('Failed to submit genetics feedback:', error);
            showModalMessage('Failed to submit. Please try again later.', 'error');
        } finally {
            setSubmitting(false);
        }
    };
    
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-bold text-gray-800">
                        Submit Genetics Info for {species}
                    </h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                    </button>
                </div>
                
                <div className="bg-blue-50 p-4 rounded-lg mb-6">
                    <p className="text-sm text-blue-900">
                        Help us build a comprehensive genetics database! Share your knowledge about {species} genetics.
                        Your submission may be used to create a visual builder for this species.
                    </p>
                </div>
                
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            What genes/loci exist for {species}? *
                        </label>
                        <textarea
                            required
                            value={formData.genes}
                            onChange={(e) => setFormData(prev => ({ ...prev, genes: e.target.value }))}
                            placeholder="e.g., A (Agouti), B (Brown), C (Albino), D (Dilution)..."
                            className="w-full p-2 border border-gray-300 rounded focus:ring-primary focus:border-primary"
                            rows="3"
                        />
                        <p className="text-xs text-gray-500 mt-1">List the gene loci and their names</p>
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            What are the possible allele combinations? *
                        </label>
                        <textarea
                            required
                            value={formData.alleles}
                            onChange={(e) => setFormData(prev => ({ ...prev, alleles: e.target.value }))}
                            placeholder="e.g., A: A/A, A/a, a/a&#10;B: B/B, B/b, b/b&#10;C: C/C, C/c, c/c, ch/ch, C/ch, c/ch..."
                            className="w-full p-2 border border-gray-300 rounded focus:ring-primary focus:border-primary font-mono text-sm"
                            rows="5"
                        />
                        <p className="text-xs text-gray-500 mt-1">List all valid allele combinations for each gene</p>
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Phenotype information (optional)
                        </label>
                        <textarea
                            value={formData.phenotypeInfo}
                            onChange={(e) => setFormData(prev => ({ ...prev, phenotypeInfo: e.target.value }))}
                            placeholder="e.g., A/A = Agouti color, a/a = Non-agouti/Black..."
                            className="w-full p-2 border border-gray-300 rounded focus:ring-primary focus:border-primary"
                            rows="4"
                        />
                        <p className="text-xs text-gray-500 mt-1">Describe what each genotype looks like</p>
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            References or sources (optional)
                        </label>
                        <textarea
                            value={formData.references}
                            onChange={(e) => setFormData(prev => ({ ...prev, references: e.target.value }))}
                            placeholder="e.g., Books, websites, breeding clubs, scientific papers..."
                            className="w-full p-2 border border-gray-300 rounded focus:ring-primary focus:border-primary"
                            rows="2"
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Contact email (optional)
                        </label>
                        <input
                            type="email"
                            value={formData.contactEmail}
                            onChange={(e) => setFormData(prev => ({ ...prev, contactEmail: e.target.value }))}
                            placeholder="your@email.com"
                            className="w-full p-2 border border-gray-300 rounded focus:ring-primary focus:border-primary"
                        />
                        <p className="text-xs text-gray-500 mt-1">In case we have questions about your submission</p>
                    </div>
                    
                    <div className="flex gap-3 pt-4">
                        <button
                            type="submit"
                            disabled={submitting}
                            className="flex-1 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2"
                        >
                            {submitting ? (
                                <>
                                    <Loader2 size={18} className="animate-spin" />
                                    Submitting...
                                </>
                            ) : (
                                'Submit Genetics Info'
                            )}
                        </button>
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition"
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};


const AnimalForm = ({ 
    formTitle,             
    animalToEdit,          
    species,               
    onSave, 
    onCancel, 
    onDelete,              
    authToken,
    showModalMessage, 
    API_BASE_URL,          // Ensure these are passed from the parent component (App)
    userProfile,           // Current user profile for default breeder
    speciesConfigs,        // Field replacements per species (legacy - to be phased out)
    X, 
    Search, 
    Loader2, 
    LoadingSpinner,
    PlusCircle, ArrowLeft, Save, Trash2, RotateCcw,
    GENDER_OPTIONS, STATUS_OPTIONS,
    AnimalImageUpload // Assuming this component is defined elsewhere
}) => {
    
    // State for field template (new system)
    const [fieldTemplate, setFieldTemplate] = useState(null);
    const [loadingTemplate, setLoadingTemplate] = useState(false);
    const [enclosureOptions, setEnclosureOptions] = useState([]);
    const [newCareTaskName, setNewCareTaskName] = useState('');
    const [newCareTaskFreq, setNewCareTaskFreq] = useState('');
    const [newAnimalCareTaskName, setNewAnimalCareTaskName] = useState('');
    const [newAnimalCareTaskFreq, setNewAnimalCareTaskFreq] = useState('');
    // Keeper History add-entry states
    const [khMode, setKhMode] = useState('manual'); // 'manual' | 'user'
    const [khName, setKhName] = useState('');
    const [khCountry, setKhCountry] = useState('');
    const [khSelectedUser, setKhSelectedUser] = useState(null);
    const [khUserSearch, setKhUserSearch] = useState('');
    const [khUserResults, setKhUserResults] = useState([]);
    const [khSearching, setKhSearching] = useState(false);

    // Fetch user's enclosures for the dropdown
    useEffect(() => {
        if (!authToken) return;
        axios.get(`${API_BASE_URL}/enclosures`, { headers: { Authorization: `Bearer ${authToken}` } })
            .then(res => setEnclosureOptions(res.data))
            .catch(() => {});
    }, [authToken, API_BASE_URL]);
    
    // Default field labels - can be overridden by species config
    const defaultFieldLabels = {
        breederAssignedId: 'Identification',
        strain: 'Strain',
        heatStatus: 'Heat Status',
        earset: 'Ear Set',
        housingType: 'Housing Type',
        noise: 'Noise Level',
        bedding: 'Bedding Type',
        geneticCode: 'Genetic Code'
    };
    
    // Get field label - uses field template, then species config, then default
    const getFieldLabel = (fieldName, defaultLabel) => {
        // Priority 1: Field template (new system)
        if (fieldTemplate?.fields?.[fieldName]?.label) {
            return fieldTemplate.fields[fieldName].label;
        }
        
        // Priority 2: Species config (legacy system)
        const config = speciesConfigs?.[formData.species];
        if (config?.fieldReplacements?.[fieldName]) {
            return config.fieldReplacements[fieldName];
        }
        
        // Priority 3: Default labels
        return defaultLabel || defaultFieldLabels[fieldName] || fieldName;
    };
    
    // Check if a field is hidden for the current species
    // CRITICAL: Never hide fields that have existing data (backward compatibility)
    const isFieldHidden = (fieldName) => {
        // Template takes priority ? if field is explicitly disabled, always hide it
        // (even if the animal has existing data in that field)
        if (fieldTemplate) {
            const fieldConfig = fieldTemplate.fields?.[fieldName];
            if (fieldConfig) {
                const isHidden = fieldConfig.enabled === false;
                if (fieldName === 'coat' || fieldName === 'earset' || fieldName === 'strain') {
                    console.log(`[AnimalForm] Field ${fieldName}:`, { enabled: fieldConfig.enabled, isHidden });
                }
                return isHidden;
            }
            // Field not listed in template ? show it (fail-safe)
            return false;
        }

        // No template loaded ? fall back to "has data" safety check for edit mode
        if (animalToEdit && formData[fieldName] && formData[fieldName] !== '' && formData[fieldName] !== null) {
            return false; // Always show fields with existing data when no template
        }

        // Fall back to old SpeciesConfig system
        const config = speciesConfigs?.[formData.species];
        return config?.hiddenFields?.includes(fieldName) || false;
    };
    
    // Initial state setup (using the passed props for options)
    const [formData, setFormData] = useState(
        animalToEdit ? {
            species: animalToEdit.species,
            breederAssignedId: animalToEdit.breederAssignedId || animalToEdit.breederyId || animalToEdit.registryCode || '',
            prefix: animalToEdit.prefix || '',
            suffix: animalToEdit.suffix || '',
            name: animalToEdit.name || '',
            gender: animalToEdit.gender || GENDER_OPTIONS[0],
            birthDate: animalToEdit.birthDate ? new Date(animalToEdit.birthDate).toISOString().substring(0, 10) : '',
            deceasedDate: animalToEdit.deceasedDate ? new Date(animalToEdit.deceasedDate).toISOString().substring(0, 10) : '',
            status: animalToEdit.status || 'Pet',
            color: animalToEdit.color || '',
            coat: animalToEdit.coat || '',
			earset: animalToEdit.earset || '', 
            remarks: animalToEdit.remarks || '',
            tags: animalToEdit.tags || [],
            geneticCode: animalToEdit.geneticCode || '',
            fatherId_public: animalToEdit.fatherId_public || null,
            motherId_public: animalToEdit.motherId_public || null,
            breederId_public: animalToEdit.breederId_public || null,
            keeperName: animalToEdit.keeperName || animalToEdit.ownerName || animalToEdit.currentOwner || animalToEdit.currentOwnerDisplay || '',
            groupRole: animalToEdit.groupRole || '',
                isPregnant: animalToEdit.isPregnant || false,
            isNursing: animalToEdit.isNursing || false,
            isInMating: animalToEdit.isInMating || false,
            isQuarantine: animalToEdit.isQuarantine || false,
            enclosureId: animalToEdit.enclosureId || '',
            lastFedDate: animalToEdit.lastFedDate ? new Date(animalToEdit.lastFedDate).toISOString().split('T')[0] : '',
            feedingFrequencyDays: animalToEdit.feedingFrequencyDays || '',
            lastMaintenanceDate: animalToEdit.lastMaintenanceDate ? new Date(animalToEdit.lastMaintenanceDate).toISOString().split('T')[0] : '',
            maintenanceFrequencyDays: animalToEdit.maintenanceFrequencyDays || '',
            careTasks: animalToEdit.careTasks || [],
            isOwned: animalToEdit.isOwned ?? true,
            isDisplay: animalToEdit.isDisplay ?? false,
            // New fields for comprehensive mammal profile
            microchipNumber: animalToEdit.microchipNumber || '',
            pedigreeRegistrationId: animalToEdit.pedigreeRegistrationId || '',
            colonyId: animalToEdit.colonyId || '',
            breed: animalToEdit.breed || '',
            strain: animalToEdit.strain || '',
            coatPattern: animalToEdit.coatPattern || '',
            phenotype: animalToEdit.phenotype || '',
            morph: animalToEdit.morph || '',
            markings: animalToEdit.markings || '',
            eyeColor: animalToEdit.eyeColor || '',
            nailColor: animalToEdit.nailColor || '',
            size: animalToEdit.size || '',
            carrierTraits: animalToEdit.carrierTraits || '',
            bodyWeight: animalToEdit.bodyWeight || '',
            bodyLength: animalToEdit.bodyLength || '',
            heightAtWithers: animalToEdit.heightAtWithers || '',
            bodyConditionScore: animalToEdit.bodyConditionScore || '',
            origin: animalToEdit.origin || 'Captive-bred',
            isNeutered: animalToEdit.isNeutered || false,
            isInfertile: animalToEdit.isInfertile || false,
            heatStatus: animalToEdit.heatStatus || '',
            lastHeatDate: animalToEdit.lastHeatDate ? new Date(animalToEdit.lastHeatDate).toISOString().substring(0, 10) : '',
            ovulationDate: animalToEdit.ovulationDate ? new Date(animalToEdit.ovulationDate).toISOString().substring(0, 10) : '',
            matingDate: animalToEdit.matingDate || '',
            expectedDueDate: animalToEdit.expectedDueDate ? new Date(animalToEdit.expectedDueDate).toISOString().substring(0, 10) : '',
            litterCount: animalToEdit.litterCount || '',
            litterSizeBorn: animalToEdit.litterSizeBorn || '',
            litterSizeWeaned: animalToEdit.litterSizeWeaned || '',
            stillbornCount: animalToEdit.stillbornCount || '',
            nursingStartDate: animalToEdit.nursingStartDate ? new Date(animalToEdit.nursingStartDate).toISOString().substring(0, 10) : '',
            weaningDate: animalToEdit.weaningDate ? new Date(animalToEdit.weaningDate).toISOString().substring(0, 10) : '',
            // Stud/Fertility fields (sire role)
            isStudAnimal: animalToEdit.isStudAnimal || false,
            availableForBreeding: animalToEdit.availableForBreeding || false,
            studFeeCurrency: animalToEdit.studFeeCurrency || 'USD',
            studFeeAmount: animalToEdit.studFeeAmount || '',
            // Sale fields
            isForSale: animalToEdit.isForSale || false,
            salePriceCurrency: animalToEdit.salePriceCurrency || 'USD',
            salePriceAmount: animalToEdit.salePriceAmount || '',
            fertilityStatus: animalToEdit.fertilityStatus || 'Unknown',
            lastMatingDate: animalToEdit.lastMatingDate ? new Date(animalToEdit.lastMatingDate).toISOString().substring(0, 10) : '',
            successfulMatings: animalToEdit.successfulMatings || '',
            fertilityNotes: animalToEdit.fertilityNotes || '',
            // Dam/Fertility fields (dam role)
            isDamAnimal: animalToEdit.isDamAnimal || false,
            damFertilityStatus: animalToEdit.damFertilityStatus || 'Unknown',
            lastPregnancyDate: animalToEdit.lastPregnancyDate ? new Date(animalToEdit.lastPregnancyDate).toISOString().substring(0, 10) : '',
            offspringCount: animalToEdit.offspringCount || '',
            damFertilityNotes: animalToEdit.damFertilityNotes || '',
            medicalConditions: animalToEdit.medicalConditions || '',
            allergies: animalToEdit.allergies || '',
            medications: animalToEdit.medications || '',
            vetVisits: animalToEdit.vetVisits || '',
            primaryVet: animalToEdit.primaryVet || '',
            dietType: animalToEdit.dietType || '',
            feedingSchedule: animalToEdit.feedingSchedule || '',
            supplements: animalToEdit.supplements || '',
            housingType: animalToEdit.housingType || '',
            bedding: animalToEdit.bedding || '',
            temperatureRange: animalToEdit.temperatureRange || '',
            humidity: animalToEdit.humidity || '',
            lighting: animalToEdit.lighting || '',
            noise: animalToEdit.noise || '',
            enrichment: animalToEdit.enrichment || '',
            temperament: animalToEdit.temperament || '',
            handlingTolerance: animalToEdit.handlingTolerance || '',
            socialStructure: animalToEdit.socialStructure || '',
            activityCycle: animalToEdit.activityCycle || '',
            lifeStage: animalToEdit.lifeStage || '',
            causeOfDeath: animalToEdit.causeOfDeath || '',
            necropsyResults: animalToEdit.necropsyResults || '',
            insurance: animalToEdit.insurance || '',
            legalStatus: animalToEdit.legalStatus || '',
            keeperHistory: animalToEdit.keeperHistory || [],
            // Show tab fields
            showTitles: animalToEdit.showTitles || '',
            showRatings: animalToEdit.showRatings || '',
            judgeComments: animalToEdit.judgeComments || '',
            workingTitles: animalToEdit.workingTitles || '',
            performanceScores: animalToEdit.performanceScores || '',
            // Dog/Cat specific - Physical measurements (duplicate entries removed)
            // heightAtWithers: animalToEdit.heightAtWithers || '', // Already defined above
            // bodyLength: animalToEdit.bodyLength || '', // Already defined above
            chestGirth: animalToEdit.chestGirth || '',
            adultWeight: animalToEdit.adultWeight || '',
            // bodyConditionScore: animalToEdit.bodyConditionScore || '', // Already defined above
            // Dog/Cat specific - Identification
            licenseNumber: animalToEdit.licenseNumber || '',
            licenseJurisdiction: animalToEdit.licenseJurisdiction || '',
            rabiesTagNumber: animalToEdit.rabiesTagNumber || '',
            tattooId: animalToEdit.tattooId || '',
            akcRegistrationNumber: animalToEdit.akcRegistrationNumber || '',
            fciRegistrationNumber: animalToEdit.fciRegistrationNumber || '',
            cfaRegistrationNumber: animalToEdit.cfaRegistrationNumber || '',
            workingRegistryIds: animalToEdit.workingRegistryIds || '',
            // Dog/Cat specific - Reproduction
            estrusCycleLength: animalToEdit.estrusCycleLength || '',
            gestationLength: animalToEdit.gestationLength || '',
            artificialInseminationUsed: animalToEdit.artificialInseminationUsed || false,
            whelpingDate: animalToEdit.whelpingDate ? new Date(animalToEdit.whelpingDate).toISOString().substring(0, 10) : '',
            queeningDate: animalToEdit.queeningDate ? new Date(animalToEdit.queeningDate).toISOString().substring(0, 10) : '',
            deliveryMethod: animalToEdit.deliveryMethod || '',
            reproductiveComplications: animalToEdit.reproductiveComplications || '',
            reproductiveClearances: animalToEdit.reproductiveClearances || '',
            // Dog/Cat specific - Health
            spayNeuterDate: animalToEdit.spayNeuterDate ? new Date(animalToEdit.spayNeuterDate).toISOString().substring(0, 10) : '',
            parasitePreventionSchedule: animalToEdit.parasitePreventionSchedule || '',
            heartwormStatus: animalToEdit.heartwormStatus || '',
            hipElbowScores: animalToEdit.hipElbowScores || '',
            geneticTestResults: animalToEdit.geneticTestResults || '',
            eyeClearance: animalToEdit.eyeClearance || '',
            cardiacClearance: animalToEdit.cardiacClearance || '',
            dentalRecords: animalToEdit.dentalRecords || '',
            chronicConditions: animalToEdit.chronicConditions || '',
            // Dog/Cat specific - Husbandry
            exerciseRequirements: animalToEdit.exerciseRequirements || '',
            dailyExerciseMinutes: animalToEdit.dailyExerciseMinutes || '',
            groomingNeeds: animalToEdit.groomingNeeds || '',
            sheddingLevel: animalToEdit.sheddingLevel || '',
            crateTrained: animalToEdit.crateTrained || false,
            litterTrained: animalToEdit.litterTrained || false,
            leashTrained: animalToEdit.leashTrained || false,
            freeFlightTrained: animalToEdit.freeFlightTrained || false,
            // Dog/Cat specific - Training & Behavior
            trainingLevel: animalToEdit.trainingLevel || '',
            trainingDisciplines: animalToEdit.trainingDisciplines || '',
            certifications: animalToEdit.certifications || '',
            workingRole: animalToEdit.workingRole || '',
            behavioralIssues: animalToEdit.behavioralIssues || '',
            biteHistory: animalToEdit.biteHistory || '',
            reactivityNotes: animalToEdit.reactivityNotes || '',
            // Dog/Cat specific - Legal & Ownership
            endOfLifeCareNotes: animalToEdit.endOfLifeCareNotes || '',
            coOwnership: animalToEdit.coOwnership || '',
            transferHistory: animalToEdit.transferHistory || '',
            breedingRestrictions: animalToEdit.breedingRestrictions || '',
            exportRestrictions: animalToEdit.exportRestrictions || '',
        } : {
            species: species, 
            breederAssignedId: '',
            prefix: '',
            suffix: '',
            name: '',
            gender: 'Unknown',
            birthDate: '', 
            deceasedDate: '',
            status: 'Pet',
            color: '',
            coat: '',
			earset: '', 
            remarks: '',
            tags: [],
            geneticCode: '',
            fatherId_public: null,
            motherId_public: null,
            breederId_public: null,
            keeperName: '',
            groupRole: '',
            isPregnant: false,
            isNursing: false,
            isInMating: false,
            isQuarantine: false,
            enclosureId: '',
            lastFedDate: '',
            feedingFrequencyDays: '',
            lastMaintenanceDate: '',
            maintenanceFrequencyDays: '',
            careTasks: [],
            breedingRole: 'both',
            isOwned: true,
            isDisplay: true,
            // New fields defaults
            microchipNumber: '',
            pedigreeRegistrationId: '',
            colonyId: '',
            breed: '',
            strain: '',
            coatPattern: '',
            phenotype: '',
            morph: '',
            markings: '',
            eyeColor: '',
            nailColor: '',
            size: '',
            carrierTraits: '',
            bodyWeight: '',
            bodyLength: '',
            heightAtWithers: '',
            bodyConditionScore: '',
            origin: 'Captive-bred',
            isNeutered: false,
            isInfertile: false,
            heatStatus: '',
            lastHeatDate: '',
            ovulationDate: '',
            matingDate: '',
            expectedDueDate: '',
            litterCount: '',
            litterSizeBorn: '',
            litterSizeWeaned: '',
            stillbornCount: '',
            nursingStartDate: '',
            weaningDate: '',
            // Stud/Fertility fields (sire role)
            isStudAnimal: false,
            availableForBreeding: false,
            studFeeCurrency: 'USD',
            studFeeAmount: '',
            // Sale fields
            isForSale: false,
            salePriceCurrency: 'USD',
            salePriceAmount: '',
            fertilityStatus: '',
            lastMatingDate: '',
            successfulMatings: '',
            fertilityNotes: '',
            // Dam/Fertility fields (dam role)
            isDamAnimal: false,
            damFertilityStatus: '',
            lastPregnancyDate: '',
            offspringCount: '',
            damFertilityNotes: '',
            medicalConditions: '',
            allergies: '',
            medications: '',
            vetVisits: '',
            primaryVet: '',
            dietType: '',
            feedingSchedule: '',
            supplements: '',
            housingType: '',
            bedding: '',
            temperatureRange: '',
            humidity: '',
            lighting: '',
            noise: '',
            enrichment: '',
            temperament: '',
            handlingTolerance: '',
            socialStructure: '',
            activityCycle: '',
            lifeStage: '',
            causeOfDeath: '',
            necropsyResults: '',
            insurance: '',
            legalStatus: '',
            keeperHistory: [],
            // Show tab fields
            showTitles: '',
            showRatings: '',
            judgeComments: '',
            workingTitles: '',
            performanceScores: '',
            // Dog/Cat specific - Physical measurements (duplicate entries removed)
            // heightAtWithers: '', // Already defined above
            // bodyLength: '', // Already defined above  
            chestGirth: '',
            adultWeight: '',
            // bodyConditionScore: '', // Already defined above
            // Dog/Cat specific - Identification
            licenseNumber: '',
            licenseJurisdiction: '',
            rabiesTagNumber: '',
            tattooId: '',
            akcRegistrationNumber: '',
            fciRegistrationNumber: '',
            cfaRegistrationNumber: '',
            workingRegistryIds: '',
            // Dog/Cat specific - Reproduction
            estrusCycleLength: '',
            gestationLength: '',
            artificialInseminationUsed: false,
            whelpingDate: '',
            queeningDate: '',
            deliveryMethod: '',
            reproductiveComplications: '',
            reproductiveClearances: '',
            // Dog/Cat specific - Health
            spayNeuterDate: '',
            parasitePreventionSchedule: '',
            heartwormStatus: '',
            hipElbowScores: '',
            geneticTestResults: '',
            eyeClearance: '',
            cardiacClearance: '',
            dentalRecords: '',
            chronicConditions: '',
            // Dog/Cat specific - Husbandry
            exerciseRequirements: '',
            dailyExerciseMinutes: '',
            groomingNeeds: '',
            sheddingLevel: '',
            crateTrained: false,
            litterTrained: false,
            leashTrained: false,
            freeFlightTrained: false,
            trainingLevel: '',
            trainingDisciplines: '',
            certifications: '',
            workingRole: '',
            behavioralIssues: '',
            biteHistory: '',
            reactivityNotes: '',
            // Dog/Cat specific - Legal & Ownership
            endOfLifeCareNotes: '',
            coOwnership: '',
            transferHistory: '',
            breedingRestrictions: '',
            exportRestrictions: '',
        }
    );
    
    // Fetch field template when species changes
    useEffect(() => {
        if (!formData.species) return;
        
        const fetchFieldTemplate = async () => {
            try {
                setLoadingTemplate(true);
                const response = await axios.get(
                    `${API_BASE_URL}/species/with-template/${encodeURIComponent(formData.species)}`
                );
                
                console.log('[AnimalForm] Field template response:', response.data);
                
                if (response.data?.fieldTemplate) {
                    setFieldTemplate(response.data.fieldTemplate);
                    console.log('[AnimalForm] Field template loaded:', response.data.fieldTemplate.name);
                    console.log('[AnimalForm] Template fields structure:', Object.keys(response.data.fieldTemplate.fields || {}).length + ' fields');
                } else {
                    setFieldTemplate(null); // No template - show all fields
                    console.log('[AnimalForm] No field template available for species:', formData.species);
                }
            } catch (error) {
                console.error('[AnimalForm] Error fetching field template:', error);
                setFieldTemplate(null); // On error, show all fields for safety
            } finally {
                setLoadingTemplate(false);
            }
        };
        
        fetchFieldTemplate();
    }, [formData.species, API_BASE_URL]);
    
    // Growth tracking state
    const [growthRecords, setGrowthRecords] = useState(
        animalToEdit?.growthRecords || []
    );
    const [measurementUnits, setMeasurementUnits] = useState({
        weight: animalToEdit?.measurementUnits?.weight || 'g',
        length: animalToEdit?.measurementUnits?.length || 'cm'
    });
    const [newMeasurement, setNewMeasurement] = useState({
        date: new Date().toISOString().substring(0, 10),
        weight: '',
        length: '',
        bcs: '',
        notes: ''
    });
    
    // Health Records with Dates
    // Tag input state (for typing tags before adding them)
    const [tagInput, setTagInput] = useState('');
    
    const [vaccinationRecords, setVaccinationRecords] = useState(() => {
        // Try to parse from database field 'vaccinations' first, then fallback to 'vaccinationRecords'
        const data = animalToEdit?.vaccinations || animalToEdit?.vaccinationRecords;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                console.log('[AnimalForm] Parsed vaccinationRecords from database:', parsed);
                return parsed;
            } catch { 
                console.error('[AnimalForm] Failed to parse vaccinationRecords:', data);
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newVaccination, setNewVaccination] = useState({
        date: new Date().toISOString().substring(0, 10),
        name: '',
        notes: ''
    });
    
    const [dewormingRecordsArray, setDewormingRecordsArray] = useState(() => {
        // Parse from database field 'dewormingRecords'
        const data = animalToEdit?.dewormingRecords;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                console.log('[AnimalForm] Parsed dewormingRecords from database:', parsed);
                return parsed;
            } catch { 
                console.error('[AnimalForm] Failed to parse dewormingRecords:', data);
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newDeworming, setNewDeworming] = useState({
        date: new Date().toISOString().substring(0, 10),
        medication: '',
        notes: ''
    });
    
    const [parasiteControlRecords, setParasiteControlRecords] = useState(() => {
        // Parse from database field 'parasiteControl'
        const data = animalToEdit?.parasiteControl;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                console.log('[AnimalForm] Parsed parasiteControl from database:', parsed);
                return parsed;
            } catch { 
                console.error('[AnimalForm] Failed to parse parasiteControl:', data);
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newParasiteControl, setNewParasiteControl] = useState({
        date: new Date().toISOString().substring(0, 10),
        treatment: '',
        notes: ''
    });
    
    const [breedingRecords, setBreedingRecords] = useState(() => {
        // Parse from database field 'breedingRecords'
        const data = animalToEdit?.breedingRecords;
        console.log('[DEBUG] Loading breeding records from database:', data);
        if (!data) return [];
        if (Array.isArray(data)) {
            console.log('[DEBUG] Breeding records loaded (array):', data);
            // Log mate information specifically
            data.forEach((record, index) => {
                console.log(`[DEBUG] Record ${index} mate data:`, {
                    mate: record.mate,
                    mateAnimalId: record.mateAnimalId,
                    litterId: record.litterId,
                    id: record.id
                });
            });
            return data;
        }
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                console.log('[DEBUG] Breeding records loaded (parsed):', parsed);
                // Log mate information specifically
                if (Array.isArray(parsed)) {
                    parsed.forEach((record, index) => {
                        console.log(`[DEBUG] Record ${index} mate data:`, {
                            mate: record.mate,
                            mateAnimalId: record.mateAnimalId,
                            litterId: record.litterId,
                            id: record.id
                        });
                    });
                }
                return Array.isArray(parsed) ? parsed : [];
            } catch { 
                return []; 
            }
        }
        return [];
    });
    const [newBreedingRecord, setNewBreedingRecord] = useState({
        breedingMethod: 'Unknown',
        breedingConditionAtTime: null,
        matingDate: '',
        mate: '',
        mateAnimalId: null,
        outcome: 'Unknown',
        birthEventDate: '',
        birthMethod: null,
        litterSizeBorn: null,
        litterSizeWeaned: null,
        stillbornCount: null,
        maleCount: null,
        femaleCount: null,
        unknownCount: null,
        litterId: null,
        notes: ''
    });
    const [mateInfo, setMateInfo] = useState(null);
    
    // Modal states for create/link litter
    const [showCreateLitterModal, setShowCreateLitterModal] = useState(false);
    const [showLinkLitterModal, setShowLinkLitterModal] = useState(false);
    const [showConflictModal, setShowConflictModal] = useState(false);
    const [conflictData, setConflictData] = useState(null);
    const [breedingRecordForLitter, setBreedingRecordForLitter] = useState(null);
    const [existingLitters, setExistingLitters] = useState([]);
    const [litterSearchLoading, setLitterSearchLoading] = useState(false);
    const [expandedBreedingRecords, setExpandedBreedingRecords] = useState({});
    const [breedingRecordOffspring, setBreedingRecordOffspring] = useState({}); // Store offspring by record ID
    const [breedingRecordLitters, setBreedingRecordLitters] = useState({}); // Store litter data by record ID
    
    const [medicalConditionsArray, setMedicalConditionsArray] = useState(() => {
        const data = animalToEdit?.medicalConditions;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                return parsed;
            } catch { 
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newMedicalCondition, setNewMedicalCondition] = useState({
        name: '',
        notes: ''
    });
    
    const [allergiesArray, setAllergiesArray] = useState(() => {
        const data = animalToEdit?.allergies;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                return parsed;
            } catch { 
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newAllergy, setNewAllergy] = useState({
        name: '',
        notes: ''
    });
    
    const [medicationsArray, setMedicationsArray] = useState(() => {
        const data = animalToEdit?.medications;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                return parsed;
            } catch { 
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newMedication, setNewMedication] = useState({
        name: '',
        notes: ''
    });
    
    const [vetVisitsArray, setVetVisitsArray] = useState(() => {
        const data = animalToEdit?.vetVisits;
        if (!data) return [];
        if (typeof data === 'string') {
            try { 
                const parsed = JSON.parse(data);
                return parsed;
            } catch { 
                return []; 
            }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newVetVisit, setNewVetVisit] = useState({
        date: new Date().toISOString().substring(0, 10),
        reason: '',
        notes: ''
    });
    
    const [medicalProcedureRecords, setMedicalProcedureRecords] = useState(() => {
        // Parse from database field 'medicalProcedures'
        const data = animalToEdit?.medicalProcedures;
        if (!data) return [];
        if (typeof data === 'string') {
            try { return JSON.parse(data); } catch { return []; }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newProcedure, setNewProcedure] = useState({
        date: new Date().toISOString().substring(0, 10),
        name: '',
        notes: ''
    });
    
    const [labResultRecords, setLabResultRecords] = useState(() => {
        // Parse from database field 'labResults'
        const data = animalToEdit?.labResults;
        if (!data) return [];
        if (typeof data === 'string') {
            try { return JSON.parse(data); } catch { return []; }
        }
        return Array.isArray(data) ? data : [];
    });
    const [newLabResult, setNewLabResult] = useState({
        date: new Date().toISOString().substring(0, 10),
        testName: '',
        result: '',
        notes: ''
    });
    
    // Keep a ref for immediate pedigree selection (avoids lost state if user selects then immediately saves)
    const pedigreeRef = useRef({ father: (animalToEdit && animalToEdit.fatherId_public) || null, mother: (animalToEdit && animalToEdit.motherId_public) || null });
    // Small cached info for selected parents so we can show name/prefix next to CTID
    const [fatherInfo, setFatherInfo] = useState(null); // { id_public, prefix, name }
    const [motherInfo, setMotherInfo] = useState(null);
    const [breederInfo, setBreederInfo] = useState(null); // { id_public, personalName, breederName, showBreederName }
    const lastFetchedParentIds = useRef({ father: null, mother: null });

    // Helper: fetch a summary for an animal by public id. Try local (authenticated) first, then global display.
    const fetchAnimalSummary = async (idPublic) => {
        if (!idPublic) return null;
        try {
            // Try local animals endpoint with auth (returns array)
            const localResp = await axios.get(`${API_BASE_URL}/animals?id_public=${encodeURIComponent(idPublic)}`, { headers: { Authorization: `Bearer ${authToken}` } });
            if (Array.isArray(localResp.data) && localResp.data.length > 0) {
                const a = localResp.data[0];
                return { id_public: a.id_public, prefix: a.prefix || '', suffix: a.suffix || '', name: a.name || '', backendId: a._id || a.id_backend || null };
            }
        } catch (err) {
            // ignore and try global
        }

        try {
            const globalResp = await axios.get(`${API_BASE_URL}/public/global/animals?id_public=${encodeURIComponent(idPublic)}`);
            if (Array.isArray(globalResp.data) && globalResp.data.length > 0) {
                const a = globalResp.data[0];
                return { id_public: a.id_public, prefix: a.prefix || '', suffix: a.suffix || '', name: a.name || '', backendId: a._id || a.id_backend || null };
            }
        } catch (err) {
            // ignore
        }
        return null;
    };

    // Helper: fetch breeder/user info by public id
    const fetchBreederInfo = async (idPublic) => {
        if (!idPublic) return null;
        try {
            const response = await axios.get(`${API_BASE_URL}/public/profiles/search?query=${idPublic}&limit=1`);
            if (Array.isArray(response.data) && response.data.length > 0) {
                const user = response.data[0];
                return {
                    id_public: user.id_public,
                    personalName: user.personalName || '',
                    breederName: user.breederName || '',
                    showBreederName: user.showBreederName || false
                };
            }
        } catch (err) {
            console.warn('Failed to fetch breeder info:', err);
        }
        return null;
    };
    const [loading, setLoading] = useState(false);
    const [modalTarget, setModalTarget] = useState(null); 
    const [pendingParentForRole, setPendingParentForRole] = useState(null); // 'father' or 'mother' - tracks which parent role to assign to selected Intersex/Unknown animal
    const [pendingParentAnimal, setPendingParentAnimal] = useState(null); // The full animal object awaiting role assignment
    const [animalImageFile, setAnimalImageFile] = useState(null);
    const [animalImagePreview, setAnimalImagePreview] = useState(animalToEdit?.imageUrl || animalToEdit?.photoUrl || null);
    const [deleteImage, setDeleteImage] = useState(false);
    const [showCommunityGeneticsModal, setShowCommunityGeneticsModal] = useState(false);
    const [activeTab, setActiveTab] = useState(1); // Tab navigation state
    const [collapsedHealthSections, setCollapsedHealthSections] = useState({}); // collapse health tab sections

    const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        console.log('[AnimalForm] handleChange called:', { name, value, type, checked });
        setFormData(prev => {
            const updated = {
                ...prev,
                [name]: type === 'checkbox' ? checked : value
            };
            
            console.log('[AnimalForm] Updated formData:', updated);
            
            // If deceased date is being set, automatically set status to Deceased
            if (name === 'deceasedDate' && value) {
                updated.status = 'Deceased';
            }
            // If deceased date is being cleared, don't automatically change status
            // (user might want to keep it as is)
            
            return updated;
        });
    };
    
        const handleSelectPedigree = async (idOrAnimal, assignedRole = null) => {
            const id = idOrAnimal && typeof idOrAnimal === 'object' ? idOrAnimal.id_public : idOrAnimal;
            
            // Handle breeder selection differently
            if (modalTarget === 'breeder') {
                setFormData(prev => ({ ...prev, breederId_public: id, manualBreederName: '' }));
                if (idOrAnimal && typeof idOrAnimal === 'object') {
                    // User object from search
                    const user = idOrAnimal;
                    const info = {
                        id_public: user.id_public,
                        personalName: user.personalName || '',
                        breederName: user.breederName || '',
                        showBreederName: user.showBreederName || false
                    };
                    setBreederInfo(info);
                } else if (id) {
                    // Fetch user info
                    try {
                        const info = await fetchBreederInfo(id);
                        setBreederInfo(info);
                    } catch (err) {
                        console.warn('Failed to fetch breeder info', err);
                    }
                } else {
                    setBreederInfo(null);
                }
                setModalTarget(null);
                return;
            }
            
            // Handle 'other-parent' case: show role selection modal if not already assigned
            if (modalTarget === 'other-parent' && !assignedRole) {
                if (idOrAnimal && typeof idOrAnimal === 'object') {
                    setPendingParentAnimal(idOrAnimal);
                    setModalTarget(null); // Close the search modal
                } else {
                    console.warn('Other parent selection requires animal object');
                }
                return;
            }
            
            // Determine target based on assignedRole (for 'other-parent') or modalTarget
            const effectiveTarget = assignedRole || modalTarget;
            
            // Handle parent selection
            const idKey = effectiveTarget === 'father' ? 'fatherId_public' : 'motherId_public';
            setFormData(prev => ({ ...prev, [idKey]: id }));
        // Update ref immediately so save uses the latest selection even if state update is pending
        if (effectiveTarget === 'father') {
            pedigreeRef.current.father = id;
        } else {
            pedigreeRef.current.mother = id;
        }

        // If caller passed the whole animal object, use it directly to avoid refetch
        if (idOrAnimal && typeof idOrAnimal === 'object') {
            const a = idOrAnimal;
            const info = { id_public: a.id_public, prefix: a.prefix || '', suffix: a.suffix || '', name: a.name || '', backendId: a._id || a.id_backend || null };
            if (effectiveTarget === 'father') {
                setFatherInfo(info);
                pedigreeRef.current.fatherBackendId = info.backendId;
            } else {
                setMotherInfo(info);
                pedigreeRef.current.motherBackendId = info.backendId;
            }
        } else if (id) {
            // Fetch a small summary for display (non-blocking for the user)
            try {
                console.debug('Selecting parent id:', id, 'for effectiveTarget:', effectiveTarget);
                const info = await fetchAnimalSummary(id);
                console.debug('Fetched parent summary:', info);
                if (effectiveTarget === 'father') {
                    setFatherInfo(info);
                    pedigreeRef.current.fatherBackendId = info?.backendId || null;
                }
                else {
                    setMotherInfo(info);
                    pedigreeRef.current.motherBackendId = info?.backendId || null;
                }
            } catch (err) {
                console.warn('Failed to fetch parent summary', err);
            }
        } else {
            // cleared selection
            if (effectiveTarget === 'father') setFatherInfo(null);
            else setMotherInfo(null);
        }

        setModalTarget(null);
    };

    // Clear a selected parent (father or mother)
    const clearParentSelection = (which) => {
        console.log(`[DEBUG] Clearing ${which} parent - Before:`, {
            formData: {
                fatherId_public: formData.fatherId_public,
                motherId_public: formData.motherId_public
            },
            pedigreeRef: {
                father: pedigreeRef.current.father,
                mother: pedigreeRef.current.mother,
                fatherBackendId: pedigreeRef.current.fatherBackendId,
                motherBackendId: pedigreeRef.current.motherBackendId
            }
        });
        
        if (which === 'father') {
            setFormData(prev => ({ ...prev, fatherId_public: null }));
            pedigreeRef.current.father = null;
            pedigreeRef.current.fatherBackendId = null;
            setFatherInfo(null);
        } else {
            setFormData(prev => ({ ...prev, motherId_public: null }));
            pedigreeRef.current.mother = null;
            pedigreeRef.current.motherBackendId = null;
            setMotherInfo(null);
        }
        
        console.log(`[DEBUG] Clearing ${which} parent - After:`, {
            pedigreeRef: {
                father: pedigreeRef.current.father,
                mother: pedigreeRef.current.mother,
                fatherBackendId: pedigreeRef.current.fatherBackendId,
                motherBackendId: pedigreeRef.current.motherBackendId
            }
        });
    };

    // Clear breeder selection
    const clearBreederSelection = () => {
        setFormData(prev => ({ ...prev, breederId_public: null, manualBreederName: '' }));
        setBreederInfo(null);
    };

    // Handle mate selection from modal
    const handleSelectMate = async (idOrAnimal) => {
        const id = idOrAnimal && typeof idOrAnimal === 'object' ? idOrAnimal.id_public : idOrAnimal;
        
        // Set mate animal ID and clear manual text
        setNewBreedingRecord(prev => ({ 
            ...prev, 
            mateAnimalId: id, 
            mate: '' 
        }));
        
        // Store animal info
        if (idOrAnimal && typeof idOrAnimal === 'object') {
            const a = idOrAnimal;
            const info = { 
                id_public: a.id_public, 
                prefix: a.prefix || '', 
                suffix: a.suffix || '', 
                name: a.name || '', 
                backendId: a._id || a.id_backend || null 
            };
            setMateInfo(info);
        } else if (id) {
            // Fetch animal summary
            try {
                const info = await fetchAnimalSummary(id);
                setMateInfo(info);
            } catch (err) {
                console.warn('Failed to fetch mate summary', err);
            }
        }
        
        setModalTarget(null);
    };

    // Clear mate selection
    const clearMateSelection = () => {
        setNewBreedingRecord(prev => ({ ...prev, mateAnimalId: null, mate: '' }));
        setMateInfo(null);
    };

    // When editing an existing animal, initialize parent and breeder info
    useEffect(() => {
        let mounted = true;
        (async () => {
            if (animalToEdit) {
                const fId = animalToEdit.fatherId_public || null;
                const mId = animalToEdit.motherId_public || null;
                const bId = animalToEdit.breederId_public || null;
                console.log('Loading parent info for animal:', animalToEdit.id_public, 'fatherId:', fId, 'motherId:', mId, 'breederId:', bId);
                if (fId) {
                    try {
                        const info = await fetchAnimalSummary(fId);
                        console.log('Fetched father info:', info, 'for fatherId:', fId);
                        if (mounted) setFatherInfo(info);
                    } catch (e) { console.error('Failed to fetch father info:', e); }
                } else {
                    setFatherInfo(null);
                }
                if (mId) {
                    try {
                        const info = await fetchAnimalSummary(mId);
                        console.log('Fetched mother info:', info, 'for motherId:', mId);
                        if (mounted) setMotherInfo(info);
                    } catch (e) { console.error('Failed to fetch mother info:', e); }
                } else {
                    setMotherInfo(null);
                }
                if (bId) {
                    try {
                        const info = await fetchBreederInfo(bId);
                        console.log('Fetched breeder info:', info, 'for breederId:', bId);
                        if (mounted) setBreederInfo(info);
                    } catch (e) { console.error('Failed to fetch breeder info:', e); }
                } else {
                    setBreederInfo(null);
                }
            }
        })();
        return () => { mounted = false; };
    }, [animalToEdit]);

    // Fetch parent info when parent IDs change (for newly selected parents)
    useEffect(() => {
        const fetchParentNames = async () => {
            // Fetch father info only if ID changed
            if (formData.fatherId_public !== lastFetchedParentIds.current.father) {
                lastFetchedParentIds.current.father = formData.fatherId_public;
                
                if (formData.fatherId_public) {
                    try {
                        const info = await fetchAnimalSummary(formData.fatherId_public);
                        console.log('[PARENT FETCH] Fetched FATHER info for ID', formData.fatherId_public, ':', info);
                        setFatherInfo(info);
                    } catch (e) { 
                        console.error('[PARENT FETCH] Failed to fetch father info:', e);
                        setFatherInfo(null);
                    }
                } else {
                    console.log('[PARENT FETCH] Clearing father info (no ID)');
                    setFatherInfo(null);
                }
            }
            
            // Fetch mother info only if ID changed
            if (formData.motherId_public !== lastFetchedParentIds.current.mother) {
                lastFetchedParentIds.current.mother = formData.motherId_public;
                
                if (formData.motherId_public) {
                    try {
                        const info = await fetchAnimalSummary(formData.motherId_public);
                        console.log('[PARENT FETCH] Fetched MOTHER info for ID', formData.motherId_public, ':', info);
                        setMotherInfo(info);
                    } catch (e) { 
                        console.error('[PARENT FETCH] Failed to fetch mother info:', e);
                        setMotherInfo(null);
                    }
                } else {
                    console.log('[PARENT FETCH] Clearing mother info (no ID)');
                    setMotherInfo(null);
                }
            }
        };
        
        fetchParentNames();
    }, [formData.fatherId_public, formData.motherId_public]);

    const addMeasurement = () => {
        if (!newMeasurement.date || !newMeasurement.weight) {
            showModalMessage('Missing Data', 'Please enter at least a date and weight.');
            return;
        }
        const newRecord = {
            id: Date.now().toString(),
            date: newMeasurement.date,
            weight: newMeasurement.weight,
            length: newMeasurement.length || null,
            bcs: newMeasurement.bcs || null,
            notes: newMeasurement.notes || ''
        };
        setGrowthRecords([...growthRecords, newRecord]);
        setNewMeasurement({ date: '', weight: '', length: '', bcs: '', notes: '' });
    };

    // Health Record Functions
    const addVaccination = () => {
        if (!newVaccination.date || !newVaccination.name) {
            showModalMessage('Missing Data', 'Please enter at least a date and vaccination name.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            date: newVaccination.date,
            name: newVaccination.name,
            notes: newVaccination.notes || ''
        };
        setVaccinationRecords([...vaccinationRecords, record]);
        setNewVaccination({ date: new Date().toISOString().substring(0, 10), name: '', notes: '' });
    };

    const addDeworming = () => {
        if (!newDeworming.date || !newDeworming.medication) {
            showModalMessage('Missing Data', 'Please enter at least a date and medication.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            date: newDeworming.date,
            medication: newDeworming.medication,
            notes: newDeworming.notes || ''
        };
        setDewormingRecordsArray([...dewormingRecordsArray, record]);
        setNewDeworming({ date: new Date().toISOString().substring(0, 10), medication: '', notes: '' });
    };

    const addParasiteControl = () => {
        if (!newParasiteControl.date || !newParasiteControl.treatment) {
            showModalMessage('Missing Data', 'Please enter at least a date and treatment.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            date: newParasiteControl.date,
            treatment: newParasiteControl.treatment,
            notes: newParasiteControl.notes || ''
        };
        setParasiteControlRecords([...parasiteControlRecords, record]);
        setNewParasiteControl({ date: new Date().toISOString().substring(0, 10), treatment: '', notes: '' });
    };

    // Enhanced breeding record creation with bidirectional sync
    const addBreedingRecord = async () => {
        // All fields are now optional - no validation required
        const record = {
            id: Date.now().toString(),
            recordDate: new Date().toISOString(),
            breedingMethod: newBreedingRecord.breedingMethod,
            breedingConditionAtTime: newBreedingRecord.breedingConditionAtTime || null,
            matingDate: newBreedingRecord.matingDate,
            mate: newBreedingRecord.mate || (mateInfo ? `${mateInfo.prefix || ''} ${mateInfo.name}`.trim() : null),
            mateAnimalId: newBreedingRecord.mateAnimalId || null,
            outcome: newBreedingRecord.outcome || null,
            birthEventDate: newBreedingRecord.birthEventDate || null,
            birthMethod: newBreedingRecord.birthMethod || null,
            litterSizeBorn: newBreedingRecord.litterSizeBorn !== null ? parseInt(newBreedingRecord.litterSizeBorn) : null,
            litterSizeWeaned: newBreedingRecord.litterSizeWeaned !== null ? parseInt(newBreedingRecord.litterSizeWeaned) : null,
            stillbornCount: newBreedingRecord.stillbornCount !== null ? parseInt(newBreedingRecord.stillbornCount) : null,
            maleCount: newBreedingRecord.maleCount !== null && newBreedingRecord.maleCount !== '' ? parseInt(newBreedingRecord.maleCount) : null,
            femaleCount: newBreedingRecord.femaleCount !== null && newBreedingRecord.femaleCount !== '' ? parseInt(newBreedingRecord.femaleCount) : null,
            unknownCount: newBreedingRecord.unknownCount !== null && newBreedingRecord.unknownCount !== '' ? parseInt(newBreedingRecord.unknownCount) : null,
            litterId: newBreedingRecord.litterId || null,
            notes: newBreedingRecord.notes || ''
        };
        
        console.log('[DEBUG] Adding new breeding record with mate data:', {
            mate: record.mate,
            mateAnimalId: record.mateAnimalId,
            mateInfo: mateInfo,
            newBreedingRecord_mate: newBreedingRecord.mate,
            newBreedingRecord_mateAnimalId: newBreedingRecord.mateAnimalId
        });
        
        // Validate offspring counts if provided
        const countValidation = validateOffspringCounts(record);
        if (!countValidation.isValid) {
            showModalMessage('Count Validation Error', `Offspring counts don't add up: ${countValidation.message}`);
            return;
        }
        
        setBreedingRecords([...breedingRecords, record]);
        
        // Create bidirectional breeding record if mate is from database
        if (record.mateAnimalId && mateInfo) {
            try {
                await createBidirectionalBreedingRecord(record, mateInfo);
                showModalMessage('Success', `Breeding record created for both ${formData.name || animalToEdit?.name} and ${mateInfo.name}`);
            } catch (error) {
                console.error('Error creating bidirectional record:', error);
                showModalMessage('Notice', `Breeding record created for ${formData.name || animalToEdit?.name}. Could not create record for mate: ${error.message}`);
            }
        }
        
        // Reset form
        setNewBreedingRecord({
            breedingMethod: 'Unknown',
            breedingConditionAtTime: null,
            matingDate: '',
            mate: '',
            mateAnimalId: null,
            outcome: 'Unknown',
            birthEventDate: '',
            birthMethod: null,
            litterSizeBorn: null,
            litterSizeWeaned: null,
            stillbornCount: null,
            maleCount: null,
            femaleCount: null,
            unknownCount: null,
            litterId: null,
            notes: ''
        });
        setMateInfo(null);
    };
    
    // Validate offspring counts across all methods
    const validateOffspringCounts = (record) => {
        const born = record.litterSizeBorn || 0;
        const weaned = record.litterSizeWeaned || 0;
        const stillborn = record.stillbornCount || 0;
        
        // Check if any counts are provided
        if (born === 0 && weaned === 0 && stillborn === 0) {
            return { isValid: true }; // No counts provided is valid
        }
        
        // Stillborn + Weaned should not exceed Total Born
        if ((stillborn + weaned) > born && born > 0) {
            return { 
                isValid: false, 
                message: `Stillborn (${stillborn}) + Weaned (${weaned}) = ${stillborn + weaned} exceeds Total Born (${born})` 
            };
        }
        
        // Weaned cannot exceed born
        if (weaned > born && born > 0) {
            return { 
                isValid: false, 
                message: `Weaned (${weaned}) cannot exceed Total Born (${born})` 
            };
        }
        
        // Stillborn cannot exceed born
        if (stillborn > born && born > 0) {
            return { 
                isValid: false, 
                message: `Stillborn (${stillborn}) cannot exceed Total Born (${born})` 
            };
        }
        
        return { isValid: true };
    };
    
    // Create bidirectional breeding record on mate's account
    const createBidirectionalBreedingRecord = async (originalRecord, mateInfo) => {
        if (!authToken || !mateInfo.backendId) {
            console.warn('Cannot create bidirectional record: missing auth or mate backend ID');
            return;
        }
        
        // Get the mate's current data
        const mateResponse = await axios.get(`${API_BASE_URL}/animals/${mateInfo.backendId}`, {
            headers: { Authorization: `Bearer ${authToken}` }
        });
        
        const mateAnimal = mateResponse.data;
        
        // Create reciprocal breeding record 
        const reciprocalRecord = {
            id: (Date.now() + 1).toString(), // Slightly different ID
            recordDate: originalRecord.recordDate,
            breedingMethod: originalRecord.breedingMethod,
            breedingConditionAtTime: originalRecord.breedingConditionAtTime,
            matingDate: originalRecord.matingDate,
            mate: `${formData.prefix || ''} ${formData.name || animalToEdit?.name || ''}`.trim(),
            mateAnimalId: formData.id_public || animalToEdit?.id_public,
            outcome: originalRecord.outcome,
            birthEventDate: originalRecord.birthEventDate,
            birthMethod: originalRecord.birthMethod,
            litterSizeBorn: originalRecord.litterSizeBorn,
            litterSizeWeaned: originalRecord.litterSizeWeaned,
            stillbornCount: originalRecord.stillbornCount,
            litterId: originalRecord.litterId,
            notes: `[Auto-generated] ${originalRecord.notes}`.trim()
        };
        
        // Add to mate's breeding records
        const updatedMateData = {
            ...mateAnimal,
            breedingRecords: [...(mateAnimal.breedingRecords || []), reciprocalRecord]
        };
        
        // Save updated mate data
        await axios.put(`${API_BASE_URL}/animals/${mateInfo.backendId}`, updatedMateData, {
            headers: { Authorization: `Bearer ${authToken}` }
        });
        
        console.log('[BIDIRECTIONAL] Created reciprocal breeding record on mate account');
    };
    
    // Handler for creating a litter from breeding record
    const handleCreateLitterFromBreeding = async (litterData) => {
        try {
            setLoading(true);
            
            // Prepare litter creation payload with proper parent handling
            const currentAnimal = formData.id_public || animalToEdit?.id_public;
            const breedingRecord = breedingRecordForLitter;
            
            const payload = {
                ...litterData,
                species: formData.species,
                // Link breeding record
                breedingRecordId: breedingRecord?.id,
                // Set parents based on current animal's gender and breeding record mate
                ...(formData.gender === 'Male' || formData.gender === 'Intersex' ? {
                    sireId_public: currentAnimal,
                    // Set dam from mate (either ID or manual name)
                    ...(breedingRecord?.mateAnimalId ? 
                        { damId_public: breedingRecord.mateAnimalId } : 
                        { manualDamName: breedingRecord?.mate || 'Unknown' }
                    )
                } : {
                    damId_public: currentAnimal,
                    // Set sire from mate (either ID or manual name)
                    ...(breedingRecord?.mateAnimalId ? 
                        { sireId_public: breedingRecord.mateAnimalId } : 
                        { manualSireName: breedingRecord?.mate || 'Unknown' }
                    )
                })
            };
            
            console.log('[CREATE LITTER] Payload:', payload);
            
            // Create the litter via API
            const response = await axios.post(`${API_BASE_URL}/litters`, payload, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            const newLitter = response.data;
            console.log('[CREATE LITTER] Created litter:', newLitter);
            
            // Update the breeding record with the litter ID
            if (breedingRecordForLitter && newLitter.litter_id_public) {
                const updatedRecords = breedingRecords.map(r => 
                    r.id === breedingRecordForLitter.id 
                        ? { ...r, litterId: newLitter.litter_id_public }
                        : r
                );
                setBreedingRecords(updatedRecords);
                
                showModalMessage('Success', `Litter ${newLitter.litter_id_public} created and linked!`);
            }
            
            setShowCreateLitterModal(false);
            setBreedingRecordForLitter(null);
        } catch (error) {
            console.error('Error creating litter:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to create litter');
        } finally {
            setLoading(false);
        }
    };
    
    // Handler for linking existing litter to breeding record
    const handleLinkLitterToBreeding = (litter) => {
        if (breedingRecordForLitter) {
            const updatedRecords = breedingRecords.map(r => 
                r.id === breedingRecordForLitter.id 
                    ? { ...r, litterId: litter.litter_id_public }
                    : r
            );
            setBreedingRecords(updatedRecords);
            
            showModalMessage('Success', `Breeding record linked to litter ${litter.litter_id_public}!`);
            
            setShowLinkLitterModal(false);
            setBreedingRecordForLitter(null);
        } else {
            // Check for conflicts between breeding record and litter data
            const conflicts = [];
            
            // Date conflicts
            if (newBreedingRecord.birthEventDate && litter.birthDate && 
                newBreedingRecord.birthEventDate !== litter.birthDate) {
                conflicts.push({
                    field: 'birthEventDate',
                    label: 'Birth Date',
                    breedingValue: newBreedingRecord.birthEventDate,
                    litterValue: litter.birthDate
                });
            }
            
            // Number conflicts
            if (newBreedingRecord.litterSizeBorn && litter.numberBorn &&
                parseInt(newBreedingRecord.litterSizeBorn) !== parseInt(litter.numberBorn)) {
                conflicts.push({
                    field: 'litterSizeBorn',
                    label: 'Number Born',
                    breedingValue: newBreedingRecord.litterSizeBorn,
                    litterValue: litter.numberBorn
                });
            }
            
            if (newBreedingRecord.stillbornCount && litter.stillborn &&
                parseInt(newBreedingRecord.stillbornCount) !== parseInt(litter.stillborn)) {
                conflicts.push({
                    field: 'stillbornCount',
                    label: 'Stillborn Count',
                    breedingValue: newBreedingRecord.stillbornCount,
                    litterValue: litter.stillborn
                });
            }
            
            if (newBreedingRecord.litterSizeWeaned && litter.numberWeaned &&
                parseInt(newBreedingRecord.litterSizeWeaned) !== parseInt(litter.numberWeaned)) {
                conflicts.push({
                    field: 'litterSizeWeaned',
                    label: 'Number Weaned',
                    breedingValue: newBreedingRecord.litterSizeWeaned,
                    litterValue: litter.numberWeaned
                });
            }
            
            if (newBreedingRecord.matingDate && (litter.matingDate || litter.pairingDate) &&
                newBreedingRecord.matingDate !== (litter.matingDate || litter.pairingDate)) {
                conflicts.push({
                    field: 'matingDate',
                    label: 'Mating Date',
                    breedingValue: newBreedingRecord.matingDate,
                    litterValue: litter.matingDate || litter.pairingDate
                });
            }
            
            if (conflicts.length > 0) {
                // Show conflict resolution modal
                setConflictData({ litter, conflicts });
                setShowConflictModal(true);
            } else {
                // No conflicts - proceed with auto-fill
                performLitterLink(litter);
            }
        }
    };
    
    // Perform the litter link with auto-fill
    const performLitterLink = (litter) => {
        const updates = { litterId: litter.litter_id_public };
        
        // Auto-fill only if field is empty
        if (!newBreedingRecord.birthEventDate && litter.birthDate) {
            updates.birthEventDate = litter.birthDate;
        }
        if (!newBreedingRecord.litterSizeBorn && litter.numberBorn) {
            updates.litterSizeBorn = litter.numberBorn;
        }
        if (!newBreedingRecord.stillbornCount && litter.stillborn) {
            updates.stillbornCount = litter.stillborn;
        }
        if (!newBreedingRecord.litterSizeWeaned && litter.numberWeaned) {
            updates.litterSizeWeaned = litter.numberWeaned;
        }
        if (!newBreedingRecord.matingDate && (litter.matingDate || litter.pairingDate)) {
            updates.matingDate = litter.matingDate || litter.pairingDate;
        }
        
        setNewBreedingRecord(prev => ({ ...prev, ...updates }));
        setShowLinkLitterModal(false);
        
        showModalMessage('Success', `Linked to litter ${litter.litter_id_public} with auto-filled data!`);
    };
    
    // Handle conflict resolution
    const handleConflictResolution = (resolutions) => {
        const litter = conflictData.litter;
        const updates = { litterId: litter.litter_id_public };
        
        // Apply conflict resolutions
        resolutions.forEach(resolution => {
            const conflict = conflictData.conflicts.find(c => c.field === resolution.field);
            if (conflict) {
                if (resolution.choice === 'litter') {
                    updates[resolution.field] = conflict.litterValue;
                }
                // If choice is 'breeding', keep existing value (don't update)
            }
        });
        
        // Auto-fill empty fields (no conflicts)
        if (!newBreedingRecord.birthEventDate && litter.birthDate && !updates.birthEventDate) {
            updates.birthEventDate = litter.birthDate;
        }
        if (!newBreedingRecord.litterSizeBorn && litter.numberBorn && !updates.litterSizeBorn) {
            updates.litterSizeBorn = litter.numberBorn;
        }
        if (!newBreedingRecord.stillbornCount && litter.stillborn && !updates.stillbornCount) {
            updates.stillbornCount = litter.stillborn;
        }
        if (!newBreedingRecord.litterSizeWeaned && litter.numberWeaned && !updates.litterSizeWeaned) {
            updates.litterSizeWeaned = litter.numberWeaned;
        }
        if (!newBreedingRecord.matingDate && (litter.matingDate || litter.pairingDate) && !updates.matingDate) {
            updates.matingDate = litter.matingDate || litter.pairingDate;
        }
        
        setNewBreedingRecord(prev => ({ ...prev, ...updates }));
        setShowLinkLitterModal(false);
        setShowConflictModal(false);
        setConflictData(null);
        
        showModalMessage('Success', `Linked to litter ${litter.litter_id_public} with resolved conflicts!`);
    };
    
    // Fetch existing litters for linking (filtered by species and animal as sire/dam)
    const fetchLittersForLinking = async () => {
        try {
            setLitterSearchLoading(true);
            
            // Fetch all litters for current species
            const response = await axios.get(
                `${API_BASE_URL}/litters?species=${encodeURIComponent(formData.species)}`,
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            let filtered = response.data || [];
            
            // Filter: current animal as sire/dam/other parent
            // Only show litters that match current animal's gender role
            const animalPublicId = formData.id_public || animalToEdit?.id_public;
            
            if (formData.gender === 'Male' || (formData.gender === 'Intersex')) {
                // Can be a sire - filter litters where this animal is sire or unknown sire
                filtered = filtered.filter(litter => 
                    !litter.sireId_public || litter.sireId_public === animalPublicId
                );
            } else if (formData.gender === 'Female' || (formData.gender === 'Intersex')) {
                // Can be a dam - filter litters where this animal is dam or unknown dam
                filtered = filtered.filter(litter => 
                    !litter.damId_public || litter.damId_public === animalPublicId
                );
            }
            
            // If mate animal is selected (not manual text), filter by that parent too
            if (newBreedingRecord.mateAnimalId && mateInfo) {
                const mateId = newBreedingRecord.mateAnimalId;
                if (formData.gender === 'Male') {
                    // Current animal is sire, mate should be dam
                    filtered = filtered.filter(litter => 
                        !litter.damId_public || litter.damId_public === mateId
                    );
                } else if (formData.gender === 'Female') {
                    // Current animal is dam, mate should be sire
                    filtered = filtered.filter(litter => 
                        !litter.sireId_public || litter.sireId_public === mateId
                    );
                }
            }
            
            // Filter by birth date if entered
            if (newBreedingRecord.birthEventDate) {
                filtered = filtered.filter(litter => 
                    !litter.birthDate || litter.birthDate === newBreedingRecord.birthEventDate
                );
            }
            
            setExistingLitters(filtered);
        } catch (error) {
            console.error('Error fetching litters:', error);
            showModalMessage('Error', 'Failed to fetch litters');
        } finally {
            setLitterSearchLoading(false);
        }
    };
    
    // Trigger litter fetch when link modal is opened or filter criteria change
    useEffect(() => {
        if (showLinkLitterModal && formData.species) {
            fetchLittersForLinking();
        }
    }, [showLinkLitterModal, newBreedingRecord.mateAnimalId, newBreedingRecord.birthEventDate]);
    
    // Fetch offspring for a breeding record when expanded
    const fetchOffspringForBreedingRecord = async (recordId, litterId) => {
        if (!litterId) return;
        
        try {
            // Fetch the litter to get offspring IDs
            const litterResponse = await axios.get(
                `${API_BASE_URL}/litters`,
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            const litter = litterResponse.data.find(l => l.litter_id_public === litterId);
            if (!litter) {
                setBreedingRecordOffspring(prev => ({ ...prev, [recordId]: [] }));
                return;
            }
            
            // Store the litter data for display
            setBreedingRecordLitters(prev => ({ ...prev, [recordId]: litter }));
            
            if (!litter.offspringIds_public || litter.offspringIds_public.length === 0) {
                setBreedingRecordOffspring(prev => ({ ...prev, [recordId]: [] }));
                return;
            }
            
            // Fetch animals that match the offspring IDs
            const animalsResponse = await axios.get(
                `${API_BASE_URL}/animals`,
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            const offspring = animalsResponse.data.filter(a => 
                litter.offspringIds_public.includes(a.id_public)
            );
            
            setBreedingRecordOffspring(prev => ({ ...prev, [recordId]: offspring }));
        } catch (error) {
            console.error('Error fetching offspring for breeding record:', error);
            setBreedingRecordOffspring(prev => ({ ...prev, [recordId]: [] }));
        }
    };
    
    // Fetch offspring when a breeding record is expanded
    useEffect(() => {
        Object.entries(expandedBreedingRecords).forEach(([recordId, isExpanded]) => {
            if (isExpanded) {
                const record = breedingRecords.find(r => r.id === recordId);
                if (record && record.litterId && !breedingRecordOffspring[recordId]) {
                    fetchOffspringForBreedingRecord(recordId, record.litterId);
                }
            }
        });
    }, [expandedBreedingRecords, breedingRecords]);
    
    // Fetch litter data for all breeding records with litterId (for collapsed view display)
    useEffect(() => {
        const fetchAllLitterData = async () => {
            try {
                const litterResponse = await axios.get(
                    `${API_BASE_URL}/litters`,
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );
                
                const litters = litterResponse.data;
                const litterMap = {};
                
                breedingRecords.forEach(record => {
                    if (record.litterId && !breedingRecordLitters[record.id]) {
                        const litter = litters.find(l => l.litter_id_public === record.litterId);
                        if (litter) {
                            litterMap[record.id] = litter;
                        }
                    }
                });
                
                if (Object.keys(litterMap).length > 0) {
                    setBreedingRecordLitters(prev => ({ ...prev, ...litterMap }));
                }
            } catch (error) {
                console.error('Error fetching litter data for breeding records:', error);
            }
        };
        
        if (breedingRecords.length > 0) {
            fetchAllLitterData();
        }
    }, [breedingRecords]);
    
    // Fetch offspring for all breeding records with litterId (on initial load when editing)
    useEffect(() => {
        const fetchAllOffspring = async () => {
            try {
                // Get all litters first
                const litterResponse = await axios.get(
                    `${API_BASE_URL}/litters`,
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );
                
                // Get all animals
                const animalsResponse = await axios.get(
                    `${API_BASE_URL}/animals`,
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );
                
                const litters = litterResponse.data;
                const allAnimals = animalsResponse.data;
                const offspringMap = {};
                
                breedingRecords.forEach(record => {
                    if (record.litterId && !breedingRecordOffspring[record.id]) {
                        const litter = litters.find(l => l.litter_id_public === record.litterId);
                        if (litter && litter.offspringIds_public && litter.offspringIds_public.length > 0) {
                            const offspring = allAnimals.filter(a => 
                                litter.offspringIds_public.includes(a.id_public)
                            );
                            if (offspring.length > 0) {
                                offspringMap[record.id] = offspring;
                            }
                        }
                    }
                });
                
                if (Object.keys(offspringMap).length > 0) {
                    setBreedingRecordOffspring(prev => ({ ...prev, ...offspringMap }));
                }
            } catch (error) {
                console.error('Error fetching offspring for breeding records:', error);
            }
        };
        
        if (breedingRecords.length > 0) {
            fetchAllOffspring();
        }
    }, [breedingRecords]);
    
    const addMedicalCondition = () => {
        if (!newMedicalCondition.name) {
            showModalMessage('Missing Data', 'Please enter a condition name.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            name: newMedicalCondition.name,
            notes: newMedicalCondition.notes || ''
        };
        setMedicalConditionsArray([...medicalConditionsArray, record]);
        setNewMedicalCondition({ name: '', notes: '' });
    };
    
    const addAllergy = () => {
        if (!newAllergy.name) {
            showModalMessage('Missing Data', 'Please enter an allergy name.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            name: newAllergy.name,
            notes: newAllergy.notes || ''
        };
        setAllergiesArray([...allergiesArray, record]);
        setNewAllergy({ name: '', notes: '' });
    };
    
    const addMedication = () => {
        if (!newMedication.name) {
            showModalMessage('Missing Data', 'Please enter a medication name.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            name: newMedication.name,
            notes: newMedication.notes || ''
        };
        setMedicationsArray([...medicationsArray, record]);
        setNewMedication({ name: '', notes: '' });
    };
    
    const addVetVisit = () => {
        if (!newVetVisit.date || !newVetVisit.reason) {
            showModalMessage('Missing Data', 'Please enter at least a date and visit reason.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            date: newVetVisit.date,
            reason: newVetVisit.reason,
            notes: newVetVisit.notes || ''
        };
        setVetVisitsArray([...vetVisitsArray, record]);
        setNewVetVisit({ date: new Date().toISOString().substring(0, 10), reason: '', notes: '' });
    };

    const addMedicalProcedure = () => {
        if (!newProcedure.date || !newProcedure.name) {
            showModalMessage('Missing Data', 'Please enter at least a date and procedure name.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            date: newProcedure.date,
            name: newProcedure.name,
            notes: newProcedure.notes || ''
        };
        setMedicalProcedureRecords([...medicalProcedureRecords, record]);
        setNewProcedure({ date: new Date().toISOString().substring(0, 10), name: '', notes: '' });
    };

    const addLabResult = () => {
        if (!newLabResult.date || !newLabResult.testName) {
            showModalMessage('Missing Data', 'Please enter at least a date and test name.');
            return;
        }
        const record = {
            id: Date.now().toString(),
            date: newLabResult.date,
            testName: newLabResult.testName,
            result: newLabResult.result || '',
            notes: newLabResult.notes || ''
        };
        setLabResultRecords([...labResultRecords, record]);
        setNewLabResult({ date: new Date().toISOString().substring(0, 10), testName: '', result: '', notes: '' });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(false);

        // Validate all required fields regardless of which tab is currently active.
        // Tab switching does not submit the form so HTML5 `required` attributes are
        // bypassed ? we must enforce these explicitly before any network call.
        const missingFields = [];
        if (!formData.name?.trim())    missingFields.push('Name (Overview tab)');
        if (!formData.species?.trim()) missingFields.push('Species (Overview tab)');
        if (!formData.gender?.trim())  missingFields.push('Gender (Overview tab)');
        if (!formData.birthDate)       missingFields.push('Date of Birth (Overview tab)');
        if (!formData.status?.trim())  missingFields.push('Status (Overview tab)');

        if (missingFields.length > 0) {
            showModalMessage(
                'Required Fields Missing',
                `Please fill in the following required fields before saving:\n\n? ${missingFields.join('\n? ')}`
            );
            return;
        }

        setLoading(true);
        
        const method = animalToEdit ? 'put' : 'post';
        const url = animalToEdit ? `${API_BASE_URL}/animals/${animalToEdit.id_public}` : `${API_BASE_URL}/animals`;

        try {
            // Upload animal image first (if selected)
                let uploadedFilename = null;
                if (animalImageFile) {
                console.log('[IMAGE UPLOAD] Starting upload:', {
                    fileName: animalImageFile.name,
                    fileSize: animalImageFile.size,
                    fileType: animalImageFile.type
                });
                try {
                    const fd = new FormData();
                    fd.append('file', animalImageFile);
                    fd.append('type', 'animal');
                    console.log('[IMAGE UPLOAD] Sending to:', `${API_BASE_URL}/upload`);
                    const uploadResp = await axios.post(`${API_BASE_URL}/upload`, fd, { 
                        headers: { 
                            'Content-Type': 'multipart/form-data', 
                            Authorization: `Bearer ${authToken}` 
                        },
                        timeout: 60000 // 60 second timeout
                    });
                    console.log('[IMAGE UPLOAD] Response received:', uploadResp?.status, uploadResp?.data);
                    // Build payload explicitly instead of mutating state directly
                    if (uploadResp?.data?.url) {
                        formData.imageUrl = uploadResp.data.url;
                        console.log('[IMAGE UPLOAD] URL set:', uploadResp.data.url);
                    }
                    if (uploadResp?.data?.filename) {
                        uploadedFilename = uploadResp.data.filename;
                    }
                } catch (uploadErr) {
                    console.error('[IMAGE UPLOAD] Upload failed:', {
                        message: uploadErr.message,
                        response: uploadErr?.response?.data,
                        status: uploadErr?.response?.status
                    });
                    showModalMessage('Image Upload', 'Failed to upload animal image. The record will be saved without the image.');
                }
            } else {
                console.log('[IMAGE UPLOAD] No image file to upload');
            }

            // Validate parents were alive at animal's birth date
            if (formData.birthDate && (formData.fatherId_public || formData.motherId_public)) {
                const animalBirthDate = new Date(formData.birthDate);
                
                // Check father
                if (formData.fatherId_public && fatherInfo) {
                    try {
                        // Fetch full father details to get deceased date
                        const fatherResp = await axios.get(`${API_BASE_URL}/animals?id_public=${encodeURIComponent(formData.fatherId_public)}`, {
                            headers: { Authorization: `Bearer ${authToken}` }
                        });
                        const father = fatherResp.data?.[0];
                        if (father?.deceasedDate) {
                            const fatherDeceasedDate = new Date(father.deceasedDate);
                            if (fatherDeceasedDate < animalBirthDate) {
                                setLoading(false);
                                showModalMessage('Error', `Father (${father.name}) was deceased before this animal's birth date`);
                                return;
                            }
                        }
                    } catch (err) {
                        console.warn('Could not validate father deceased date:', err);
                    }
                }
                
                // Check mother
                if (formData.motherId_public && motherInfo) {
                    try {
                        // Fetch full mother details to get deceased date
                        const motherResp = await axios.get(`${API_BASE_URL}/animals?id_public=${encodeURIComponent(formData.motherId_public)}`, {
                            headers: { Authorization: `Bearer ${authToken}` }
                        });
                        const mother = motherResp.data?.[0];
                        if (mother?.deceasedDate) {
                            const motherDeceasedDate = new Date(mother.deceasedDate);
                            if (motherDeceasedDate < animalBirthDate) {
                                setLoading(false);
                                showModalMessage('Error', `Mother (${mother.name}) was deceased before this animal's birth date`);
                                return;
                            }
                        }
                    } catch (err) {
                        console.warn('Could not validate mother deceased date:', err);
                    }
                }
            }

            // Prepare explicit payload to send to the API and log it for debugging
            // Merge in any immediate pedigree selections stored in `pedigreeRef` to avoid race conditions
            const payloadToSave = { ...formData };
            
            // Include growth records
            payloadToSave.growthRecords = growthRecords;
            payloadToSave.measurementUnits = measurementUnits;
            
            // Include health records - map to correct field names and serialize if needed
            payloadToSave.vaccinations = vaccinationRecords.length > 0 ? JSON.stringify(vaccinationRecords) : null;
            payloadToSave.vaccinationRecords = vaccinationRecords; // Keep for backward compat
            payloadToSave.dewormingRecords = dewormingRecordsArray.length > 0 ? JSON.stringify(dewormingRecordsArray) : null;
            payloadToSave.dewormingRecordsArray = dewormingRecordsArray; // Keep for backward compat
            payloadToSave.parasiteControl = parasiteControlRecords.length > 0 ? JSON.stringify(parasiteControlRecords) : null;
            payloadToSave.parasiteControlRecords = parasiteControlRecords; // Keep for backward compat
            payloadToSave.medicalConditions = medicalConditionsArray.length > 0 ? JSON.stringify(medicalConditionsArray) : null;
            payloadToSave.allergies = allergiesArray.length > 0 ? JSON.stringify(allergiesArray) : null;
            payloadToSave.medications = medicationsArray.length > 0 ? JSON.stringify(medicationsArray) : null;
            payloadToSave.vetVisits = vetVisitsArray.length > 0 ? JSON.stringify(vetVisitsArray) : null;
            payloadToSave.medicalProcedures = medicalProcedureRecords.length > 0 ? JSON.stringify(medicalProcedureRecords) : null;
            payloadToSave.medicalProcedureRecords = medicalProcedureRecords; // Keep for backward compat
            payloadToSave.labResults = labResultRecords.length > 0 ? JSON.stringify(labResultRecords) : null;
            payloadToSave.labResultRecords = labResultRecords; // Keep for backward compat
            
            // Include breeding records (clean up enum fields to prevent validation errors)
            payloadToSave.breedingRecords = breedingRecords.map(record => ({
                ...record,
                breedingMethod: record.breedingMethod || 'Unknown',
                outcome: record.outcome || 'Unknown',
                breedingConditionAtTime: record.breedingConditionAtTime || null,
                birthMethod: record.birthMethod || null,
                // Cache litter name from linked litter so view panels can show it without a separate fetch
                litterName: breedingRecordLitters[record.id]?.breedingPairCodeName || record.litterName || null,
            }));
            
            // Debug log for breeding records
            console.log('[DEBUG] Breeding records being saved:', payloadToSave.breedingRecords);
            payloadToSave.breedingRecords.forEach((record, index) => {
                console.log(`[DEBUG] Saving record ${index} mate data:`, {
                    mate: record.mate,
                    mateAnimalId: record.mateAnimalId,
                    litterId: record.litterId,
                    id: record.id
                });
            });
            
            // Debug log for health records
            console.log('[DEBUG] Health records in payload:', {
                vaccinations: payloadToSave.vaccinations,
                dewormingRecords: payloadToSave.dewormingRecords,
                parasiteControl: payloadToSave.parasiteControl,
                medicalConditions: payloadToSave.medicalConditions,
                allergies: payloadToSave.allergies,
                medications: payloadToSave.medications,
                vaccinationRecordsCount: vaccinationRecords.length,
                dewormingRecordsCount: dewormingRecordsArray.length,
                parasiteControlCount: parasiteControlRecords.length
            });
            
            // keeperHistory (Keeper History) is managed directly in formData by the user
            
            // Handle image deletion
            if (deleteImage && animalToEdit) {
                payloadToSave.imageUrl = null;
                payloadToSave.photoUrl = null;
                payloadToSave.profileImage = null;
                payloadToSave.image_path = null;
                console.log('[IMAGE DELETE] Image deletion requested');
            }
            
            // Validate deceased date: remove if it's before birth date
            if (payloadToSave.deceasedDate && payloadToSave.birthDate) {
                const birthDate = new Date(payloadToSave.birthDate);
                const deceasedDate = new Date(payloadToSave.deceasedDate);
                if (deceasedDate < birthDate) {
                    console.log('[VALIDATION] Deceased date is before birth date, removing it');
                    payloadToSave.deceasedDate = '';
                }
            }
            
            // Determine final parent values (pedigreeRef takes precedence if set, otherwise use formData)
            const finalFatherId = pedigreeRef.current.father !== undefined ? pedigreeRef.current.father : formData.fatherId_public;
            const finalMotherId = pedigreeRef.current.mother !== undefined ? pedigreeRef.current.mother : formData.motherId_public;
            
            console.log('[DEBUG] Parent removal check:', {
                pedigreeRefFather: pedigreeRef.current.father,
                pedigreeRefMother: pedigreeRef.current.mother,
                formDataFather: formData.fatherId_public,
                formDataMother: formData.motherId_public,
                finalFatherId,
                finalMotherId
            });
            
            // include backend objectIds for parents when available (but not if null - clearing)
            if (pedigreeRef.current.fatherBackendId) {
                payloadToSave.father = pedigreeRef.current.fatherBackendId;
            } else if (finalFatherId === null) {
                payloadToSave.father = null;
            }
            if (pedigreeRef.current.motherBackendId) {
                payloadToSave.mother = pedigreeRef.current.motherBackendId;
            } else if (finalMotherId === null) {
                payloadToSave.mother = null;
            }
            
            payloadToSave.fatherId_public = finalFatherId;
            payloadToSave.motherId_public = finalMotherId;

            // Include common alias fields (keep as strings to support CTU/CTC format)
            // Always send father fields (even if null to clear)
            payloadToSave.fatherId = finalFatherId;
            payloadToSave.father_id = finalFatherId;
            payloadToSave.father_public = finalFatherId;
            payloadToSave.sireId_public = finalFatherId;
            
            // Always send mother fields (even if null to clear)
            payloadToSave.motherId = finalMotherId;
            payloadToSave.mother_id = finalMotherId;
            payloadToSave.mother_public = finalMotherId;
            payloadToSave.damId_public = finalMotherId;
            
            console.log('[DEBUG] Final payload parent fields:', {
                fatherId_public: payloadToSave.fatherId_public,
                motherId_public: payloadToSave.motherId_public,
                sireId_public: payloadToSave.sireId_public,
                damId_public: payloadToSave.damId_public
            });
            
            console.log('[DEBUG] Breeder field in payload:', {
                breederId_public: payloadToSave.breederId_public,
                manualBreederName: payloadToSave.manualBreederName,
                keeperName: payloadToSave.keeperName
            });

            // If an image URL was set by the upload step, also populate common alternate keys
            // so backend implementations that expect different field names still receive the URL.
            const returnedUrl = payloadToSave.imageUrl || payloadToSave.photoUrl || payloadToSave.profileImage || payloadToSave.image_path || null;
            if (returnedUrl) {
                payloadToSave.imageUrl = payloadToSave.imageUrl || returnedUrl;
                payloadToSave.photoUrl = payloadToSave.photoUrl || returnedUrl;
                payloadToSave.profileImage = payloadToSave.profileImage || returnedUrl;
                payloadToSave.profileImageUrl = payloadToSave.profileImageUrl || returnedUrl;
                payloadToSave.image_path = payloadToSave.image_path || returnedUrl;
                payloadToSave.photo = payloadToSave.photo || returnedUrl;
                payloadToSave.image_url = payloadToSave.image_url || returnedUrl;
            }

            // Expose the final payload to the page for easy runtime inspection in DevTools
            try {
                try {
                    window.__lastAnimalPayload = payloadToSave;
                    console.debug('window.__lastAnimalPayload set (inspect in console)');
                } catch (exposeErr) {
                    console.warn('Could not set window.__lastAnimalPayload:', exposeErr);
                }
                console.debug('Animal payload about to be saved:', payloadToSave);
                console.log('[APPEARANCE FIELDS] Checking payload:', {
                    size: payloadToSave.size,
                    phenotype: payloadToSave.phenotype,
                    morph: payloadToSave.morph,
                    markings: payloadToSave.markings,
                    eyeColor: payloadToSave.eyeColor,
                    nailColor: payloadToSave.nailColor,
                    weight: payloadToSave.weight,
                    length: payloadToSave.length
                });

                console.log('[SAVE] About to call onSave:', { method, url });
                const saveResponse = await onSave(method, url, payloadToSave);
                console.log('[SAVE] onSave completed successfully:', saveResponse?.status);
            } catch (saveErr) {
                // If we uploaded a file but the animal save failed, attempt cleanup to avoid orphan files.
                console.error('[SAVE] Error in onSave:', saveErr);
                if (uploadedFilename) {
                    try {
                        await axios.delete(`${API_BASE_URL}/upload/${uploadedFilename}`, { headers: { Authorization: `Bearer ${authToken}` } });
                    } catch (cleanupErr) {
                        console.warn('Failed to cleanup uploaded file after save failure:', cleanupErr?.response?.data || cleanupErr.message);
                    }
                }
                throw saveErr;
            }

            // For new animals, notify the list to reload. For edits, the list
            // is updated in-place by handleSaveAnimal � no full reload needed.
            if (!animalToEdit) {
                try { window.dispatchEvent(new Event('animals-changed')); } catch (e) { /* ignore */ }
            }

            console.log('[SAVE] Showing success message and closing form');
            showModalMessage('Success', `Animal ${formData.name} successfully ${animalToEdit ? 'updated' : 'added'}!`);
            onCancel(); 
        } catch (error) {
            console.error('Animal Save Error:', error.response?.data || error.message);
            console.error('Animal Save Error (full):', error);
            showModalMessage('Error', error.response?.data?.message || `Failed to ${animalToEdit ? 'update' : 'add'} animal.`);
        } finally {
            console.log('[SAVE] Setting loading to false');
            setLoading(false);
        }
    };
    
    const currentId = animalToEdit?.id_public;
    const requiredGender = modalTarget === 'father' ? 'Male' : 
                           modalTarget === 'mother' ? 'Female' : 
                           modalTarget === 'other-parent' ? ['Intersex', 'Unknown'] : 
                           modalTarget === 'mate' ? (
                               formData.gender === 'Male' ? ['Female', 'Intersex', 'Unknown'] :
                               formData.gender === 'Female' ? ['Male', 'Intersex', 'Unknown'] :
                               null // Intersex/Unknown can mate with any gender
                           ) : null;

    return (
        <div className="w-full max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg">
            {/* --- Parent Search Modal --- */}
            {modalTarget && modalTarget !== 'breeder' && modalTarget !== 'other-parent' && modalTarget !== 'mate' && ( 
                <ParentSearchModal
                    title={modalTarget === 'father' ? 'Sire' : 'Dam'} 
                    currentId={currentId} 
                    onSelect={handleSelectPedigree} 
                    onClose={() => setModalTarget(null)} 
                    authToken={authToken} 
                    showModalMessage={showModalMessage}
                    API_BASE_URL={API_BASE_URL}
                    X={X}
                    Search={Search}
                    Loader2={Loader2}
                    LoadingSpinner={LoadingSpinner}
                    requiredGender={requiredGender}
                    birthDate={formData.birthDate}
                    species={formData.species}
                /> 
            )}

            {/* --- Other Parent Search Modal (Intersex/Unknown) --- */}
            {modalTarget === 'other-parent' && ( 
                <ParentSearchModal
                    title="Other Parent" 
                    currentId={currentId} 
                    onSelect={handleSelectPedigree} 
                    onClose={() => setModalTarget(null)} 
                    authToken={authToken} 
                    showModalMessage={showModalMessage}
                    API_BASE_URL={API_BASE_URL}
                    X={X}
                    Search={Search}
                    Loader2={Loader2}
                    LoadingSpinner={LoadingSpinner}
                    requiredGender={requiredGender}
                    birthDate={formData.birthDate}
                    species={formData.species}
                /> 
            )}

            {/* --- Breeder Search Modal --- */}
            {modalTarget === 'breeder' && (
                <UserSearchModal
                    onClose={() => setModalTarget(null)}
                    onSelectUser={handleSelectPedigree}
                    showModalMessage={showModalMessage}
                    API_BASE_URL={API_BASE_URL}
                    modalTarget={modalTarget}
                    userProfile={userProfile}
                />
            )}

            {/* --- Mate Search Modal (for breeding records) --- */}
            {modalTarget === 'mate' && (
                <ParentSearchModal
                    title="Mate"
                    currentId={currentId}
                    onSelect={handleSelectMate}
                    onClose={() => setModalTarget(null)}
                    authToken={authToken}
                    showModalMessage={showModalMessage}
                    API_BASE_URL={API_BASE_URL}
                    X={X}
                    Search={Search}
                    Loader2={Loader2}
                    LoadingSpinner={LoadingSpinner}
                    requiredGender={requiredGender}
                    birthDate={null}
                    species={formData.species}
                />
            )}

            {/* --- Parent Role Selection Modal (for Intersex/Unknown) --- */}
            {pendingParentAnimal && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">Assign Parent Role</h3>
                        <p className="text-gray-600 mb-6">
                            {pendingParentAnimal.prefix && `${pendingParentAnimal.prefix} `}
                            {pendingParentAnimal.name}
                            {pendingParentAnimal.suffix && ` ${pendingParentAnimal.suffix}`}
                            <br />
                            <span className="text-sm text-gray-500">({pendingParentAnimal.id_public})</span>
                        </p>
                        <p className="text-gray-700 mb-4 font-medium">
                            How would you like to assign this {pendingParentAnimal.gender} animal?
                        </p>
                        <div className="flex gap-3">
                            <button
                                type="button"
                                onClick={() => {
                                    setPendingParentForRole('father');
                                    handleSelectPedigree(pendingParentAnimal, 'father');
                                    setPendingParentAnimal(null);
                                    setPendingParentForRole(null);
                                }}
                                className="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition"
                            >
                                As Sire
                            </button>
                            <button
                                type="button"
                                onClick={() => {
                                    setPendingParentForRole('mother');
                                    handleSelectPedigree(pendingParentAnimal, 'mother');
                                    setPendingParentAnimal(null);
                                    setPendingParentForRole(null);
                                }}
                                className="flex-1 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg transition"
                            >
                                As Dam
                            </button>
                        </div>
                        <button
                            type="button"
                            onClick={() => {
                                setPendingParentAnimal(null);
                                setPendingParentForRole(null);
                            }}
                            className="w-full mt-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            )}

            {/* --- Create Litter Modal --- */}
            {showCreateLitterModal && breedingRecordForLitter && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-96 overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-bold text-gray-800">Create Litter</h3>
                            <button onClick={() => setShowCreateLitterModal(false)} className="text-gray-500 hover:text-gray-700">
                                <X size={24} />
                            </button>
                        </div>
                        
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            const litterData = {
                                sireId_public: formData.get('sireId_public') || (formData.get('gender') === 'Male' ? animalToEdit?.id_public : null),
                                damId_public: formData.get('damId_public') || (formData.get('gender') === 'Female' ? animalToEdit?.id_public : null),
                                species: formData.get('species'),
                                birthDate: formData.get('birthDate') || breedingRecordForLitter.birthEventDate,
                                litterSizeBorn: parseInt(formData.get('litterSizeBorn')) || breedingRecordForLitter.litterSizeBorn || 0,
                                stillbornCount: parseInt(formData.get('stillbornCount')) || breedingRecordForLitter.stillbornCount || 0,
                                litterSizeWeaned: parseInt(formData.get('litterSizeWeaned')) || breedingRecordForLitter.litterSizeWeaned || 0,
                                // Legacy fields for backward compatibility
                                numberBorn: parseInt(formData.get('litterSizeBorn')) || breedingRecordForLitter.litterSizeBorn || 0,
                                stillborn: parseInt(formData.get('stillbornCount')) || breedingRecordForLitter.stillbornCount || 0,
                                numberWeaned: parseInt(formData.get('litterSizeWeaned')) || breedingRecordForLitter.litterSizeWeaned || 0,
                                // Enhanced breeding record fields
                                breedingMethod: formData.get('breedingMethod') || breedingRecordForLitter.breedingMethod || 'Unknown',
                                breedingConditionAtTime: formData.get('breedingConditionAtTime') || breedingRecordForLitter.breedingConditionAtTime || null,
                                matingDate: formData.get('matingDate') || breedingRecordForLitter.matingDate || '',
                                outcome: formData.get('outcome') || breedingRecordForLitter.outcome || 'Unknown',
                                birthMethod: formData.get('birthMethod') || breedingRecordForLitter.birthMethod || null,
                                notes: formData.get('notes') || breedingRecordForLitter.notes || ''
                            };
                            handleCreateLitterFromBreeding(litterData);
                        }} className="space-y-3">
                            
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Sire ID</label>
                                <input type="text" name="sireId_public" defaultValue={formData.gender === 'Male' || formData.gender === 'Intersex' ? animalToEdit?.id_public : ''} 
                                    className="w-full text-xs p-2 border border-gray-300 rounded-md" placeholder="Leave blank if unknown" />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Dam ID</label>
                                <input type="text" name="damId_public" defaultValue={formData.gender === 'Female' || formData.gender === 'Intersex' ? animalToEdit?.id_public : ''} 
                                    className="w-full text-xs p-2 border border-gray-300 rounded-md" placeholder="Leave blank if unknown" />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Species</label>
                                <input type="text" name="species" value={formData.species} readOnly 
                                    className="w-full text-xs p-2 border border-gray-300 rounded-md bg-gray-100" />
                            </div>

                            {/* Enhanced breeding information */}
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Breeding Method</label>
                                    <select name="breedingMethod" defaultValue={breedingRecordForLitter.breedingMethod || 'Unknown'} 
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md">
                                        <option value="Natural">Natural</option>
                                        <option value="AI">AI</option>
                                        <option value="Assisted">Assisted</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Condition</label>
                                    <select name="breedingConditionAtTime" defaultValue={breedingRecordForLitter.breedingConditionAtTime || ''} 
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md">
                                        <option value="">Unknown</option>
                                        <option value="Good">Good</option>
                                        <option value="Okay">Okay</option>
                                        <option value="Poor">Poor</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Mating Dates</label>
                                <input type="text" name="matingDate" defaultValue={breedingRecordForLitter.matingDate || ''} 
                                    className="w-full text-xs p-2 border border-gray-300 rounded-md" placeholder="e.g., 2024-01-15" />
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Birth Method</label>
                                    <select name="birthMethod" defaultValue={breedingRecordForLitter.birthMethod || ''} 
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md">
                                        <option value="">Unknown</option>
                                        <option value="Natural">Natural</option>
                                        <option value="C-Section">C-Section</option>
                                        <option value="Assisted">Assisted</option>
                                        <option value="Induced">Induced</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Outcome</label>
                                    <select name="outcome" defaultValue={breedingRecordForLitter.outcome || 'Unknown'} 
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md">
                                        <option value="Successful">Successful</option>
                                        <option value="Unsuccessful">Unsuccessful</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Birth Date</label>
                                <input type="date" name="birthDate" defaultValue={breedingRecordForLitter.birthEventDate ? new Date(breedingRecordForLitter.birthEventDate).toISOString().substring(0, 10) : ''} 
                                    className="w-full text-xs p-2 border border-gray-300 rounded-md" />
                            </div>
                            
                            <div className="grid grid-cols-3 gap-2">
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Born</label>
                                    <input type="number" name="litterSizeBorn" defaultValue={breedingRecordForLitter.litterSizeBorn || 0} min="0"
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md" />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Stillborn</label>
                                    <input type="number" name="stillbornCount" defaultValue={breedingRecordForLitter.stillbornCount || 0} min="0"
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md" />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Weaned</label>
                                    <input type="number" name="litterSizeWeaned" defaultValue={breedingRecordForLitter.litterSizeWeaned || 0} min="0"
                                        className="w-full text-xs p-2 border border-gray-300 rounded-md" />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                                <textarea name="notes" defaultValue={breedingRecordForLitter.notes || ''} rows="2"
                                    className="w-full text-xs p-2 border border-gray-300 rounded-md" placeholder="Litter notes..." />
                            </div>
                            
                            <div className="flex gap-2 pt-4">
                                <button type="submit" disabled={loading} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg transition">
                                    {loading ? 'Creating...' : 'Create Litter'}
                                </button>
                                <button type="button" onClick={() => setShowCreateLitterModal(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* --- Link Litter Modal --- */}
            {showLinkLitterModal && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-96 overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-bold text-gray-800">Link Existing Litter</h3>
                            <button onClick={() => setShowLinkLitterModal(false)} className="text-gray-500 hover:text-gray-700">
                                <X size={24} />
                            </button>
                        </div>
                        
                        {litterSearchLoading ? (
                            <div className="text-center py-8">
                                <LoadingSpinner />
                                <p className="text-gray-600 mt-2">Loading litters...</p>
                            </div>
                        ) : existingLitters.length === 0 ? (
                            <div className="text-center py-6 text-gray-600">
                                <p>No matching litters found for {formData.species}</p>
                                <p className="text-xs text-gray-500 mt-2">Try creating a new litter instead</p>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {existingLitters.map((litter) => (
                                    <button
                                        key={litter._id}
                                        type="button"
                                        onClick={() => handleLinkLitterToBreeding(litter)}
                                        className="w-full text-left p-3 border border-green-200 rounded-lg hover:bg-green-50 transition"
                                    >
                                        <div className="font-semibold text-green-700">{litter.litter_id_public}</div>
                                        <div className="text-xs text-gray-600 space-y-1">
                                            {litter.sireId_public && <div>Sire: {litter.sireId_public}</div>}
                                            {litter.damId_public && <div>Dam: {litter.damId_public}</div>}
                                            {litter.birthDate && <div>Born: {formatDate(litter.birthDate)}</div>}
                                            {litter.numberBorn && <div>{litter.numberBorn} born &bull; {litter.stillborn || 0} stillborn &bull; {litter.numberWeaned || 0} weaned</div>}
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}
                        
                        <button type="button" onClick={() => setShowLinkLitterModal(false)} className="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                            Cancel
                        </button>
                    </div>
                </div>
            )}

            {/* --- Conflict Resolution Modal --- */}
            {showConflictModal && conflictData && (
                <ConflictResolutionModal 
                    conflicts={conflictData.conflicts}
                    litter={conflictData.litter}
                    onResolve={handleConflictResolution}
                    onCancel={() => {
                        setShowConflictModal(false);
                        setConflictData(null);
                        setShowLinkLitterModal(false);
                    }}
                />
            )}

            <h2 className="text-3xl font-bold text-gray-800 mb-6 flex items-center justify-between">
                <span>
                    <PlusCircle size={24} className="inline mr-2 text-primary" /> 
                    {formTitle}
                </span>
                <button 
                    onClick={onCancel} 
                    className="text-gray-500 hover:text-gray-700 transition duration-150 p-2 rounded-lg"
                    title="Back to List"
                >
                    <ArrowLeft size={24} />
                </button>
            </h2>

            <form onSubmit={handleSubmit} className="space-y-6">
                
                {/* Tab Navigation */}
                <div className="border border-gray-300 -mx-6 px-6 pt-4">
                    <div className="flex flex-wrap gap-1 pb-px">
                        {[
                            { id: 1, label: 'Overview', icon: '📋' },
                            { id: 2, label: 'Status & Privacy', icon: '🔒' },
                            { id: 3, label: 'Physical', icon: '🎨' },
                            { id: 4, label: 'Identification', icon: '🏷️' },
                            { id: 5, label: 'Lineage', icon: '🌳' },
                            { id: 6, label: 'Breeding', icon: '🥚' },
                            { id: 7, label: 'Health', icon: '🏥' },
                            { id: 8, label: 'Animal Care', icon: '🏠' },
                            { id: 9, label: 'Behavior', icon: '🧠' },
                            { id: 10, label: 'Records', icon: '📝' },
                            { id: 11, label: 'End of Life', icon: '⚖️' },
                            { id: 12, label: 'Show', icon: '🏆' },
                            { id: 13, label: 'Legal', icon: '📄' },
                            { id: 14, label: 'Logs', icon: '📜' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                type="button"
                                onClick={() => setActiveTab(tab.id)}
                                data-tutorial-target={tab.id === 2 ? 'status-privacy-tab' : tab.id === 3 ? 'physical-tab' : tab.id === 4 ? 'identification-tab' : tab.id === 5 ? 'lineage-tab' : tab.id === 6 ? 'breeding-tab' : tab.id === 7 ? 'health-tab' : tab.id === 8 ? 'husbandry-tab' : tab.id === 9 ? 'behavior-tab' : tab.id === 10 ? 'records-tab' : tab.id === 11 ? 'end-of-life-tab' : tab.id === 12 ? 'show-tab' : undefined}
                                className={`flex-shrink-0 px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium rounded border transition-colors ${
                                    activeTab === tab.id 
                                        ? 'bg-primary text-black border-gray-400' 
                                        : 'bg-gray-50 text-gray-600 hover:text-gray-800 border-gray-300'
                                }`}
                                title={tab.label}
                            >
                                <span className="mr-1">{tab.icon}</span>
                                <span className="hidden lg:inline">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
                
                {/* Tab 1: Overview - Core Identity */}
                {activeTab === 1 && (
                    <div className="space-y-6">
                        {/* Image Upload */}
                        <div>
                            <AnimalImageUpload 
                                imageUrl={animalImagePreview} 
                                onFileChange={async (e) => {
                                    if (e.target.files && e.target.files[0]) {
                                        const original = e.target.files[0];
                                        try {
                                            let compressedBlob = null;
                                            try {
                                                compressedBlob = await compressImageWithWorker(original, 200 * 1024, { maxWidth: 1200, maxHeight: 1200, startQuality: 0.85 });
                                            } catch (werr) {
                                                compressedBlob = null;
                                            }
                                            if (!compressedBlob) {
                                                try {
                                                    compressedBlob = await compressImageToMaxSize(original, 200 * 1024, { maxWidth: 1200, maxHeight: 1200, startQuality: 0.85 });
                                                } catch (err) {
                                                    compressedBlob = await compressImageFile(original, { maxWidth: 1200, maxHeight: 1200, quality: 0.8 });
                                                }
                                            }
                                            const baseName = original.name.replace(/\.[^/.]+$/, '') || 'image';
                                            const compressedFile = new File([compressedBlob], `${baseName}.jpg`, { type: 'image/jpeg' });
                                            if (compressedBlob.size > 200 * 1024) {
                                                showModalMessage('Image Compression', 'Image was compressed but is still larger than 200KB.');
                                            }
                                            setAnimalImageFile(compressedFile);
                                            setAnimalImagePreview(URL.createObjectURL(compressedFile));
                                        } catch (err) {
                                            setAnimalImageFile(original);
                                            setAnimalImagePreview(URL.createObjectURL(original));
                                        }
                                    }
                                }}
                                onDeleteImage={() => {
                                    setAnimalImageFile(null);
                                    setAnimalImagePreview(null);
                                    setDeleteImage(true);
                                }}
                                disabled={loading}
                                Trash2={Trash2}
                            />
                        </div>
                        
                        {/* Identity Fields */}
                        <div data-tutorial-target="animal-name-section" className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">Identity</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {!isFieldHidden('prefix') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Prefix</label>
                                    <input type="text" name="prefix" value={formData.prefix} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                )}
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Name*</label>
                                    <input type="text" name="name" value={formData.name} onChange={handleChange} required 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                
                                {!isFieldHidden('suffix') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Suffix</label>
                                    <input type="text" name="suffix" value={formData.suffix} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                )}
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Gender*</label>
                                    <select name="gender" value={formData.gender} onChange={handleChange} required 
                                        data-tutorial-target="animal-gender-select"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        {GENDER_OPTIONS.map(g => <option key={g} value={g}>{g}</option>)}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Date of Birth*</label>
                                    <DatePicker name="birthDate" value={formData.birthDate} onChange={handleChange} maxDate={new Date()} required
                                        data-tutorial-target="animal-birthdate-input"
                                        className="mt-1 p-2" />
                                </div>
                                
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700">Status*</label>
                                    <select name="status" value={formData.status} onChange={handleChange} required 
                                        data-tutorial-target="animal-status-select"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="Pet">Pet - Personal animal, not for breeding/sale</option>
                                        <option value="Breeder">Breeder - Active breeding animal</option>
                                        <option value="Available">Available - For sale</option>
                                        <option value="Booked">Booked - Reserved/deposit received</option>
                                        <option value="Retired">Retired - No longer breeding</option>
                                        <option value="Deceased">Deceased - Animal has passed away</option>
                                        <option value="Rehomed">Rehomed - Sold/given to new home</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">
                                        Status tracks the animal's current state. Use "For Sale" or "For Stud" options in the Privacy tab to control showcase visibility.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Tab 2: Status & Privacy */}
                {activeTab === 2 && (
                    <div className="space-y-6">
                        {/* Ownership */}
                        <div data-tutorial-target="ownership-section" className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">⭐ Breeder</h3>
                            
                            <div className="space-y-3">
                                <div>
                                    <label className='block text-sm font-medium text-gray-700 mb-2'>Breeder (User)</label>
                                    <div 
                                        onClick={() => !loading && setModalTarget('breeder')}
                                        className="flex flex-col items-start p-3 border border-gray-300 rounded-lg bg-white cursor-pointer hover:border-primary transition"
                                    >
                                        <div className="flex items-center space-x-2 w-full">
                                            {formData.breederId_public && breederInfo ? (
                                                <span className="text-gray-800">
                                                    {(() => {
                                                        const showPersonal = breederInfo.showPersonalName ?? false;
                                                        const showBreeder = breederInfo.showBreederName ?? false;
                                                        if (showPersonal && showBreeder && breederInfo.personalName && breederInfo.breederName) {
                                                            return `${breederInfo.personalName} (${breederInfo.breederName})`;
                                                        } else if (showBreeder && breederInfo.breederName) {
                                                            return breederInfo.breederName;
                                                        } else if (showPersonal && breederInfo.personalName) {
                                                            return breederInfo.personalName;
                                                        } else {
                                                            return 'Unknown Breeder';
                                                        }
                                                    })()}
                                                </span>
                                            ) : (
                                                <span className="text-gray-400">
                                                    {formData.breederId_public ? 'Loading...' : 'Click to Select Breeder'}
                                                </span>
                                            )}
                                            {formData.breederId_public && (
                                                <button
                                                    type="button"
                                                    onClick={(e) => { e.stopPropagation(); clearBreederSelection(); }}
                                                    title="Clear breeder selection"
                                                    className="text-sm text-red-500 hover:text-red-700 p-1 rounded"
                                                >
                                                    <X size={14} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {!isFieldHidden('manualBreederName') && (
                                <div>
                                    <label className='block text-sm font-medium text-gray-700 mb-2'>Breeder (Manual Name)</label>
                                    <input 
                                        type="text" 
                                        name="manualBreederName" 
                                        value={formData.manualBreederName || ''} 
                                        onChange={(e) => {
                                            handleChange(e);
                                            if (e.target.value.trim() && formData.breederId_public) {
                                                clearBreederSelection();
                                            }
                                        }}
                                        placeholder="Enter breeder name (if not a registered user)"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Use this if the breeder is not a registered user on the platform.</p>
                                </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Current Owner */}
                        <div data-tutorial-target="current-owner-field" className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">🏠 Keeper</h3>
                            {!isFieldHidden('isOwned') && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label className="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg bg-white hover:bg-gray-50 transition">
                                    <input type="checkbox" name="isOwned" checked={formData.isOwned} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">Currently Owned by Me</span>
                                </label>
                            </div>
                            )}
                            {!isFieldHidden('keeperName') && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className='block text-sm font-medium text-gray-700 mb-2'>{getFieldLabel('keeperName', 'Keeper Name')}</label>
                                    <input 
                                        type="text" 
                                        name="keeperName" 
                                        value={formData.keeperName || ''} 
                                        onChange={handleChange}
                                        placeholder="Keeper name (person caring for this animal)"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Records keeper changes in keeper history.</p>
                                </div>
                            </div>
                            )}

                            {/* Co-ownership - Template controlled */}
                            {!isFieldHidden('coOwnership') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('coOwnership', 'Co-Ownership')}</label>
                                    <textarea name="coOwnership" value={formData.coOwnership || ''} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Co-owner name, terms, breeding rights" />
                                </div>
                            )}
                        </div>

                        {/* Keeper History */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">?? Keeper History</h3>

                            {/* Existing entries */}
                            {(formData.keeperHistory || []).length > 0 && (
                                <div className="space-y-2">
                                    {(formData.keeperHistory || []).map((entry, idx) => (
                                        <div key={idx} className="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-3">
                                            <div className="flex items-center gap-2 min-w-0">
                                                {entry.country && <span className={`${getCountryFlag(entry.country)} inline-block h-4 w-6 flex-shrink-0`}></span>}
                                                <div className="min-w-0">
                                                    <p className="text-sm font-medium text-gray-800 truncate">{entry.name || 'Anonymous'}</p>
                                                    {entry.userId_public && <p className="text-xs text-gray-400 font-mono">{entry.userId_public}</p>}
                                                    {entry.country && <p className="text-xs text-gray-500">{getCountryName(entry.country)}</p>}
                                                </div>
                                            </div>
                                            <button type="button" onClick={() => setFormData(prev => ({ ...prev, keeperHistory: (prev.keeperHistory || []).filter((_, i) => i !== idx) }))} className="text-red-400 hover:text-red-600 p-1 flex-shrink-0 ml-2">
                                                <X size={14} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Add new entry */}
                            <div className="bg-white border border-dashed border-gray-300 rounded-lg p-3 space-y-3">
                                <p className="text-xs font-medium text-gray-500 uppercase tracking-wide">Add Entry</p>

                                {/* Mode toggle */}
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => { setKhMode('manual'); setKhSelectedUser(null); setKhUserSearch(''); setKhUserResults([]); }} className={`px-3 py-1 text-xs rounded-full border transition ${khMode === 'manual' ? 'bg-gray-700 text-white border-gray-700' : 'bg-white text-gray-600 border-gray-300 hover:border-gray-500'}`}>Manual Name</button>
                                    <button type="button" onClick={() => setKhMode('user')} className={`px-3 py-1 text-xs rounded-full border transition ${khMode === 'user' ? 'bg-gray-700 text-white border-gray-700' : 'bg-white text-gray-600 border-gray-300 hover:border-gray-500'}`}>Select User</button>
                                </div>

                                {khMode === 'manual' ? (
                                    <input type="text" value={khName} onChange={e => setKhName(e.target.value)} placeholder="Keeper name" className="block w-full p-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary" />
                                ) : (
                                    <div className="space-y-2">
                                        <div className="flex gap-2">
                                            <input type="text" value={khUserSearch} onChange={e => { setKhUserSearch(e.target.value); setKhUserResults([]); setKhSelectedUser(null); setKhName(''); }} placeholder="Search by name or CTUID" className="flex-1 p-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary" />
                                            <button type="button" disabled={khSearching || !khUserSearch.trim()} onClick={async () => {
                                                if (!khUserSearch.trim()) return;
                                                setKhSearching(true);
                                                try {
                                                    const res = await axios.get(`${API_BASE_URL}/public/profiles/search?query=${encodeURIComponent(khUserSearch.trim())}&limit=10`);
                                                    setKhUserResults(res.data || []);
                                                } catch(e) {}
                                                setKhSearching(false);
                                            }} className="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded disabled:opacity-40 transition flex-shrink-0">
                                                {khSearching ? <Loader2 size={14} className="animate-spin" /> : <Search size={14} />}
                                            </button>
                                        </div>
                                        {khUserResults.length > 0 && !khSelectedUser && (
                                            <div className="border border-gray-200 rounded divide-y divide-gray-100 max-h-44 overflow-y-auto bg-white shadow-sm">
                                                {khUserResults.map(u => {
                                                    const showP = u.showPersonalName ?? false;
                                                    const showB = u.showBreederName ?? false;
                                                    const dName = (showP && showB && u.personalName && u.breederName) ? `${u.personalName} (${u.breederName})` : (showB && u.breederName) ? u.breederName : (showP && u.personalName) ? u.personalName : 'Anonymous';
                                                    return (
                                                        <button key={u.id_public} type="button" onClick={() => { setKhSelectedUser(u); setKhName(dName); setKhCountry(u.country || ''); setKhUserResults([]); }} className="w-full text-left px-3 py-2 hover:bg-gray-50 flex items-center gap-2">
                                                            {u.profileImage && u.profileImage !== 'present' ? <img src={u.profileImage} className="w-7 h-7 rounded-full object-cover flex-shrink-0" alt="" /> : <div className="w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><User size={12} className="text-gray-400" /></div>}
                                                            <div className="min-w-0 flex-1">
                                                                <p className="text-sm font-medium text-gray-800 truncate">{dName}</p>
                                                                <p className="text-xs text-gray-400 font-mono">{u.id_public}</p>
                                                            </div>
                                                            {u.country && <span className={`${getCountryFlag(u.country)} inline-block h-4 w-6 flex-shrink-0`}></span>}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        )}
                                        {khSelectedUser && (
                                            <div className="flex items-center gap-3 bg-blue-50 border border-blue-200 rounded-lg p-2">
                                                {khSelectedUser.profileImage && khSelectedUser.profileImage !== 'present' ? <img src={khSelectedUser.profileImage} className="w-9 h-9 rounded-full object-cover flex-shrink-0" alt="" /> : <div className="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><User size={14} className="text-gray-400" /></div>}
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-semibold text-gray-800 truncate">{khName}</p>
                                                    <p className="text-xs text-gray-500 font-mono">{khSelectedUser.id_public}</p>
                                                </div>
                                                {khSelectedUser.country && <span className={`${getCountryFlag(khSelectedUser.country)} inline-block h-4 w-6 flex-shrink-0`}></span>}
                                                <button type="button" onClick={() => { setKhSelectedUser(null); setKhName(''); setKhUserSearch(''); setKhCountry(''); }} className="text-gray-400 hover:text-gray-600 p-0.5"><X size={13} /></button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Country dropdown */}
                                <select value={khCountry} onChange={e => setKhCountry(e.target.value)} className="block w-full p-2 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary">
                                    <option value="">Country (optional)</option>
                                    {[['US','United States'],['CA','Canada'],['GB','United Kingdom'],['AU','Australia'],['NZ','New Zealand'],['DE','Germany'],['FR','France'],['IT','Italy'],['ES','Spain'],['NL','Netherlands'],['SE','Sweden'],['NO','Norway'],['DK','Denmark'],['CH','Switzerland'],['BE','Belgium'],['AT','Austria'],['PL','Poland'],['CZ','Czech Republic'],['IE','Ireland'],['PT','Portugal'],['GR','Greece'],['RU','Russia'],['JP','Japan'],['KR','South Korea'],['CN','China'],['IN','India'],['BR','Brazil'],['MX','Mexico'],['ZA','South Africa'],['SG','Singapore'],['HK','Hong Kong'],['MY','Malaysia'],['TH','Thailand']].map(([code, name]) => (
                                        <option key={code} value={code}>{name}</option>
                                    ))}
                                </select>

                                <button type="button" disabled={!khName.trim()} onClick={() => {
                                    const entry = { name: khName.trim(), userId_public: khSelectedUser?.id_public || null, country: khCountry || null };
                                    setFormData(prev => ({ ...prev, keeperHistory: [...(prev.keeperHistory || []), entry] }));
                                    setKhName(''); setKhCountry(''); setKhSelectedUser(null); setKhUserSearch(''); setKhUserResults([]);
                                }} className="w-full py-1.5 bg-gray-700 hover:bg-gray-800 text-white text-sm rounded transition disabled:opacity-40 disabled:cursor-not-allowed">
                                    + Add Entry
                                </button>
                            </div>
                        </div>
                        
                        {/* Availability for Sale/Stud */}
                        <div data-tutorial-target="availability-for-sale-stud" className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">🏷️🥚 Availability for Sale or Stud</h3>
                            <p className="text-xs text-gray-500">Enable "For Sale" or "For Stud" to make this animal visible in the public showcase (requires Public Profile enabled)</p>
                            
                            {/* For Sale Section */}
                            {!isFieldHidden('isForSale') && (
                            <div className="bg-white p-4 rounded-lg border border-gray-200 space-y-3">
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" name="isForSale" checked={formData.isForSale} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">🏷️ Available for Sale</span>
                                </div>
                                {formData.isForSale && (
                                    <div className="ml-7 flex gap-2">
                                        <select name="salePriceCurrency" value={formData.salePriceCurrency} onChange={handleChange} 
                                            className="block w-24 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="USD">USD ($)</option>
                                            <option value="EUR">EUR (�)</option>
                                            <option value="GBP">GBP (�)</option>
                                            <option value="CAD">CAD (C$)</option>
                                            <option value="AUD">AUD (A$)</option>
                                            <option value="JPY">JPY (�)</option>
                                            <option value="Negotiable">Negotiable</option>
                                        </select>
                                        <input type="number" name="salePriceAmount" value={formData.salePriceAmount || ''} onChange={handleChange} 
                                            className="block flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="Price amount" min="0" step="0.01" disabled={formData.salePriceCurrency === 'Negotiable'} />
                                    </div>
                                )}
                            </div>
                            )}
                            
                            {/* For Stud Section */}
                            {!isFieldHidden('availableForBreeding') && (
                            <div className="bg-white p-4 rounded-lg border border-gray-200 space-y-3">
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" name="availableForBreeding" checked={formData.availableForBreeding} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">🥚 Available for Stud</span>
                                </div>
                                {formData.availableForBreeding && (
                                    <div className="ml-7 flex gap-2">
                                        <select name="studFeeCurrency" value={formData.studFeeCurrency || 'USD'} onChange={handleChange} 
                                            className="block w-24 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="USD">USD ($)</option>
                                            <option value="EUR">EUR (�)</option>
                                            <option value="GBP">GBP (�)</option>
                                            <option value="CAD">CAD (C$)</option>
                                            <option value="AUD">AUD (A$)</option>
                                            <option value="JPY">JPY (�)</option>
                                            <option value="Negotiable">Negotiable</option>
                                        </select>
                                        <input type="number" name="studFeeAmount" value={formData.studFeeAmount || ''} onChange={handleChange} 
                                            className="block flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="Fee amount" min="0" step="0.01" disabled={formData.studFeeCurrency === 'Negotiable'} />
                                    </div>
                                )}
                            </div>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Tab 3: Physical Profile */}
                {activeTab === 3 && (
                    <div className="space-y-6">
                        {/* Appearance */}
                        <div data-tutorial-target="appearance-section" className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">✨ Appearance</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {!isFieldHidden('color') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('color', 'Color')}</label>
                                    <input type="text" name="color" value={formData.color} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                )}
                                
                                {!isFieldHidden('coatPattern') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('coatPattern', 'Pattern')}</label>
                                    <input type="text" name="coatPattern" value={formData.coatPattern} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Solid, Hooded, Brindle" />
                                </div>
                                )}
                                
                                {!isFieldHidden('coat') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">{getFieldLabel('coat', 'Coat Type')}</label>
                                        <input type="text" name="coat" value={formData.coat} onChange={handleChange} 
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Short, Long, Rex" />
                                    </div>
                                )}
                                
                                {!isFieldHidden('earset') && (formData.species === 'Rat' || formData.species === 'Fancy Rat') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">{getFieldLabel('earset', 'Earset')}</label>
                                        <input type="text" name="earset" value={formData.earset} onChange={handleChange} 
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Standard, Dumbo" />
                                    </div>
                                )}
                                
                                {!isFieldHidden('phenotype') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('phenotype', 'Phenotype')}</label>
                                    <input type="text" name="phenotype" value={formData.phenotype || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Observable traits" />
                                </div>
                                )}
                                
                                {!isFieldHidden('morph') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('morph', 'Morph')}</label>
                                    <input type="text" name="morph" value={formData.morph || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Mutation/Morph" />
                                </div>
                                )}
                                
                                {!isFieldHidden('markings') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('markings', 'Markings')}</label>
                                    <input type="text" name="markings" value={formData.markings || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Body markings/patterns" />
                                </div>
                                )}
                                
                                {!isFieldHidden('eyeColor') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('eyeColor', 'Eye Color')}</label>
                                    <input type="text" name="eyeColor" value={formData.eyeColor || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Eye color" />
                                </div>
                                )}
                                
                                {!isFieldHidden('nailColor') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('nailColor', 'Nail Color')}</label>
                                    <input type="text" name="nailColor" value={formData.nailColor || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Nail/claw color" />
                                </div>
                                )}
                                
                                {!isFieldHidden('carrierTraits') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('carrierTraits', 'Carrier Traits')}</label>
                                    <input type="text" name="carrierTraits" value={formData.carrierTraits || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Genetic traits carried" />
                                </div>
                                )}

                                {!isFieldHidden('size') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('size', 'Size')}</label>
                                    <input type="text" name="size" value={formData.size || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Standard, Dwarf" />
                                </div>
                                )}
                            </div>


                        </div>

                        {/* Genetic Code */}
                        {!isFieldHidden('geneticCode') && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700 mb-4">🧬 {getFieldLabel('geneticCode', 'Genetic Code')}</h3>
                                <GeneticCodeBuilder
                                    species={formData.species}
                                    gender={formData.gender}
                                    value={formData.geneticCode}
                                    onChange={(value) => setFormData(prev => ({ ...prev, geneticCode: value }))}
                                    onOpenCommunityForm={() => setShowCommunityGeneticsModal(true)}
                                />
                            </div>
                        )}

                        {/* Life Stage */}
                        {!isFieldHidden('lifeStage') && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🌱 Life Stage</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <select name="lifeStage" value={formData.lifeStage} onChange={handleChange} 
                                        data-tutorial-target="life-stage-select"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="">Select Life Stage</option>
                                        <option value="Newborn">Newborn</option>
                                        <option value="Juvenile">Juvenile</option>
                                        <option value="Adult">Adult</option>
                                        <option value="Senior">Senior</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        )}

                        {/* Measurements & Growth Tracking */}
                        <div data-tutorial-target="measurements-growth-section" className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <div className="mb-4">
                                <h3 className="text-lg font-semibold text-gray-700">📏 Measurements & Growth Tracking</h3>
                                <p className="text-xs text-gray-600 mt-1">Current measurements & growth history</p>
                            </div>
                            
                            {/* Current Measurement Display */}
                            {growthRecords.length > 0 && (() => {
                                const sorted = [...growthRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                                const mostRecentWeight = sorted[0];
                                const mostRecentLength = sorted.find(r => r.length);
                                const mostRecentHeight = sorted.find(r => r.height);
                                const mostRecentGirth = sorted.find(r => r.chestGirth);
                                
                                return (
                                    <div data-tutorial-target="current-measurements-growth-chart" className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">Current Measurements</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
                                            <div>
                                                <span className="text-xs text-gray-600">Weight:</span>
                                                <p className="font-medium">{mostRecentWeight.weight} {measurementUnits.weight}</p>
                                            </div>
                                            {mostRecentLength && mostRecentLength.length && (
                                                <div>
                                                    <span className="text-xs text-gray-600">Body Length:</span>
                                                    <p className="font-medium">{mostRecentLength.length} {measurementUnits.length}</p>
                                                </div>
                                            )}
                                            {mostRecentHeight && mostRecentHeight.height && (
                                                <div>
                                                    <span className="text-xs text-gray-600">Height:</span>
                                                    <p className="font-medium">{mostRecentHeight.height} {measurementUnits.length}</p>
                                                </div>
                                            )}
                                            {mostRecentGirth && mostRecentGirth.chestGirth && (
                                                <div>
                                                    <span className="text-xs text-gray-600">Chest Girth:</span>
                                                    <p className="font-medium">{mostRecentGirth.chestGirth} {measurementUnits.length}</p>
                                                </div>
                                            )}
                                            {mostRecentWeight.bcs && (
                                                <div>
                                                    <span className="text-xs text-gray-600">BCS:</span>
                                                    <p className="font-medium">{mostRecentWeight.bcs}</p>
                                                </div>
                                            )}
                                            <div>
                                                <span className="text-xs text-gray-600">Date:</span>
                                                <p className="font-medium">{mostRecentWeight.date}</p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Growth Curve Charts - Weight, Length, and Height */}
                            {growthRecords.length > 0 && (() => {
                                const sorted = [...growthRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                                const weights = sorted.map(r => parseFloat(r.weight) || 0).filter(w => w > 0);
                                const lengths = sorted
                                    .filter(record => record.length && !isNaN(parseFloat(record.length)))
                                    .map(record => parseFloat(record.length));
                                const heights = sorted
                                    .filter(record => record.height && !isNaN(parseFloat(record.height)))
                                    .map(record => parseFloat(record.height));
                                
                                if (weights.length < 1) return null;
                                
                                const width = 500;
                                const height = 250;
                                const margin = { top: 20, right: 30, bottom: 50, left: 70 };
                                const graphWidth = width - margin.left - margin.right;
                                const graphHeight = height - margin.top - margin.bottom;
                                
                                // Weight chart setup
                                const minWeight = Math.min(...weights);
                                const maxWeight = Math.max(...weights);
                                const weightPadding = (maxWeight - minWeight) * 0.1 || 5;
                                const weightChartMin = Math.max(0, minWeight - weightPadding);
                                const weightChartMax = maxWeight + weightPadding;
                                const weightRange = weightChartMax - weightChartMin;
                                
                                // Length chart setup
                                const hasLengthData = lengths.length >= 1;
                                let minLength, maxLength, lengthRange, lengthChartMin, lengthChartMax;
                                if (hasLengthData) {
                                    minLength = Math.min(...lengths);
                                    maxLength = Math.max(...lengths);
                                    const lengthPadding = (maxLength - minLength) * 0.1 || 1;
                                    lengthChartMin = Math.max(0, minLength - lengthPadding);
                                    lengthChartMax = maxLength + lengthPadding;
                                    lengthRange = lengthChartMax - lengthChartMin;
                                }
                                
                                // Height chart setup
                                const hasHeightData = heights.length >= 1;
                                let minHeight, maxHeight, heightRange, heightChartMin, heightChartMax;
                                if (hasHeightData) {
                                    minHeight = Math.min(...heights);
                                    maxHeight = Math.max(...heights);
                                    const heightPadding = (maxHeight - minHeight) * 0.1 || 1;
                                    heightChartMin = Math.max(0, minHeight - heightPadding);
                                    heightChartMax = maxHeight + heightPadding;
                                    heightRange = heightChartMax - heightChartMin;
                                }
                                
                                // Create points for weight
                                const weightPoints = sorted.map((record, idx) => ({
                    x: margin.left + (idx / Math.max(1, sorted.length - 1)) * graphWidth,
                    y: margin.top + graphHeight - ((parseFloat(record.weight) - weightChartMin) / weightRange) * graphHeight,
                    weight: record.weight,
                    length: record.length,
                    height: record.height,
                    bcs: record.bcs,
                    notes: record.notes,
                    date: record.date
                }));
                
                // Create points for length
                const lengthPoints = hasLengthData ? sorted.filter(r => r.length).map((record, idx) => ({
                    x: margin.left + (sorted.indexOf(record) / Math.max(1, sorted.length - 1)) * graphWidth,
                    y: margin.top + graphHeight - ((parseFloat(record.length) - lengthChartMin) / lengthRange) * graphHeight,
                    weight: record.weight,
                    length: record.length,
                    height: record.height,
                    bcs: record.bcs,
                    notes: record.notes,
                    date: record.date
                })) : [];
                
                // Create points for height
                const heightPoints = hasHeightData ? sorted.filter(r => r.height).map((record, idx) => ({
                    x: margin.left + (sorted.indexOf(record) / Math.max(1, sorted.length - 1)) * graphWidth,
                                    length: record.length,
                                    height: record.height,
                                    bcs: record.bcs,
                                    notes: record.notes,
                                    date: record.date
                                })) : [];
                                
                                const weightPathData = weightPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                const lengthPathData = lengthPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                const heightPathData = heightPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                
                                const getBCSDescription = (bcsValue) => {
                                    const bcsMap = {
                                        '1': 'Emaciated',
                                        '2': 'Thin',
                                        '3': 'Ideal',
                                        '4': 'Overweight',
                                        '5': 'Obese'
                                    };
                                    return bcsMap[bcsValue] || bcsValue;
                                };
                                
                                const renderChart = (points, label, color, pathData, chartMin, chartMax) => {
                                    const range = chartMax - chartMin;
                                    return (
                                        <svg key={`chart-${label}`} width="100%" height="300" viewBox={`0 0 ${width} ${height}`} style={{ maxWidth: '100%' }} preserveAspectRatio="xMidYMid meet">
                                            {/* Grid lines */}
                                            {[0, 0.25, 0.5, 0.75, 1].map((ratio, i) => {
                                                const y = margin.top + graphHeight * (1 - ratio);
                                                const axisLabel = (chartMin + range * ratio).toFixed(1);
                                                return (
                                                    <g key={`grid-${i}`}>
                                                        <line x1={margin.left} y1={y} x2={width - margin.right} y2={y} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4" />
                                                        <text x={margin.left - 12} y={y} textAnchor="end" dy="0.3em" fontSize="11" fill="#666">{axisLabel}</text>
                                                    </g>
                                                );
                                            })}
                                            
                                            {/* Axes */}
                                            <line x1={margin.left} y1={margin.top} x2={margin.left} y2={height - margin.bottom} stroke={color} strokeWidth="2" />
                                            <line x1={margin.left} y1={height - margin.bottom} x2={width - margin.right} y2={height - margin.bottom} stroke="#333" strokeWidth="2" />
                                            
                                            {/* Y-axis label */}
                                            <text x={20} y={margin.top + graphHeight / 2} textAnchor="middle" fontSize="12" fill={color} fontWeight="600" transform={`rotate(-90 20 ${margin.top + graphHeight / 2})`}>
                                                {label} ({label === 'Weight' ? measurementUnits.weight : measurementUnits.length})
                                            </text>
                                            
                                            {/* X-axis label */}
                                            <text x={margin.left + graphWidth / 2} y={height - 8} textAnchor="middle" fontSize="12" fill="#333" fontWeight="600">
                                                Date
                                            </text>
                                            
                                            {/* X-axis date labels */}
                                            {points.map((p, i) => (
                                                i % Math.max(1, Math.floor(points.length / 5)) === 0 && (
                                                    <text key={`date-${i}`} x={p.x} y={height - margin.bottom + 25} textAnchor="middle" fontSize="10" fill="#666">
                                                        {formatDate(p.date)}
                                                    </text>
                                                )
                                            ))}
                                            
                                            {/* Curve */}
                                            <path d={pathData} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                            
                                            {/* Points */}
                                            {points.map((p, i) => {
                                                const tooltipText = [
                                                    `Date: ${formatDate(p.date)}`,
                                                    `Weight: ${p.weight} ${measurementUnits.weight}`,
                                                    p.length ? `Length: ${p.length} ${measurementUnits.length}` : null,
                                                    p.bcs ? `BCS: ${p.bcs} - ${getBCSDescription(p.bcs)}` : null,
                                                    p.notes ? `Notes: ${p.notes}` : null
                                                ].filter(Boolean).join('\n');
                                                
                                                // Color gradient from green (earliest) to red (latest)
                                                const colorRatio = points.length > 1 ? i / (points.length - 1) : 0;
                                                let dotColor;
                                                if (colorRatio < 0.5) {
                                                    const t = colorRatio * 2;
                                                    const r = Math.round(144 + (255 - 144) * t);
                                                    const g = 191;
                                                    const b = Math.round(71 + (0 - 71) * t);
                                                    dotColor = `rgb(${r}, ${g}, ${b})`;
                                                } else {
                                                    const t = (colorRatio - 0.5) * 2;
                                                    const r = 255;
                                                    const g = Math.round(191 - (191) * t);
                                                    const b = 0;
                                                    dotColor = `rgb(${r}, ${g}, ${b})`;
                                                }
                                                
                                                return (
                                                    <circle key={`point-${i}`} cx={p.x} cy={p.y} r="5" fill={dotColor} stroke="#fff" strokeWidth="2">
                                                        <title>{tooltipText}</title>
                                                    </circle>
                                                );
                                            })}
                                        </svg>
                                    );
                                };
                                
                                return (
                                    <div className="space-y-4">
                                        {/* Weight Chart */}
                                        <div className="bg-white p-4 rounded-lg border border-gray-200">
                                            <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                <span className="inline-block w-3 h-1 bg-blue-500 rounded"></span>
                                                Weight Growth Curve
                                            </h4>
                                            {renderChart(weightPoints, 'Weight', '#3b82f6', weightPathData, weightChartMin, weightChartMax)}
                                            <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                        </div>
                                        
                                        {/* Length Chart */}
                                        {hasLengthData && (
                                            <div className="bg-white p-4 rounded-lg border border-gray-200">
                                                <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                    <span className="inline-block w-3 h-1 bg-orange-500 rounded"></span>
                                                    Body Length Growth Curve
                                                </h4>
                                                {renderChart(lengthPoints, 'Length', '#ff8c42', lengthPathData, lengthChartMin, lengthChartMax)}
                                                <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                            </div>
                                        )}
                                        
                                        {/* Height at Withers Chart */}
                                        {hasHeightData && (
                                            <div className="bg-white p-4 rounded-lg border border-gray-200">
                                                <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                    <span className="inline-block w-3 h-1 bg-purple-500 rounded"></span>
                                                    Height at Withers Growth Curve
                                                </h4>
                                                {renderChart(heightPoints, 'Height', '#9333ea', heightPathData, heightChartMin, heightChartMax)}
                                                <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}
                            
                            {/* Growth Records */}
                            <div className="space-y-3 mt-6">
                                <h4 className="text-sm font-semibold text-gray-600">Growth History</h4>
                                
                                {/* Unit Selection */}
                                <div className="bg-blue-50 p-3 rounded-lg border border-blue-200" data-tutorial-target="measurement-units-select">
                                    <p className="text-xs font-medium text-gray-700 mb-2">Measurement Units</p>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-600">Weight Unit</label>
                                            <select 
                                                value={measurementUnits.weight}
                                                onChange={(e) => setMeasurementUnits({...measurementUnits, weight: e.target.value})}
                                                className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary bg-white"
                                            >
                                                <option value="g">Grams (g)</option>
                                                <option value="kg">Kilograms (kg)</option>
                                                <option value="lb">Pounds (lb)</option>
                                                <option value="oz">Ounces (oz)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-600">Length Unit</label>
                                            <select 
                                                value={measurementUnits.length}
                                                onChange={(e) => setMeasurementUnits({...measurementUnits, length: e.target.value})}
                                                className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary bg-white"
                                            >
                                                <option value="cm">Centimeters (cm)</option>
                                                <option value="m">Meters (m)</option>
                                                <option value="in">Inches (in)</option>
                                                <option value="ft">Feet (ft)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Add New Measurement */}
                                <div className="bg-white p-3 rounded-lg border border-gray-300 space-y-3">
                                    <p className="text-xs font-medium text-gray-600">Add New Measurement</p>
                                    
                                    {/* Row 1: Date, Weight, Body Length, Height at Withers (Dog/Cat only) */}
                                    <div className={`grid gap-3 ${(formData.species === 'Dog' || formData.species === 'Cat') ? 'grid-cols-1 md:grid-cols-4' : 'grid-cols-1 md:grid-cols-3'}`}>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Date</label>
                                            <DatePicker 
                                                value={newMeasurement.date}
                                                onChange={(e) => setNewMeasurement({...newMeasurement, date: e.target.value})}
                                                className="mt-1 p-2 text-sm"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Weight ({measurementUnits.weight})</label>
                                            <input 
                                                type="number" 
                                                step="0.1"
                                                value={newMeasurement.weight}
                                                onChange={(e) => setNewMeasurement({...newMeasurement, weight: e.target.value})}
                                                placeholder={`e.g., ${measurementUnits.weight === 'g' ? '450' : measurementUnits.weight === 'kg' ? '0.45' : measurementUnits.weight === 'lb' ? '1' : '16'}`}
                                                className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">{getFieldLabel('length', 'Body Length')} ({measurementUnits.length})</label>
                                            <input 
                                                type="number" 
                                                step="0.1"
                                                value={newMeasurement.length}
                                                onChange={(e) => setNewMeasurement({...newMeasurement, length: e.target.value})}
                                                placeholder={`e.g., ${measurementUnits.length === 'cm' ? '20' : measurementUnits.length === 'm' ? '0.2' : measurementUnits.length === 'in' ? '8' : '0.66'}`}
                                                className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            />
                                        </div>
                                        {(formData.species === 'Dog' || formData.species === 'Cat') && (
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Height at Withers ({measurementUnits.length})</label>
                                                <input 
                                                    type="number" 
                                                    step="0.1"
                                                    value={newMeasurement.height}
                                                    onChange={(e) => setNewMeasurement({...newMeasurement, height: e.target.value})}
                                                    placeholder={`e.g., ${measurementUnits.length === 'cm' ? '25' : measurementUnits.length === 'm' ? '0.25' : measurementUnits.length === 'in' ? '10' : '0.83'}`}
                                                    className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                />
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Row 2: Chest Girth (Dog/Cat only), BCS, Notes */}
                                    <div className={`grid gap-3 ${(formData.species === 'Dog' || formData.species === 'Cat') ? 'grid-cols-1 md:grid-cols-3' : 'grid-cols-1 md:grid-cols-2'}`}>
                                        {(formData.species === 'Dog' || formData.species === 'Cat') && (
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Chest Girth ({measurementUnits.length})</label>
                                                <input 
                                                    type="number" 
                                                    step="0.1"
                                                    value={newMeasurement.chestGirth}
                                                    onChange={(e) => setNewMeasurement({...newMeasurement, chestGirth: e.target.value})}
                                                    placeholder={`e.g., ${measurementUnits.length === 'cm' ? '30' : measurementUnits.length === 'm' ? '0.3' : measurementUnits.length === 'in' ? '12' : '1'}`}
                                                    className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                />
                                            </div>
                                        )}
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Body Condition Score</label>
                                            <select 
                                                value={newMeasurement.bcs}
                                                onChange={(e) => setNewMeasurement({...newMeasurement, bcs: e.target.value})}
                                                className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                                <option value="">Select BCS</option>
                                                {formData.species === 'Dog' ? (
                                                    <>
                                                        <option value="1">1 - Emaciated</option>
                                                        <option value="2">2 - Very Thin</option>
                                                        <option value="3">3 - Thin</option>
                                                        <option value="4">4 - Underweight</option>
                                                        <option value="5">5 - Ideal</option>
                                                        <option value="6">6 - Overweight</option>
                                                        <option value="7">7 - Heavy</option>
                                                        <option value="8">8 - Obese</option>
                                                        <option value="9">9 - Severely Obese</option>
                                                    </>
                                                ) : formData.species === 'Cat' ? (
                                                    <>
                                                        <option value="1">1 - Emaciated</option>
                                                        <option value="2">2 - Lean</option>
                                                        <option value="3">3 - Ideal</option>
                                                        <option value="4">4 - Overweight</option>
                                                        <option value="5">5 - Obese</option>
                                                    </>
                                                ) : (
                                                    <>
                                                        <option value="1">1 - Emaciated</option>
                                                        <option value="2">2 - Thin</option>
                                                        <option value="3">3 - Ideal</option>
                                                        <option value="4">4 - Overweight</option>
                                                        <option value="5">5 - Obese</option>
                                                    </>
                                                )}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Notes</label>
                                            <input 
                                                type="text" 
                                                value={newMeasurement.notes}
                                                onChange={(e) => setNewMeasurement({...newMeasurement, notes: e.target.value})}
                                                placeholder="e.g., pregnant, sick"
                                                className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <button
                                        type="button"
                                        onClick={addMeasurement}
                                        data-tutorial-target="add-measurement-btn"
                                        className="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm font-medium"
                                    >
                                        Add Measurement
                                    </button>
                                </div>
                                
                                {/* Measurements List */}
                                {growthRecords.length > 0 && (
                                    <div className="space-y-2 bg-gray-50 p-3 rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                                        {growthRecords.map((record) => (
                                            <div key={record.id} className="flex items-center justify-between p-2 bg-white rounded border border-gray-100 text-sm">
                                                <div className="flex gap-4 text-gray-700 flex-1 flex-wrap">
                                                    <span className="font-medium">{record.date}</span>
                                                    <span>{record.weight} {measurementUnits.weight}</span>
                                                    {record.length && (
                                                        <span>L: {record.length} {measurementUnits.length}</span>
                                                    )}
                                                    {record.height && (
                                                        <span>H: {record.height} {measurementUnits.length}</span>
                                                    )}
                                                    {record.chestGirth && (
                                                        <span>G: {record.chestGirth} {measurementUnits.length}</span>
                                                    )}
                                                    {record.bcs && (
                                                        <>
                                                            <span className="mx-2"></span>
                                                            <span className="text-gray-700">BCS: {record.bcs}</span>
                                                        </>
                                                    )}
                                                    {record.notes && (
                                                        <span className="ml-2 text-xs text-gray-500 italic">({record.notes})</span>
                                                    )}
                                                </div>
                                                <button
                                                    type="button"
                                                    onClick={() => setGrowthRecords(growthRecords.filter(r => r.id !== record.id))}
                                                    className="text-red-500 hover:text-red-700 p-1"
                                                    title="Delete measurement"
                                                >
                                                    <Trash2 size={14} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                    </div>
                )}
                
                {/* Tab 4: Identification */}
                {activeTab === 4 && (
                    <div className="space-y-6">
                        {/* Identification Numbers */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">🔢 Identification Numbers</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('breederAssignedId') && (
                                <div data-tutorial-target="identification-breeder-id">
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('breederAssignedId', 'Identification')}</label>
                                    <input type="text" name="breederAssignedId" value={formData.breederAssignedId} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder={getFieldLabel('breederAssignedId', 'Identification')} />
                                </div>
                                )}
                                
                                {!isFieldHidden('microchipNumber') && (
                                <div data-tutorial-target="microchip-input">
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('microchipNumber', 'Microchip Number')}</label>
                                    <input type="text" name="microchipNumber" value={formData.microchipNumber} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                )}
                                
                                {!isFieldHidden('pedigreeRegistrationId') && (
                                <div data-tutorial-target="registration-id-input">
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('pedigreeRegistrationId', 'Pedigree Registration ID')}</label>
                                    <input type="text" name="pedigreeRegistrationId" value={formData.pedigreeRegistrationId} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                )}
                                
                                {!isFieldHidden('colonyId') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('colonyId', 'Colony ID')}</label>
                                    <input type="text" name="colonyId" value={formData.colonyId || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Colony or group identifier" />
                                </div>
                                )}

                                {/* Licensing fields moved to Tab 13: Legal & Documentation */}
                                {!isFieldHidden('rabiesTagNumber') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Rabies Tag Number</label>
                                        <input type="text" name="rabiesTagNumber" value={formData.rabiesTagNumber || ''} onChange={handleChange} 
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                )}
                                {!isFieldHidden('tattooId') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Tattoo ID</label>
                                        <input type="text" name="tattooId" value={formData.tattooId || ''} onChange={handleChange} 
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                )}
                            </div>

                            {/* Dog/Cat Registry Numbers - integrated */}
                            {(formData.species === 'Dog' || formData.species === 'Cat') && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {formData.species === 'Dog' && (
                                            <>
                                                {!isFieldHidden('akcRegistrationNumber') && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">AKC Registration #</label>
                                                    <input type="text" name="akcRegistrationNumber" value={formData.akcRegistrationNumber || ''} onChange={handleChange} 
                                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                                </div>
                                                )}
                                                {!isFieldHidden('fciRegistrationNumber') && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700">FCI Registration #</label>
                                                    <input type="text" name="fciRegistrationNumber" value={formData.fciRegistrationNumber || ''} onChange={handleChange} 
                                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                                </div>
                                                )}
                                            </>
                                        )}
                                        {formData.species === 'Cat' && !isFieldHidden('cfaRegistrationNumber') && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700">CFA Registration #</label>
                                                <input type="text" name="cfaRegistrationNumber" value={formData.cfaRegistrationNumber || ''} onChange={handleChange} 
                                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        )}
                                        {!isFieldHidden('workingRegistryIds') && (
                                        <div className={formData.species === 'Cat' ? '' : 'md:col-span-2'}>
                                            <label className="block text-sm font-medium text-gray-700">Working Registry IDs</label>
                                            <input type="text" name="workingRegistryIds" value={formData.workingRegistryIds || ''} onChange={handleChange} 
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                placeholder="Herding, Hunting, Service registrations" />
                                        </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                        
                        {/* Classification */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="classification-section">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">🗂️ Classification</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Species</label>
                                    <input type="text" value={formData.species} disabled 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-600" />
                                    <p className="text-xs text-gray-500 mt-1">Cannot be changed after creation</p>
                                </div>
                                
                                {!isFieldHidden('breed') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('breed', 'Breed')}</label>
                                    <input type="text" name="breed" value={formData.breed} onChange={handleChange} 
                                        data-tutorial-target="breed-select"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                )}
                                
                                {!isFieldHidden('strain') && (
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700">{getFieldLabel('strain', 'Strain')} {!fieldTemplate?.fields?.strain?.label && !speciesConfigs?.[formData.species]?.fieldReplacements?.strain && <span className="text-xs text-gray-500">(small mammals)</span>}</label>
                                        <input type="text" name="strain" value={formData.strain} onChange={handleChange} 
                                            data-tutorial-target="strain-input"
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder={getFieldLabel('strain', 'e.g., C57BL/6, Wistar, Syrian')} />
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Origin */}
                        {!isFieldHidden('origin') && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🌍 Origin</h3>
                                <label className="block text-sm font-medium text-gray-700">{getFieldLabel('origin', 'Origin')}</label>
                                <select name="origin" value={formData.origin || ''} onChange={handleChange}
                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                    <option value="">Select Origin</option>
                                    <option value="Captive-bred">Captive-bred</option>
                                    <option value="Wild-caught">Wild-caught</option>
                                    <option value="Rescue">Rescue</option>
                                </select>
                            </div>
                        )}

                        {/* Tags */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200" data-tutorial-target="tags-section">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">🏷️ Tags</h3>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Tags (Lines, Enclosures, etc)</label>
                            <input 
                                type="text" 
                                placeholder="Type and press Enter or comma to add tags" 
                                value={tagInput} 
                                onChange={(e) => setTagInput(e.target.value)}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' || e.key === ',') {
                                        e.preventDefault();
                                        const trimmed = tagInput.trim();
                                        if (trimmed && !formData.tags.includes(trimmed)) {
                                            setFormData({ ...formData, tags: [...formData.tags, trimmed] });
                                            setTagInput('');
                                        }
                                    } else if (e.key === 'Backspace' && !tagInput && formData.tags.length > 0) {
                                        // Remove last tag if backspace on empty input
                                        setFormData({ ...formData, tags: formData.tags.slice(0, -1) });
                                    }
                                }}
                                onBlur={() => {
                                    // Add tag on blur if there's content
                                    const trimmed = tagInput.trim();
                                    if (trimmed && !formData.tags.includes(trimmed)) {
                                        setFormData({ ...formData, tags: [...formData.tags, trimmed] });
                                        setTagInput('');
                                    }
                                }}
                                className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                            />
                            {formData.tags.length > 0 && (
                                <div className="mt-2 flex flex-wrap gap-2">
                                    {formData.tags.map((tag, idx) => (
                                        <span key={idx} className="inline-flex items-center bg-primary text-black text-xs font-semibold px-3 py-1 rounded-full">
                                            {tag}
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    const newTags = formData.tags.filter((_, i) => i !== idx);
                                                    setFormData({ ...formData, tags: newTags });
                                                }}
                                                className="ml-2 text-black hover:text-gray-600"
                                            >
                                            <Trash2 size={12} />
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Tab 5: Lineage & Offspring */}
                {activeTab === 5 && (
                    <div className="space-y-6">
                        {/* Pedigree Section */}
                        <div 
                            data-tutorial-target="pedigree-section"
                            className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4"
                        >
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">🌳 Pedigree: Sire and Dam</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div className='flex flex-col'>
                                    <label className='text-sm font-medium text-gray-600 mb-1'>Sire (Father)</label>
                                    <div 
                                        onClick={() => !loading && setModalTarget('father')}
                                        data-tutorial-target="select-sire-btn"
                                        className="flex flex-col items-start p-3 border border-gray-300 rounded-lg bg-white cursor-pointer hover:border-primary transition disabled:opacity-50"
                                    >
                                        <div className="flex items-center space-x-2 w-full">
                                        {formData.fatherId_public && fatherInfo ? (
                                            <span className="text-gray-800">
                                                {fatherInfo.prefix && `${fatherInfo.prefix} `}{fatherInfo.name}
                                            </span>
                                        ) : (
                                            <span className={formData.fatherId_public ? "text-gray-800 font-mono" : "text-gray-400"}>
                                                {formData.fatherId_public ? `${formData.fatherId_public}` : 'Click to Select Sire'}
                                            </span>
                                        )}
                                        {formData.fatherId_public && (
                                            <button
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearParentSelection('father'); }}
                                                title="Clear sire selection"
                                                className="text-sm text-red-500 hover:text-red-700 p-1 rounded"
                                            >
                                                <X size={14} />
                                            </button>
                                        )}
                                        </div>
                                    </div>
                                </div>
                                <div className='flex flex-col'>
                                    <label className='text-sm font-medium text-gray-600 mb-1'>Dam (Mother)</label>
                                    <div 
                                        onClick={() => !loading && setModalTarget('mother')}
                                        data-tutorial-target="select-dam-btn"
                                        className="flex flex-col items-start p-3 border border-gray-300 rounded-lg bg-white cursor-pointer hover:border-primary transition disabled:opacity-50"
                                    >
                                        <div className="flex items-center space-x-2 w-full">
                                            {formData.motherId_public && motherInfo ? (
                                                <span className="text-gray-800">
                                                    {motherInfo.prefix && `${motherInfo.prefix} `}{motherInfo.name}
                                                </span>
                                            ) : (
                                                <span className={formData.motherId_public ? "text-gray-800 font-mono" : "text-gray-400"}>
                                                    {formData.motherId_public ? `${formData.motherId_public}` : 'Click to Select Dam'}
                                                </span>
                                            )}
                                            {formData.motherId_public && (
                                                <button
                                                    type="button"
                                                    onClick={(e) => { e.stopPropagation(); clearParentSelection('mother'); }}
                                                    title="Clear dam selection"
                                                    className="text-sm text-red-500 hover:text-red-700 p-1 rounded"
                                                >
                                                    <X size={14} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className='flex flex-col'>
                                    <label className='text-sm font-medium text-gray-600 mb-1'>Other Parent</label>
                                    <div 
                                        onClick={() => !loading && setModalTarget('other-parent')}
                                        data-tutorial-target="select-other-parent-btn"
                                        className="flex flex-col items-start p-3 border border-gray-300 rounded-lg bg-white cursor-pointer hover:border-primary transition disabled:opacity-50"
                                    >
                                        <div className="flex items-center space-x-2 w-full">
                                            <span className="text-gray-400">
                                                Intersex/Unknown
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Breeding Records - ALWAYS SHOWN */}
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-4" data-tutorial-target="breeding-records-section">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 flex items-center mb-4"><span className="text-blue-600 mr-2">📊</span>Breeding Records</h3>
                            
                            {/* Breeding Role Selector - for animals with unclear breeding roles */}
                            {!isFieldHidden('breedingRole') && (formData.gender === 'Intersex' || formData.gender === 'Unknown') && (
                                <div className="bg-white p-3 rounded-lg border border-blue-200 mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-3">Breeding Role</label>
                                    <div className="flex gap-4">
                                        <label className="flex items-center space-x-2">
                                            <input type="radio" name="breedingRole" value="sire" 
                                                checked={formData.breedingRole === 'sire'} 
                                                onChange={(e) => setFormData({...formData, breedingRole: e.target.value})}
                                                className="w-4 h-4" />
                                            <span className="text-sm">Sire Only</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input type="radio" name="breedingRole" value="dam" 
                                                checked={formData.breedingRole === 'dam'} 
                                                onChange={(e) => setFormData({...formData, breedingRole: e.target.value})}
                                                className="w-4 h-4" />
                                            <span className="text-sm">Dam Only</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input type="radio" name="breedingRole" value="both" 
                                                checked={formData.breedingRole === 'both'} 
                                                onChange={(e) => setFormData({...formData, breedingRole: e.target.value})}
                                                className="w-4 h-4" />
                                            <span className="text-sm">Both Sire & Dam</span>
                                        </label>
                                    </div>
                                </div>
                            )}
                            
                            {/* Add New Breeding Record Form */}
                            <div className="bg-white p-4 rounded-lg border border-blue-200 space-y-4">
                                <h4 className="text-sm font-semibold text-gray-700">Add Breeding Record</h4>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {/* Common fields - all genders */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Breeding Method</label>
                                        <select value={newBreedingRecord.breedingMethod} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, breedingMethod: e.target.value})}
                                            className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="">Select method</option>
                                            <option value="Natural">Natural</option>
                                            <option value="AI">AI (Artificial Insemination)</option>
                                            <option value="Assisted">Assisted</option>
                                            <option value="Unknown">Unknown</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Breeding Condition</label>
                                        <select value={newBreedingRecord.breedingConditionAtTime || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, breedingConditionAtTime: e.target.value || null})}
                                            className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="">Select condition</option>
                                            <option value="Good">Good</option>
                                            <option value="Okay">Okay</option>
                                            <option value="Poor">Poor</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Mating Date</label>
                                        <DatePicker value={newBreedingRecord.matingDate || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, matingDate: e.target.value})}
                                            maxDate={new Date()}
                                            className="p-2 text-sm" />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Mate / Other Parent</label>
                                        <div className="space-y-2">
                                            {/* Selector / Display */}
                                            <div 
                                                onClick={() => !loading && setModalTarget('mate')}
                                                className="flex items-center justify-between p-3 border border-gray-300 rounded-lg bg-white cursor-pointer hover:border-primary transition"
                                            >
                                                <div className="flex items-center space-x-2 flex-1">
                                                    {newBreedingRecord.mateAnimalId && mateInfo ? (
                                                        <span className="text-gray-800 text-sm">
                                                            {mateInfo.prefix && `${mateInfo.prefix} `}{mateInfo.name}
                                                        </span>
                                                    ) : newBreedingRecord.mate ? (
                                                        <span className="text-gray-800 text-sm">{newBreedingRecord.mate}</span>
                                                    ) : (
                                                        <span className="text-gray-400 text-sm">Click to select from database</span>
                                                    )}
                                                </div>
                                                {(newBreedingRecord.mateAnimalId || newBreedingRecord.mate) && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); clearMateSelection(); }}
                                                        className="text-sm text-red-500 hover:text-red-700 p-1 rounded"
                                                        type="button"
                                                    >
                                                        <X size={14} />
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {/* Manual Entry Option */}
                                            <div className="text-xs text-gray-500">
                                                <span>Or enter manually: </span>
                                                <input 
                                                    type="text" 
                                                    value={newBreedingRecord.mate || ''} 
                                                    onChange={(e) => setNewBreedingRecord({...newBreedingRecord, mate: e.target.value || '', mateAnimalId: null})}
                                                    placeholder="Type name or ID"
                                                    className="ml-1 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-primary focus:border-primary"
                                                    onClick={(e) => e.stopPropagation()}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Outcome field - shown for all genders */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Outcome</label>
                                        <select value={newBreedingRecord.outcome || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, outcome: e.target.value || null})}
                                            className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="">Select outcome</option>
                                            <option value="Successful">Successful</option>
                                            <option value="Unsuccessful">Unsuccessful</option>
                                            <option value="Unknown">Unknown</option>
                                        </select>
                                    </div>
                                    
                                    {/* Birth date - shown for all genders */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Birth Date</label>
                                        <DatePicker value={newBreedingRecord.birthEventDate || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, birthEventDate: e.target.value})}
                                            maxDate={new Date()}
                                            className="p-2 text-sm" />
                                    </div>
                                    
                                    {/* Birth method - shown for all genders */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Birth Method</label>
                                        <select value={newBreedingRecord.birthMethod || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, birthMethod: e.target.value || null})}
                                            className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="">Select method</option>
                                            <option value="Natural">Natural</option>
                                            <option value="C-Section">C-Section</option>
                                            <option value="Assisted">Assisted</option>
                                            <option value="Induced">Induced</option>
                                            <option value="Unknown">Unknown</option>
                                        </select>
                                    </div>
                                    
                                    {/* Litter fields - shown for females and intersex if outcome is successful or not specified */}
                                    {(formData.gender === 'Female' || formData.gender === 'Intersex' || (formData.gender === 'Unknown' && (formData.breedingRole === 'dam' || formData.breedingRole === 'both'))) && (
                                        <>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Litter Size Born</label>
                                                <input type="number" value={newBreedingRecord.litterSizeBorn || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, litterSizeBorn: e.target.value ? parseInt(e.target.value) : null})}
                                                    placeholder="Number born" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Stillborn Count</label>
                                                <input type="number" value={newBreedingRecord.stillbornCount || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, stillbornCount: e.target.value ? parseInt(e.target.value) : null})}
                                                    placeholder="Stillborn" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Litter Size Weaned</label>
                                                <input type="number" value={newBreedingRecord.litterSizeWeaned || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, litterSizeWeaned: e.target.value ? parseInt(e.target.value) : null})}
                                                    placeholder="Number weaned" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        </>
                                    )}
                                    
                                    {/* Litter fields for males/sire if outcome is successful */}
                                    {(formData.gender === 'Male' || (formData.gender === 'Intersex' && newBreedingRecord.outcome === 'Successful') || ((formData.gender === 'Unknown' && (formData.breedingRole === 'sire' || formData.breedingRole === 'both')) && newBreedingRecord.outcome === 'Successful')) && newBreedingRecord.outcome === 'Successful' && (
                                        <>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Litter Size Born (Sire)</label>
                                                <input type="number" value={newBreedingRecord.litterSizeBorn || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, litterSizeBorn: e.target.value ? parseInt(e.target.value) : null})}
                                                    placeholder="Number born" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Stillborn Count (Sire)</label>
                                                <input type="number" value={newBreedingRecord.stillbornCount || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, stillbornCount: e.target.value ? parseInt(e.target.value) : null})}
                                                    placeholder="Stillborn" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Litter Size Weaned (Sire)</label>
                                                <input type="number" value={newBreedingRecord.litterSizeWeaned || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, litterSizeWeaned: e.target.value ? parseInt(e.target.value) : null})}
                                                    placeholder="Stillborn" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        </>
                                    )}

                                    {/* Offspring gender counts */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Males Born</label>
                                        <input type="number" value={newBreedingRecord.maleCount ?? ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, maleCount: e.target.value !== '' ? parseInt(e.target.value) : null})}
                                            placeholder="# males" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Females Born</label>
                                        <input type="number" value={newBreedingRecord.femaleCount ?? ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, femaleCount: e.target.value !== '' ? parseInt(e.target.value) : null})}
                                            placeholder="# females" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Unknown / Intersex Born</label>
                                        <input type="number" value={newBreedingRecord.unknownCount ?? ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, unknownCount: e.target.value !== '' ? parseInt(e.target.value) : null})}
                                            placeholder="# unknown/intersex" min="0" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                </div>
                                
                                {/* Notes */}
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea value={newBreedingRecord.notes || ''} onChange={(e) => setNewBreedingRecord({...newBreedingRecord, notes: e.target.value})}
                                        placeholder="Additional breeding record details..."
                                        rows="2" className="w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                </div>
                                
                                {/* Litter Link */}
                                <div>
                                    <label className="block text-xs font-medium text-gray-700 mb-1">Link to Litter</label>
                                    <div 
                                        onClick={() => !loading && setShowLinkLitterModal(true)}
                                        className="flex items-center justify-between p-3 border border-gray-300 rounded-lg bg-white cursor-pointer hover:border-primary transition"
                                    >
                                        <div className="flex items-center space-x-2 flex-1">
                                            {newBreedingRecord.litterId ? (
                                                <span className="text-gray-800 text-sm font-mono bg-purple-100 px-2 py-1 rounded">
                                                    {newBreedingRecord.litterId}
                                                </span>
                                            ) : (
                                                <span className="text-gray-400 text-sm">Click to select existing litter</span>
                                            )}
                                        </div>
                                        {newBreedingRecord.litterId && (
                                            <button 
                                                onClick={(e) => { 
                                                    e.stopPropagation(); 
                                                    setNewBreedingRecord({...newBreedingRecord, litterId: null}); 
                                                }}
                                                className="text-sm text-red-500 hover:text-red-700 p-1 rounded"
                                                type="button"
                                            >
                                                <X size={14} />
                                            </button>
                                        )}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Auto-fills blank fields when selected</p>
                                </div>
                                
                                <button type="button" onClick={addBreedingRecord} className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">
                                    Add Breeding Record
                                </button>
                            </div>
                            
                            {/* Breeding Records List - Accordion View */}
                            {breedingRecords.length > 0 && (
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-2">
                                    <h4 className="text-sm font-semibold text-gray-700 mb-2">Saved Breeding Records ({breedingRecords.length})</h4>
                                    <div className="space-y-2">
                                        {breedingRecords.map((record, idx) => {
                                            // Determine if this is a dam or sire record based on gender/role
                                            const isSireOnly = formData.gender === 'Male' || (formData.gender === 'Unknown' && formData.breedingRole === 'sire');
                                            const isDamOnly = formData.gender === 'Female' || (formData.gender === 'Unknown' && formData.breedingRole === 'dam');
                                            const isBoth = formData.gender === 'Intersex' || (formData.gender === 'Unknown' && formData.breedingRole === 'both');
                                            const isExpanded = expandedBreedingRecords[record.id];
                                            
                                            // Get litter data if available
                                            const linkedLitter = breedingRecordLitters[record.id];
                                            
                                            const countSummary = [
                                                record.litterSizeBorn !== null && `${record.litterSizeBorn} born`,
                                                record.stillbornCount && `${record.stillbornCount} stillborn`,
                                                record.litterSizeWeaned !== null && `${record.litterSizeWeaned} weaned`
                                            ].filter(Boolean).join(' � ') || 'No counts';
                                            
                                            return (
                                                <div key={record.id} className={`bg-white rounded border transition-all ${isExpanded ? 'border-blue-300 shadow-md' : 'border-blue-100'}`}>
                                                    {/* COLLAPSED HEADER */}
                                                    <div 
                                                        onClick={() => setExpandedBreedingRecords({...expandedBreedingRecords, [record.id]: !isExpanded})}
                                                        className="p-3 flex items-center justify-between cursor-pointer hover:bg-blue-50 transition rounded"
                                                    >
                                                        <div className="flex items-center gap-3 flex-1 min-w-0">
                                                            {/* Expand toggle */}
                                                            <span className={`text-lg transition-transform flex-shrink-0 ${isExpanded ? 'rotate-90' : ''}`}>▶️</span>
                                                            
                                                            {/* Main identifier: litter name prominent, CTL ID secondary */}
                                                            {(linkedLitter?.breedingPairCodeName || record.litterName) ? (
                                                                <>
                                                                    <span className="px-2 py-0.5 rounded text-xs font-bold bg-blue-700 text-white flex-shrink-0">
                                                                        {linkedLitter?.breedingPairCodeName || record.litterName}
                                                                    </span>
                                                                    {record.litterId && (
                                                                        <span className="text-xs font-mono text-gray-400 flex-shrink-0">{record.litterId}</span>
                                                                    )}
                                                                </>
                                                            ) : record.litterId ? (
                                                                <span className="font-mono px-2 py-0.5 rounded text-xs font-semibold flex-shrink-0 bg-blue-300 text-blue-800">{record.litterId}</span>
                                                            ) : null}
                                                            
                                                            {/* Summary: Birth date, mate, counts */}
                                                            <div className="text-sm text-gray-700 flex gap-2 truncate flex-wrap">
                                                                {/* Birth date from litter or record */}
                                                                {(linkedLitter?.birthDate || record.birthEventDate) && (
                                                                    <>
                                                                        <span className="flex-shrink-0">
                                                                            {formatDate(linkedLitter?.birthDate || record.birthEventDate)}
                                                                        </span>
                                                                        <span className="text-gray-400 flex-shrink-0">&bull;</span>
                                                                    </>
                                                                )}
                                                                
                                                                {/* Mate name */}
                                                                {record.mate && (
                                                                    <>
                                                                        <span className="text-gray-600 flex-shrink-0">{record.mate}</span>
                                                                        <span className="text-gray-400 flex-shrink-0">&bull;</span>
                                                                    </>
                                                                )}
                                                                
                                                                {/* Counts */}
                                                                <span className="text-blue-700 font-medium truncate">{countSummary}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Create/Link buttons and Delete - only if not expanded */}
                                                        <div className="flex gap-1 ml-2 flex-shrink-0">
                                                            {!record.litterId && !isExpanded && (
                                                                <>
                                                                    <button
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            setBreedingRecordForLitter(record);
                                                                            setShowCreateLitterModal(true);
                                                                        }}
                                                                        className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                                                        title="Create new litter from this record"
                                                                    >
                                                                        Create
                                                                    </button>
                                                                    <button
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            setBreedingRecordForLitter(record);
                                                                            setShowLinkLitterModal(true);
                                                                        }}
                                                                        className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200"
                                                                        title="Link existing litter"
                                                                    >
                                                                        Link
                                                                    </button>
                                                                </>
                                                            )}
                                                            <button 
                                                                type="button"
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setBreedingRecords(breedingRecords.filter(r => r.id !== record.id));
                                                                }}
                                                                className="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200"
                                                                title="Delete record"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* EXPANDED CONTENT */}
                                                    {isExpanded && (
                                                        <div className="border-t border-blue-100 p-4 bg-blue-50 space-y-4">
                                                            {/* CTL ID + Litter Name */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                <div><div className="text-gray-600 text-xs">CTL ID</div><div className="font-mono bg-blue-100 px-2 py-1 rounded text-xs font-semibold">{record.litterId || 'Not Linked'}</div></div>
                                                                {(linkedLitter?.breedingPairCodeName || record.litterName) && <div><div className="text-gray-600 text-xs">Litter Name</div><div className="font-semibold text-blue-800">{linkedLitter?.breedingPairCodeName || record.litterName}</div></div>}
                                                            </div>
                                                            {/* Mate, Dates, Method, Condition, Outcome */}
                                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                {record.mate && (<div><div className="text-gray-600 text-xs">Mate / Other Parent</div><div className="font-semibold text-gray-800">{record.mate}</div></div>)}
                                                                <div><div className="text-gray-600 text-xs">Mating Date</div><div className="font-semibold text-gray-800">{formatDate(record.matingDate) || '�'}</div></div>
                                                                {record.breedingMethod && (<div><div className="text-gray-600 text-xs">Breeding Method</div><div className="font-semibold text-gray-800">{record.breedingMethod}</div></div>)}
                                                                {record.breedingConditionAtTime && (<div><div className="text-gray-600 text-xs">Breeding Condition</div><div className="font-semibold text-gray-800">{record.breedingConditionAtTime}</div></div>)}
                                                                {record.outcome && (<div><div className="text-gray-600 text-xs">Outcome</div><div className={`font-semibold ${record.outcome === 'Successful' ? 'text-green-600' : record.outcome === 'Unsuccessful' ? 'text-red-600' : 'text-gray-600'}`}>{record.outcome}</div></div>)}
                                                                <div><div className="text-gray-600 text-xs">Birth Date</div><div className="font-semibold text-gray-800">{formatDate(linkedLitter?.birthDate || record.birthEventDate) || '�'}</div></div>
                                                                {record.birthMethod && (<div><div className="text-gray-600 text-xs">Birth Method</div><div className="font-semibold text-gray-800">{record.birthMethod}</div></div>)}
                                                            </div>
                                                            {/* Notes */}
                                                            {record.notes && (<div className="bg-white p-3 rounded border border-blue-100"><div className="text-sm font-semibold text-gray-700 mb-2">Notes</div><div className="text-sm text-gray-700 italic">{record.notes}</div></div>)}
                                                            {/* Offspring Counts */}
                                                            <div className="bg-white p-3 rounded border border-blue-100">
                                                                <div className="text-sm font-semibold text-gray-700 mb-3">Offspring Counts</div>
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                                    <div><div className="text-gray-600 text-xs">Total Born</div><div className="text-2xl font-bold text-blue-600">{record.litterSizeBorn !== null ? record.litterSizeBorn : '�'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Stillborn</div><div className="text-2xl font-bold text-gray-600">{record.stillbornCount || '0'}</div></div>
                                                                    <div><div className="text-gray-600 text-xs">Weaned</div><div className="text-2xl font-bold text-green-600">{record.litterSizeWeaned !== null ? record.litterSizeWeaned : '�'}</div></div>
                                                                    {linkedLitter?.maleCount != null && <div><div className="text-gray-600 text-xs">Males</div><div className="text-2xl font-bold text-blue-500">{linkedLitter.maleCount}</div></div>}
                                                                    {linkedLitter?.femaleCount != null && <div><div className="text-gray-600 text-xs">Females</div><div className="text-2xl font-bold text-pink-500">{linkedLitter.femaleCount}</div></div>}
                                                                    {linkedLitter?.unknownCount != null && linkedLitter.unknownCount > 0 && <div><div className="text-gray-600 text-xs">Unknown / Intersex</div><div className="text-2xl font-bold text-gray-600">{linkedLitter.unknownCount}</div></div>}
                                                                    {linkedLitter?.inbreedingCoefficient != null && <div><div className="text-gray-600 text-xs">COI</div><div className="text-xl font-bold text-orange-600">{linkedLitter.inbreedingCoefficient.toFixed(2)}%</div></div>}
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-3 mt-3">
                                                                    <div>
                                                                        <label className="block text-xs text-gray-500 mb-1">Males Born</label>
                                                                        <input type="number" min="0" value={record.maleCount ?? ''} onClick={(e) => e.stopPropagation()}
                                                                            onChange={(e) => setBreedingRecords(breedingRecords.map(r => r.id === record.id ? {...r, maleCount: e.target.value !== '' ? parseInt(e.target.value) : null} : r))}
                                                                            className="w-full p-1.5 text-sm border border-gray-300 rounded focus:ring-primary focus:border-primary" placeholder="—" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs text-gray-500 mb-1">Females Born</label>
                                                                        <input type="number" min="0" value={record.femaleCount ?? ''} onClick={(e) => e.stopPropagation()}
                                                                            onChange={(e) => setBreedingRecords(breedingRecords.map(r => r.id === record.id ? {...r, femaleCount: e.target.value !== '' ? parseInt(e.target.value) : null} : r))}
                                                                            className="w-full p-1.5 text-sm border border-gray-300 rounded focus:ring-primary focus:border-primary" placeholder="—" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs text-gray-500 mb-1">Unknown / Intersex</label>
                                                                        <input type="number" min="0" value={record.unknownCount ?? ''} onClick={(e) => e.stopPropagation()}
                                                                            onChange={(e) => setBreedingRecords(breedingRecords.map(r => r.id === record.id ? {...r, unknownCount: e.target.value !== '' ? parseInt(e.target.value) : null} : r))}
                                                                            className="w-full p-1.5 text-sm border border-gray-300 rounded focus:ring-primary focus:border-primary" placeholder="—" />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Offspring Cards */}
                                                            {record.litterId && breedingRecordOffspring[record.id] && breedingRecordOffspring[record.id].length > 0 && (
                                                                <div className="bg-white p-3 rounded border border-blue-100">
                                                                    <div className="text-sm font-semibold text-gray-700 mb-3">Offspring ({breedingRecordOffspring[record.id].length})</div>
                                                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                                                        {breedingRecordOffspring[record.id].map(offspring => (
                                                                            <div 
                                                                                key={offspring.id_public}
                                                                                className="border border-gray-200 rounded-lg p-2 hover:shadow-md transition"
                                                                            >
                                                                                <div className="flex items-center space-x-2">
                                                                                    <div className="w-10 h-10 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                                                                                        <AnimalImage 
                                                                                            src={offspring.imageUrl || offspring.photoUrl} 
                                                                                            alt={offspring.name} 
                                                                                            className="w-full h-full object-cover" 
                                                                                            iconSize={16} 
                                                                                        />
                                                                                    </div>
                                                                                    <div className="flex-1 min-w-0">
                                                                                        <div className="text-xs font-semibold text-gray-800 truncate">
                                                                                            {offspring.prefix && `${offspring.prefix} `}{offspring.name}{offspring.suffix && ` ${offspring.suffix}`}
                                                                                        </div>
                                                                                        <div className="text-[10px] text-gray-500 font-mono">{offspring.id_public}</div>
                                                                                        <div className="text-[10px] text-gray-600">{offspring.gender}</div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {/* Action buttons when expanded */}
                                                            {!record.litterId && (
                                                                <div className="flex gap-2 pt-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            setBreedingRecordForLitter(record);
                                                                            setShowCreateLitterModal(true);
                                                                        }}
                                                                        className="flex-1 px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium"
                                                                    >
                                                                        Create Litter
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            setBreedingRecordForLitter(record);
                                                                            setShowLinkLitterModal(true);
                                                                        }}
                                                                        className="flex-1 px-3 py-2 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium"
                                                                    >
                                                                        Link Litter
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* Tab 6: Reproduction & Breeding */}
                {activeTab === 6 && (
                    <div className="space-y-6">
                        {/* Reproductive Status - Key Status Indicators */}
                        {(!isFieldHidden('isNeutered') || !isFieldHidden('isInfertile') || !isFieldHidden('isPregnant') || !isFieldHidden('isNursing') || !isFieldHidden('isInMating')) && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="reproductive-status-section">
                            <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">🌿 Reproductive Status</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {!isFieldHidden('isNeutered') && (
                                <label className="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg bg-white hover:bg-gray-50 transition">
                                    <input
                                        type="checkbox"
                                        name="isNeutered"
                                        checked={formData.isNeutered}
                                        onChange={handleChange}
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary"
                                    />
                                    <span className="text-sm font-medium text-gray-700">
                                        {formData.gender === 'Female' ? 'Spayed' : (formData.gender === 'Intersex' || formData.gender === 'Unknown') ? 'Neutered / Spayed' : 'Neutered'}
                                    </span>
                                </label>
                                )}
                                
                                {!isFieldHidden('isInMating') && !formData.isNeutered && !formData.isInfertile && (
                                    <label className="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg bg-white hover:bg-gray-50 transition" data-tutorial-target="mating-pregnancy-checkbox">
                                        <input
                                            type="checkbox"
                                            name="isInMating"
                                            checked={formData.isInMating}
                                            onChange={handleChange}
                                            className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary"
                                        />
                                        <span className="text-sm font-medium text-gray-700">{getFieldLabel('isInMating', 'In Mating')}</span>
                                    </label>
                                )}

                                {!isFieldHidden('isInfertile') && (
                                <label className="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg bg-white hover:bg-gray-50 transition">
                                    <input
                                        type="checkbox"
                                        name="isInfertile"
                                        checked={formData.isInfertile || false}
                                        onChange={handleChange}
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary"
                                    />
                                    <span className="text-sm font-medium text-gray-700">Infertile</span>
                                </label>
                                )}

                                {!isFieldHidden('isPregnant') && (formData.gender === 'Female' || formData.gender === 'Intersex' || formData.gender === 'Unknown') && !formData.isNeutered && !formData.isInfertile && (
                                    <label className="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg bg-white hover:bg-gray-50 transition" data-tutorial-target="mating-pregnancy-checkbox">
                                        <input
                                            type="checkbox"
                                            name="isPregnant"
                                            checked={formData.isPregnant}
                                            onChange={handleChange}
                                            className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary"
                                        />
                                        <span className="text-sm font-medium text-gray-700">{getFieldLabel('isPregnant', 'Pregnant')}</span>
                                    </label>
                                )}

                                {!isFieldHidden('isNursing') && (formData.gender === 'Female' || formData.gender === 'Intersex' || formData.gender === 'Unknown') && (
                                    <label className="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg bg-white hover:bg-gray-50 transition" data-tutorial-target="nursing-checkbox">
                                        <input
                                            type="checkbox"
                                            name="isNursing"
                                            checked={formData.isNursing}
                                            onChange={handleChange}
                                            className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary"
                                        />
                                        <span className="text-sm font-medium text-gray-700">{getFieldLabel('isNursing', 'Nursing')}</span>
                                    </label>
                                )}

                            </div>
                        </div>
                        )}

                        {/* Estrus/Cycle - Only for females when not neutered */}
                        {!isFieldHidden('heatStatus') && (formData.gender === 'Female' || formData.gender === 'Intersex' || formData.gender === 'Unknown') && !formData.isNeutered && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="estrus-cycle-section">
                                <h3 className="text-lg font-semibold text-gray-700 mb-4">🔄 Estrus/Cycle</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('heatStatus', 'Heat Status')}</label>
                                        <select name="heatStatus" value={formData.heatStatus} onChange={handleChange}
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="">Select status...</option>
                                            <option value="Pre-estrus">Pre-estrus</option>
                                            <option value="Estrus">Estrus</option>
                                            <option value="Post-estrus">Post-estrus</option>
                                            <option value="Anestrus">Anestrus</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Last Heat Date</label>
                                        <DatePicker value={formData.lastHeatDate} onChange={(e) => handleChange({ target: { name: 'lastHeatDate', value: e.target.value } })}
                                            className="p-2" />
                                    </div>
                                    
                                    {!isFieldHidden('ovulationDate') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Ovulation Date</label>
                                        <DatePicker value={formData.ovulationDate} onChange={(e) => handleChange({ target: { name: 'ovulationDate', value: e.target.value } })}
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                    )}
                                    
                                    {/* Estrus Cycle Length */}
                                    {!isFieldHidden('estrusCycleLength') && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('estrusCycleLength', 'Estrus Cycle Length (days)')}</label>
                                            <input type="number" name="estrusCycleLength" value={formData.estrusCycleLength || ''} onChange={handleChange} 
                                                className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                placeholder="Cycle length in days" />
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Stud Information - Always shown when not neutered and not infertile */}
                        {!formData.isNeutered && !formData.isInfertile && (formData.gender === 'Male' || formData.gender === 'Intersex' || formData.gender === 'Unknown') && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="stud-info-section">
                                <div className="mb-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♂️ Sire Information <span className="text-xs font-normal text-gray-500">(Active Status)</span></h3>
                                    {formData.gender === 'Unknown' && <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded mt-1 inline-block">Fertility</span>}
                                    {formData.gender === 'Intersex' && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded mt-1 inline-block">Sire Role</span>}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {!isFieldHidden('fertilityStatus') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('fertilityStatus', 'Sire Fertility Status')}</label>
                                        <select name="fertilityStatus" value={formData.fertilityStatus} onChange={handleChange} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="Unknown">Unknown</option>
                                            <option value="Fertile">Fertile</option>
                                            <option value="Subfertile">Subfertile</option>
                                            <option value="Infertile">Infertile</option>
                                        </select>
                                    </div>
                                    )}
                                    
                                    {!isFieldHidden('fertilityNotes') && (
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('fertilityNotes', 'Fertility Notes')}</label>
                                        <textarea name="fertilityNotes" value={formData.fertilityNotes} onChange={handleChange} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Any genetic concerns, fertility issues, or special breeding notes for sire role"
                                            rows="3" />
                                    </div>
                                    )}
                                    
                                    {/* Reproductive Clearances & Complications */}
                                    {(!isFieldHidden('reproductiveClearances') || !isFieldHidden('reproductiveComplications')) && (
                                        <>
                                            {!isFieldHidden('reproductiveClearances') && (
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('reproductiveClearances', 'Reproductive Clearances')}</label>
                                                <textarea name="reproductiveClearances" value={formData.reproductiveClearances || ''} onChange={handleChange} rows="2"
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                    placeholder="Brucellosis test, progesterone timing, etc." />
                                            </div>
                                            )}
                                            {!isFieldHidden('reproductiveComplications') && (
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('reproductiveComplications', 'Reproductive Complications')}</label>
                                                <textarea name="reproductiveComplications" value={formData.reproductiveComplications || ''} onChange={handleChange} rows="2"
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                    placeholder="Any complications during breeding" />
                                            </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Dam Information - Always shown when not neutered and not infertile */}
                        {!formData.isNeutered && !formData.isInfertile && (formData.gender === 'Female' || formData.gender === 'Intersex' || formData.gender === 'Unknown') && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="dam-info-section">
                                <div className="mb-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♀️ Dam Information <span className="text-xs font-normal text-gray-500">(Active Status)</span></h3>
                                    {formData.gender === 'Unknown' && <span className="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded mt-1 inline-block">Egg Fertility</span>}
                                    {formData.gender === 'Intersex' && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded mt-1 inline-block">Dam Role</span>}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {!isFieldHidden('damFertilityStatus') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Dam Fertility Status <span className="text-xs text-gray-500 font-normal">(Egg/Gestation)</span></label>
                                        <select name="damFertilityStatus" value={formData.damFertilityStatus || formData.fertilityStatus} onChange={(e) => handleChange({target: {name: 'damFertilityStatus', value: e.target.value}})} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="Unknown">Unknown</option>
                                            <option value="Fertile">Fertile</option>
                                            <option value="Subfertile">Subfertile</option>
                                            <option value="Infertile">Infertile</option>
                                        </select>
                                    </div>
                                    )}
                                    
                                    {!isFieldHidden('damFertilityNotes') && (
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('damFertilityNotes', 'Dam Fertility Notes')}</label>
                                        <textarea name="damFertilityNotes" value={formData.damFertilityNotes || ''} onChange={handleChange} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Any genetic concerns, fertility issues, or special breeding notes for dam role"
                                            rows="3" />
                                    </div>
                                    )}
                                    
                                    {/* Dog/Cat Pregnancy & Delivery Details */}
                                    {/* Gestation, Delivery, Dates - Template controlled */}
                                    {(!isFieldHidden('gestationLength') || !isFieldHidden('deliveryMethod') || !isFieldHidden('whelpingDate') || !isFieldHidden('queeningDate') || !isFieldHidden('reproductiveClearances') || !isFieldHidden('reproductiveComplications')) && (
                                        <>
                                            {!isFieldHidden('gestationLength') && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('gestationLength', 'Gestation Length (days)')}</label>
                                                <input type="number" name="gestationLength" value={formData.gestationLength || ''} onChange={handleChange} 
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                    placeholder="Length in days" />
                                            </div>
                                            )}
                                            {!isFieldHidden('deliveryMethod') && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('deliveryMethod', 'Delivery Method')}</label>
                                                <select name="deliveryMethod" value={formData.deliveryMethod || ''} onChange={handleChange} 
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                                    <option value="">Select...</option>
                                                    <option value="Natural">Natural</option>
                                                    <option value="C-Section">C-Section</option>
                                                    <option value="Assisted">Assisted</option>
                                                </select>
                                            </div>
                                            )}
                                            {!isFieldHidden('whelpingDate') && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('whelpingDate', 'Whelping Date')}</label>
                                                <DatePicker name="whelpingDate" value={formData.whelpingDate || ''} onChange={handleChange} 
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            )}
                                            {!isFieldHidden('queeningDate') && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('queeningDate', 'Queening Date')}</label>
                                                <DatePicker name="queeningDate" value={formData.queeningDate || ''} onChange={handleChange} 
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            )}
                                            {!isFieldHidden('reproductiveClearances') && (
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('reproductiveClearances', 'Reproductive Clearances')}</label>
                                                <textarea name="reproductiveClearances" value={formData.reproductiveClearances || ''} onChange={handleChange} rows="2"
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                    placeholder="Brucellosis test, progesterone timing, etc." />
                                            </div>
                                            )}
                                            {!isFieldHidden('reproductiveComplications') && (
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('reproductiveComplications', 'Reproductive Complications')}</label>
                                                <textarea name="reproductiveComplications" value={formData.reproductiveComplications || ''} onChange={handleChange} rows="2"
                                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                    placeholder="Any complications during breeding/delivery" />
                                            </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {/* Tab 7: Health */}
                {activeTab === 7 && (
                    <div className="space-y-6">
                        {/* Preventive Care */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200" data-tutorial-target="preventive-care-section">
                            <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, preventiveCare: !p.preventiveCare}))} className="w-full flex items-center justify-between text-left group">
                                <h3 className="text-lg font-semibold text-gray-700">🛡️ Preventive Care</h3>
                                <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.preventiveCare ? '▶' : '▼'}</span>
                            </button>
                            {!collapsedHealthSections.preventiveCare && (<div className="space-y-6 mt-4">
                            {/* Vaccinations */}
                            <div className="space-y-3">
                                <h4 className="text-sm font-semibold text-gray-700">Vaccinations</h4>
                                <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Date</label>
                                            <DatePicker value={newVaccination.date} onChange={(e) => setNewVaccination({...newVaccination, date: e.target.value})}
                                                className="mt-1 p-2 text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Vaccination Name</label>
                                            <input type="text" value={newVaccination.name} onChange={(e) => setNewVaccination({...newVaccination, name: e.target.value})}
                                                placeholder="e.g., Rabies, Distemper" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Notes</label>
                                            <input type="text" value={newVaccination.notes} onChange={(e) => setNewVaccination({...newVaccination, notes: e.target.value})}
                                                placeholder="e.g., Booster, Clinic name" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                    </div>
                                    <button type="button" onClick={addVaccination} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                        Add Vaccination Record
                                    </button>
                                </div>
                                {vaccinationRecords.length > 0 && (
                                    <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                        {vaccinationRecords.map((record) => (
                                            <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                <div className="flex-1">
                                                    <strong>{record.date}:</strong> {record.name}
                                                    {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                </div>
                                                <button type="button" onClick={() => setVaccinationRecords(vaccinationRecords.filter(r => r.id !== record.id))}
                                                    className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {/* Deworming */}
                            <div className="space-y-3 border-t border-gray-200 pt-4">
                                <h4 className="text-sm font-semibold text-gray-700">Deworming Records</h4>
                                <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Date</label>
                                            <DatePicker value={newDeworming.date} onChange={(e) => setNewDeworming({...newDeworming, date: e.target.value})}
                                                className="mt-1 p-2 text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Medication</label>
                                            <input type="text" value={newDeworming.medication} onChange={(e) => setNewDeworming({...newDeworming, medication: e.target.value})}
                                                placeholder="e.g., Fenbendazole, Panacur" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Notes</label>
                                            <input type="text" value={newDeworming.notes} onChange={(e) => setNewDeworming({...newDeworming, notes: e.target.value})}
                                                placeholder="e.g., Dosage, vet notes" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                    </div>
                                    <button type="button" onClick={addDeworming} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                        Add Deworming Record
                                    </button>
                                </div>
                                {dewormingRecordsArray.length > 0 && (
                                    <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                        {dewormingRecordsArray.map((record) => (
                                            <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                <div className="flex-1">
                                                    <strong>{record.date}:</strong> {record.medication}
                                                    {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                </div>
                                                <button type="button" onClick={() => setDewormingRecordsArray(dewormingRecordsArray.filter(r => r.id !== record.id))}
                                                    className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {/* Parasite Control */}
                            <div className="space-y-3 border-t border-gray-200 pt-4">
                                <h4 className="text-sm font-semibold text-gray-700">Parasite Control</h4>
                                <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Date</label>
                                            <DatePicker value={newParasiteControl.date} onChange={(e) => setNewParasiteControl({...newParasiteControl, date: e.target.value})}
                                                className="mt-1 p-2 text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Treatment</label>
                                            <input type="text" value={newParasiteControl.treatment} onChange={(e) => setNewParasiteControl({...newParasiteControl, treatment: e.target.value})}
                                                placeholder="e.g., Flea/tick, mite treatment" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Notes</label>
                                            <input type="text" value={newParasiteControl.notes} onChange={(e) => setNewParasiteControl({...newParasiteControl, notes: e.target.value})}
                                                placeholder="e.g., Product name, vet notes" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                    </div>
                                    <button type="button" onClick={addParasiteControl} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                        Add Parasite Control Record
                                    </button>
                                </div>
                                {parasiteControlRecords.length > 0 && (
                                    <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                        {parasiteControlRecords.map((record) => (
                                            <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                <div className="flex-1">
                                                    <strong>{record.date}:</strong> {record.treatment}
                                                    {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                </div>
                                                <button type="button" onClick={() => setParasiteControlRecords(parasiteControlRecords.filter(r => r.id !== record.id))}
                                                    className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            </div>)}
                        </div>

                        {/* Procedures & Diagnostics */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200" data-tutorial-target="procedures-section">
                            <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, proceduresDiagnostics: !p.proceduresDiagnostics}))} className="w-full flex items-center justify-between text-left group">
                                <h3 className="text-lg font-semibold text-gray-700">🔬 Procedures & Diagnostics</h3>
                                <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.proceduresDiagnostics ? '▶' : '▼'}</span>
                            </button>
                            {!collapsedHealthSections.proceduresDiagnostics && (<div className="space-y-6 mt-4">
                            {/* Medical Procedures */}
                            <div className="space-y-3">
                                <h4 className="text-sm font-semibold text-gray-700">Medical Procedures</h4>
                                <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Date</label>
                                            <DatePicker value={newProcedure.date} onChange={(e) => setNewProcedure({...newProcedure, date: e.target.value})}
                                                className="mt-1 p-2 text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Procedure Name</label>
                                            <input type="text" value={newProcedure.name} onChange={(e) => setNewProcedure({...newProcedure, name: e.target.value})}
                                                placeholder="e.g., Neutering, Surgery" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Notes</label>
                                            <input type="text" value={newProcedure.notes} onChange={(e) => setNewProcedure({...newProcedure, notes: e.target.value})}
                                                placeholder="e.g., Vet clinic, outcome" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                    </div>
                                    <button type="button" onClick={addMedicalProcedure} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                        Add Procedure Record
                                    </button>
                                </div>
                                {medicalProcedureRecords.length > 0 && (
                                    <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                        {medicalProcedureRecords.map((record) => (
                                            <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                <div className="flex-1">
                                                    <strong>{record.date}:</strong> {record.name}
                                                    {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                </div>
                                                <button type="button" onClick={() => setMedicalProcedureRecords(medicalProcedureRecords.filter(r => r.id !== record.id))}
                                                    className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {/* Lab Results */}
                            <div className="space-y-3 border-t border-gray-200 pt-4">
                                <h4 className="text-sm font-semibold text-gray-700">Laboratory Results</h4>
                                <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Date</label>
                                            <DatePicker value={newLabResult.date} onChange={(e) => setNewLabResult({...newLabResult, date: e.target.value})}
                                                className="mt-1 p-2 text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-gray-700">Test Name</label>
                                            <input type="text" value={newLabResult.testName} onChange={(e) => setNewLabResult({...newLabResult, testName: e.target.value})}
                                                placeholder="e.g., Blood work, DNA test" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-medium text-gray-700">Result/Findings</label>
                                            <input type="text" value={newLabResult.result} onChange={(e) => setNewLabResult({...newLabResult, result: e.target.value})}
                                                placeholder="e.g., Negative, Normal, Abnormal" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-medium text-gray-700">Notes (optional)</label>
                                            <input type="text" value={newLabResult.notes} onChange={(e) => setNewLabResult({...newLabResult, notes: e.target.value})}
                                                placeholder="e.g., Lab name, reference range" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                        </div>
                                    </div>
                                    <button type="button" onClick={addLabResult} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                        Add Lab Result
                                    </button>
                                </div>
                                {labResultRecords.length > 0 && (
                                    <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                        {labResultRecords.map((record) => (
                                            <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                <div className="flex-1">
                                                    <strong>{record.date}:</strong> {record.testName} - {record.result}
                                                    {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                </div>
                                                <button type="button" onClick={() => setLabResultRecords(labResultRecords.filter(r => r.id !== record.id))}
                                                    className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            </div>)}
                        </div>

                        {/* Active Medical Records */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200" data-tutorial-target="medical-history-section">
                            <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, activeMedical: !p.activeMedical}))} className="w-full flex items-center justify-between text-left group">
                                <h3 className="text-lg font-semibold text-gray-700">🩹💊 Active Medical Records</h3>
                                <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.activeMedical ? '▶' : '▼'}</span>
                            </button>
                            {!collapsedHealthSections.activeMedical && (<div className="space-y-4 mt-4">
                            {/* Quarantine toggle */}
                            <label className="flex items-center gap-3 cursor-pointer p-3 border rounded-lg bg-white hover:bg-orange-50 transition">
                                <input
                                    type="checkbox"
                                    name="isQuarantine"
                                    checked={formData.isQuarantine || false}
                                    onChange={handleChange}
                                    className="form-checkbox h-5 w-5 text-orange-500 rounded focus:ring-orange-400"
                                />
                                <span className="text-sm font-medium text-gray-700">In Quarantine / Isolation</span>
                            </label>
                            <div className="space-y-4">
                                {/* Medical Conditions */}
                                <div className="space-y-3">
                                    <h4 className="text-sm font-semibold text-gray-700">Medical Conditions</h4>
                                    <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Condition Name</label>
                                                <input type="text" value={newMedicalCondition.name} onChange={(e) => setNewMedicalCondition({...newMedicalCondition, name: e.target.value})}
                                                    placeholder="e.g., Diabetes, Respiratory infection" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Notes (optional)</label>
                                                <input type="text" value={newMedicalCondition.notes} onChange={(e) => setNewMedicalCondition({...newMedicalCondition, notes: e.target.value})}
                                                    placeholder="e.g., Ongoing treatment" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        </div>
                                        <button type="button" onClick={addMedicalCondition} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                            Add Medical Condition
                                        </button>
                                    </div>
                                    {medicalConditionsArray.length > 0 && (
                                        <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                            {medicalConditionsArray.map((record) => (
                                                <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                    <div className="flex-1">
                                                        <strong>{record.name}</strong>
                                                        {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                    </div>
                                                    <button type="button" onClick={() => setMedicalConditionsArray(medicalConditionsArray.filter(r => r.id !== record.id))}
                                                        className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Allergies */}
                                <div className="space-y-3 border-t border-gray-200 pt-4">
                                    <h4 className="text-sm font-semibold text-gray-700">Allergies</h4>
                                    <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Allergy Name</label>
                                                <input type="text" value={newAllergy.name} onChange={(e) => setNewAllergy({...newAllergy, name: e.target.value})}
                                                    placeholder="e.g., Peanuts, Penicillin" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Notes (optional)</label>
                                                <input type="text" value={newAllergy.notes} onChange={(e) => setNewAllergy({...newAllergy, notes: e.target.value})}
                                                    placeholder="e.g., Severe reaction" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        </div>
                                        <button type="button" onClick={addAllergy} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                            Add Allergy
                                        </button>
                                    </div>
                                    {allergiesArray.length > 0 && (
                                        <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                            {allergiesArray.map((record) => (
                                                <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                    <div className="flex-1">
                                                        <strong>{record.name}</strong>
                                                        {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                    </div>
                                                    <button type="button" onClick={() => setAllergiesArray(allergiesArray.filter(r => r.id !== record.id))}
                                                        className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Medications */}
                                <div className="space-y-3 border-t border-gray-200 pt-4">
                                    <h4 className="text-sm font-semibold text-gray-700">Current Medications</h4>
                                    <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Medication Name</label>
                                                <input type="text" value={newMedication.name} onChange={(e) => setNewMedication({...newMedication, name: e.target.value})}
                                                    placeholder="e.g., Antibiotic, Pain reliever" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Notes (optional)</label>
                                                <input type="text" value={newMedication.notes} onChange={(e) => setNewMedication({...newMedication, notes: e.target.value})}
                                                    placeholder="e.g., Dosage, frequency" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        </div>
                                        <button type="button" onClick={addMedication} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                            Add Medication
                                        </button>
                                    </div>
                                    {medicationsArray.length > 0 && (
                                        <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                            {medicationsArray.map((record) => (
                                                <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                    <div className="flex-1">
                                                        <strong>{record.name}</strong>
                                                        {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                    </div>
                                                    <button type="button" onClick={() => setMedicationsArray(medicationsArray.filter(r => r.id !== record.id))}
                                                        className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                            </div>
                            </div>)}
                        </div>

                        {/* Health Clearances & Screening */}
                        {(!isFieldHidden('spayNeuterDate') || !isFieldHidden('heartwormStatus') || !isFieldHidden('hipElbowScores') || !isFieldHidden('eyeClearance') || !isFieldHidden('cardiacClearance') || !isFieldHidden('dentalRecords') || !isFieldHidden('geneticTestResults') || !isFieldHidden('chronicConditions')) && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, healthClearances: !p.healthClearances}))} className="w-full flex items-center justify-between text-left group">
                                <h3 className="text-lg font-semibold text-gray-700">🏥 Health Clearances & Screening</h3>
                                <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.healthClearances ? '▶' : '▼'}</span>
                            </button>
                            {!collapsedHealthSections.healthClearances && (<div className="space-y-4 mt-4">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {!isFieldHidden('spayNeuterDate') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('spayNeuterDate', 'Spay/Neuter Date')}</label>
                                    <DatePicker value={formData.spayNeuterDate || ''} onChange={(e) => handleChange({ target: { name: 'spayNeuterDate', value: e.target.value } })}
                                        className="mt-1 p-2" />
                                </div>
                                )}
                                {!isFieldHidden('heartwormStatus') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('heartwormStatus', 'Heartworm Status')}</label>
                                    <select name="heartwormStatus" value={formData.heartwormStatus || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="">Select...</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Positive">Positive</option>
                                        <option value="On Prevention">On Prevention</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                </div>
                                )}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('hipElbowScores') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('hipElbowScores', 'Hip/Elbow Scores')}</label>
                                    <input type="text" name="hipElbowScores" value={formData.hipElbowScores || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., OFA Good, PennHIP 0.32" />
                                </div>
                                )}
                                {!isFieldHidden('eyeClearance') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('eyeClearance', 'Eye Clearance')}</label>
                                    <input type="text" name="eyeClearance" value={formData.eyeClearance || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., CAER Clear 2024" />
                                </div>
                                )}
                                {!isFieldHidden('cardiacClearance') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('cardiacClearance', 'Cardiac Clearance')}</label>
                                    <input type="text" name="cardiacClearance" value={formData.cardiacClearance || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., OFA Cardiac Normal" />
                                </div>
                                )}
                                {!isFieldHidden('dentalRecords') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('dentalRecords', 'Dental Records')}</label>
                                    <input type="text" name="dentalRecords" value={formData.dentalRecords || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Last cleaning 01/2024" />
                                </div>
                                )}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('geneticTestResults') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('geneticTestResults', 'Genetic Test Results')}</label>
                                    <textarea name="geneticTestResults" value={formData.geneticTestResults || ''} onChange={handleChange} rows="2"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Embark: Clear for DM, vWD, DCM" />
                                </div>
                                )}
                                {!isFieldHidden('chronicConditions') && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-700">{getFieldLabel('chronicConditions', 'Chronic Conditions')}</label>
                                    <textarea name="chronicConditions" value={formData.chronicConditions || ''} onChange={handleChange} rows="2"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Allergies, arthritis, epilepsy" />
                                </div>
                                )}
                            </div>
                            </div>)}
                        </div>
                        )}

                        {/* Veterinary Care */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200" data-tutorial-target="vet-care-section">
                            <button type="button" onClick={() => setCollapsedHealthSections(p => ({...p, vetCare: !p.vetCare}))} className="w-full flex items-center justify-between text-left group">
                                <h3 className="text-lg font-semibold text-gray-700">🩺 Veterinary Care</h3>
                                <span className="text-gray-400 group-hover:text-gray-600">{collapsedHealthSections.vetCare ? '▶' : '▼'}</span>
                            </button>
                            {!collapsedHealthSections.vetCare && (<div className="space-y-4 mt-4">
                            <div className="space-y-4">
                                {/* Veterinary Visits */}
                                <div className="space-y-3">
                                    <h4 className="text-sm font-semibold text-gray-700">Veterinary Visits</h4>
                                    <div className="bg-white p-3 rounded-lg border border-gray-200 space-y-3">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Date</label>
                                                <DatePicker value={newVetVisit.date} onChange={(e) => setNewVetVisit({...newVetVisit, date: e.target.value})}
                                                    className="mt-1 p-2 text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Visit Reason</label>
                                                <input type="text" value={newVetVisit.reason} onChange={(e) => setNewVetVisit({...newVetVisit, reason: e.target.value})}
                                                    placeholder="e.g., Annual checkup, Emergency" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700">Notes (optional)</label>
                                                <input type="text" value={newVetVisit.notes} onChange={(e) => setNewVetVisit({...newVetVisit, notes: e.target.value})}
                                                    placeholder="e.g., Vaccines given, Diagnosis" className="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                            </div>
                                        </div>
                                        <button type="button" onClick={addVetVisit} className="w-full px-4 py-2 bg-primary hover:bg-primary/90 text-black rounded-lg text-sm font-medium">
                                            Add Veterinary Visit
                                        </button>
                                    </div>
                                    {vetVisitsArray.length > 0 && (
                                        <div className="space-y-2 bg-white p-3 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                            {vetVisitsArray.map((record) => (
                                                <div key={record.id} className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                    <div className="flex-1">
                                                        <strong>{record.date}:</strong> {record.reason}
                                                        {record.notes && <span className="text-xs text-gray-500 ml-2">({record.notes})</span>}
                                                    </div>
                                                    <button type="button" onClick={() => setVetVisitsArray(vetVisitsArray.filter(r => r.id !== record.id))}
                                                        className="text-red-500 hover:text-red-700 p-1" title="Delete record">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {!isFieldHidden('primaryVet') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Primary Veterinarian</label>
                                    <input type="text" name="primaryVet" value={formData.primaryVet} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Dr. Smith, ABC Veterinary Clinic" />
                                </div>
                                )}

                                {!isFieldHidden('parasitePreventionSchedule') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('parasitePreventionSchedule', 'Parasite Prevention Schedule')}</label>
                                    <textarea name="parasitePreventionSchedule" value={formData.parasitePreventionSchedule || ''} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Ivermectin every 3 months, flea/tick monthly" />
                                </div>
                                )}


                            </div>
                            </div>)}
                        </div>
                    </div>
                )}

                {/* Tab 8: Animal Care */}
                {activeTab === 8 && (
                    <div className="space-y-6">
                        {/* 1st Section: Nutrition */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="nutrition-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🍽️ Nutrition</h3>
                            <div className="space-y-4">
                                {!isFieldHidden('dietType') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Diet Type</label>
                                    <input type="text" name="dietType" value={formData.dietType} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Pellets, fresh vegetables, lab blocks" />
                                </div>
                                )}
                                
                                {!isFieldHidden('feedingSchedule') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Feeding Schedule</label>
                                    <textarea name="feedingSchedule" value={formData.feedingSchedule} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Morning and evening, free feeding" />
                                </div>
                                )}

                                {/* Feeding tracking ? powers Management view */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Last Fed Date</label>
                                        <input type="date" name="lastFedDate" value={formData.lastFedDate || ''} onChange={handleChange}
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Feeding Every (days)</label>
                                        <input type="number" name="feedingFrequencyDays" value={formData.feedingFrequencyDays || ''} onChange={handleChange}
                                            min="1" className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                            placeholder="e.g. 1 = daily, 3 = every 3 days" />
                                    </div>
                                </div>
                                
                                {!isFieldHidden('supplements') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Supplements</label>
                                    <textarea name="supplements" value={formData.supplements} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Vitamin D, calcium powder" />
                                </div>
                                )}
                            </div>
                        </div>

                        {/* 2nd Section: Housing & Enclosure */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="housing-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🏡 Housing & Enclosure</h3>
                            <div className="space-y-4">
                                {/* Enclosure assignment */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Assigned Enclosure</label>
                                    <select name="enclosureId" value={formData.enclosureId || ''} onChange={handleChange}
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="">* None / Unassigned *</option>
                                        {enclosureOptions.map(enc => (
                                            <option key={enc._id} value={enc._id}>
                                                {enc.name}{enc.enclosureType ? ` (${enc.enclosureType})` : ''}{enc.size ? ` � ${enc.size}` : ''}
                                            </option>
                                        ))}
                                    </select>
                                    {enclosureOptions.length === 0 && (
                                        <p className="text-xs text-gray-400 mt-1">No enclosures created yet. Create them in the Management view.</p>
                                    )}
                                </div>

                                {!isFieldHidden('housingType') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('housingType', 'Housing Type')}</label>
                                        <input type="text" name="housingType" value={formData.housingType} onChange={handleChange} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Wire cage, glass aquarium, multi-level enclosure" />
                                    </div>
                                )}

                                {!isFieldHidden('bedding') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('bedding', 'Bedding / Substrate')}</label>
                                        <input type="text" name="bedding" value={formData.bedding} onChange={handleChange} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Aspen shavings, paper bedding, fleece liners" />
                                    </div>
                                )}
                                
                                {!isFieldHidden('enrichment') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Enrichment Items</label>
                                    <textarea name="enrichment" value={formData.enrichment} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Exercise wheel, tunnels, chew toys, hammocks" />
                                </div>
                                )}

                                {/* Enclosure Maintenance tracking ? powers Management view */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Last Maintenance Date</label>
                                        <input type="date" name="lastMaintenanceDate" value={formData.lastMaintenanceDate || ''} onChange={handleChange}
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Maintenance Every (days)</label>
                                        <input type="number" name="maintenanceFrequencyDays" value={formData.maintenanceFrequencyDays || ''} onChange={handleChange}
                                            min="1" className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                            placeholder="e.g. 7 = weekly, 30 = monthly" />
                                    </div>
                                </div>

                                {/* Enclosure Care Tasks ? flexible recurring tasks for enclosure maintenance */}
                                <div className="border border-gray-200 rounded-lg p-3 bg-white space-y-2">
                                    <div className="flex items-center justify-between mb-1">
                                        <label className="text-sm font-medium text-gray-700">Enclosure Care Tasks</label>
                                        <span className="text-xs text-gray-400">Deep clean, spot clean, water change, etc.</span>
                                    </div>
                                    {(formData.careTasks || []).length === 0 ? (
                                        <p className="text-xs text-gray-400">No enclosure care tasks yet.</p>
                                    ) : (
                                        <div className="space-y-1">
                                            {(formData.careTasks || []).map((task, idx) => (
                                                <div key={idx} className="flex items-center gap-2 text-sm bg-gray-50 rounded px-2 py-1.5">
                                                    <span className="flex-1 font-medium text-gray-700">{task.taskName}</span>
                                                    {task.frequencyDays && <span className="text-xs text-gray-400">Every {task.frequencyDays}d</span>}
                                                    {task.lastDoneDate && <span className="text-xs text-gray-400">Last: {new Date(task.lastDoneDate).toLocaleDateString()}</span>}
                                                    <button type="button" onClick={() => setFormData(prev => ({ ...prev, careTasks: (prev.careTasks || []).filter((_, i) => i !== idx) }))} className="text-red-400 hover:text-red-600 font-bold leading-none">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                        <input type="text" value={newCareTaskName} onChange={e => setNewCareTaskName(e.target.value)}
                                            placeholder="Task name (e.g. Deep clean, Spot clean, Water change)"
                                            className="flex-1 p-1.5 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary" />
                                        <div className="flex gap-2">
                                            <input type="number" value={newCareTaskFreq} onChange={e => setNewCareTaskFreq(e.target.value)}
                                                placeholder="Days" min="1"
                                                className="flex-1 sm:w-20 p-1.5 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary" />
                                            <button type="button" onClick={() => {
                                                if (!newCareTaskName.trim()) return;
                                                setFormData(prev => ({ ...prev, careTasks: [...(prev.careTasks || []), { taskName: newCareTaskName.trim(), frequencyDays: newCareTaskFreq ? Number(newCareTaskFreq) : null, lastDoneDate: null }] }));
                                                setNewCareTaskName(''); setNewCareTaskFreq('');
                                            }} className="px-3 py-1.5 bg-primary text-black text-sm font-medium rounded-md hover:bg-primary/80 whitespace-nowrap flex-shrink-0">+ Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 3rd Section: Animal Care */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="animal-care-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🧴 Animal Care</h3>
                            <div className="space-y-4">
                                <p className="text-sm text-gray-600">Track recurring care tasks specific to this animal, such as health checks, grooming, weighing, and handling routines.</p>

                                {/* Animal Care Tasks ? flexible recurring tasks for animal care */}
                                <div className="border border-gray-200 rounded-lg p-3 bg-white space-y-2">
                                    <div className="flex items-center justify-between mb-1">
                                        <label className="text-sm font-medium text-gray-700">Animal Care Tasks</label>
                                        <span className="text-xs text-gray-400">Weigh, nail trim, health check, handling, etc.</span>
                                    </div>
                                    {(formData.animalCareTasks || []).length === 0 ? (
                                        <p className="text-xs text-gray-400">No animal care tasks yet.</p>
                                    ) : (
                                        <div className="space-y-1">
                                            {(formData.animalCareTasks || []).map((task, idx) => (
                                                <div key={idx} className="flex items-center gap-2 text-sm bg-gray-50 rounded px-2 py-1.5">
                                                    <span className="flex-1 font-medium text-gray-700">{task.taskName}</span>
                                                    {task.frequencyDays && <span className="text-xs text-gray-400">Every {task.frequencyDays}d</span>}
                                                    {task.lastDoneDate && <span className="text-xs text-gray-400">Last: {new Date(task.lastDoneDate).toLocaleDateString()}</span>}
                                                    <button type="button" onClick={() => setFormData(prev => ({ ...prev, animalCareTasks: (prev.animalCareTasks || []).filter((_, i) => i !== idx) }))} className="text-red-400 hover:text-red-600 font-bold leading-none">?</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                        <input type="text" value={newAnimalCareTaskName} onChange={e => setNewAnimalCareTaskName(e.target.value)}
                                            placeholder="Task name (e.g. Weigh, Nail trim, Health check)"
                                            className="flex-1 p-1.5 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary" />
                                        <div className="flex gap-2">
                                            <input type="number" value={newAnimalCareTaskFreq} onChange={e => setNewAnimalCareTaskFreq(e.target.value)}
                                                placeholder="Days" min="1"
                                                className="flex-1 sm:w-20 p-1.5 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary" />
                                            <button type="button" onClick={() => {
                                                if (!newAnimalCareTaskName.trim()) return;
                                                setFormData(prev => ({ ...prev, animalCareTasks: [...(prev.animalCareTasks || []), { taskName: newAnimalCareTaskName.trim(), frequencyDays: newAnimalCareTaskFreq ? Number(newAnimalCareTaskFreq) : null, lastDoneDate: null }] }));
                                                setNewAnimalCareTaskName(''); setNewAnimalCareTaskFreq('');
                                            }} className="px-3 py-1.5 bg-primary text-black text-sm font-medium rounded-md hover:bg-primary/80 whitespace-nowrap flex-shrink-0">+ Add</button>
                                        </div>
                                    </div>
                                </div>

                                {/* Additional Animal Care Fields */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Handling Notes</label>
                                    <textarea name="handlingNotes" value={formData.handlingNotes || ''} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Prefers gentle handling, allow time to acclimate, hand-feeds well" />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Socialization Notes</label>
                                    <textarea name="socializationNotes" value={formData.socializationNotes || ''} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Gets along with cage mates, needs solo time, enjoys interaction" />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Special Care Requirements</label>
                                    <textarea name="specialCareRequirements" value={formData.specialCareRequirements || ''} onChange={handleChange} rows="3"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Requires daily medication, sensitive to stress, special diet needs" />
                                </div>
                            </div>
                        </div>

                        {/* 4th Section: Environment */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="environment-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🌡️ Environment</h3>
                            <div className="space-y-4">
                                {!isFieldHidden('temperatureRange') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Temperature Range</label>
                                    <input type="text" name="temperatureRange" value={formData.temperatureRange} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., 68-72�F, 20-22�C" />
                                </div>
                                )}

                                {!isFieldHidden('humidity') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Humidity</label>
                                    <input type="text" name="humidity" value={formData.humidity} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., 40-60%, 50%" />
                                </div>
                                )}

                                {!isFieldHidden('lighting') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Lighting</label>
                                    <input type="text" name="lighting" value={formData.lighting} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., 12:12 hour cycle, LED lights, UVB" />
                                </div>
                                )}

                                {!isFieldHidden('noise') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('noise', 'Noise Level')}</label>
                                        <input type="text" name="noise" value={formData.noise} onChange={handleChange} 
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Quiet, moderate, high" />
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 5th Section: Exercise & Grooming */}
                        {(!isFieldHidden('groomingNeeds') || !isFieldHidden('sheddingLevel')) && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="exercise-grooming-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">✂️ Grooming</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('groomingNeeds') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('groomingNeeds', 'Grooming Needs')}</label>
                                    <select name="groomingNeeds" value={formData.groomingNeeds || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="">Select...</option>
                                        {getFieldLabel('groomingNeeds', 'Grooming Needs').toLowerCase().includes('shed') ? <>
                                            <option value="Normal">Normal (clean sheds)</option>
                                            <option value="Occasional">Occasional stuck shed</option>
                                            <option value="Frequent">Frequent stuck shed (dysecdysis)</option>
                                            <option value="Requires soaking">Requires soaking during shed</option>
                                        </> : <>
                                            <option value="Low">Low - minimal brushing</option>
                                            <option value="Moderate">Moderate - weekly grooming</option>
                                            <option value="High">High - daily brushing</option>
                                            <option value="Professional">Professional - regular groomer</option>
                                        </>}
                                    </select>
                                </div>
                                )}
                                {!isFieldHidden('sheddingLevel') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('sheddingLevel', 'Shedding Level')}</label>
                                    <select name="sheddingLevel" value={formData.sheddingLevel || ''} onChange={handleChange} 
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="">Select...</option>
                                        <option value="None">None - hypoallergenic</option>
                                        <option value="Low">Low</option>
                                        <option value="Moderate">Moderate</option>
                                        <option value="Heavy">Heavy</option>
                                        <option value="Seasonal">Seasonal blowouts</option>
                                    </select>
                                </div>
                                )}
                            </div>
                        </div>
                        )}
                    </div>
                )}

                {/* Tab 9: Behavior & Welfare */}
                {activeTab === 9 && (
                    <div className="space-y-6">
                        {/* Behavior */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">💭 Behavior</h3>
                            <div className="space-y-4" data-tutorial-target="behavior-items-section">
                                {!isFieldHidden('temperament') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Temperament</label>
                                    <input type="text" name="temperament" value={formData.temperament} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Friendly, skittish, aggressive, calm" />
                                </div>
                                )}
                                
                                {!isFieldHidden('handlingTolerance') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Handling Tolerance</label>
                                    <input type="text" name="handlingTolerance" value={formData.handlingTolerance} onChange={handleChange} 
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Enjoys handling, tolerates briefly, avoids contact" />
                                </div>
                                )}
                                
                                {!isFieldHidden('socialStructure') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Social Structure</label>
                                    <textarea name="socialStructure" value={formData.socialStructure} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Lives with 2 cage mates, solitary, dominant in group" />
                                </div>
                                )}
                            </div>
                        </div>

                        {/* Activity */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🌓🏃 Activity</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {!isFieldHidden('activityCycle') && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Activity Cycle</label>
                                <select name="activityCycle" value={formData.activityCycle} onChange={handleChange} data-tutorial-target="activity-pattern-select"
                                    className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                    <option value="">Select Activity Pattern</option>
                                    <option value="Diurnal">Diurnal (Active during day)</option>
                                    <option value="Nocturnal">Nocturnal (Active at night)</option>
                                    <option value="Crepuscular">Crepuscular (Active dawn/dusk)</option>
                                </select>
                            </div>
                            )}
                            {!isFieldHidden('exerciseRequirements') && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700">{getFieldLabel('exerciseRequirements', 'Exercise Requirements')}</label>
                                <select name="exerciseRequirements" value={formData.exerciseRequirements || ''} onChange={handleChange} 
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                    <option value="">Select...</option>
                                    <option value="Low">Low</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="High">High</option>
                                    <option value="Very High">Very High</option>
                                </select>
                            </div>
                            )}
                            {!isFieldHidden('dailyExerciseMinutes') && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700">{getFieldLabel('dailyExerciseMinutes', 'Daily Exercise (minutes)')}</label>
                                <input type="number" name="dailyExerciseMinutes" value={formData.dailyExerciseMinutes || ''} onChange={handleChange} 
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                    placeholder="e.g., 60" />
                            </div>
                            )}
                            </div>

                            {/* Training & Behavior - Template controlled */}
                            {(!isFieldHidden('trainingLevel') || !isFieldHidden('trainingDisciplines') || !isFieldHidden('workingRole') || !isFieldHidden('certifications')) && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {!isFieldHidden('trainingLevel') && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">{getFieldLabel('trainingLevel', 'Training Level')}</label>
                                            <select name="trainingLevel" value={formData.trainingLevel || ''} onChange={handleChange} 
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                                <option value="">Select...</option>
                                                <option value="None">None</option>
                                                <option value="Basic">Basic obedience</option>
                                                <option value="Intermediate">Intermediate</option>
                                                <option value="Advanced">Advanced</option>
                                                <option value="Competition">Competition level</option>
                                            </select>
                                        </div>
                                        )}
                                        {!isFieldHidden('trainingDisciplines') && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">{getFieldLabel('trainingDisciplines', 'Training Disciplines')}</label>
                                            <input type="text" name="trainingDisciplines" value={formData.trainingDisciplines || ''} onChange={handleChange} 
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                placeholder="e.g., Agility, Rally, Herding, Nosework" />
                                        </div>
                                        )}
                                        {!isFieldHidden('workingRole') && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">{getFieldLabel('workingRole', 'Working Role')}</label>
                                            <input type="text" name="workingRole" value={formData.workingRole || ''} onChange={handleChange} 
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                                placeholder="e.g., Service Dog, Therapy, SAR" />
                                        </div>
                                        )}
                                    </div>
                                    {!isFieldHidden('certifications') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">{getFieldLabel('certifications', 'Certifications')}</label>
                                        <textarea name="certifications" value={formData.certifications || ''} onChange={handleChange} rows="2"
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., CGC, TDI, AKC titles" />
                                    </div>
                                    )}
                                </>
                            )}
                            {(!isFieldHidden('crateTrained') || !isFieldHidden('litterTrained') || !isFieldHidden('leashTrained') || !isFieldHidden('freeFlightTrained')) && (
                            <div className="flex flex-wrap gap-6 pt-2">
                                {!isFieldHidden('crateTrained') && (
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" name="crateTrained" checked={formData.crateTrained || false} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">{getFieldLabel('crateTrained', 'Crate Trained')}</span>
                                </div>
                                )}
                                {!isFieldHidden('litterTrained') && (
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" name="litterTrained" checked={formData.litterTrained || false} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">{getFieldLabel('litterTrained', 'Litter Trained')}</span>
                                </div>
                                )}
                                {!isFieldHidden('leashTrained') && (
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" name="leashTrained" checked={formData.leashTrained || false} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">{getFieldLabel('leashTrained', 'Leash Trained')}</span>
                                </div>
                                )}
                                {!isFieldHidden('freeFlightTrained') && (
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" name="freeFlightTrained" checked={formData.freeFlightTrained || false} onChange={handleChange} 
                                        className="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary" />
                                    <span className="text-sm font-medium text-gray-700">{getFieldLabel('freeFlightTrained', 'Free Flight Trained')}</span>
                                </div>
                                )}
                            </div>
                            )}
                        </div>

                        {/* Known Issues */}
                        {(!isFieldHidden('behavioralIssues') || !isFieldHidden('biteHistory') || !isFieldHidden('reactivityNotes')) && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">⚠️ Known Issues</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('behavioralIssues') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('behavioralIssues', 'Behavioral Issues')}</label>
                                    <textarea name="behavioralIssues" value={formData.behavioralIssues || ''} onChange={handleChange} rows="2"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Resource guarding, separation anxiety" />
                                </div>
                                )}
                                {!isFieldHidden('biteHistory') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('biteHistory', 'Bite History')}</label>
                                    <textarea name="biteHistory" value={formData.biteHistory || ''} onChange={handleChange} rows="2"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Any bite incidents, context, and outcome" />
                                </div>
                                )}
                            </div>
                            {!isFieldHidden('reactivityNotes') && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700">{getFieldLabel('reactivityNotes', 'Reactivity Notes')}</label>
                                <textarea name="reactivityNotes" value={formData.reactivityNotes || ''} onChange={handleChange} rows="2"
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                    placeholder="Triggers, thresholds, management strategies" />
                            </div>
                            )}
                        </div>
                        )}

                    </div>
                )}

                {/* Tab 10: Records & Notes */}
                {activeTab === 10 && (
                    <div className="space-y-6">
                        {!isFieldHidden('remarks') && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200" data-tutorial-target="remarks-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">📝 Remarks & Notes</h3>
                            <textarea name="remarks" value={formData.remarks} onChange={handleChange} rows="5"
                                className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                placeholder="General notes, observations, and records..." />
                            <p className="text-xs text-gray-500 mt-2">Future features: File attachments, change timeline, and detailed record keeping will be added here.</p>
                        </div>
                        )}
                    </div>
                )}

                {/* Tab 11: End of Life & Legal */}
                {activeTab === 11 && (
                    <div className="space-y-6">
                        {/* End of Life */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🕊️ Information</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Date of Death</label>
                                    <DatePicker value={formData.deceasedDate || ''} onChange={(e) => handleChange({ target: { name: 'deceasedDate', value: e.target.value } })} data-tutorial-target="date-of-death-input"
                                        maxDate={new Date()}
                                        className="p-2" />
                                </div>
                                
                                {!isFieldHidden('causeOfDeath') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Cause of Death</label>
                                    <input type="text" name="causeOfDeath" value={formData.causeOfDeath} onChange={handleChange} data-tutorial-target="cause-of-death-input"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Natural causes, illness, injury" />
                                </div>
                                )}
                                
                                {!isFieldHidden('necropsyResults') && (
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Necropsy Results</label>
                                    <textarea name="necropsyResults" value={formData.necropsyResults} onChange={handleChange} rows="3" data-tutorial-target="necropsy-results-textarea"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Post-mortem examination findings..." />
                                </div>
                                )}

                                {!isFieldHidden('endOfLifeCareNotes') && (
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('endOfLifeCareNotes', 'End of Life Care Notes')}</label>
                                        <textarea name="endOfLifeCareNotes" value={formData.endOfLifeCareNotes || ''} onChange={handleChange} rows="2"
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="Wishes for cremation, burial, memorial" />
                                    </div>
                                )}
                            </div>
                        </div>

                    </div>
                )}

                {/* Tab 12: Show */}
                {activeTab === 12 && (
                    <div className="space-y-6">
                        {/* Show Titles & Ratings */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="show-titles-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🥇 Show Titles & Ratings</h3>
                            <div className="space-y-4">
                                {!isFieldHidden('showTitles') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Show Titles</label>
                                    <textarea name="showTitles" value={formData.showTitles || ''} onChange={handleChange} rows="3"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Champion (CH), Grand Champion (GCH), Best in Show" />
                                    <p className="text-xs text-gray-500 mt-1">List official show titles earned</p>
                                </div>
                                )}
                                
                                {!isFieldHidden('showRatings') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Show Ratings</label>
                                    <textarea name="showRatings" value={formData.showRatings || ''} onChange={handleChange} rows="3"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="e.g., Excellent, Very Good, ratings from shows" />
                                    <p className="text-xs text-gray-500 mt-1">Ratings and scores from shows or competitions</p>
                                </div>
                                )}
                                
                                {!isFieldHidden('judgeComments') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Judge Comments</label>
                                    <textarea name="judgeComments" value={formData.judgeComments || ''} onChange={handleChange} rows="4" data-tutorial-target="judge-comments-textarea"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                        placeholder="Notable comments from judges at shows or competitions" />
                                </div>
                                )}
                            </div>
                        </div>

                        {/* Working & Performance - Template controlled */}
                        {!isFieldHidden('workingTitles') && (
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">🎯 Working & Performance</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('workingTitles', 'Working Titles')}</label>
                                        <textarea name="workingTitles" value={formData.workingTitles || ''} onChange={handleChange} rows="3"
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., CGC (Canine Good Citizen), TKN (Trick Dog Novice), HT (Herding Tested)" />
                                        <p className="text-xs text-gray-500 mt-1">Working, obedience, agility, or performance titles</p>
                                    </div>
                                    {!isFieldHidden('performanceScores') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('performanceScores', 'Performance Scores')}</label>
                                        <textarea name="performanceScores" value={formData.performanceScores || ''} onChange={handleChange} rows="3"
                                            className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" 
                                            placeholder="e.g., Agility Q scores, obedience scores, rally scores" />
                                        <p className="text-xs text-gray-500 mt-1">Scores from performance events and trials</p>
                                    </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {/* Tab 13: Legal & Documentation */}
                {activeTab === 13 && (
                    <div className="space-y-6">
                        {/* Licensing */}
                        {(!isFieldHidden('licenseNumber') || !isFieldHidden('licenseJurisdiction')) && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🔑 Licensing & Permits</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('licenseNumber') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('licenseNumber', 'License Number')}</label>
                                    <input type="text" name="licenseNumber" value={formData.licenseNumber || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder={getFieldLabel('licenseNumber', 'License / permit number')} />
                                </div>
                                )}
                                {!isFieldHidden('licenseJurisdiction') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('licenseJurisdiction', 'License Jurisdiction')}</label>
                                    <input type="text" name="licenseJurisdiction" value={formData.licenseJurisdiction || ''} onChange={handleChange}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Los Angeles County" />
                                </div>
                                )}
                            </div>
                        </div>
                        )}

                        {/* Insurance & Legal Status */}
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4" data-tutorial-target="legal-admin-section">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">📋 Legal / Administrative</h3>
                            <div className="space-y-4">
                                {!isFieldHidden('insurance') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('insurance', 'Insurance')}</label>
                                    <textarea name="insurance" value={formData.insurance || ''} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Pet insurance policy details, provider, coverage" />
                                </div>
                                )}
                                {!isFieldHidden('legalStatus') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">{getFieldLabel('legalStatus', 'Legal Status')}</label>
                                    <textarea name="legalStatus" value={formData.legalStatus || ''} onChange={handleChange} rows="2"
                                        className="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="e.g., Ownership documents, permits, CITES registration" />
                                </div>
                                )}
                            </div>
                        </div>

                        {/* Restrictions */}
                        {(!isFieldHidden('breedingRestrictions') || !isFieldHidden('exportRestrictions')) && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">🚫 Restrictions</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {!isFieldHidden('breedingRestrictions') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('breedingRestrictions', 'Breeding Restrictions')}</label>
                                    <textarea name="breedingRestrictions" value={formData.breedingRestrictions || ''} onChange={handleChange} rows="2"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="Limited registration, spay/neuter contract" />
                                </div>
                                )}
                                {!isFieldHidden('exportRestrictions') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">{getFieldLabel('exportRestrictions', 'Export Restrictions')}</label>
                                    <textarea name="exportRestrictions" value={formData.exportRestrictions || ''} onChange={handleChange} rows="2"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
                                        placeholder="Country restrictions, registry limitations" />
                                </div>
                                )}
                            </div>
                        </div>
                        )}
                    </div>
                )}
                
                {/* Submit/Delete Buttons (always visible outside tabs) */}
                <div className="mt-8 flex justify-between items-center border-t pt-4">
                    <div className="flex space-x-4">
                        <button type="button" onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center space-x-2">
                            <ArrowLeft size={18} />
                            <span>Back to Profile</span>
                        </button>
                            <button
                                type="submit"
                                disabled={loading}
                                data-tutorial-target="save-animal-btn"
                                onClick={(e) => {
                                    try {
                                        console.log('Save button clicked (frontend debug)');
                                        const form = e.target && e.target.closest ? e.target.closest('form') : document.querySelector('form');
                                        if (form) {
                                            console.log('form.checkValidity():', form.checkValidity());
                                            Array.from(form.elements).forEach(el => {
                                                if (el.willValidate && !el.checkValidity()) {
                                                    console.warn('INVALID FIELD:', el.name || el.id || el.placeholder, el.validity, el.value);
                                                }
                                            });
                                        }
                                    } catch (err) {
                                        console.error('Save-button debug failed', err);
                                    }
                                }}
                                className="bg-primary hover:bg-primary/90 text-black font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center space-x-2 disabled:opacity-50"
                            >
                                {loading ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />}
                                <span>{loading ? 'Saving...' : 'Save Animal'}</span>
                            </button>
                    </div>
                    {animalToEdit && onDelete && (
                        <button 
                            type="button"
                            data-tutorial-target="delete-animal-btn"
                            onClick={() => { 
                                // Ownership logic:
                                // - If I created it and still own it ? Can delete it
                                // - If I created it but transferred it away ? Someone else owns it (I'd be in ViewOnly)
                                // - If it was transferred TO me ? I own it but can only return it (not delete)
                                
                                // Check if this animal was transferred TO the current user
                                const iWasTransferredThisAnimal = animalToEdit.originalOwnerId && animalToEdit.breederId_public && animalToEdit.breederId_public !== userProfile?.id_public && animalToEdit.ownerId_public === userProfile?.id_public;
                                
                                const confirmMessage = iWasTransferredThisAnimal 
                                    ? `Return ${animalToEdit.name} to ${animalToEdit.breederName || 'the original breeder'}? This will remove the animal from your account.`
                                    : `Are you sure you want to delete ${animalToEdit.name}? This action cannot be undone.`;
                                if(window.confirm(confirmMessage)) { 
                                    onDelete(animalToEdit.id_public, animalToEdit); 
                                } 
                            }} 
                            className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center space-x-2"
                        > 
                            {(() => {
                                const iWasTransferredThisAnimal = animalToEdit.originalOwnerId && animalToEdit.breederId_public && animalToEdit.breederId_public !== userProfile?.id_public && animalToEdit.ownerId_public === userProfile?.id_public;
                                return iWasTransferredThisAnimal ? <RotateCcw size={18} /> : <Trash2 size={18} />;
                            })()}
                            <span>{(() => {
                                const iWasTransferredThisAnimal = animalToEdit.originalOwnerId && animalToEdit.breederId_public && animalToEdit.breederId_public !== userProfile?.id_public && animalToEdit.ownerId_public === userProfile?.id_public;
                                return iWasTransferredThisAnimal ? 'Return Animal' : 'Delete';
                            })()}</span> 
                        </button>
                    )}
                </div>
            </form>
            
            {/* Community Genetics Submission Modal */}
            {showCommunityGeneticsModal && (
                <CommunityGeneticsModal
                    species={formData.species}
                    onClose={() => setShowCommunityGeneticsModal(false)}
                    authToken={authToken}
                    API_BASE_URL={API_BASE_URL}
                    showModalMessage={showModalMessage}
                />
            )}
        </div>
    );
};

const UserProfileCard = ({ userProfile }) => {
    if (!userProfile) return null;

    const formattedCreationDate = userProfile.creationDate
        ? new Intl.DateTimeFormat('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(userProfile.creationDate))
        : 'N/A';

    const isPersonalNameVisible = userProfile.showPersonalName ?? true;
    const isBreederNameVisible = userProfile.showBreederName ?? false;

    return (
        <div className="bg-white p-3 rounded-xl shadow-lg flex flex-col items-center text-center" style={{minWidth: '200px', maxWidth: '220px'}}>
            {/* Names at top */}
            <div className="mb-2 w-full">
                <div className="flex items-center justify-center gap-2 mb-2">
                    <DonationBadge user={userProfile} size="sm" />
                </div>
                {isPersonalNameVisible && (
                    <h3 className="text-sm font-bold text-gray-900 line-clamp-2">
                        {userProfile.personalName}
                    </h3>
                )}
                
                {(isBreederNameVisible && userProfile.breederName) && (
                    <div className="text-xs text-gray-700 font-semibold line-clamp-1">
                        {userProfile.breederName}
                    </div>
                )}

                {(!isPersonalNameVisible && !isBreederNameVisible) && (
                    <h3 className="text-xs font-bold text-gray-500">
                        (Name Hidden)
                    </h3>
                )}
            </div>

            {/* Image centered */}
            <div className="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 overflow-hidden shadow-inner mb-2">
                {(userProfile.profileImage || userProfile.profileImageUrl || userProfile.imageUrl || userProfile.avatarUrl || userProfile.avatar || userProfile.profile_image) ? (
                    <img src={userProfile.profileImage || userProfile.profileImageUrl || userProfile.imageUrl || userProfile.avatarUrl || userProfile.avatar || userProfile.profile_image} alt={userProfile.personalName} className="w-full h-full object-cover" />
                ) : (
                    <User size={32} />
                )}
            </div>

            {/* Other info below image */}
            <div className="w-full space-y-1">
                <div className="text-sm font-extrabold text-accent">
                    {userProfile.id_public}
                </div>
                
                <div className="text-xs text-gray-600">
                    {formattedCreationDate}
                </div>
            </div>
        </div>
    );
};

const ProfileEditForm = ({ userProfile, showModalMessage, onSaveSuccess, onCancel, authToken }) => {
    console.log('[ProfileEditForm] userProfile.allowMessages:', userProfile.allowMessages);
    
    const [personalName, setPersonalName] = useState(userProfile.personalName);
    const [breederName, setBreederName] = useState(userProfile.breederName || '');
    const [showPersonalName, setShowPersonalName] = useState(userProfile.showPersonalName ?? false); 
    const [showBreederName, setShowBreederName] = useState(userProfile.showBreederName ?? false); 
    const [websiteURL, setWebsiteURL] = useState(userProfile.websiteURL || '');
    const [showWebsiteURL, setShowWebsiteURL] = useState(userProfile.showWebsiteURL ?? false);
    const [showEmailPublic, setShowEmailPublic] = useState(userProfile.showEmailPublic ?? false); 
    const [showGeneticCodePublic, setShowGeneticCodePublic] = useState(userProfile.showGeneticCodePublic ?? false);
    const [showRemarksPublic, setShowRemarksPublic] = useState(userProfile.showRemarksPublic ?? false);
    const [bio, setBio] = useState(userProfile.bio || '');
    const [showBio, setShowBio] = useState(userProfile.showBio ?? true);
    const [allowMessages, setAllowMessages] = useState(userProfile.allowMessages === undefined ? true : !!userProfile.allowMessages);
    const [emailNotificationPreference, setEmailNotificationPreference] = useState(userProfile.emailNotificationPreference || 'none');
    const [country, setCountry] = useState(userProfile.country || '');
    const [usState, setUsState] = useState(userProfile.state || '');

    // Keep allowMessages in sync if userProfile updates (e.g., after save or refetch)
    useEffect(() => {
        const next = userProfile.allowMessages === undefined ? true : !!userProfile.allowMessages;
        setAllowMessages(next);
        // Also sync email notification preference and country
        setEmailNotificationPreference(userProfile.emailNotificationPreference || 'none');
        setCountry(userProfile.country || '');
        setUsState(userProfile.country === 'US' ? (userProfile.state || '') : '');
    }, [userProfile.allowMessages, userProfile.emailNotificationPreference, userProfile.country, userProfile.state]);
    
    console.log('[ProfileEditForm] Initial allowMessages state:', allowMessages);

    const [profileImageFile, setProfileImageFile] = useState(null); 
    const [profileImageURL, setProfileImageURL] = useState(
        userProfile.profileImage || userProfile.profileImageUrl || userProfile.imageUrl || userProfile.avatarUrl || userProfile.avatar || userProfile.profile_image || null
    ); 
    const [profileLoading, setProfileLoading] = useState(false);

    // Keep local preview in sync when parent `userProfile` updates (e.g., after save)
    useEffect(() => {
        const img = userProfile.profileImage || userProfile.profileImageUrl || userProfile.imageUrl || userProfile.avatarUrl || userProfile.avatar || userProfile.profile_image || null;
        setProfileImageURL(img);
    }, [userProfile]);

    const [email, setEmail] = useState(userProfile.email);
    const [currentPassword, setCurrentPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmNewPassword, setConfirmNewPassword] = useState('');
    const [securityLoading, setSecurityLoading] = useState(false);
    const [passwordLoading, setPasswordLoading] = useState(false);
    const [deleteLoading, setDeleteLoading] = useState(false);
    const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

    const handleImageChange = async (e) => {
        if (e.target.files && e.target.files[0]) {
            const original = e.target.files[0];
            try {
                const compressedBlob = await compressImageToMaxSize(original, 200 * 1024, { maxWidth: 1200, maxHeight: 1200, startQuality: 0.85 });
                const mime = compressedBlob.type || original.type;
                const baseName = original.name.replace(/\.[^/.]+$/, '');
                const ext = mime === 'image/png' ? '.png' : '.jpg';
                const compressedFile = new File([compressedBlob], `${baseName}${ext}`, { type: mime });
                if (compressedBlob.size > 200 * 1024) {
                    showModalMessage('Image Compression', 'Image was compressed but remains larger than 200KB. Consider using a smaller image for faster uploads.');
                }
                setProfileImageFile(compressedFile);
                setProfileImageURL(URL.createObjectURL(compressedFile));
            } catch (err) {
                console.warn('Profile image compression failed, using original file', err);
                setProfileImageFile(original);
                setProfileImageURL(URL.createObjectURL(original));
            }
        }
    };

    const handleProfileUpdate = async (e) => {
        e.preventDefault();
        setProfileLoading(true);
        
        const payload = {
            personalName: personalName,
            breederName: breederName || null,
            showPersonalName: showPersonalName,
            showBreederName: showBreederName,
            websiteURL: websiteURL || null,
            showWebsiteURL: websiteURL ? showWebsiteURL : false,
            showEmailPublic: showEmailPublic,
            showGeneticCodePublic: showGeneticCodePublic,
            showRemarksPublic: showRemarksPublic,
            bio: bio || null,
            showBio: bio ? showBio : true,
            allowMessages: allowMessages,
            emailNotificationPreference: emailNotificationPreference,
            country: country || null,
            state: country === 'US' ? (usState || null) : null,
        };
        
        console.log('[PROFILE UPDATE] allowMessages being sent:', allowMessages, 'Type:', typeof allowMessages);
        console.log('[PROFILE UPDATE] Bio state:', bio, 'Type:', typeof bio, 'Length:', bio ? bio.length : 'null');
        console.log('[PROFILE UPDATE] showBio state:', showBio, 'Type:', typeof showBio);
        
        console.log('[PROFILE UPDATE] Sending payload:', {
            showBreederName: payload.showBreederName,
            breederName: payload.breederName,
            bio: payload.bio,
            showBio: payload.showBio,
            showBreederNameType: typeof payload.showBreederName
        });

        try {
            let uploadSucceeded = false;
            let uploadData = null;

            if (profileImageFile) {
                try {
                    const fd = new FormData();
                    fd.append('file', profileImageFile);
                    fd.append('type', 'profile');
                    console.log('Profile: attempting upload to', `${API_BASE_URL}/upload`);
                    const uploadResp = await axios.post(`${API_BASE_URL}/upload`, fd, { headers: { Authorization: `Bearer ${authToken}` } });
                    console.log('Profile upload response:', uploadResp.status, uploadResp.data);
                    if (uploadResp?.data) {
                        uploadData = uploadResp.data;
                        const returnedUrl = uploadResp.data.url || uploadResp.data.path || (uploadResp.data.data && (uploadResp.data.data.url || uploadResp.data.data.path));
                        if (returnedUrl) {
                            payload.profileImage = returnedUrl;
                            payload.profileImageUrl = returnedUrl;
                            payload.imageUrl = returnedUrl;
                            payload.avatarUrl = returnedUrl;
                            payload.profile_image = returnedUrl;
                            uploadSucceeded = true;
                        }
                    }
                } catch (uploadErr) {
                    console.error('Profile image upload failed:', uploadErr?.response?.data || uploadErr.message);
                    showModalMessage('Image Upload', 'Upload endpoint failed ? will attempt fallback save (file included in profile PUT).');
                }
            }

            if (uploadSucceeded) {
                console.log('Profile: sending JSON profile update with image URL', payload.profileImageUrl);
                const resp = await axios.put(`${API_BASE_URL}/users/profile`, payload, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                // Try to obtain updated user object from response
                const updatedUser = resp?.data?.user || resp?.data || null;
                if (onSaveSuccess) await onSaveSuccess(updatedUser);
            } else if (profileImageFile) {
                try {
                    const form = new FormData();
                    form.append('profileImage', profileImageFile);
                    form.append('avatar', profileImageFile);
                    form.append('file', profileImageFile);
                    Object.keys(payload).forEach(k => {
                        if (payload[k] !== undefined && payload[k] !== null) form.append(k, payload[k]);
                    });
                    console.log('Profile: attempting multipart PUT to users/profile with form keys:', Array.from(form.keys()));
                    const profileResp = await axios.put(`${API_BASE_URL}/users/profile`, form, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    console.log('Profile multipart PUT response:', profileResp.status, profileResp.data);
                    const updatedUser = profileResp?.data?.user || profileResp?.data || null;
                    if (onSaveSuccess) await onSaveSuccess(updatedUser);
                } catch (fmErr) {
                    console.error('Profile multipart PUT failed:', fmErr?.response?.data || fmErr.message);
                    showModalMessage('Error', 'Failed to save profile with image. See console/network logs for details.');
                    throw fmErr;
                }
            } else {
                const resp = await axios.put(`${API_BASE_URL}/users/profile`, payload, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                const updatedUser = resp?.data?.user || resp?.data || null;
                if (onSaveSuccess) await onSaveSuccess(updatedUser);
            }
            showModalMessage('Success', 'Profile information updated successfully.');
            // If onSaveSuccess wasn't called with an updatedUser above, call it now without args
            if (onSaveSuccess) await onSaveSuccess(); 
        } catch (error) {
            console.error('Profile Update Error:', error.response?.data || error.message);
            showModalMessage('Error', error.response?.data?.message || 'Failed to update profile information.');
        } finally {
            setProfileLoading(false);
        }
    };

    const handleEmailUpdate = async (e) => {
        e.preventDefault();
        if (email === userProfile.email) {
            showModalMessage('Info', 'Email is already set to this value.');
            return;
        }
        setSecurityLoading(true);
        try {
            await axios.put(`${API_BASE_URL}/auth/change-email`, { newEmail: email }, { headers: { Authorization: `Bearer ${authToken}` } });
            showModalMessage('Email Changed', 'Your email has been updated. You may need to log in again with the new email.');
            await onSaveSuccess(); 
        } catch (error) {
            console.error('Email Update Error:', error.response?.data || error.message);
            showModalMessage('Error', error.response?.data?.message || 'Failed to update email address.');
            setEmail(userProfile.email); 
        } finally {
            setSecurityLoading(false);
        }
    };

    const handlePasswordUpdate = async (e) => {
        e.preventDefault();
        if (!currentPassword || !newPassword || !confirmNewPassword) {
            showModalMessage('Warning', 'All password fields are required to change your password.');
            return;
        }
        if (newPassword !== confirmNewPassword) {
            showModalMessage('Warning', 'New password and confirmation do not match.');
            return;
        }
        setPasswordLoading(true);
        try {
            await axios.put(`${API_BASE_URL}/auth/change-password`, { currentPassword, newPassword }, { headers: { Authorization: `Bearer ${authToken}` } });
            showModalMessage('Success', 'Your password has been changed successfully. You will need to re-login with the new password.');
            setCurrentPassword('');
            setNewPassword('');
            setConfirmNewPassword('');
        } catch (error) {
            console.error('Password Update Error:', error.response?.data || error.message);
            showModalMessage('Error', error.response?.data?.message || 'Failed to change password. Check your current password.');
        } finally {
            setPasswordLoading(false);
        }
    };

    const handleDeleteAccount = async () => {
        if (!showDeleteConfirm) {
            setShowDeleteConfirm(true);
            return;
        }
        
        setDeleteLoading(true);
        try {
            await axios.delete(`${API_BASE_URL}/users/account`, { 
                headers: { Authorization: `Bearer ${authToken}` } 
            });
            showModalMessage('Account Deleted', 'Your account and all data have been permanently deleted.');
            // Clear token and redirect to home
            localStorage.removeItem('authToken');
            window.location.href = '/';
        } catch (error) {
            console.error('Account Deletion Error:', error.response?.data || error.message);
            showModalMessage('Error', error.response?.data?.message || 'Failed to delete account.');
            setShowDeleteConfirm(false);
        } finally {
            setDeleteLoading(false);
        }
    };

    return (
        <div className="w-full max-w-5xl bg-white p-6 rounded-xl shadow-lg">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
                <h2 className="text-3xl font-bold text-gray-800 flex items-center">
                    <Settings size={24} className="mr-3 text-primary-dark" />
                    Edit Profile
                </h2>
                <button 
                    onClick={onCancel} 
                    className="flex items-center text-gray-600 hover:text-gray-800 transition" 
                    disabled={profileLoading || securityLoading || passwordLoading}
                >
                    <ArrowLeft size={18} className="mr-1" /> Back to Profile
                </button>
            </div>
            
            <form onSubmit={handleProfileUpdate} className="space-y-6 mb-8 p-4 sm:p-6 border rounded-lg bg-gray-50 overflow-x-hidden">
                <h3 className="text-xl font-semibold text-gray-800 border-b pb-2">Public Profile Information</h3>
                
                <div data-tutorial-target="profile-image-upload">
                    <ProfileImagePlaceholder 
                        url={profileImageURL} 
                        onFileChange={handleImageChange} 
                        disabled={profileLoading} 
                    />
                </div>

                <div className="space-y-4 min-w-0">
                    <div data-tutorial-target="name-fields">
                        <input type="text" name="personalName" placeholder="Personal Name *" value={personalName} onChange={(e) => setPersonalName(e.target.value)} required 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={profileLoading} />
                        <input type="text" name="breederName" placeholder="Breeder Name (Optional)" value={breederName} onChange={(e) => setBreederName(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={profileLoading} />
                    </div>
                    <div data-tutorial-target="website-country-fields">
                        <input type="url" name="websiteURL" placeholder="Website URL (Optional) e.g., https://example.com" value={websiteURL} onChange={(e) => setWebsiteURL(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={profileLoading} />
                    
                        <textarea 
                            name="bio" 
                            placeholder="Bio (Optional) - Tell other breeders about yourself and your breeding program" 
                            value={bio} 
                            onChange={(e) => setBio(e.target.value)}
                            rows="4"
                            maxLength="500"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border resize-none" 
                            disabled={profileLoading}
                        />
                        {bio && <p className="text-xs text-gray-500 mt-1">{bio.length}/500 characters</p>}

                        <select value={country} onChange={(e) => { setCountry(e.target.value); if (e.target.value !== 'US') setUsState(''); }}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={profileLoading}>
                        <option value="">Select Country (Optional)</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <option value="AU">Australia</option>
                        <option value="NZ">New Zealand</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="IT">Italy</option>
                        <option value="ES">Spain</option>
                        <option value="NL">Netherlands</option>
                        <option value="SE">Sweden</option>
                        <option value="NO">Norway</option>
                        <option value="DK">Denmark</option>
                        <option value="CH">Switzerland</option>
                        <option value="BE">Belgium</option>
                        <option value="AT">Austria</option>
                        <option value="PL">Poland</option>
                        <option value="CZ">Czech Republic</option>
                        <option value="IE">Ireland</option>
                        <option value="PT">Portugal</option>
                        <option value="GR">Greece</option>
                        <option value="RU">Russia</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                        <option value="CN">China</option>
                        <option value="IN">India</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                        <option value="ZA">South Africa</option>
                        <option value="SG">Singapore</option>
                        <option value="HK">Hong Kong</option>
                        <option value="MY">Malaysia</option>
                        <option value="TH">Thailand</option>
                        </select>

                        {country === 'US' && (
                            <select value={usState} onChange={(e) => setUsState(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border mt-2" disabled={profileLoading}>
                                <option value="">Select State (Optional)</option>
                                {US_STATES.map(s => (
                                    <option key={s.code} value={s.code}>{s.name}</option>
                                ))}
                            </select>
                        )}
                    </div>

                    <div data-tutorial-target="public-visibility-checkboxes" className="pt-2 space-y-2">
                        <h4 className="text-base font-medium text-gray-800 pt-2 border-t border-gray-200">Public Profile Visibility:</h4>
                        
                        <label className="flex items-center space-x-2 text-sm text-gray-700">
                            <input type="checkbox" checked={showPersonalName} onChange={(e) => setShowPersonalName(e.target.checked)} 
                                className="rounded text-primary-dark focus:ring-primary-dark" disabled={profileLoading} />
                            <span>Display **Personal Name** on your public profile card.</span>
                        </label>
                        
                        {breederName && (
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input type="checkbox" checked={showBreederName} onChange={(e) => setShowBreederName(e.target.checked)} 
                                    className="rounded text-primary-dark focus:ring-primary-dark" disabled={profileLoading} />
                                <span>Display **Breeder Name** on your public profile card.</span>
                            </label>
                        )}
                        
                        <label className="flex items-center space-x-2 text-sm text-gray-700">
                            <input type="checkbox" checked={showEmailPublic} onChange={(e) => setShowEmailPublic(e.target.checked)} 
                                className="rounded text-primary-dark focus:ring-primary-dark" disabled={profileLoading} />
                            <span>Display **Email Address** on your public profile card.</span>
                        </label>
                        
                        {websiteURL && (
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input type="checkbox" checked={showWebsiteURL} onChange={(e) => setShowWebsiteURL(e.target.checked)} 
                                    className="rounded text-primary-dark focus:ring-primary-dark" disabled={profileLoading} />
                                <span>Display **Website URL** on your public profile card.</span>
                            </label>
                        )}
                        
                        {bio && (
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input type="checkbox" checked={showBio} onChange={(e) => setShowBio(e.target.checked)} 
                                    className="rounded text-primary-dark focus:ring-primary-dark" disabled={profileLoading} />
                                <span>Display **Bio** on your public profile card.</span>
                            </label>
                        )}
                    </div>

                    <div data-tutorial-target="messaging-preferences" className="pt-4 space-y-2 border-t border-gray-200">
                        <h4 className="text-base font-medium text-gray-800">Messaging Preferences:</h4>
                        
                        <label className="flex items-center space-x-2 text-sm text-gray-700">
                            <input type="checkbox" checked={allowMessages} onChange={(e) => setAllowMessages(e.target.checked)} 
                                className="rounded text-primary-dark focus:ring-primary-dark" disabled={profileLoading} />
                            <span>Allow other breeders to message me</span>
                        </label>
                    </div>

                    <div data-tutorial-target="email-notifications" className="pt-4 space-y-3 border-t border-gray-200">
                        <h4 className="text-base font-medium text-gray-800">Email Notifications:</h4>
                        <p className="text-sm text-gray-600">Choose what types of notifications to receive via email:</p>
                        
                        <div className="space-y-2 pl-2">
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input 
                                    type="radio" 
                                    name="emailNotificationPreference" 
                                    value="none"
                                    checked={emailNotificationPreference === 'none'}
                                    onChange={(e) => setEmailNotificationPreference(e.target.value)}
                                    className="text-primary-dark focus:ring-primary-dark" 
                                    disabled={profileLoading} 
                                />
                                <span><strong>None</strong> - Don't send me email notifications</span>
                            </label>
                            
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input 
                                    type="radio" 
                                    name="emailNotificationPreference" 
                                    value="requestsOnly"
                                    checked={emailNotificationPreference === 'requestsOnly'}
                                    onChange={(e) => setEmailNotificationPreference(e.target.value)}
                                    className="text-primary-dark focus:ring-primary-dark" 
                                    disabled={profileLoading} 
                                />
                                <span><strong>Requests Only</strong> - Send breeder requests, transfers, and breeding requests</span>
                            </label>
                            
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input 
                                    type="radio" 
                                    name="emailNotificationPreference" 
                                    value="messagesOnly"
                                    checked={emailNotificationPreference === 'messagesOnly'}
                                    onChange={(e) => setEmailNotificationPreference(e.target.value)}
                                    className="text-primary-dark focus:ring-primary-dark" 
                                    disabled={profileLoading} 
                                />
                                <span><strong>Messages Only</strong> - Send new messages from other breeders</span>
                            </label>
                            
                            <label className="flex items-center space-x-2 text-sm text-gray-700">
                                <input 
                                    type="radio" 
                                    name="emailNotificationPreference" 
                                    value="all"
                                    checked={emailNotificationPreference === 'all'}
                                    onChange={(e) => setEmailNotificationPreference(e.target.value)}
                                    className="text-primary-dark focus:ring-primary-dark" 
                                    disabled={profileLoading} 
                                />
                                <span><strong>All</strong> - Send all notifications by email</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div data-tutorial-target="profile-save-cancel" className="flex justify-end pt-2">
                    <button type="submit" disabled={profileLoading}
                        className="bg-accent hover:bg-accent/90 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center disabled:opacity-50"
                    >
                        {profileLoading ? <Loader2 className="animate-spin mr-2" size={20} /> : <Save size={20} className="mr-2" />}
                        Save Profile Info
                    </button>
                </div>
            </form>

            <BreederDirectorySettings
                authToken={authToken}
                API_BASE_URL={API_BASE_URL}
                showModalMessage={showModalMessage}
                userProfile={userProfile}
            />
            
            <form onSubmit={handleEmailUpdate} className="space-y-4 mb-8 p-4 sm:p-6 border rounded-lg bg-gray-50 overflow-x-hidden">
                <h3 className="text-xl font-semibold text-gray-800 border-b pb-2">Change Email Address</h3>
                <input type="email" placeholder="New Email Address *" value={email} onChange={(e) => setEmail(e.target.value)} required 
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={securityLoading} />
                <div className="flex justify-end pt-2">
                    <button type="submit" disabled={securityLoading} 
                        className="bg-primary hover:bg-primary-dark text-black font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center disabled:opacity-50"
                    >
                        {securityLoading ? <Loader2 className="animate-spin mr-2" size={20} /> : <Mail size={20} className="mr-2" />}
                        Update Email
                    </button>
                </div>
            </form>

            <form onSubmit={handlePasswordUpdate} className="space-y-4 p-4 sm:p-6 border rounded-lg bg-gray-50 overflow-x-hidden">
                <h3 className="text-xl font-semibold text-gray-800 border-b pb-2">Change Password</h3>
                <input type="password" placeholder="Current Password *" value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} required 
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={passwordLoading} />
                <input type="password" placeholder="New Password *" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} required 
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={passwordLoading} />
                <input type="password" placeholder="Confirm New Password *" value={confirmNewPassword} onChange={(e) => setConfirmNewPassword(e.target.value)} required 
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition box-border" disabled={passwordLoading} />
                <div className="flex justify-end pt-2">
                    <button type="submit" disabled={passwordLoading}
                        className="bg-primary-dark hover:bg-primary text-black font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center disabled:opacity-50"
                    >
                        {passwordLoading ? <Loader2 className="animate-spin mr-2" size={20} /> : <Save size={20} className="mr-2" />}
                        Set New Password
                    </button>
                </div>
            </form>
            
            <div className="mt-8 p-4 sm:p-6 border-2 border-red-300 rounded-lg bg-red-50 overflow-x-hidden">
                <h3 className="text-xl font-semibold text-red-800 border-b border-red-200 pb-2 mb-4">Danger Zone</h3>
                <p className="text-sm text-gray-700 mb-4">
                    Deleting your account is permanent and cannot be undone. All your animals, litters, and profile data will be permanently deleted.
                </p>
                {!showDeleteConfirm ? (
                    <button
                        onClick={handleDeleteAccount}
                        className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition flex items-center gap-2"
                    >
                        <Trash2 size={18} />
                        Delete Account
                    </button>
                ) : (
                    <div className="space-y-3">
                        <p className="text-red-700 font-semibold">Are you absolutely sure? This cannot be undone!</p>
                        <div className="flex gap-3">
                            <button
                                onClick={handleDeleteAccount}
                                disabled={deleteLoading}
                                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition flex items-center gap-2 disabled:opacity-50"
                            >
                                {deleteLoading ? <Loader2 className="animate-spin" size={18} /> : <Trash2 size={18} />}
                                Yes, Delete Everything
                            </button>
                            <button
                                onClick={() => setShowDeleteConfirm(false)}
                                disabled={deleteLoading}
                                className="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

const DonationView = ({ onBack }) => {
    return (
        <div className="w-full max-w-2xl bg-white p-8 rounded-xl shadow-lg">
            {/* Back Button */}
            <button 
                onClick={onBack}
                className="flex items-center text-gray-600 hover:text-gray-800 font-medium mb-6 transition"
            >
                <ArrowLeft size={20} className="mr-2" />
                Back
            </button>

            {/* Header */}
            <div className="flex items-center gap-3 mb-6">
                <div className="bg-gradient-to-r from-pink-500 to-red-500 p-3 rounded-full">
                    <Heart size={32} className="text-white fill-current" />
                </div>
                <div>
                    <h1 className="text-3xl font-bold text-gray-800">Support CritterTrack</h1>
                    <p className="text-gray-500 text-sm">Help keep this platform running</p>
                </div>
            </div>

            {/* Description */}
            <div className="bg-gradient-to-r from-primary/10 to-accent/10 border-2 border-primary/20 rounded-lg p-6 mb-6">
                <p className="text-gray-700 leading-relaxed mb-4">
                    CritterTrack is provided <strong>completely free of charge</strong> to all users. There are no premium tiers, 
                    paywalls, or required subscriptions. However, hosting, maintaining, and improving this platform requires resources.
                </p>
                <p className="text-gray-700 leading-relaxed">
                    If you find CritterTrack valuable for managing your breeding program, please consider supporting its 
                    continued development with a voluntary donation. Every contribution, no matter the size, helps keep this 
                    platform running and improving.
                </p>
            </div>

            {/* Personal Note */}
            <div className="bg-accent/10 border-2 border-accent/30 rounded-lg p-5 mb-6">
                <p className="text-sm text-gray-700 font-semibold mb-2 flex items-center gap-2">
                    <Heart size={18} className="text-accent fill-current" />
                    A note from the developer
                </p>
                <p className="text-sm text-gray-600 leading-relaxed">
                    CritterTrack is developed and maintained by a single developer who is passionate about helping breeders 
                    manage their programs effectively. Your support directly contributes to server costs, new features, 
                    and ongoing maintenance. Thank you for being part of this community!
                </p>
            </div>

            {/* Donation Options */}
            <h2 className="text-xl font-bold text-gray-800 mb-4">Choose Your Support Method</h2>
            <div className="space-y-4">
                {/* One-Time Donation */}
                <div className="border-2 border-primary/30 rounded-lg p-6 bg-gradient-to-r from-primary/5 to-accent/5 hover:shadow-md transition">
                    <div className="flex items-start gap-4">
                        <div className="bg-primary/20 p-3 rounded-lg">
                            <DollarSign size={24} className="text-primary-dark" />
                        </div>
                        <div className="flex-1">
                            <h3 className="font-bold text-lg text-gray-800 mb-2">One-Time Donation</h3>
                            <p className="text-sm text-gray-600 mb-4">
                                Make a one-time contribution of any amount you choose. Perfect for showing your appreciation 
                                or celebrating a milestone in your breeding program.
                            </p>
                            <form action="https://www.paypal.com/donate" method="post" target="_blank">
                                <input type="hidden" name="business" value="mouserymorningstar@gmail.com" />
                                <input type="hidden" name="no_recurring" value="0" />
                                <input type="hidden" name="item_name" value="Support CritterTrack Development" />
                                <input type="hidden" name="currency_code" value="USD" />
                                <button
                                    type="submit"
                                    className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md flex items-center justify-center gap-2"
                                >
                                    <Heart size={18} />
                                    Donate via PayPal
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                {/* Monthly Subscription */}
                <div className="border-2 border-accent/30 rounded-lg p-6 bg-gradient-to-r from-accent/5 to-primary/5 hover:shadow-md transition">
                    <div className="flex items-start gap-4">
                        <div className="bg-accent/20 p-3 rounded-lg">
                            <RefreshCw size={24} className="text-accent-dark" />
                        </div>
                        <div className="flex-1">
                            <h3 className="font-bold text-lg text-gray-800 mb-2">Monthly Support</h3>
                            <p className="text-sm text-gray-600 mb-4">
                                Become a recurring supporter with a monthly contribution. Your ongoing support helps ensure 
                                CritterTrack's long-term sustainability. Cancel anytime through your PayPal account.
                            </p>
                            <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                                <input type="hidden" name="cmd" value="_xclick-subscriptions" />
                                <input type="hidden" name="business" value="mouserymorningstar@gmail.com" />
                                <input type="hidden" name="item_name" value="CritterTrack Monthly Support" />
                                <input type="hidden" name="currency_code" value="USD" />
                                <input type="hidden" name="a3" value="5.00" />
                                <input type="hidden" name="p3" value="1" />
                                <input type="hidden" name="t3" value="M" />
                                <input type="hidden" name="src" value="1" />
                                <input type="hidden" name="sra" value="1" />
                                <button
                                    type="submit"
                                    className="w-full bg-gradient-to-r from-accent to-accent/80 hover:from-accent-dark hover:to-accent text-white font-semibold py-3 px-6 rounded-lg transition shadow-md flex items-center justify-center gap-2"
                                >
                                    <Heart size={18} className="fill-current" />
                                    Support for $5/month
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                {/* Ko-fi Shop */}
                <div className="border-2 border-blue-500/30 rounded-lg p-6 bg-gradient-to-r from-blue-500/5 to-cyan-500/5 hover:shadow-md transition">
                    <div className="flex items-start gap-4">
                        <div className="bg-blue-500/20 p-3 rounded-lg">
                            <ShoppingBag size={24} className="text-blue-600" />
                        </div>
                        <div className="flex-1">
                            <h3 className="font-bold text-lg text-gray-800 mb-2">Ko-fi Shop</h3>
                            <p className="text-sm text-gray-600 mb-4">
                                Support CritterTrack by purchasing the Mouse Magic genetics guide. Currently Available in English and French! Every purchase helps 
                                fund server costs and development while you get quality products in return.
                            </p>
                            <a
                                href="https://ko-fi.com/mousemagic/shop"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md flex items-center justify-center gap-2"
                            >
                                <ShoppingBag size={18} />
                                Buy Mouse Magic Genetics Guide
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            {/* Footer Note */}
            <div className="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p className="text-xs text-gray-600 text-center leading-relaxed">
                    All donations are processed securely through PayPal. You are not required to have a PayPal account to donate. 
                    Monthly subscriptions can be cancelled at any time through your PayPal account settings.
                </p>
            </div>

            {/* Thank You */}
            <div className="mt-6 text-center">
                <p className="text-sm text-gray-500 italic">
                    Thank you for considering supporting CritterTrack. Your generosity is deeply appreciated! ??
                </p>
            </div>
        </div>
    );
};

// ==================== BREEDER DIRECTORY VIEW ====================
const BreederDirectory = ({ authToken, API_BASE_URL, onBack }) => {
    const navigate = useNavigate();
    const [breeders, setBreeders] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedSpecies, setSelectedSpecies] = useState('');
    const [selectedCountry, setSelectedCountry] = useState('');
    const [selectedState, setSelectedState] = useState('');
    const [availableSpecies, setAvailableSpecies] = useState([]);
    const [availableCountries, setAvailableCountries] = useState([]);
    const [availableStates, setAvailableStates] = useState([]);

    // Fetch breeders on mount
    useEffect(() => {
        fetchBreeders();
    }, []);

    const fetchBreeders = async () => {
        setLoading(true);
        try {
            const response = await axios.get(`${API_BASE_URL}/users/breeder-directory`, {
                headers: authToken ? { Authorization: `Bearer ${authToken}` } : {}
            });
            setBreeders(response.data || []);
            
            // Extract unique species from all breeders
            const speciesSet = new Set();
            response.data.forEach(breeder => {
                if (breeder.breedingStatus) {
                    Object.keys(breeder.breedingStatus).forEach(species => {
                        if (breeder.breedingStatus[species] === 'breeder' || breeder.breedingStatus[species] === 'retired') {
                            speciesSet.add(species);
                        }
                    });
                }
            });
            setAvailableSpecies(Array.from(speciesSet).sort());
            
            // Extract unique countries from all breeders
            const countrySet = new Set();
            response.data.forEach(breeder => {
                if (breeder.country) {
                    countrySet.add(breeder.country);
                }
            });
            setAvailableCountries(Array.from(countrySet).sort());

            // Extract unique US states from US breeders
            const stateSet = new Set();
            response.data.forEach(breeder => {
                if (breeder.country === 'US' && breeder.state) {
                    stateSet.add(breeder.state);
                }
            });
            setAvailableStates(Array.from(stateSet).sort());
        } catch (error) {
            console.error('Failed to fetch breeders:', error);
        } finally {
            setLoading(false);
        }
    };

    // Filter and sort breeders
    const filteredBreeders = useMemo(() => {
        let result = breeders;

        // Filter out breeders with no public names
        result = result.filter(breeder => {
            const hasPersonalName = breeder.showPersonalName && breeder.personalName;
            const hasBreederName = breeder.showBreederName && breeder.breederName;
            return hasPersonalName || hasBreederName;
        });

        // Filter by search query
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            result = result.filter(breeder => {
                const personalName = breeder.personalName?.toLowerCase() || '';
                const breederName = breeder.breederName?.toLowerCase() || '';
                const id = breeder.id_public?.toLowerCase() || '';
                return personalName.includes(query) || breederName.includes(query) || id.includes(query);
            });
        }

        // Filter by selected species
        if (selectedSpecies) {
            result = result.filter(breeder => {
                if (!breeder.breedingStatus) return false;
                return breeder.breedingStatus[selectedSpecies] === 'breeder' || 
                       breeder.breedingStatus[selectedSpecies] === 'retired';
            });
        }

        // Filter by selected country
        if (selectedCountry) {
            result = result.filter(breeder => breeder.country === selectedCountry);
        }

        // Filter by selected US state
        if (selectedState) {
            result = result.filter(breeder => breeder.state === selectedState);
        }

        return result;
    }, [breeders, searchQuery, selectedSpecies, selectedCountry, selectedState]);

    return (
        <div className="min-h-screen bg-gray-50 pb-20">
            {/* Header */}
            <div className="bg-white border-b border-gray-200 p-4 sticky top-0 z-10">
                <div className="max-w-5xl mx-auto">
                    <div className="flex items-center gap-3 mb-3">
                        <button
                            onClick={() => navigate(-1)}
                            className="p-2 hover:bg-gray-100 rounded transition"
                        >
                            <ArrowLeft size={20} />
                        </button>
                        <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <Star size={24} className="text-primary" />
                            Breeders Registry
                        </h1>
                    </div>

                    {/* Search */}
                    <div className="relative mb-3">
                        <Search size={18} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search by name or ID..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                        />
                    </div>

                    {/* Filters */}
                    <div className="flex gap-3">
                        <div className="flex-1">
                            <select
                                value={selectedSpecies}
                                onChange={(e) => setSelectedSpecies(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm"
                            >
                                <option value="">All Species</option>
                                {availableSpecies.map(species => (
                                    <option key={species} value={species}>
                                        {getSpeciesDisplayName(species)}
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div className="flex-1">
                            <select
                                value={selectedCountry}
                                onChange={(e) => { setSelectedCountry(e.target.value); if (e.target.value !== 'US') setSelectedState(''); }}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm"
                            >
                                <option value="">All Countries</option>
                                {availableCountries.map(country => (
                                    <option key={country} value={country}>
                                        {getCountryName(country)}
                                    </option>
                                ))}
                            </select>
                        </div>
                        {selectedCountry === 'US' && availableStates.length > 0 && (
                            <div className="flex-1">
                                <select
                                    value={selectedState}
                                    onChange={(e) => setSelectedState(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm"
                                >
                                    <option value="">All States</option>
                                    {availableStates.map(stateCode => (
                                        <option key={stateCode} value={stateCode}>
                                            {getStateName(stateCode)}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Content */}
            <div className="max-w-5xl mx-auto p-4">
                {loading ? (
                    <div className="flex items-center justify-center py-20">
                        <Loader2 size={32} className="animate-spin text-primary" />
                    </div>
                ) : filteredBreeders.length === 0 ? (
                    <div className="text-center py-20">
                        <Star size={48} className="mx-auto text-gray-300 mb-3" />
                        <p className="text-gray-600">No breeders found</p>
                        {(searchQuery || selectedSpecies || selectedCountry || selectedState) && (
                            <button
                                onClick={() => {
                                    setSearchQuery('');
                                    setSelectedSpecies('');
                                    setSelectedCountry('');
                                    setSelectedState('');
                                }}
                                className="mt-3 text-primary hover:underline"
                            >
                                Clear filters
                            </button>
                        )}
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {filteredBreeders.map(breeder => {
                            // Build display name based on what's public
                            let displayName = '';
                            const hasPersonalName = breeder.showPersonalName && breeder.personalName;
                            const hasBreederName = breeder.showBreederName && breeder.breederName;
                            
                            if (hasPersonalName && hasBreederName) {
                                displayName = `${breeder.personalName} (${breeder.breederName})`;
                            } else if (hasBreederName) {
                                displayName = breeder.breederName;
                            } else if (hasPersonalName) {
                                displayName = breeder.personalName;
                            } else {
                                displayName = breeder.id_public;
                            }

                            return (
                                <div
                                    key={breeder.id_public}
                                    className="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition"
                                >
                                    {/* Header Row */}
                                    <div className="flex flex-col sm:flex-row items-start gap-4 mb-4">
                                        {/* Profile Picture */}
                                        <div className="flex-shrink-0">
                                            <div className="w-20 h-20 bg-gray-100 rounded-full overflow-hidden">
                                                {breeder.profileImage ? (
                                                    <img 
                                                        src={breeder.profileImage} 
                                                        alt={displayName} 
                                                        className="w-full h-full object-cover"
                                                    />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                        <User size={36} />
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Name and CTU Badge */}
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-3 mb-1">
                                                <h3 className="text-xl font-bold text-gray-800">{displayName}</h3>
                                                <DonationBadge user={breeder} size="sm" />
                                            </div>
                                            <div className="flex items-center gap-3 flex-wrap">
                                                <span className="text-xs bg-primary text-black px-2.5 py-1 rounded font-medium">
                                                    {breeder.id_public}
                                                </span>
                                                {breeder.country && (
                                                    <div className="flex items-center gap-2 text-sm text-gray-600">
                                                        <span className={`${getCountryFlag(breeder.country)} inline-block h-4 w-6 flex-shrink-0`}></span>
                                                        <span>{getCountryName(breeder.country)}{breeder.country === 'US' && breeder.state ? `, ${getStateName(breeder.state)}` : ''}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* View Profile Button */}
                                        <button
                                            onClick={() => navigate(`/user/${breeder.id_public}`)}
                                            className="px-4 py-2 bg-primary hover:bg-primary/80 text-black text-sm font-medium rounded transition flex-shrink-0 w-full sm:w-auto"
                                        >
                                            View Profile
                                        </button>
                                    </div>

                                    {/* Bio */}
                                    {breeder.bio && (
                                        <p className="text-sm text-gray-700 mb-4 leading-relaxed">
                                            {breeder.bio}
                                        </p>
                                    )}

                                    {/* Breeding Species */}
                                    <div className="flex flex-wrap gap-3">
                                        {breeder.breedingStatus && Object.entries(breeder.breedingStatus).map(([species, status]) => {
                                            if (status !== 'breeder' && status !== 'retired') return null;
                                            
                                            return (
                                                <div 
                                                    key={species} 
                                                    className="flex items-center gap-2 px-3 py-1.5 bg-gray-50 rounded-full border border-gray-200"
                                                >
                                                    {status === 'breeder' ? (
                                                        <Star size={14} className="text-primary" />
                                                    ) : (
                                                        <Moon size={14} className="text-gray-500" />
                                                    )}
                                                    <span className="text-sm font-medium text-gray-800">{getSpeciesDisplayName(species)}</span>
                                                    <span className="text-xs text-gray-500">
                                                        ({status === 'breeder' ? 'Active' : 'Retired'})
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        </div>
    );
};

const ProfileView = ({ userProfile, showModalMessage, fetchUserProfile, authToken, onProfileUpdated, onProfileEditButtonClicked }) => {
    const navigate = useNavigate();
    const [isEditing, setIsEditing] = useState(false);
    const [copySuccess, setCopySuccess] = useState(false);
    const [checkingForUpdates, setCheckingForUpdates] = useState(false);
    const [updateAvailable, setUpdateAvailable] = useState(false);
    // Note: Donation button is now globally available via fixed button in top-left corner

    const handleShare = () => {
        const url = `${window.location.origin}/user/${userProfile.id_public}`;
        navigator.clipboard.writeText(url).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        });
    };

    const handleCheckForUpdates = async () => {
        setCheckingForUpdates(true);
        setUpdateAvailable(false);
        
        try {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    console.log('[ProfileView] Manually checking for service worker updates...');
                    await registration.update();
                    console.log('[ProfileView] Update check complete');
                    
                    // Set up listener for update found event
                    const handleUpdateAvailable = () => {
                        console.log('[ProfileView] Update is available!');
                        setUpdateAvailable(true);
                        showModalMessage('Update Available', 'A new version of CritterTrack is available. Please refresh the page to update.');
                        // Remove listener after it fires
                        window.removeEventListener('sw-update-available', handleUpdateAvailable);
                    };
                    
                    window.addEventListener('sw-update-available', handleUpdateAvailable);
                    
                    // Check if update was already found (SW_UPDATE_AVAILABLE flag)
                    if (window.SW_UPDATE_AVAILABLE) {
                        handleUpdateAvailable();
                    }
                    
                    showModalMessage('Check Complete', 'CritterTrack is up to date. You\'re running the latest version!');
                } else {
                    showModalMessage('Error', 'Service worker is not installed. Please refresh the page.');
                }
            }
        } catch (error) {
            console.error('[ProfileView] Error checking for updates:', error);
            showModalMessage('Error', 'Failed to check for updates. Please try again later.');
        } finally {
            setCheckingForUpdates(false);
        }
    };

    if (!userProfile) return <LoadingSpinner />;

    if (isEditing) {
        return (
            <ProfileEditForm 
                userProfile={userProfile} 
                showModalMessage={showModalMessage} 
                onSaveSuccess={(updatedUser) => { 
                    if (updatedUser && typeof onProfileUpdated === 'function') {
                        onProfileUpdated(updatedUser);
                    } else {
                        fetchUserProfile(authToken);
                    }
                    setIsEditing(false);
                }} 
                onCancel={() => setIsEditing(false)} 
                authToken={authToken} 
            />
        );
    }

    return (
        <div className="w-full max-w-5xl bg-white p-3 sm:p-6 rounded-xl shadow-lg">
            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-0 mb-4 sm:mb-6">
                <h2 className="text-xl sm:text-3xl font-bold text-gray-800 flex items-center">
                    <Settings className="w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3 text-primary-dark" />
                    Profile Settings
                </h2>
                <button
                    onClick={handleShare}
                    className="px-2 sm:px-3 py-1 sm:py-1.5 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-1 sm:gap-2 text-sm sm:text-base self-start sm:self-auto"
                >
                    <Link className="w-4 h-4 sm:w-4 sm:h-4" />
                    {copySuccess ? 'Copied!' : 'Share'}
                </button>
            </div>
            <div className="space-y-3 sm:space-y-4 overflow-x-hidden">
                
                <div className="p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200 overflow-x-hidden">
                    <p className="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3">Public Visibility Status</p>
                    
                    <div className="flex justify-between items-center gap-2 py-1.5 sm:py-2">
                        <span className="text-xs sm:text-sm text-gray-800 truncate flex-1">Personal Name</span>
                        <span className={`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs font-semibold rounded-full whitespace-nowrap ${ 
                            (userProfile.showPersonalName ?? true) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {(userProfile.showPersonalName ?? true) ? 'Public' : 'Private'}
                        </span>
                    </div>

                    <div className="flex justify-between items-center gap-2 py-1.5 sm:py-2">
                        <span className="text-xs sm:text-sm text-gray-800 truncate flex-1">Breeder Name</span>
                        <span className={`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs font-semibold rounded-full whitespace-nowrap ${ 
                            (userProfile.showBreederName ?? false) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {(userProfile.showBreederName ?? false) ? 'Public' : 'Private'}
                        </span>
                    </div>

                    <div className="flex justify-between items-center gap-2 py-1.5 sm:py-2">
                        <span className="text-xs sm:text-sm text-gray-800 truncate flex-1">Website URL</span>
                        <span className={`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs font-semibold rounded-full whitespace-nowrap ${ 
                            (userProfile.showWebsiteURL ?? false) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {(userProfile.showWebsiteURL ?? false) ? 'Public' : 'Private'}
                        </span>
                    </div>

                    <div className="flex justify-between items-center gap-2 py-1.5 sm:py-2">
                        <span className="text-xs sm:text-sm text-gray-800 truncate flex-1">Bio</span>
                        <span className={`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs font-semibold rounded-full whitespace-nowrap ${ 
                            (userProfile.showBio ?? true) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {(userProfile.showBio ?? true) ? 'Public' : 'Private'}
                        </span>
                    </div>

                    <div className="flex justify-between items-center gap-2 py-1.5 sm:py-2">
                        <span className="text-sm sm:text-base text-gray-800 truncate">Messages</span>
                        <span className={`px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${
                            (userProfile.allowMessages === true) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {(userProfile.allowMessages === true) ? 'Allowed' : 'Disabled'}
                        </span>
                    </div>
                    
                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 py-2">
                        <span className="text-sm sm:text-base text-gray-800 truncate">Email Address ({userProfile.email})</span>
                        <span className={`px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${ 
                            (userProfile.showEmailPublic ?? false) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`}>
                            {(userProfile.showEmailPublic ?? false) ? 'Public' : 'Private'}
                        </span>
                    </div>
                </div>

                <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 overflow-x-hidden" data-tutorial-target="personal-id-section">
                    <p className="text-lg font-semibold text-gray-700">Personal ID:</p>
                    <p className="text-2xl sm:text-3xl font-extrabold text-accent truncate">{userProfile.id_public}</p>
                </div>
            </div>
            
            <button 
                onClick={() => {
                    setIsEditing(true);
                    onProfileEditButtonClicked(true);
                }}
                data-tutorial-target="profile-edit-btn"
                className="mt-6 bg-accent hover:bg-accent/90 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 shadow-md flex items-center"
            >
                <Edit size={20} className="mr-2" /> Edit Profile
            </button>
            
            <button 
                onClick={handleCheckForUpdates}
                disabled={checkingForUpdates}
                className="mt-3 bg-primary hover:bg-primary/90 text-black font-semibold py-3 px-6 rounded-lg transition duration-150 shadow-md flex items-center disabled:opacity-50"
            >
                {checkingForUpdates ? (
                    <>
                        <Loader2 size={20} className="mr-2 animate-spin" /> Checking for Updates...
                    </>
                ) : updateAvailable ? (
                    <>
                        <CheckCircle size={20} className="mr-2 text-green-600" /> Update Available!
                    </>
                ) : (
                    <>
                        <RefreshCw size={20} className="mr-2" /> Check for Updates
                    </>
                )}
            </button>
            
            {userProfile?.id_public === 'CTU2' && (
                <button 
                    onClick={() => navigate('/family-tree')}
                    className="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 shadow-md flex items-center"
                >
                    <Users size={20} className="mr-2" /> Family Tree (Testing)
                </button>
            )}
        </div>
    );
};

const AuthView = ({ onLoginSuccess, showModalMessage, isRegister, setIsRegister, mainTitle, onShowTerms, onShowPrivacy, userCount }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [personalName, setPersonalName] = useState('');
    const [loading, setLoading] = useState(false);
    const [verificationStep, setVerificationStep] = useState(false);
    const [verificationCode, setVerificationCode] = useState('');
    const [agreedToTerms, setAgreedToTerms] = useState(false);
    const [forgotPasswordStep, setForgotPasswordStep] = useState(0); // 0=off, 1=email, 2=code, 3=new password
    const [resetEmail, setResetEmail] = useState('');
    const [resetCode, setResetCode] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmNewPassword, setConfirmNewPassword] = useState('');
    const [suspensionInfo, setSuspensionInfo] = useState(null);
    const [suspensionTimeRemaining, setSuspensionTimeRemaining] = useState(null);
    const [banInfo, setBanInfo] = useState(null);
    const [suspensionLiftedNotification, setSuspensionLiftedNotification] = useState(null);

    // Restore verification state from localStorage on mount
    useEffect(() => {
        const savedVerificationState = localStorage.getItem('pendingVerification');
        if (savedVerificationState) {
            try {
                const { email: savedEmail, verificationStep: savedStep } = JSON.parse(savedVerificationState);
                setEmail(savedEmail);
                setVerificationStep(savedStep);
                setIsRegister(true);
            } catch (error) {
                console.error('Failed to restore verification state:', error);
                localStorage.removeItem('pendingVerification');
            }
        }
        
        // Check URL for password reset token
        const params = new URLSearchParams(window.location.search);
        const resetToken = params.get('token');
        const resetTokenEmail = params.get('email');
        if (resetToken && resetTokenEmail) {
            setForgotPasswordStep(3);
            setResetCode(resetToken);
            setResetEmail(resetTokenEmail);
        }
    }, []);

    // Persist verification state to localStorage when it changes
    useEffect(() => {
        if (verificationStep && email) {
            localStorage.setItem('pendingVerification', JSON.stringify({ 
                email, 
                verificationStep: true 
            }));
        } else {
            localStorage.removeItem('pendingVerification');
        }
    }, [verificationStep, email]);

    // Check for suspension info and update timer
    useEffect(() => {
        const suspensionEndTime = localStorage.getItem('suspensionEndTime');
        const suspensionReason = localStorage.getItem('suspensionReason');
        
        if (suspensionEndTime) {
            setSuspensionInfo({
                endTime: parseInt(suspensionEndTime),
                reason: suspensionReason || 'Your account has been suspended.'
            });
        }
        
        // Check for ban info
        const banReason = localStorage.getItem('banReason');
        const banType = localStorage.getItem('banType');
        
        if (banReason) {
            setBanInfo({
                reason: banReason,
                type: banType || 'banned'
            });
        }
    }, []);

    // Update suspension countdown timer
    useEffect(() => {
        if (!suspensionInfo) return;
        
        const updateTimer = () => {
            const now = new Date().getTime();
            const timeLeft = suspensionInfo.endTime - now;
            
            if (timeLeft <= 0) {
                // Suspension expired
                setSuspensionTimeRemaining(null);
                localStorage.removeItem('suspensionEndTime');
                localStorage.removeItem('suspensionReason');
                setSuspensionInfo(null);
            } else {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                // Format end date as dd/mm/yyyy
                const endDate = new Date(suspensionInfo.endTime);
                const day = String(endDate.getDate()).padStart(2, '0');
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const year = endDate.getFullYear();
                const endDateStr = `${day}/${month}/${year}`;
                
                // Build time string - show days/hours/minutes plus expiry date
                const timeParts = [];
                if (days > 0) timeParts.push(`${days}d`);
                if (hours > 0 || days > 0) timeParts.push(`${hours}h`);
                timeParts.push(`${minutes}m`);
                
                setSuspensionTimeRemaining(`${timeParts.join(' ')} | Expires: ${endDateStr}`);
            }
        };
        
        updateTimer();
        const interval = setInterval(updateTimer, 60000); // Update every minute
        
        return () => clearInterval(interval);
    }, [suspensionInfo]);

    // Check for and manage suspension lift notification
    useEffect(() => {
        const suspensionLiftedData = localStorage.getItem('suspensionLiftedNotification');
        
        if (suspensionLiftedData) {
            try {
                const { expiresAt } = JSON.parse(suspensionLiftedData);
                const now = new Date().getTime();
                
                if (now < expiresAt) {
                    // Notification is still valid (within 24 hours)
                    setSuspensionLiftedNotification(true);
                } else {
                    // Notification has expired
                    localStorage.removeItem('suspensionLiftedNotification');
                    setSuspensionLiftedNotification(null);
                }
            } catch (error) {
                console.error('Error parsing suspension lift notification:', error);
                localStorage.removeItem('suspensionLiftedNotification');
            }
        }
    }, []);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        if (isRegister && !verificationStep) {
            // Step 1: Request verification code
            if (!agreedToTerms) {
                showModalMessage('Terms Required', 'You must agree to the Terms of Service and Privacy Policy to register.');
                setLoading(false);
                return;
            }
            if (password !== confirmPassword) {
                showModalMessage('Password Mismatch', 'Passwords do not match. Please try again.');
                setLoading(false);
                return;
            }
            try {
                await axios.post(`${API_BASE_URL}/auth/register-request`, {
                    email,
                    password,
                    personalName
                });
                setVerificationStep(true);
                showModalMessage('Verification Code Sent', 'Please check your email for a 6-digit verification code.');
            } catch (error) {
                console.error('Registration request error:', error.response?.data || error.message);
                showModalMessage(
                    'Registration Failed',
                    error.response?.data?.message || 'Failed to send verification code. Please try again.'
                );
            } finally {
                setLoading(false);
            }
        } else if (isRegister && verificationStep) {
            // Step 2: Verify code and complete registration
            try {
                const response = await axios.post(`${API_BASE_URL}/auth/verify-email`, {
                    email,
                    code: verificationCode
                });
                localStorage.removeItem('pendingVerification');
                showModalMessage('Registration Success', 'Your account has been verified! You are now logged in.');
                onLoginSuccess(response.data.token);
                setVerificationStep(false);
                setVerificationCode('');
            } catch (error) {
                console.error('Verification error:', error.response?.data || error.message);
                showModalMessage(
                    'Verification Failed',
                    error.response?.data?.message || 'Invalid or expired verification code. Please try again.'
                );
            } finally {
                setLoading(false);
            }
        } else {
            // Login flow (unchanged)
            try {
                const response = await axios.post(`${API_BASE_URL}/auth/login`, { email, password });
                
                // Clear any old suspension data on successful login
                localStorage.removeItem('suspensionEndTime');
                localStorage.removeItem('suspensionReason');
                localStorage.removeItem('banReason');
                localStorage.removeItem('banType');
                setSuspensionInfo(null);
                setSuspensionTimeRemaining(null);
                setBanInfo(null);
                
                onLoginSuccess(response.data.token);
            } catch (error) {
                console.error('Login error:', error.response?.data || error.message);
                
                // Check if this is a suspension or ban error (403)
                if (error.response?.status === 403) {
                    const message = error.response?.data?.message || '';
                    
                    if (message.includes('Account suspended')) {
                        // Parse suspension message and extract expiry time
                        console.log('[LOGIN] User account suspended:', message);
                        
                        // Check if suspension end time already exists in localStorage
                        const existingEndTime = localStorage.getItem('suspensionEndTime');
                        let suspensionEndTime;
                        
                        // PRIORITY 1: Use structured expiryTimestamp from response (most accurate, directly from server)
                        const responseTimestamp = error.response?.data?.expiryTimestamp;
                        
                        if (responseTimestamp) {
                            // Use the structured expiryTimestamp from response data - it's the source of truth
                            console.log('[LOGIN] Using server expiryTimestamp:', responseTimestamp);
                            suspensionEndTime = responseTimestamp;
                        } else {
                            // PRIORITY 2: Try to extract from message string (fallback)
                            const timestampMatch = message.match(/ExpiryTimestamp:\s*(\d+)/);
                            
                            if (timestampMatch) {
                                console.log('[LOGIN] Using expiryTimestamp from message');
                                suspensionEndTime = parseInt(timestampMatch[1]);
                            } else if (existingEndTime) {
                                // PRIORITY 3: Use existing stored time (don't reset timer on retry)
                                console.log('[LOGIN] Using stored suspension end time');
                                suspensionEndTime = parseInt(existingEndTime);
                            } else {
                                // PRIORITY 4: Last resort - calculate from hours/minutes
                                console.log('[LOGIN] Calculating from hours/minutes (fallback)');
                                const hoursMatch = message.match(/(\d+)\s+hour/);
                                const minutesMatch = message.match(/(\d+)\s+minute/);
                                const hoursRemaining = hoursMatch ? parseInt(hoursMatch[1]) : 0;
                                const minutesRemaining = minutesMatch ? parseInt(minutesMatch[1]) : 0;
                                
                                console.log('[LOGIN] Parsed hours:', hoursRemaining, 'minutes:', minutesRemaining);
                                
                                const totalMilliseconds = (hoursRemaining * 60 * 60 * 1000) + (minutesRemaining * 60 * 1000);
                                console.log('[LOGIN] Total milliseconds:', totalMilliseconds);
                                
                                if (totalMilliseconds > 0) {
                                    suspensionEndTime = new Date().getTime() + totalMilliseconds;
                                    console.log('[LOGIN] Calculated end time:', suspensionEndTime);
                                } else {
                                    console.error('[LOGIN] Could not extract suspension duration from message, defaulting to 24 hours');
                                    suspensionEndTime = new Date().getTime() + (24 * 60 * 60 * 1000);
                                }
                            }
                        }
                        
                        // Extract reason - try multiple patterns to be robust
                        let suspensionReason = 'Your account has been suspended.';
                        
                        // Try pattern 1: Extract everything between "Account suspended:" and "Expires in"
                        const reasonMatch1 = message.match(/Account suspended:\s*(.+?)\s+Expires in/i);
                        if (reasonMatch1) {
                            suspensionReason = reasonMatch1[1].trim();
                        } else {
                            // Try pattern 2: Extract everything after "Account suspended:" until we hit "ExpiryTimestamp"
                            const reasonMatch2 = message.match(/Account suspended:\s*(.+?)\s+ExpiryTimestamp/i);
                            if (reasonMatch2) {
                                suspensionReason = reasonMatch2[1].trim();
                            } else {
                                // Try pattern 3: Extract everything after "Account suspended:" (greedy, in case Expires in isn't there)
                                const reasonMatch3 = message.match(/Account suspended:\s*(.+)/i);
                                if (reasonMatch3) {
                                    let text = reasonMatch3[1];
                                    // Remove ExpiryTimestamp if it exists
                                    text = text.replace(/\s*ExpiryTimestamp:.+$/i, '').trim();
                                    // Remove Expires in... if it exists
                                    text = text.replace(/\s*Expires in.+$/i, '').trim();
                                    if (text) {
                                        suspensionReason = text;
                                    }
                                }
                            }
                        }
                        
                        console.log('[LOGIN] Extracted suspension reason:', suspensionReason);
                        
                        // Store suspension info for display on login screen (always update with server timestamp)
                        localStorage.setItem('suspensionEndTime', suspensionEndTime.toString());
                        localStorage.setItem('suspensionReason', suspensionReason);
                        
                        // Trigger re-render of suspension banner
                        setSuspensionInfo({
                            endTime: suspensionEndTime,
                            reason: suspensionReason
                        });
                        
                        // Don't show error modal for suspension - let the banner display it
                        return;
                    } else if (message.includes('Account banned')) {
                        // Extract ban reason and type
                        const banReasonMatch = message.match(/^Account banned:\s*(.+?)(?:\s+\(IP Ban\))?$/);
                        const banReason = banReasonMatch ? banReasonMatch[1] : 'Your account has been permanently banned.';
                        const isIPBan = message.includes('IP Ban');
                        
                        // Store ban info for display on login screen
                        localStorage.setItem('banReason', banReason);
                        localStorage.setItem('banType', isIPBan ? 'ip-ban' : 'banned');
                        
                        // Trigger re-render of ban banner
                        setBanInfo({
                            reason: banReason,
                            type: isIPBan ? 'ip-ban' : 'banned'
                        });
                        
                        // Don't show error modal for ban - let the banner display it
                        return;
                    }
                }
                
                // If login failed for any reason OTHER than suspension, clear old suspension data
                // This handles the case where suspension was lifted but user typed wrong password
                localStorage.removeItem('suspensionEndTime');
                localStorage.removeItem('suspensionReason');
                localStorage.removeItem('banReason');
                localStorage.removeItem('banType');
                setSuspensionInfo(null);
                setSuspensionTimeRemaining(null);
                setBanInfo(null);
                
                showModalMessage(
                    'Login Failed',
                    error.response?.data?.message || 'An unexpected error occurred. Please try again.'
                );
            } finally {
                setLoading(false);
            }
        }
    };

    const handleForgotPassword = async (e) => {
        e.preventDefault();
        if (forgotPasswordStep === 1) {
            // Step 1: Request password reset
            setLoading(true);
            try {
                await axios.post(`${API_BASE_URL}/auth/forgot-password`, { email: resetEmail });
                showModalMessage('Check Your Email', 'A password reset email has been sent. Click the button in the email to continue.');
                setForgotPasswordStep(2);
            } catch (error) {
                console.error('Forgot password error:', error.response?.data || error.message);
                showModalMessage(
                    'Request Failed',
                    error.response?.data?.message || 'Failed to send reset email. Please try again.'
                );
            } finally {
                setLoading(false);
            }
        } else if (forgotPasswordStep === 2) {
            // Step 2: User should have clicked the button in email - skip to step 3
            // This shouldn't normally be reached, but kept for safety
            setForgotPasswordStep(3);
        } else if (forgotPasswordStep === 3) {
            // Step 3: Reset password with code and new password
            if (newPassword !== confirmNewPassword) {
                showModalMessage('Password Mismatch', 'Passwords do not match.');
                return;
            }
            setLoading(true);
            try {
                await axios.post(`${API_BASE_URL}/auth/reset-password`, {
                    email: resetEmail,
                    token: resetCode,
                    newPassword
                });
                showModalMessage('Success', 'Password reset successful! You can now log in with your new password.');
                setForgotPasswordStep(0);
                setResetEmail('');
                setResetCode('');
                setNewPassword('');
                setConfirmNewPassword('');
            } catch (error) {
                console.error('Reset password error:', error.response?.data || error.message);
                showModalMessage(
                    'Reset Failed',
                    error.response?.data?.message || 'Failed to reset password. Please try again.'
                );
            } finally {
                setLoading(false);
            }
        }
    };

    const closeForgotPassword = () => {
        setForgotPasswordStep(0);
        setResetEmail('');
        setResetCode('');
        setNewPassword('');
        setConfirmNewPassword('');
    };

    const handleResendCode = async () => {
        setLoading(true);
        try {
            await axios.post(`${API_BASE_URL}/auth/resend-verification`, { email });
            showModalMessage('Code Resent', 'A new verification code has been sent to your email.');
        } catch (error) {
            console.error('Resend error:', error.response?.data || error.message);
            showModalMessage('Resend Failed', error.response?.data?.message || 'Failed to resend code.');
        } finally {
            setLoading(false);
        }
    };

    const handleBackToRegistration = () => {
        setVerificationStep(false);
        setVerificationCode('');
        localStorage.removeItem('pendingVerification');
    };

    const handleClearCode = () => {
        setVerificationCode('');
    };

    return (
        <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl">
            {!forgotPasswordStep && !verificationStep && (
                <div className="mb-6 p-4 rounded-lg bg-gradient-to-r from-blue-100 to-purple-100 flex items-center gap-4 shadow">
                    <Users size={32} className="text-primary-dark" />
                    <div>
                        <div className="text-lg font-bold text-gray-800">
                            Join {userCount} breeders & keepers!
                        </div>
                        <div className="text-sm text-gray-700">
                            Be part of a growing community. Register now and connect with passionate breeders and keepers worldwide!
                        </div>
                    </div>
                </div>
            )}
            <h2 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                {forgotPasswordStep > 0 ? 'Reset Password' : (verificationStep ? 'Verify Your Email' : mainTitle)}
            </h2>

            {forgotPasswordStep > 0 ? (
                // Forgot Password Flow
                <form onSubmit={handleForgotPassword} className="space-y-4">
                    {forgotPasswordStep === 1 && (
                        <div>
                            <p className="text-sm text-gray-600 mb-4">Enter the email address associated with your account.</p>
                            <input
                                type="email"
                                placeholder="Email Address *"
                                value={resetEmail}
                                onChange={(e) => setResetEmail(e.target.value)}
                                required
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition"
                            />
                        </div>
                    )}
                    
                    {forgotPasswordStep === 2 && (
                        <div>
                            <p className="text-sm text-gray-600 mb-4">📧 Check your email for a password reset button. Click it to proceed with resetting your password.</p>
                            <p className="text-xs text-gray-500 bg-blue-50 p-3 rounded border border-blue-200">The reset link will expire in 1 hour.</p>
                        </div>
                    )}
                    
                    {forgotPasswordStep === 3 && (
                        <div className="space-y-3">
                            <p className="text-sm text-gray-600 mb-4">Enter your new password.</p>
                            <input
                                type="password"
                                placeholder="New Password *"
                                value={newPassword}
                                onChange={(e) => setNewPassword(e.target.value)}
                                required
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition"
                            />
                            <input
                                type="password"
                                placeholder="Confirm Password *"
                                value={confirmNewPassword}
                                onChange={(e) => setConfirmNewPassword(e.target.value)}
                                required
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition"
                            />
                        </div>
                    )}
                    
                    <button
                        type="submit"
                        disabled={loading || (forgotPasswordStep === 1 && !resetEmail) || (forgotPasswordStep === 2) || (forgotPasswordStep === 3 && (!newPassword || !confirmNewPassword))}
                        className="w-full bg-primary text-black font-bold py-3 rounded-lg shadow-md hover:bg-primary/90 transition duration-150 flex items-center justify-center disabled:opacity-50"
                    >
                        {loading ? <Loader2 className="animate-spin mr-2" size={20} /> : (
                            forgotPasswordStep === 1 ? 'Send Reset Email' : 
                            forgotPasswordStep === 2 ? 'I clicked the email button' : 
                            'Reset Password'
                        )}
                    </button>
                    
                    <button
                        type="button"
                        onClick={closeForgotPassword}
                        className="w-full text-sm text-gray-600 hover:text-gray-800 transition py-2"
                    >
                        ? Back to Login
                    </button>
                </form>
            ) : verificationStep ? (
                // Step 2: Verification Code Form
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="text-center mb-4">
                        <p className="text-sm text-gray-600">
                            We sent a 6-digit code to <strong>{email}</strong>
                        </p>
                        <p className="text-xs text-gray-500 mt-2">
                            Code expires in 10 minutes
                        </p>
                    </div>
                    
                    <input 
                        type="text" 
                        placeholder="Enter 6-digit code" 
                        value={verificationCode} 
                        onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))} 
                        required 
                        maxLength={6}
                        pattern="[0-9]{6}"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition text-center text-2xl tracking-widest font-mono"
                    />
                    
                    <button
                        type="submit"
                        disabled={loading || verificationCode.length !== 6}
                        className="w-full bg-primary text-black font-bold py-3 rounded-lg shadow-md hover:bg-primary/90 transition duration-150 flex items-center justify-center disabled:opacity-50"
                    >
                        {loading ? <Loader2 className="animate-spin mr-2" size={20} /> : 'Verify & Create Account'}
                    </button>

                    <div className="flex flex-col space-y-2 mt-4 border-t pt-4">
                        <button 
                            type="button" 
                            onClick={handleClearCode}
                            disabled={loading}
                            className="text-sm text-accent hover:text-accent/80 transition duration-150 font-medium py-1"
                        >
                            Clear Code & Try Again
                        </button>
                        <button 
                            type="button" 
                            onClick={handleResendCode}
                            disabled={loading}
                            className="text-sm text-accent hover:text-accent/80 transition duration-150 font-medium py-1"
                        >
                            Resend Code
                        </button>
                        <button 
                            type="button" 
                            onClick={handleBackToRegistration}
                            className="text-sm text-gray-600 hover:text-gray-800 transition duration-150 py-1"
                        >
                            ? Change Email or Start Over
                        </button>
                    </div>
                </form>
            ) : (
                // Step 1: Registration/Login Form
                <form onSubmit={handleSubmit} className="space-y-4">
                    
                    {suspensionLiftedNotification && (
                        <div className="bg-green-100 border-l-4 border-green-500 p-4 rounded">
                            <div className="flex items-start">
                                <div className="flex-shrink-0">
                                    <CheckCircle className="h-5 w-5 text-green-500" />
                                </div>
                                <div className="ml-3 w-full">
                                    <p className="text-sm font-bold text-green-900">Good News! ??</p>
                                    <p className="text-sm text-green-800 mt-2">Your suspension has been lifted. You can now log in to your account.</p>
                                    <p className="text-xs text-green-600 mt-2">This message will disappear in 24 hours.</p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {suspensionInfo && (
                        <div className="bg-red-100 border-l-4 border-red-500 p-4 rounded">
                            <div className="flex items-start">
                                <div className="flex-shrink-0">
                                    <AlertCircle className="h-5 w-5 text-red-500" />
                                </div>
                                <div className="ml-3 w-full">
                                    <p className="text-sm font-bold text-red-900">Account Suspended</p>
                                    <p className="text-sm text-red-800 mt-2 font-semibold">Reason:</p>
                                    <p className="text-sm text-red-700 mt-1 bg-red-50 p-2 rounded border border-red-200">{suspensionInfo.reason}</p>
                                    {suspensionTimeRemaining && (
                                        <p className="text-sm text-red-700 mt-3 font-semibold">
                                            Time remaining: <span className="text-lg text-red-900">{suspensionTimeRemaining}</span>
                                        </p>
                                    )}
                                    <p className="text-xs text-red-600 mt-3">
                                        <a href={`mailto:CrittertrackOwner@gmail.com?subject=Suspension Appeal&body=I would like to appeal my account suspension.%0D%0A%0D%0AReason for suspension: ${encodeURIComponent(suspensionInfo.reason)}%0D%0A%0D%0AMy appeal:`} className="underline hover:text-red-800 font-semibold">
                                            Submit an appeal
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {banInfo && (
                        <div className="bg-red-900 border-l-4 border-red-700 p-4 rounded">
                            <div className="flex items-start">
                                <div className="flex-shrink-0">
                                    <Ban className="h-5 w-5 text-red-200" />
                                </div>
                                <div className="ml-3">
                                    <p className="text-sm font-medium text-red-100">
                                        Account {banInfo.type === 'ip-ban' ? 'IP Banned' : 'Permanently Banned'}
                                    </p>
                                    <p className="text-sm text-red-200 mt-1">{banInfo.reason}</p>
                                    <p className="text-sm text-red-300 mt-2">
                                        {banInfo.type === 'ip-ban' 
                                            ? 'Your IP address has been banned from creating accounts or accessing the platform.' 
                                            : 'This account has been permanently banned from accessing the platform.'}
                                    </p>
                                    <p className="text-xs text-red-200 mt-2">
                                        <a href={`mailto:CrittertrackOwner@gmail.com?subject=${banInfo.type === 'ip-ban' ? 'IP Ban' : 'Ban'} Appeal&body=I would like to appeal my account ban.%0D%0A%0D%0AReason for ban: ${encodeURIComponent(banInfo.reason)}%0D%0A%0D%0AMy appeal:`} className="underline hover:text-red-100">
                                            Submit an appeal
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {isRegister && (
                        <input type="text" placeholder="Your Personal Name *" value={personalName} onChange={(e) => setPersonalName(e.target.value)} required 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" />
                    )}
                    
                    <input type="email" placeholder="Email Address *" value={email} onChange={(e) => setEmail(e.target.value)} required 
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" />
                    <input type="password" placeholder="Password *" value={password} onChange={(e) => setPassword(e.target.value)} required 
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" />
                    
                    {isRegister && (
                        <input 
                            type="password" 
                            placeholder="Confirm Password *" 
                            value={confirmPassword} 
                            onChange={(e) => setConfirmPassword(e.target.value)} 
                            required 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" 
                        />
                    )}
                    
                    {isRegister && (
                        <label className="flex items-start space-x-2 p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input
                                type="checkbox"
                                checked={agreedToTerms}
                                onChange={(e) => setAgreedToTerms(e.target.checked)}
                                required
                                className="mt-1 h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary cursor-pointer"
                            />
                            <span className="text-sm text-gray-700">
                                I agree to the{' '}
                                <button
                                    type="button"
                                    onClick={onShowTerms}
                                    className="text-accent hover:text-accent/80 underline font-medium"
                                >
                                    Terms of Service
                                </button>
                                {' '}and{' '}
                                <button
                                    type="button"
                                    onClick={onShowPrivacy}
                                    className="text-accent hover:text-accent/80 underline font-medium"
                                >
                                    Privacy Policy
                                </button>
                            </span>
                        </label>
                    )}
                    
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-primary text-black font-bold py-3 rounded-lg shadow-md hover:bg-primary/90 transition duration-150 flex items-center justify-center disabled:opacity-50"
                    >
                        {loading ? <Loader2 className="animate-spin mr-2" size={20} /> : (isRegister ? <><UserPlus size={20} className="mr-2" /> Register</> : <><LogIn size={20} className="mr-2" /> Log In</>)}
                    </button>
                </form>
            )}
            
            {!verificationStep && forgotPasswordStep === 0 && (
                <>
                    <div className="mt-6 text-center space-y-3">
                        {!isRegister && (
                            <button type="button" onClick={() => setForgotPasswordStep(1)}
                                className="block w-full text-sm text-accent hover:text-accent/80 transition duration-150 font-medium"
                            >
                                Forgot Password?
                            </button>
                        )}
                        <button type="button" onClick={() => setIsRegister(prev => !prev)}
                            className="block w-full text-sm text-accent hover:text-accent/80 transition duration-150 font-medium"
                        >
                            {isRegister ? 'Already have an account? Log In' : "Don't have an account? Register Here"}
                        </button>
                    </div>
                    
                    <div className="mt-4">
                        <InstallPWA />
                    </div>
                </>
            )}
            
            <div className="mt-6 pt-6 border-t border-gray-200 text-center text-xs text-gray-500 space-x-4">
                <button onClick={onShowTerms} className="hover:text-primary transition">
                    Terms of Service
                </button>
                <span>|</span>
                <button onClick={onShowPrivacy} className="hover:text-primary transition">
                    Privacy Policy
                </button>
            </div>
        </div>
    );
};

    const ParentCard = ({ parentId, parentType, authToken, API_BASE_URL, onViewAnimal }) => {
        const [parentData, setParentData] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [notFound, setNotFound] = React.useState(false);

        React.useEffect(() => {
            if (!parentId) {
                setParentData(null);
                setNotFound(false);
                return;
            }

            const fetchParent = async () => {
                setLoading(true);
                setNotFound(false);
                try {
                    console.log(`[ParentCard] Fetching parent ${parentId} of type ${parentType}`);
                    // Try to fetch from authenticated endpoint (can access any animal globally)
                    try {
                        const response = await axios.get(`${API_BASE_URL}/animals/any/${parentId}`, {
                            headers: { Authorization: `Bearer ${authToken}` }
                        });
                        if (response.data) {
                            console.log(`[ParentCard] Found parent ${parentId} via /animals/any:`, response.data);
                            setParentData(response.data);
                            setLoading(false);
                            return;
                        }
                    } catch (authError) {
                        // If authenticated endpoint fails, try public
                        console.log(`[ParentCard] Parent ${parentId} not found in /animals/any, trying public. Error:`, authError.response?.status, authError.response?.data);
                    }

                    // Try fetching from global public animals database
                    const publicResponse = await axios.get(`${API_BASE_URL}/public/global/animals?id_public=${parentId}`);
                    if (publicResponse.data && publicResponse.data.length > 0) {
                        console.log(`[ParentCard] Found parent ${parentId} via public endpoint`);
                        setParentData(publicResponse.data[0]);
                    } else {
                        // Animal not found in either collection - treat as if no parent recorded
                        console.warn(`[ParentCard] Parent ${parentId} not found in local or public collections`);
                        setNotFound(true);
                        setParentData(null);
                    }
                } catch (error) {
                    console.error(`[ParentCard] Error fetching ${parentType}:`, error);
                    setNotFound(true);
                    setParentData(null);
                } finally {
                    setLoading(false);
                }
            };

            fetchParent();
        }, [parentId, parentType, authToken, API_BASE_URL]);

    if (!parentId || notFound) {
        return (
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                <p className="text-gray-500 text-sm">No {parentType} recorded</p>
            </div>
        );
    }

    if (loading) {
        return (
            <div className="border-2 border-gray-300 rounded-lg p-4 flex justify-center items-center">
                <Loader2 size={24} className="animate-spin text-gray-400" />
            </div>
        );
    }

    if (!parentData) {
        return (
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                <p className="text-gray-500 text-sm">Loading {parentType} data...</p>
            </div>
        );
    }

    const imgSrc = parentData.imageUrl || parentData.photoUrl || null;

    return (
        <div 
            className="border-2 border-gray-300 rounded-lg overflow-hidden cursor-pointer hover:shadow-md transition-shadow"
            onClick={() => onViewAnimal(parentData)}
        >
            <div className="bg-gray-50 px-3 py-2 border-b border-gray-300">
                <p className="text-xs font-semibold text-gray-600">{parentType}</p>
            </div>
            <div className="p-3 flex flex-col items-center">
                {/* Image */}
                <div className="w-20 h-20 bg-gray-100 rounded-md overflow-hidden flex items-center justify-center mb-2">
                    {imgSrc ? (
                        <img src={imgSrc} alt={parentData.name} className="w-full h-full object-cover" />
                    ) : (
                        <Cat size={28} className="text-gray-400" />
                    )}
                </div>

                {/* Icon row */}
                <div className="flex justify-center items-center space-x-2 mb-2">
                    {parentData.isOwned ? (
                        <Heart size={12} className="text-black" />
                    ) : (
                        <HeartOff size={12} className="text-black" />
                    )}
                    {parentData.showOnPublicProfile ? (
                        <Eye size={12} className="text-black" />
                    ) : (
                        <EyeOff size={12} className="text-black" />
                    )}
                    {parentData.isInMating && <Hourglass size={12} className="text-black" />}
                    {parentData.isPregnant && <Bean size={12} className="text-black" />}
                    {parentData.isNursing && <Milk size={12} className="text-black" />}
                </div>

                {/* Name */}
                <div className="text-center mb-1">
                    <p className="text-sm font-semibold text-gray-800 truncate">
                        {parentData.prefix ? `${parentData.prefix} ` : ''}{parentData.name}{parentData.suffix ? ` ${parentData.suffix}` : ''}
                    </p>
                </div>

                {/* ID */}
                <div className="text-center mb-2">
                    <p className="text-xs text-gray-500">{parentData.id_public}</p>
                </div>

                {/* Status bar */}
                <div className="w-full bg-gray-100 py-1 text-center border-t border-gray-300">
                    <p className="text-xs font-medium text-gray-700">{parentData.status || 'Unknown'}</p>
                </div>
            </div>
        </div>
    );
};

const AnimalList = ({ authToken, showModalMessage, onEditAnimal, onViewAnimal, fetchHiddenAnimals, navigate }) => {
    const [animals, setAnimals] = useState([]);
    const [allAnimalsRaw, setAllAnimalsRaw] = useState([]); // Unfiltered ? used by Management View
    const [loading, setLoading] = useState(true);
    
    // Load filters from localStorage or use defaults
    const [statusFilter, setStatusFilter] = useState(() => {
        try {
            return localStorage.getItem('animalList_statusFilter') || '';
        } catch { return ''; }
    });
    // Manual search: `searchInput` is the controlled input, `appliedNameFilter` is sent to the API
    const [searchInput, setSearchInput] = useState(() => {
        try {
            return localStorage.getItem('animalList_searchInput') || '';
        } catch { return ''; }
    });
    const [appliedNameFilter, setAppliedNameFilter] = useState(() => {
        try {
            return localStorage.getItem('animalList_appliedNameFilter') || '';
        } catch { return ''; }
    });
    const [selectedGenders, setSelectedGenders] = useState(() => {
        try {
            const saved = localStorage.getItem('animalList_selectedGenders');
            // Default to all genders if not previously saved
            return saved ? JSON.parse(saved) : ['Male', 'Female', 'Intersex', 'Unknown'];
        } catch { return ['Male', 'Female', 'Intersex', 'Unknown']; }
    });
    // Always start with all species selected (empty array = show all)
    // Don't persist this filter to prevent newly created animals from being hidden
    const [selectedSpecies, setSelectedSpecies] = useState([]);
    // Master species list ? all species the user has ANY animal for, never filtered
    const [allUserSpecies, setAllUserSpecies] = useState([]);
    const [statusFilterPregnant, setStatusFilterPregnant] = useState(() => {
        try {
            return localStorage.getItem('animalList_statusFilterPregnant') === 'true';
        } catch { return false; }
    });
    const [statusFilterNursing, setStatusFilterNursing] = useState(() => {
        try {
            return localStorage.getItem('animalList_statusFilterNursing') === 'true';
        } catch { return false; }
    });
    const [statusFilterMating, setStatusFilterMating] = useState(() => {
        try {
            return localStorage.getItem('animalList_statusFilterMating') === 'true';
        } catch { return false; }
    });
    const [ownedFilterActive, setOwnedFilterActive] = useState(() => {
        try {
            const saved = localStorage.getItem('animalList_ownedFilterActive');
            return saved !== null ? saved === 'true' : true;
        } catch { return true; }
    });
    const [publicFilter, setPublicFilter] = useState(() => {
        try {
            return localStorage.getItem('animalList_publicFilter') || '';
        } catch { return ''; }
    });
    const [bulkDeleteMode, setBulkDeleteMode] = useState({}); // { species: true/false }
    const [selectedAnimals, setSelectedAnimals] = useState({}); // { species: [id1, id2, ...] }
    const [collapsedSpecies, setCollapsedSpecies] = useState({}); // { species: true/false } - for mobile collapse
    const [userSpeciesOrder, setUserSpeciesOrder] = useState([]); // User's custom species order
    const [animalView, setAnimalView] = useState('list'); // 'list' | 'management'
    const [collapsedMgmtSections, setCollapsedMgmtSections] = useState({ enclosures: true }); // { sectionKey: bool }
    const [collapsedMgmtGroups, setCollapsedMgmtGroups] = useState({}); // { groupKey: bool }

    // Activity Log state
    const [activityLogs, setActivityLogs] = useState([]);
    const [logsLoading, setLogsLoading] = useState(false);
    const [logsPagination, setLogsPagination] = useState({ page: 1, totalPages: 1, total: 0 });
    const [logsLoaded, setLogsLoaded] = useState(false);
    const [showActivityLogScreen, setShowActivityLogScreen] = useState(false);
    const [logFilterAction, setLogFilterAction] = useState('');
    const [logFilterSearch, setLogFilterSearch] = useState('');
    const [logFilterStartDate, setLogFilterStartDate] = useState('');
    const [logFilterEndDate, setLogFilterEndDate] = useState('');
    // Supplies & Inventory state
    const [showSuppliesScreen, setShowSuppliesScreen] = useState(false);
    const [supplies, setSupplies] = useState([]);
    const [suppliesLoading, setSuppliesLoading] = useState(false);
    const [supplyForm, setSupplyForm] = useState({ name: '', category: 'Other', currentStock: '', unit: '', reorderThreshold: '', notes: '', isFeederAnimal: false, feederType: '', feederSize: '', costPerUnit: '', nextOrderDate: '', orderFrequency: '', orderFrequencyUnit: 'months' });
    const [supplyFormVisible, setSupplyFormVisible] = useState(false);
    const [editingSupplyId, setEditingSupplyId] = useState(null);
    const [supplySaving, setSupplySaving] = useState(false);
    const [supplyCategoryFilter, setSupplyCategoryFilter] = useState('All');
    const [restockingSupplyId, setRestockingSupplyId] = useState(null);
    const [restockForm, setRestockForm] = useState({ qty: '', cost: '', date: new Date().toISOString().slice(0, 10), notes: '' });
    const [restockSaving, setRestockSaving] = useState(false);
    const [feedingModal, setFeedingModal] = useState(null); // { animal } when open
    const [feedingForm, setFeedingForm] = useState({ supplyId: '', qty: '1', notes: '', updateStock: true });
    const [enclosures, setEnclosures] = useState([]);
    const [enclosureFormVisible, setEnclosureFormVisible] = useState(false);
    const [enclosureFormData, setEnclosureFormData] = useState({ name: '', enclosureType: '', size: '', notes: '', cleaningTasks: [] });
    const [editingEnclosureId, setEditingEnclosureId] = useState(null);
    const [enclosureSaving, setEnclosureSaving] = useState(false);
    const [assigningAnimalId, setAssigningAnimalId] = useState(null);
    const [newCleaningTaskName, setNewCleaningTaskName] = useState('');
    const [newCleaningTaskFreq, setNewCleaningTaskFreq] = useState('');
    
    // Save filters to localStorage whenever they change
    useEffect(() => {
        try {
            localStorage.setItem('animalList_statusFilter', statusFilter);
        } catch (e) { console.warn('Failed to save statusFilter', e); }
    }, [statusFilter]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_searchInput', searchInput);
        } catch (e) { console.warn('Failed to save searchInput', e); }
    }, [searchInput]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_appliedNameFilter', appliedNameFilter);
        } catch (e) { console.warn('Failed to save appliedNameFilter', e); }
    }, [appliedNameFilter]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_selectedGenders', JSON.stringify(selectedGenders));
        } catch (e) { console.warn('Failed to save selectedGenders', e); }
    }, [selectedGenders]);
    
    // Removed selectedSpecies persistence - always default to showing all species
    // This prevents confusion when users create new animals and they don't appear due to cached filters
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_statusFilterPregnant', statusFilterPregnant.toString());
        } catch (e) { console.warn('Failed to save statusFilterPregnant', e); }
    }, [statusFilterPregnant]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_statusFilterNursing', statusFilterNursing.toString());
        } catch (e) { console.warn('Failed to save statusFilterNursing', e); }
    }, [statusFilterNursing]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_statusFilterMating', statusFilterMating.toString());
        } catch (e) { console.warn('Failed to save statusFilterMating', e); }
    }, [statusFilterMating]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_ownedFilterActive', ownedFilterActive.toString());
        } catch (e) { console.warn('Failed to save ownedFilterActive', e); }
    }, [ownedFilterActive]);
    
    useEffect(() => {
        try {
            localStorage.setItem('animalList_publicFilter', publicFilter);
        } catch (e) { console.warn('Failed to save publicFilter', e); }
    }, [publicFilter]);
    
    const fetchAnimals = useCallback(async () => {
        setLoading(true);
        try {
            let params = [];
            if (statusFilter) {
                params.push(`status=${statusFilter}`);
            }
            if (appliedNameFilter) {
                params.push(`name=${encodeURIComponent(appliedNameFilter)}`);
            }
            if (statusFilterPregnant) {
                params.push(`isPregnant=true`);
            }
            if (statusFilterNursing) {
                params.push(`isNursing=true`);
            }
            if (statusFilterMating) {
                params.push(`isInMating=true`);
            }
            if (ownedFilterActive) {
                params.push(`isOwned=true`);
            }
            const queryString = params.length > 0 ? `?${params.join('&')}` : '';
            const url = `${API_BASE_URL}/animals${queryString}`;

            const response = await axios.get(url, { headers: { Authorization: `Bearer ${authToken}` } });
            let data = response.data || [];
            
            // Client-side fallback filtering in case the API doesn't apply the `name` filter reliably
            if (appliedNameFilter) {
                const term = appliedNameFilter.toLowerCase();
                data = data.filter(a => {
                    const name = (a.name || '').toString().toLowerCase();
                    const registry = (a.breederAssignedId || a.registryCode || '').toString().toLowerCase();
                    const idPublic = (a.id_public || '').toString().toLowerCase();
                    const tags = (a.tags || []).map(t => t.toLowerCase());
                    const tagsMatch = tags.some(tag => tag.includes(term));
                    return name.includes(term) || registry.includes(term) || idPublic.includes(term.replace(/^ct-?/,'').toLowerCase()) || tagsMatch;
                });
            }

            // Filter by selected species (if any species are selected)
            if (selectedSpecies.length > 0) {
                data = data.filter(a => selectedSpecies.includes(a.species));
            }

            // Filter by selected genders (if not all are selected, or if none are selected show nothing)
            if (selectedGenders.length === 0) {
                // No genders selected = show no animals
                data = [];
            } else if (selectedGenders.length < GENDER_OPTIONS.length) {
                // Some genders selected = filter to those
                data = data.filter(a => selectedGenders.includes(a.gender));
            }

            // Filter out view-only animals when "My Animals" filter is active
            if (ownedFilterActive) {
                data = data.filter(a => !a.isViewOnly);
            }

            // Enforce that males are excluded when pregnant or nursing filters are active
            if (statusFilterPregnant || statusFilterNursing) {
                data = data.filter(a => {
                    const gender = (a.gender || '').toString().toLowerCase();
                    return gender !== 'male';
                });
            }

            // Ensure only animals with the actual boolean flags are shown when those filters are enabled
            if (statusFilterPregnant) {
                data = data.filter(a => a.isPregnant === true);
            }
            if (statusFilterNursing) {
                data = data.filter(a => a.isNursing === true);
            }
            if (statusFilterMating) {
                data = data.filter(a => a.isInMating === true);
            }

            // Filter by public/private status
            if (publicFilter === 'public') {
                data = data.filter(a => a.showOnPublicProfile === true);
            } else if (publicFilter === 'private') {
                data = data.filter(a => !a.showOnPublicProfile);
            }

            // Cache-bust images ONLY once per session startup (not on every filter change)
            // Store whether we've already busted this session
            if (!fetchAnimals._cacheBusted) {
                fetchAnimals._cacheBusted = true;
                data = data.map(a => {
                    const img = a.imageUrl || a.photoUrl || null;
                    if (img) {
                        const busted = img.includes('?') ? `${img}&t=${Date.now()}` : `${img}?t=${Date.now()}`;
                        return { ...a, imageUrl: busted, photoUrl: busted };
                    }
                    return a;
                });
            }

            setAnimals(data);
            // Derive species list from already-fetched data instead of a separate API call
            const speciesList = [...new Set(data.map(a => a.species).filter(Boolean))];
            if (speciesList.length > 0) setAllUserSpecies(speciesList);
        } catch (error) {
            console.error('Fetch animals error:', error);
            showModalMessage('Error', 'Failed to fetch animal list.');
        } finally {
            setLoading(false);
        }
    }, [authToken, statusFilter, selectedGenders, selectedSpecies, appliedNameFilter, statusFilterPregnant, statusFilterNursing, statusFilterMating, ownedFilterActive, publicFilter, showModalMessage]);

    // Species list is now derived from the fetchAnimals result � no separate API call needed
    const fetchAllSpecies = useCallback(async () => {
        // No-op: species are populated as a side-effect of fetchAnimals()
        // Kept for compatibility with the animals-changed event handler
    }, []);

    // Fetch ALL user animals (no client-side filters) ? used by Management View
    const fetchAllAnimals = useCallback(async () => {
        if (!authToken) return;
        try {
            const res = await axios.get(`${API_BASE_URL}/animals`, {
                headers: { Authorization: `Bearer ${authToken}` },
                params: { isOwned: 'true' }
            });
            setAllAnimalsRaw(res.data || []);
        } catch (err) { console.error('[fetchAllAnimals]', err); }
    }, [authToken, API_BASE_URL]);

    useEffect(() => {
        fetchAnimals();
    }, [fetchAnimals]);

    // Refresh animals when other parts of the app signal a change (e.g., after upload/save)
    useEffect(() => {
        const handleAnimalsChanged = () => {
            try { fetchAnimals(); } catch (e) { /* ignore */ }
            try { fetchAllSpecies(); } catch (e) { /* ignore */ }
            try { fetchAllAnimals(); } catch (e) { /* ignore */ }
        };
        window.addEventListener('animals-changed', handleAnimalsChanged);
        return () => window.removeEventListener('animals-changed', handleAnimalsChanged);
    }, [fetchAnimals, fetchAllSpecies, fetchAllAnimals]);

    // Patch a single updated animal in-place without reloading the full list
    useEffect(() => {
        const handleAnimalUpdated = (e) => {
            const updated = e.detail;
            if (!updated?.id_public) return;
            setAnimals(prev => prev.map(a => a.id_public === updated.id_public ? { ...a, ...updated } : a));
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === updated.id_public ? { ...a, ...updated } : a));
        };
        window.addEventListener('animal-updated', handleAnimalUpdated);
        return () => window.removeEventListener('animal-updated', handleAnimalUpdated);
    }, []);

    useEffect(() => { fetchAllAnimals(); }, [fetchAllAnimals]);

    // Fetch the current user's activity log (lazy ? only when log screen opens)
    const fetchActivityLogs = useCallback(async (page = 1, filters = {}) => {
        if (!authToken) return;
        setLogsLoading(true);
        try {
            const params = new URLSearchParams({ page, limit: 30 });
            if (filters.targetType) params.set('targetType', filters.targetType);
            if (filters.action) params.set('action', filters.action);
            if (filters.search) params.set('search', filters.search);
            if (filters.startDate) params.set('startDate', filters.startDate);
            if (filters.endDate) params.set('endDate', filters.endDate);
            const res = await axios.get(`${API_BASE_URL}/activity-logs?${params}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            if (page === 1) {
                setActivityLogs(res.data.logs || []);
            } else {
                setActivityLogs(prev => [...prev, ...(res.data.logs || [])]);
            }
            setLogsPagination(res.data);
            setLogsLoaded(true);
        } catch (err) {
            console.error('[fetchActivityLogs]', err);
        } finally {
            setLogsLoading(false);
        }
    }, [authToken, API_BASE_URL]);

    // Auto-fetch logs when the activity log screen opens for the first time
    useEffect(() => {
        if (showActivityLogScreen && !logsLoaded && !logsLoading) {
            fetchActivityLogs(1, { targetType: 'management' });
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [showActivityLogScreen]);

    // Reset log screen when navigating away from management view
    useEffect(() => {
        if (animalView !== 'management') { setShowActivityLogScreen(false); setShowSuppliesScreen(false); setSupplyFormVisible(false); }
    }, [animalView]);

    // Fire-and-forget management activity logger (called from management handlers)
    const logManagementActivity = useCallback(async (action, targetId_public, details = {}) => {
        if (!authToken) return;
        try {
            await axios.post(`${API_BASE_URL}/activity-logs`,
                { action, targetId_public: targetId_public || null, details },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
        } catch (err) {
            // Non-critical ? don't surface logging failures to the user
        }
    }, [authToken, API_BASE_URL]);
    const fetchEnclosures = useCallback(async () => {
        try {
            const res = await axios.get(`${API_BASE_URL}/enclosures`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setEnclosures(res.data);
        } catch (err) { console.error('[fetchEnclosures]', err); }
    }, [authToken]);
    useEffect(() => { fetchEnclosures(); }, [fetchEnclosures]);

    const fetchSupplies = useCallback(async () => {
        if (!authToken) return;
        setSuppliesLoading(true);
        try {
            const res = await axios.get(`${API_BASE_URL}/supplies`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setSupplies(res.data || []);
        } catch (err) { console.error('[fetchSupplies]', err); }
        setSuppliesLoading(false);
    }, [authToken, API_BASE_URL]);
    useEffect(() => { fetchSupplies(); }, [fetchSupplies]);

    // Fetch user's custom species order on mount
    useEffect(() => {
        const fetchSpeciesOrder = async () => {
            try {
                const response = await axios.get(`${API_BASE_URL}/users/species-order`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                if (response.data && Array.isArray(response.data.speciesOrder)) {
                    setUserSpeciesOrder(response.data.speciesOrder);
                }
            } catch (error) {
                console.error('[SPECIES ORDER] Error fetching:', error);
            }
        };
        if (authToken) {
            fetchSpeciesOrder();
        }
    }, [authToken, API_BASE_URL]);

    const groupedAnimals = useMemo(() => {
        return animals.reduce((groups, animal) => {
            const species = animal.species || 'Unspecified Species';
            if (!groups[species]) {
                groups[species] = [];
            }
            groups[species].push(animal);
            return groups;
        }, {});
    }, [animals]);
    
    const speciesNames = useMemo(() => {
        return [...allUserSpecies].sort((a, b) => {
            // Use user's custom order if available
            if (userSpeciesOrder.length > 0) {
                const aIndex = userSpeciesOrder.indexOf(a);
                const bIndex = userSpeciesOrder.indexOf(b);
                
                // Both are in user's custom order
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                // Only a is in custom order, it comes first
                if (aIndex !== -1) return -1;
                // Only b is in custom order, it comes first
                if (bIndex !== -1) return 1;
                // Neither in custom order, use alphabetical
                return a.localeCompare(b);
            }
            
            // Fallback to default order (Mouse, Rat, Hamster, then alphabetical)
            const order = ['Mouse', 'Rat', 'Hamster'];
            const aIndex = order.indexOf(a);
            const bIndex = order.indexOf(b);
            
            if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
            if (aIndex !== -1) return -1;
            if (bIndex !== -1) return 1;
            return a.localeCompare(b);
        });
    }, [allUserSpecies, userSpeciesOrder]);

    // Initialize species filter to "All" on first load only
    // Also add any new species that appear (e.g., after creating a new animal)
    // Keep selectedSpecies in sync with allUserSpecies (the unfiltered master list)
    useEffect(() => {
        if (allUserSpecies.length === 0) return;
        if (selectedSpecies.length === 0) {
            // First load: select everything
            setSelectedSpecies([...allUserSpecies]);
        } else {
            // Add any newly-seen species so they aren't silently hidden
            const newSpecies = allUserSpecies.filter(s => !selectedSpecies.includes(s));
            if (newSpecies.length > 0) {
                setSelectedSpecies(prev => [...prev, ...newSpecies]);
            }
        }
    }, [allUserSpecies]); // eslint-disable-line react-hooks/exhaustive-deps

    const handleStatusFilterChange = (e) => setStatusFilter(e.target.value);
    const handleSearchInputChange = (e) => setSearchInput(e.target.value);
    const toggleGender = (gender) => {
        setSelectedGenders(prev => 
            prev.includes(gender) 
                ? prev.filter(g => g !== gender) 
                : [...prev, gender]
        );
    };
    const toggleSpecies = (species) => {
        setSelectedSpecies(prev => 
            prev.includes(species)
                ? prev.filter(s => s !== species)
                : [...prev, species]
        );
    };
    const handleFilterPregnant = () => { setStatusFilterPregnant(prev => !prev); setStatusFilterNursing(false); setStatusFilterMating(false); };
    const handleFilterNursing = () => { setStatusFilterNursing(prev => !prev); setStatusFilterPregnant(false); setStatusFilterMating(false); };
    const handleFilterMating = () => { setStatusFilterMating(prev => !prev); setStatusFilterPregnant(false); setStatusFilterNursing(false); };
    
    // Check if any filters are active (different from defaults)
    const hasActiveFilters = (
        statusFilter !== '' ||
        appliedNameFilter !== '' ||
        searchInput !== '' ||
        selectedGenders.length !== 4 ||
        !speciesNames.every(species => selectedSpecies.includes(species)) ||
        statusFilterPregnant ||
        statusFilterNursing ||
        statusFilterMating ||
        !ownedFilterActive ||
        publicFilter !== ''
    );
    
    const handleClearFilters = () => {
        setStatusFilter('');
        setSearchInput('');
        setAppliedNameFilter('');
        setSelectedGenders(['Male', 'Female', 'Intersex', 'Unknown']);
        setSelectedSpecies([...speciesNames]);
        setStatusFilterPregnant(false);
        setStatusFilterNursing(false);
        setStatusFilterMating(false);
        setOwnedFilterActive(true);
        setPublicFilter('');
    };
    
    const handleRefresh = async () => {
        try {
            setLoading(true);
            
            // Fetch animals first
            const currentAnimals = await axios.get(`${API_BASE_URL}/animals`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            // Recalculate COI for all animals with parents
            for (const animal of currentAnimals.data) {
                if (animal.fatherId_public || animal.motherId_public || animal.sireId_public || animal.damId_public) {
                    try {
                        await axios.get(`${API_BASE_URL}/animals/${animal.id_public}/inbreeding`, {
                            params: { generations: 50 },
                            headers: { Authorization: `Bearer ${authToken}` }
                        });
                    } catch (error) {
                        console.log(`Failed to calculate COI for ${animal.name}:`, error);
                    }
                }
            }

            // Refresh the list with updated COI values
            await fetchAnimals();
        } catch (error) {
            console.error('Error refreshing:', error);
        } finally {
            setLoading(false);
        }
    };

    const triggerSearch = () => {
        const term = searchInput.trim();
        if (!term) {
            // empty -> clear filter and fetch all
            setAppliedNameFilter('');
            return;
        }
        if (term.length < 3) {
            showModalMessage('Search Info', 'Please enter at least 3 characters to search.');
            return;
        }
        setAppliedNameFilter(term);
    };

    const toggleBulkDeleteMode = (species) => {
        setBulkDeleteMode(prev => ({ ...prev, [species]: !prev[species] }));
        setSelectedAnimals(prev => ({ ...prev, [species]: [] }));
    };

    const toggleAnimalSelection = (species, animalId) => {
        setSelectedAnimals(prev => {
            const current = prev[species] || [];
            const updated = current.includes(animalId)
                ? current.filter(id => id !== animalId)
                : [...current, animalId];
            return { ...prev, [species]: updated };
        });
    };

    const toggleAnimalPrivacy = async (animalId, newPrivacyValue) => {
        // Update local state immediately for instant UI feedback
        const updatedAnimals = animals.map(animal => 
            animal.id_public === animalId 
                ? { ...animal, showOnPublicProfile: newPrivacyValue, isDisplay: newPrivacyValue }
                : animal
        );
        setAnimals(updatedAnimals);

        // Update database in the background
        try {
            const response = await fetch(`${API_BASE_URL}/animals/${animalId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ 
                    showOnPublicProfile: newPrivacyValue,
                    isDisplay: newPrivacyValue 
                })
            });

            if (!response.ok) {
                // Revert on failure
                const revertedAnimals = animals.map(animal => 
                    animal.id_public === animalId 
                        ? { ...animal, showOnPublicProfile: !newPrivacyValue, isDisplay: !newPrivacyValue }
                        : animal
                );
                setAnimals(revertedAnimals);
                showModalMessage('Error', 'Failed to update privacy setting.');
            }
        } catch (error) {
            console.error('Error updating privacy:', error);
            // Revert on error
            const revertedAnimals = animals.map(animal => 
                animal.id_public === animalId 
                    ? { ...animal, showOnPublicProfile: !newPrivacyValue, isDisplay: !newPrivacyValue }
                    : animal
            );
            setAnimals(revertedAnimals);
            showModalMessage('Error', 'Failed to update privacy setting.');
        }
    };

    const toggleAnimalOwned = async (animalId, newOwnedValue) => {
        // Update local state immediately for instant UI feedback
        const updatedAnimals = animals.map(animal => 
            animal.id_public === animalId 
                ? { ...animal, isOwned: newOwnedValue }
                : animal
        );
        setAnimals(updatedAnimals);

        // Update database in the background
        try {
            const response = await fetch(`${API_BASE_URL}/animals/${animalId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ 
                    isOwned: newOwnedValue
                })
            });

            if (!response.ok) {
                // Revert on failure
                const revertedAnimals = animals.map(animal => 
                    animal.id_public === animalId 
                        ? { ...animal, isOwned: !newOwnedValue }
                        : animal
                );
                setAnimals(revertedAnimals);
                showModalMessage('Error', 'Failed to update owned status.');
            }
        } catch (error) {
            console.error('Error updating owned status:', error);
            // Revert on error
            const revertedAnimals = animals.map(animal => 
                animal.id_public === animalId 
                    ? { ...animal, isOwned: !newOwnedValue }
                    : animal
            );
            setAnimals(revertedAnimals);
            showModalMessage('Error', 'Failed to update owned status.');
        }
    };

    const moveSpecies = async (species, direction) => {
        const currentIndex = speciesNames.indexOf(species);
        if (currentIndex === -1) return;

        const newOrder = [...speciesNames];
        const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;

        // Check bounds
        if (newIndex < 0 || newIndex >= newOrder.length) return;

        // Swap
        [newOrder[newIndex], newOrder[currentIndex]] = [newOrder[currentIndex], newOrder[newIndex]];

        // Update local state immediately
        setUserSpeciesOrder(newOrder);

        // Save to backend
        try {
            await axios.post(`${API_BASE_URL}/users/species-order`, 
                { speciesOrder: newOrder },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
        } catch (error) {
            console.error('[SPECIES ORDER] Error saving:', error);
            showModalMessage('Error', 'Failed to save species order.');
        }
    };

    const toggleBulkPrivacy = async (species, makePublic) => {
        const speciesAnimals = groupedAnimals[species] || [];
        const animalIds = speciesAnimals.map(animal => animal.id_public);
        
        if (animalIds.length === 0) {
            showModalMessage('No Animals', 'No animals found for this species.');
            return;
        }

        const action = makePublic ? 'public' : 'private';
        const confirmChange = window.confirm(`Are you sure you want to make all ${animalIds.length} ${getSpeciesDisplayName(species)} animals ${action}?`);
        if (!confirmChange) return;

        // Update local state immediately for instant UI feedback
        const updatedAnimals = animals.map(animal => 
            animalIds.includes(animal.id_public) 
                ? { ...animal, showOnPublicProfile: makePublic, isDisplay: makePublic }
                : animal
        );
        setAnimals(updatedAnimals);

        // Update database in the background
        let failedUpdates = 0;
        for (const animalId of animalIds) {
            try {
                await fetch(`${API_BASE_URL}/animals/${animalId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        showOnPublicProfile: makePublic,
                        isDisplay: makePublic 
                    })
                });
            } catch (error) {
                console.error(`Error updating animal ${animalId}:`, error);
                failedUpdates++;
            }
        }

        // Show notification if there were failures
        if (failedUpdates > 0) {
            showModalMessage('Partial Success', `Updated locally, but ${failedUpdates} animal(s) failed to sync with the server. They will be updated on next refresh.`);
        }
    };

    const toggleAllAnimalsPrivacy = async (makePublic) => {
        if (animals.length === 0) {
            showModalMessage('No Animals', 'No animals found.');
            return;
        }

        const action = makePublic ? 'public' : 'private';
        const confirmChange = window.confirm(`Are you sure you want to make ALL ${animals.length} animals ${action}?`);
        if (!confirmChange) return;

        // Update local state immediately for instant UI feedback
        const updatedAnimals = animals.map(animal => ({
            ...animal,
            showOnPublicProfile: makePublic,
            isDisplay: makePublic
        }));
        setAnimals(updatedAnimals);

        // Update database in the background
        let failedUpdates = 0;
        for (const animal of animals) {
            try {
                await fetch(`${API_BASE_URL}/animals/${animal.id_public}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        showOnPublicProfile: makePublic,
                        isDisplay: makePublic 
                    })
                });
            } catch (error) {
                console.error(`Error updating animal ${animal.id_public}:`, error);
                failedUpdates++;
            }
        }

        // Show notification if there were failures
        if (failedUpdates > 0) {
            showModalMessage('Partial Success', `Updated locally, but ${failedUpdates} animal(s) failed to sync with the server. They will be updated on next refresh.`);
        }
    };

    const handleBulkDelete = async (species) => {
        const selectedIds = selectedAnimals[species] || [];
        if (selectedIds.length === 0) {
            showModalMessage('No Selection', 'Please select at least one animal to delete.');
            return;
        }

        const confirmDelete = window.confirm(`Are you sure you want to delete ${selectedIds.length} animal(s)? This action cannot be undone.`);
        if (!confirmDelete) return;

        try {
            setLoading(true);
            for (const id of selectedIds) {
                await axios.delete(`${API_BASE_URL}/animals/${id}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
            }
            showModalMessage('Success', `Successfully deleted ${selectedIds.length} animal(s).`);
            setBulkDeleteMode(prev => ({ ...prev, [species]: false }));
            setSelectedAnimals(prev => ({ ...prev, [species]: [] }));
            await fetchAnimals();
        } catch (error) {
            console.error('Error deleting animals:', error);
            showModalMessage('Error', 'Failed to delete some animals. Please try again.');
        } finally {
            setLoading(false);
        }
    };

    const AnimalCard = ({ animal, onEditAnimal, species, isSelectable, isSelected, onToggleSelect, onTogglePrivacy, onToggleOwned }) => {
        const birth = animal.birthDate ? formatDate(animal.birthDate) : '';
        const imgSrc = animal.imageUrl || animal.photoUrl || null;

        const handleClick = () => {
            if (isSelectable) {
                onToggleSelect(species, animal.id_public);
            } else {
                onViewAnimal(animal);
            }
        };

        return (
            <div className="w-full flex justify-center">
                <div
                    onClick={handleClick}
                    className={`relative bg-white rounded-lg sm:rounded-xl shadow-sm w-full max-w-[165px] sm:max-w-[140px] md:max-w-[176px] h-44 sm:h-48 md:h-56 flex flex-col items-center overflow-hidden cursor-pointer hover:shadow-md transition border-2 pt-2 sm:pt-3 ${
                        isSelected ? 'border-red-500' : animal.isViewOnly ? 'border-gray-400 bg-gray-50' : 'border-gray-300'
                    }`}
                >
                    {isSelectable && (
                        <div className="absolute top-2 left-2 z-10" onClick={(e) => e.stopPropagation()}>
                            <input
                                type="checkbox"
                                checked={isSelected}
                                onChange={() => onToggleSelect(species, animal.id_public)}
                                className="w-5 h-5 cursor-pointer"
                            />
                        </div>
                    )}
                    {/* Transfer icon top-left */}
                    {(animal.soldStatus || animal.isViewOnly) && !isSelectable && (
                        <div className="absolute top-1 sm:top-2 left-1 sm:left-2 text-black" title="Transferred Animal">
                            <ArrowLeftRight className="w-3 h-3 sm:w-3.5 sm:h-3.5" strokeWidth={2.5} />
                        </div>
                    )}

                    {/* Birthdate center-top - only show if not in selection mode */}
                    {birth && !isSelectable && (
                        <div className="absolute top-1 sm:top-2 left-1/2 transform -translate-x-1/2 text-[10px] sm:text-xs text-gray-600 bg-white/80 px-1 sm:px-2 py-0.5 rounded">
                            {birth}
                        </div>
                    )}

                    {/* Gender badge top-right */}
                    {animal.gender && (
                        <div className={`absolute top-1 sm:top-2 right-1 sm:right-2`} title={animal.gender}>
                            {animal.gender === 'Male' ? <Mars className="w-3 h-3 sm:w-4 sm:h-4" strokeWidth={2.5} style={{color: 'var(--color-primary, #9ED4E0)'}} /> : animal.gender === 'Female' ? <Venus className="w-3 h-3 sm:w-4 sm:h-4" strokeWidth={2.5} style={{color: 'var(--color-accent, #D27096)'}} /> : animal.gender === 'Intersex' ? <VenusAndMars className="w-3 h-3 sm:w-4 sm:h-4 text-purple-500" strokeWidth={2.5} /> : <Circle className="w-3 h-3 sm:w-4 sm:h-4 text-gray-500" strokeWidth={2.5} />}
                        </div>
                    )}

                    {/* Centered profile image */}
                    <div className="flex items-center justify-center w-full px-1 sm:px-2 mt-0.5 sm:mt-1 h-20 sm:h-20 md:h-28">
                        {imgSrc ? (
                            <img src={imgSrc} alt={animal.name} className="max-w-20 max-h-20 sm:max-w-20 sm:max-h-20 md:max-w-24 md:max-h-24 w-auto h-auto object-contain rounded-md" />
                        ) : (
                            <div className="w-20 h-20 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                <Cat className="w-8 h-8 sm:w-8 sm:h-8 md:w-9 md:h-9" />
                            </div>
                        )}
                    </div>
                    
                    {/* Icon row */}
                    <div className="w-full flex justify-center items-center space-x-1 sm:space-x-2 py-0.5 sm:py-1">
                        {animal.isInMating && <Hourglass className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-black" />}
                        {animal.isPregnant && <Bean className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-black" />}
                        {animal.isNursing && <Milk className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-black" />}
                    </div>
                    
                    {/* Prefix / Name under image */}
                    <div className="w-full text-center px-1 sm:px-2 pb-0.5 sm:pb-1 flex-grow">
                        <div className="text-[11px] sm:text-xs md:text-sm font-semibold text-gray-800 line-clamp-2 leading-tight">{animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}</div>
                    </div>

                    {/* Edit is available when viewing full card; remove inline edit icon from dashboard cards */}

                    {/* ID bottom-right */}
                    <div className="w-full px-1 sm:px-2 pb-1 sm:pb-2 flex justify-between items-center mt-auto">
                        {/* Privacy and Owned toggles bottom-left */}
                        {!isSelectable && (
                            <div className="flex items-center gap-1">
                                {/* Owned toggle */}
                                <button
                                    type="button"
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        onToggleOwned && onToggleOwned(animal.id_public, !animal.isOwned);
                                    }}
                                    className={`p-0.5 sm:p-1 rounded transition-colors ${
                                        animal.isOwned 
                                            ? 'bg-red-100 hover:bg-red-200' 
                                            : 'bg-gray-100 hover:bg-gray-200'
                                    }`}
                                    title={animal.isOwned ? "Click to mark as Not Owned" : "Click to mark as Owned"}
                                >
                                    {animal.isOwned ? (
                                        <Heart className="w-3 h-3 sm:w-4 sm:h-4 text-red-600" />
                                    ) : (
                                        <HeartOff className="w-3 h-3 sm:w-4 sm:h-4 text-gray-500" />
                                    )}
                                </button>
                                {/* Privacy toggle */}
                                <button
                                    type="button"
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        onTogglePrivacy && onTogglePrivacy(animal.id_public, !animal.showOnPublicProfile);
                                    }}
                                    className={`p-0.5 sm:p-1 rounded transition-colors ${
                                        animal.showOnPublicProfile 
                                            ? 'bg-green-100 hover:bg-green-200' 
                                            : 'bg-gray-100 hover:bg-gray-200'
                                    }`}
                                    title={animal.showOnPublicProfile ? "Click to make Private" : "Click to make Public"}
                                >
                                    {animal.showOnPublicProfile ? (
                                        <Eye className="w-3 h-3 sm:w-4 sm:h-4 text-green-600" />
                                    ) : (
                                        <EyeOff className="w-3 h-3 sm:w-4 sm:h-4 text-gray-500" />
                                    )}
                                </button>
                            </div>
                        )}
                        {/* Spacer if no toggles (in selection mode) */}
                        {isSelectable && <div></div>}
                        <div className="text-[9px] sm:text-[10px] md:text-xs text-gray-500">{animal.id_public}</div>
                    </div>
                    
                    {/* Status bar at bottom */}
                    <div className={`w-full py-0.5 sm:py-1 text-center border-t border-gray-300 mt-auto ${
                        animal.isViewOnly ? 'bg-orange-100' : 'bg-gray-100'
                    }`}>
                        <div className={`text-[10px] sm:text-xs font-medium ${
                            animal.isViewOnly ? 'text-orange-800' : 'text-gray-700'
                        }`}>{animal.isViewOnly ? 'Sold' : (animal.status || 'Unknown')}</div>
                    </div>
                </div>
            </div>
        );
    };

    // -- Activity log helpers -----------------------------------------------------
    const getActionColor = (action) => {
        if (!action) return 'bg-gray-300';
        if (action.includes('delete') || action.includes('failed')) return 'bg-red-400';
        if (action === 'animal_fed') return 'bg-green-400';
        if (action === 'reproduction_update') return 'bg-pink-400';
        if (action.includes('task_done')) return 'bg-amber-400';
        if (action.includes('assign') || action.includes('transfer')) return 'bg-purple-400';
        if (action.includes('create') || action.includes('login')) return 'bg-green-400';
        if (action.includes('update') || action.includes('change') || action.includes('upload')) return 'bg-blue-400';
        if (action.includes('visibility')) return 'bg-yellow-400';
        return 'bg-gray-400';
    };

    const getActionLabel = (action) => {
        const labels = {
            login: 'Logged in',
            logout: 'Logged out',
            password_change: 'Changed password',
            profile_update: 'Updated profile',
            profile_image_change: 'Changed profile image',
            privacy_settings_change: 'Changed privacy settings',
            animal_create: 'Added animal',
            animal_update: 'Updated animal',
            animal_delete: 'Deleted animal',
            animal_image_upload: 'Uploaded animal image',
            animal_image_delete: 'Deleted animal image',
            animal_visibility_change: 'Changed animal visibility',
            animal_transfer_initiate: 'Initiated animal transfer',
            animal_transfer_accept: 'Accepted animal transfer',
            animal_transfer_reject: 'Rejected animal transfer',
            litter_create: 'Created litter',
            litter_update: 'Updated litter',
            litter_delete: 'Deleted litter',
            message_send: 'Sent message',
            message_delete: 'Deleted message',
            report_submit: 'Submitted report',
            transaction_create: 'Created transaction',
            transaction_delete: 'Deleted transaction',
            // Management panel
            enclosure_create: 'Created enclosure',
            enclosure_update: 'Updated enclosure',
            enclosure_delete: 'Deleted enclosure',
            enclosure_assign: 'Assigned to enclosure',
            enclosure_unassign: 'Removed from enclosure',
            animal_fed: 'Marked as fed',
            care_task_done: 'Care task completed',
            enclosure_task_done: 'Cleaning task completed',
            reproduction_update: 'Reproductive status updated',
        };
        if (!action) return 'Unknown action';
        const key = action.replace(/_failed$/, '');
        const base = labels[key] || action.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        return action.endsWith('_failed') ? `${base} (failed)` : base;
    };

    const formatTimeAgo = (dateStr) => {
        if (!dateStr) return '';
        const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
        if (diff < 60) return `${diff}s ago`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
        return formatDateDisplay(dateStr);
    };

    // -- Activity Log Screen ------------------------------------------------------
    const renderActivityLogScreen = () => {
        const ACTION_OPTIONS = [
            { value: '', label: 'All Management Actions' },
            { value: 'enclosure_create', label: 'Created Enclosure' },
            { value: 'enclosure_update', label: 'Updated Enclosure' },
            { value: 'enclosure_delete', label: 'Deleted Enclosure' },
            { value: 'enclosure_assign', label: 'Assigned to Enclosure' },
            { value: 'enclosure_unassign', label: 'Removed from Enclosure' },
            { value: 'animal_fed', label: 'Marked as Fed' },
            { value: 'care_task_done', label: 'Care Task Completed' },
            { value: 'enclosure_task_done', label: 'Cleaning Task Completed' },
            { value: 'reproduction_update', label: 'Reproductive Status Updated' },
        ];

        // targetType: 'management' is always included to scope logs to management panel only
        const currentFilters = { targetType: 'management', action: logFilterAction, search: logFilterSearch, startDate: logFilterStartDate, endDate: logFilterEndDate };

        const handleApplyFilters = () => {
            setActivityLogs([]);
            setLogsLoaded(false);
            fetchActivityLogs(1, currentFilters);
        };

        const handleResetFilters = () => {
            setLogFilterAction('');
            setLogFilterSearch('');
            setLogFilterStartDate('');
            setLogFilterEndDate('');
            setActivityLogs([]);
            setLogsLoaded(false);
            fetchActivityLogs(1, { targetType: 'management' });
        };

        return (
            <div className="mt-4 space-y-4">
                {/* Back + Refresh row */}
                <div className="flex items-center justify-between">
                    <button
                        onClick={() => setShowActivityLogScreen(false)}
                        className="flex items-center gap-1.5 text-sm text-gray-600 hover:text-gray-800 transition"
                    >
                        <ChevronLeft size={16} />
                        Back to Management
                    </button>
                    <button
                        onClick={() => { setLogsLoaded(false); fetchActivityLogs(1, currentFilters); }}
                        disabled={logsLoading}
                        className="flex items-center gap-1 text-xs text-gray-400 hover:text-gray-600 transition disabled:opacity-50"
                    >
                        <RefreshCw size={12} />
                        Refresh
                    </button>
                </div>

                {/* Title + total */}
                <div className="flex items-center gap-2">
                    <ScrollText size={18} className="text-indigo-600" />
                    <h3 className="text-lg font-semibold text-gray-800">Activity Log</h3>
                    <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">{logsPagination.total || 0} entries</span>
                </div>

                {/* Filter bar */}
                <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-3 space-y-2">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Action Type</label>
                            <select
                                value={logFilterAction}
                                onChange={e => setLogFilterAction(e.target.value)}
                                className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-indigo-400 focus:border-indigo-400"
                            >
                                {ACTION_OPTIONS.map(opt => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">Search (animal name / ID)</label>
                            <input
                                type="text"
                                value={logFilterSearch}
                                onChange={e => setLogFilterSearch(e.target.value)}
                                onKeyPress={e => { if (e.key === 'Enter') handleApplyFilters(); }}
                                placeholder="e.g. Pixie or CT-00123"
                                className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-indigo-400 focus:border-indigo-400"
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">From Date</label>
                            <input
                                type="date"
                                value={logFilterStartDate}
                                onChange={e => setLogFilterStartDate(e.target.value)}
                                className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-indigo-400 focus:border-indigo-400"
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-medium text-gray-600 mb-1">To Date</label>
                            <input
                                type="date"
                                value={logFilterEndDate}
                                onChange={e => setLogFilterEndDate(e.target.value)}
                                className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-indigo-400 focus:border-indigo-400"
                            />
                        </div>
                    </div>
                    <div className="flex gap-2 justify-end">
                        <button
                            onClick={handleResetFilters}
                            className="text-xs px-3 py-1.5 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50"
                        >
                            Reset
                        </button>
                        <button
                            onClick={handleApplyFilters}
                            disabled={logsLoading}
                            className="text-xs px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium disabled:opacity-50"
                        >
                            {logsLoading ? 'Loading...' : 'Apply Filters'}
                        </button>
                    </div>
                </div>

                {/* Log entries */}
                <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    {logsLoading && activityLogs.length === 0 ? (
                        <div className="flex items-center justify-center py-10 text-gray-400 gap-2">
                            <Loader2 size={18} className="animate-spin" />
                            <span className="text-sm">Loading activity log...</span>
                        </div>
                    ) : activityLogs.length === 0 ? (
                        <div className="text-sm text-gray-400 text-center py-10">No activity found for the selected filters.</div>
                    ) : (
                        <div className="divide-y divide-gray-100">
                            {activityLogs.map((log) => (
                                <div key={log._id} className="flex items-start gap-3 px-4 py-3 hover:bg-gray-50">
                                    <span className={`mt-1.5 w-2.5 h-2.5 rounded-full flex-shrink-0 ${getActionColor(log.action)}`} />
                                    <div className="flex-1 min-w-0">
                                        <div className="text-sm text-gray-800 font-medium">
                                            {getActionLabel(log.action)}
                                            {(log.details?.name || log.details?.enclosureName) && <span className="text-gray-500 font-normal"> → <span className="font-medium text-gray-700">{log.details.name || log.details.enclosureName}</span></span>}
                                            {log.details?.species && !log.details?.name && <span className="text-gray-500 font-normal"> ({log.details.species})</span>}
                                            {log.details?.status && <span className="text-indigo-500 font-normal text-xs ml-1">({log.details.status})</span>}
                                        </div>
                                        {log.targetId_public && (
                                            <div className="text-xs text-gray-400 mt-0.5">{log.targetId_public}</div>
                                        )}
                                        {log.details && Object.keys(log.details).filter(k => !['name', 'species', 'status', 'enclosureName'].includes(k)).length > 0 && (
                                            <div className="text-xs text-gray-400 mt-0.5">
                                                {Object.entries(log.details)
                                                    .filter(([k]) => !['name', 'species', 'status', 'enclosureName'].includes(k))
                                                    .slice(0, 3)
                                                    .map(([k, v]) => `${k}: ${v}`)
                                                    .join(' � ')
                                                }
                                            </div>
                                        )}
                                    </div>
                                    <div className="text-xs text-gray-400 flex-shrink-0 text-right ml-2">
                                        <div className="font-medium">{formatTimeAgo(log.createdAt)}</div>
                                        <div className="text-gray-300">{log.createdAt ? new Date(log.createdAt).toLocaleDateString() : ''}</div>
                                        {log.success === false && <div className="text-red-400 font-medium mt-0.5">failed</div>}
                                    </div>
                                </div>
                            ))}
                            {logsPagination.page < logsPagination.totalPages && (
                                <div className="p-3">
                                    <button
                                        onClick={() => fetchActivityLogs(logsPagination.page + 1, currentFilters)}
                                        disabled={logsLoading}
                                        className="w-full py-2 text-xs text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-lg transition flex items-center justify-center gap-1 disabled:opacity-50"
                                    >
                                        {logsLoading ? <><Loader2 size={12} className="animate-spin" /> Loading...</> : `Load more (${activityLogs.length} of ${logsPagination.total})`}
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // -- Supplies & Inventory Screen ---------------------------------------------
    const renderSuppliesScreen = () => {
        const CATEGORIES = ['Food', 'Bedding', 'Medication', 'Other'];
        const CATEGORY_COLORS = {
            Food: 'bg-green-100 text-green-700',
            Bedding: 'bg-yellow-100 text-yellow-700',
            Medication: 'bg-red-100 text-red-700',
            Other: 'bg-gray-100 text-gray-600',
        };
        // Map supply category ? budget expense category
        const BUDGET_CATEGORY_MAP = { Food: 'food', Bedding: 'housing', Medication: 'medical', Other: 'other' };
        const isLow = (item) => item.reorderThreshold != null && item.currentStock <= item.reorderThreshold;
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const isOverdue = (item) => item.nextOrderDate && new Date(item.nextOrderDate) < today;
        const isDueSoon = (item) => { if (!item.nextOrderDate) return false; const d = new Date(item.nextOrderDate); const diff = (d - today) / (1000 * 60 * 60 * 24); return diff >= 0 && diff <= 14; };
        const needsAttention = (item) => isLow(item) || isOverdue(item);
        const filtered = supplyCategoryFilter === 'All' ? supplies : supplies.filter(s => s.category === supplyCategoryFilter);
        const lowStockItems = supplies.filter(isLow);
        const overdueItems = supplies.filter(isOverdue);
        const attentionItems = supplies.filter(needsAttention);

        const handleSupplySubmit = async () => {
            if (!supplyForm.name.trim()) return;
            setSupplySaving(true);
            try {
                if (editingSupplyId) {
                    const res = await axios.patch(`${API_BASE_URL}/supplies/${editingSupplyId}`, supplyForm, { headers: { Authorization: `Bearer ${authToken}` } });
                    setSupplies(prev => prev.map(s => s._id === editingSupplyId ? res.data : s));
                } else {
                    const res = await axios.post(`${API_BASE_URL}/supplies`, supplyForm, { headers: { Authorization: `Bearer ${authToken}` } });
                    setSupplies(prev => [...prev, res.data]);
                }
                setSupplyForm({ name: '', category: 'Other', currentStock: '', unit: '', reorderThreshold: '', notes: '', isFeederAnimal: false, feederType: '', feederSize: '', costPerUnit: '', nextOrderDate: '', orderFrequency: '', orderFrequencyUnit: 'months' });
                setSupplyFormVisible(false);
                setEditingSupplyId(null);
            } catch (err) { console.error(err); }
            setSupplySaving(false);
        };

        const handleSupplyDelete = async (id) => {
            if (!window.confirm('Delete this supply item?')) return;
            try {
                await axios.delete(`${API_BASE_URL}/supplies/${id}`, { headers: { Authorization: `Bearer ${authToken}` } });
                setSupplies(prev => prev.filter(s => s._id !== id));
            } catch (err) { console.error(err); }
        };

        const handleSupplyEdit = (item) => {
            setSupplyForm({
                name: item.name,
                category: item.category,
                currentStock: item.currentStock ?? '',
                unit: item.unit || '',
                reorderThreshold: item.reorderThreshold ?? '',
                notes: item.notes || '',
                isFeederAnimal: item.isFeederAnimal || false,
                feederType: item.feederType || '',
                feederSize: item.feederSize || '',
                costPerUnit: item.costPerUnit ?? '',
                nextOrderDate: item.nextOrderDate ? new Date(item.nextOrderDate).toISOString().split('T')[0] : '',
                orderFrequency: item.orderFrequency ?? '',
                orderFrequencyUnit: item.orderFrequencyUnit || 'months',
            });
            setEditingSupplyId(item._id);
            setSupplyFormVisible(true);
        };

        const openRestock = (item) => {
            setRestockingSupplyId(item._id);
            // Auto-suggest cost from costPerUnit if it's a feeder animal
            const suggestCost = item.isFeederAnimal && item.costPerUnit ? '' : '';
            setRestockForm({ qty: '', cost: suggestCost, date: new Date().toISOString().slice(0, 10), notes: '' });
            setSupplyFormVisible(false);
            setEditingSupplyId(null);
        };

                        const handleRestockSubmit = async (item) => {
            const qty = parseFloat(restockForm.qty);
            const cost = parseFloat(restockForm.cost);
            if (!qty || qty <= 0 || !restockForm.cost || cost < 0) return;
            setRestockSaving(true);
            try {
                // 1. Update supply stock (and advance next order date if a schedule is set)
                const newStock = (item.currentStock || 0) + qty;
                const stockPatch = { currentStock: newStock };
                if (item.orderFrequency && item.orderFrequencyUnit) {
                    const base = new Date();
                    if (item.orderFrequencyUnit === 'days') base.setDate(base.getDate() + Number(item.orderFrequency));
                    else if (item.orderFrequencyUnit === 'weeks') base.setDate(base.getDate() + Number(item.orderFrequency) * 7);
                    else if (item.orderFrequencyUnit === 'months') base.setMonth(base.getMonth() + Number(item.orderFrequency));
                    stockPatch.nextOrderDate = base.toISOString().split('T')[0];
                }
                const supplyRes = await axios.patch(
                    `${API_BASE_URL}/supplies/${item._id}`,
                    stockPatch,
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );
                setSupplies(prev => prev.map(s => s._id === item._id ? supplyRes.data : s));

                // 2. Log budget expense
                const feederLabel = item.isFeederAnimal && (item.feederType || item.feederSize)
                    ? ` � ${[item.feederType, item.feederSize].filter(Boolean).join(' ')}`
                    : '';
                await axios.post(
                    `${API_BASE_URL}/budget/transactions`,
                    {
                        type: 'expense',
                        price: cost,
                        date: restockForm.date || new Date().toISOString().slice(0, 10),
                        category: BUDGET_CATEGORY_MAP[item.category] || 'other',
                        description: `Supplies restock: ${item.name}${feederLabel} (�${qty}${item.unit ? ' ' + item.unit : ''})`,

                        notes: restockForm.notes || null,
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );
                setRestockingSupplyId(null);
            } catch (err) { console.error(err); }
            setRestockSaving(false);
        };

        return (
            <div className="mt-4 space-y-4">
                {/* Back + Refresh */}
                <div className="flex items-center justify-between">
                    <button
                        onClick={() => { setShowSuppliesScreen(false); setSupplyFormVisible(false); setEditingSupplyId(null); }}
                        className="flex items-center gap-1.5 text-sm text-gray-600 hover:text-gray-800 transition"
                    >
                        <ChevronLeft size={16} />
                        Back to Management
                    </button>
                    <button onClick={fetchSupplies} disabled={suppliesLoading}
                        className="flex items-center gap-1 text-xs text-gray-400 hover:text-gray-600 transition disabled:opacity-50">
                        <RefreshCw size={12} /> Refresh
                    </button>
                </div>

                {/* Title + Add button */}
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <Package size={18} className="text-emerald-600" />
                        <h3 className="text-lg font-semibold text-gray-800">Supplies &amp; Inventory</h3>
                        <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full">{supplies.length} item{supplies.length !== 1 ? 's' : ''}</span>
                    </div>
                    <button
                        onClick={() => { setSupplyForm({ name: '', category: 'Other', currentStock: '', unit: '', reorderThreshold: '', notes: '', isFeederAnimal: false, feederType: '', feederSize: '', costPerUnit: '', nextOrderDate: '', orderFrequency: '', orderFrequencyUnit: 'months' }); setEditingSupplyId(null); setSupplyFormVisible(v => !v); }}
                        className="flex items-center gap-1 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded-lg font-medium transition"
                    >
                        <Plus size={14} /> Add Item
                    </button>
                </div>

                {/* Low stock alert */}
                {attentionItems.length > 0 && (
                    <div className="flex items-start gap-2 bg-amber-50 border border-amber-200 rounded-xl p-3">
                        <AlertTriangle size={16} className="text-amber-500 mt-0.5 shrink-0" />
                        <div className="text-sm text-amber-700 space-y-0.5">
                            {lowStockItems.length > 0 && <div><span className="font-semibold">Low stock:</span> {lowStockItems.map(i => i.name).join(', ')}</div>}
                            {overdueItems.length > 0 && <div><span className="font-semibold">Order overdue:</span> {overdueItems.map(i => i.name).join(', ')}</div>}
                        </div>
                    </div>
                )}

                {/* Add / Edit form */}
                {supplyFormVisible && (
                    <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 space-y-3">
                        <h4 className="text-sm font-semibold text-emerald-800">{editingSupplyId ? 'Edit Item' : 'New Supply Item'}</h4>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Name *</label>
                                <input type="text" value={supplyForm.name} onChange={e => setSupplyForm(f => ({ ...f, name: e.target.value }))} placeholder="e.g. Rat blocks" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400" />
                            </div>
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Category</label>
                                <select value={supplyForm.category} onChange={e => setSupplyForm(f => ({ ...f, category: e.target.value, isFeederAnimal: e.target.value === 'Food' ? f.isFeederAnimal : false }))} className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400">
                                    {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Current Stock</label>
                                <input type="number" min="0" value={supplyForm.currentStock} onChange={e => setSupplyForm(f => ({ ...f, currentStock: e.target.value }))} placeholder="0" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400" />
                            </div>
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Unit (e.g. bags, kg, boxes)</label>
                                <input type="text" value={supplyForm.unit} onChange={e => setSupplyForm(f => ({ ...f, unit: e.target.value }))} placeholder="bags" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400" />
                            </div>
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Cost per unit</label>
                                <input type="number" min="0" step="0.01" value={supplyForm.costPerUnit} onChange={e => setSupplyForm(f => ({ ...f, costPerUnit: e.target.value }))} placeholder="0.00" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400" />
                            </div>
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Reorder when stock reaches</label>
                                <input type="number" min="0" value={supplyForm.reorderThreshold} onChange={e => setSupplyForm(f => ({ ...f, reorderThreshold: e.target.value }))} placeholder="e.g. 2" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400" />
                            </div>
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Notes</label>
                                    <input type="text" value={supplyForm.notes} onChange={e => setSupplyForm(f => ({ ...f, notes: e.target.value }))} placeholder="Notes" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400" />
                            </div>
                        </div>
                        {/* Schedule-based reorder */}
                        <div className="border-t border-emerald-200 pt-3 space-y-2">
                            <p className="text-xs font-semibold text-gray-600">Reorder Schedule <span className="font-normal text-gray-400">(optional ? for bulk or timed items)</span></p>
                            <p className="text-[11px] text-gray-400">Set a date &amp; repeat frequency for items ordered on a schedule, regardless of stock count ? e.g. a 650 L bedding pallet every 3 months.</p>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <div>
                                    <label className="text-xs font-medium text-gray-600 mb-1 block">Next order date</label>
                                    <input type="date" value={supplyForm.nextOrderDate} onChange={e => setSupplyForm(f => ({ ...f, nextOrderDate: e.target.value }))} className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400" />
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-gray-600 mb-1 block">Repeat every</label>
                                    <input type="number" min="1" value={supplyForm.orderFrequency} onChange={e => setSupplyForm(f => ({ ...f, orderFrequency: e.target.value }))} placeholder="e.g. 3" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400" />
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-gray-600 mb-1 block">Frequency unit</label>
                                    <select value={supplyForm.orderFrequencyUnit} onChange={e => setSupplyForm(f => ({ ...f, orderFrequencyUnit: e.target.value }))} className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-1 focus:ring-emerald-400">
                                        <option value="days">Days</option>
                                        <option value="weeks">Weeks</option>
                                        <option value="months">Months</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        {/* Feeder animal toggle (Food only) */}
                        {supplyForm.category === 'Food' && (
                            <div className="col-span-2">
                                <label className="flex items-center gap-2 cursor-pointer select-none">
                                    <input type="checkbox" checked={supplyForm.isFeederAnimal} onChange={e => setSupplyForm(f => ({ ...f, isFeederAnimal: e.target.checked }))} className="w-4 h-4 accent-emerald-600" />
                                    <span className="text-sm font-medium text-gray-700">This is a feeder animal (mice, rats, crickets, etc.)</span>
                                </label>
                            </div>
                        )}
                        {supplyForm.category === 'Food' && supplyForm.isFeederAnimal && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 bg-green-50 border border-green-200 rounded-lg p-3">
                                <div>
                                    <label className="text-xs font-medium text-gray-600 mb-1 block">Feeder Type</label>
                                    <input type="text" value={supplyForm.feederType} onChange={e => setSupplyForm(f => ({ ...f, feederType: e.target.value }))} list="feeder-type-list" placeholder="e.g. Mice, Rats" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400" />
                                    <datalist id="feeder-type-list"><option value="Mice" /><option value="Rats" /><option value="Gerbils" /><option value="Crickets" /><option value="Dubia Roaches" /><option value="Mealworms" /><option value="Superworms" /><option value="Waxworms" /><option value="Hornworms" /><option value="Fish" /></datalist>
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-gray-600 mb-1 block">Size</label>
                                    <input type="text" value={supplyForm.feederSize} onChange={e => setSupplyForm(f => ({ ...f, feederSize: e.target.value }))} list="feeder-size-list" placeholder="e.g. Pinky, Adult" className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-emerald-400" />
                                    <datalist id="feeder-size-list"><option value="Pinky" /><option value="Fuzzy" /><option value="Hopper" /><option value="Weaned" /><option value="Adult" /><option value="Small" /><option value="Medium" /><option value="Large" /><option value="XL" /></datalist>
                                </div>
                            </div>
                        )}
                        <div className="flex gap-2 justify-end pt-1">
                            <button onClick={() => { setSupplyFormVisible(false); setEditingSupplyId(null); }} className="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition">Cancel</button>
                            <button onClick={handleSupplySubmit} disabled={supplySaving || !supplyForm.name.trim()} className="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded-lg font-medium transition disabled:opacity-50 flex items-center gap-1.5">
                                {supplySaving ? <Loader2 size={13} className="animate-spin" /> : <Save size={13} />}
                                {editingSupplyId ? 'Save Changes' : 'Add Item'}
                            </button>
                        </div>
                    </div>
                )}

                {/* Category filter pills */}
                <div className="flex gap-1.5 flex-wrap">
                    {['All', ...CATEGORIES].map(cat => (
                        <button key={cat} onClick={() => setSupplyCategoryFilter(cat)}
                            className={`px-3 py-1 text-xs rounded-full font-medium transition ${supplyCategoryFilter === cat ? 'bg-emerald-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                        >{cat}</button>
                    ))}
                </div>

                {/* Items grid */}
                {suppliesLoading ? (
                    <div className="flex items-center justify-center py-12 text-gray-400 gap-2"><Loader2 size={20} className="animate-spin" /> Loading...</div>
                ) : filtered.length === 0 ? (
                    <div className="text-center py-12 text-gray-400 text-sm">
                        {supplies.length === 0 ? 'No supplies added yet. Click "Add Item" to get started.' : `No ${supplyCategoryFilter} items.`}
                    </div>
                ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {filtered.map(item => (
                            <div key={item._id} className={`border rounded-xl p-3 bg-white flex flex-col gap-1.5 shadow-sm ${isLow(item) ? 'border-amber-300' : 'border-gray-200'}`}>
                                <div className="flex items-start justify-between gap-2">
                                    <div className="flex items-center gap-1.5 flex-wrap min-w-0">
                                        <span className="font-semibold text-sm text-gray-800 truncate">{item.name}</span>
                                        {isLow(item) && <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full font-medium shrink-0">Low Stock</span>}
                                        {isOverdue(item) && <span className="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded-full font-medium shrink-0">Order Due</span>}
                                        {!isOverdue(item) && isDueSoon(item) && <span className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full font-medium shrink-0">Order Soon</span>}
                                    </div>
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-medium shrink-0 ${CATEGORY_COLORS[item.category] || CATEGORY_COLORS.Other}`}>{item.category}</span>
                                </div>
                                <div className="flex items-baseline gap-2">
                                    <span className={`text-lg font-bold ${isLow(item) ? 'text-amber-600' : 'text-gray-800'}`}>{item.currentStock}</span>
                                    {item.unit && <span className="text-gray-500 text-xs">{item.unit}</span>}
                                    {item.reorderThreshold != null && <span className="text-gray-400 text-xs ml-auto">Reorder at {item.reorderThreshold}</span>}
                                </div>
                                {item.notes && <p className="text-xs text-gray-400 truncate">{item.notes}</p>}
                                {(item.isFeederAnimal || item.costPerUnit != null) && (
                                    <div className="flex flex-wrap gap-1.5 mt-0.5">
                                        {item.isFeederAnimal && item.feederType && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">{item.feederType}</span>}
                                        {item.isFeederAnimal && item.feederSize && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">{item.feederSize}</span>}
                                        {item.costPerUnit != null && <span className="text-xs text-gray-400">${Number(item.costPerUnit).toFixed(2)} / {item.unit || 'unit'}</span>}
                                    </div>
                                )}
                                {item.nextOrderDate && (
                                    <div className={`flex items-center gap-1.5 text-xs rounded-lg px-2 py-1.5 mt-0.5 ${isOverdue(item) ? 'bg-red-50 text-red-600' : isDueSoon(item) ? 'bg-blue-50 text-blue-600' : 'bg-gray-50 text-gray-500'}`}>
                                        <Calendar size={11} className="shrink-0" />
                                        <span>Next order: {new Date(item.nextOrderDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                        {item.orderFrequency && <span className="opacity-60"> 🔄 every {item.orderFrequency} {item.orderFrequencyUnit}</span>}
                                    </div>
                                )}

                                {/* Inline restock form */}
                                {restockingSupplyId === item._id && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-2.5 mt-1 space-y-2">
                                        <p className="text-xs font-semibold text-blue-700">Restock ? logs an expense in Budget{item.isFeederAnimal ? ` � ${[item.feederType, item.feederSize].filter(Boolean).join(' ')}` : ''}</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="text-[10px] font-medium text-gray-500 block mb-0.5">Qty received *</label>
                                                <input type="number" min="0.01" step="any" value={restockForm.qty} onChange={e => {
                                                    const q = e.target.value;
                                                    const autoCost = item.costPerUnit && q ? (parseFloat(q) * item.costPerUnit).toFixed(2) : restockForm.cost;
                                                    setRestockForm(f => ({ ...f, qty: q, cost: autoCost }));
                                                }} placeholder="e.g. 5" className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-medium text-gray-500 block mb-0.5">Cost paid *</label>
                                                <input type="number" min="0" step="0.01" value={restockForm.cost} onChange={e => setRestockForm(f => ({ ...f, cost: e.target.value }))} placeholder="0.00" className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-medium text-gray-500 block mb-0.5">Date</label>
                                                <input type="date" value={restockForm.date} onChange={e => setRestockForm(f => ({ ...f, date: e.target.value }))} className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-medium text-gray-500 block mb-0.5">Notes</label>
                                                <input type="text" value={restockForm.notes} onChange={e => setRestockForm(f => ({ ...f, notes: e.target.value }))} placeholder="Notes" className="w-full text-sm border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400" />
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end">
                                            <button onClick={() => setRestockingSupplyId(null)} className="px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-100 rounded-lg transition">Cancel</button>
                                            <button
                                                onClick={() => handleRestockSubmit(item)}
                                                disabled={restockSaving || !restockForm.qty || !restockForm.cost}
                                                className="px-2.5 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg font-medium transition disabled:opacity-50 flex items-center gap-1"
                                            >
                                                {restockSaving ? <Loader2 size={11} className="animate-spin" /> : <ShoppingBag size={11} />}
                                                Log Restock
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-2 justify-end mt-0.5">
                                    <button onClick={() => openRestock(item)} className="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded-lg transition font-medium"><ShoppingBag size={11} /> Restock</button>
                                    <button onClick={() => handleSupplyEdit(item)} className="flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 px-2 py-1 rounded-lg transition"><Edit size={11} /> Edit</button>
                                    <button onClick={() => handleSupplyDelete(item._id)} className="flex items-center gap-1 text-xs text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded-lg transition"><Trash2 size={11} /> Delete</button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // -- Management View ----------------------------------------------------------
    const renderManagementView = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const daysSince = (dateStr) => {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            d.setHours(0, 0, 0, 0);
            return Math.floor((today - d) / 86400000);
        };

        const isDue = (lastDate, freqDays) => {
            if (!freqDays) return false;
            if (!lastDate) return true;
            const ds = daysSince(lastDate);
            return ds !== null && ds >= Number(freqDays);
        };

        const toggleSection = (key) => setCollapsedMgmtSections(prev => ({ ...prev, [key]: !prev[key] }));
        const toggleGroup = (key) => setCollapsedMgmtGroups(prev => ({ ...prev, [key]: !prev[key] }));

        // Enclosure CRUD handlers
        const handleSaveEnclosure = async () => {
            if (enclosureSaving || !enclosureFormData.name.trim()) return;
            setEnclosureSaving(true);
            try {
                if (editingEnclosureId) {
                    await axios.put(`${API_BASE_URL}/enclosures/${editingEnclosureId}`, enclosureFormData,
                        { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } });
                    logManagementActivity('enclosure_update', null, { name: enclosureFormData.name.trim() });
                } else {
                    await axios.post(`${API_BASE_URL}/enclosures`, enclosureFormData,
                        { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } });
                    logManagementActivity('enclosure_create', null, { name: enclosureFormData.name.trim() });
                }
                setEnclosureFormVisible(false);
                setEditingEnclosureId(null);
                setEnclosureFormData({ name: '', enclosureType: '', size: '', notes: '', cleaningTasks: [] });
                fetchEnclosures();
            } catch (err) {
                showModalMessage('Error', err.response?.data?.message || 'Failed to save enclosure');
            } finally { setEnclosureSaving(false); }
        };

        const handleDeleteEnclosure = async (encId) => {
            if (!window.confirm('Delete this enclosure? Animals inside will become unassigned.')) return;
            const encToDelete = enclosures.find(e => e._id === encId);
            try {
                await axios.delete(`${API_BASE_URL}/enclosures/${encId}`,
                    { headers: { 'Authorization': `Bearer ${authToken}` } });
                logManagementActivity('enclosure_delete', null, { name: encToDelete?.name || encId });
                fetchEnclosures();
                fetchAnimals();
            } catch (err) {
                showModalMessage('Error', err.response?.data?.message || 'Failed to delete enclosure');
            }
        };

        const handleAssignAnimalToEnclosure = async (animalIdPublic, enclosureId) => {
            try {
                await axios.put(`${API_BASE_URL}/animals/${animalIdPublic}`,
                    { enclosureId: enclosureId || null },
                    { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } });
                const encName = enclosureId ? (enclosures.find(e => e._id === enclosureId)?.name || enclosureId) : null;
                logManagementActivity(
                    enclosureId ? 'enclosure_assign' : 'enclosure_unassign',
                    animalIdPublic,
                    enclosureId ? { enclosureName: encName } : {}
                );
                fetchAnimals();
            } catch (err) { console.error('Assign enclosure failed:', err); }
        };

        const handleMarkFed = (e, animal) => {
            e.stopPropagation();
            // Open the feeding modal; form resets each time
            setFeedingForm({ supplyId: '', qty: '1', notes: '', updateStock: true });
            setFeedingModal({ animal });
        };

        const handleFeedingSubmit = async () => {
            if (!feedingModal) return;
            const { animal } = feedingModal;
            const now = new Date().toISOString();
            setFeedingModal(null);
            // Optimistic: update lastFedDate immediately
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, lastFedDate: now } : a));
            try {
                const body = {};
                if (feedingForm.supplyId) {
                    body.supplyId = feedingForm.supplyId;
                    if (feedingForm.updateStock) body.quantity = Number(feedingForm.qty) || 1;
                }
                if (feedingForm.notes.trim()) body.notes = feedingForm.notes.trim();
                const res = await axios.post(`${API_BASE_URL}/animals/${animal.id_public}/feeding`, body,
                    { headers: { Authorization: `Bearer ${authToken}` } });
                // Update supply stock in state
                if (res.data.supply) setSupplies(prev => prev.map(s => s._id === res.data.supply._id ? res.data.supply : s));
                const supplyItem = feedingForm.supplyId ? supplies.find(s => s._id === feedingForm.supplyId) : null;
                logManagementActivity('animal_fed', animal.id_public, {
                    name: animal.name,
                    species: animal.species,
                    ...(supplyItem ? { food: supplyItem.name, qty: `${feedingForm.qty} ${supplyItem.unit || ''}`.trim() } : {})
                });
            } catch (err) {
                console.error('Feeding failed:', err);
                setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, lastFedDate: animal.lastFedDate } : a));
            }
        };

        const handleSkipFeeding = async (e, animal) => {
            e.stopPropagation();
            const now = new Date().toISOString();
            // Optimistic: advance lastFedDate so it clears the overdue state
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, lastFedDate: now } : a));
            try {
                await axios.post(`${API_BASE_URL}/animals/${animal.id_public}/feeding`,
                    { skipped: true },
                    { headers: { Authorization: `Bearer ${authToken}` } });
                logManagementActivity('feeding_skipped', animal.id_public, { name: animal.name, species: animal.species });
            } catch (err) {
                console.error('Skip feeding failed:', err);
                setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, lastFedDate: animal.lastFedDate } : a));
            }
        };

        const handleMarkMaintDone = (e, animal) => {
            e.stopPropagation();
            const now = new Date().toISOString();
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, lastMaintenanceDate: now } : a));
            axios.put(`${API_BASE_URL}/animals/${animal.id_public}`,
                { lastMaintenanceDate: now },
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => logManagementActivity('care_task_done', animal.id_public, { name: animal.name, taskName: 'General maintenance' }))
                .catch(err => { console.error('Mark maintenance failed:', err); setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, lastMaintenanceDate: animal.lastMaintenanceDate } : a)); });
        };

        const parseArrayField = (val) => {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            try { return JSON.parse(val); } catch { return [{ name: String(val) }]; }
        };

        // -- Section data ---------------------------------------------------------
        // Exclude deceased animals from all management sections
        const allAnimals = allAnimalsRaw.filter(a => a.status !== 'Deceased');
        // 1. Enclosures ? grouped by named enclosure (enclosureId)
        const enclosureAnimalMap = {}; // { enclosureId: [animals] }
        const unassignedAnimals = [];
        allAnimals.forEach(a => {
            if (a.enclosureId) {
                if (!enclosureAnimalMap[a.enclosureId]) enclosureAnimalMap[a.enclosureId] = [];
                enclosureAnimalMap[a.enclosureId].push(a);
            } else {
                unassignedAnimals.push(a);
            }
        });

        // 2. Reproduction
        const matingList = allAnimals.filter(a => a.isInMating);
        const pregnantList = allAnimals.filter(a => a.isPregnant && !a.isInMating);
        const nursingList = allAnimals.filter(a => a.isNursing);
        const reproTotal = allAnimals.filter(a => a.isInMating || a.isPregnant || a.isNursing).length;

        // 3. Feeding
        const feedDue = allAnimals.filter(a => isDue(a.lastFedDate, a.feedingFrequencyDays));
        const feedOk = allAnimals.filter(a => a.feedingFrequencyDays && !isDue(a.lastFedDate, a.feedingFrequencyDays));
        const feedNone = allAnimals.filter(a => !a.feedingFrequencyDays);

        // 4. Maintenance ? enclosure cleaning tasks + supply reorders
        const enclosuresWithCleaningTasks = enclosures.filter(enc => enc.cleaningTasks?.length > 0);
        const animalsWithCareTasks = allAnimals.filter(a => (a.careTasks?.length > 0) || (a.animalCareTasks?.length > 0));
        const todayMaint = new Date(); todayMaint.setHours(0, 0, 0, 0);
        const supplyReorderDue = supplies.filter(s =>
            (s.reorderThreshold != null && s.currentStock <= s.reorderThreshold) ||
            (s.nextOrderDate && new Date(s.nextOrderDate) < todayMaint)
        );
        const maintTotalDue = enclosuresWithCleaningTasks.reduce((sum, enc) => sum + enc.cleaningTasks.filter(t => isDue(t.lastDoneDate, t.frequencyDays)).length, 0) + supplyReorderDue.length;
        const animalCareDue = feedDue.length + animalsWithCareTasks.reduce((sum, a) => {
            const enclosureTasks = (a.careTasks || []).filter(t => isDue(t.lastDoneDate, t.frequencyDays)).length;
            const animalTasks = (a.animalCareTasks || []).filter(t => isDue(t.lastDoneDate, t.frequencyDays)).length;
            return sum + enclosureTasks + animalTasks;
        }, 0);

        // 5. Medical ? quarantine and treatment
        const quarantineList = allAnimals.filter(a => a.isQuarantine);
        const treatmentList = allAnimals.filter(a => !a.isQuarantine && (
            parseArrayField(a.medicalConditions).length > 0 || parseArrayField(a.medications).length > 0
        ));

        const handleMarkEnclosureTaskDone = async (e, enc, taskIdx) => {
            e.stopPropagation();
            const updated = [...(enc.cleaningTasks || [])];
            updated[taskIdx] = { ...updated[taskIdx], lastDoneDate: new Date().toISOString() };
            // Optimistic update
            setEnclosures(prev => prev.map(ex => ex._id === enc._id ? { ...ex, cleaningTasks: updated } : ex));
            axios.put(`${API_BASE_URL}/enclosures/${enc._id}`,
                { name: enc.name, enclosureType: enc.enclosureType || '', size: enc.size || '', notes: enc.notes || '', cleaningTasks: updated },
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => logManagementActivity('enclosure_task_done', null, { name: enc.name, taskName: updated[taskIdx]?.taskName || 'Cleaning task' }))
                .catch(err => { console.error('Mark enclosure task done failed:', err); fetchEnclosures(); });
        };

        const handleSkipEnclosureTask = async (e, enc, taskIdx) => {
            e.stopPropagation();
            const updated = [...(enc.cleaningTasks || [])];
            const taskName = updated[taskIdx]?.taskName || 'Cleaning task';
            updated[taskIdx] = { ...updated[taskIdx], lastDoneDate: new Date().toISOString(), lastSkipped: true };
            // Optimistic update
            setEnclosures(prev => prev.map(ex => ex._id === enc._id ? { ...ex, cleaningTasks: updated } : ex));
            axios.put(`${API_BASE_URL}/enclosures/${enc._id}`,
                { name: enc.name, enclosureType: enc.enclosureType || '', size: enc.size || '', notes: enc.notes || '', cleaningTasks: updated },
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => logManagementActivity('enclosure_task_skipped', null, { name: enc.name, taskName }))
                .catch(err => { console.error('Skip enclosure task failed:', err); fetchEnclosures(); });
        };

        const handleMarkAnimalCareTaskDone = (e, animal, taskIdx, taskType = 'enclosure') => {
            e.stopPropagation();
            const fieldName = taskType === 'animal' ? 'animalCareTasks' : 'careTasks';
            const updated = [...(animal[fieldName] || [])];
            updated[taskIdx] = { ...updated[taskIdx], lastDoneDate: new Date().toISOString() };
            // Optimistic update
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, [fieldName]: updated } : a));
            axios.put(`${API_BASE_URL}/animals/${animal.id_public}`, { [fieldName]: updated },
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => logManagementActivity('care_task_done', animal.id_public, { name: animal.name, taskName: updated[taskIdx]?.taskName || 'Care task' }))
                .catch(err => { console.error('Mark animal care task done failed:', err); fetchAllAnimals(); });
        };

        const handleSkipAnimalCareTask = (e, animal, taskIdx, taskType = 'enclosure') => {
            e.stopPropagation();
            const fieldName = taskType === 'animal' ? 'animalCareTasks' : 'careTasks';
            const updated = [...(animal[fieldName] || [])];
            const taskName = updated[taskIdx]?.taskName || 'Care task';
            updated[taskIdx] = { ...updated[taskIdx], lastDoneDate: new Date().toISOString(), lastSkipped: true };
            // Optimistic update
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, [fieldName]: updated } : a));
            axios.put(`${API_BASE_URL}/animals/${animal.id_public}`, { [fieldName]: updated },
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => logManagementActivity('care_task_skipped', animal.id_public, { name: animal.name, taskName }))
                .catch(err => { console.error('Skip animal care task failed:', err); fetchAllAnimals(); });
        };

        const handleUnquarantine = (e, animal) => {
            e.stopPropagation();
            if (!window.confirm(`Release ${animal.name || 'this animal'} from quarantine?`)) return;
            // Optimistic update
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, isQuarantine: false } : a));
            axios.put(`${API_BASE_URL}/animals/${animal.id_public}`, { isQuarantine: false },
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => logManagementActivity('quarantine_released', animal.id_public, { name: animal.name, species: animal.species }))
                .catch(err => { console.error('Unquarantine failed:', err); setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, isQuarantine: true } : a)); });
        };

        const handleReproStatusUpdate = (e, animal, patch) => {
            e.stopPropagation();
            // Optimistic update
            setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, ...patch } : a));
            axios.put(`${API_BASE_URL}/animals/${animal.id_public}`, patch,
                { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` } })
                .then(() => {
                    let reproStatus = 'Status changed';
                    if (patch.isInMating === false && patch.isPregnant === true) reproStatus = 'Confirmed Pregnant';
                    else if (patch.isPregnant === false && patch.isNursing === true) reproStatus = 'Started Nursing';
                    else if (patch.isInMating === false) reproStatus = 'Cleared Mating';
                    else if (patch.isPregnant === false) reproStatus = 'Cleared Pregnancy';
                    else if (patch.isNursing === false) reproStatus = 'Cleared Nursing';
                    logManagementActivity('reproduction_update', animal.id_public, { name: animal.name, species: animal.species, status: reproStatus });
                })
                .catch(err => { console.error('Repro status update failed:', err); setAllAnimalsRaw(prev => prev.map(a => a.id_public === animal.id_public ? { ...a, ...Object.fromEntries(Object.keys(patch).map(k => [k, animal[k]])) } : a)); });
        };

        // -- Shared helpers --------------------------------------------------------
        // All appearance fields that make up "Variety" ? same set as Tab 3 / Appearance section
        const VARIETY_KEYS = ['color', 'coatPattern', 'coat', 'earset', 'phenotype', 'morph', 'markings', 'eyeColor', 'nailColor', 'carrierTraits', 'size'];
        const getAnimalVariety = (a) => VARIETY_KEYS.map(k => a[k]).filter(Boolean).join(' ');

        // -- Shared card + group components ---------------------------------------
        const MgmtAnimalCard = ({ animal, extras }) => (
            <div
                className="flex items-center justify-between bg-white border border-gray-200 rounded-lg px-3 py-2 hover:bg-gray-50 cursor-pointer gap-2"
                onClick={() => onViewAnimal && onViewAnimal(animal)}
            >
                <div className="flex items-center gap-2 min-w-0">
                    {animal.imageUrl ? (
                        <img src={animal.imageUrl} alt={animal.name} className="w-8 h-8 rounded-full object-cover flex-shrink-0" />
                    ) : (
                        <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                            <Cat size={14} className="text-gray-400" />
                        </div>
                    )}
                    <div className="min-w-0">
                        <div className="font-semibold text-sm text-gray-800 truncate">
                            {[animal.prefix, animal.name || 'Unnamed', animal.suffix].filter(Boolean).join(' ')}
                        </div>
                        <div className="text-xs text-gray-500 truncate">
                            {getSpeciesDisplayName(animal.species)}{animal.gender ? ` � ${animal.gender}` : ''}
                            {animal.dateOfBirth ? ` � ${formatDateShort(animal.dateOfBirth)}` : ''}
                        </div>
                        {(() => {
                            const variety = getAnimalVariety(animal);
                            const parts = [animal.status, variety].filter(Boolean);
                            return parts.length > 0 ? (
                                <div className="text-xs text-gray-400 truncate">{parts.join(' � ')}</div>
                            ) : null;
                        })()}
                    </div>
                </div>
                {extras}
            </div>
        );

        const MgmtGroup = ({ groupKey, label, groupAnimals, headerClass, renderExtras }) => {
            const isGrpCollapsed = collapsedMgmtGroups[groupKey] || false;
            return (
                <div className="border border-gray-200 rounded-lg overflow-hidden">
                    <div
                        className={`relative flex items-center justify-between ${headerClass} px-3 py-2 cursor-pointer`}
                        onClick={() => toggleGroup(groupKey)}
                    >
                        <div className="absolute left-1/2 -translate-x-1/2 pointer-events-none">
                            {isGrpCollapsed
                                ? <ChevronDown className="w-3.5 h-3.5 text-gray-400" />
                                : <ChevronUp className="w-3.5 h-3.5 text-gray-400" />}
                        </div>
                        <span className="font-medium text-sm text-gray-800">{label}</span>
                        <span className="text-xs text-gray-500 bg-white/70 px-2 py-0.5 rounded-full">{groupAnimals.length}</span>
                    </div>
                    {!isGrpCollapsed && (
                        <div className="p-2 space-y-1.5 bg-white">
                            {groupAnimals.length === 0
                                ? <div className="text-sm text-gray-400 text-center py-2">None</div>
                                : groupAnimals.map(a => (
                                    <MgmtAnimalCard key={a._id || a.id_public} animal={a} extras={renderExtras ? renderExtras(a) : null} />
                                ))
                            }
                        </div>
                    )}
                </div>
            );
        };

        const SectionHeader = ({ sectionKey, icon, title, count, bgClass }) => {
            const collapsed = collapsedMgmtSections[sectionKey] || false;
            return (
                <div
                    className={`relative flex items-center justify-between ${bgClass} px-3 py-2.5 sm:px-4 sm:py-3 border-b cursor-pointer`}
                    onClick={() => toggleSection(sectionKey)}
                >
                    <div className="absolute left-1/2 -translate-x-1/2 pointer-events-none">
                        {collapsed
                            ? <ChevronDown className="w-4 h-4 text-gray-400" />
                            : <ChevronUp className="w-4 h-4 text-gray-400" />}
                    </div>
                    <div className="flex items-center gap-2">
                        {icon}
                        <span className="font-semibold text-gray-800">{title}</span>
                        <span className="text-xs text-gray-500 bg-white/70 px-2 py-0.5 rounded-full">{count}</span>
                    </div>
                    <div />
                </div>
            );
        };

        return (
            <div className="space-y-3 sm:space-y-4 mt-4">

                {/* -- 1. ENCLOSURES ------------------------------------------ */}
                <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    {/* Section header ? collapse on click, Add button on right */}
                    <div className="relative flex items-center justify-between bg-blue-50 px-3 py-2.5 sm:px-4 sm:py-3 border-b cursor-pointer" onClick={() => toggleSection('enclosures')}>
                        <div className="absolute left-1/2 -translate-x-1/2 pointer-events-none">
                            {collapsedMgmtSections['enclosures']
                                ? <ChevronDown className="w-4 h-4 text-gray-400" />
                                : <ChevronUp className="w-4 h-4 text-gray-400" />}
                        </div>
                        <div className="flex items-center gap-2">
                            <Home size={18} className="text-blue-600" />
                            <span className="font-semibold text-gray-800">Enclosures</span>
                            <span className="text-xs text-gray-500 bg-white/70 px-2 py-0.5 rounded-full">{enclosures.length}</span>
                        </div>
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                if (editingEnclosureId) { setEditingEnclosureId(null); setEnclosureFormVisible(false); }
                                else { setEnclosureFormData({ name: '', enclosureType: '', size: '', notes: '', cleaningTasks: [] }); setEnclosureFormVisible(v => !v); }
                            }}
                            className="flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-800 bg-white border border-blue-200 px-2 py-1 rounded-lg"
                        >
                            <Plus size={13} /> {enclosureFormVisible && !editingEnclosureId ? 'Cancel' : 'Add'}
                        </button>
                    </div>

                    {/* Inline create / edit form */}
                    {enclosureFormVisible && !collapsedMgmtSections['enclosures'] && (
                        <div className="p-3 border-b bg-blue-50/40 space-y-2">
                            <div className="text-xs font-semibold text-blue-700 mb-1">{editingEnclosureId ? 'Edit Enclosure' : 'New Enclosure'}</div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Name *</label>
                                    <input type="text" value={enclosureFormData.name}
                                        onChange={e => setEnclosureFormData(p => ({...p, name: e.target.value}))}
                                        placeholder="e.g. Tank 1, Vivarium A, Colony Room 3"
                                        className="block w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400" />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Type</label>
                                    <input type="text" value={enclosureFormData.enclosureType}
                                        onChange={e => setEnclosureFormData(p => ({...p, enclosureType: e.target.value}))}
                                        placeholder="e.g. Tank, Cage, Vivarium, Pond, Room"
                                        className="block w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400" />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Size</label>
                                    <input type="text" value={enclosureFormData.size}
                                        onChange={e => setEnclosureFormData(p => ({...p, size: e.target.value}))}
                                        placeholder="e.g. 40 gallon, 48�24�24, 10 sq ft"
                                        className="block w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400" />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                                    <input type="text" value={enclosureFormData.notes}
                                        onChange={e => setEnclosureFormData(p => ({...p, notes: e.target.value}))}
                                        placeholder="Optional notes"
                                        className="block w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400" />
                                </div>
                                {/* Cleaning Tasks */}
                                <div className="col-span-full">
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Cleaning Tasks</label>
                                    {(enclosureFormData.cleaningTasks || []).length > 0 && (
                                        <div className="space-y-1 mb-2">
                                            {(enclosureFormData.cleaningTasks || []).map((task, idx) => (
                                                <div key={idx} className="flex items-center gap-2 text-xs bg-white rounded border border-gray-200 px-2 py-1.5">
                                                    <span className="flex-1 font-medium text-gray-700">{task.taskName}</span>
                                                    {task.frequencyDays && <span className="text-gray-400">Every {task.frequencyDays}d</span>}
                                                    <button type="button" onClick={() => setEnclosureFormData(p => ({ ...p, cleaningTasks: (p.cleaningTasks || []).filter((_, i) => i !== idx) }))} className="text-red-400 hover:text-red-600 font-bold text-sm leading-none">🗑️</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <div className="flex items-center gap-2">
                                        <input type="text" value={newCleaningTaskName} onChange={e => setNewCleaningTaskName(e.target.value)}
                                            placeholder="e.g. Spot clean, Full clean, Bulb change"
                                            className="flex-1 p-1.5 text-xs border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400" />
                                        <input type="number" value={newCleaningTaskFreq} onChange={e => setNewCleaningTaskFreq(e.target.value)}
                                            placeholder="Days" min="1"
                                            className="w-16 p-1.5 text-xs border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400" />
                                        <button type="button" onClick={() => {
                                            if (!newCleaningTaskName.trim()) return;
                                            setEnclosureFormData(p => ({ ...p, cleaningTasks: [...(p.cleaningTasks || []), { taskName: newCleaningTaskName.trim(), frequencyDays: newCleaningTaskFreq ? Number(newCleaningTaskFreq) : null, lastDoneDate: null }] }));
                                            setNewCleaningTaskName(''); setNewCleaningTaskFreq('');
                                        }} className="px-2 py-1.5 text-xs bg-blue-600 text-white rounded font-medium hover:bg-blue-700 whitespace-nowrap">+ Add</button>
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => { setEnclosureFormVisible(false); setEditingEnclosureId(null); }}
                                    className="text-xs px-3 py-1.5 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button onClick={handleSaveEnclosure} disabled={enclosureSaving || !enclosureFormData.name.trim()}
                                    className="text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium disabled:opacity-50">
                                    {enclosureSaving ? 'Saving...' : (editingEnclosureId ? 'Save Changes' : 'Create Enclosure')}
                                </button>
                            </div>
                        </div>
                    )}

                    {!collapsedMgmtSections['enclosures'] && (
                        <div className="p-3 space-y-2">
                            {enclosures.length === 0 && unassignedAnimals.length === 0 ? (
                                <div className="text-sm text-gray-400 text-center py-4">No enclosures yet. Click Add to create your first enclosure.</div>
                            ) : (
                                <>
                                    {/* Named enclosures */}
                                    {enclosures.map(enc => {
                                        const occupants = enclosureAnimalMap[enc._id] || [];
                                        const isGrpCollapsed = collapsedMgmtGroups[`enc_${enc._id}`] || false;
                                        return (
                                            <div key={enc._id} className="border border-gray-200 rounded-lg overflow-hidden">
                                                {/* Enclosure header */}
                                                <div className="relative flex items-center bg-blue-50/60 px-3 py-2 cursor-pointer"
                                                    onClick={() => toggleGroup(`enc_${enc._id}`)}
                                                >
                                                    <div className="absolute left-1/2 -translate-x-1/2 pointer-events-none">
                                                        {isGrpCollapsed
                                                            ? <ChevronDown className="w-3.5 h-3.5 text-gray-400" />
                                                            : <ChevronUp className="w-3.5 h-3.5 text-gray-400" />}
                                                    </div>
                                                    <div className="flex items-center gap-2 flex-1 min-w-0">
                                                        <span className="font-semibold text-sm text-gray-800 truncate">{enc.name}</span>
                                                        {enc.enclosureType && <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full whitespace-nowrap shrink-0">{enc.enclosureType}</span>}
                                                        {enc.size && <span className="text-xs text-gray-400 whitespace-nowrap hidden sm:inline shrink-0">{enc.size}</span>}
                                                        <span className="text-xs text-gray-500 bg-white/70 px-1.5 py-0.5 rounded-full shrink-0">{occupants.length}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1 ml-2 shrink-0" onClick={e => e.stopPropagation()}>
                                                        <button
                                                            onClick={() => {
                                                                setEnclosureFormData({ name: enc.name, enclosureType: enc.enclosureType || '', size: enc.size || '', notes: enc.notes || '', cleaningTasks: enc.cleaningTasks || [] });
                                                                setEditingEnclosureId(enc._id);
                                                                setEnclosureFormVisible(true);
                                                                setCollapsedMgmtSections(p => ({...p, enclosures: false}));
                                                            }}
                                                            className="p-1 text-gray-400 hover:text-blue-600 rounded" title="Edit"
                                                        ><Edit size={13} /></button>
                                                        <button onClick={() => handleDeleteEnclosure(enc._id)}
                                                            className="p-1 text-gray-400 hover:text-red-500 rounded" title="Delete"
                                                        ><Trash2 size={13} /></button>
                                                    </div>
                                                </div>
                                                {!isGrpCollapsed && enc.notes && (
                                                    <div className="px-3 py-1.5 bg-gray-50 text-xs text-gray-500 border-b border-gray-100">{enc.notes}</div>
                                                )}
                                                {!isGrpCollapsed && (
                                                    <div className="p-2 space-y-1.5 bg-white">
                                                        {occupants.length === 0
                                                            ? <div className="text-xs text-gray-400 text-center py-2">No animals assigned yet</div>
                                                            : occupants.map(a => (
                                                                <MgmtAnimalCard key={a._id || a.id_public} animal={a}
                                                                    extras={
                                                                        <button onClick={(e) => { e.stopPropagation(); handleAssignAnimalToEnclosure(a.id_public, ''); }}
                                                                            className="text-xs text-gray-400 hover:text-red-500 border border-gray-200 hover:border-red-200 rounded px-1.5 py-0.5 shrink-0">
                                                                            Remove
                                                                        </button>
                                                                    }
                                                                />
                                                            ))
                                                        }
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}

                                    {/* Unassigned animals */}
                                    {unassignedAnimals.length > 0 && (
                                        <div className="border border-dashed border-gray-300 rounded-lg overflow-hidden">
                                            <div className="relative flex items-center justify-between bg-gray-50 px-3 py-2 cursor-pointer"
                                                onClick={() => toggleGroup('enc_unassigned')}
                                            >
                                                <div className="absolute left-1/2 -translate-x-1/2 pointer-events-none">
                                                    {collapsedMgmtGroups['enc_unassigned']
                                                        ? <ChevronDown className="w-3.5 h-3.5 text-gray-400" />
                                                        : <ChevronUp className="w-3.5 h-3.5 text-gray-400" />}
                                                </div>
                                                <span className="font-medium text-sm text-gray-500">Unassigned</span>
                                                <span className="text-xs text-gray-400 bg-white/70 px-2 py-0.5 rounded-full">{unassignedAnimals.length}</span>
                                            </div>
                                            {!collapsedMgmtGroups['enc_unassigned'] && (
                                                <div className="p-2 space-y-1.5 bg-white">
                                                    {unassignedAnimals.map(a => (
                                                        <MgmtAnimalCard key={a._id || a.id_public} animal={a}
                                                            extras={
                                                                enclosures.length > 0 ? (
                                                                    assigningAnimalId === a.id_public ? (
                                                                        <div className="flex items-center gap-1 shrink-0" onClick={e => e.stopPropagation()}>
                                                                            <select autoFocus defaultValue=""
                                                                                onChange={e => { if (e.target.value) { handleAssignAnimalToEnclosure(a.id_public, e.target.value); } setAssigningAnimalId(null); }}
                                                                                onBlur={() => setAssigningAnimalId(null)}
                                                                                className="text-xs border border-blue-300 rounded p-1 max-w-[130px]">
                                                                                <option value="" disabled>Select enclosure...</option>
                                                                                {enclosures.map(enc => <option key={enc._id} value={enc._id}>{enc.name}</option>)}
                                                                            </select>
                                                                        </div>
                                                                    ) : (
                                                                        <button onClick={(e) => { e.stopPropagation(); setAssigningAnimalId(a.id_public); }}
                                                                            className="text-xs text-blue-500 hover:text-blue-700 border border-blue-200 rounded px-1.5 py-0.5 shrink-0 whitespace-nowrap">
                                                                            Assign
                                                                        </button>
                                                                    )
                                                                ) : null
                                                            }
                                                        />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>

                {/* -- 2. REPRODUCTION ---------------------------------------- */}
                <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <SectionHeader sectionKey="reproduction"
                        icon={<Bean size={18} className="text-pink-600" />}
                        title="Reproduction" count={reproTotal} bgClass="bg-pink-50" />
                    {!collapsedMgmtSections['reproduction'] && (
                        <div className="p-3 space-y-2">
                            {reproTotal === 0
                                ? <div className="text-sm text-gray-400 text-center py-4">No animals currently in a reproductive state.</div>
                                : <>
                                    {matingList.length > 0 && (
                                        <MgmtGroup groupKey="repro_mating" label="In Mating"
                                            groupAnimals={matingList} headerClass="bg-purple-50"
                                            renderExtras={(a) => (
                                                <div className="flex items-center gap-1 shrink-0" onClick={e => e.stopPropagation()}>
                                                    {a.matingDate && <div className="text-xs text-gray-400 hidden sm:block">Since {formatDateShort(a.matingDate)}</div>}
                                                    <button onClick={(e) => handleReproStatusUpdate(e, a, { isInMating: false, isPregnant: true })}
                                                        className="text-xs px-1.5 py-0.5 rounded bg-pink-100 text-pink-700 hover:bg-pink-200 border border-pink-200 whitespace-nowrap">🥜 Pregnant</button>
                                                    <button onClick={(e) => handleReproStatusUpdate(e, a, { isInMating: false })}
                                                        className="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200">Clear</button>
                                                </div>
                                            )} />
                                    )}
                                    {pregnantList.length > 0 && (
                                        <MgmtGroup groupKey="repro_pregnant" label="Pregnant / Gravid"
                                            groupAnimals={pregnantList} headerClass="bg-pink-50"
                                            renderExtras={(a) => (
                                                <div className="flex items-center gap-1 shrink-0" onClick={e => e.stopPropagation()}>
                                                    {a.expectedDueDate && <div className="text-xs text-gray-400 hidden sm:block">Due {formatDateShort(a.expectedDueDate)}</div>}
                                                    <button onClick={(e) => handleReproStatusUpdate(e, a, { isPregnant: false, isNursing: true })}
                                                        className="text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-200 whitespace-nowrap">🍼 Nursing</button>
                                                    <button onClick={(e) => handleReproStatusUpdate(e, a, { isPregnant: false })}
                                                        className="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200">Clear</button>
                                                </div>
                                            )} />
                                    )}
                                    {nursingList.length > 0 && (
                                        <MgmtGroup groupKey="repro_nursing" label="Nursing / Brooding"
                                            groupAnimals={nursingList} headerClass="bg-blue-50"
                                            renderExtras={(a) => (
                                                <div className="flex items-center gap-1 shrink-0" onClick={e => e.stopPropagation()}>
                                                    <button onClick={(e) => handleReproStatusUpdate(e, a, { isNursing: false })}
                                                        className="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200">✅ Done</button>
                                                </div>
                                            )} />
                                    )}
                                </>
                            }
                        </div>
                    )}
                </div>

                {/* -- 3. ANIMAL CARE ----------------------------------------- */}
                <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <SectionHeader sectionKey="feeding"
                        icon={<Utensils size={18} className="text-green-600" />}
                        title="Animal Care" count={animalCareDue > 0 ? `${animalCareDue} due` : animals.length} bgClass="bg-green-50" />
                    {!collapsedMgmtSections['feeding'] && (
                        <div className="divide-y divide-gray-100">
                            {/* -- Daily / Routine -- */}
                            <div>
                                <div className="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 uppercase tracking-wide">Daily / Routine</div>
                                <div className="p-3 space-y-2">
                                    {feedDue.length > 0 && (
                                        <MgmtGroup groupKey="feed_due" label="Due Today / Overdue"
                                            groupAnimals={feedDue} headerClass="bg-red-50"
                                            renderExtras={(a) => (
                                                <div className="flex items-center gap-2 shrink-0" onClick={e => e.stopPropagation()}>
                                                    <div className="text-xs text-gray-400 text-right whitespace-nowrap hidden sm:block">
                                                        {a.dietType && <div>{a.dietType}</div>}
                                                        {a.lastFedDate
                                                            ? <div>Last: {formatDateShort(a.lastFedDate)}</div>
                                                            : <div className="text-orange-500">Never fed</div>}
                                                        {a.feedingFrequencyDays && <div>Every {a.feedingFrequencyDays}d</div>}
                                                    </div>
                                                    <button onClick={(e) => handleMarkFed(e, a)}
                                                        className="bg-green-500 hover:bg-green-600 text-white text-xs font-medium px-2 py-1 rounded-lg whitespace-nowrap">
                                                        ? Fed
                                                    </button>
                                                    <button onClick={(e) => handleSkipFeeding(e, a)}
                                                        className="bg-gray-100 hover:bg-gray-200 text-gray-500 text-xs font-medium px-2 py-1 rounded-lg whitespace-nowrap border border-gray-200">
                                                        ?? Skip
                                                    </button>
                                                </div>
                                            )} />
                                    )}
                                    {feedOk.length > 0 && (
                                        <MgmtGroup groupKey="feed_ok" label="Up to Date"
                                            groupAnimals={feedOk} headerClass="bg-green-50"
                                            renderExtras={(a) => (
                                                <div className="text-xs text-gray-400 text-right whitespace-nowrap shrink-0">
                                                    {a.lastFedDate && <div>Last: {formatDateShort(a.lastFedDate)}</div>}
                                                    {a.feedingFrequencyDays && <div> 🔄 Every {a.feedingFrequencyDays}d</div>}
                                                </div>
                                            )} />
                                    )}
                                    {feedNone.length > 0 && (
                                        <MgmtGroup groupKey="feed_none" label="No Schedule Set"
                                            groupAnimals={feedNone} headerClass="bg-gray-100"
                                            renderExtras={(a) => a.dietType
                                                ? <div className="text-xs text-gray-400 shrink-0 truncate max-w-[100px]">{a.dietType}</div>
                                                : null} />
                                    )}
                                    {feedDue.length === 0 && feedOk.length === 0 && feedNone.length === 0 && (
                                        <div className="text-sm text-gray-400 text-center py-4">No animals with a feeding schedule.</div>
                                    )}
                                </div>
                            </div>
                            {/* -- Scheduled Care -- */}
                            <div>
                                <div className="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 uppercase tracking-wide">Scheduled Care</div>
                                {animalsWithCareTasks.length === 0 ? (
                                    <div className="px-3 py-4 text-xs text-gray-400 text-center">No scheduled care tasks. Edit an animal and add tasks in the Animal Care tab.</div>
                                ) : animalsWithCareTasks.map(a => {
                                    const grpKey = `maint_animal_${a.id_public}`;
                                    const isGrpCollapsed = collapsedMgmtGroups[grpKey] || false;
                                    const enclosureTasks = (a.careTasks || []).map(t => ({ ...t, type: 'enclosure' }));
                                    const animalTasks = (a.animalCareTasks || []).map(t => ({ ...t, type: 'animal' }));
                                    const tasks = [...enclosureTasks, ...animalTasks];
                                    const dueTasks = tasks.filter(t => isDue(t.lastDoneDate, t.frequencyDays));
                                    return (
                                        <div key={a.id_public} className="border-b border-gray-100 last:border-0">
                                            <div className="flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-gray-50" onClick={() => toggleGroup(grpKey)}>
                                                <div className="flex items-center gap-2 min-w-0">
                                                    {isGrpCollapsed ? <ChevronDown size={14} className="text-gray-400" /> : <ChevronUp size={14} className="text-gray-400" />}
                                                    {a.imageUrl
                                                        ? <img src={a.imageUrl} alt={a.name} className="w-6 h-6 rounded-full object-cover flex-shrink-0" />
                                                        : <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><Cat size={11} className="text-gray-400" /></div>}
                                                    <span className="text-sm font-medium text-gray-800 truncate">{[a.prefix, a.name || 'Unnamed', a.suffix].filter(Boolean).join(' ')}</span>
                                                    <span className="text-xs text-gray-400 hidden sm:block">{getSpeciesDisplayName(a.species)}</span>
                                                </div>
                                                {dueTasks.length > 0 && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-medium shrink-0">{dueTasks.length} due</span>}
                                            </div>
                                            {!isGrpCollapsed && (
                                                <div className="px-4 py-2 space-y-2">
                                                    {tasks.map((task, idx) => {
                                                        const due = isDue(task.lastDoneDate, task.frequencyDays);
                                                        const daysAgo = task.lastDoneDate ? daysSince(task.lastDoneDate) : null;
                                                        const daysLeft = task.frequencyDays && daysAgo !== null ? task.frequencyDays - daysAgo : null;
                                                        const soon = !due && daysLeft !== null && daysLeft <= 2;
                                                        const taskType = task.type;
                                                        const realIdx = taskType === 'animal' ? idx - enclosureTasks.length : idx;
                                                        return (
                                                            <div key={idx} className="flex items-center justify-between gap-2 text-sm" onClick={e => e.stopPropagation()}>
                                                                <div className="flex items-center gap-2 min-w-0">
                                                                    <span className={`w-2 h-2 rounded-full flex-shrink-0 ${due ? 'bg-red-500' : soon ? 'bg-orange-400' : task.frequencyDays ? 'bg-green-500' : 'bg-gray-300'}`} />
                                                                    <span className="text-gray-700 truncate">{task.taskName}</span>
                                                                    {taskType === 'enclosure' && <span className="text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">Housing</span>}
                                                                    {taskType === 'animal' && <span className="text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded">Animal</span>}
                                                                </div>
                                                                <div className="flex items-center gap-1.5 shrink-0 text-xs text-gray-400">
                                                                    {task.frequencyDays && <span>🔄 Every {task.frequencyDays}d</span>}
                                                                    {task.lastDoneDate ? <span>✅ Last: {formatDateShort(task.lastDoneDate)}</span> : <span className="text-orange-500">❌ Never done</span>}
                                                                    <button onClick={(e) => handleMarkAnimalCareTaskDone(e, a, realIdx, taskType)}
                                                                        className={`ml-1 text-xs px-2 py-0.5 rounded font-medium border ${due ? 'bg-amber-500 text-white hover:bg-amber-600 border-amber-500' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border-gray-200'}`}>
                                                                        ? Done
                                                                    </button>
                                                                    <button onClick={(e) => handleSkipAnimalCareTask(e, a, realIdx, taskType)}
                                                                        className="ml-1 text-xs px-2 py-0.5 rounded font-medium border bg-gray-100 text-gray-400 hover:bg-gray-200 border-gray-200">
                                                                        ?? Skip
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>

                {/* -- 4. MAINTENANCE ----------------------------------------- */}
                <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <SectionHeader sectionKey="maintenance"
                        icon={<Wrench size={18} className="text-amber-600" />}
                        title="Maintenance" count={`${maintTotalDue} due`} bgClass="bg-amber-50" />
                    {!collapsedMgmtSections['maintenance'] && (
                        <div className="divide-y divide-gray-100">
                            {/* -- Enclosure Cleaning -- */}
                            <div>
                                <div className="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 uppercase tracking-wide">Enclosure Cleaning</div>
                                {enclosuresWithCleaningTasks.length === 0 ? (
                                    <div className="px-3 py-4 text-xs text-gray-400 text-center">No cleaning tasks defined. Edit an enclosure above and add tasks.</div>
                                ) : enclosuresWithCleaningTasks.map(enc => {
                                    const grpKey = `maint_enc_${enc._id}`;
                                    const isGrpCollapsed = collapsedMgmtGroups[grpKey] || false;
                                    const dueTasks = enc.cleaningTasks.filter(t => isDue(t.lastDoneDate, t.frequencyDays));
                                    return (
                                        <div key={enc._id} className="border-b border-gray-100 last:border-0">
                                            <div className="flex items-center justify-between px-3 py-2 bg-amber-50/40 cursor-pointer" onClick={() => toggleGroup(grpKey)}>
                                                <div className="flex items-center gap-2">
                                                    {isGrpCollapsed ? <ChevronDown size={14} className="text-gray-400" /> : <ChevronUp size={14} className="text-gray-400" />}
                                                    <span className="text-sm font-medium text-gray-800">{enc.name}</span>
                                                    {enc.enclosureType && <span className="text-xs text-gray-400">({enc.enclosureType})</span>}
                                                </div>
                                                {dueTasks.length > 0 && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-medium">{dueTasks.length} due</span>}
                                            </div>
                                            {!isGrpCollapsed && (
                                                <div className="px-4 py-2 space-y-2">
                                                    {enc.cleaningTasks.map((task, idx) => {
                                                        const due = isDue(task.lastDoneDate, task.frequencyDays);
                                                        const daysAgo = task.lastDoneDate ? daysSince(task.lastDoneDate) : null;
                                                        const daysLeft = task.frequencyDays && daysAgo !== null ? task.frequencyDays - daysAgo : null;
                                                        const soon = !due && daysLeft !== null && daysLeft <= 2;
                                                        return (
                                                            <div key={idx} className="flex items-center justify-between gap-2 text-sm" onClick={e => e.stopPropagation()}>
                                                                <div className="flex items-center gap-2 min-w-0">
                                                                    <span className={`w-2 h-2 rounded-full flex-shrink-0 ${due ? 'bg-red-500' : soon ? 'bg-orange-400' : task.frequencyDays ? 'bg-green-500' : 'bg-gray-300'}`} />
                                                                    <span className="text-gray-700 truncate">{task.taskName}</span>
                                                                </div>
                                                                <div className="flex items-center gap-1.5 shrink-0 text-xs text-gray-400">
                                                                    {task.frequencyDays && <span>🔄 Every {task.frequencyDays}d</span>}
                                                                    {task.lastDoneDate ? <span>✅ Last: {formatDateShort(task.lastDoneDate)}</span> : <span className="text-orange-500">❌ Never done</span>}
                                                                    <button onClick={(e) => handleMarkEnclosureTaskDone(e, enc, idx)}
                                                                        className={`ml-1 text-xs px-2 py-0.5 rounded font-medium border ${due ? 'bg-amber-500 text-white hover:bg-amber-600 border-amber-500' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border-gray-200'}`}>
                                                                        ? Done
                                                                    </button>
                                                                    <button onClick={(e) => handleSkipEnclosureTask(e, enc, idx)}
                                                                        className="ml-1 text-xs px-2 py-0.5 rounded font-medium border bg-gray-100 text-gray-400 hover:bg-gray-200 border-gray-200">
                                                                        ?? Skip
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>

                            {/* -- Supplies & Inventory -- */}
                            <div>
                                <div className="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 uppercase tracking-wide flex items-center justify-between">
                                    <span>Supplies &amp; Inventory</span>
                                    {suppliesLoading
                                        ? <Loader2 size={11} className="animate-spin text-gray-400" />
                                        : <span className="text-gray-400 font-normal normal-case">
                                            {supplies.length} item{supplies.length !== 1 ? 's' : ''}
                                            {supplyReorderDue.length > 0 && <span className="ml-1 text-amber-600 font-semibold">❗ {supplyReorderDue.length} to reorder</span>}
                                          </span>
                                    }
                                </div>
                                {supplies.length === 0 ? (
                                    <div className="px-3 py-3 flex items-center justify-between">
                                        <span className="text-xs text-gray-400">No items tracked yet.</span>
                                        <button onClick={() => { setSupplyFormVisible(false); setEditingSupplyId(null); setShowSuppliesScreen(true); }} className="flex items-center gap-1 text-xs text-emerald-600 hover:text-emerald-800 font-medium transition"><Package size={12} /> View All</button>
                                    </div>
                                ) : (
                                    <div className="px-3 py-2 space-y-1.5">
                                        {supplyReorderDue.length > 0 ? (
                                            supplyReorderDue.map(s => {
                                                const isDate = s.nextOrderDate && new Date(s.nextOrderDate) < todayMaint;
                                                const isStock = s.reorderThreshold != null && s.currentStock <= s.reorderThreshold;
                                                return (
                                                    <div key={s._id} className="flex items-center justify-between gap-2 text-sm">
                                                        <div className="flex items-center gap-2 min-w-0">
                                                            <span className="w-2 h-2 rounded-full flex-shrink-0 bg-red-500" />
                                                            <span className="text-gray-700 truncate">{s.name}</span>
                                                            {s.unit && <span className="text-gray-400 text-xs">{s.unit}</span>}
                                                        </div>
                                                        <div className="flex items-center gap-1.5 shrink-0">
                                                            {isStock && <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full">Low stock: {s.currentStock}</span>}
                                                            {isDate && <span className="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded-full">Order due</span>}
                                                            <button onClick={() => { setSupplyFormVisible(false); setEditingSupplyId(null); setShowSuppliesScreen(true); }} className="text-xs px-2 py-0.5 rounded font-medium border bg-amber-500 text-white hover:bg-amber-600 border-amber-500">Reorder</button>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        ) : (
                                            <p className="text-xs text-gray-400 py-1">{supplies.length} item{supplies.length !== 1 ? 's' : ''} tracked � all stocked</p>
                                        )}
                                        <div className="flex justify-end pt-0.5">
                                            <button onClick={() => { setSupplyFormVisible(false); setEditingSupplyId(null); setShowSuppliesScreen(true); }} className="flex items-center gap-1 text-xs text-emerald-600 hover:text-emerald-800 font-medium transition"><Package size={12} /> View All</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>

                {/* -- 5. MEDICAL / QUARANTINE -------------------------------- */}
                <div className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <SectionHeader sectionKey="medical"
                        icon={<Activity size={18} className="text-red-600" />}
                        title="Medical / Quarantine" count={quarantineList.length + treatmentList.length} bgClass="bg-red-50" />
                    {!collapsedMgmtSections['medical'] && (
                        <div className="p-3 space-y-2">
                            {quarantineList.length === 0 && treatmentList.length === 0
                                ? <div className="text-sm text-gray-400 text-center py-4">No animals in quarantine or under treatment.</div>
                                : <>
                                    {quarantineList.length > 0 && (
                                        <MgmtGroup groupKey="med_quarantine" label="Quarantine / Isolation"
                                            groupAnimals={quarantineList} headerClass="bg-orange-50"
                                            renderExtras={(a) => {
                                                const conds = parseArrayField(a.medicalConditions);
                                                return (
                                                    <div className="flex items-center gap-1.5 shrink-0">
                                                        {conds.length > 0
                                                            ? <div className="text-xs text-orange-600 max-w-[100px] truncate">{conds.map(c => c.name || c).join(', ')}</div>
                                                            : <span className="text-xs text-orange-400">Quarantine</span>}
                                                        <button
                                                            onClick={(e) => handleUnquarantine(e, a)}
                                                            className="text-xs px-2 py-0.5 rounded font-medium border bg-green-500 text-white hover:bg-green-600 border-green-500 whitespace-nowrap"
                                                            title="Release from quarantine"
                                                        >
                                                            🔓 Release
                                                        </button>
                                                    </div>
                                                );
                                            }} />
                                    )}
                                    {treatmentList.length > 0 && (
                                        <MgmtGroup groupKey="med_treatment" label="Under Treatment"
                                            groupAnimals={treatmentList} headerClass="bg-red-50"
                                            renderExtras={(a) => {
                                                const conds = parseArrayField(a.medicalConditions);
                                                const meds = parseArrayField(a.medications);
                                                return (
                                                    <div className="text-xs text-right shrink-0 max-w-[140px]">
                                                        {conds.length > 0 && <div className="text-gray-500 truncate">{conds.map(c => c.name || c).join(', ')}</div>}
                                                        {meds.length > 0 && <div className="text-blue-500 truncate">{meds.map(m => m.name || m).join(', ')}</div>}
                                                    </div>
                                                );
                                            }} />
                                    )}
                                </>
                            }
                        </div>
                    )}
                </div>

                {/* -- 6. ACTIVITY LOG ? now a separate screen, accessed via button in header -- */}

                {/* -- Feeding Modal ------------------------------------------------------- */}
                {feedingModal && (
                    <div className="fixed inset-0 bg-black/50 z-[300] flex items-center justify-center p-4" onClick={() => setFeedingModal(null)}>
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-5 space-y-4" onClick={e => e.stopPropagation()}>
                            <div className="flex items-start justify-between">
                                <div>
                                    <h3 className="font-bold text-gray-800 text-base">Record Feeding</h3>
                                    <p className="text-sm text-gray-500 mt-0.5">{feedingModal.animal.name}</p>
                                </div>
                                <button onClick={() => setFeedingModal(null)} className="text-gray-400 hover:text-gray-600 p-1 rounded"><X size={18} /></button>
                            </div>

                            {/* Food / Supply selector */}
                            <div className="space-y-1.5">
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide">Food / Supply</label>
                                <select
                                    value={feedingForm.supplyId}
                                    onChange={e => setFeedingForm(f => ({ ...f, supplyId: e.target.value, qty: '1' }))}
                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary/40 focus:border-primary"
                                >
                                    <option value="">🍽️ No food selected 🍽️</option>
                                    {supplies.filter(s => s.category === 'Food').map(s => (
                                        <option key={s._id} value={s._id}>
                                            {s.name}{s.feederType ? ` (${s.feederType}${s.feederSize ? ` � ${s.feederSize}` : ''})` : ''}{s.currentStock != null ? ` � ${s.currentStock} ${s.unit || 'in stock'}` : ''}
                                        </option>
                                    ))}
                                    {supplies.filter(s => s.category === 'Food').length === 0 && (
                                        <option disabled>No food items in supply 🍽️ add some in Supplies & Inventory</option>
                                    )}
                                </select>
                            </div>

                            {/* Quantity + stock deduction ? only shown when a supply is selected */}
                            {feedingForm.supplyId && (() => {
                                const s = supplies.find(x => x._id === feedingForm.supplyId);
                                const stockAfter = Math.round((s.currentStock - Number(feedingForm.qty || 0)) * 100) / 100;
                                return (
                                    <div className="space-y-2">
                                        {/* Deduct from stock toggle */}
                                        <label className="flex items-center gap-2 cursor-pointer select-none">
                                            <input
                                                type="checkbox"
                                                checked={feedingForm.updateStock}
                                                onChange={e => setFeedingForm(f => ({ ...f, updateStock: e.target.checked }))}
                                                className="w-4 h-4 rounded accent-green-500"
                                            />
                                            <span className="text-sm text-gray-700">Deduct from stock</span>
                                            {s && <span className="text-xs text-gray-400">(current: {s.currentStock} {s.unit})</span>}
                                        </label>
                                        {/* Quantity input ? only when deducting */}
                                        {feedingForm.updateStock && (
                                            <div className="space-y-1">
                                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide">Quantity{s?.unit ? ` (${s.unit})` : ''}</label>
                                                <input
                                                    type="number" min="0.1" step="0.1"
                                                    value={feedingForm.qty}
                                                    onChange={e => setFeedingForm(f => ({ ...f, qty: e.target.value }))}
                                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary/40 focus:border-primary"
                                                />
                                                {s && <p className="text-xs text-gray-400">Stock after: {s.currentStock} → <span className={stockAfter < 0 ? 'text-red-500 font-medium' : 'text-gray-600'}>{stockAfter} {s.unit}</span></p>}
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}

                            {/* Notes */}
                            <div className="space-y-1.5">
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide">Notes</label>
                                <input
                                    type="text"
                                    value={feedingForm.notes}
                                    onChange={e => setFeedingForm(f => ({ ...f, notes: e.target.value }))}
                                    placeholder="e.g. Refused once, ate second attempt"
                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary/40 focus:border-primary"
                                />
                            </div>

                            <div className="flex gap-2 pt-1">
                                <button
                                    onClick={handleFeedingSubmit}
                                    className="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition"
                                >
                                    ? Record Feeding
                                </button>
                                <button
                                    onClick={() => setFeedingModal(null)}
                                    className="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                )}

            </div>
        );
    };

    return (
        <div className="w-full max-w-5xl bg-white p-6 rounded-xl shadow-lg">
            <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div className='flex items-center gap-2'>
                    <ClipboardList size={20} className="sm:w-6 sm:h-6 mr-2 sm:mr-3 text-primary-dark" />
                    {animalView === 'list' ? `My Animals (${animals.length})` : showActivityLogScreen ? 'Activity Log' : showSuppliesScreen ? 'Supplies & Inventory' : 'Management View'}
                    {animalView === 'list' && hasActiveFilters && (
                        <span className="bg-pink-500 text-white text-xs font-semibold px-2 py-1 rounded-full">
                            Filtered
                        </span>
                    )}
                </div>
                <div className="flex items-center gap-1 sm:gap-2 flex-wrap" data-tutorial-target="bulk-privacy-controls">
                    {animalView === 'list' && hasActiveFilters && (
                        <button
                            onClick={handleClearFilters}
                            className="text-gray-600 hover:text-gray-800 transition flex items-center gap-0.5 sm:gap-1 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg hover:bg-gray-100 text-xs sm:text-sm"
                            title="Clear All Filters"
                        >
                            <X size={14} className="sm:w-4 sm:h-4" />
                            <span className="font-medium">Clear Filters</span>
                        </button>
                    )}
                    {animalView === 'list' && (<>
                    <button
                        onClick={() => toggleAllAnimalsPrivacy(true)}
                        className="text-green-600 hover:text-green-700 transition flex items-center gap-0.5 sm:gap-1 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg hover:bg-green-50 text-xs sm:text-sm"
                        title="Make All Animals Public"
                    >
                        <Eye size={14} className="sm:w-4 sm:h-4" />
                        <span className="font-medium">All Public</span>
                    </button>
                    <button
                        onClick={() => toggleAllAnimalsPrivacy(false)}
                        className="text-gray-600 hover:text-gray-800 transition flex items-center gap-0.5 sm:gap-1 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg hover:bg-gray-100 text-xs sm:text-sm"
                        title="Make All Animals Private"
                    >
                        <EyeOff size={14} className="sm:w-4 sm:h-4" />
                        <span className="font-medium">All Private</span>
                    </button>
                    <button 
                        onClick={() => { navigate('/hidden-animals'); fetchHiddenAnimals(); }}
                        data-tutorial-target="hidden-animals-btn"
                        className="text-gray-600 hover:text-gray-800 transition flex items-center gap-0.5 sm:gap-1 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg hover:bg-gray-100 text-xs sm:text-sm"
                        title="View Hidden Animals"
                    >
                        <Archive size={14} className="sm:w-[18px] sm:h-[18px]" />
                        <span className="font-medium">Hidden</span>
                    </button>
                    </>)}
                    {animalView === 'management' && !showActivityLogScreen && !showSuppliesScreen && (
                        <button
                            onClick={() => {
                                setActivityLogs([]);
                                setLogsLoaded(false);
                                setShowActivityLogScreen(true);
                            }}
                            className="flex items-center gap-1 px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 border border-indigo-200 rounded-lg transition font-medium"
                            title="View Activity Log"
                        >
                            <ScrollText size={14} className="sm:w-4 sm:h-4" />
                            <span className="font-medium">Activity Log</span>
                        </button>
                    )}
                    {animalView === 'management' && !showActivityLogScreen && !showSuppliesScreen && (
                        <button
                            onClick={() => { setSupplyForm({ name: '', category: 'Other', currentStock: '', unit: '', reorderThreshold: '', notes: '', isFeederAnimal: false, feederType: '', feederSize: '', costPerUnit: '', nextOrderDate: '', orderFrequency: '', orderFrequencyUnit: 'months' }); setEditingSupplyId(null); setSupplyFormVisible(false); setShowSuppliesScreen(true); }}
                            className="flex items-center gap-1 px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm text-emerald-600 hover:text-emerald-800 hover:bg-emerald-50 border border-emerald-200 rounded-lg transition font-medium"
                            title="Supplies & Inventory"
                        >
                            <Package size={14} className="sm:w-4 sm:h-4" />
                            <span className="font-medium">Supplies</span>
                        </button>
                    )}
                    <button 
                        onClick={handleRefresh} 
                        disabled={loading}
                        className="text-gray-600 hover:text-primary transition disabled:opacity-50 flex items-center p-1 sm:p-0"
                        title="Refresh List"
                    >
                        {loading ? <Loader2 size={16} className="sm:w-[18px] sm:h-[18px] animate-spin" /> : <RefreshCw size={16} className="sm:w-[18px] sm:h-[18px]" />}
                    </button>
                </div>
            </h2>

            {/* View Toggle: My Animals / Management */}
            <div className="flex border border-gray-200 rounded-xl overflow-hidden shadow-sm mb-4">
                <button
                    onClick={() => setAnimalView('list')}
                    className={`flex-1 flex items-center justify-center gap-2 py-2 px-4 text-sm font-semibold transition ${
                        animalView === 'list' ? 'bg-primary text-black' : 'bg-white text-gray-600 hover:bg-gray-50'
                    }`}
                >
                    <ClipboardList size={15} />
                    <span>My Animals</span>
                </button>
                <button
                    onClick={() => setAnimalView('management')}
                    className={`flex-1 flex items-center justify-center gap-2 py-2 px-4 text-sm font-semibold transition ${
                        animalView === 'management' ? 'bg-primary text-black' : 'bg-white text-gray-600 hover:bg-gray-50'
                    }`}
                >
                    <LayoutGrid size={15} />
                    <span>Management</span>
                </button>
            </div>

            {animalView === 'list' && (
            <div className="mb-4 sm:mb-6 p-2 sm:p-4 border rounded-lg bg-gray-50 space-y-2 sm:space-y-3">
                {/* Search and Add buttons - Stack on mobile */}
                <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <input
                        type="text"
                        placeholder="Search by name..."
                        value={searchInput}
                        onChange={handleSearchInputChange}
                        onKeyPress={(e) => { if (e.key === 'Enter') triggerSearch(); }}
                        className="flex-grow p-2 text-sm border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition"
                        disabled={loading}
                        data-tutorial-target="my-animals-search"
                    />
                    <div className="flex gap-2">
                        <button
                            onClick={triggerSearch}
                            disabled={loading}
                            className="flex-1 sm:flex-none bg-primary hover:bg-primary/90 text-black font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-1 text-sm"
                            title="Search"
                        >
                            <Search size={16} />
                            <span className="hidden sm:inline">Search</span>
                        </button>
                        <button 
                            onClick={() => navigate('/select-species')} 
                            className="flex-1 sm:flex-none bg-accent hover:bg-accent/90 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-1 whitespace-nowrap text-sm"
                            data-tutorial-target="add-animal-btn"
                        >
                            <PlusCircle size={16} /> <span className="hidden sm:inline">Add Animal</span><span className="sm:hidden">Add</span>
                        </button>
                    </div>
                </div>

                {/* Line 1: Species + Status dropdowns (centered) */}
                <div className="flex flex-wrap justify-center gap-3 sm:gap-4 pt-2 border-t border-gray-200">
                    <div className="flex gap-1 sm:gap-2 items-center" data-tutorial-target="species-filter">
                        <span className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Species:</span>
                        <select 
                            value={
                                // Show "All" if all available species are selected
                                speciesNames.every(species => selectedSpecies.includes(species)) ? '' : 
                                // Otherwise show first selected species (or empty)
                                (selectedSpecies.find(s => speciesNames.includes(s)) || '')
                            }
                            onChange={(e) => {
                                const value = e.target.value;
                                if (value === '') {
                                    setSelectedSpecies([...speciesNames]);
                                } else {
                                    setSelectedSpecies([value]);
                                }
                            }}
                            className="p-1.5 sm:p-2 text-xs sm:text-sm border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition min-w-[120px] sm:min-w-[160px]"
                        >
                            <option value="">All</option>
                            {speciesNames.map(species => (
                                <option key={species} value={species}>{getSpeciesDisplayName(species)}</option>
                            ))}
                        </select>
                    </div>
                    
                    <div className="flex gap-1 sm:gap-2 items-center" data-tutorial-target="status-filter">
                        <span className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Status:</span>
                        <select value={statusFilter} onChange={handleStatusFilterChange} 
                            className="p-1.5 sm:p-2 text-xs sm:text-sm border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition min-w-[120px] sm:min-w-[160px]"
                        >
                            <option value="">All</option>
                            {STATUS_OPTIONS.map(status => (
                                <option key={status} value={status}>{status}</option>
                            ))}
                        </select>
                    </div>
                </div>

                {/* Line 2: Gender icons + Visibility filters (both centered with gap) */}
                <div className="flex flex-wrap justify-center items-center gap-4 sm:gap-8">
                    <div className="flex items-center gap-1 sm:gap-2" data-tutorial-target="gender-filter">
                        <span className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Gender:</span>
                        {GENDER_OPTIONS.map(gender => {
                            const isSelected = selectedGenders.includes(gender);
                            let Icon, bgColor;
                            
                            switch(gender) {
                                case 'Male':
                                    Icon = Mars;
                                    bgColor = isSelected ? 'bg-primary' : 'bg-gray-300 hover:bg-gray-400';
                                    break;
                                case 'Female':
                                    Icon = Venus;
                                    bgColor = isSelected ? 'bg-pink-400' : 'bg-gray-300 hover:bg-gray-400';
                                    break;
                                case 'Intersex':
                                    Icon = VenusAndMars;
                                    bgColor = isSelected ? 'bg-purple-400' : 'bg-gray-300 hover:bg-gray-400';
                                    break;
                                case 'Unknown':
                                    Icon = Circle;
                                    bgColor = isSelected ? 'bg-teal-400' : 'bg-gray-300 hover:bg-gray-400';
                                    break;
                                default:
                                    Icon = Circle;
                                    bgColor = 'bg-gray-300 hover:bg-gray-400';
                            }
                            
                            return (
                                <button key={gender} onClick={() => toggleGender(gender)}
                                    className={`p-1.5 sm:p-2 rounded-lg transition duration-150 shadow-sm ${bgColor}`}
                                    title={gender}
                                >
                                    <Icon className="w-4 h-4 sm:w-[18px] sm:h-[18px] text-black" />
                                </button>
                            );
                        })}
                    </div>

                    <div className="flex items-center gap-1 sm:gap-2" data-tutorial-target="visibility-filter">
                        <span className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Visibility:</span>
                        {['All', 'Public', 'Private'].map(option => {
                            const value = option === 'All' ? '' : option.toLowerCase();
                            const isSelected = publicFilter === value;
                            return (
                                <button key={option} onClick={() => setPublicFilter(value)}
                                    className={`px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm font-semibold rounded-lg transition duration-150 shadow-sm ${ 
                                        isSelected ? 'bg-primary text-black' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    {option}
                                </button>
                            );
                        })}
                    </div>
                </div>

                {/* Line 3: Show filters (centered) */}
                <div className="flex justify-center items-center gap-1 sm:gap-2" data-tutorial-target="collection-filters">
                    <span className='text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap'>Show:</span>
                    
                    <button onClick={() => setOwnedFilterActive(prev => !prev)}
                        className={`px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm font-semibold rounded-lg transition duration-150 shadow-sm flex items-center gap-1 ${ 
                            ownedFilterActive ? 'bg-primary text-black' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                        title={ownedFilterActive ? 'Showing only your animals' : 'Showing all animals'}
                    >
                        {ownedFilterActive ? <Heart className="w-3.5 h-3.5 sm:w-4 sm:h-4" /> : <HeartHandshake className="w-3.5 h-3.5 sm:w-4 sm:h-4" />}
                        <span className="hidden sm:inline">{ownedFilterActive ? 'My Animals' : 'All'}</span>
                    </button>

                    <button onClick={handleFilterMating}
                        className={`px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm font-semibold rounded-lg transition duration-150 shadow-sm flex items-center gap-1 ${ 
                            statusFilterMating ? 'bg-accent text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                        title="Mating"
                    >
                        <Hourglass className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                        <span className="hidden sm:inline">Mating</span>
                    </button>
                    <button onClick={handleFilterPregnant}
                        className={`px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm font-semibold rounded-lg transition duration-150 shadow-sm flex items-center gap-1 ${ 
                            statusFilterPregnant ? 'bg-accent text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                        title="Pregnant"
                    >
                        <Bean className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                        <span className="hidden sm:inline">Pregnant</span>
                    </button>
                    <button onClick={handleFilterNursing}
                        className={`px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm font-semibold rounded-lg transition duration-150 shadow-sm flex items-center gap-1 ${ 
                            statusFilterNursing ? 'bg-accent text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                        title="Nursing"
                    >
                        <Milk className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                        <span className="hidden sm:inline">Nursing</span>
                    </button>
                </div>
            </div>
            )}

            {animalView === 'management' ? (
                loading ? <LoadingSpinner /> : showActivityLogScreen ? renderActivityLogScreen() : showSuppliesScreen ? renderSuppliesScreen() : renderManagementView()
            ) : loading ? (
                <LoadingSpinner />
            ) : animals.length === 0 ? (
                <div className="text-center p-8 bg-gray-50 rounded-lg">
                    <Cat size={48} className="text-gray-400 mx-auto mb-4" />
                    <p className="text-xl font-semibold text-gray-600">No animals found.</p>
                    <p className="text-gray-500">Try adjusting your filters or add a new animal!</p>
                </div>
            ) : (
                <div className="space-y-3 sm:space-y-4">
                    {speciesNames.map(species => {
                        const isBulkMode = bulkDeleteMode[species] || false;
                        const selected = selectedAnimals[species] || [];
                        const isCollapsed = collapsedSpecies[species] || false;
                        // Skip species that have no visible animals under current filters
                        if (!groupedAnimals[species]?.length) return null;
                        
                        return (
                        <div key={species} className="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                            <div 
                                className="relative flex items-center justify-between bg-gray-100 px-2 py-2 sm:p-4 border-b cursor-pointer"
                                onClick={() => {
                                    if (!isBulkMode) {
                                        setCollapsedSpecies(prev => ({ ...prev, [species]: !prev[species] }));
                                    }
                                }}
                            >
                                {/* Collapse indicator ? centered, up/down chevron */}
                                {!isBulkMode && (
                                    <div className="absolute left-1/2 -translate-x-1/2 pointer-events-none">
                                        {isCollapsed
                                            ? <ChevronDown className="w-4 h-4 text-gray-400" />
                                            : <ChevronUp className="w-4 h-4 text-gray-400" />
                                        }
                                    </div>
                                )}
                                <div className="flex items-center gap-1 sm:gap-2">
                                    {/* Reorder buttons ? left side, bordered pill */}
                                    {!isBulkMode && (
                                        <div className="flex items-center border border-gray-300 rounded-lg overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                            <button
                                                onClick={(e) => { e.stopPropagation(); moveSpecies(species, 'up'); }}
                                                disabled={speciesNames.indexOf(species) === 0}
                                                className="p-1 sm:p-1.5 hover:bg-gray-200 transition disabled:opacity-30 disabled:cursor-not-allowed border-r border-gray-300"
                                                title="Move Up"
                                            >
                                                <ChevronUp className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-gray-600" />
                                            </button>
                                            <button
                                                onClick={(e) => { e.stopPropagation(); moveSpecies(species, 'down'); }}
                                                disabled={speciesNames.indexOf(species) === speciesNames.length - 1}
                                                className="p-1 sm:p-1.5 hover:bg-gray-200 transition disabled:opacity-30 disabled:cursor-not-allowed"
                                                title="Move Down"
                                            >
                                                <ChevronDown className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-gray-600" />
                                            </button>
                                        </div>
                                    )}
                                    <h3 className="text-sm sm:text-lg font-bold text-gray-700">
                                        {getSpeciesDisplayName(species)} ({groupedAnimals[species].length})
                                    </h3>
                                </div>
                                <div className="flex items-center gap-0.5 sm:gap-2 flex-wrap" onClick={(e) => e.stopPropagation()}>
                                    {isBulkMode && (
                                        <>
                                            <span className="text-xs sm:text-sm text-gray-600 hidden sm:inline">
                                                {selected.length} selected
                                            </span>
                                            <span className="text-xs text-gray-600 sm:hidden">
                                                {selected.length}
                                            </span>
                                            <button
                                                onClick={() => handleBulkDelete(species)}
                                                disabled={selected.length === 0}
                                                className="px-2 sm:px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                <span className="hidden sm:inline">Delete Selected</span>
                                                <span className="sm:hidden">Delete</span>
                                            </button>
                                            <button
                                                onClick={() => toggleBulkDeleteMode(species)}
                                                className="px-2 sm:px-3 py-1 bg-gray-300 hover:bg-gray-400 text-gray-800 text-xs sm:text-sm font-semibold rounded-lg transition"
                                            >
                                                Cancel
                                            </button>
                                        </>
                                    )}
                                    {!isBulkMode && (
                                        <>
                                            <button
                                                onClick={() => navigate(`/animal-tree/${encodeURIComponent(species)}`)}
                                                className="p-1 sm:p-2 hover:bg-gray-200 rounded-lg transition"
                                                title="Animal Tree"
                                                data-tutorial-target="animal-tree-btn"
                                            >
                                                <Network className="w-3.5 h-3.5 sm:w-[18px] sm:h-[18px] text-blue-500" />
                                            </button>
                                            <button
                                                onClick={() => toggleBulkPrivacy(species, true)}
                                                className="p-1 sm:p-2 hover:bg-gray-200 rounded-lg transition"
                                                title="Make All Public"
                                            >
                                                <Eye className="w-3.5 h-3.5 sm:w-[18px] sm:h-[18px] text-green-600" />
                                            </button>
                                            <button
                                                onClick={() => toggleBulkPrivacy(species, false)}
                                                className="p-1 sm:p-2 hover:bg-gray-200 rounded-lg transition"
                                                title="Make All Private"
                                            >
                                                <EyeOff className="w-3.5 h-3.5 sm:w-[18px] sm:h-[18px] text-gray-600" />
                                            </button>
                                            <button
                                                onClick={() => toggleBulkDeleteMode(species)}
                                                data-tutorial-target="bulk-delete-btn"
                                                className="p-1 sm:p-2 hover:bg-gray-200 rounded-lg transition"
                                                title="Delete Multiple"
                                            >
                                                <Trash2 className="w-3.5 h-3.5 sm:w-[18px] sm:h-[18px] text-red-500" />
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                            {/* Collapsible content */}
                            <div className={isCollapsed ? 'hidden' : 'block'}>
                                <div className="p-1.5 sm:p-4 grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 sm:gap-4">
                                    {groupedAnimals[species].map(animal => (
                                        <AnimalCard 
                                            key={animal.id_public} 
                                            animal={animal} 
                                            onEditAnimal={onEditAnimal}
                                            species={species}
                                            isSelectable={isBulkMode}
                                            isSelected={selected.includes(animal.id_public)}
                                            onToggleSelect={toggleAnimalSelection}
                                            onTogglePrivacy={toggleAnimalPrivacy}
                                            onToggleOwned={toggleAnimalOwned}
                                        />
                                    ))}
                                </div>
                            </div>
                        </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
};

// Messages View Component
const MessagesView = ({ authToken, API_BASE_URL, onClose, showModalMessage, selectedConversation, setSelectedConversation, userProfile }) => {
    const [conversations, setConversations] = useState([]);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [loading, setLoading] = useState(true);
    const [sending, setSending] = useState(false);
    const messagesEndRef = useRef(null);

    useEffect(() => {
        fetchConversations();
        
        // Poll for new conversations every 5 seconds
        const interval = setInterval(() => {
            fetchConversations();
        }, 5000);

        return () => clearInterval(interval);
    }, []);

    useEffect(() => {
        if (selectedConversation) {
            fetchMessages(selectedConversation.otherUserId);
        }
    }, [selectedConversation]);

    useEffect(() => {
        // Poll for new messages every 3 seconds when a conversation is open
        if (!selectedConversation) return;
        
        const interval = setInterval(() => {
            fetchMessages(selectedConversation.otherUserId);
        }, 3000);

        return () => clearInterval(interval);
    }, [selectedConversation]);

    useEffect(() => {
        // Scroll to bottom when messages change
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    const fetchConversations = async () => {
        try {
            const response = await axios.get(`${API_BASE_URL}/messages/conversations`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setConversations(response.data || []);
        } catch (error) {
            console.error('Error fetching conversations:', error);
        } finally {
            setLoading(false);
        }
    };

    const fetchMessages = async (otherUserId) => {
        try {
            console.log('[MessagesView] Fetching messages for:', otherUserId);
            const response = await axios.get(`${API_BASE_URL}/messages/conversation/${otherUserId}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            console.log('[MessagesView] Got messages:', response.data?.messages?.length || 0, 'messages');
            setMessages(response.data.messages || []);
        } catch (error) {
            console.error('[MessagesView] Error fetching messages:', error.response?.data || error.message);
            showModalMessage && showModalMessage('Error', 'Failed to load messages');
        }
    };

    const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!newMessage.trim() || !selectedConversation) {
            console.log('[MessagesView] Cannot send: newMessage or selectedConversation missing');
            return;
        }

        console.log('[MessagesView] Sending message to:', selectedConversation.otherUserId);
        setSending(true);
        try {
            await axios.post(`${API_BASE_URL}/messages/send`, {
                receiverId: selectedConversation.otherUserId,
                message: newMessage.trim()
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            console.log('[MessagesView] Message sent successfully');
            setNewMessage('');
            await fetchMessages(selectedConversation.otherUserId);
            await fetchConversations(); // Refresh conversation list
        } catch (error) {
            console.error('[MessagesView] Error sending message:', error.response?.data || error.message);
            showModalMessage && showModalMessage('Error', error.response?.data?.error || 'Failed to send message');
        } finally {
            setSending(false);
        }
    };

    const getDisplayName = (user) => {
        if (!user) return 'Unknown User';
        return (user.showBreederName && user.breederName) 
            ? user.breederName 
            : (user.showPersonalName ? user.personalName : `User ${user.id_public}`);
    };

    const handleDeleteMessage = async (messageId) => {
        if (!window.confirm('Delete this message?')) return;
        try {
            await axios.delete(`${API_BASE_URL}/messages/${messageId}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            await fetchMessages(selectedConversation.otherUserId);
        } catch (error) {
            showModalMessage && showModalMessage('Error', 'Failed to delete message');
        }
    };

    const handleDeleteConversation = async () => {
        if (!window.confirm('Delete entire conversation? This cannot be undone.')) return;
        try {
            await axios.delete(`${API_BASE_URL}/messages/conversation/${selectedConversation.otherUserId}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setSelectedConversation(null);
            await fetchConversations();
            showModalMessage && showModalMessage('Success', 'Conversation deleted');
        } catch (error) {
            showModalMessage && showModalMessage('Error', 'Failed to delete conversation');
        }
    };

    const handleBlockUser = async () => {
        if (!window.confirm(`Block ${getDisplayName(selectedConversation.otherUser)}?`)) return;
        try {
            await axios.post(`${API_BASE_URL}/messages/block/${selectedConversation.otherUserId}`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setSelectedConversation(null);
            await fetchConversations();
            showModalMessage && showModalMessage('Success', 'User blocked');
        } catch (error) {
            showModalMessage && showModalMessage('Error', 'Failed to block user');
        }
    };

    const handleReportConversation = async () => {
        const reason = window.prompt('Why are you reporting this conversation? (max 1000 characters)');
        if (!reason) return;
        if (reason.length > 1000) {
            showModalMessage && showModalMessage('Error', 'Report reason too long');
            return;
        }
        try {
            // Get messages from the last 24 hours
            const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
            const recentMessages = messages
                .filter(msg => new Date(msg.createdAt).getTime() > twentyFourHoursAgo)
                .map(msg => ({
                    messageId: msg._id,
                    senderId: msg.senderId,
                    message: msg.message,
                    createdAt: msg.createdAt
                }));
            
            await axios.post(`${API_BASE_URL}/reports/message`, {
                conversationUserId: selectedConversation.otherUserId,
                reportedUserId: selectedConversation.otherUserId,
                reason: reason.trim(),
                recentMessages: recentMessages
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage && showModalMessage('Success', 'Report submitted to support team');
        } catch (error) {
            showModalMessage && showModalMessage('Error', 'Failed to submit report');
        }
    };

    const handleReportMessage = async (messageId, messageContent) => {
        const reason = window.prompt(`Why are you reporting this message?\n\n"${messageContent.substring(0, 100)}${messageContent.length > 100 ? '...' : ''}"\n\n(max 1000 characters)`);
        if (!reason) return;
        if (reason.length > 1000) {
            showModalMessage && showModalMessage('Error', 'Report reason too long');
            return;
        }
        try {
            await axios.post(`${API_BASE_URL}/reports/message`, {
                messageId: messageId,
                reportedUserId: selectedConversation.otherUserId,
                reason: reason.trim()
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage && showModalMessage('Success', 'Message reported to support team');
        } catch (error) {
            showModalMessage && showModalMessage('Error', 'Failed to submit report');
        }
    };

    const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        const now = new Date();
        const diffInHours = (now - date) / (1000 * 60 * 60);
        
        if (diffInHours < 24) {
            return date.toLocaleTimeString('en-GB', { hour: 'numeric', minute: '2-digit' });
        } else if (diffInHours < 168) { // Less than a week
            return date.toLocaleDateString('en-GB', { weekday: 'short', hour: 'numeric', minute: '2-digit' });
        } else {
            return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
        }
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[85vh] sm:h-[600px] flex flex-col">
                {/* Header */}
                <div className="flex justify-between items-center p-2 sm:p-4 border-b">
                    <h2 className="text-lg sm:text-xl font-bold text-gray-800 flex items-center gap-1 sm:gap-2">
                        <MessageSquare className="w-5 h-5 sm:w-6 sm:h-6 text-blue-500" />
                        Messages
                    </h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700 transition p-1">
                        <X className="w-5 h-5 sm:w-6 sm:h-6" />
                    </button>
                </div>

                <div className="flex flex-1 overflow-hidden">
                    {/* Conversations List - Hidden on mobile when conversation selected */}
                    <div className={`${selectedConversation ? 'hidden sm:flex' : 'flex'} sm:w-1/3 w-full border-r overflow-y-auto flex-col`}>
                        {loading ? (
                            <div className="flex items-center justify-center h-full">
                                <Loader2 className="animate-spin text-gray-400 w-6 h-6 sm:w-8 sm:h-8" />
                            </div>
                        ) : conversations.length === 0 ? (
                            <div className="p-3 sm:p-4 text-center text-gray-500">
                                <MessageSquare className="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 text-gray-300" />
                                <p className="text-sm sm:text-base">No conversations yet</p>
                            </div>
                        ) : (
                            conversations.map(conv => (
                                <div
                                    key={conv.conversationId}
                                    onClick={() => setSelectedConversation(conv)}
                                    className={`p-2 sm:p-4 border-b cursor-pointer hover:bg-gray-50 transition ${
                                        selectedConversation?.conversationId === conv.conversationId ? 'bg-blue-50' : ''
                                    }`}
                                >
                                    <div className="flex items-center gap-2 sm:gap-3">
                                        <div className="w-8 h-8 sm:w-10 sm:h-10 bg-gray-200 rounded-full overflow-hidden flex-shrink-0">
                                            {conv.otherUser?.profileImage ? (
                                                <img src={conv.otherUser.profileImage} alt="" className="w-full h-full object-cover" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                    <User size={20} />
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-baseline">
                                                <p className="font-semibold text-sm truncate flex items-center gap-1">
                                                    {getDisplayName(conv.otherUser)}
                                                    <DonationBadge badge={getDonationBadge(conv.otherUser)} size="xs" />
                                                </p>
                                                {conv.unreadCount > 0 && (
                                                    <span className="bg-purple-600 text-white text-xs rounded-full px-2 py-0.5 ml-2">
                                                        {conv.unreadCount}
                                                    </span>
                                                )}
                                            </div>
                                            <p className="text-xs text-gray-500 truncate">{conv.lastMessage}</p>
                                            <p className="text-xs text-gray-400">{formatTime(conv.lastMessageDate)}</p>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* Messages Thread */}
                    <div className="flex-1 flex flex-col">
                        {!selectedConversation ? (
                            <div className="flex items-center justify-center h-full text-gray-400 px-4">
                                <div className="text-center">
                                    <MessageSquare size={64} className="mx-auto mb-4 text-gray-200" />
                                    <p>Select a conversation to view messages</p>
                                </div>
                            </div>
                        ) : (
                            <>
                                {/* Conversation Header */}
                                <div className="p-4 border-b bg-gray-50">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <button
                                                onClick={() => setSelectedConversation(null)}
                                                className="sm:hidden text-gray-600 hover:text-gray-800 transition"
                                            >
                                                <ArrowLeft size={20} />
                                            </button>
                                            <div className="w-10 h-10 bg-gray-200 rounded-full overflow-hidden">
                                                {selectedConversation.otherUser?.profileImage ? (
                                                    <img src={selectedConversation.otherUser.profileImage} alt="" className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                        <User size={20} />
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <p className="font-semibold flex items-center gap-2">
                                                    {getDisplayName(selectedConversation.otherUser)}
                                                    <DonationBadge badge={getDonationBadge(selectedConversation.otherUser)} size="xs" />
                                                </p>
                                                <p className="text-xs text-gray-500">{selectedConversation.otherUser?.id_public}</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={handleBlockUser}
                                                className="p-2 text-gray-600 hover:bg-red-100 hover:text-red-600 rounded-lg transition"
                                                title="Block user"
                                            >
                                                <Ban size={18} />
                                            </button>
                                            <button
                                                onClick={handleReportConversation}
                                                className="p-2 text-gray-600 hover:bg-orange-100 hover:text-orange-600 rounded-lg transition"
                                                title="Report conversation"
                                            >
                                                <Flag size={18} />
                                            </button>
                                            <button
                                                onClick={handleDeleteConversation}
                                                className="p-2 text-gray-600 hover:bg-red-100 hover:text-red-600 rounded-lg transition"
                                                title="Delete conversation"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {messages.length === 0 ? (
                                        <div className="flex items-center justify-center h-full text-gray-400">
                                            <p>No messages yet. Start the conversation!</p>
                                        </div>
                                    ) : (
                                        messages.map(msg => {
                                            const isSentByMe = msg.senderId.toString() === selectedConversation.otherUserId ? false : true;
                                            return (
                                                <div key={msg._id} className={`flex ${isSentByMe ? 'justify-end' : 'justify-start'} group`}>
                                                    <div className={`max-w-[70%] rounded-lg px-4 py-2 ${
                                                        isSentByMe 
                                                            ? 'bg-blue-500 text-white' 
                                                            : 'bg-gray-200 text-gray-800'
                                                    }`}>
                                                        <p className="text-sm whitespace-pre-wrap break-words">{msg.message}</p>
                                                        <div className="flex items-center justify-between gap-2 mt-1">
                                                            <p className={`text-xs ${isSentByMe ? 'text-blue-100' : 'text-gray-500'}`}>
                                                                {formatTime(msg.createdAt)}
                                                            </p>
                                                            {isSentByMe ? (
                                                                <button
                                                                    onClick={() => handleDeleteMessage(msg._id)}
                                                                    className="opacity-0 group-hover:opacity-100 transition p-1 hover:bg-white hover:bg-opacity-20 rounded"
                                                                    title="Delete message"
                                                                >
                                                                    <Trash2 size={14} />
                                                                </button>
                                                            ) : (
                                                                <button
                                                                    onClick={() => handleReportMessage(msg._id, msg.message)}
                                                                    className="opacity-0 group-hover:opacity-100 transition p-1 hover:bg-gray-300 rounded"
                                                                    title="Report message"
                                                                >
                                                                    <Flag size={14} />
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Send Message Form */}
                                <form onSubmit={handleSendMessage} className="p-4 border-t bg-gray-50">
                                    {userProfile?.allowMessages === false ? (
                                        <div className="text-center py-2 text-sm text-gray-500">
                                            You have disabled messages. Enable them in your profile settings to send messages.
                                        </div>
                                    ) : selectedConversation.otherUser?.allowMessages === false ? (
                                        <div className="text-center py-2 text-sm text-gray-500">
                                            This user has disabled messages
                                        </div>
                                    ) : (
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={newMessage}
                                                onChange={(e) => setNewMessage(e.target.value)}
                                                placeholder="Type a message..."
                                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                disabled={sending}
                                            />
                                            <button
                                                type="submit"
                                                disabled={sending || !newMessage.trim()}
                                                className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                            >
                                                {sending ? (
                                                    <>
                                                        <Loader2 className="animate-spin" size={16} />
                                                        Sending...
                                                    </>
                                                ) : (
                                                    'Send'
                                                )}
                                            </button>
                                        </div>
                                    )}
                                </form>
                            </>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// Moderator Warning Banner Component
const WarningBanner = ({ authToken, API_BASE_URL, userProfile }) => {
    const [warnings, setWarnings] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchWarnings = async () => {
            if (!authToken) {
                setLoading(false);
                return;
            }
            try {
                // Get warnings from userProfile or fetch if not available
                let userWarnings = [];
                
                if (userProfile?.warnings !== undefined) {
                    userWarnings = userProfile.warnings || [];
                } else {
                    // Fetch user profile to get warnings
                    const response = await axios.get(`${API_BASE_URL}/users/profile`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    userWarnings = response.data?.warnings || [];
                }
                
                // Filter to only active (non-lifted) warnings
                const activeWarnings = userWarnings.filter(w => !w.isLifted);
                setWarnings(activeWarnings);
            } catch (error) {
                console.error('Failed to fetch user profile:', error);
            } finally {
                setLoading(false);
            }
        };
        fetchWarnings();
    }, [authToken, API_BASE_URL, userProfile?.warnings]);

    if (loading || warnings.length === 0) {
        return null;
    }

    return (
        <div className="w-full flex justify-center">
            <div className="w-full max-w-5xl px-6">
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow-md mb-3">
                    <div className="flex items-start">
                        <div className="flex-shrink-0">
                            <AlertCircle className="h-6 w-6 text-yellow-400" />
                        </div>
                        <div className="ml-3 flex-1">
                            <h3 className="text-lg font-bold text-yellow-800">⚠️ Official Warning{warnings.length !== 1 ? 's' : ''} from Moderation Team</h3>
                            <div className="mt-3 text-yellow-700">
                                <p className="text-sm font-semibold mb-2">
                                    You have {warnings.length} active warning{warnings.length !== 1 ? 's' : ''}:
                                </p>
                                <div className="space-y-3">
                                    {warnings.map((warning, index) => (
                                        <div key={index} className="bg-yellow-100 p-2 rounded text-xs">
                                            <p className="font-semibold">Warning #{index + 1}</p>
                                            <p className="mt-1"><strong>Reason:</strong> {warning.reason}</p>
                                            <p className="mt-1"><strong>Date:</strong> {new Date(warning.date).toLocaleString('en-GB')}</p>
                                            {warning.category && <p className="mt-1"><strong>Category:</strong> {warning.category}</p>}
                                        </div>
                                    ))}
                                </div>
                                {warnings.length >= 3 && (
                                    <p className="text-xs mt-3 text-red-600 font-semibold">
                                        ⚠️ You have reached 3 warnings - your account is suspended. Contact moderators for appeal.
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// Poll Component for Broadcasts
const BroadcastPoll = ({ poll, onVote, isVoting, styles }) => {
    const [selectedOptions, setSelectedOptions] = useState([]);
    const hasEnded = poll.pollEndsAt && new Date() > new Date(poll.pollEndsAt);
    const hasVoted = poll.userVote && poll.userVote.length > 0;
    
    const handleOptionToggle = (index) => {
        if (hasVoted || hasEnded) return;
        
        setSelectedOptions(prev => {
            if (poll.allowMultipleChoices) {
                return prev.includes(index) 
                    ? prev.filter(i => i !== index)
                    : [...prev, index];
            } else {
                return [index];
            }
        });
    };
    
    const handleSubmitVote = () => {
        if (selectedOptions.length === 0 || isVoting) return;
        onVote(selectedOptions);
    };
    
    const getTotalVotes = () => {
        return poll.pollOptions?.reduce((sum, option) => sum + (option.votes || 0), 0) || 0;
    };
    
    const getOptionPercentage = (votes) => {
        const total = getTotalVotes();
        return total > 0 ? Math.round((votes / total) * 100) : 0;
    };
    
    return (
        <div className="mt-3">
            <h4 className={`font-medium ${styles.title} mb-2 text-base`}>{poll.pollQuestion}</h4>
            
            <div className="grid grid-cols-2 gap-2">
                {poll.pollOptions?.map((option, index) => {
                    const isSelected = selectedOptions.includes(index);
                    const hasUserVote = hasVoted && poll.userVote.includes(index);
                    const percentage = getOptionPercentage(option.votes || 0);
                    
                    return (
                        <div key={index} className="relative">
                            <button
                                onClick={() => handleOptionToggle(index)}
                                disabled={hasVoted || hasEnded || isVoting}
                                className={`w-full text-left p-2 rounded-md border transition-all text-sm ${
                                    hasVoted || hasEnded
                                        ? 'cursor-not-allowed opacity-60'
                                        : `cursor-pointer ${styles.optionBg} border-gray-300 hover:border-gray-400`
                                } ${
                                    isSelected || hasUserVote 
                                        ? `border-green-500 ${styles.optionBg}` 
                                        : ''
                                }`}
                            >
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center">
                                        <div className={`w-3.5 h-3.5 rounded mr-2.5 border-2 ${
                                            isSelected || hasUserVote 
                                                ? 'bg-green-500 border-green-500' 
                                                : 'border-gray-400'
                                        } ${poll.allowMultipleChoices ? '' : 'rounded-full'}`}>
                                            {(isSelected || hasUserVote) && (
                                                <Check size={10} className="text-white m-0.5" />
                                            )}
                                        </div>
                                        <span className={styles.text}>{option.text}</span>
                                        {hasUserVote && <span className="ml-2 text-green-600 text-xs font-medium">(Your vote)</span>}
                                    </div>
                                    {(hasVoted || hasEnded) && (
                                        <div className="flex items-center gap-2">
                                            <span className={`${styles.subtitle} text-xs`}>
                                                {option.votes || 0} votes ({percentage}%)
                                            </span>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Results bar */}
                                {(hasVoted || hasEnded) && percentage > 0 && (
                                    <div className="mt-1.5 bg-gray-200 rounded-full h-1.5">
                                        <div 
                                            className={`${styles.resultBar} h-1.5 rounded-full transition-all duration-300`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                )}
                            </button>
                        </div>
                    );
                })}
            </div>
            
            {!hasVoted && !hasEnded && (
                <button
                    onClick={handleSubmitVote}
                    disabled={selectedOptions.length === 0 || isVoting}
                    className={`mt-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                        selectedOptions.length === 0 || isVoting
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : styles.button
                    }`}
                >
                    {isVoting ? 'Voting...' : `Vote ${poll.allowMultipleChoices ? '(Multiple allowed)' : ''}`}
                </button>
            )}
            
            <div className={`mt-2 text-xs ${styles.subtitle} flex justify-between`}>
                <span>Total votes: {getTotalVotes()}</span>
                {poll.pollEndsAt && (
                    <span>
                        {hasEnded ? 'Poll ended' : `Ends: ${new Date(poll.pollEndsAt).toLocaleDateString('en-GB')}`}
                    </span>
                )}
            </div>
        </div>
    );
};

// System Broadcast Banner Component (for info/announcements - shows in banner area)
const BroadcastBanner = ({ authToken, API_BASE_URL }) => {
    const [broadcasts, setBroadcasts] = useState([]);
    const [dismissedIds, setDismissedIds] = useState(() => {
        const saved = localStorage.getItem('dismissedBroadcasts');
        return saved ? JSON.parse(saved) : [];
    });
    const [pollVotes, setPollVotes] = useState({});
    const [votingInProgress, setVotingInProgress] = useState({});

    useEffect(() => {
        const fetchBroadcasts = async () => {
            if (!authToken) return;
            try {
                const response = await axios.get(`${API_BASE_URL}/notifications`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                // Filter for broadcast/announcement types that are NOT warning/alert (show info, announcement, or undefined)
                const broadcastNotifications = (response.data || []).filter(n => {
                    const isBroadcastType = n.type === 'broadcast' || n.type === 'announcement';
                    const isNotUrgent = n.broadcastType !== 'warning' && n.broadcastType !== 'alert';
                    const isNotDismissed = !dismissedIds.includes(n._id);
                    return isBroadcastType && isNotUrgent && isNotDismissed;
                });
                setBroadcasts(broadcastNotifications);
            } catch (error) {
                console.error('Failed to fetch broadcasts:', error);
            }
        };
        fetchBroadcasts();
        // Refresh every 60 seconds for updates
        const interval = setInterval(fetchBroadcasts, 60000);
        return () => clearInterval(interval);
    }, [authToken, API_BASE_URL, dismissedIds]);

    const handleDismiss = (id) => {
        const newDismissed = [...dismissedIds, id];
        setDismissedIds(newDismissed);
        localStorage.setItem('dismissedBroadcasts', JSON.stringify(newDismissed));
        setBroadcasts(prev => prev.filter(b => b._id !== id));
    };

    const handlePollVote = async (notificationId, selectedOptions) => {
        if (!authToken || votingInProgress[notificationId]) return;
        
        setVotingInProgress(prev => ({ ...prev, [notificationId]: true }));
        
        // Optimistic update - update UI immediately
        const previousBroadcasts = broadcasts;
        setPollVotes(prev => ({ ...prev, [notificationId]: selectedOptions }));
        
        setBroadcasts(prev => prev.map(broadcast => {
            if (broadcast._id === notificationId) {
                // Calculate optimistic vote counts
                const updatedOptions = broadcast.pollOptions.map((option, index) => {
                    if (selectedOptions.includes(index)) {
                        return {
                            ...option,
                            votes: (option.votes || 0) + 1
                        };
                    }
                    return option;
                });
                
                return {
                    ...broadcast,
                    userVote: selectedOptions,
                    pollOptions: updatedOptions
                };
            }
            return broadcast;
        }));
        
        try {
            console.log('[POLL] Voting:', { notificationId, selectedOptions });
            
            const response = await axios.post(
                `${API_BASE_URL}/moderation/poll/vote`,
                { notificationId, selectedOptions },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            console.log('[POLL] Vote response:', response.data);
            
            // Update with actual server response
            setBroadcasts(prev => prev.map(broadcast => {
                if (broadcast._id === notificationId) {
                    return {
                        ...broadcast,
                        userVote: response.data.userVote || selectedOptions,
                        pollOptions: response.data.pollResults || broadcast.pollOptions
                    };
                }
                return broadcast;
            }));
        } catch (error) {
            console.error('[POLL] Failed to vote on poll:', error);
            console.error('[POLL] Error response:', error.response?.data);
            
            // Revert optimistic update on error
            setBroadcasts(previousBroadcasts);
            setPollVotes(prev => {
                const updated = { ...prev };
                delete updated[notificationId];
                return updated;
            });
        } finally {
            setVotingInProgress(prev => ({ ...prev, [notificationId]: false }));
        }
    };

    if (broadcasts.length === 0) return null;

    // Style configurations for different broadcast types
    const getStyles = (broadcastType) => {
        if (broadcastType === 'announcement') {
            // Announcement: Purple/violet - more prominent
            return {
                bg: 'bg-purple-50',
                border: 'border-purple-500',
                icon: 'text-purple-500',
                title: 'text-purple-800',
                text: 'text-purple-700',
                subtitle: 'text-purple-500',
                dismissBtn: 'text-purple-400 hover:text-purple-600',
                emoji: 'ℹ️',
                label: 'Announcement'
            };
        }
        if (broadcastType === 'poll') {
            // Poll: Green - interactive
            return {
                bg: 'bg-green-50',
                border: 'border-green-500',
                icon: 'text-green-500',
                title: 'text-green-800',
                text: 'text-green-700',
                subtitle: 'text-green-500',
                dismissBtn: 'text-green-400 hover:text-green-600',
                emoji: 'ℹ️',
                label: 'Poll',
                button: 'bg-green-500 hover:bg-green-600 text-white',
                optionBg: 'bg-green-100 hover:bg-green-200',
                resultBar: 'bg-green-400'
            };
        }
        // Info: Blue - standard informational
        return {
            bg: 'bg-blue-50',
            border: 'border-blue-400',
            icon: 'text-blue-400',
            title: 'text-blue-800',
            text: 'text-blue-700',
            subtitle: 'text-blue-500',
            dismissBtn: 'text-blue-400 hover:text-blue-600',
            emoji: 'ℹ️',
            label: 'Info'
        };
    };

    return (
        <div className="w-full max-w-4xl mx-auto">
            {broadcasts.map(broadcast => {
                const styles = getStyles(broadcast.broadcastType);
                return (
                    <div key={broadcast._id} className={`${styles.bg} border-l-4 ${styles.border} p-3 rounded-lg shadow-sm mb-2`}>
                            <div className="flex items-start">
                                <div className="flex-shrink-0">
                                    <Info className={`h-5 w-5 ${styles.icon}`} />
                                </div>
                                <div className="ml-2.5 flex-1">
                                    <div className="flex justify-between items-start">
                                        <h3 className={`text-base font-bold ${styles.title}`}>
                                            {styles.emoji} {broadcast.title || `System ${styles.label}`}
                                        </h3>
                                        <button 
                                            onClick={() => handleDismiss(broadcast._id)}
                                            className={`${styles.dismissBtn} ml-2`}
                                        >
                                            <X size={16} />
                                        </button>
                                    </div>
                                    {broadcast.message && (
                                        <p className={`mt-1.5 ${styles.text} text-sm`}>{broadcast.message}</p>
                                    )}
                                    
                                    {broadcast.broadcastType === 'poll' && broadcast.pollQuestion && (
                                        <BroadcastPoll
                                            poll={broadcast}
                                            onVote={(selectedOptions) => handlePollVote(broadcast._id, selectedOptions)}
                                            isVoting={votingInProgress[broadcast._id] || false}
                                            styles={styles}
                                        />
                                    )}
                                    
                                    <p className={`mt-1.5 ${styles.subtitle} text-xs`}>
                                        {new Date(broadcast.createdAt).toLocaleString('en-GB')}
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                })}
        </div>
    );
};

// Urgent Broadcast Popup Component (for warning/alert types - shows as modal popup)
const UrgentBroadcastPopup = ({ authToken, API_BASE_URL }) => {
    const [urgentBroadcast, setUrgentBroadcast] = useState(null);
    const [acknowledgedIds, setAcknowledgedIds] = useState(() => {
        const saved = localStorage.getItem('acknowledgedUrgentBroadcasts');
        return saved ? JSON.parse(saved) : [];
    });

    useEffect(() => {
        const fetchUrgentBroadcasts = async () => {
            if (!authToken) return;
            try {
                const response = await axios.get(`${API_BASE_URL}/notifications`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                // Filter for urgent broadcast types (warning/alert) - these MUST have explicit broadcastType
                const urgentNotifications = (response.data || []).filter(n => {
                    const isBroadcastType = n.type === 'broadcast' || n.type === 'announcement';
                    const isUrgent = n.broadcastType === 'warning' || n.broadcastType === 'alert';
                    const isNotAcknowledged = !acknowledgedIds.includes(n._id);
                    return isBroadcastType && isUrgent && isNotAcknowledged;
                });
                // Show the most recent one
                if (urgentNotifications.length > 0) {
                    setUrgentBroadcast(urgentNotifications[0]);
                } else {
                    setUrgentBroadcast(null);
                }
            } catch (error) {
                console.error('Failed to fetch urgent broadcasts:', error);
            }
        };
        fetchUrgentBroadcasts();
        // Check every 60 seconds for urgent broadcasts
        const interval = setInterval(fetchUrgentBroadcasts, 60000);
        return () => clearInterval(interval);
    }, [authToken, API_BASE_URL, acknowledgedIds]);

    const handleAcknowledge = () => {
        if (urgentBroadcast) {
            const newAcknowledged = [...acknowledgedIds, urgentBroadcast._id];
            setAcknowledgedIds(newAcknowledged);
            localStorage.setItem('acknowledgedUrgentBroadcasts', JSON.stringify(newAcknowledged));
            setUrgentBroadcast(null);
        }
    };

    if (!urgentBroadcast) return null;

    const isAlert = urgentBroadcast.broadcastType === 'alert';
    const bgColor = isAlert ? 'bg-red-50' : 'bg-orange-50';
    const borderColor = isAlert ? 'border-red-500' : 'border-orange-500';
    const textColor = isAlert ? 'text-red-800' : 'text-orange-800';
    const iconColor = isAlert ? 'text-red-500' : 'text-orange-500';
    const btnColor = isAlert ? 'bg-red-600 hover:bg-red-700' : 'bg-orange-600 hover:bg-orange-700';

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[9999]">
            <div className={`${bgColor} border-2 ${borderColor} rounded-xl shadow-2xl max-w-lg w-full p-6 animate-pulse-once`}>
                <div className="flex items-start">
                    <div className="flex-shrink-0">
                        <AlertTriangle className={`h-8 w-8 ${iconColor}`} />
                    </div>
                    <div className="ml-4 flex-1">
                        <h3 className={`text-xl font-bold ${textColor}`}>
                            {isAlert ? '🚨 URGENT ALERT' : '⚠️ Important Notice'}
                        </h3>
                        <h4 className={`text-lg font-semibold ${textColor} mt-2`}>
                            {urgentBroadcast.title || 'System Message'}
                        </h4>
                        <p className={`mt-3 ${textColor} text-sm leading-relaxed`}>
                            {urgentBroadcast.message}
                        </p>
                        <p className={`mt-3 text-xs ${iconColor}`}>
                            {new Date(urgentBroadcast.createdAt).toLocaleString('en-GB')}
                        </p>
                        <button
                            onClick={handleAcknowledge}
                            className={`mt-4 w-full ${btnColor} text-white font-semibold py-3 px-4 rounded-lg transition-colors`}
                        >
                            I Understand
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// Notification Panel Component
const NotificationPanel = ({ authToken, API_BASE_URL, onClose, showModalMessage, onNotificationChange, onViewAnimal }) => {
    const [notifications, setNotifications] = useState([]);
    const [loading, setLoading] = useState(true);
    const [processing, setProcessing] = useState(null);

    useEffect(() => {
        fetchNotifications();
    }, []);

    const fetchNotifications = async () => {
        try {
            console.log('[Notifications] Fetching from:', `${API_BASE_URL}/notifications`);
            const response = await axios.get(`${API_BASE_URL}/notifications`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            console.log('[Notifications] Received:', response.data);
            
            // Fetch missing animal images for notifications that don't have them
            const notificationsWithImages = await Promise.all(
                (response.data || []).map(async (notification) => {
                    // If animalImageUrl is missing, try to fetch the animal details
                    if (!notification.animalImageUrl && notification.animalId_public) {
                        try {
                            const animalRes = await axios.get(`${API_BASE_URL}/public/global/animals?id_public=${notification.animalId_public}`, {
                                headers: { Authorization: `Bearer ${authToken}` }
                            });
                            if (animalRes.data?.length > 0) {
                                notification.animalImageUrl = animalRes.data[0].imageUrl || '';
                            }
                        } catch (err) {
                            console.warn('Failed to fetch image for animal:', notification.animalId_public, err);
                        }
                    }
                    return notification;
                })
            );
            
            setNotifications(notificationsWithImages || []);
        } catch (error) {
            console.error('Error fetching notifications:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleReject = async (notificationId) => {
        setProcessing(notificationId);
        try {
            await axios.post(`${API_BASE_URL}/notifications/${notificationId}/reject`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage('Rejected', 'Request rejected and link removed');
            fetchNotifications();
            if (onNotificationChange) onNotificationChange();
        } catch (error) {
            console.error('Error rejecting notification:', error);
            showModalMessage('Error', 'Failed to reject request');
        } finally {
            setProcessing(null);
        }
    };

    const handleAcceptTransfer = async (transferId) => {
        setProcessing(transferId);
        try {
            await axios.post(`${API_BASE_URL}/transfers/${transferId}/accept`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage('Success', 'Transfer accepted! Animal has been added to your account.');
            fetchNotifications();
            if (onNotificationChange) onNotificationChange();
        } catch (error) {
            console.error('Error accepting transfer:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to accept transfer');
        } finally {
            setProcessing(null);
        }
    };

    const handleDeclineTransfer = async (transferId) => {
        setProcessing(transferId);
        try {
            await axios.post(`${API_BASE_URL}/transfers/${transferId}/decline`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage('Declined', 'Transfer declined');
            fetchNotifications();
            if (onNotificationChange) onNotificationChange();
        } catch (error) {
            console.error('Error declining transfer:', error);
            showModalMessage('Error', 'Failed to decline transfer');
        } finally {
            setProcessing(null);
        }
    };

    const handleAcceptViewOnly = async (transferId) => {
        setProcessing(transferId);
        try {
            await axios.post(`${API_BASE_URL}/transfers/${transferId}/accept-view-only`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage('Success', 'View-only access accepted');
            fetchNotifications();
            if (onNotificationChange) onNotificationChange();
        } catch (error) {
            console.error('Error accepting view-only:', error);
            showModalMessage('Error', 'Failed to accept view-only access');
        } finally {
            setProcessing(null);
        }
    };

    const handleDelete = async (notificationId) => {
        try {
            console.log('[handleDelete] Deleting notification:', notificationId);
            await axios.delete(`${API_BASE_URL}/notifications/${notificationId}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            // Wait for the backend to process before refreshing
            await fetchNotifications();
            
            if (onNotificationChange) {
                console.log('[handleDelete] Calling onNotificationChange');
                // Small delay to ensure backend count is updated
                setTimeout(() => onNotificationChange(), 100);
            }
        } catch (error) {
            console.error('Error deleting notification:', error);
        }
    };

    const handleApprove = async (notificationId) => {
        setProcessing(notificationId);
        try {
            await axios.post(`${API_BASE_URL}/notifications/${notificationId}/approve`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            fetchNotifications();
            if (onNotificationChange) onNotificationChange();
        } catch (error) {
            console.error('Error acknowledging notification:', error);
        } finally {
            setProcessing(null);
        }
    };

    const pendingNotifications = notifications.filter(n => 
        n.status === 'pending' && 
        n.type !== 'broadcast' && 
        n.type !== 'announcement'
    );
    const otherNotifications = notifications.filter(n => 
        n.status !== 'pending' && 
        n.type !== 'broadcast' && 
        n.type !== 'announcement'
    );

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center border-b p-4">
                    <h3 className="text-xl font-bold text-gray-800">Notifications</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800">
                        <X size={24} />
                    </button>
                </div>

                <div className="flex-grow overflow-y-auto p-4 space-y-4">
                    {loading ? (
                        <div className="flex justify-center py-8">
                            <Loader2 className="animate-spin" size={32} />
                        </div>
                    ) : notifications.length === 0 ? (
                        <p className="text-center text-gray-500 py-8">No notifications</p>
                    ) : (
                        <>
                            {pendingNotifications.length > 0 && (
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-2">Pending Requests</h4>
                                    {pendingNotifications.map(notification => (
                                        <div key={notification._id} className={`border rounded-lg p-4 mb-2 ${
                                            notification.type === 'content_edited' 
                                                ? 'bg-orange-100 border-orange-400' 
                                                : !notification.read ? 'bg-primary/20 border-primary' : 'bg-white'
                                        }`}>
                                            {/* Moderation Notice Header */}
                                            {notification.type === 'content_edited' && (
                                                <div className="flex items-center text-orange-700 font-semibold mb-2">
                                                    <span className="mr-2">⚠️</span>
                                                    <span>Moderation Notice</span>
                                                </div>
                                            )}
                                            <div className="flex items-start space-x-3 mb-2">
                                                {/* Moderation Icon for content_edited */}
                                                {notification.type === 'content_edited' && (
                                                    <div className="flex-shrink-0 w-16 h-16 bg-orange-200 rounded-md overflow-hidden flex items-center justify-center">
                                                        <Shield size={32} className="text-orange-600" />
                                                    </div>
                                                )}
                                                {/* Animal Thumbnail - hide for content_edited */}
                                                {notification.type !== 'content_edited' && (
                                                <div 
                                                    className="flex-shrink-0 w-16 h-16 bg-gray-200 rounded-md overflow-hidden cursor-pointer hover:opacity-80 transition-opacity"
                                                    onClick={() => {
                                                        if (notification.animalId_public && onViewAnimal) {
                                                            onViewAnimal(notification.animalId_public, true);
                                                        }
                                                    }}
                                                    title="Click to view animal"
                                                >
                                                    {notification.animalImageUrl ? (
                                                        <img 
                                                            src={notification.animalImageUrl} 
                                                            alt={notification.animalName}
                                                            className="w-full h-full object-cover"
                                                        />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-500">
                                                            <AlertCircle size={28} />
                                                        </div>
                                                    )}
                                                </div>
                                                )}
                                                {/* Notification Message */}
                                                <div className="flex-1">
                                                    <p className="text-sm text-gray-700">{notification.message}</p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {new Date(notification.createdAt).toLocaleString('en-GB')}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="flex space-x-2">
                                                {/* Transfer Request */}
                                                {notification.type === 'transfer_request' && notification.transferId && (
                                                    <>
                                                        <button
                                                            onClick={() => handleAcceptTransfer(notification.transferId)}
                                                            disabled={processing === notification.transferId}
                                                            className="flex items-center space-x-1 bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                                        >
                                                            <CheckCircle size={14} />
                                                            <span>Accept</span>
                                                        </button>
                                                        <button
                                                            onClick={() => handleDeclineTransfer(notification.transferId)}
                                                            disabled={processing === notification.transferId}
                                                            className="flex items-center space-x-1 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                                        >
                                                            <XCircle size={14} />
                                                            <span>Decline</span>
                                                        </button>
                                                    </>
                                                )}
                                                {/* View-Only Offer */}
                                                {notification.type === 'view_only_offer' && notification.transferId && (
                                                    <>
                                                        <button
                                                            onClick={() => handleAcceptViewOnly(notification.transferId)}
                                                            disabled={processing === notification.transferId}
                                                            className="flex items-center space-x-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                                        >
                                                            <CheckCircle size={14} />
                                                            <span>Accept</span>
                                                        </button>
                                                        <button
                                                            onClick={() => handleDeclineTransfer(notification.transferId)}
                                                            disabled={processing === notification.transferId}
                                                            className="flex items-center space-x-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                                        >
                                                            <XCircle size={14} />
                                                            <span>Decline</span>
                                                        </button>
                                                    </>
                                                )}
                                                {/* Link Request (old functionality) */}
                                                {notification.type === 'link_request' && (
                                                    <>
                                                        <button
                                                            onClick={() => handleReject(notification._id)}
                                                            disabled={processing === notification._id}
                                                            className="flex items-center space-x-1 bg-primary border-2 border-black text-black hover:bg-primary/90 px-3 py-1 rounded text-sm disabled:opacity-50"
                                                        >
                                                            <XCircle size={14} />
                                                            <span>Reject</span>
                                                        </button>
                                                        <button
                                                            onClick={() => handleDelete(notification._id)}
                                                            className="flex items-center space-x-1 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm"
                                                        >
                                                            <Trash2 size={14} />
                                                            <span>Delete</span>
                                                        </button>
                                                    </>
                                                )}
                                                {/* Breeder and Parent Requests */}
                                                {(notification.type === 'breeder_request' || notification.type === 'parent_request') && (
                                                    <>
                                                        <button
                                                            onClick={() => handleReject(notification._id)}
                                                            disabled={processing === notification._id}
                                                            className="flex items-center space-x-1 bg-accent hover:bg-accent/80 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                                        >
                                                            <XCircle size={14} />
                                                            <span>Reject</span>
                                                        </button>
                                                        <button
                                                            onClick={() => handleDelete(notification._id)}
                                                            className="flex items-center space-x-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm"
                                                        >
                                                            <Trash2 size={14} />
                                                            <span>Delete</span>
                                                        </button>
                                                    </>
                                                )}
                                                {/* Content Edited - Acknowledge button */}
                                                {notification.type === 'content_edited' && (
                                                    <button
                                                        onClick={() => handleApprove(notification._id)}
                                                        disabled={processing === notification._id}
                                                        className="flex items-center space-x-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                                    >
                                                        <CheckCircle size={14} />
                                                        <span>Acknowledge</span>
                                                    </button>
                                                )}
                                                {/* Delete button for other notifications */}
                                                {notification.type !== 'link_request' && 
                                                 notification.type !== 'breeder_request' &&
                                                 notification.type !== 'parent_request' &&
                                                 notification.type !== 'transfer_request' && 
                                                 notification.type !== 'view_only_offer' &&
                                                 notification.type !== 'content_edited' && (
                                                    <button
                                                        onClick={() => handleDelete(notification._id)}
                                                        className="flex items-center space-x-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm"
                                                    >
                                                        <Trash2 size={14} />
                                                        <span>Delete</span>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {otherNotifications.length > 0 && (
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-2">History</h4>
                                    {otherNotifications.map(notification => (
                                        <div key={notification._id} className="border rounded-lg p-4 mb-2 bg-gray-50">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-grow">
                                                    <p className="text-sm text-gray-700 mb-1">{notification.message}</p>
                                                    <p className="text-xs text-gray-500">
                                                        {new Date(notification.createdAt).toLocaleString('en-GB')} ? 
                                                        <span className={`ml-1 ${notification.status === 'approved' ? 'text-green-600' : 'text-red-600'}`}>
                                                            {notification.status}
                                                        </span>
                                                    </p>
                                                </div>
                                                <button
                                                    onClick={() => handleDelete(notification._id)}
                                                    className="text-gray-400 hover:text-red-600 ml-2"
                                                >
                                                    <X size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}
                </div>
            </div>
        </div>
    );
};

const App = () => {
    const navigate = useNavigate();
    const location = useLocation();
    const [authToken, setAuthToken] = useState(() => {
        try {
            return localStorage.getItem('authToken') || null;
        } catch (e) {
            console.warn('Could not read authToken from localStorage', e);
            return null;
        }
    });
    const [userProfile, setUserProfile] = useState(null);

    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
    const [userCount, setUserCount] = useState('...');
    
    // Derive currentView from URL path
    const currentView = location.pathname.split('/')[1] || 'list';
    
    // Detect mobile/app environment
    React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);
    
    // Version check - clear localStorage cache if version changed
    React.useEffect(() => {
        const storedVersion = localStorage.getItem('appVersion');
        if (storedVersion !== APP_VERSION) {
            console.log(`[Cache Clear] App version changed from ${storedVersion} to ${APP_VERSION}`);
            
            // Clear all filter-related localStorage items
            const filterKeys = [
                'animalList_statusFilter',
                'animalList_searchInput',
                'animalList_appliedNameFilter',
                'animalList_selectedGenders',
                'animalList_selectedSpecies',
                'animalList_statusFilterPregnant',
                'animalList_statusFilterNursing',
                'animalList_statusFilterMating',
                'animalList_ownedFilterActive',
                'animalList_publicFilter'
            ];
            
            filterKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log(`[Cache Clear] Removed ${key}`);
            });
            
            // Update stored version
            localStorage.setItem('appVersion', APP_VERSION);
            console.log('[Cache Clear] Cache cleared successfully');
        }
    }, []);
    
    // Fetch and display user count on login/register screen
    useEffect(() => {
        const fetchUserCount = async () => {
            try {
                console.log('Fetching user count from:', `${API_BASE_URL}/public/users/count`);
                const response = await fetch(`${API_BASE_URL}/public/users/count`);
                console.log('User count response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('User count data:', data);
                    const count = data.totalUsers || 'many';
                    const formattedCount = typeof count === 'number' ? count.toLocaleString() : count;
                    console.log('Setting user count to:', formattedCount);
                    setUserCount(formattedCount);
                } else {
                    console.log('User count response not ok:', await response.text());
                }
            } catch (err) {
                console.error('Failed to fetch user count:', err);
                // Keep the "..." placeholder if fetch fails
            }
        };
        fetchUserCount();
    }, [API_BASE_URL, setUserCount]);
    
    // Tutorial context hook
 
    const [animalToEdit, setAnimalToEdit] = useState(null);
    const [speciesToAdd, setSpeciesToAdd] = useState(null); 
    const [speciesOptions, setSpeciesOptions] = useState([]); 
    const [speciesConfigs, setSpeciesConfigs] = useState({}); // Field replacements per species
    const [speciesSearchTerm, setSpeciesSearchTerm] = useState('');
    const [speciesCategoryFilter, setSpeciesCategoryFilter] = useState('All');
    const [showModal, setShowModal] = useState(false);
    const [modalMessage, setModalMessage] = useState({ title: '', message: '' });
    const [isRegister, setIsRegister] = useState(false); 
    
    const [showNotifications, setShowNotifications] = useState(false);
    const [notificationCount, setNotificationCount] = useState(0);
    
    const [showMessages, setShowMessages] = useState(false);
    const [unreadMessageCount, setUnreadMessageCount] = useState(0);
    const [conversations, setConversations] = useState([]);
    const [selectedConversation, setSelectedConversation] = useState(null);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [sendingMessage, setSendingMessage] = useState(false);

    const [showUserSearchModal, setShowUserSearchModal] = useState(false);
    const [viewingPublicProfile, setViewingPublicProfile] = useState(null);
    const [viewingPublicAnimal, setViewingPublicAnimal] = useState(null);
    const [publicAnimalViewHistory, setPublicAnimalViewHistory] = useState([]); // Navigation history for public animals
    const [viewAnimalBreederInfo, setViewAnimalBreederInfo] = useState(null);
    const [animalToView, setAnimalToView] = useState(null);
    const [animalViewHistory, setAnimalViewHistory] = useState([]); // Navigation history stack for animals
    const [detailViewTab, setDetailViewTab] = useState(1); // Tab for detail view
    const [showTabs, setShowTabs] = useState(true); // Toggle for collapsible tabs panel
    const [sireData, setSireData] = useState(null);
    const [damData, setDamData] = useState(null);
    const [offspringData, setOffspringData] = useState([]);
    
    // Clear history when animal view is completely closed
    React.useEffect(() => {
        if (!animalToView) {
            setAnimalViewHistory([]);
        }
    }, [animalToView]);
    
    // Clear history when public animal view is completely closed
    React.useEffect(() => {
        if (!viewingPublicAnimal) {
            setPublicAnimalViewHistory([]);
        }
    }, [viewingPublicAnimal]);
    
    // Fetch parent animals when viewing an animal
    React.useEffect(() => {
        if (!animalToView) {
            setSireData(null);
            setDamData(null);
            setOffspringData([]);
            return;
        }
        
        const fetchPedigreeData = async () => {
            try {
                const sireId = animalToView.sireId_public || animalToView.fatherId_public;
                const damId = animalToView.damId_public || animalToView.motherId_public;
                
                // Fetch parents using /any/ endpoint to get parents regardless of ownership
                if (sireId) {
                    const response = await axios.get(`${API_BASE_URL}/animals/any/${sireId}`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    setSireData(response.data);
                }
                
                if (damId) {
                    const response = await axios.get(`${API_BASE_URL}/animals/any/${damId}`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    setDamData(response.data);
                }
                
                // Fetch offspring using the dedicated offspring endpoint
                try {
                    const offspringResponse = await axios.get(`${API_BASE_URL}/animals/${animalToView.id_public}/offspring`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    
                    const litters = offspringResponse.data || [];
                    // Flatten offspring from all litters into a single array
                    const allOffspring = [];
                    litters.forEach(litter => {
                        if (litter.offspring && Array.isArray(litter.offspring)) {
                            allOffspring.push(...litter.offspring);
                        }
                    });
                    
                    console.log('Fetched offspring from API:', allOffspring);
                    setOffspringData(allOffspring);
                } catch (e) {
                    console.log('No offspring endpoint available or no offspring found:', e.message);
                    setOffspringData([]);
                }
            } catch (error) {
                console.error('Error fetching pedigree data:', error);
            }
        };
        
        fetchPedigreeData();
    }, [animalToView, authToken]);
    
    const [showPedigreeChart, setShowPedigreeChart] = useState(false);
    const [copySuccessAnimal, setCopySuccessAnimal] = useState(false);
    const [showImageModal, setShowImageModal] = useState(false);
    const [enlargedImageUrl, setEnlargedImageUrl] = useState(null);
    const [breedingRecordLitters, setBreedingRecordLitters] = useState({});
    const [expandedBreedingRecords, setExpandedBreedingRecords] = useState({});
    const [showCreateLitterModal, setShowCreateLitterModal] = useState(false);
    const [showLinkLitterModal, setShowLinkLitterModal] = useState(false);
    const [breedingRecordForLitter, setBreedingRecordForLitter] = useState(null);

    // Fetch litter data when breeding records expand (for male/female counts and COI)
    React.useEffect(() => {
        if (!animalToView?.breedingRecords?.length || !authToken) return;
        Object.entries(expandedBreedingRecords).forEach(([idxStr, isExpanded]) => {
            if (!isExpanded) return;
            const idx = parseInt(idxStr);
            const record = animalToView.breedingRecords[idx];
            if (!record?.litterId || breedingRecordLitters[record.litterId] !== undefined) return;
            axios.get(`${API_BASE_URL}/litters`, { headers: { Authorization: `Bearer ${authToken}` } })
                .then(res => {
                    const litter = res.data.find(l => l.litter_id_public === record.litterId);
                    if (litter) setBreedingRecordLitters(prev => ({ ...prev, [record.litterId]: litter }));
                })
                .catch(() => {});
        });
    }, [expandedBreedingRecords, animalToView?.breedingRecords, authToken, API_BASE_URL]);
    
    const [showBugReportModal, setShowBugReportModal] = useState(false);
    const [bugReportCategory, setBugReportCategory] = useState('Bug');
    const [bugReportDescription, setBugReportDescription] = useState('');
    const [bugReportSubmitting, setBugReportSubmitting] = useState(false);
    
    const [showFeedbackModal, setShowFeedbackModal] = useState(false);
    const [feedbackSpecies, setFeedbackSpecies] = useState('');
    const [feedbackText, setFeedbackText] = useState('');
    const [feedbackSubmitting, setFeedbackSubmitting] = useState(false);
    
    const [showWelcomeGuide, setShowWelcomeGuide] = useState(false);
    const [hasSeenWelcomeGuide, setHasSeenWelcomeGuide] = useState(false);
    
    const [hasSeenDonationHighlight, setHasSeenDonationHighlight] = useState(() => {
        return localStorage.getItem('hasSeenDonationHighlight') === 'true';
    });
    
    const [showTermsModal, setShowTermsModal] = useState(false);
    const [showPrivacyModal, setShowPrivacyModal] = useState(false);
    
    // Animals for genetics calculator
    const [myAnimalsForCalculator, setMyAnimalsForCalculator] = useState([]);
    
    // Available animals showcase (mixed: for sale + for stud)
    const [availableAnimals, setAvailableAnimals] = useState([]);
    const [currentAvailableIndex, setCurrentAvailableIndex] = useState(0);
    
    // Transfer modal states
    const [showTransferModal, setShowTransferModal] = useState(false);
    const [transferAnimal, setTransferAnimal] = useState(null);
    const [preSelectedTransferAnimal, setPreSelectedTransferAnimal] = useState(null);
    const [preSelectedTransactionType, setPreSelectedTransactionType] = useState(null);
    const [budgetModalOpen, setBudgetModalOpen] = useState(false);
    const [transferUserQuery, setTransferUserQuery] = useState('');
    const [transferUserResults, setTransferUserResults] = useState([]);
    const [transferSelectedUser, setTransferSelectedUser] = useState(null);
    const [transferSearching, setTransferSearching] = useState(false);
    const [transferSearchPerformed, setTransferSearchPerformed] = useState(false);
    const [transferPrice, setTransferPrice] = useState('');
    const [transferNotes, setTransferNotes] = useState('');
    
    // Community banner states
    const [communityUsers, setCommunityUsers] = useState([]);
    const scrollContainerRef = useRef(null);

    // Tutorial modal states
    const [showInfoTab, setShowInfoTab] = useState(false);
    const [showAdminPanel, setShowAdminPanel] = useState(false);
    const [showProfileMenu, setShowProfileMenu] = useState(false);
    const profileMenuDesktopRef = useRef(null);
    const profileMenuMobileRef = useRef(null);
    const [showModReportQueue, setShowModReportQueue] = useState(false);
    const [modCurrentContext, setModCurrentContext] = useState(null);
    const [inModeratorMode, setInModeratorMode] = useState(() => {
        if (typeof window !== 'undefined') {
            return localStorage.getItem('moderationAuthenticated') === 'true';
        }
        return false;
    });
    const [showModerationAuthModal, setShowModerationAuthModal] = useState(false);
    const [maintenanceMode, setMaintenanceMode] = useState(false);
    const [maintenanceMessage, setMaintenanceMessage] = useState('');
    const [showUrgentNotification, setShowUrgentNotification] = useState(false);
    const [urgentNotificationData, setUrgentNotificationData] = useState({ title: '', content: '' });

    const timeoutRef = useRef(null);
    const consecutiveAuthErrors = useRef(0);
    const activeEvents = ['mousemove', 'keydown', 'scroll', 'click'];

    const showModalMessage = useCallback((title, message) => {
        setModalMessage({ title, message });
        setShowModal(true);
    }, []);

    const handleLogout = useCallback((expired = false) => {
        setAuthToken(null);
        setUserProfile(null);
        setInModeratorMode(false);
        setShowAdminPanel(false);
        setShowModReportQueue(false);
        localStorage.removeItem('authToken');
        localStorage.removeItem('moderationAuthenticated');
        navigate('/');
        if (expired) {
            showModalMessage('Session Expired', 'You were logged out due to 30 minutes of inactivity.');
        }
    }, [showModalMessage]);

    const handleModQuickFlag = useCallback(async (flagData) => {
        console.log('[MOD ACTION] HANDLER CALLED with:', flagData);
        try {
            console.log('[MOD ACTION] Inside try block');
            console.log('[MOD ACTION] Starting action:', flagData);
            console.log('[MOD ACTION] API_BASE_URL:', API_BASE_URL);
            console.log('[MOD ACTION] authToken:', authToken ? 'present' : 'MISSING');

            // Handle different action types
            if (flagData.action === 'flag') {
                // Create a report for flagged content
                const reportType = flagData.context?.type === 'profile' ? 'profile' : 
                                  flagData.context?.type === 'animal' ? 'animal' : 'message';
                
                // Get the correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                const reportData = {
                    reason: flagData.reason,
                    category: flagData.category,
                    description: `Moderator flag: ${flagData.reason}`,
                    reportedContentId: flagData.context?.id,
                    reportedUserId: userId,
                    isModeratorReport: true
                };

                console.log('[MOD ACTION FLAG] Submitting flag:', { reportType, reportData });

                const response = await axios.post(
                    `${API_BASE_URL}/reports/${reportType}`,
                    reportData,
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION FLAG] Success:', response.data);
                showModalMessage('Flag Submitted', 'Content has been flagged and added to the report queue.');
            } 
            else if (flagData.action === 'edit') {
                // Edit/redact content fields
                const contentType = flagData.context?.type;
                const contentId = flagData.context?.id;
                
                console.log('[MOD ACTION EDIT] Submitting edit:', { contentType, contentId, fieldEdits: flagData.fieldEdits });
                
                const response = await axios.patch(
                    `${API_BASE_URL}/moderation/content/${contentType}/${contentId}/edit`,
                    {
                        fieldEdits: flagData.fieldEdits,
                        reason: flagData.reason
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION EDIT] Success:', response.data);
                showModalMessage('Content Edited', 'Content has been updated successfully.');
                // Refresh the current view
                window.location.reload();
            }
            else if (flagData.action === 'warn') {
                // Warn user - get correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION WARN] Warning user:', { userId, reason: flagData.reason, category: flagData.category });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/warn`,
                    {
                        reason: flagData.reason,
                        category: flagData.category
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION WARN] Success:', response.data);
                showModalMessage('Warning Sent', `User has been warned. Total warnings: ${response.data.warningCount}`);
            }
            else if (flagData.action === 'suspend') {
                // Suspend user - get correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION SUSPEND] Suspending user:', { userId, reason: flagData.reason, durationDays: flagData.durationDays });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/status`,
                    {
                        status: 'suspended',
                        reason: flagData.reason,
                        durationDays: flagData.durationDays
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION SUSPEND] Success:', response.data);
                
                // Check if the suspended user is the current logged-in user
                const isSuspendedUserCurrentUser = userProfile && userProfile.id_public === userId;
                
                if (isSuspendedUserCurrentUser) {
                    // Log out the suspended user
                    console.log('[MOD ACTION SUSPEND] Suspended user is current user - logging them out');
                    
                    // Calculate suspension end time
                    const suspensionEndTime = new Date().getTime() + (flagData.durationDays * 24 * 60 * 60 * 1000);
                    
                    // Store suspension info for display on login screen
                    localStorage.setItem('suspensionEndTime', suspensionEndTime.toString());
                    localStorage.setItem('suspensionReason', flagData.reason || 'Your account has been suspended.');
                    
                    // Log out
                    setAuthToken(null);
                    setUserProfile(null);
                    try {
                        localStorage.removeItem('authToken');
                    } catch (e) {
                        console.warn('Could not clear authToken from localStorage', e);
                    }
                    
                    // Show suspension message with timer
                    showModalMessage(
                        'Account Suspended',
                        `Your account has been suspended for ${flagData.durationDays} days. Reason: ${flagData.reason || 'No reason provided'}. You will be able to log back in after the suspension period ends.`
                    );
                    
                    // Redirect to login
                    navigate('/');
                } else {
                    showModalMessage('User Suspended', `User has been suspended for ${flagData.durationDays} days.`);
                }
            }
            else if (flagData.action === 'ban') {
                // Ban user - get correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION BAN] Banning user:', { userId, reason: flagData.reason, ipBan: flagData.ipBan });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/status`,
                    {
                        status: 'banned',
                        reason: flagData.reason,
                        ipBan: flagData.ipBan
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION BAN] Success:', response.data);
                showModalMessage('User Banned', 'User has been permanently banned.');
            }
            else if (flagData.action === 'lift-warning') {
                // Lift warning from user
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION LIFT_WARNING] Lifting warning for user:', { userId, reason: flagData.reason, warningIndex: flagData.warningIndex });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/lift-warning`,
                    {
                        reason: flagData.reason,
                        warningIndex: flagData.warningIndex
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION LIFT_WARNING] Success:', response.data);
                showModalMessage('Warning Lifted', `User's warning count is now ${response.data.warningCount}.`);
                
                // Refetch user profile to update warning banner
                if (userProfile && userProfile._id === userId) {
                    try {
                        const updatedProfile = await axios.get(`${API_BASE_URL}/users/profile`, {
                            headers: { Authorization: `Bearer ${authToken}` }
                        });
                        setUserProfile(updatedProfile.data);
                    } catch (err) {
                        console.error('Failed to refresh user profile:', err);
                    }
                }
            }
            else if (flagData.action === 'lift-suspension') {
                // Lift suspension from user
                console.log('[MOD ACTION LIFT_SUSPENSION] Full flagData:', flagData);
                console.log('[MOD ACTION LIFT_SUSPENSION] Context:', flagData.context);
                
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                // Also try id_public as fallback
                const userIdPublic = flagData.context?.id;
                
                console.log('[MOD ACTION LIFT_SUSPENSION] Lifting suspension for user:', { 
                    userId, 
                    userIdPublic,
                    reason: flagData.reason,
                    contextType: flagData.context?.type
                });
                
                // Use userId if available, otherwise try id_public
                const finalUserId = userId || userIdPublic;
                
                if (!finalUserId) {
                    throw new Error('User ID not found in context');
                }
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${finalUserId}/status`,
                    {
                        status: 'active',
                        reason: flagData.reason
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION LIFT_SUSPENSION] Success:', response.data);
                
                // If the response indicates suspension was lifted, store notification for the user
                if (response.data.suspensionLifted) {
                    console.log('[MOD ACTION LIFT_SUSPENSION] Setting notification for user');
                    // Note: This notification is stored in a shared location. In a real app, 
                    // this should be sent to the user's device via websocket/notification system
                    // For now, it will appear when the user logs back in
                }
                
                showModalMessage('Suspension Lifted', 'User account has been reactivated and can now log in.');
            }
            else if (flagData.action === 'lift-ban') {
                // Lift ban from user
                console.log('[MOD ACTION LIFT_BAN] Full flagData:', flagData);
                console.log('[MOD ACTION LIFT_BAN] Context:', flagData.context);
                
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                // Also try id_public as fallback
                const userIdPublic = flagData.context?.id;
                
                console.log('[MOD ACTION LIFT_BAN] Lifting ban for user:', { 
                    userId, 
                    userIdPublic,
                    reason: flagData.reason,
                    contextType: flagData.context?.type
                });
                
                // Use userId if available, otherwise try id_public
                const finalUserId = userId || userIdPublic;
                
                if (!finalUserId) {
                    throw new Error('User ID not found in context');
                }
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${finalUserId}/status`,
                    {
                        status: 'active',
                        reason: flagData.reason
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION LIFT_BAN] Success:', response.data);
                showModalMessage('Ban Lifted', 'User account has been reactivated and can now log in.');
            }
        } catch (error) {
            console.error('[MOD ACTION] ERROR OCCURRED:', {
                message: error.message,
                status: error.response?.status,
                statusText: error.response?.statusText,
                errorData: error.response?.data,
                errorResponse: error.response,
                fullError: error
            });
            
            // Extract error message for user feedback
            const errorMsg = error.response?.data?.message 
                || error.response?.data?.error 
                || error.message 
                || 'An error occurred while performing this action.';
            
            console.error('[MOD ACTION] Showing error message to user:', errorMsg);
            showModalMessage('Action Failed', errorMsg);
        }
    }, [showModalMessage, authToken, API_BASE_URL, userProfile]);

    const handleImageDownload = async (imageUrl) => {
        try {
            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = `crittertrack-image-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(blobUrl);
        } catch (error) {
            console.error('Failed to download image:', error);
            showModalMessage('Download Failed', 'Could not download the image. Please try right-clicking and "Save image as..."');
        }
    };

    const resetIdleTimer = useCallback(() => {
        if (timeoutRef.current) {
            clearTimeout(timeoutRef.current);
        }
        timeoutRef.current = setTimeout(() => {
            if (authToken) {
                handleLogout(true);
            }
        }, IDLE_TIMEOUT_MS);
    }, [authToken, handleLogout]);

     useEffect(() => {
        if (authToken) {
            axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
            resetIdleTimer();

            activeEvents.forEach(event => window.addEventListener(event, resetIdleTimer));
            
            // Add axios response interceptor to catch suspension/ban
            const interceptor = axios.interceptors.response.use(
                response => response,
                error => {
                    if (error.response?.status === 403 && error.response?.data?.forceLogout) {
                        const accountStatus = error.response?.data?.accountStatus;
                        const message = error.response?.data?.message || 'Your account status has changed.';
                        
                        console.log('[AUTH] Force logout triggered:', { accountStatus, message });
                        
                        // Clear auth and show message
                        handleLogout();
                        showModalMessage(
                            accountStatus === 'suspended' ? 'Account Suspended' : 'Account Status Changed',
                            message
                        );
                    }
                    return Promise.reject(error);
                }
            );
            
            return () => {
                axios.interceptors.response.eject(interceptor);
            };
        } else {
            if (timeoutRef.current) {
                clearTimeout(timeoutRef.current);
            }
            activeEvents.forEach(event => window.removeEventListener(event, resetIdleTimer));
        }

        return () => {
            if (timeoutRef.current) {
                clearTimeout(timeoutRef.current);
            }
            activeEvents.forEach(event => window.removeEventListener(event, resetIdleTimer));
        };
    }, [authToken, resetIdleTimer, handleLogout, showModalMessage]);

    // Poll for maintenance mode and urgent notifications
    useEffect(() => {
        // Skip maintenance check for admins/moderators - they should always have access
        const isStaff = ['admin', 'moderator'].includes(userProfile?.role);
        if (!authToken || isStaff) {
            return; // Don't need to check if staff or not logged in
        }

        const pollForUpdates = async () => {
            try {
                const response = await axios.get(`${API_BASE_URL}/admin/maintenance-status`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                const data = response.data;
                
                if (data.active && !maintenanceMode) {
                    // Maintenance mode just activated
                    setMaintenanceMode(true);
                    setMaintenanceMessage(data.message || 'System Maintenance in Progress');
                    
                    // Show urgent notification to user about maintenance
                    setUrgentNotificationData({
                        title: 'SYSTEM MAINTENANCE ACTIVATED',
                        content: data.message || 'The system is going into maintenance mode. You will be logged out shortly.'
                    });
                    setShowUrgentNotification(true);
                    
                    // Logout user after 5 seconds
                    setTimeout(() => {
                        handleLogout();
                    }, 5000);
                } else if (!data.active && maintenanceMode) {
                    // Maintenance mode just deactivated
                    setMaintenanceMode(false);
                    setMaintenanceMessage('');
                    showModalMessage('Notice', 'Maintenance mode has been deactivated. System is back online.');
                }
            } catch (error) {
                console.error('Error checking maintenance status:', error);
            }
        };

        const pollInterval = setInterval(pollForUpdates, 300000); // Check every 5 minutes
        pollForUpdates(); // Check immediately on mount

        return () => clearInterval(pollInterval);
    }, [authToken, userProfile, maintenanceMode, API_BASE_URL, showModalMessage, handleLogout]);

    // Listen for urgent notifications via WebSocket or server-sent events
    useEffect(() => {
        if (!authToken) {
            return;
        }

        // TODO: Implement urgent notifications when backend EventSource endpoint is available
        // EventSource doesn't support custom headers, so auth needs to be handled via query params
        // For now, urgent notifications are disabled to prevent 401 errors
        
        return () => {
            // Cleanup if needed
        };
    }, [authToken, userProfile, maintenanceMode, API_BASE_URL, showModalMessage, handleLogout]);

    // Poll for user account status changes (suspension/ban)
    useEffect(() => {
        if (!authToken) {
            return;
        }

        const pollUserStatus = async () => {
            try {
                const response = await axios.get(`${API_BASE_URL}/auth/status`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                consecutiveAuthErrors.current = 0; // reset on successful response
                const data = response.data;
                
                // Check if suspension was recently lifted (within 24 hours)
                if (data.suspensionLifted) {
                    const savedNotification = localStorage.getItem('suspensionLiftedNotification');
                    if (!savedNotification) {
                        console.log('[AUTH] Suspension has been lifted for user');
                        // Clear the suspension info from localStorage
                        localStorage.removeItem('suspensionEndTime');
                        localStorage.removeItem('suspensionReason');
                        // Store notification with 24-hour expiry
                        const expiresAt = new Date().getTime() + (24 * 60 * 60 * 1000);
                        localStorage.setItem('suspensionLiftedNotification', JSON.stringify({ expiresAt }));
                        // Force a page reload to update the UI
                        window.location.reload();
                    }
                }
                
                // Check if user status has changed to suspended or banned
                if (data.accountStatus === 'suspended' || data.accountStatus === 'banned') {
                    console.log('[AUTH] User account status changed:', data.accountStatus);
                    
                    // Logout user and show message
                    handleLogout();
                    
                    const title = data.accountStatus === 'suspended' ? 'Account Suspended' : 'Account Banned';
                    const message = data.accountStatus === 'suspended' 
                        ? (data.suspensionReason || 'Your account has been suspended.')
                        : (data.banReason || 'Your account has been banned.');
                    
                    showModalMessage(title, message);
                }
            } catch (error) {
                // If we get a 403 with forceLogout flag, handle it immediately
                if (error.response?.status === 403 && error.response?.data?.forceLogout) {
                    consecutiveAuthErrors.current = 0;
                    const accountStatus = error.response?.data?.accountStatus;
                    const message = error.response?.data?.message || 'Your account status has changed.';
                    
                    console.log('[AUTH] Force logout on status check:', { accountStatus, message });
                    handleLogout();
                    showModalMessage(
                        accountStatus === 'suspended' ? 'Account Suspended' : 'Account Status Changed',
                        message
                    );
                } else if (error.response?.status === 401) {
                    // Token may appear invalid transiently on network reconnection.
                    // Only logout after 3 consecutive 401s to avoid spurious sign-outs.
                    consecutiveAuthErrors.current += 1;
                    console.log(`[AUTH] Status check 401 (${consecutiveAuthErrors.current}/3)`);
                    if (consecutiveAuthErrors.current >= 3) {
                        console.log('[AUTH] Persistent 401 ? logging out');
                        consecutiveAuthErrors.current = 0;
                        handleLogout();
                    }
                } else {
                    // Network error or 5xx ? transient, reset counter and stay silent
                    consecutiveAuthErrors.current = 0;
                }
                // Other errors are non-critical (network, server errors) - don't logout
            }
        };

        // Poll every 2 minutes for user status changes
        const statusPollInterval = setInterval(pollUserStatus, 120000);
        
        // Also check immediately on mount
        pollUserStatus();

        return () => clearInterval(statusPollInterval);
    }, [authToken, API_BASE_URL, handleLogout, showModalMessage]);

    // Note: Onboarding tutorial is no longer auto-triggered for new users
    // Instead, users see a one-time WelcomeGuideModal that explains profile setup
    // Tutorials are available manually via the Help button (?) in the header

    // Clear pre-selected transfer data when leaving budget view
    useEffect(() => {
        if (currentView !== 'budget') {
            setPreSelectedTransferAnimal(null);
            setPreSelectedTransactionType(null);
        }
    }, [currentView]);

    // Auth token effect - set up axios defaults
    useEffect(() => {
        if (authToken) {
            axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
        } else {
            delete axios.defaults.headers.common['Authorization'];
            localStorage.removeItem('authToken');
            setUserProfile(null);
            // Only redirect to home if not on a public route
            const publicRoutes = ['donation', 'genetics-calculator', 'breeder', 'animal'];
            const currentPath = location.pathname.split('/')[1] || '';
            if (!publicRoutes.includes(currentPath)) {
                navigate('/');
            }
        }
    }, [authToken, navigate, location.pathname]);

    const fetchUserProfile = useCallback(async (token) => {
        // Don't fetch if no token (already logged out)
        if (!token) return;
        
        try {
            const response = await axios.get(`${API_BASE_URL}/users/profile`, { headers: { Authorization: `Bearer ${token}` } });
            // Normalize profile image keys for UI compatibility and add a cache-busting query
            const user = response.data || {};
            const img = user.profileImage || user.profileImageUrl || user.imageUrl || user.avatarUrl || user.avatar || user.profile_image || null;
            if (img) {
                const busted = img.includes('?') ? `${img}&t=${Date.now()}` : `${img}?t=${Date.now()}`;
                // prefer `profileImage` and also set `profileImageUrl` for backwards compatibility
                user.profileImage = busted;
                user.profileImageUrl = busted;
            }
            setUserProfile(user);
        } catch (error) {
            console.error('Failed to fetch user profile:', error);
            // Only log out if it's a 401 or 403 (token expired/invalid/forbidden), not for network errors
            if (error.response?.status === 401 || error.response?.status === 403) {
                // Only show error modal if we still have a token (not already logged out)
                if (authToken) {
                    showModalMessage('Session Expired', 'Your session has expired. Please log in again.');
                    setAuthToken(null);
                    try {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('userId');
                    } catch (e) {
                        console.warn('Could not clear auth from localStorage', e);
                    }
                }
            } else if (error.code === 'ERR_NETWORK' || !error.response) {
                // Network error - don't log out, just log it
                console.warn('Network error fetching profile, will retry automatically');
            } else {
                // Other unexpected errors - log but don't force logout
                console.error('Unexpected error fetching profile:', error.response?.status, error.message);
            }
            // For network/other errors, don't log out - the periodic refresh will retry
        }
    }, [showModalMessage, authToken]);

    // Periodically refresh user profile to catch warning/suspension changes
    useEffect(() => {
        if (!authToken) return;
        
        // Fetch immediately, then set up periodic refetch
        fetchUserProfile(authToken);
        
        // Refetch user profile every 10 seconds to catch warning/suspension updates
        const interval = setInterval(() => {
            fetchUserProfile(authToken);
        }, 10000);
        
        return () => clearInterval(interval);
    }, [authToken, fetchUserProfile]);

    // Handle ?message= query param to open messages with a specific user
    useEffect(() => {
        if (!authToken || !userProfile) return;
        
        const params = new URLSearchParams(window.location.search);
        const messageUserId = params.get('message');
        
        if (messageUserId) {
            // Clear the query param from URL
            window.history.replaceState({}, '', window.location.pathname);
            
            // Fetch the user's profile to get their name
            axios.get(`${API_BASE_URL}/public/profile/${messageUserId}`)
                .then(res => {
                    const targetProfile = res.data;
                    setSelectedConversation({
                        otherUserId: targetProfile.userId_backend || messageUserId,
                        otherUser: {
                            id_public: targetProfile.id_public || messageUserId,
                            personalName: targetProfile.personalName,
                            breederName: targetProfile.breederName,
                            showPersonalName: targetProfile.showPersonalName,
                            showBreederName: targetProfile.showBreederName,
                            profileImage: targetProfile.profileImage
                        }
                    });
                    setShowMessages(true);
                })
                .catch(err => {
                    console.error('Failed to load user for messaging:', err);
                    showModalMessage('Error', 'Could not start conversation with this user.');
                });
        }
    }, [authToken, userProfile, showModalMessage]);

    // Check if user has seen welcome guide (localStorage only - no API call needed)
    useEffect(() => {
        if (!authToken || !userProfile) return;
        
        const storageKey = `${userProfile._id}_hasSeenWelcomeGuide`;
        const hasSeen = localStorage.getItem(storageKey) === 'true';
        setHasSeenWelcomeGuide(hasSeen);
        
        // Show modal if they haven't seen it
        if (!hasSeen) {
            setShowWelcomeGuide(true);
        }
    }, [authToken, userProfile]);

    // Fetch animals for genetics calculator when needed
    useEffect(() => {
        const fetchAnimalsForCalculator = async () => {
            if (currentView === 'genetics-calculator' && authToken) {
                try {
                    const response = await axios.get(`${API_BASE_URL}/animals?isOwned=true`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    setMyAnimalsForCalculator(response.data || []);

                } catch (error) {
                    console.error('Failed to fetch animals for calculator:', error);
                    setMyAnimalsForCalculator([]);
                }
            }
        };
        fetchAnimalsForCalculator();
    }, [currentView, authToken, API_BASE_URL]);

    // Fetch and cycle through available animals (for sale + for stud mixed)
    // Only runs on desktop (=1024px) since the showcase widget is hidden on mobile
    useEffect(() => {
        const isDesktop = () => window.matchMedia('(min-width: 1024px)').matches;

        const fetchAvailableAnimals = async () => {
            if (!authToken || !isDesktop()) return;
            try {
                const response = await axios.get(`${API_BASE_URL}/public/global/animals`);
                if (response.data && response.data.length > 0) {
                    const filtered = response.data.filter(animal =>
                        animal.isForSale === true || animal.isForSale === 'true' ||
                        animal.availableForBreeding === true || animal.availableForBreeding === 'true'
                    );

                    // Enrich with owner country � only fetch profiles not already cached
                    const ownerIds = [...new Set(filtered.map(a => a.ownerId_public).filter(Boolean))];
                    const ownerProfiles = await Promise.all(ownerIds.map(async (id_public) => {
                        try {
                            const profileResp = await axios.get(`${API_BASE_URL}/public/profile/${id_public}`);
                            return { id_public, country: profileResp.data?.country || null };
                        } catch {
                            return { id_public, country: null };
                        }
                    }));
                    const ownerCountryMap = new Map(ownerProfiles.map(p => [p.id_public, p.country]));
                    const enriched = filtered.map(animal => ({
                        ...animal,
                        ownerCountry: ownerCountryMap.get(animal.ownerId_public) || null,
                    }));

                    setAvailableAnimals(enriched.sort(() => Math.random() - 0.5));
                    setCurrentAvailableIndex(0);
                } else {
                    setAvailableAnimals([]);
                }
            } catch (error) {
                console.error('[Available Animals] Failed to fetch:', error);
                setAvailableAnimals([]);
            }
        };

        // Store for manual refresh (e.g. after a user lists an animal)
        window.refreshAvailableAnimals = fetchAvailableAnimals;

        // Only run initial fetch on desktop
        if (isDesktop()) fetchAvailableAnimals();

        // Refresh every 30 minutes � data changes infrequently and widget is desktop-only
        const refreshInterval = setInterval(fetchAvailableAnimals, 1800000);

        return () => {
            clearInterval(refreshInterval);
            delete window.refreshAvailableAnimals;
        };
    }, [authToken, API_BASE_URL]);

    // Auto-cycle through available animals every 30 seconds
    useEffect(() => {
        if (availableAnimals.length > 1 && authToken) {
            const cycleInterval = setInterval(() => {
                setCurrentAvailableIndex(prev => (prev + 1) % availableAnimals.length);
            }, 30000);
            
            return () => clearInterval(cycleInterval);
        }
    }, [availableAnimals.length, authToken]);

    // Fetch breeder info when viewing an animal
    useEffect(() => {
        const fetchViewBreederInfo = async () => {
            if (animalToView?.breederId_public && currentView === 'view-animal') {
                try {
                    const response = await axios.get(
                        `${API_BASE_URL}/public/profiles/search?query=${animalToView.breederId_public}&limit=1`
                    );
                    if (response.data && response.data.length > 0) {
                        setViewAnimalBreederInfo(response.data[0]);
                    }
                } catch (error) {
                    console.error('Failed to fetch breeder info for view:', error);
                    setViewAnimalBreederInfo(null);
                }
            } else {
                setViewAnimalBreederInfo(null);
            }
        };
        fetchViewBreederInfo();
    }, [animalToView, currentView, API_BASE_URL]);

    const fetchNotificationCount = useCallback(async () => {
        if (!authToken) return;
        try {
            const response = await axios.get(`${API_BASE_URL}/notifications/unread-count`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setNotificationCount(response.data?.count || 0);
        } catch (error) {
            console.error('Failed to fetch notification count:', error);
        }
    }, [authToken, API_BASE_URL]);

    const fetchUnreadMessageCount = useCallback(async () => {
        if (!authToken) return;
        try {
            const response = await axios.get(`${API_BASE_URL}/messages/unread-count`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setUnreadMessageCount(response.data?.count || 0);
        } catch (error) {
            // Silently fail for message count - backend may not have this endpoint yet
            if (error.response?.status !== 404 && error.response?.status !== 500) {
                console.error('Failed to fetch message count:', error);
            }
            setUnreadMessageCount(0);
        }
    }, [authToken, API_BASE_URL]);

    useEffect(() => {
        if (authToken) {
            fetchNotificationCount();
            fetchUnreadMessageCount();
            // Poll for new notifications and messages every 60 seconds
            const interval = setInterval(() => {
                fetchNotificationCount();
                fetchUnreadMessageCount();
            }, 60000);
            return () => clearInterval(interval);
        }
    }, [authToken, fetchNotificationCount, fetchUnreadMessageCount]);

    // Mark donation highlight as seen after 8 seconds
    useEffect(() => {
        if (authToken && !hasSeenDonationHighlight) {
            const timer = setTimeout(() => {
                setHasSeenDonationHighlight(true);
                localStorage.setItem('hasSeenDonationHighlight', 'true');
            }, 8000);
            return () => clearTimeout(timer);
        }
    }, [authToken, hasSeenDonationHighlight]);

    // Close profile dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (e) => {
            const inDesktop = profileMenuDesktopRef.current?.contains(e.target);
            const inMobile = profileMenuMobileRef.current?.contains(e.target);
            if (!inDesktop && !inMobile) setShowProfileMenu(false);
        };
        if (showProfileMenu) document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [showProfileMenu]);
	
    // Fetch global species list and configs
    useEffect(() => {
        const fetchSpeciesAndConfigs = async () => {
            try {
                const [speciesResponse, configsResponse] = await Promise.all([
                    axios.get(`${API_BASE_URL}/species`),
                    axios.get(`${API_BASE_URL}/species/configs`)
                ]);
                setSpeciesOptions(speciesResponse.data);
                setSpeciesConfigs(configsResponse.data || {});
            } catch (error) {
                console.error('Failed to fetch species:', error);
                // Fallback to defaults if API fails
                setSpeciesOptions([
                    { name: 'Fancy Mouse', category: 'Mammal', isDefault: true },
                    { name: 'Fancy Rat', category: 'Mammal', isDefault: true },
                    { name: 'Russian Dwarf Hamster', category: 'Mammal', isDefault: true },
                    { name: 'Campbells Dwarf Hamster', category: 'Mammal', isDefault: true },
                    { name: 'Chinese Dwarf Hamster', category: 'Mammal', isDefault: true },
                    { name: 'Syrian Hamster', category: 'Mammal', isDefault: true },
                    { name: 'Guinea Pig', category: 'Mammal', isDefault: true }
                ]);
                setSpeciesConfigs({});
            }
        };
        fetchSpeciesAndConfigs();
    }, [API_BASE_URL]);
	
    // Fetch community users (active-first, topped up with recent new members)
    useEffect(() => {
        const fetchCommunityUsers = async () => {
            try {
                const [newestResponse, activeResponse] = await Promise.all([
                    axios.get(`${API_BASE_URL}/public/users/newest?limit=10`),
                    axios.get(`${API_BASE_URL}/public/users/active?minutes=30`)
                ]);
                let newest = newestResponse.data || [];
                let active = activeResponse.data || [];

                const hasVisibleName = (u) => (u.showBreederName && u.breederName) || (u.showPersonalName && u.personalName);
                const clean = (arr) => arr.filter(u => u.id_public && u.accountStatus !== 'banned' && u.id_public !== 'CTU1' && hasVisibleName(u));
                newest = clean(newest);
                active = clean(active);

                const seenIds = new Set();
                const combined = [];
                
                // Create a set of active user IDs for quick lookup
                const activeIds = new Set(active.map(u => u.id_public));

                // First, add up to 1 newest member (if any) who is NOT also active
                const fourteenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                for (const user of newest) {
                    if (!seenIds.has(user.id_public) && !activeIds.has(user.id_public) && combined.length < 1) {
                        seenIds.add(user.id_public);
                        const isNew = user.createdAt && new Date(user.createdAt) > fourteenDaysAgo;
                        combined.push({ ...user, isActive: false, isNew: !!isNew });
                    }
                }

                // Fill up to 5 total with active users (already sorted most-recently-active first by backend)
                for (const user of active) {
                    if (!seenIds.has(user.id_public) && combined.length < 5) {
                        seenIds.add(user.id_public);
                        combined.push({ ...user, isActive: true, isNew: false });
                    }
                }
                
                // If we still have less than 5, fill remaining with new users
                for (const user of newest) {
                    if (!seenIds.has(user.id_public) && combined.length < 5) {
                        seenIds.add(user.id_public);
                        const isNew = user.createdAt && new Date(user.createdAt) > fourteenDaysAgo;
                        combined.push({ ...user, isActive: false, isNew: !!isNew });
                    }
                }

                setCommunityUsers(combined);
            } catch (error) {
                console.error('Error fetching community users:', error);
            }
        };

        if (authToken) {
            fetchCommunityUsers();
            // Refresh every 2 minutes
            const interval = setInterval(fetchCommunityUsers, 120000);
            return () => clearInterval(interval);
        }
    }, [authToken, API_BASE_URL]);
    
    // Auto-scroll effect for community banner - back and forth on desktop
    useEffect(() => {
        const scrollContainer = scrollContainerRef.current;
        if (!scrollContainer || !communityUsers.length) return;
        
        // Disable auto-scroll on mobile to prevent jittery behavior
        const isMobile = window.innerWidth < 768;
        if (isMobile) return;
        
        let scrollInterval;
        let isPaused = false;
        let isScrollingRight = true;
        const scrollSpeed = 0.5; // pixels per interval
        
        const startScroll = () => {
            scrollInterval = setInterval(() => {
                if (!isPaused && scrollContainer) {
                    const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                    let currentScroll = scrollContainer.scrollLeft;

                    if (isScrollingRight) {
                        currentScroll += scrollSpeed;
                        if (currentScroll >= maxScroll) {
                            currentScroll = maxScroll;
                            isScrollingRight = false;
                        }
                    } else {
                        currentScroll -= scrollSpeed;
                        if (currentScroll <= 0) {
                            currentScroll = 0;
                            isScrollingRight = true;
                        }
                    }
                    
                    scrollContainer.scrollLeft = currentScroll;
                }
            }, 50);
        };
        
        const handleMouseEnter = () => { isPaused = true; };
        const handleMouseLeave = () => { isPaused = false; };
        
        scrollContainer.addEventListener('mouseenter', handleMouseEnter);
        scrollContainer.addEventListener('mouseleave', handleMouseLeave);
        
        startScroll();
        
        return () => {
            clearInterval(scrollInterval);
            scrollContainer?.removeEventListener('mouseenter', handleMouseEnter);
            scrollContainer?.removeEventListener('mouseleave', handleMouseLeave);
        };
    }, [communityUsers]);
	
    const handleBugReportSubmit = async (e) => {
        e.preventDefault();
        if (!bugReportDescription.trim()) {
            showModalMessage('Error', 'Please enter a description for your report.');
            return;
        }
        
        setBugReportSubmitting(true);
        try {
            await axios.post(`${API_BASE_URL}/bug-reports`, {
                category: bugReportCategory,
                description: bugReportDescription,
                page: currentView
            }, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            
            showModalMessage('Success', 'Thank you for your report! We will review it soon.');
            setShowBugReportModal(false);
            setBugReportDescription('');
            setBugReportCategory('Bug');
        } catch (error) {
            console.error('Failed to submit bug report:', error);
            showModalMessage('Error', 'Failed to submit report. Please try again.');
        } finally {
            setBugReportSubmitting(false);
        }
    };
    
    const handleSubmitFeedback = async (e) => {
        e.preventDefault();
        if (!feedbackSpecies || !feedbackText.trim()) return;
        
        setFeedbackSubmitting(true);
        try {
            await axios.post(
                `${API_BASE_URL}/feedback/species`,
                {
                    species: feedbackSpecies,
                    feedback: feedbackText.trim(),
                    type: 'species-customization'
                },
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            showModalMessage('Feedback Sent', 'Thank you! Your feedback will help us improve species customization.');
            setShowFeedbackModal(false);
            setFeedbackSpecies('');
            setFeedbackText('');
        } catch (error) {
            console.error('Failed to submit feedback:', error);
            showModalMessage('Error', 'Failed to submit feedback. Please try again.');
        } finally {
            setFeedbackSubmitting(false);
        }
    };
    
    const handleDismissWelcomeGuide = async () => {
        try {
            console.log('[WELCOME GUIDE] Dismissing...');
            
            // Save to database
            await axios.post(
                `${API_BASE_URL}/users/dismiss-profile-setup-guide`,
                {},
                { headers: { Authorization: `Bearer ${authToken}` } }
            );
            
            console.log('[WELCOME GUIDE] Saved to database');
            
            // Update state
            setHasSeenWelcomeGuide(true);
            setShowWelcomeGuide(false);
            
            // Save to localStorage as backup
            if (userProfile?._id) {
                localStorage.setItem(`${userProfile._id}_hasSeenWelcomeGuide`, 'true');
                console.log('[WELCOME GUIDE] Saved to localStorage');
            }
        } catch (error) {
            console.error('[WELCOME GUIDE] Failed to dismiss:', error);
            // Still hide the modal even if save failed
            setShowWelcomeGuide(false);
        }
    };

    const handleLoginSuccess = (token) => {
        setAuthToken(token);
        try {
            localStorage.setItem('authToken', token);
        } catch (e) {
            console.warn('Could not persist authToken to localStorage', e);
        }
        navigate('/');
        setIsRegister(false);
    };

    const handleEditAnimal = (animal) => {
        setAnimalToEdit(animal);
        setSpeciesToAdd(animal.species); 
        navigate('/edit-animal');
    };

    const handleViewAnimal = async (animal) => {
        console.log('[handleViewAnimal] Viewing animal:', animal);
        
        // If we're already viewing an animal, push it to history before navigating to new one
        if (animalToView) {
            setAnimalViewHistory(prev => [...prev, animalToView]);
            console.log('[handleViewAnimal] Pushed current animal to history, stack size:', animalViewHistory.length + 1);
        }
        
        // Fetch latest animal data from backend to ensure privacy settings are current
        let currentAnimal = animal;
        if (authToken) {
            try {
                const response = await axios.get(`${API_BASE_URL}/animals/any/${animal.id_public}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                currentAnimal = response.data;
                console.log('[handleViewAnimal] Fetched latest animal data with sectionPrivacy:', response.data.sectionPrivacy);
            } catch (error) {
                console.warn('[handleViewAnimal] Failed to fetch latest data, using cached:', error);
                // Fall back to the passed animal data if fetch fails
            }
        }
        
        // Normalize parent field names (backend uses sireId_public/damId_public, frontend uses fatherId_public/motherId_public)
        const normalizedAnimal = {
            ...currentAnimal,
            fatherId_public: currentAnimal.fatherId_public || currentAnimal.sireId_public,
            motherId_public: currentAnimal.motherId_public || currentAnimal.damId_public
        };
        
        // Set initial inbreeding coefficient for immediate display
        if (!normalizedAnimal.fatherId_public && !normalizedAnimal.motherId_public) {
            // Animals with no parents have 0% COI by definition
            normalizedAnimal.inbreedingCoefficient = 0;
        }
        // Use existing COI if available, will be updated in background
        
        console.log('[handleViewAnimal] Father ID:', normalizedAnimal.fatherId_public, 'Mother ID:', normalizedAnimal.motherId_public);
        setAnimalToView(normalizedAnimal);
        navigate('/view-animal');
        
        // Recalculate COI in background (non-blocking) for animals with parents
        if ((normalizedAnimal.fatherId_public || normalizedAnimal.motherId_public) && authToken) {
            axios.get(`${API_BASE_URL}/animals/${normalizedAnimal.id_public}/inbreeding`, {
                params: { generations: 50 },
                headers: { Authorization: `Bearer ${authToken}` }
            })
            .then(coiResponse => {
                // Update the animal with fresh COI
                setAnimalToView(prev => ({
                    ...prev,
                    inbreedingCoefficient: coiResponse.data.inbreedingCoefficient
                }));
            })
            .catch(error => {
                console.log(`Could not calculate COI for animal ${normalizedAnimal.id_public}:`, error);
            });
        }
    };

    // Handle back navigation from animal detail view
    const handleBackFromAnimal = () => {
        if (animalViewHistory.length > 0) {
            // Pop the last animal from history and view it
            const previousAnimal = animalViewHistory[animalViewHistory.length - 1];
            setAnimalViewHistory(prev => prev.slice(0, -1));
            setAnimalToView(previousAnimal);
            console.log('[handleBackFromAnimal] Navigating back to previous animal, remaining history:', animalViewHistory.length - 1);
        } else {
            // No history, close the detail view entirely
            setAnimalToView(null);
            setAnimalViewHistory([]);
            navigate('/');
            console.log('[handleBackFromAnimal] No history, closing detail view');
        }
    };
    
    // Handle closing all animal modals (X button closes entire stack)
    const handleCloseAllAnimals = () => {
        setAnimalToView(null);
        setAnimalViewHistory([]);
        navigate('/');
        console.log('[handleCloseAllAnimals] Closed entire animal modal stack');
    };
    
    // Handle viewing public animals with history support
    const handleViewPublicAnimal = (animal) => {
        console.log('[handleViewPublicAnimal] Viewing public animal:', animal);
        
        // If we're already viewing a public animal, push it to history before navigating to new one
        if (viewingPublicAnimal) {
            setPublicAnimalViewHistory(prev => [...prev, viewingPublicAnimal]);
            console.log('[handleViewPublicAnimal] Pushed current animal to history, stack size:', publicAnimalViewHistory.length + 1);
        }
        
        setViewingPublicAnimal(animal);
    };
    
    // Handle back navigation from public animal detail view
    const handleBackFromPublicAnimal = () => {
        if (publicAnimalViewHistory.length > 0) {
            // Pop the last animal from history and view it
            const previousAnimal = publicAnimalViewHistory[publicAnimalViewHistory.length - 1];
            setPublicAnimalViewHistory(prev => prev.slice(0, -1));
            setViewingPublicAnimal(previousAnimal);
            console.log('[handleBackFromPublicAnimal] Navigating back to previous animal, remaining history:', publicAnimalViewHistory.length - 1);
        } else {
            // No history, close the detail view entirely
            setViewingPublicAnimal(null);
            setPublicAnimalViewHistory([]);
            console.log('[handleBackFromPublicAnimal] No history, closing detail view');
        }
    };
    
    // Handle closing all public animal modals (X button closes entire stack)
    const handleCloseAllPublicAnimals = () => {
        setViewingPublicAnimal(null);
        setPublicAnimalViewHistory([]);
        console.log('[handleCloseAllPublicAnimals] Closed entire public animal modal stack');
    };

    // Set up global handler for viewing public animals from search modal
    useEffect(() => {
        window.handleViewPublicAnimal = (animal) => {
            handleViewPublicAnimal(animal);
        };
        return () => {
            delete window.handleViewPublicAnimal;
        };
    }, [viewingPublicAnimal, publicAnimalViewHistory]);

    const handleSaveAnimal = async (method, url, data) => {
        console.log('[handleSaveAnimal] Called with:', { method, url, dataKeys: Object.keys(data), size: data.size });
        if (userProfile && !data.ownerId_public) {
            data.ownerId_public = userProfile.id_public;
        }
        try {
            console.debug('handleSaveAnimal called:', method, url, data);
            const headers = authToken ? { Authorization: `Bearer ${authToken}` } : {};
            let response;
            if (method === 'post') {
                console.log('[handleSaveAnimal] Making POST request...');
                response = await axios.post(url, data, { headers });
                console.log('[handleSaveAnimal] POST response:', response?.status);
            } else if (method === 'put') {
                console.log('[handleSaveAnimal] Making PUT request...');
                response = await axios.put(url, data, { headers });
                console.log('[handleSaveAnimal] PUT response:', response?.status);
            }
            
            // After saving, if we were editing an animal, refetch it and patch
            // the local animals list in-place (no full reload needed).
            if (method === 'put' && animalToEdit) {
                try {
                    const refreshedAnimal = await axios.get(`${API_BASE_URL}/animals/${animalToEdit.id_public}`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    const updated = refreshedAnimal.data;
                    setAnimalToView(updated);
                    // Notify list components to patch this single animal in-place
                    try { window.dispatchEvent(new CustomEvent('animal-updated', { detail: updated })); } catch (e) { /* ignore */ }
                } catch (refreshError) {
                    console.error('Failed to refresh animal data after save:', refreshError);
                    setAnimalToView(animalToEdit);
                }
            }
            
            return response;
        } catch (error) {
            console.error('handleSaveAnimal error:', error.response?.data || error.message || error);
            throw error;
        }
    };

    const handleDeleteAnimal = async (id_public, animalData = null) => {
        try {
            
            // Always use DELETE � the backend handles both permanent deletion and
            // ownership revert (for formally-transferred animals with originalOwnerId)
            const deleteResp = await axios.delete(`${API_BASE_URL}/animals/${id_public}`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            navigate('/');
            if (deleteResp.data?.reverted) {
                showModalMessage('Success', `Animal has been returned to ${animalData?.breederName || 'the original owner'}.`);
            } else {
                showModalMessage('Success', `Animal with ID ${id_public} has been successfully deleted.`);
            }
        } catch (error) {
            console.error('Failed to process animal action:', error);
            showModalMessage('Error', `Failed to process animal action: ${error.response?.data?.message || error.message}`);
        }
    };

    const handleHideViewOnlyAnimal = async (id_public) => {
        if (!window.confirm('Hide this view-only animal? You can restore it later from the hidden animals list.')) {
            return;
        }
        try {
            await axios.post(`${API_BASE_URL}/animals/${id_public}/hide`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            navigate('/');
            showModalMessage('Success', 'View-only animal hidden. You can restore it anytime from the hidden animals section.');
        } catch (error) {
            console.error('Failed to hide animal:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to hide animal');
        }
    };

    const handleHideAnimal = async (id_public) => {
        try {
            await axios.post(`${API_BASE_URL}/animals/${id_public}/hide`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage('Success', 'Animal hidden successfully. You can restore it anytime from the hidden animals section.');
            fetchHiddenAnimals();
        } catch (error) {
            console.error('Failed to hide animal:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to hide animal');
        }
    };

    const toggleAnimalOwned = async (animalId, newOwnedValue) => {
        try {
            const response = await axios.put(`${API_BASE_URL}/animals/${animalId}`, {
                isOwned: newOwnedValue
            }, {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            });

            // Update animalToView if this is the currently viewed animal
            if (animalToView && animalToView.id_public === animalId) {
                setAnimalToView({ ...animalToView, isOwned: newOwnedValue });
            }
        } catch (error) {
            console.error('Error updating owned status:', error);
            showModalMessage('Error', 'Failed to update owned status.');
        }
    };

    const handleRestoreViewOnlyAnimal = async (id_public) => {
        try {
            await axios.post(`${API_BASE_URL}/animals/${id_public}/restore`, {}, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            showModalMessage('Success', 'View-only animal restored to your list!');
            // Refresh the view
            if (currentView === 'hidden-animals') {
                fetchHiddenAnimals();
            }
        } catch (error) {
            console.error('Failed to restore animal:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to restore animal');
        }
    };

    const [hiddenAnimals, setHiddenAnimals] = useState([]);
    const [loadingHidden, setLoadingHidden] = useState(false);

    const fetchHiddenAnimals = async () => {
        setLoadingHidden(true);
        try {
            const response = await axios.get(`${API_BASE_URL}/animals/hidden/list`, {
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setHiddenAnimals(response.data || []);
        } catch (error) {
            console.error('Failed to fetch hidden animals:', error);
            showModalMessage('Error', 'Failed to load hidden animals');
        } finally {
            setLoadingHidden(false);
        }
    };

    const handleSearchTransferUser = async () => {
        if (transferUserQuery.length < 2) return;
        
        setTransferSearching(true);
        setTransferSearchPerformed(true);
        try {
            const response = await axios.get(`${API_BASE_URL}/public/profiles/search`, {
                params: { query: transferUserQuery },
                headers: { Authorization: `Bearer ${authToken}` }
            });
            setTransferUserResults(response.data || []);
        } catch (error) {
            console.error('Error searching users:', error);
            setTransferUserResults([]);
        } finally {
            setTransferSearching(false);
        }
    };

    const handleSubmitTransfer = async () => {
        if (!transferSelectedUser || !transferPrice) {
            showModalMessage('Error', 'Please select a buyer and enter a price');
            return;
        }

        try {
            const transactionData = {
                type: 'sale',
                animalId: transferAnimal.id_public,
                animalName: transferAnimal.name,
                price: parseFloat(transferPrice),
                buyer: transferSelectedUser.breederName || transferSelectedUser.personalName,
                buyerUserId: transferSelectedUser.userId_backend,
                date: new Date().toISOString().split('T')[0],
                notes: transferNotes
            };

            await axios.post(`${API_BASE_URL}/budget/transactions`, transactionData, {
                headers: { Authorization: `Bearer ${authToken}` }
            });

            showModalMessage('Success', `Transfer request sent to ${transferSelectedUser.breederName || transferSelectedUser.personalName}!`);
            setShowTransferModal(false);
            setTransferAnimal(null);
            setTransferUserQuery('');
            setTransferUserResults([]);
            setTransferSelectedUser(null);
            setTransferSearchPerformed(false);
            setTransferPrice('');
            setTransferNotes('');
            navigate('/');
        } catch (error) {
            console.error('Error creating transfer:', error);
            showModalMessage('Error', error.response?.data?.message || 'Failed to create transfer');
        }
    };

    if (!authToken) {
        // Allow unauthenticated users to access search and genetics calculator
        const mainTitle = isRegister ? 'Create Account' : 'Welcome';
        
        // Handle public profile viewing for non-logged-in users
        if (viewingPublicProfile) {
            return (
                <div className="min-h-screen bg-page-bg flex flex-col items-center p-6 font-sans">
                    {showModal && <ModalMessage title={modalMessage.title} message={modalMessage.message} onClose={() => setShowModal(false)} />}
                    {viewingPublicAnimal && (
                        <ViewOnlyAnimalDetail 
                            animal={viewingPublicAnimal}
                            onClose={handleBackFromPublicAnimal}
                            onCloseAll={handleCloseAllPublicAnimals}
                            API_BASE_URL={API_BASE_URL}
                            authToken={authToken}
                            onViewProfile={(user) => setViewingPublicProfile(user)}
                            onViewAnimal={handleViewPublicAnimal}
                            setModCurrentContext={setModCurrentContext}
                        />
                    )}

                    {/* Moderator Action Sidebar - Shows when viewing animals in mod mode */}
                    {inModeratorMode && !showModReportQueue && !showAdminPanel && localStorage.getItem('moderationAuthenticated') === 'true' && (
                        <ModeratorActionSidebar
                            isActive={true}
                            onOpenReportQueue={() => setShowModReportQueue(true)}
                            onQuickFlag={handleModQuickFlag}
                            onExitModeration={() => {
                                setInModeratorMode(false);
                                setShowAdminPanel(false);
                                setShowModReportQueue(false);
                                localStorage.removeItem('moderationAuthenticated');
                                setViewingPublicProfile(null);
                                setViewingPublicAnimal(null);
                                navigate('/');
                            }}
                            currentPage={location.pathname}
                            currentContext={modCurrentContext}
                            API_BASE_URL={API_BASE_URL}
                            authToken={authToken}
                        />
                    )}
                    
                    <header className="w-full max-w-5xl bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                        <CustomAppLogo size="w-10 h-10" />
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => setShowUserSearchModal(true)}
                                className="px-3 py-2 bg-primary hover:bg-primary-dark text-black font-semibold rounded-lg transition flex items-center"
                                data-tutorial-target="global-search-btn"
                            >
                                <Search size={18} className="mr-1" /> Search
                            </button>
                            <button 
                                onClick={() => { setViewingPublicProfile(null); navigate('/'); }}
                                className="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition flex items-center"
                            >
                                <LogIn size={18} className="mr-1" /> Login
                            </button>
                        </div>
                    </header>

                    {showUserSearchModal && (
                        <UserSearchModal 
                            onClose={() => setShowUserSearchModal(false)} 
                            showModalMessage={showModalMessage} 
                            API_BASE_URL={API_BASE_URL}
                            onSelectUser={(user) => {
                                setShowUserSearchModal(false);
                                setViewingPublicProfile(user);
                            }}
                        />
                    )}
                    
                    <PublicProfileView 
                        profile={viewingPublicProfile}
                        onBack={() => { setViewingPublicProfile(null); navigate('/'); }}
                        onViewAnimal={handleViewPublicAnimal}
                        API_BASE_URL={API_BASE_URL}
                        authToken={authToken}
                        setModCurrentContext={setModCurrentContext}
                    />

                    {/* Moderator Action Sidebar - Shows in moderator mode even when viewing public profiles */}
                    {inModeratorMode && !showModReportQueue && ['admin', 'moderator'].includes(userProfile?.role) && (
                        <ModeratorActionSidebar
                            isActive={true}
                            onOpenReportQueue={() => setShowModReportQueue(true)}
                            onQuickFlag={handleModQuickFlag}
                            onExitModeration={() => {
                                setInModeratorMode(false);
                                setShowAdminPanel(false);
                                setShowModReportQueue(false);
                                localStorage.removeItem('moderationAuthenticated');
                            }}
                            currentPage={location.pathname}
                            currentContext={modCurrentContext}
                        />
                    )}
                </div>
            );
        }
        
        // Genetics calculator for non-logged-in users
        if (currentView === 'genetics-calculator') {
            return (
                <div className="min-h-screen bg-page-bg flex flex-col items-center p-6 font-sans">
                    {showModal && <ModalMessage title={modalMessage.title} message={modalMessage.message} onClose={() => setShowModal(false)} />}
                    
                    <header className="w-full max-w-5xl bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                        <CustomAppLogo size="w-10 h-10" />
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => setShowUserSearchModal(true)}
                                className="px-3 py-2 bg-primary hover:bg-primary-dark text-black font-semibold rounded-lg transition flex items-center"
                            >
                                <Search size={18} className="mr-1" /> Search
                            </button>
                            <button 
                                onClick={() => navigate('/')}
                                className="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition flex items-center"
                            >
                                <LogIn size={18} className="mr-1" /> Login
                            </button>
                        </div>
                    </header>
                    
                    {showUserSearchModal && (
                        <UserSearchModal 
                            onClose={() => setShowUserSearchModal(false)} 
                            showModalMessage={showModalMessage} 
                            API_BASE_URL={API_BASE_URL}
                            onSelectUser={(user) => {
                                setShowUserSearchModal(false);
                                setViewingPublicProfile(user);
                            }}
                        />
                    )}
                    
                    {viewingPublicAnimal && (
                        <ViewOnlyAnimalDetail 
                            animal={viewingPublicAnimal}
                            onClose={handleBackFromPublicAnimal}
                            onCloseAll={handleCloseAllPublicAnimals}
                            API_BASE_URL={API_BASE_URL}
                            authToken={authToken}
                            onViewProfile={(user) => setViewingPublicProfile(user)}
                            onViewAnimal={handleViewPublicAnimal}
                            setModCurrentContext={setModCurrentContext}
                            setShowImageModal={setShowImageModal}
                            setEnlargedImageUrl={setEnlargedImageUrl}
                        />
                    )}
                    
                    <MouseGeneticsCalculator
                        API_BASE_URL={API_BASE_URL}
                        authToken={null}
                        userRole={null}
                    />
                </div>
            );
        }
        
        // Donation view for non-logged-in users
        if (currentView === 'donation') {
            return (
                <div className="min-h-screen bg-page-bg flex flex-col items-center justify-center p-6 font-sans">
                    {showModal && <ModalMessage title={modalMessage.title} message={modalMessage.message} onClose={() => setShowModal(false)} />}
                    
                    <DonationView onBack={() => navigate('/')} />
                </div>
            );
        }
        
        // Default auth view with search button
        return (
            <div className="min-h-screen bg-page-bg flex flex-col items-center justify-center p-6 font-sans">
                {showModal && <ModalMessage title={modalMessage.title} message={modalMessage.message} onClose={() => setShowModal(false)} />}
                
                {/* Public navigation header */}
                <header className="w-full max-w-5xl bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                    <CustomAppLogo size="w-10 h-10" />
                    <button 
                        onClick={() => navigate('/genetics-calculator')}
                        className="px-3 py-2 bg-primary hover:bg-primary-dark text-black font-semibold rounded-lg transition flex items-center"
                    >
                        <Cat size={18} className="mr-1" /> Calculator
                    </button>
                </header>
                
                {showUserSearchModal && (
                    <UserSearchModal 
                        onClose={() => setShowUserSearchModal(false)} 
                        showModalMessage={showModalMessage} 
                        API_BASE_URL={API_BASE_URL}
                        onSelectUser={(user) => {
                            setShowUserSearchModal(false);
                            setViewingPublicProfile(user);
                        }}
                    />
                )}
                
                {viewingPublicAnimal && (
                    <ViewOnlyAnimalDetail 
                        animal={viewingPublicAnimal}
                        onClose={handleBackFromPublicAnimal}
                        API_BASE_URL={API_BASE_URL}
                        authToken={authToken}
                        setModCurrentContext={setModCurrentContext}
                        onViewProfile={(user) => setViewingPublicProfile(user)}
                        onViewAnimal={handleViewPublicAnimal}
                        setShowImageModal={setShowImageModal}
                        setEnlargedImageUrl={setEnlargedImageUrl}
                    />
                )}
                
                {/* Logo above all content */}
                <div className="flex flex-col items-center mb-6">
                    <CustomAppLogo size="w-32 h-32" />
                </div>
                
                {/* 3-Column Layout: Donation | Auth Form | Features */}
                <div className="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                    {/* LEFT: Donation Section */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="bg-gradient-to-r from-pink-500 to-red-500 p-2.5 rounded-full">
                                <Heart size={24} className="text-white fill-current" />
                            </div>
                            <h3 className="text-xl font-bold text-gray-800">Support CritterTrack</h3>
                        </div>
                        
                        <p className="text-sm text-gray-700 leading-relaxed mb-4">
                            CritterTrack is <strong>completely free</strong> and developed by a single independent developer 
                            passionate about helping breeders and keepers manage their animals.
                        </p>
                        
                        <p className="text-sm text-gray-600 leading-relaxed mb-6">
                            Your support helps cover server costs and enables continuous improvements. Every contribution, 
                            no matter the size, makes a difference!
                        </p>
                        
                        <RouterLink
                            to="/donation"
                            className="w-full bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition flex items-center justify-center gap-2"
                        >
                            <Heart size={18} className="fill-current" />
                            Learn More & Donate
                        </RouterLink>
                        
                        <a
                            href="https://ko-fi.com/mousemagic/shop"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="w-full mt-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition flex items-center justify-center gap-2"
                        >
                            <ShoppingBag size={18} />
                            Buy Mouse Magic Genetics Guide
                        </a>
                    </div>
                    
                    {/* MIDDLE: Auth Form */}
                    <div>
                        <AuthView 
                            onLoginSuccess={handleLoginSuccess} 
                            showModalMessage={showModalMessage} 
                            isRegister={isRegister} 
                            setIsRegister={setIsRegister} 
                            mainTitle={mainTitle}
                            onShowTerms={() => setShowTermsModal(true)}
                            onShowPrivacy={() => setShowPrivacyModal(true)}
                            userCount={userCount}
                        />
                    </div>
                    
                    {/* RIGHT: Features Summary */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">What's Included</h3>
                        
                        <div className="space-y-3">
                            <div className="flex items-start gap-3">
                                <div className="bg-primary/20 p-2 rounded-lg mt-0.5">
                                    <Cat size={18} className="text-primary-dark" />
                                </div>
                                <div>
                                    <h4 className="font-semibold text-gray-800 text-sm">Animal Management</h4>
                                    <p className="text-xs text-gray-600">Track your animals with detailed records, photos, and genetic codes</p>
                                </div>
                            </div>
                            
                            <div className="flex items-start gap-3">
                                <div className="bg-primary/20 p-2 rounded-lg mt-0.5">
                                    <BookOpen size={18} className="text-primary-dark" />
                                </div>
                                <div>
                                    <h4 className="font-semibold text-gray-800 text-sm">Litter Tracking</h4>
                                    <p className="text-xs text-gray-600">Manage breeding pairs, track litters, and monitor offspring</p>
                                </div>
                            </div>
                            
                            <div className="flex items-start gap-3">
                                <div className="bg-primary/20 p-2 rounded-lg mt-0.5">
                                    <Calculator size={18} className="text-primary-dark" />
                                </div>
                                <div>
                                    <h4 className="font-semibold text-gray-800 text-sm">Genetics Calculator</h4>
                                    <p className="text-xs text-gray-600">Predict offspring outcomes and calculate inbreeding coefficients</p>
                                </div>
                            </div>
                            
                            <div className="flex items-start gap-3">
                                <div className="bg-primary/20 p-2 rounded-lg mt-0.5">
                                    <DollarSign size={18} className="text-primary-dark" />
                                </div>
                                <div>
                                    <h4 className="font-semibold text-gray-800 text-sm">Budget Tracking</h4>
                                    <p className="text-xs text-gray-600">Monitor expenses and income for your breeding program</p>
                                </div>
                            </div>
                            
                            <div className="flex items-start gap-3">
                                <div className="bg-primary/20 p-2 rounded-lg mt-0.5">
                                    <Search size={18} className="text-primary-dark" />
                                </div>
                                <div>
                                    <h4 className="font-semibold text-gray-800 text-sm">Public Profiles</h4>
                                    <p className="text-xs text-gray-600">Share your animals and connect with other breeders</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {showTermsModal && <TermsOfService onClose={() => setShowTermsModal(false)} />}
                {showPrivacyModal && <PrivacyPolicy onClose={() => setShowPrivacyModal(false)} />}
            </div>
        );
    }

     return (
        <div className="min-h-screen bg-page-bg flex flex-col font-sans">
            {/* Fixed Donation Button - Top Left */}
            <div className="fixed top-4 left-4 z-[60]">
                <button
                    onClick={() => {
                        navigate('/donation');
                        if (!hasSeenDonationHighlight) {
                            setHasSeenDonationHighlight(true);
                            localStorage.setItem('hasSeenDonationHighlight', 'true');
                        }
                    }}
                    className={`bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white p-2.5 rounded-full shadow-lg transition-all hover:scale-110 flex items-center justify-center ${
                        !hasSeenDonationHighlight ? 'animate-pulse ring-4 ring-pink-300 ring-opacity-50' : ''
                    }`}
                    title="Support CritterTrack"
                    aria-label="Support CritterTrack"
                >
                    <Heart size={20} className="fill-current" />
                </button>
                
                {/* First-time tooltip */}
                {!hasSeenDonationHighlight && (
                    <div className="absolute top-full mt-2 left-0 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg shadow-xl whitespace-nowrap animate-bounce">
                        <div className="absolute bottom-full left-4 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-900"></div>
                        ❤️ Support CritterTrack
                    </div>
                )}
            </div>
            
            {/* Available Animal Showcase - Top Right */}
            {currentView === 'list' && !inModeratorMode && availableAnimals.length > 0 && availableAnimals[currentAvailableIndex] && (
                <div className="hidden lg:block absolute top-20 right-4 z-[60] w-48">
                    <div 
                        key={currentAvailableIndex}
                        onClick={() => navigate('/marketplace')}
                        className="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition-all hover:scale-[1.02] animate-fadeInScale"
                        style={{
                            animation: 'fadeInScale 0.5s ease-in-out'
                        }}
                    >
                        <div className="bg-gradient-to-r from-primary to-accent p-2 relative">
                            <div className="text-xs font-semibold text-black text-center flex items-center justify-center gap-2 flex-wrap">
                                {availableAnimals[currentAvailableIndex].isForSale && (
                                    <><span>🏷️</span> For Sale</>
                                )}
                                {availableAnimals[currentAvailableIndex].availableForBreeding && (
                                    <><span>🥚</span> For Stud</>
                                )}
                                {availableAnimals[currentAvailableIndex].isForSale && availableAnimals[currentAvailableIndex].availableForBreeding && (
                                    <span className="text-xs">/</span>
                                )}
                            </div>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    window.refreshAvailableAnimals && window.refreshAvailableAnimals();
                                }}
                                className="absolute right-1 top-1/2 -translate-y-1/2 p-1 hover:bg-black/10 rounded transition-colors"
                                title="Refresh available animals"
                            >
                                <RefreshCw size={14} className="text-black" />
                            </button>
                        </div>
                        {availableAnimals[currentAvailableIndex].imageUrl && (
                            <img 
                                src={availableAnimals[currentAvailableIndex].imageUrl} 
                                alt={availableAnimals[currentAvailableIndex].name}
                                className="w-full h-32 object-cover"
                            />
                        )}
                        <div className="p-2">
                            <div className="flex items-start gap-2">
                                <div className="flex-1 min-w-0">
                                    <p className="font-semibold text-sm text-gray-800 truncate">
                                        {availableAnimals[currentAvailableIndex].prefix && `${availableAnimals[currentAvailableIndex].prefix} `}
                                        {availableAnimals[currentAvailableIndex].name}
                                        {availableAnimals[currentAvailableIndex].suffix && ` ${availableAnimals[currentAvailableIndex].suffix}`}
                                    </p>
                                    <p className="text-xs text-gray-600 truncate">
                                        {availableAnimals[currentAvailableIndex].species}
                                        {availableAnimals[currentAvailableIndex].variety && ` � ${availableAnimals[currentAvailableIndex].variety}`}
                                    </p>
                                </div>
                                {availableAnimals[currentAvailableIndex].ownerCountry && (
                                    <span
                                        className={`${getCountryFlag(availableAnimals[currentAvailableIndex].ownerCountry)} inline-block h-4 w-6 flex-shrink-0 mt-1`}
                                        title={getCountryName(availableAnimals[currentAvailableIndex].ownerCountry)}
                                    ></span>
                                )}
                            </div>
                            <div className="mt-1 space-y-1">
                                {availableAnimals[currentAvailableIndex].isForSale && availableAnimals[currentAvailableIndex].salePriceAmount && (
                                    <p className="text-xs text-green-600 font-semibold">
                                        Fee: {availableAnimals[currentAvailableIndex].salePriceCurrency === 'Negotiable' ? 'Negotiable' : `${getCurrencySymbol(availableAnimals[currentAvailableIndex].salePriceCurrency)}${availableAnimals[currentAvailableIndex].salePriceAmount}`}
                                    </p>
                                )}
                                {availableAnimals[currentAvailableIndex].availableForBreeding && availableAnimals[currentAvailableIndex].studFeeAmount && (
                                    <p className="text-xs text-purple-600 font-semibold">
                                        Fee: {availableAnimals[currentAvailableIndex].studFeeCurrency === 'Negotiable' ? 'Negotiable' : `${getCurrencySymbol(availableAnimals[currentAvailableIndex].studFeeCurrency)}${availableAnimals[currentAvailableIndex].studFeeAmount}`}
                                    </p>
                                )}
                            </div>
                            <div className="mt-2 flex items-center justify-between">
                                <span className="text-xs text-gray-500">
                                    {availableAnimals[currentAvailableIndex].gender}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            
            {/* Welcome Guide Modal - Shows once to brand new users on first login */}
            {showWelcomeGuide && (
                <WelcomeGuideModal 
                    onClose={handleDismissWelcomeGuide}
                />
            )}
            
            <div className="flex flex-col items-center p-6 flex-1">
            {showModal && <ModalMessage title={modalMessage.title} message={modalMessage.message} onClose={() => setShowModal(false)} />}
            {showUserSearchModal && (
                <UserSearchModal 
                    onClose={() => setShowUserSearchModal(false)} 
                    showModalMessage={showModalMessage} 
                    API_BASE_URL={API_BASE_URL}
                    onSelectUser={(user) => {
                        setShowUserSearchModal(false);
                        navigate(`/user/${user.id_public}`);
                    }}
                />
            )}
            {viewingPublicAnimal && (
                <ViewOnlyAnimalDetail 
                    animal={viewingPublicAnimal}
                    onClose={handleBackFromPublicAnimal}
                    onCloseAll={handleCloseAllPublicAnimals}
                    API_BASE_URL={API_BASE_URL}
                    authToken={authToken}
                    setModCurrentContext={setModCurrentContext}
                    onViewProfile={(user) => navigate(`/user/${user.id_public}`)}
                    onViewAnimal={handleViewPublicAnimal}
                    setShowImageModal={setShowImageModal}
                    setEnlargedImageUrl={setEnlargedImageUrl}
                />
            )}
            
            <header className="w-full bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-6 max-w-5xl overflow-visible">
                {/* Desktop: Single row layout */}
                <div className="hidden md:flex justify-between items-center">
                    <CustomAppLogo size="w-10 h-10" />
                    
                    <nav className="flex space-x-3">
                        <button onClick={() => navigate('/')} className={`px-4 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'list' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <Cat size={18} className="mb-1" />
                            <span>Animals</span>
                        </button>
                        <button onClick={() => navigate('/litters')} data-tutorial-target="litters-btn" className={`px-4 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'litters' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <BookOpen size={18} className="mb-1" />
                            <span>Litters</span>
                        </button>
                        <button onClick={() => navigate('/budget')} data-tutorial-target="budget-btn" className={`px-4 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'budget' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <DollarSign size={18} className="mb-1" />
                            <span>Budget</span>
                        </button>
                        <button onClick={() => navigate('/marketplace')} className={`px-4 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'marketplace' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <ShoppingBag size={18} className="mb-1" />
                            <span>Marketplace</span>
                        </button>
                        <button onClick={() => navigate('/genetics-calculator')} data-tutorial-target="genetics-btn" className={`px-4 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'genetics-calculator' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <Calculator size={18} className="mb-1" />
                            <span>Calculator</span>
                        </button>
                        <button onClick={() => navigate('/breeder-directory')} data-tutorial-target="breeders-btn" className={`px-4 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'breeder-directory' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <MoonStar size={18} className="mb-1" />
                            <span>Breeders</span>
                        </button>
                    </nav>

                    <div className="flex items-center space-x-3">
                        <button 
                            onClick={() => setShowUserSearchModal(true)} 
                            className="flex flex-col items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 px-3 rounded-lg transition duration-150 shadow-sm"
                            title="Search Users by Name or ID"
                            data-tutorial-target="global-search-btn"
                        >
                            <Search size={18} className="mb-1" />
                            <span className="text-xs">Search</span>
                        </button>

                        <button
                            onClick={() => {
                                setShowNotifications(true);
                                setNotificationCount(0);
                                fetchNotificationCount();
                            }}
                            data-tutorial-target="notification-bell"
                            className="relative flex flex-col items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 px-3 rounded-lg transition duration-150 shadow-sm"
                            title="Notifications"
                        >
                            <Bell size={18} />
                            {notificationCount > 0 && (
                                <span className="absolute -top-1 -right-1 bg-purple-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                                    {notificationCount > 9 ? '9+' : notificationCount}
                                </span>
                            )}
                        </button>
                        
                        <button
                            onClick={() => setShowMessages(true)}
                            data-tutorial-target="messages-btn"
                            className="relative flex flex-col items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 px-3 rounded-lg transition duration-150 shadow-sm"
                            title="Messages"
                        >
                            <MessageSquare size={18} />
                            {unreadMessageCount > 0 && (
                                <span className="absolute -top-1 -right-1 bg-purple-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                                    {unreadMessageCount > 9 ? '9+' : unreadMessageCount}
                                </span>
                            )}
                        </button>
                        
                        {/* Avatar / Profile Dropdown */}
                        <div className="relative" ref={profileMenuDesktopRef}>
                            <button
                                onClick={() => setShowProfileMenu(p => !p)}
                                className="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-sm font-bold text-black hover:ring-2 hover:ring-primary/60 transition overflow-hidden flex-shrink-0 shadow-md"
                                title="Account"
                            >
                                {(userProfile?.profileImage || userProfile?.profileImageUrl)
                                    ? <img src={userProfile.profileImage || userProfile.profileImageUrl} alt="" className="w-full h-full object-cover" />
                                    : (userProfile?.personalName || userProfile?.breederName || '?').slice(0, 2).toUpperCase()
                                }
                            </button>
                            {showProfileMenu && (
                                <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-200 py-1 z-50">
                                    <button onClick={() => { navigate('/profile'); setShowProfileMenu(false); }}
                                        className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100">
                                        <User size={15} /> Profile
                                    </button>
                                    <button onClick={() => { setShowInfoTab(true); setShowProfileMenu(false); }}
                                        className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100">
                                        <BookOpen size={15} /> Help &amp; Tutorials
                                    </button>
                                    {['admin', 'moderator'].includes(userProfile?.role) && (
                                        <button onClick={() => { inModeratorMode ? setShowAdminPanel(!showAdminPanel) : setShowModerationAuthModal(true); setShowProfileMenu(false); }}
                                            className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50">
                                            <Shield size={15} /> {inModeratorMode ? 'Panel' : 'Moderation'}
                                        </button>
                                    )}
                                    <hr className="my-1 border-gray-200" />
                                    <button onClick={() => handleLogout(false)}
                                        className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50">
                                        <LogOut size={15} /> Logout
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* Mobile: Three row layout */}
                <div className="md:hidden overflow-x-visible">
                    {/* First row: Logo and action buttons */}
                    <div className="flex justify-between items-center mb-3 gap-2">
                        <CustomAppLogo size="w-8 h-8" className="flex-shrink-0" />
                        
                        <div className="flex items-center space-x-2 flex-shrink-0">
                            <button 
                                onClick={() => setShowUserSearchModal(true)} 
                                className="flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg transition duration-150 shadow-sm"
                                title="Search"
                                data-tutorial-target="global-search-btn"
                            >
                                <Search size={18} />
                            </button>

                            <button
                                onClick={() => {
                                    setShowNotifications(true);
                                    setNotificationCount(0);
                                    fetchNotificationCount();
                                }}
                                data-tutorial-target="notification-bell"
                                className="relative flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg transition duration-150 shadow-sm"
                                title="Notifications"
                            >
                                <Bell size={18} />
                                {notificationCount > 0 && (
                                    <span className="absolute -top-1 -right-1 bg-purple-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold text-[10px]">
                                        {notificationCount > 9 ? '9+' : notificationCount}
                                    </span>
                                )}
                            </button>
                            
                            <button
                                onClick={() => setShowMessages(true)}
                                data-tutorial-target="messages-btn"
                                className="relative flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg transition duration-150 shadow-sm"
                                title="Messages"
                            >
                                <MessageSquare size={18} />
                                {unreadMessageCount > 0 && (
                                    <span className="absolute -top-1 -right-1 bg-purple-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold text-[10px]">
                                        {unreadMessageCount > 9 ? '9+' : unreadMessageCount}
                                    </span>
                                )}
                            </button>
                            
                            {/* Avatar / Profile Dropdown (mobile) */}
                            <div className="relative" ref={profileMenuMobileRef}>
                                <button
                                    onClick={() => setShowProfileMenu(p => !p)}
                                    className="w-9 h-9 rounded-full bg-primary flex items-center justify-center text-sm font-bold text-black hover:ring-2 hover:ring-primary/60 transition overflow-hidden flex-shrink-0 shadow-md"
                                    title="Account"
                                >
                                    {(userProfile?.profileImage || userProfile?.profileImageUrl)
                                        ? <img src={userProfile.profileImage || userProfile.profileImageUrl} alt="" className="w-full h-full object-cover" />
                                        : (userProfile?.personalName || userProfile?.breederName || '?').slice(0, 2).toUpperCase()
                                    }
                                </button>
                                {showProfileMenu && (
                                    <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-200 py-1 z-50">
                                        <button onClick={() => { navigate('/profile'); setShowProfileMenu(false); }}
                                            className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100">
                                            <User size={15} /> Profile
                                        </button>
                                        <button onClick={() => { setShowInfoTab(true); setShowProfileMenu(false); }}
                                            className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-100">
                                            <BookOpen size={15} /> Help &amp; Tutorials
                                        </button>
                                        {['admin', 'moderator'].includes(userProfile?.role) && (
                                            <button onClick={() => { inModeratorMode ? setShowAdminPanel(!showAdminPanel) : setShowModerationAuthModal(true); setShowProfileMenu(false); }}
                                                className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50">
                                                <Shield size={15} /> {inModeratorMode ? 'Panel' : 'Moderation'}
                                            </button>
                                        )}
                                        <hr className="my-1 border-gray-200" />
                                        <button onClick={() => handleLogout(false)}
                                            className="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50">
                                            <LogOut size={15} /> Logout
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Second row: Navigation row 1 (4 buttons) */}
                    <nav className="grid grid-cols-4 gap-1 mb-1">
                        <button onClick={() => navigate('/')} className={`px-2 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'list' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <Cat size={18} className="mb-0.5" />
                            <span>Animals</span>
                        </button>
                        <button onClick={() => navigate('/litters')} data-tutorial-target="litters-btn" className={`px-2 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'litters' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <BookOpen size={18} className="mb-0.5" />
                            <span>Litters</span>
                        </button>
                        <button onClick={() => navigate('/budget')} data-tutorial-target="budget-btn" className={`px-2 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'budget' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <DollarSign size={18} className="mb-0.5" />
                            <span>Budget</span>
                        </button>
                        <button onClick={() => navigate('/marketplace')} data-tutorial-target="marketplace-btn" className={`px-2 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'marketplace' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <ShoppingBag size={18} className="mb-0.5" />
                            <span>Marketplace</span>
                        </button>
                    </nav>

                    {/* Third row: Navigation row 2 (2 buttons) */}
                    <nav className="grid grid-cols-2 gap-1">
                        <button onClick={() => navigate('/genetics-calculator')} data-tutorial-target="genetics-btn" className={`px-2 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'genetics-calculator' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <Calculator size={18} className="mb-0.5" />
                            <span>Calculator</span>
                        </button>
                        <button onClick={() => navigate('/breeder-directory')} data-tutorial-target="breeders-btn" className={`px-2 py-2 text-xs font-medium rounded-lg transition duration-150 flex flex-col items-center ${currentView === 'breeder-directory' ? 'bg-primary text-black shadow-md' : 'text-gray-600 hover:bg-gray-100'}`}>
                            <MoonStar size={18} className="mb-0.5" />
                            <span>Breeders</span>
                        </button>
                    </nav>
                </div>
            </header>

            {/* Moderator Warning Banner */}
            <WarningBanner authToken={authToken} API_BASE_URL={API_BASE_URL} userProfile={userProfile} />
            
            {/* System Broadcast Banner (info/announcements) - only on dashboard */}
            {(currentView === 'list' || currentView === '') && (
                <BroadcastBanner authToken={authToken} API_BASE_URL={API_BASE_URL} />
            )}
            
            {/* Urgent Broadcast Popup (warning/alert) */}
            <UrgentBroadcastPopup authToken={authToken} API_BASE_URL={API_BASE_URL} />

            {/* Species Customization Request Button */}
            {!inModeratorMode && (
                <button
                    onClick={() => setShowFeedbackModal(true)}
                    className="fixed left-0 z-40 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white px-2 py-4 rounded-r-lg shadow-lg transition-all duration-200 hover:px-3 group"
                    style={{ writingMode: 'vertical-rl', textOrientation: 'mixed', top: 'calc(50% - 120px)' }}
                    title="Request species field customization"
                >
                    <span className="flex items-center gap-2 text-sm font-medium">
                        <Mail size={16} className="rotate-90" />
                        <span>Species Customization</span>
                    </span>
                </button>
            )}

            {/* Beta Feedback Button - Temporary prominent feedback access for beta users */}
            {!inModeratorMode && (
                <button
                    onClick={() => setShowBugReportModal(true)}
                    className="fixed left-0 z-40 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-2 py-4 rounded-r-lg shadow-lg transition-all duration-200 hover:px-3 group"
                    style={{ writingMode: 'vertical-rl', textOrientation: 'mixed', top: 'calc(50% + 120px)' }}
                    title="Share feedback or report issues"
                >
                    <span className="flex items-center gap-2 text-sm font-medium">
                        <MessageSquare size={16} className="rotate-90" />
                        <span>Beta Feedback</span>
                        <AlertCircle size={14} className="rotate-90 opacity-70" />
                    </span>
                </button>
            )}

            {showNotifications && (
                <NotificationPanel
                    authToken={authToken}
                    API_BASE_URL={API_BASE_URL}
                    onClose={() => {
                        setShowNotifications(false);
                        fetchNotificationCount();
                    }}
                    onNotificationChange={fetchNotificationCount}
                    showModalMessage={showModalMessage}
                    onViewAnimal={(animalId_public, viewFromNotification) => {
                        // Fetch animal with notification flag to override private animal access
                        axios.get(`${API_BASE_URL}/animals/any/${animalId_public}?viewFromNotification=${viewFromNotification}`, {
                            headers: { Authorization: `Bearer ${authToken}` }
                        })
                            .then(res => {
                                setAnimalToView(res.data);
                                navigate('/view-animal');
                                setShowNotifications(false);
                            })
                            .catch(err => {
                                console.error('Failed to load animal:', err);
                                showModalMessage('Error', 'Could not load animal details.');
                            });
                    }}
                />
            )}
            
            {showMessages && (
                <MessagesView
                    authToken={authToken}
                    API_BASE_URL={API_BASE_URL}
                    onClose={() => {
                        setShowMessages(false);
                        setSelectedConversation(null);
                        fetchUnreadMessageCount();
                    }}
                    showModalMessage={showModalMessage}
                    selectedConversation={selectedConversation}
                    setSelectedConversation={setSelectedConversation}
                    userProfile={userProfile}
                />
            )}
            
            {showBugReportModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-xl font-bold text-gray-800">Share Your Feedback</h2>
                            <button 
                                onClick={() => setShowBugReportModal(false)}
                                className="text-gray-500 hover:text-gray-700 transition"
                            >
                                <X size={24} />
                            </button>
                        </div>
                        
                        <p className="text-sm text-gray-600 mb-4">
                            Report bugs, request new features, or share general feedback to help us improve CritterTrack.
                        </p>
                        
                        <form onSubmit={handleBugReportSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select
                                    value={bugReportCategory}
                                    onChange={(e) => setBugReportCategory(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                >
                                    <option value="Bug">Bug</option>
                                    <option value="Feature Request">Feature Request</option>
                                    <option value="General Feedback">General Feedback</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea
                                    value={bugReportDescription}
                                    onChange={(e) => setBugReportDescription(e.target.value)}
                                    placeholder="Describe your bug report, feature request, or feedback in detail. Include steps to reproduce if reporting a bug."
                                    rows={6}
                                    required
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary resize-none"
                                />
                            </div>
                            
                            <div className="flex gap-3 justify-end">
                                <button
                                    type="button"
                                    onClick={() => setShowBugReportModal(false)}
                                    className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={bugReportSubmitting}
                                    className="px-4 py-2 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition disabled:opacity-50 flex items-center gap-2"
                                >
                                    {bugReportSubmitting ? (
                                        <>
                                            <Loader2 className="animate-spin" size={16} />
                                            Submitting...
                                        </>
                                    ) : (
                                        'Submit Report'
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Species Customization Feedback Modal */}
            {showFeedbackModal && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xl font-bold text-gray-800">Request Species Customization</h3>
                            <button 
                                onClick={() => setShowFeedbackModal(false)}
                                className="text-gray-500 hover:text-gray-700 transition"
                            >
                                <X size={24} />
                            </button>
                        </div>
                        <p className="text-sm text-gray-600 mb-4">
                            Let us know if a species needs different or additional fields (e.g., "Morph" instead of "Color/Coat" for snakes, or missing fields like "Pattern")
                        </p>
                        
                        <form onSubmit={handleSubmitFeedback} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Species</label>
                                <select
                                    value={feedbackSpecies}
                                    onChange={(e) => setFeedbackSpecies(e.target.value)}
                                    required
                                    className="w-full p-2 border border-gray-300 rounded-lg"
                                >
                                    <option value="">Select a species...</option>
                                    {speciesOptions.map(s => (
                                        <option key={s._id || s.name} value={s.name}>{s.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    What fields need to be different or added?
                                </label>
                                <textarea
                                    value={feedbackText}
                                    onChange={(e) => setFeedbackText(e.target.value)}
                                    required
                                    rows={4}
                                    placeholder='Example: For snakes, replace "Color" and "Coat" with "Morph", and add a "Pattern" field'
                                    className="w-full p-2 border border-gray-300 rounded-lg"
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setShowFeedbackModal(false);
                                        setFeedbackSpecies('');
                                        setFeedbackText('');
                                    }}
                                    className="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={feedbackSubmitting}
                                    className="flex-1 px-4 py-2 bg-accent hover:bg-accent/80 text-white rounded-lg transition disabled:opacity-50 flex items-center justify-center"
                                >
                                    {feedbackSubmitting ? <Loader2 className="animate-spin mr-2" size={18} /> : <Mail size={18} className="mr-2" />}
                                    {feedbackSubmitting ? 'Sending...' : 'Send Feedback'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Help/Lessons Tab Modal */}
            {showInfoTab && (
                <InfoTab 
                    onClose={() => setShowInfoTab(false)}
                />
            )}

            {/* Moderation Auth Modal */}
            {showModerationAuthModal && authToken && !inModeratorMode && (
                <ModerationAuthModal
                    isOpen={showModerationAuthModal}
                    onClose={() => setShowModerationAuthModal(false)}
                    onSuccess={() => {
                        setInModeratorMode(true);
                        setShowModerationAuthModal(false);
                        localStorage.setItem('moderationAuthenticated', 'true');
                    }}
                    API_BASE_URL={API_BASE_URL}
                    authToken={authToken}
                />
            )}

            {/* Moderation Panel - Opens while in Moderator Mode */}
            {showAdminPanel && inModeratorMode && ['admin', 'moderator'].includes(userProfile?.role) && (
                <AdminPanel
                    isOpen={showAdminPanel}
                    onClose={() => setShowAdminPanel(false)}
                    authToken={authToken}
                    API_BASE_URL={API_BASE_URL}
                    userRole={userProfile?.role}
                    userEmail={userProfile?.email}
                    userId={userProfile?.id_public}
                    username={userProfile?.personalName}
                    skipAuthentication={true}
                />
            )}

            {/* Moderation Report Queue - Full page view of all reports */}
            {showModReportQueue && inModeratorMode && ['admin', 'moderator'].includes(userProfile?.role) && (
                <ModOversightPanel
                    isOpen={showModReportQueue}
                    onClose={() => setShowModReportQueue(false)}
                    authToken={authToken}
                    API_BASE_URL={API_BASE_URL}
                    onActionTaken={() => {
                        // Refresh or update state if needed
                    }}
                />
            )}

            {/* Moderator Action Sidebar - Shows while browsing in moderator mode */}
            {inModeratorMode && !showModReportQueue && !showAdminPanel && localStorage.getItem('moderationAuthenticated') === 'true' && (
                <ModeratorActionSidebar
                    isActive={true}
                    onOpenReportQueue={() => setShowModReportQueue(true)}
                    onQuickFlag={handleModQuickFlag}
                    onExitModeration={() => {
                        setInModeratorMode(false);
                        setShowAdminPanel(false);
                        setShowModReportQueue(false);
                        localStorage.removeItem('moderationAuthenticated');
                    }}
                    currentPage={location.pathname}
                    currentContext={modCurrentContext}
                />
            )}



            {/* Profile Card and Community Feed - shown only on list view */}
            {currentView === 'list' && (
                <div className="w-full max-w-5xl mb-6 flex flex-col sm:flex-row gap-4">
                    {/* Profile Card - Hidden on mobile */}
                    {currentView !== 'profile' && userProfile && <div className="hidden sm:block"><UserProfileCard userProfile={userProfile} /></div>}
                    
                    {/* Community Feed Banner */}
                    {communityUsers.length > 0 && (
                        <div className="flex-1 min-w-0 bg-gradient-to-r from-primary/20 to-accent/20 p-3 rounded-lg border border-primary/30" data-tutorial-target="community-activity">
                            <h3 className="text-xs font-semibold text-gray-800 mb-2 flex items-center justify-center">
                                <Users size={14} className="mr-2 text-primary-dark" />
                                Community Feed
                            </h3>
                            <div
                                ref={scrollContainerRef}
                                className="flex flex-wrap justify-center gap-3 pb-2"
                            >
                                {communityUsers.map(user => {
                                    const displayName = (user.showBreederName && user.breederName)
                                        ? user.breederName
                                        : ((user.showPersonalName ?? false) ? user.personalName : 'Anonymous');
                                    return (
                                        <div
                                            key={user.id_public}
                                            className="relative bg-white rounded-lg p-2 shadow-sm border-2 border-primary/40 hover:shadow-md transition cursor-pointer w-[18%] min-w-[110px] max-w-[140px]"
                                            onClick={() => navigate(`/user/${user.id_public}`)}
                                        >
                                            {/* Active green dot */}
                                            {user.isActive && (
                                                <span className="absolute top-1.5 right-1.5 w-2.5 h-2.5 bg-green-400 border-2 border-white rounded-full" title="Recently active" />
                                            )}
                                            {/* New member badge */}
                                            {!user.isActive && user.isNew && (
                                                <span className="absolute top-1 right-1 text-[9px] font-bold bg-blue-100 text-blue-600 px-1 rounded">NEW</span>
                                            )}
                                            <div className="w-10 h-10 bg-gray-100 rounded-full overflow-hidden mx-auto mb-1">
                                                {user.profileImage ? (
                                                    <img src={user.profileImage} alt={displayName} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                        <User size={20} />
                                                    </div>
                                                )}
                                            </div>
                                            <p className="text-xs font-semibold text-gray-800 text-center line-clamp-2 min-h-[2.5rem] flex items-center justify-center gap-1">
                                                {displayName}
                                                <DonationBadge badge={getDonationBadge(user)} size="xs" />
                                            </p>
                                            <p className="text-xs text-gray-500 text-center truncate">{user.id_public}</p>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            )}

            <main className="w-full flex-grow max-w-5xl">
                <Routes>
                    <Route path="/" element={
                        <AnimalList 
                            authToken={authToken} 
                            showModalMessage={showModalMessage} 
                            onEditAnimal={handleEditAnimal} 
                            onViewAnimal={handleViewAnimal}
                            fetchHiddenAnimals={fetchHiddenAnimals}
                            navigate={navigate}
                        />
                    } />
                    <Route path="/list" element={
                        <AnimalList 
                            authToken={authToken} 
                            showModalMessage={showModalMessage} 
                            onEditAnimal={handleEditAnimal} 
                            onViewAnimal={handleViewAnimal}
                            fetchHiddenAnimals={fetchHiddenAnimals}
                            navigate={navigate}
                        />
                    } />
                    <Route path="/donation" element={<DonationView onBack={() => navigate('/')} />} />
                    <Route path="/marketplace" element={
                        <Marketplace 
                            authToken={authToken}
                            userProfile={userProfile}
                            showModalMessage={showModalMessage}
                            onViewAnimal={(animalId) => {
                                // Navigate to public animal page
                                window.location.href = `/animal/${animalId}`;
                            }}
                            onViewProfile={(userId) => {
                                // Navigate to public profile page
                                window.location.href = `/user/${userId}`;
                            }}
                            onStartConversation={(conversationData) => {
                                setSelectedConversation(conversationData);
                                setShowMessages(true);
                            }}
                        />
                    } />
                    <Route path="/family-tree" element={
                        userProfile?.id_public === 'CTU2' ? (
                            <FamilyTree
                                authToken={authToken}
                                userProfile={userProfile}
                                showModalMessage={showModalMessage}
                                onViewAnimal={handleViewAnimal}
                                onBack={() => navigate('/')}
                            />
                        ) : (
                            <div style={{ padding: '20px', textAlign: 'center' }}>
                                <h2>Access Restricted</h2>
                                <p>The Family Tree feature is currently in testing and only available to select users.</p>
                                <button onClick={() => navigate('/')} style={{ marginTop: '20px', padding: '10px 20px', cursor: 'pointer' }}>
                                    Back to Home
                                </button>
                            </div>
                        )
                    } />
                    <Route path="/family-tree" element={
                        userProfile?.id_public === 'CTU2' ? (
                            <FamilyTree
                                authToken={authToken}
                                userProfile={userProfile}
                                showModalMessage={showModalMessage}
                                onViewAnimal={handleViewAnimal}
                                onBack={() => navigate('/')}
                            />
                        ) : (
                            <div style={{ padding: '20px', textAlign: 'center' }}>
                                <h2>Access Restricted</h2>
                                <p>The Family Tree feature is currently in testing and only available to select users.</p>
                                <button onClick={() => navigate('/')} style={{ marginTop: '20px', padding: '10px 20px', cursor: 'pointer' }}>
                                    Back to Home
                                </button>
                            </div>
                        )
                    } />
                    <Route path="/animal-tree/:species" element={
                        <AnimalTree
                            authToken={authToken}
                            userProfile={userProfile}
                            showModalMessage={showModalMessage}
                            onViewAnimal={handleViewAnimal}
                            onBack={() => navigate('/')}
                        />
                    } />
                    <Route path="/profile" element={<ProfileView userProfile={userProfile} showModalMessage={showModalMessage} fetchUserProfile={fetchUserProfile} authToken={authToken} onProfileUpdated={setUserProfile} />} />
                    <Route path="/breeder-directory" element={
                        <BreederDirectory
                            authToken={authToken}
                            API_BASE_URL={API_BASE_URL}
                            onBack={() => navigate('/')}
                        />
                    } />
                    <Route path="/litters" element={
                        <LitterManagement
                            authToken={authToken}
                            API_BASE_URL={API_BASE_URL}
                            userProfile={userProfile}
                            showModalMessage={showModalMessage}
                            onViewAnimal={handleViewAnimal}
                        />
                    } />
                    <Route path="/budget" element={
                        <BudgetingTab
                            authToken={authToken}
                            API_BASE_URL={API_BASE_URL}
                            showModalMessage={showModalMessage}
                            preSelectedAnimal={preSelectedTransferAnimal}
                            preSelectedType={preSelectedTransactionType}
                            onAddModalOpen={() => setBudgetModalOpen(true)}
                        />
                    } />
                    <Route path="/genetics-calculator" element={
                        <MouseGeneticsCalculator
                            API_BASE_URL={API_BASE_URL}
                            authToken={authToken}
                            myAnimals={myAnimalsForCalculator}
                            userRole={userProfile?.role}
                        />
                    } />
                    <Route path="/select-species" element={
                        <SpeciesSelector 
                            speciesOptions={speciesOptions} 
                            onSelectSpecies={(species) => { 
                                setSpeciesToAdd(species); 
                                navigate('/add-animal'); 
                            }} 
                            onManageSpecies={() => navigate('/manage-species')}
                            searchTerm={speciesSearchTerm}
                            setSearchTerm={setSpeciesSearchTerm}
                            categoryFilter={speciesCategoryFilter}
                            setCategoryFilter={setSpeciesCategoryFilter}
                        />
                    } />
                    <Route path="/manage-species" element={
                        <SpeciesManager 
                            speciesOptions={speciesOptions} 
                            setSpeciesOptions={setSpeciesOptions} 
                            onCancel={() => navigate('/select-species')}
                            showModalMessage={showModalMessage}
                            authToken={authToken}
                            API_BASE_URL={API_BASE_URL}
                        />
                    } />
                    <Route path="/add-animal" element={
                        !speciesToAdd ? (
                            <SpeciesSelector
                                speciesOptions={speciesOptions}
                                onSelectSpecies={(species) => {
                                    setSpeciesToAdd(species);
                                    navigate('/add-animal');
                                }}
                                onManageSpecies={() => navigate('/manage-species')}
                                searchTerm={speciesSearchTerm}
                                setSearchTerm={setSpeciesSearchTerm}
                                categoryFilter={speciesCategoryFilter}
                                setCategoryFilter={setSpeciesCategoryFilter}
                            />
                        ) : (
                            <AnimalForm
                                formTitle={`Add New ${speciesToAdd}`}
                                animalToEdit={null}
                                species={speciesToAdd}
                                onSave={handleSaveAnimal}
                                onCancel={() => { navigate('/'); setSpeciesToAdd(null); }}
                                onDelete={null}
                                authToken={authToken}
                                showModalMessage={showModalMessage}
                                API_BASE_URL={API_BASE_URL}
                                userProfile={userProfile}
                                speciesConfigs={speciesConfigs}
                                X={X}
                                Search={Search}
                                Loader2={Loader2}
                                LoadingSpinner={LoadingSpinner}
                                PlusCircle={PlusCircle}
                                ArrowLeft={ArrowLeft}
                                Save={Save}
                                Trash2={Trash2}
                                RotateCcw={RotateCcw}
                                GENDER_OPTIONS={GENDER_OPTIONS}
                                STATUS_OPTIONS={STATUS_OPTIONS}
                                AnimalImageUpload={AnimalImageUpload}
                            />
                        )
                    } />
                    <Route path="/edit-animal" element={
                        animalToEdit && (
                            <AnimalForm 
                                formTitle={`Edit ${animalToEdit.name}`}
                                animalToEdit={animalToEdit} 
                                species={animalToEdit.species} 
                                onSave={handleSaveAnimal} 
                                onCancel={() => navigate('/')} 
                                onDelete={handleDeleteAnimal}
                                authToken={authToken} 
                                showModalMessage={showModalMessage}
                                API_BASE_URL={API_BASE_URL}
                                userProfile={userProfile}
                                speciesConfigs={speciesConfigs}
                                X={X}
                                Search={Search}
                                Loader2={Loader2}
                                LoadingSpinner={LoadingSpinner}
                                PlusCircle={PlusCircle}
                                ArrowLeft={ArrowLeft}
                                Save={Save}
                                Trash2={Trash2}
                                RotateCcw={RotateCcw}
                                GENDER_OPTIONS={GENDER_OPTIONS}
                                STATUS_OPTIONS={STATUS_OPTIONS}
                                AnimalImageUpload={AnimalImageUpload}
                            />
                        )
                    } />
                    <Route path="/view-animal" element={
                        animalToView && (() => {
                            // Ownership logic:
                            // 1. If I'm the current owner (ownerId_public === my ID) ? PrivateAnimalDetail (full edit, but can return if transferred to me)
                            // 2. If I'm the creator but no longer the owner (breederId_public === my ID but ownerId_public !== my ID) ? ViewOnlyPrivateAnimalDetail (read-only, I transferred it away)
                            // 3. Otherwise ? ViewOnlyPrivateAnimalDetail (someone else owns it)
                            
                            const iCurrentlyOwn = animalToView.ownerId_public === userProfile?.id_public;
                            const iCreatedItButTransferred = animalToView.breederId_public === userProfile?.id_public && animalToView.ownerId_public !== userProfile?.id_public;
                            
                            if (iCurrentlyOwn) {
                                // I own it - full edit access (with return button instead of delete if transferred to me)
                                return (
                                    <PrivateAnimalDetail
                                        animal={animalToView}
                                        onClose={handleBackFromAnimal}
                                        onCloseAll={handleCloseAllAnimals}
                                        onEdit={handleEditAnimal}
                                        API_BASE_URL={API_BASE_URL}
                                        authToken={authToken}
                                        setShowImageModal={setShowImageModal}
                                        setEnlargedImageUrl={setEnlargedImageUrl}
                                        onUpdateAnimal={setAnimalToView}
                                        onHideAnimal={handleHideAnimal}
                                        showModalMessage={showModalMessage}
                                        onTransfer={(animal) => {
                                            setTransferAnimal(animal);
                                            setShowTransferModal(true);
                                        }}
                                        onViewAnimal={handleViewAnimal}
                                        onToggleOwned={toggleAnimalOwned}
                                        userProfile={userProfile}
                                    />
                                );
                            } else {
                                // Someone else owns it - read-only (or I created it but transferred it away)
                                return (
                                    <ViewOnlyPrivateAnimalDetail
                                        animal={animalToView}
                                        onClose={handleBackFromAnimal}
                                        onCloseAll={handleCloseAllAnimals}
                                        API_BASE_URL={API_BASE_URL}
                                        authToken={authToken}
                                        setShowImageModal={setShowImageModal}
                                        setEnlargedImageUrl={setEnlargedImageUrl}
                                        onHideAnimal={handleHideAnimal}
                                        showModalMessage={showModalMessage}
                                        onViewAnimal={handleViewAnimal}
                                    />
                                );
                            }
                        })()
                    } />
                    <Route path="/view-animal-old-backup" element={
                        animalToView && (
                            (() => {
                                const parseHealthRecords = (data) => {
                                    if (!data) return [];
                                    if (typeof data === 'string') {
                                        try {
                                            return JSON.parse(data);
                                        } catch (e) {
                                            console.error('Failed to parse health records:', e);
                                            return [];
                                        }
                                    }
                                    return Array.isArray(data) ? data : [];
                                };
                                const formattedBirthDate = animalToView.birthDate
                                    ? new Intl.DateTimeFormat('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(animalToView.birthDate))
                                    : '';
                                const handleShareAnimal = () => {
                                    const url = `${window.location.origin}/animal/${animalToView.id_public}`;
                                    navigator.clipboard.writeText(url).then(() => {
                                        setCopySuccessAnimal(true);
                                        setTimeout(() => setCopySuccessAnimal(false), 2000);
                                    });
                                };
                                return (
                                    <>
                                    <div className="w-full max-w-5xl mx-auto">
                                        <div className="bg-white border border-gray-300 rounded-t-lg p-6 mb-0">
                                            <div className="flex items-start justify-between mb-0">
                                                <button onClick={() => navigate('/')} className="flex items-center text-gray-600 hover:text-gray-800 font-medium">
                                                    <ArrowLeft size={20} className="mr-2" />
                                                    Back to Dashboard
                                                </button>
                                                <div className="flex flex-wrap items-center gap-2">
                                                    <button
                                                        onClick={handleShareAnimal}
                                                        data-tutorial-target="share-animal-btn"
                                                        className="px-3 py-2 bg-primary hover:bg-primary/90 text-black font-semibold rounded-lg transition flex items-center gap-2"
                                                        title={copySuccessAnimal ? 'Link Copied!' : 'Share Link'}
                                                    >
                                                        <Link size={18} />
                                                        <span className="text-sm">{copySuccessAnimal ? 'Link Copied!' : 'Share'}</span>
                                                    </button>
                                                    {userProfile && animalToView.ownerId_public === userProfile.id_public && !animalToView.isViewOnly && (
                                                        <>
                                                            <button 
                                                                data-tutorial-target="edit-animal-btn"
                                                                onClick={() => { setAnimalToEdit(animalToView); setSpeciesToAdd(animalToView.species); navigate('/edit-animal'); }} 
                                                                className="bg-primary hover:bg-primary/90 text-black font-semibold py-2 px-4 rounded-lg"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button 
                                                                onClick={() => { 
                                                                    setPreSelectedTransferAnimal(animalToView);
                                                                    setPreSelectedTransactionType('animal-sale');
                                                                    navigate('/budget');
                                                                }}
                                                                data-tutorial-target="transfer-animal-btn"
                                                                className="bg-accent hover:bg-accent/90 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center gap-2"
                                                            >
                                                                <ArrowLeftRight size={16} />
                                                                Transfer
                                                            </button>
                                                        </>
                                                    )}
                                                    {animalToView.isViewOnly && (
                                                        <button
                                                            onClick={() => handleHideViewOnlyAnimal(animalToView.id_public)}
                                                            className="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition flex items-center gap-2"
                                                        >
                                                            <Archive size={16} />
                                                            Hide
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        {/* Tab Navigation - Collapsible */}
                                        <div className="bg-white border border-t-0 border-gray-300">
                                            {/* Toggle Button */}
                                            <div className="px-4 py-2 flex items-center justify-between border-b border-gray-200">
                                                <span className="text-sm font-semibold text-gray-700">Tabs</span>
                                                <button
                                                    onClick={() => setShowTabs(!showTabs)}
                                                    className="p-1 hover:bg-gray-200 rounded transition-colors"
                                                    title={showTabs ? "Collapse tabs" : "Expand tabs"}
                                                >
                                                    {showTabs ? 'Hide' : 'Show'} 
                                                </button>
                                            </div>

                                            {/* Collapsible Tab Panel */}
                                            {showTabs && (
                                                <div className="px-4 py-3 flex flex-wrap gap-2">
                                                    {[
                            { id: 1, label: 'Overview', icon: '📋' },
                            { id: 2, label: 'Status & Privacy', icon: '🔒' },
                            { id: 3, label: 'Physical', icon: '🎨' },
                            { id: 4, label: 'Identification', icon: '🏷️' },
                            { id: 5, label: 'Lineage', icon: '🌳' },
                            { id: 6, label: 'Breeding', icon: '🥚' },
                            { id: 7, label: 'Health', icon: '🏥' },
                            { id: 8, label: 'Animal Care', icon: '🏠' },
                            { id: 11, label: 'Show', icon: '🏆' }
                                                    ].map(tab => (
                                                        <button
                                                            key={tab.id}
                                                            onClick={() => setDetailViewTab(tab.id)}
                                                            data-tutorial-target={tab.id === 2 ? 'status-privacy-tab' : tab.id === 3 ? 'physical-tab' : tab.id === 4 ? 'identification-tab' : tab.id === 5 ? 'lineage-tab' : tab.id === 6 ? 'breeding-tab' : tab.id === 7 ? 'health-tab' : tab.id === 8 ? 'husbandry-tab' : tab.id === 11 ? 'show-tab' : undefined}
                                                            className={`px-3 py-1.5 text-xs sm:text-sm font-medium rounded transition-colors ${
                                                                detailViewTab === tab.id 
                                                                    ? 'bg-primary text-black' 
                                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                            }`}
                                                            title={tab.label}
                                                        >
                                                            <span className="mr-1">{tab.icon}</span>
                                                            {tab.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Tab Content Wrapper */}
                                        <div className="bg-white border border-t-0 border-gray-300 rounded-b-lg p-6">
                                        {/* Tab 1: Overview */}
                                        {detailViewTab === 1 && (
                                            <div className="space-y-6">
                                                {/* Main Card - Two Column Layout */}
                                                <div className="bg-white border-2 border-gray-300 rounded-lg overflow-hidden relative">
                                                    {/* Public Profile Toggle - Top Right */}
                                                    <div className="absolute top-4 right-4 z-10">
                                                        <button
                                                            type="button"
                                                            data-tutorial-target="detail-private-toggle"
                                                            onClick={async () => {
                                                                const newIsDisplay = !animalToView.isDisplay;
                                                                try {
                                                                    const response = await fetch(`${API_BASE_URL}/animals/${animalToView.id_public}`, {
                                                                        method: 'PUT',
                                                                        headers: {
                                                                            'Content-Type': 'application/json',
                                                                            'Authorization': `Bearer ${authToken}`
                                                                        },
                                                                        body: JSON.stringify({ isDisplay: newIsDisplay })
                                                                    });
                                                                    if (response.ok) {
                                                                        setAnimalToView({ ...animalToView, isDisplay: newIsDisplay });
                                                                    } else {
                                                                        showModalMessage('Error', 'Failed to update visibility.');
                                                                    }
                                                                } catch (err) {
                                                                    console.error('Error updating visibility:', err);
                                                                    showModalMessage('Error', 'Failed to update visibility.');
                                                                }
                                                            }}
                                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg font-medium transition ${
                                                                animalToView.isDisplay 
                                                                    ? 'bg-green-100 text-green-800 hover:bg-green-200' 
                                                                    : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                                                            }`}
                                                        >
                                                            {animalToView.isDisplay ? (
                                                                <>
                                                                    <Eye size={16} />
                                                                    <span>Public</span>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <EyeOff size={16} />
                                                                    <span>Private</span>
                                                                </>
                                                            )}
                                                        </button>
                                                    </div>
                                                    <div className="flex relative">
                                                        {/* Left Column - Image */}
                                                        <div className="w-1/3 p-4 sm:p-6 flex flex-col items-center justify-center relative min-h-80">
                                                            {/* Birthdate badge */}
                                                            {animalToView.birthDate && (
                                                                <div className="absolute top-2 left-2 text-xs text-gray-600 bg-white/80 px-2 py-0.5 rounded">
                                                                    {formatDate(animalToView.birthDate)}
                                                                </div>
                                                            )}

                                                            {/* Gender badge */}
                                                            <div className="absolute top-2 right-2">
                                                                {animalToView.gender === 'Male' ? <Mars size={20} strokeWidth={2.5} className="text-blue-600" /> : animalToView.gender === 'Female' ? <Venus size={20} strokeWidth={2.5} className="text-pink-600" /> : animalToView.gender === 'Intersex' ? <VenusAndMars size={20} strokeWidth={2.5} className="text-purple-500" /> : <Circle size={20} strokeWidth={2.5} className="text-gray-500" />}
                                                            </div>

                                                            {/* Profile Image */}
                                                            <div className="flex items-center justify-center h-40 w-full">
                                                                {(animalToView.imageUrl || animalToView.photoUrl) ? (
                                                                    <img 
                                                                        src={animalToView.imageUrl || animalToView.photoUrl} 
                                                                        alt={animalToView.name} 
                                                                        className="max-w-32 max-h-32 w-auto h-auto object-contain rounded-md cursor-pointer hover:opacity-80 transition"
                                                                        onClick={() => {
                                                                            setEnlargedImageUrl(animalToView.imageUrl || animalToView.photoUrl);
                                                                            setShowImageModal(true);
                                                                        }}
                                                                        title="Click to enlarge"
                                                                    />
                                                                ) : (
                                                                    <div className="w-32 h-32 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
                                                                        <Cat size={48} />
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Icon row */}
                                                            <div className="flex justify-center items-center space-x-2 py-2 mt-2">
                                                                {animalToView.isOwned ? (
                                                                    <Heart size={14} className="text-black" />
                                                                ) : (
                                                                    <HeartOff size={14} className="text-black" />
                                                                )}
                                                                {animalToView.showOnPublicProfile ? (
                                                                    <Eye size={14} className="text-black" />
                                                                ) : (
                                                                    <EyeOff size={14} className="text-black" />
                                                                )}
                                                                {animalToView.isInMating && <Hourglass size={14} className="text-black" />}
                                                                {animalToView.isPregnant && <Bean size={14} className="text-black" />}
                                                                {animalToView.isNursing && <Milk size={14} className="text-black" />}
                                                                {animalToView.isNeutered && <Scissors size={14} className="text-black" />}
                                                            </div>

                                                            {/* Status text */}
                                                            <div className="text-sm font-medium text-gray-700 mt-2">
                                                                {animalToView.isViewOnly ? 'Sold' : (animalToView.status || 'Unknown')}
                                                            </div>
                                                        </div>

                                                        {/* Right Column - Info */}
                                                        <div className="w-2/3 p-4 sm:p-6 flex flex-col border-l border-gray-300 space-y-3">
                                                            {/* Species/Breed/Strain/CTC - At Top */}
                                                            <p className="text-sm text-gray-600">
                                                                {animalToView.species}
                                                                {animalToView.breed && ` � ${animalToView.breed}`}
                                                                {animalToView.strain && ` � ${animalToView.strain}`}
                                                                {animalToView.id_public && ` � ${animalToView.id_public}`}
                                                            </p>

                                                            {/* Name */}
                                                            <h2 className="text-2xl font-bold text-gray-800">
                                                                {animalToView.prefix ? `${animalToView.prefix} ` : ''}
                                                                {animalToView.name}
                                                                {animalToView.suffix ? ` ${animalToView.suffix}` : ''}
                                                            </h2>

                                                            {/* Appearance */}
                                                            {(animalToView.color || animalToView.coat || animalToView.coatPattern || animalToView.earset) && (
                                                                <p className="text-sm text-gray-700">
                                                                    {[
                                                                        animalToView.color,
                                                                        animalToView.coatPattern,
                                                                        animalToView.coat,
                                                                        animalToView.earset
                                                                    ].filter(Boolean).join(' ')}
                                                                </p>
                                                            )}

                                                            {/* Date of Birth */}
                                                            {animalToView.birthDate && (
                                                                <div className="text-sm text-gray-700 space-y-1">
                                                                    <p>
                                                                        Date of Birth: {formatDate(animalToView.birthDate)} ~ {(() => {
                                                                            const birth = new Date(animalToView.birthDate);
                                                                            const endDate = animalToView.deceasedDate ? new Date(animalToView.deceasedDate) : new Date();
                                                                            let years = endDate.getFullYear() - birth.getFullYear();
                                                                            let months = endDate.getMonth() - birth.getMonth();
                                                                            let days = endDate.getDate() - birth.getDate();
                                                                            
                                                                            if (days < 0) {
                                                                                months--;
                                                                                const prevMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                                                                                days += prevMonth.getDate();
                                                                            }
                                                                            if (months < 0) {
                                                                                years--;
                                                                                months += 12;
                                                                            }
                                                                            
                                                                            if (years > 0) {
                                                                                return `${years}y ${months}m ${days}d`;
                                                                            } else if (months > 0) {
                                                                                return `${months}m ${days}d`;
                                                                            } else {
                                                                                return `${days}d`;
                                                                            }
                                                                        })()}
                                                                    </p>
                                                                    {animalToView.deceasedDate && (
                                                                        <p className="text-red-600">
                                                                            Deceased: {formatDate(animalToView.deceasedDate)}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            )}
                                                            
                                                            {/* Tags at bottom of right column */}
                                                            {animalToView.tags && animalToView.tags.length > 0 && (
                                                                <div className="border-t border-gray-200 pt-3 mt-3">
                                                                    <div className="flex flex-wrap gap-2">
                                                                        {animalToView.tags.map((tag, idx) => (
                                                                            <span key={idx} className="inline-flex items-center bg-primary text-black text-xs font-semibold px-2 py-1 rounded-full">
                                                                                {tag}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Identification Card */}
                                                {(animalToView.microchipNumber || animalToView.registryCode || animalToView.breederAssignedId || animalToView.pedigreeRegId) && (
                                                    <div className="bg-white border-2 border-gray-300 rounded-lg p-4">
                                                        <h4 className="font-semibold text-gray-700 mb-2">Identification</h4>
                                                        <div className="text-sm space-y-1">
                                                            {animalToView.microchipNumber && <div><strong>Microchip:</strong> {animalToView.microchipNumber}</div>}
                                                            {animalToView.registryCode && <div><strong>Registry:</strong> {animalToView.registryCode}</div>}
                                                            {animalToView.breederAssignedId && <div><strong>Identification:</strong> {animalToView.breederAssignedId}</div>}
                                                            {animalToView.pedigreeRegId && <div><strong>Pedigree Reg ID:</strong> {animalToView.pedigreeRegId}</div>}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Genetic Code Card */}
                                                {animalToView.geneticCode && (
                                                    <div className="bg-white border-2 border-gray-300 rounded-lg p-4">
                                                        <h4 className="font-semibold text-gray-700 mb-2">Genetic Code</h4>
                                                        <div className="text-sm font-mono bg-gray-50 p-2 rounded border border-gray-200">
                                                            {animalToView.geneticCode}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Health Card */}
                                                {(animalToView.currentWeight || animalToView.bcs || animalToView.growthRecords?.length > 0 || animalToView.medicalConditions || animalToView.medications) && (
                                                    <div className="bg-white border-2 border-gray-300 rounded-lg p-4">
                                                        <h4 className="font-semibold text-gray-700 mb-2">Health</h4>
                                                        <div className="space-y-3 text-sm">
                                                            {/* Current Measurements Summary */}
                                                            {(() => {
                                                                // Compute current measurements from growth records if available
                                                                let currentWeight = null;
                                                                let currentLength = null;
                                                                let growthRecords = animalToView.growthRecords;
                                                                
                                                                // Parse growthRecords if it's a string
                                                                if (typeof growthRecords === 'string') {
                                                                    try {
                                                                        growthRecords = JSON.parse(growthRecords);
                                                                    } catch (e) {
                                                                        growthRecords = [];
                                                                    }
                                                                }
                                                                
                                                                if (growthRecords && Array.isArray(growthRecords) && growthRecords.length > 0) {
                                                                    const sorted = [...growthRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                                                                    currentWeight = sorted[0].weight;
                                                                    const withLength = sorted.find(r => r.length);
                                                                    currentLength = withLength ? withLength.length : null;
                                                                }
                                                                
                                                                return (currentWeight || animalToView.bcs || currentLength) && (
                                                                    <div className="grid grid-cols-2 gap-2">
                                                                        {currentWeight && (
                                                                            <div>
                                                                                <strong>Weight:</strong> {currentWeight}{animalToView.measurementUnits?.weight || 'g'}
                                                                                {animalToView.weightTrend && (
                                                                                    <span className={animalToView.weightTrend === 'up' ? 'text-red-600' : animalToView.weightTrend === 'down' ? 'text-green-600' : 'text-gray-600'}>
                                                                                        {animalToView.weightTrend === 'up' ? ' ↑' : animalToView.weightTrend === 'down' ? ' ↓' : ' →'}
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        )}
                                                                        {animalToView.bcs && <div><strong>BCS:</strong> {animalToView.bcs}</div>}
                                                                        {currentLength && (
                                                                            <div><strong>Length:</strong> {currentLength} {animalToView.measurementUnits?.length || 'cm'}</div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })()}
                                                            
                                                            {/* Conditions and Medications */}
                                                            {(animalToView.medicalConditions || animalToView.medications) && (
                                                                <div className="border-t border-gray-200 pt-2 space-y-2">
                                                                    {animalToView.medicalConditions && (() => {
                                                                        const parsed = parseHealthRecords(animalToView.medicalConditions);
                                                                        return parsed && parsed.length > 0 ? (
                                                                            <div>
                                                                                <strong>Conditions:</strong>
                                                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                                    {parsed.map((condition, idx) => (
                                                                                        <li key={idx} className="text-gray-700">
                                                                                            {condition.condition || condition.name}
                                                                                            {condition.notes && <span className="text-gray-600"> - {condition.notes}</span>}
                                                                                        </li>
                                                                                    ))}
                                                                                </ul>
                                                                            </div>
                                                                        ) : null;
                                                                    })()}
                                                                    {animalToView.medications && (() => {
                                                                        const parsed = parseHealthRecords(animalToView.medications);
                                                                        return parsed && parsed.length > 0 ? (
                                                                            <div>
                                                                                <strong>Medications:</strong>
                                                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                                    {parsed.map((med, idx) => (
                                                                                        <li key={idx} className="text-gray-700">
                                                                                            {med.medication || med.name}
                                                                                            {med.notes && <span className="text-gray-600"> - {med.notes}</span>}
                                                                                        </li>
                                                                                    ))}
                                                                                </ul>
                                                                            </div>
                                                                        ) : null;
                                                                    })()}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Reproductive Status Card */}
                                                {!animalToView.isNeutered && (animalToView.heatStatus || animalToView.lastHeatDate || animalToView.matingDate) && (
                                                    <div className="bg-white border-2 border-gray-300 rounded-lg p-4">
                                                        <h4 className="font-semibold text-gray-700 mb-2">🌿 Reproductive Status</h4>
                                                        <div className="text-sm space-y-1">
                                                            {animalToView.heatStatus && <div><strong>Heat Status:</strong> {animalToView.heatStatus}</div>}
                                                            {animalToView.lastHeatDate && <div><strong>Last Heat:</strong> {formatDate(animalToView.lastHeatDate)}</div>}
                                                            {animalToView.matingDate && <div><strong>Last Mating:</strong> {animalToView.matingDate}</div>}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Parents Card - Always Visible */}
                                                <div className="bg-white border-2 border-gray-300 rounded-lg p-4">
                                                    <h4 className="font-semibold text-gray-700 mb-4">Parents</h4>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        {/* Sire Card */}
                                                        {sireData ? (
                                                            <div 
                                                                onClick={() => {
                                                                    setAnimalToView(sireData);
                                                                    setDetailViewTab(1);
                                                                }}
                                                                className="bg-gray-50 rounded-lg border border-gray-200 p-3 cursor-pointer hover:shadow-md transition"
                                                            >
                                                                <div className="w-full h-48 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center mb-3">
                                                                    <AnimalImage src={sireData.imageUrl || sireData.photoUrl} alt={sireData.name} className="w-full h-full object-cover" iconSize={32} />
                                                                </div>
                                                                <div className="text-center">
                                                                    <p className="font-semibold text-gray-800 text-sm">
                                                                        {sireData.prefix ? `${sireData.prefix} ` : ''}{sireData.name}{sireData.suffix ? ` ${sireData.suffix}` : ''}
                                                                    </p>
                                                                    <p className="text-xs text-gray-600 mt-1">
                                                                        {sireData.gender}
                                                                    </p>
                                                                    {sireData.birthDate && (
                                                                        <p className="text-xs text-gray-500 mt-2">
                                                                            Born: {formatDate(sireData.birthDate)}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-3">
                                                                <div className="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center mb-3">
                                                                    <Cat size={48} className="text-gray-400" />
                                                                </div>
                                                                <div className="text-center">
                                                                    <p className="text-sm text-gray-500 italic">Father unknown</p>
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Dam Card */}
                                                        {damData ? (
                                                            <div 
                                                                onClick={() => {
                                                                    setAnimalToView(damData);
                                                                    setDetailViewTab(1);
                                                                }}
                                                                className="bg-gray-50 rounded-lg border border-gray-200 p-3 cursor-pointer hover:shadow-md transition"
                                                            >
                                                                <div className="w-full h-48 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center mb-3">
                                                                    <AnimalImage src={damData.imageUrl || damData.photoUrl} alt={damData.name} className="w-full h-full object-cover" iconSize={32} />
                                                                </div>
                                                                <div className="text-center">
                                                                    <p className="font-semibold text-gray-800 text-sm">
                                                                        {damData.prefix ? `${damData.prefix} ` : ''}{damData.name}{damData.suffix ? ` ${damData.suffix}` : ''}
                                                                    </p>
                                                                    <p className="text-xs text-gray-600 mt-1">
                                                                        {damData.gender}
                                                                    </p>
                                                                    {damData.birthDate && (
                                                                        <p className="text-xs text-gray-500 mt-2">
                                                                            Born: {formatDate(damData.birthDate)}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-3">
                                                                <div className="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center mb-3">
                                                                    <Cat size={48} className="text-gray-400" />
                                                                </div>
                                                                <div className="text-center">
                                                                    <p className="text-sm text-gray-500 italic">Mother unknown</p>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Offspring Card */}
                                                {offspringData && offspringData.length > 0 && (
                                                    <div className="bg-white border-2 border-gray-300 rounded-lg p-4">
                                                        <h4 className="font-semibold text-gray-700 mb-4">Offspring ({offspringData.length})</h4>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                            {offspringData.map(offspring => (
                                                                <div 
                                                                    key={offspring.id_public}
                                                                    onClick={() => {
                                                                        setAnimalToView(offspring);
                                                                        setDetailViewTab(1);
                                                                    }}
                                                                    className="bg-gray-50 rounded-lg border border-gray-200 p-3 cursor-pointer hover:shadow-md transition"
                                                                >
                                                                    <div className="w-full h-48 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center mb-3">
                                                                        <AnimalImage src={offspring.imageUrl || offspring.photoUrl} alt={offspring.name} className="w-full h-full object-cover" iconSize={32} />
                                                                    </div>
                                                                    <div className="text-center">
                                                                        <p className="font-semibold text-gray-800 text-sm">
                                                                            {offspring.prefix ? `${offspring.prefix} ` : ''}{offspring.name}{offspring.suffix ? ` ${offspring.suffix}` : ''}
                                                                        </p>
                                                                        <p className="text-xs text-gray-600 mt-1">
                                                                            {offspring.gender}
                                                                        </p>
                                                                        {offspring.birthDate && (
                                                                            <p className="text-xs text-gray-500 mt-2">
                                                                                Born: {formatDate(offspring.birthDate)}
                                                                            </p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}


                                            </div>
                                        )}

                                        {/* Tab 2: Status & Privacy */}
                                        {detailViewTab === 2 && (
                                            <div className="space-y-6">
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div>
                                                            <span className="text-sm text-gray-600">Status</span>
                                                            <p className="font-medium">{animalToView.status || 'Unknown'}</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-sm text-gray-600">🏠 Keeper</span>
                                                            <p className="font-medium">{animalToView.keeperName || ''}</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-sm text-gray-600">Public Profile</span>
                                                            <p className="font-medium">{animalToView.showOnPublicProfile ? 'Yes' : 'No'}</p>
                                                        </div>
                                                        <div>
                                                            <span className="text-sm text-gray-600">Owned</span>
                                                            <p className="font-medium">{animalToView.isOwned ? 'Yes' : 'No'}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                {animalToView.keeperHistory && animalToView.keeperHistory.length > 0 && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">?? Keeper History</h3>
                                                        <div className="space-y-2">
                                                            {animalToView.keeperHistory.map((entry, idx) => (
                                                                <div key={idx} className="flex items-center gap-3 p-3 bg-white rounded border border-gray-200">
                                                                    <div className="flex-1 min-w-0">
                                                                        <p className="text-sm font-semibold text-gray-800">{entry.name || 'Unknown'}</p>
                                                                        {entry.userId_public && <p className="text-xs text-gray-400 font-mono">{entry.userId_public}</p>}
                                                                    </div>
                                                                    {entry.country && (
                                                                        <div className="flex items-center gap-1 flex-shrink-0">
                                                                            <span className={`${getCountryFlag(entry.country)} inline-block h-4 w-6`}></span>
                                                                            <span className="text-xs text-gray-500">{getCountryName(entry.country)}</span>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                    <h3 className="text-lg font-semibold text-gray-700 mb-3">Breeder Info</h3>
                                                    <div className="text-sm">
                                                        <strong>Breeder:</strong>{' '}
                                                        {animalToView.manualBreederName ? (
                                                            <span>{animalToView.manualBreederName}</span>
                                                        ) : animalToView.breederId_public ? (
                                                            viewAnimalBreederInfo ? (
                                                                <span>
                                                                    {(() => {
                                                                        const showPersonal = viewAnimalBreederInfo.showPersonalName ?? false;
                                                                        const showBreeder = viewAnimalBreederInfo.showBreederName ?? false;
                                                                        
                                                                        if (showPersonal && showBreeder && viewAnimalBreederInfo.personalName && viewAnimalBreederInfo.breederName) {
                                                                            return `${viewAnimalBreederInfo.personalName} (${viewAnimalBreederInfo.breederName})`;
                                                                        } else if (showBreeder && viewAnimalBreederInfo.breederName) {
                                                                            return viewAnimalBreederInfo.breederName;
                                                                        } else if (showPersonal && viewAnimalBreederInfo.personalName) {
                                                                            return viewAnimalBreederInfo.personalName;
                                                                        } else {
                                                                            return 'Unknown Breeder';
                                                                        }
                                                                    })()}
                                                                </span>
                                                            ) : (
                                                                <span className="font-mono text-accent">{animalToView.breederId_public}</span>
                                                            )
                                                        ) : (
                                                            <span className="text-gray-500 italic">Not specified</span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Tab 3: Physical Profile */}
                                        {detailViewTab === 3 && (
                                            <div className="space-y-6">
                                                {/* Appearance - Always show */}
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                    <h3 className="text-lg font-semibold text-gray-700">✨ Appearance</h3>
                                                    {(() => {
                                                        const fields = [
                                                            { key: 'color', label: 'Color' },
                                                            { key: 'coatPattern', label: 'Pattern' },
                                                            { key: 'coat', label: 'Coat Type' },
                                                            { key: 'earset', label: 'Earset' },
                                                            { key: 'phenotype', label: 'Phenotype' },
                                                            { key: 'morph', label: 'Morph' },
                                                            { key: 'markings', label: 'Markings' },
                                                            { key: 'eyeColor', label: 'Eye Color' },
                                                            { key: 'nailColor', label: 'Nail/Claw Color' },
                                                            { key: 'carrierTraits', label: 'Carrier Traits' },
                                                        ].filter(f => animalToView[f.key]);
                                                        
                                                        return fields.length > 0 ? (
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                                {fields.map(f => (
                                                                    <div key={f.key}><span className="text-gray-600">{f.label}:</span> <strong>{animalToView[f.key]}</strong></div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <div className="text-sm text-gray-500">No appearance data recorded yet.</div>
                                                        );
                                                    })()}
                                                </div>
                                                
                                                {/* Genetic Code - Always show */}
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                    <h3 className="text-lg font-semibold text-gray-700 mb-2">🧬 Genetic Code</h3>
                                                    <p className="text-sm font-mono">{animalToView.geneticCode || 'Not specified'}</p>
                                                </div>
                                                
                                                {/* Life Stage - Always show */}
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                    <span className="text-sm text-gray-600">Life Stage:</span> <strong>{animalToView.lifeStage || 'Not specified'}</strong>
                                                </div>

                                                {/* Current Measurements - Always show */}
                                                {(() => {
                                                    let growthRecords = animalToView.growthRecords;
                                                    if (typeof growthRecords === 'string') {
                                                        try {
                                                            growthRecords = JSON.parse(growthRecords);
                                                        } catch (e) {
                                                            growthRecords = [];
                                                        }
                                                    }
                                                    
                                                    // Compute current weight, length, and height from growth records
                                                    let currentWeight = null;
                                                    let currentLength = null;
                                                    let currentHeight = null;
                                                    if (growthRecords && Array.isArray(growthRecords) && growthRecords.length > 0) {
                                                        const sorted = [...growthRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                                                        currentWeight = sorted[0].weight;
                                                        const withLength = sorted.find(r => r.length);
                                                        currentLength = withLength ? withLength.length : null;
                                                        const withHeight = sorted.find(r => r.height);
                                                        currentHeight = withHeight ? withHeight.height : null;
                                                    }
                                                    
                                                    // Fallback to stored values if no growth records
                                                    if (!currentWeight) currentWeight = animalToView.currentWeight;
                                                    
                                                    // Always show Current Measurements section
                                                    return (
                                                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                            <h3 className="text-lg font-semibold text-gray-700">Current Measurements</h3>
                                                            {(currentWeight || animalToView.bcs || currentLength || currentHeight) ? (
                                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                                    {currentWeight && (
                                                                        <div><span className="text-gray-600">Weight:</span> <strong>{currentWeight} {animalToView.measurementUnits?.weight || 'g'}</strong></div>
                                                                    )}
                                                                    {animalToView.bcs && (
                                                                        <div><span className="text-gray-600">BCS:</span> <strong>{animalToView.bcs}</strong></div>
                                                                    )}
                                                                    {currentLength && (
                                                                        <div><span className="text-gray-600">Length:</span> <strong>{currentLength} {animalToView.measurementUnits?.length || 'cm'}</strong></div>
                                                                    )}
                                                                    {currentHeight && (
                                                                        <div><span className="text-gray-600">Height:</span> <strong>{currentHeight} {animalToView.measurementUnits?.length || 'cm'}</strong></div>
                                                                    )}
                                                                </div>
                                                            ) : (
                                                                <div className="text-sm text-gray-500">No measurements recorded yet.</div>
                                                            )}
                                                        </div>
                                                    );
                                                })()}

                                                {/* Growth Curve Charts - Weight and Length */}
                                                {(() => {
                                                    let growthRecords = animalToView.growthRecords;
                                                    if (typeof growthRecords === 'string') {
                                                        try {
                                                            growthRecords = JSON.parse(growthRecords);
                                                        } catch (e) {
                                                            growthRecords = [];
                                                        }
                                                    }
                                                    
                                                    // Ensure growthRecords is an array
                                                    if (!growthRecords) growthRecords = [];
                                                    
                                                    // If fewer than 1 entry, show empty chart placeholder
                                                    if (growthRecords.length < 1) {
                                                        return (
                                                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Growth Curves</h3>
                                                                <svg width="100%" height="300" viewBox="0 0 500 300" style={{ maxWidth: '100%' }} preserveAspectRatio="xMidYMid meet">
                                                                    {/* Grid lines */}
                                                                    {[0, 0.25, 0.5, 0.75, 1].map((ratio, i) => {
                                                                        const y = 20 + 260 * (1 - ratio);
                                                                        return (
                                                                            <g key={`grid-${i}`}>
                                                                                <line x1={70} y1={y} x2={470} y2={y} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4" />
                                                                                <text x={58} y={y} textAnchor="end" dy="0.3em" fontSize="11" fill="#999">📏</text>
                                                                            </g>
                                                                        );
                                                                    })}
                                                                    
                                                                    {/* Axes */}
                                                                    <line x1={70} y1={20} x2={70} y2={280} stroke="#333" strokeWidth="2" />
                                                                    <line x1={70} y1={280} x2={470} y2={280} stroke="#333" strokeWidth="2" />
                                                                    
                                                                    {/* Empty state message */}
                                                                    <text x={270} y={150} textAnchor="middle" fontSize="14" fill="#999">
                                                                        📈 No growth data recorded yet
                                                                    </text>
                                                                </svg>
                                                                <p className="text-xs text-gray-500 mt-2">Growth curves will appear once measurement entries are added.</p>
                                                            </div>
                                                        );
                                                    }
                                                    
                                                    // Full interactive charts with 1+ entries
                                                    return (() => {
                                                        const sorted = [...growthRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                                                        const weights = sorted.map(r => parseFloat(r.weight) || 0).filter(w => w > 0);
                                                        const lengths = sorted
                                                            .filter(record => record.length && !isNaN(parseFloat(record.length)))
                                                            .map(record => parseFloat(record.length));
                                                        const heights = sorted
                                                            .filter(record => record.height && !isNaN(parseFloat(record.height)))
                                                            .map(record => parseFloat(record.height));
                                                        
                                                        if (weights.length < 1) return null;
                                                        
                                                        const width = 500;
                                                        const height = 250;
                                                        const margin = { top: 20, right: 30, bottom: 50, left: 70 };
                                                        const graphWidth = width - margin.left - margin.right;
                                                        const graphHeight = height - margin.top - margin.bottom;
                                                        
                                                        // Weight chart setup
                                                        const minWeight = Math.min(...weights);
                                                        const maxWeight = Math.max(...weights);
                                                        const weightPadding = (maxWeight - minWeight) * 0.1 || 5;
                                                        const weightChartMin = Math.max(0, minWeight - weightPadding);
                                                        const weightChartMax = maxWeight + weightPadding;
                                                        const weightRange = weightChartMax - weightChartMin;
                                                        
                                                        // Length chart setup
                                                        const hasLengthData = lengths.length >= 1;
                                                        let minLength, maxLength, lengthRange, lengthChartMin, lengthChartMax;
                                                        if (hasLengthData) {
                                                            minLength = Math.min(...lengths);
                                                            maxLength = Math.max(...lengths);
                                                            const lengthPadding = (maxLength - minLength) * 0.1 || 1;
                                                            lengthChartMin = Math.max(0, minLength - lengthPadding);
                                                            lengthChartMax = maxLength + lengthPadding;
                                                            lengthRange = lengthChartMax - lengthChartMin;
                                                        }
                                                        
                                                        // Height chart setup
                                                        const hasHeightData = heights.length >= 1;
                                                        let minHeight, maxHeight, heightRange, heightChartMin, heightChartMax;
                                                        if (hasHeightData) {
                                                            minHeight = Math.min(...heights);
                                                            maxHeight = Math.max(...heights);
                                                            const heightPadding = (maxHeight - minHeight) * 0.1 || 1;
                                                            heightChartMin = Math.max(0, minHeight - heightPadding);
                                                            heightChartMax = maxHeight + heightPadding;
                                                            heightRange = heightChartMax - heightChartMin;
                                                        }
                                                        
                                                        // Create points for weight
                                                        const weightPoints = sorted.map((record, idx) => ({
                                                            x: margin.left + (idx / Math.max(1, sorted.length - 1)) * graphWidth,
                                                            y: margin.top + graphHeight - ((parseFloat(record.weight) - weightChartMin) / weightRange) * graphHeight,
                                                            weight: record.weight,
                                                            length: record.length,
                                                            height: record.height,
                                                            bcs: record.bcs,
                                                            notes: record.notes,
                                                            date: record.date
                                                        }));
                                                        
                                                        // Create points for length
                                                        const lengthPoints = hasLengthData ? sorted.filter(r => r.length).map((record, idx) => ({
                                                            x: margin.left + (sorted.indexOf(record) / Math.max(1, sorted.length - 1)) * graphWidth,
                                                            y: margin.top + graphHeight - ((parseFloat(record.length) - lengthChartMin) / lengthRange) * graphHeight,
                                                            weight: record.weight,
                                                            length: record.length,
                                                            height: record.height,
                                                            bcs: record.bcs,
                                                            notes: record.notes,
                                                            date: record.date
                                                        })) : [];
                                                        
                                                        // Create points for height
                                                        const heightPoints = hasHeightData ? sorted.filter(r => r.height).map((record, idx) => ({
                                                            x: margin.left + (sorted.indexOf(record) / Math.max(1, sorted.length - 1)) * graphWidth,
                                                            y: margin.top + graphHeight - ((parseFloat(record.height) - heightChartMin) / heightRange) * graphHeight,
                                                            weight: record.weight,
                                                            length: record.length,
                                                            height: record.height,
                                                            bcs: record.bcs,
                                                            notes: record.notes,
                                                            date: record.date
                                                        })) : [];
                                                        
                                                        const weightPathData = weightPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                                        const lengthPathData = lengthPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                                        const heightPathData = heightPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
                                                        
                                                        const getBCSDescription = (bcsValue) => {
                                                            const bcsMap = {
                                                                '1': 'Emaciated',
                                                                '2': 'Thin',
                                                                '3': 'Ideal',
                                                                '4': 'Overweight',
                                                                '5': 'Obese'
                                                            };
                                                            return bcsMap[bcsValue] || bcsValue;
                                                        };
                                                        
                                                        const renderChart = (points, label, color, pathData, chartMin, chartMax) => {
                                                            const range = chartMax - chartMin;
                                                            return (
                                                                <svg key={`chart-${label}`} width="100%" height="300" viewBox={`0 0 ${width} ${height}`} style={{ maxWidth: '100%' }} preserveAspectRatio="xMidYMid meet">
                                                                    {/* Grid lines */}
                                                                    {[0, 0.25, 0.5, 0.75, 1].map((ratio, i) => {
                                                                        const y = margin.top + graphHeight * (1 - ratio);
                                                                        const axisLabel = (chartMin + range * ratio).toFixed(1);
                                                                        return (
                                                                            <g key={`grid-${i}`}>
                                                                                <line x1={margin.left} y1={y} x2={width - margin.right} y2={y} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4" />
                                                                                <text x={margin.left - 12} y={y} textAnchor="end" dy="0.3em" fontSize="11" fill="#666">{axisLabel}</text>
                                                                            </g>
                                                                        );
                                                                    })}
                                                                    
                                                                    {/* Axes */}
                                                                    <line x1={margin.left} y1={margin.top} x2={margin.left} y2={height - margin.bottom} stroke={color} strokeWidth="2" />
                                                                    <line x1={margin.left} y1={height - margin.bottom} x2={width - margin.right} y2={height - margin.bottom} stroke="#333" strokeWidth="2" />
                                                                    
                                                                    {/* Y-axis label */}
                                                                    <text x={20} y={margin.top + graphHeight / 2} textAnchor="middle" fontSize="12" fill={color} fontWeight="600" transform={`rotate(-90 20 ${margin.top + graphHeight / 2})`}>
                                                                        {label} ({label === 'Weight' ? animalToView.measurementUnits?.weight || 'g' : animalToView.measurementUnits?.length || 'cm'})
                                                                    </text>
                                                                    
                                                                    {/* X-axis label */}
                                                                    <text x={margin.left + graphWidth / 2} y={height - 8} textAnchor="middle" fontSize="12" fill="#333" fontWeight="600">
                                                                        Date
                                                                    </text>
                                                                    
                                                                    {/* X-axis date labels */}
                                                                    {points.map((p, i) => (
                                                                        i % Math.max(1, Math.floor(points.length / 5)) === 0 && (
                                                                            <text key={`date-${i}`} x={p.x} y={height - margin.bottom + 25} textAnchor="middle" fontSize="10" fill="#666">
                                                                                {formatDate(p.date)}
                                                                            </text>
                                                                        )
                                                                    ))}
                                                                    
                                                                    {/* Curve */}
                                                                    <path d={pathData} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                                                    
                                                                    {/* Points */}
                                                                    {points.map((p, i) => {
                                                                        const tooltipText = [
                                                                            `Date: ${formatDate(p.date)}`,
                                                                            `Weight: ${p.weight} ${animalToView.measurementUnits?.weight || 'g'}`,
                                                                            p.length ? `Length: ${p.length} ${animalToView.measurementUnits?.length || 'cm'}` : null,
                                                                            p.bcs ? `BCS: ${p.bcs} - ${getBCSDescription(p.bcs)}` : null,
                                                                            p.notes ? `Notes: ${p.notes}` : null
                                                                        ].filter(Boolean).join('\n');
                                                                        
                                                                        // Color gradient from green (earliest) to red (latest)
                                                                        const colorRatio = points.length > 1 ? i / (points.length - 1) : 0;
                                                                        let dotColor;
                                                                        if (colorRatio < 0.5) {
                                                                            const t = colorRatio * 2;
                                                                            const r = Math.round(144 + (255 - 144) * t);
                                                                            const g = 191;
                                                                            const b = Math.round(71 + (0 - 71) * t);
                                                                            dotColor = `rgb(${r}, ${g}, ${b})`;
                                                                        } else {
                                                                            const t = (colorRatio - 0.5) * 2;
                                                                            const r = 255;
                                                                            const g = Math.round(191 - (191) * t);
                                                                            const b = 0;
                                                                            dotColor = `rgb(${r}, ${g}, ${b})`;
                                                                        }
                                                                        
                                                                        return (
                                                                            <circle key={`point-${i}`} cx={p.x} cy={p.y} r="5" fill={dotColor} stroke="#fff" strokeWidth="2">
                                                                                <title>{tooltipText}</title>
                                                                            </circle>
                                                                        );
                                                                    })}
                                                                </svg>
                                                            );
                                                        };
                                                        
                                                        return (
                                                            <div className="space-y-4">
                                                                {/* Weight Chart */}
                                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                                    <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                                        <span className="inline-block w-3 h-1 bg-blue-500 rounded"></span>
                                                                        Weight Growth Curve
                                                                    </h3>
                                                                    {renderChart(weightPoints, 'Weight', '#3b82f6', weightPathData, weightChartMin, weightChartMax)}
                                                                    <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                                                </div>
                                                                
                                                                {/* Length Chart */}
                                                                {hasLengthData && (
                                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                                        <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                                            <span className="inline-block w-3 h-1 bg-orange-500 rounded"></span>
                                                                            Length Growth Curve
                                                                        </h3>
                                                                        {renderChart(lengthPoints, 'Length', '#ff8c42', lengthPathData, lengthChartMin, lengthChartMax)}
                                                                        <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Height Chart */}
                                                                {hasHeightData && (
                                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                                        <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                                            <span className="inline-block w-3 h-1 bg-purple-500 rounded"></span>
                                                                            Height at Withers Growth Curve
                                                                        </h3>
                                                                        {renderChart(heightPoints, 'Height', '#9333ea', heightPathData, heightChartMin, heightChartMax)}
                                                                        <p className="text-xs text-gray-500 mt-2">Hover over points to see detailed measurements and notes.</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })();
                                                })()}
                                            </div>
                                        )}

                                        {/* Tab 4: Identification */}
                                        {detailViewTab === 4 && (
                                            <div className="space-y-6">
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                    <h3 className="text-lg font-semibold text-gray-700">🔢 Identification Numbers</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                        <div><span className="text-gray-600">CritterTrack ID:</span> <strong>{animalToView.id_public || ''}</strong></div>
                                                        <div><span className="text-gray-600">Identification:</span> <strong>{animalToView.breederAssignedId || ''}</strong></div>
                                                        {animalToView.microchipNumber && <div><span className="text-gray-600">Microchip:</span> <strong>{animalToView.microchipNumber}</strong></div>}
                                                        <div><span className="text-gray-600">Pedigree Reg ID:</span> <strong>{animalToView.pedigreeRegistrationId || ''}</strong></div>
                                                    </div>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                    <h3 className="text-lg font-semibold text-gray-700">🗂️ Classification</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                        <div><span className="text-gray-600">Species:</span> <strong>{animalToView.species}</strong></div>
                                                        <div><span className="text-gray-600">Breed:</span> <strong>{animalToView.breed || ''}</strong></div>
                                                        <div><span className="text-gray-600">Strain:</span> <strong>{animalToView.strain || ''}</strong></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Tab 5: Lineage */}
                                        {detailViewTab === 5 && (
                                            <div className="space-y-6">
                                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                    <div className="flex justify-between items-center mb-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">🌳 Parents</h3>
                                                        <button
                                                            onClick={() => setShowPedigreeChart(true)}
                                                            data-tutorial-target="pedigree-btn"
                                                            className="flex items-center gap-2 px-3 py-1.5 bg-primary hover:bg-primary/90 text-black text-sm font-semibold rounded-lg transition"
                                                        >
                                                            <FileText size={16} />
                                                            Pedigree
                                                        </button>
                                                    </div>
                                                    <div className="flex flex-col sm:grid sm:grid-cols-2 gap-4">
                                                        <ParentCard 
                                                            parentId={animalToView.fatherId_public} 
                                                            parentType="Father"
                                                            authToken={authToken}
                                                            API_BASE_URL={API_BASE_URL}
                                                            onViewAnimal={handleViewAnimal}
                                                        />
                                                        <ParentCard 
                                                            parentId={animalToView.motherId_public} 
                                                            parentType="Mother"
                                                            authToken={authToken}
                                                            API_BASE_URL={API_BASE_URL}
                                                            onViewAnimal={handleViewAnimal}
                                                        />
                                                    </div>
                                                </div>
                                                {animalToView.origin && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                        <span className="text-sm text-gray-600">Origin:</span> <strong>{animalToView.origin}</strong>
                                                    </div>
                                                )}

                                                {/* Breeding Records - Accordion View (Nested) */}
                                                {animalToView.breedingRecords && animalToView.breedingRecords.length > 0 && (
                                                    <div className="bg-purple-50 p-4 rounded-lg border border-purple-200 space-y-3">
                                                        <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-purple-600 mr-2">📊</span>Breeding Records</h3>
                                                        <div className="space-y-2">
                                                            {animalToView.breedingRecords.map((record, idx) => {
                                                                const isExpanded = expandedBreedingRecords[idx];
                                                                const countSummary = [
                                                                    record.litterSizeBorn !== null && `${record.litterSizeBorn} born`,
                                                                    record.stillbornCount && `${record.stillbornCount} stillborn`,
                                                                    record.litterSizeWeaned !== null && `${record.litterSizeWeaned} weaned`
                                                                ].filter(Boolean).join(' � ') || 'No counts';
                                                                return (
                                                                    <div key={idx} className={`bg-white rounded border transition-all ${isExpanded ? 'border-purple-300 shadow-md' : 'border-purple-100'}`}>
                                                                        <div 
                                                                            onClick={() => setExpandedBreedingRecords({...expandedBreedingRecords, [idx]: !isExpanded})}
                                                                            className="p-3 flex items-center justify-between cursor-pointer hover:bg-purple-50 transition rounded"
                                                                        >
                                                                            <div className="flex items-center gap-3 flex-1">
                                                                                <span className={`text-lg transition-transform ${isExpanded ? 'rotate-90' : ''}`}>▶️</span>
                                                                                {record.litterName ? (
                                                                                    <>
                                                                                        <span className="px-2 py-0.5 rounded text-xs font-bold bg-purple-700 text-white flex-shrink-0">{record.litterName}</span>
                                                                                        {record.litterId && <span className="text-xs font-mono text-gray-400 flex-shrink-0">{record.litterId}</span>}
                                                                                    </>
                                                                                ) : record.litterId ? (
                                                                                    <span className="font-mono px-2 py-0.5 rounded text-xs font-semibold flex-shrink-0 bg-purple-300 text-purple-800">{record.litterId}</span>
                                                                                ) : null}
                                                                                <div className="text-sm text-gray-700 flex items-center gap-2 flex-wrap">
                                                                                    {record.birthEventDate && <><span>{formatDate(record.birthEventDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                                    {!record.birthEventDate && formatDate(record.matingDate) && <><span>{formatDate(record.matingDate)}</span><span className="text-gray-400">&bull;</span></>}
                                                                                    {record.mate && <><span>{record.mate}</span><span className="text-gray-400">&bull;</span></>}
                                                                                    <span className="text-purple-700 font-medium">{countSummary}</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        {isExpanded && (
                                                                            <div className="border-t border-purple-100 p-4 bg-purple-50 space-y-4">
                                                                                {/* CTL ID + Litter Name */}
                                                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                                    <div><div className="text-gray-600 text-xs">CTL ID</div><div className="font-mono text-xs font-semibold text-gray-700">{record.litterId || 'Not Linked'}</div></div>
                                                                                    {record.litterName && <div><div className="text-gray-600 text-xs">Litter Name</div><div className="font-semibold text-purple-800">{record.litterName}</div></div>}
                                                                                </div>
                                                                                {/* Mate, Dates, Method, Condition, Outcome */}
                                                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                                                                    {record.mate && (<div><div className="text-gray-600 text-xs">Mate / Other Parent</div><div className="font-semibold text-gray-800">{record.mate}</div></div>)}
                                                                                    <div><div className="text-gray-600 text-xs">Mating Date</div><div className="font-semibold text-gray-800">{formatDate(record.matingDate) || '�'}</div></div>
                                                                                    {record.breedingMethod && (<div><div className="text-gray-600 text-xs">Breeding Method</div><div className="font-semibold text-gray-800">{record.breedingMethod}</div></div>)}
                                                                                    {record.breedingConditionAtTime && (<div><div className="text-gray-600 text-xs">Breeding Condition</div><div className="font-semibold text-gray-800">{record.breedingConditionAtTime}</div></div>)}
                                                                                    {record.outcome && (<div><div className="text-gray-600 text-xs">Outcome</div><div className={`font-semibold ${record.outcome === 'Successful' ? 'text-green-600' : record.outcome === 'Unsuccessful' ? 'text-red-600' : 'text-gray-600'}`}>{record.outcome}</div></div>)}
                                                                                    {record.birthEventDate && (<div><div className="text-gray-600 text-xs">Birth Date</div><div className="font-semibold text-gray-800">{formatDate(record.birthEventDate) || '�'}</div></div>)}
                                                                                    {record.birthMethod && (<div><div className="text-gray-600 text-xs">Birth Method</div><div className="font-semibold text-gray-800">{record.birthMethod}</div></div>)}
                                                                                </div>
                                                                                {/* Notes */}
                                                                                {record.notes && (<div className="bg-white p-3 rounded border border-purple-100"><div className="text-sm font-semibold text-gray-700 mb-2">Notes</div><div className="text-sm text-gray-700 italic">{record.notes}</div></div>)}
                                                                                {/* Offspring Counts */}
                                                                                <div className="bg-white p-3 rounded border border-purple-100">
                                                                                    <div className="text-sm font-semibold text-gray-700 mb-3">Offspring Counts</div>
                                                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                                                        <div><div className="text-gray-600 text-xs">Total Born</div><div className="text-2xl font-bold text-purple-600">{record.litterSizeBorn !== null ? record.litterSizeBorn : '�'}</div></div>
                                                                                        <div><div className="text-gray-600 text-xs">Stillborn</div><div className="text-2xl font-bold text-gray-600">{record.stillbornCount || '0'}</div></div>
                                                                                        <div><div className="text-gray-600 text-xs">Weaned</div><div className="text-2xl font-bold text-green-600">{record.litterSizeWeaned !== null ? record.litterSizeWeaned : '�'}</div></div>
                                                                                        {breedingRecordLitters?.[record.litterId]?.maleCount != null && <div><div className="text-gray-600 text-xs">Males</div><div className="text-2xl font-bold text-blue-500">{breedingRecordLitters[record.litterId].maleCount}</div></div>}
                                                                                        {breedingRecordLitters?.[record.litterId]?.femaleCount != null && <div><div className="text-gray-600 text-xs">Females</div><div className="text-2xl font-bold text-pink-500">{breedingRecordLitters[record.litterId].femaleCount}</div></div>}
                                                                                        {breedingRecordLitters?.[record.litterId]?.unknownCount != null && breedingRecordLitters[record.litterId].unknownCount > 0 && <div><div className="text-gray-600 text-xs">Unknown / Intersex</div><div className="text-2xl font-bold text-gray-600">{breedingRecordLitters[record.litterId].unknownCount}</div></div>}
                                                                                        {breedingRecordLitters?.[record.litterId]?.inbreedingCoefficient != null && <div><div className="text-gray-600 text-xs">COI</div><div className="text-xl font-bold text-orange-600">{breedingRecordLitters[record.litterId].inbreedingCoefficient.toFixed(2)}%</div></div>}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}

                                                <OffspringSection
                                                    animalId={animalToView.id_public}
                                                    API_BASE_URL={API_BASE_URL}
                                                    authToken={authToken}
                                                    onViewAnimal={handleViewAnimal}
                                                />
                                            </div>
                                        )}                    {/* Tab 6: Breeding */}
                    {detailViewTab === 6 && (
                        <div className="space-y-6">
                            {/* 1st Section: Reproductive Status */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🌿 Reproductive Status</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Neutered/Spayed:</span> <strong>{animalToView.isNeutered ? 'Yes' : 'No'}</strong></div>
                                    <div><span className="text-gray-600">Infertile:</span> <strong>{animalToView.isInfertile ? 'Yes' : 'No'}</strong></div>
                                    {!animalToView.isNeutered && !animalToView.isInfertile && (
                                        <div><span className="text-gray-600">In Mating:</span> <strong>{animalToView.isInMating ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {(animalToView.gender === 'Female' || animalToView.gender === 'Intersex' || animalToView.gender === 'Unknown') && !animalToView.isNeutered && (
                                        <>
                                            <div><span className="text-gray-600">Pregnant:</span> <strong>{animalToView.isPregnant ? 'Yes' : 'No'}</strong></div>
                                            <div><span className="text-gray-600">Nursing:</span> <strong>{animalToView.isNursing ? 'Yes' : 'No'}</strong></div>
                                        </>
                                    )}
                                    {animalToView.gender === 'Male' && !animalToView.isNeutered && !animalToView.isInfertile && (
                                        <div><span className="text-gray-600">Stud Animal:</span> <strong>{animalToView.isStudAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                    {animalToView.gender === 'Female' && !animalToView.isNeutered && !animalToView.isInfertile && (
                                        <div><span className="text-gray-600">Breeding Dam:</span> <strong>{animalToView.isDamAnimal ? 'Yes' : 'No'}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* 2nd Section: Estrus/Cycle (Female/Intersex/Unknown only) */}
                            {(animalToView.gender === 'Female' || animalToView.gender === 'Intersex' || animalToView.gender === 'Unknown') && !animalToView.isNeutered && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🔄 Estrus/Cycle</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Heat Status:</span> <strong>{animalToView.heatStatus || ''}</strong></div>
                                        <div><span className="text-gray-600">Last Heat Date:</span> <strong>{animalToView.lastHeatDate ? formatDate(animalToView.lastHeatDate) : ''}</strong></div>
                                        <div><span className="text-gray-600">Ovulation Date:</span> <strong>{animalToView.ovulationDate ? formatDate(animalToView.ovulationDate) : ''}</strong></div>
                                        {(animalToView.species === 'Dog' || animalToView.species === 'Cat') && (
                                            <div><span className="text-gray-600">Estrus Cycle Length:</span> <strong>{animalToView.estrusCycleLength ? `${animalToView.estrusCycleLength} days` : ''}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}


                            {/* 4th Section: Stud Information */}
                            {!animalToView.isNeutered && !animalToView.isInfertile && (animalToView.gender === 'Male' || animalToView.gender === 'Intersex' || animalToView.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♂️ Sire Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Fertility Status:</span> <strong>{animalToView.fertilityStatus || ''}</strong></div>
                                    </div>
                                    {animalToView.fertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animalToView.fertilityNotes}</strong></div>
                                    )}
                                    {(animalToView.species === 'Dog' || animalToView.species === 'Cat') && (
                                        <>
                                            {animalToView.reproductiveClearances && (
                                                <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animalToView.reproductiveClearances}</strong></div>
                                            )}
                                            {animalToView.reproductiveComplications && (
                                                <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animalToView.reproductiveComplications}</strong></div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}

                            {/* 5th Section: Dam Information */}
                            {!animalToView.isNeutered && !animalToView.isInfertile && (animalToView.gender === 'Female' || animalToView.gender === 'Intersex' || animalToView.gender === 'Unknown') && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">♀️ Dam Information</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-gray-600">Dam Fertility Status:</span> <strong>{animalToView.damFertilityStatus || animalToView.fertilityStatus || ''}</strong></div>
                                        {(animalToView.species === 'Dog' || animalToView.species === 'Cat') && (
                                            <>
                                                <div><span className="text-gray-600">Gestation Length:</span> <strong>{animalToView.gestationLength ? `${animalToView.gestationLength} days` : ''}</strong></div>
                                                <div><span className="text-gray-600">Delivery Method:</span> <strong>{animalToView.deliveryMethod || ''}</strong></div>
                                                {animalToView.species === 'Dog' && animalToView.whelpingDate && (
                                                    <div><span className="text-gray-600">Whelping Date:</span> <strong>{formatDate(animalToView.whelpingDate)}</strong></div>
                                                )}
                                                {animalToView.species === 'Cat' && animalToView.queeningDate && (
                                                    <div><span className="text-gray-600">Queening Date:</span> <strong>{formatDate(animalToView.queeningDate)}</strong></div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                    {animalToView.damFertilityNotes && (
                                        <div className="text-sm"><span className="text-gray-600">Notes:</span> <strong className="whitespace-pre-wrap">{animalToView.damFertilityNotes}</strong></div>
                                    )}
                                    {(animalToView.species === 'Dog' || animalToView.species === 'Cat') && (
                                        <>
                                            {animalToView.reproductiveClearances && (
                                                <div className="text-sm"><span className="text-gray-600">Reproductive Clearances:</span> <strong className="whitespace-pre-wrap">{animalToView.reproductiveClearances}</strong></div>
                                            )}
                                            {animalToView.reproductiveComplications && (
                                                <div className="text-sm"><span className="text-gray-600">Reproductive Complications:</span> <strong className="whitespace-pre-wrap">{animalToView.reproductiveComplications}</strong></div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}

                            {/* 6th Section: Breeding History */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="text-blue-600 mr-2">📊</span>Breeding History</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    {(animalToView.gender === 'Male' || animalToView.gender === 'Intersex' || animalToView.gender === 'Unknown') && (
                                        <>
                                            <div><span className="text-gray-600">Last Mating Date:</span> <strong>{animalToView.lastMatingDate ? formatDate(animalToView.lastMatingDate) : ''}</strong></div>
                                            </>
                                    )}
                                    {(animalToView.gender === 'Female' || animalToView.gender === 'Intersex' || animalToView.gender === 'Unknown') && (
                                        <>
                                            <div><span className="text-gray-600">Last Pregnancy Date:</span> <strong>{animalToView.lastPregnancyDate ? formatDate(animalToView.lastPregnancyDate) : ''}</strong></div>
                                            <div><span className="text-gray-600">Litter Count:</span> <strong>{animalToView.litterCount || ''}</strong></div>
                                        </>
                                    )}
                                    <div><span className="text-gray-600">Total Offspring:</span> <strong>{animalToView.offspringCount || ''}</strong></div>
                                </div>
                            </div>
                        </div>
                    )}

                                        {/* Tab 7: Health */}
                                        {detailViewTab === 7 && (
                                            <div className="space-y-6">
                                                {(animalToView.vaccinations || animalToView.dewormingRecords || animalToView.parasiteControl || animalToView.primaryVet) && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">Health Records</h3>
                                                        {animalToView.vaccinations && (
                                                            <div>
                                                                <strong>Vaccinations:</strong>
                                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                    {(() => {
                                                                        const data = animalToView.vaccinations;
                                                                        const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                                        return parsed.map((vacc, idx) => (
                                                                            <li key={idx} className="text-gray-700">
                                                                                {vacc.name} {vacc.date && `(${formatDate(vacc.date)})`}
                                                                                {vacc.notes && <span className="text-gray-600"> - {vacc.notes}</span>}
                                                                            </li>
                                                                        ));
                                                                    })()}
                                                                </ul>
                                                            </div>
                                                        )}
                                                        {animalToView.dewormingRecords && (
                                                            <div>
                                                                <strong>Deworming:</strong>
                                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                    {(() => {
                                                                        const data = animalToView.dewormingRecords;
                                                                        const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                                        return parsed.map((record, idx) => (
                                                                            <li key={idx} className="text-gray-700">
                                                                                {record.medication} {record.date && `(${formatDate(record.date)})`}
                                                                                {record.notes && <span className="text-gray-600"> - {record.notes}</span>}
                                                                            </li>
                                                                        ));
                                                                    })()}
                                                                </ul>
                                                            </div>
                                                        )}
                                                        {animalToView.parasiteControl && (
                                                            <div>
                                                                <strong>Parasite Control:</strong>
                                                                <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                    {(() => {
                                                                        const data = animalToView.parasiteControl;
                                                                        const parsed = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return []; } })() : Array.isArray(data) ? data : [];
                                                                        return parsed.map((record, idx) => (
                                                                            <li key={idx} className="text-gray-700">
                                                                                {record.treatment} {record.date && `(${formatDate(record.date)})`}
                                                                                {record.notes && <span className="text-gray-600"> - {record.notes}</span>}
                                                                            </li>
                                                                        ));
                                                                    })()}
                                                                </ul>
                                                            </div>
                                                        )}
                                                        {animalToView.primaryVet && <div><strong>Primary Vet:</strong> <p className="text-sm mt-1">{animalToView.primaryVet}</p></div>}
                                                    </div>
                                                )}
                                                {(animalToView.medicalConditions || animalToView.allergies || animalToView.medications) && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">Medical Information</h3>
                                                        {animalToView.medicalConditions && (() => {
                                                            const parsed = parseHealthRecords(animalToView.medicalConditions);
                                                            return parsed && parsed.length > 0 ? (
                                                                <div>
                                                                    <strong>Medical Conditions:</strong>
                                                                    <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                        {parsed.map((condition, idx) => (
                                                                            <li key={idx} className="text-gray-700">
                                                                                {condition.condition || condition.name}
                                                                                {condition.notes && <span className="text-gray-600"> - {condition.notes}</span>}
                                                                            </li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            ) : null;
                                                        })()}
                                                        {animalToView.allergies && (() => {
                                                            const parsed = parseHealthRecords(animalToView.allergies);
                                                            return parsed && parsed.length > 0 ? (
                                                                <div>
                                                                    <strong>Allergies:</strong>
                                                                    <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                        {parsed.map((allergy, idx) => (
                                                                            <li key={idx} className="text-gray-700">
                                                                                {allergy.allergen || allergy.name}
                                                                                {allergy.notes && <span className="text-gray-600"> - {allergy.notes}</span>}
                                                                            </li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            ) : null;
                                                        })()}
                                                        {animalToView.medications && (() => {
                                                            const parsed = parseHealthRecords(animalToView.medications);
                                                            return parsed && parsed.length > 0 ? (
                                                                <div>
                                                                    <strong>Medications:</strong>
                                                                    <ul className="text-sm mt-1 list-disc list-inside space-y-1">
                                                                        {parsed.map((med, idx) => (
                                                                            <li key={idx} className="text-gray-700">
                                                                                {med.medication || med.name}
                                                                                {med.notes && <span className="text-gray-600"> - {med.notes}</span>}
                                                                            </li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            ) : null;
                                                        })()}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Tab 8: Husbandry */}
                                        {detailViewTab === 8 && (
                                            <div className="space-y-6">
                                                {(animalToView.dietType || animalToView.feedingSchedule || animalToView.supplements) && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">🍽️ Nutrition</h3>
                                                        {animalToView.dietType && <div><strong>Diet Type:</strong> <p className="text-sm mt-1">{animalToView.dietType}</p></div>}
                                                        {animalToView.feedingSchedule && <div><strong>Feeding Schedule:</strong> <p className="text-sm mt-1">{animalToView.feedingSchedule}</p></div>}
                                                        {animalToView.supplements && <div><strong>Supplements:</strong> <p className="text-sm mt-1">{animalToView.supplements}</p></div>}
                                                    </div>
                                                )}
                                                {(animalToView.housingType || animalToView.bedding || animalToView.enrichment) && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">🧴 Animal Care</h3>
                                                        {animalToView.housingType && <div><strong>Housing Type:</strong> <p className="text-sm mt-1">{animalToView.housingType}</p></div>}
                                                        {animalToView.bedding && <div><strong>Bedding:</strong> <p className="text-sm mt-1">{animalToView.bedding}</p></div>}
                                                        {animalToView.enrichment && <div><strong>Enrichment:</strong> <p className="text-sm mt-1">{animalToView.enrichment}</p></div>}
                                                    </div>
                                                )}
                                                {(animalToView.temperatureRange || animalToView.humidity || animalToView.lighting || animalToView.noise) && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">🌡️ Environment</h3>
                                                        {animalToView.temperatureRange && <div><strong>Temperature Range:</strong> <p className="text-sm mt-1">{animalToView.temperatureRange}</p></div>}
                                                        {animalToView.humidity && <div><strong>Humidity:</strong> <p className="text-sm mt-1">{animalToView.humidity}</p></div>}
                                                        {animalToView.lighting && <div><strong>Lighting:</strong> <p className="text-sm mt-1">{animalToView.lighting}</p></div>}
                                                        {animalToView.noise && <div><strong>Noise Level:</strong> <p className="text-sm mt-1">{animalToView.noise}</p></div>}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Tab 9: Behavior */}
                                        {detailViewTab === 9 && (
                                            <div className="space-y-6">
                                                {(animalToView.temperament || animalToView.handlingTolerance || animalToView.socialStructure || animalToView.activityCycle) && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                                        <h3 className="text-lg font-semibold text-gray-700">Behavior & Welfare</h3>
                                                        {animalToView.temperament && <div><strong>Temperament:</strong> <p className="text-sm mt-1">{animalToView.temperament}</p></div>}
                                                        {animalToView.handlingTolerance && <div><strong>Handling Tolerance:</strong> <p className="text-sm mt-1">{animalToView.handlingTolerance}</p></div>}
                                                        {animalToView.socialStructure && <div><strong>Social Structure:</strong> <p className="text-sm mt-1">{animalToView.socialStructure}</p></div>}
                                                        {animalToView.activityCycle && <div><strong>Activity Cycle:</strong> <p className="text-sm mt-1">{animalToView.activityCycle}</p></div>}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Tab 10: Records */}
                                        {detailViewTab === 10 && (
                                            <div className="space-y-6">
                                                {animalToView.remarks && (
                                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                        <h3 className="text-lg font-semibold text-gray-700 mb-3">Remarks / Notes</h3>
                                                        <p className="text-sm">{animalToView.remarks}</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}                    {/* Tab 11: End of Life */}
                    {detailViewTab === 11 && (
                        <div className="space-y-6">
                            {/* 1st Section: End of Life */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🕊️ Information</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Deceased Date:</span> <strong>{animalToView.deceasedDate ? formatDate(animalToView.deceasedDate) : ''}</strong></div>
                                    <div><span className="text-gray-600">Cause of Death:</span> <strong>{animalToView.causeOfDeath || ''}</strong></div>
                                    <div><span className="text-gray-600">Necropsy Results:</span> <strong>{animalToView.necropsyResults || ''}</strong></div>
                                    {(animalToView.species === 'Dog' || animalToView.species === 'Cat') && animalToView.endOfLifeCareNotes && (
                                        <div><span className="text-gray-600">End of Life Care Notes:</span> <strong className="whitespace-pre-wrap">{animalToView.endOfLifeCareNotes}</strong></div>
                                    )}
                                </div>
                            </div>

                            {/* 2nd Section: Legal/Administrative */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">📋 Legal/Administrative</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><span className="text-gray-600">Insurance:</span> <strong>{animalToView.insurance || ''}</strong></div>
                                    <div><span className="text-gray-600">Legal Status:</span> <strong>{animalToView.legalStatus || ''}</strong></div>
                                </div>
                            </div>

                            {/* 3rd Section: Restrictions (Dog/Cat only) */}
                            {(animalToView.species === 'Dog' || animalToView.species === 'Cat') && (animalToView.breedingRestrictions || animalToView.exportRestrictions) && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🚫 Restrictions</h3>
                                    <div className="space-y-3 text-sm">
                                        {animalToView.breedingRestrictions && (
                                            <div><span className="text-gray-600">Breeding Restrictions:</span> <strong className="whitespace-pre-wrap">{animalToView.breedingRestrictions}</strong></div>
                                        )}
                                        {animalToView.exportRestrictions && (
                                            <div><span className="text-gray-600">Export Restrictions:</span> <strong className="whitespace-pre-wrap">{animalToView.exportRestrictions}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Tab 12: Show */}
                    {detailViewTab === 12 && (
                        <div className="space-y-6">
                            {/* Show Titles & Ratings */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                <h3 className="text-lg font-semibold text-gray-700">🥇 Show Titles & Ratings</h3>
                                <div className="space-y-3 text-sm">
                                    <div><span className="text-gray-600">Titles:</span> <strong>{animalToView.showTitles || ''}</strong></div>
                                    <div><span className="text-gray-600">Ratings:</span> <strong>{animalToView.showRatings || ''}</strong></div>
                                    <div><span className="text-gray-600">Judge Comments:</span> <strong className="whitespace-pre-wrap">{animalToView.judgeComments || ''}</strong></div>
                                </div>
                            </div>

                            {/* Working Titles & Performance - Dog only */}
                            {animalToView.species === 'Dog' && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">🎯 Working & Performance</h3>
                                    <div className="space-y-3 text-sm">
                                        <div><span className="text-gray-600">Working Titles:</span> <strong>{animalToView.workingTitles || ''}</strong></div>
                                        <div><span className="text-gray-600">Performance Scores:</span> <strong>{animalToView.performanceScores || ''}</strong></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                                    {/* Pedigree Chart Modal */}
                                    {showPedigreeChart && animalToView && (
                                        <PedigreeChart
                                            animalData={animalToView}
                                            onClose={() => setShowPedigreeChart(false)}
                                            API_BASE_URL={API_BASE_URL}
                                            authToken={authToken}
                                        />
                                    )}
                                        </div>
                                    </div>
                                </>
                            );
                        })()
                    )
                } />
                <Route path="/hidden-animals" element={
                        <div className="w-full max-w-5xl bg-white p-6 rounded-xl shadow-lg">
                            <div className="flex items-start justify-between mb-6">
                                <button onClick={() => navigate('/')} className="flex items-center text-gray-600 hover:text-gray-800 font-medium">
                                    <ArrowLeft size={20} className="mr-2" />
                                    Back to Dashboard
                                </button>
                            </div>
                            <h2 className="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                                <Archive size={24} className="mr-3 text-gray-600" />
                                Hidden View-Only Animals
                            </h2>
                            {loadingHidden ? (
                                <div className="flex justify-center py-8">
                                    <Loader2 className="animate-spin" size={32} />
                                </div>
                            ) : hiddenAnimals.length === 0 ? (
                                <p className="text-center text-gray-500 py-8">No hidden animals</p>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {hiddenAnimals.map(animal => (
                                        <div key={animal.id_public} className="border border-gray-300 rounded-lg p-4 bg-gray-50">
                                            <div className="flex items-center space-x-3 mb-3">
                                                <div className="w-16 h-16 bg-gray-200 rounded-md overflow-hidden flex-shrink-0">
                                                    {animal.imageUrl || animal.photoUrl ? (
                                                        <img src={animal.imageUrl || animal.photoUrl} alt={animal.name} className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-gray-400">
                                                            <Cat size={32} />
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex-1">
                                                    <h3 className="font-semibold text-gray-800">
                                                        {animal.prefix ? `${animal.prefix} ` : ''}{animal.name}{animal.suffix ? ` ${animal.suffix}` : ''}
                                                    </h3>
                                                    <p className="text-sm text-gray-600">{animal.id_public}</p>
                                                    <p className="text-xs text-gray-500">{animal.species} � {animal.gender}</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => handleRestoreViewOnlyAnimal(animal.id_public)}
                                                    className="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2"
                                                >
                                                    <Eye size={16} />
                                                    Restore
                                                </button>
                                                <button
                                                    onClick={() => handleViewAnimal(animal)}
                                                    className="flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition"
                                                >
                                                    View
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    } />
                </Routes>
            </main>

            <footer className="w-full mt-6 text-center text-sm pt-4 border-t border-gray-200 max-w-5xl">
                <div className="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 mb-2">
                    <button
                        onClick={() => setShowBugReportModal(true)}
                        className="text-gray-600 hover:text-primary transition font-medium flex items-center gap-1"
                    >
                        <AlertCircle size={14} />
                        Report Issue / Bug
                    </button>
                    <span className="hidden sm:inline text-gray-300">|</span>
                    <button
                        onClick={() => setShowTermsModal(true)}
                        className="text-gray-600 hover:text-primary transition"
                    >
                        Terms of Service
                    </button>
                    <span className="hidden sm:inline text-gray-300">|</span>
                    <button
                        onClick={() => setShowPrivacyModal(true)}
                        className="text-gray-600 hover:text-primary transition"
                    >
                        Privacy Policy
                    </button>
                </div>
                <p className="text-gray-500">&copy; {new Date().getFullYear()} CritterTrack Pedigree System.</p>
            </footer>
            
            {showTermsModal && <TermsOfService onClose={() => setShowTermsModal(false)} />}
            {showPrivacyModal && <PrivacyPolicy onClose={() => setShowPrivacyModal(false)} />}
            
            {/* Transfer Animal Modal */}
            {showTransferModal && transferAnimal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <ArrowLeftRight size={24} className="text-blue-600" />
                                Transfer Animal
                            </h2>
                            <button
                                onClick={() => {
                                    setShowTransferModal(false);
                                    setTransferAnimal(null);
                                    setTransferUserQuery('');
                                    setTransferUserResults([]);
                                    setTransferSelectedUser(null);
                                    setTransferSearchPerformed(false);
                                    setTransferPrice('');
                                    setTransferNotes('');
                                }}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <X size={24} />
                            </button>
                        </div>

                        <div className="space-y-4">
                            {/* Animal Info */}
                            <div className="p-3 bg-gray-50 rounded-lg">
                                <p className="text-sm text-gray-600">Transferring:</p>
                                <p className="font-semibold text-gray-800">{transferAnimal.id_public} - {transferAnimal.name}</p>
                            </div>

                            {/* Buyer Search */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Search for Buyer *
                                </label>
                                {transferSelectedUser ? (
                                    <div className="flex items-center justify-between p-2 border border-gray-300 rounded-lg bg-gray-50">
                                        <span className="text-gray-700">
                                            {transferSelectedUser.breederName || transferSelectedUser.personalName}
                                        </span>
                                        <button
                                            onClick={() => {
                                                setTransferSelectedUser(null);
                                                setTransferUserResults([]);
                                            }}
                                            className="text-gray-500 hover:text-red-500"
                                        >
                                            <X className="w-4 h-4" />
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={transferUserQuery}
                                                onChange={(e) => {
                                                    setTransferUserQuery(e.target.value);
                                                    setTransferSearchPerformed(false);
                                                }}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter') {
                                                        e.preventDefault();
                                                        handleSearchTransferUser();
                                                    }
                                                }}
                                                placeholder="Search by name or ID (min 2 chars)..."
                                                className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                            />
                                            <button
                                                onClick={handleSearchTransferUser}
                                                disabled={transferSearching}
                                                className="px-4 py-2 bg-primary text-black rounded-lg hover:bg-primary/90 disabled:opacity-50 flex items-center gap-2"
                                            >
                                                <Search className="w-4 h-4" />
                                                {transferSearching ? 'Searching...' : 'Search'}
                                            </button>
                                        </div>
                                        {transferUserQuery.length >= 2 && transferUserResults.length > 0 && (
                                            <div className="mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                                {transferUserResults.map(user => {
                                                    const hasVisibleBreederName = user.breederName && user.showBreederName;
                                                    const hasVisiblePersonalName = user.personalName && user.showPersonalName;
                                                    
                                                    let displayName;
                                                    if (hasVisibleBreederName && hasVisiblePersonalName) {
                                                        displayName = `${user.personalName} (${user.breederName})`;
                                                    } else if (hasVisibleBreederName) {
                                                        displayName = user.breederName;
                                                    } else {
                                                        displayName = user.personalName;
                                                    }
                                                    
                                                    return (
                                                        <button
                                                            key={user.id_public}
                                                            onClick={() => {
                                                                setTransferSelectedUser(user);
                                                                setTransferUserQuery('');
                                                                setTransferUserResults([]);
                                                            }}
                                                            className="w-full text-left px-4 py-2 hover:bg-gray-100 border-b border-gray-100 last:border-b-0"
                                                        >
                                                            <div className="font-medium">{user.id_public}</div>
                                                            <div className="text-sm text-gray-600">{displayName}</div>
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        )}
                                        {transferSearchPerformed && transferUserResults.length === 0 && !transferSearching && (
                                            <div className="mt-1 p-4 bg-white border border-gray-300 rounded-lg text-center text-gray-500 text-sm">
                                                No users found
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>

                            {/* Price */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Sale Price * ($)
                                </label>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={transferPrice}
                                    onChange={(e) => setTransferPrice(e.target.value)}
                                    placeholder="0.00"
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                    required
                                />
                            </div>

                            {/* Notes */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Notes
                                </label>
                                <textarea
                                    value={transferNotes}
                                    onChange={(e) => setTransferNotes(e.target.value)}
                                    placeholder="Add any additional notes..."
                                    rows={3}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                />
                            </div>

                            {/* Info Box */}
                            <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <Info className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-xs text-blue-800">
                                        <p className="font-semibold mb-1">ℹ️ How Transfer Works</p>
                                        <p>The buyer will receive a notification to accept the transfer. Once accepted, the animal will be transferred to their account and you'll keep view-only access to track lineage.</p>
                                    </div>
                                </div>
                            </div>

                            {/* Buttons */}
                            <div className="flex gap-3 pt-4">
                                <button
                                    onClick={handleSubmitTransfer}
                                    disabled={!transferSelectedUser || !transferPrice}
                                    className="flex-1 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg transition disabled:cursor-not-allowed"
                                >
                                    Send Transfer Request
                                </button>
                                <button
                                    onClick={() => {
                                        setShowTransferModal(false);
                                        setTransferAnimal(null);
                                        setTransferUserQuery('');
                                        setTransferUserResults([]);
                                        setTransferSelectedUser(null);
                                        setTransferSearchPerformed(false);
                                        setTransferPrice('');
                                        setTransferNotes('');
                                    }}
                                    className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Image Modal */}
            {showImageModal && enlargedImageUrl && (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[90] p-4"
                    onClick={() => setShowImageModal(false)}
                >
                    <div className="relative max-w-7xl max-h-full flex flex-col items-center gap-4">
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                setShowImageModal(false);
                            }}
                            className="self-end text-white hover:text-gray-300 transition"
                        >
                            <X size={32} />
                        </button>
                        <img 
                            src={enlargedImageUrl} 
                            alt="Enlarged view" 
                            className="max-w-full max-h-[75vh] object-contain"
                            onClick={(e) => e.stopPropagation()}
                        />
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                handleImageDownload(enlargedImageUrl);
                            }}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition"
                        >
                            <Download size={20} />
                            Download Image
                        </button>
                    </div>
                </div>
            )}
            </div>
        </div>
    );
};

// ==================== PRIVATE ANIMAL SCREEN ====================
// Shown when trying to view a private animal that doesn't have public access
const PrivateAnimalScreen = ({ onBack }) => {
    return (
        <div className="min-h-screen bg-page-bg flex flex-col items-center justify-center p-6">
            <div className="bg-white rounded-xl shadow-lg p-8 max-w-md text-center">
                <Lock size={64} className="text-gray-500 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-gray-800 mb-2">This Animal is Private</h1>
                <p className="text-gray-600 mb-6">
                    This animal doesn't have a public profile available. The owner has not shared this animal publicly.
                </p>
                <button
                    onClick={onBack}
                    className="w-full px-4 py-2 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition"
                >
                    Go Back
                </button>
            </div>
        </div>
    );
};

// Public Animal Page Component
const PublicAnimalPage = () => {
    const { animalId } = useParams();
    const navigate = useNavigate();
    const location = useLocation();
    const [animal, setAnimal] = useState(null);
    const [loading, setLoading] = useState(true);
    const [notFound, setNotFound] = useState(false);
    const [isPrivate, setIsPrivate] = useState(false);
    const [modCurrentContext, setModCurrentContext] = useState(null);
    const [showImageModal, setShowImageModal] = useState(false);
    const [enlargedImageUrl, setEnlargedImageUrl] = useState(null);

    // Check if user is in moderator mode
    const authToken = localStorage.getItem('authToken');
    const inModeratorMode = localStorage.getItem('moderationAuthenticated') === 'true';

    // Determine where to go back to
    const handleGoBack = () => {
        // Check if there's a referrer in location state
        if (location.state?.from) {
            navigate(location.state.from);
        } else {
            // Default to home
            navigate('/');
        }
    };

    const handleImageDownload = async (imageUrl) => {
        try {
            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = `crittertrack-image-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(blobUrl);
        } catch (error) {
            console.error('Failed to download image:', error);
        }
    };

    useEffect(() => {
        const fetchAnimal = async () => {
            try {
                // First try to fetch from public animals
                const response = await axios.get(`${API_BASE_URL}/public/global/animals?id_public=${animalId}`);
                if (response.data?.[0]) {
                    setAnimal(response.data[0]);
                    setLoading(false);
                    return;
                }
                
                // If not found in public, try to fetch from private to determine if it's private or truly not found
                if (authToken) {
                    try {
                        const privateResponse = await axios.get(
                            `${API_BASE_URL}/animals/${animalId}`,
                            { headers: { Authorization: `Bearer ${authToken}` } }
                        );
                        if (privateResponse.data) {
                            // Animal exists but is private
                            setIsPrivate(true);
                            setLoading(false);
                            return;
                        }
                    } catch (error) {
                        // Not found in private either, it's truly not found
                    }
                }
                
                // Truly not found
                setNotFound(true);
                setLoading(false);
            } catch (error) {
                console.error('Animal not found or not public:', error);
                setNotFound(true);
                setLoading(false);
            }
        };
        fetchAnimal();
    }, [animalId]);

    if (loading) {
        return (
            <div className="min-h-screen bg-page-bg flex items-center justify-center p-6">
                <Loader2 className="animate-spin text-primary" size={48} />
            </div>
        );
    }

    if (isPrivate) {
        return (
            <div className="min-h-screen bg-page-bg flex flex-col items-center p-6">
                <header className="w-full max-w-5xl bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                    <CustomAppLogo size="w-10 h-10" />
                    <button
                        onClick={handleGoBack}
                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition"
                    >
                        Home
                    </button>
                </header>
                <PrivateAnimalScreen onBack={handleGoBack} />
            </div>
        );
    }

    if (notFound) {
        return (
            <div className="min-h-screen bg-page-bg flex flex-col items-center justify-center p-6">
                <div className="bg-white rounded-xl shadow-lg p-8 max-w-md text-center">
                    <XCircle size={64} className="text-red-500 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">Animal Not Found</h1>
                    <p className="text-gray-600 mb-6">
                        This animal either doesn't exist or is not publicly visible.
                    </p>
                    <button
                        onClick={handleGoBack}
                        className="w-full px-4 py-2 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition"
                    >
                        Login / Register
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-page-bg flex flex-col items-center p-6">
            <header className="w-full max-w-5xl bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <CustomAppLogo size="w-10 h-10" />
                <button
                    onClick={handleGoBack}
                    className="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition"
                >
                    Home
                </button>
            </header>
            <ViewOnlyAnimalDetail
                animal={animal}
                onClose={handleGoBack}
                onCloseAll={handleGoBack}
                API_BASE_URL={API_BASE_URL}
                authToken={authToken}
                onViewProfile={(user) => navigate(`/user/${user.id_public}`)}
                onViewAnimal={(animal) => navigate(`/animal/${animal.id_public}`)}
                setModCurrentContext={setModCurrentContext}
                setShowImageModal={setShowImageModal}
                setEnlargedImageUrl={setEnlargedImageUrl}
            />
            
            {/* Image Modal */}
            {showImageModal && enlargedImageUrl && (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[90] p-4"
                    onClick={() => setShowImageModal(false)}
                >
                    <div className="relative max-w-7xl max-h-full flex flex-col items-center gap-4">
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                setShowImageModal(false);
                            }}
                            className="self-end text-white hover:text-gray-300 transition"
                        >
                            <X size={32} />
                        </button>
                        <img 
                            src={enlargedImageUrl} 
                            alt="Enlarged view" 
                            className="max-w-full max-h-[75vh] object-contain"
                            onClick={(e) => e.stopPropagation()}
                        />
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                handleImageDownload(enlargedImageUrl);
                            }}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition"
                        >
                            <Download size={20} />
                            Download Image
                        </button>
                    </div>
                </div>
            )}
            
            {/* Moderator Action Sidebar */}
            {inModeratorMode && (
                <ModeratorActionSidebar
                    isActive={true}
                    onOpenReportQueue={() => navigate('/')}
                    onQuickFlag={(flagData) => {
                        console.log('Quick flag from animal page:', flagData);
                    }}
                    onExitModeration={() => {
                        localStorage.removeItem('moderationAuthenticated');
                        navigate('/');
                    }}
                    currentPage={location.pathname}
                    currentContext={modCurrentContext}
                />
            )}
        </div>
    );
};

// Public Profile Page Component
const PublicProfilePage = () => {
    const { userId } = useParams();
    const navigate = useNavigate();
    const [profile, setProfile] = useState(null);
    const [loading, setLoading] = useState(true);
    const [notFound, setNotFound] = useState(false);
    const [showModal, setShowModal] = useState(false);
    const [modalContent, setModalContent] = useState({ title: '', message: '' });

    // Check if user is logged in and in moderator mode
    const authToken = localStorage.getItem('authToken');
    const inModeratorMode = localStorage.getItem('moderationAuthenticated') === 'true';
    const [userProfile, setUserProfile] = useState(null);
    const [modCurrentContext, setModCurrentContext] = useState(null);

    const showModalMessage = (title, message) => {
        setModalContent({ title, message });
        setShowModal(true);
    };

    const handleModQuickFlag = useCallback(async (flagData) => {
        console.log('[MOD ACTION] HANDLER CALLED with:', flagData);
        try {
            console.log('[MOD ACTION] Inside try block');
            console.log('[MOD ACTION] Starting action:', flagData);
            console.log('[MOD ACTION] API_BASE_URL:', API_BASE_URL);
            console.log('[MOD ACTION] authToken:', authToken ? 'present' : 'MISSING');

            // Handle different action types
            if (flagData.action === 'flag') {
                // Create a report for flagged content
                const reportType = flagData.context?.type === 'profile' ? 'profile' : 
                                  flagData.context?.type === 'animal' ? 'animal' : 'message';
                
                // Get the correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                const reportData = {
                    reason: flagData.reason,
                    category: flagData.category,
                    description: `Moderator flag: ${flagData.reason}`,
                    reportedContentId: flagData.context?.id,
                    reportedUserId: userId,
                    isModeratorReport: true
                };

                console.log('[MOD ACTION FLAG] Submitting flag:', { reportType, reportData });

                const response = await axios.post(
                    `${API_BASE_URL}/reports/${reportType}`,
                    reportData,
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION FLAG] Success:', response.data);
                showModalMessage('Flag Submitted', 'Content has been flagged and added to the report queue.');
            } 
            else if (flagData.action === 'edit') {
                // Edit/redact content fields
                const contentType = flagData.context?.type;
                const contentId = flagData.context?.id;
                
                console.log('[MOD ACTION EDIT] Submitting edit:', { contentType, contentId, fieldEdits: flagData.fieldEdits });
                
                const response = await axios.patch(
                    `${API_BASE_URL}/moderation/content/${contentType}/${contentId}/edit`,
                    {
                        fieldEdits: flagData.fieldEdits,
                        reason: flagData.reason
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION EDIT] Success:', response.data);
                showModalMessage('Content Edited', 'Content has been updated successfully.');
                // Refresh the current view
                window.location.reload();
            }
            else if (flagData.action === 'warn') {
                // Warn user - get correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION WARN] Warning user:', { userId, reason: flagData.reason, category: flagData.category });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/warn`,
                    {
                        reason: flagData.reason,
                        category: flagData.category
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION WARN] Success:', response.data);
                showModalMessage('Warning Sent', `User has been warned. Total warnings: ${response.data.warningCount}`);
            }
            else if (flagData.action === 'suspend') {
                // Suspend user - get correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION SUSPEND] Suspending user:', { userId, reason: flagData.reason, durationDays: flagData.durationDays });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/status`,
                    {
                        status: 'suspended',
                        reason: flagData.reason,
                        durationDays: flagData.durationDays
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION SUSPEND] Success:', response.data);
                showModalMessage('User Suspended', `User has been suspended for ${flagData.durationDays} days.`);
            }
            else if (flagData.action === 'ban') {
                // Ban user - get correct user ID based on context type
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION BAN] Banning user:', { userId, reason: flagData.reason, ipBan: flagData.ipBan });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/status`,
                    {
                        status: 'banned',
                        reason: flagData.reason,
                        ipBan: flagData.ipBan
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION BAN] Success:', response.data);
                showModalMessage('User Banned', 'User has been permanently banned.');
            }
            else if (flagData.action === 'lift-warning') {
                // Lift warning from user
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION LIFT_WARNING] Lifting warning for user:', { userId, reason: flagData.reason, warningIndex: flagData.warningIndex });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/lift-warning`,
                    {
                        reason: flagData.reason,
                        warningIndex: flagData.warningIndex
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION LIFT_WARNING] Success:', response.data);
                showModalMessage('Warning Lifted', `User's warning count is now ${response.data.warningCount}.`);
            }
            else if (flagData.action === 'lift-suspension') {
                // Lift suspension from user
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION LIFT_SUSPENSION] Lifting suspension for user:', { userId, reason: flagData.reason });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/status`,
                    {
                        status: 'active',
                        reason: flagData.reason
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION LIFT_SUSPENSION] Success:', response.data);
                showModalMessage('Suspension Lifted', 'User account has been reactivated and can now log in.');
            }
            else if (flagData.action === 'lift-ban') {
                // Lift ban from user
                const userId = flagData.context?.type === 'profile' 
                    ? flagData.context?.userId 
                    : flagData.context?.ownerId;
                
                console.log('[MOD ACTION LIFT_BAN] Lifting ban for user:', { userId, reason: flagData.reason });
                
                const response = await axios.post(
                    `${API_BASE_URL}/moderation/users/${userId}/status`,
                    {
                        status: 'active',
                        reason: flagData.reason
                    },
                    { headers: { Authorization: `Bearer ${authToken}` } }
                );

                console.log('[MOD ACTION LIFT_BAN] Success:', response.data);
                showModalMessage('Ban Lifted', 'User account has been unbanned and can now log in.');
            }
        } catch (error) {
            console.error('[MOD ACTION] ERROR OCCURRED:', {
                message: error.message,
                status: error.response?.status,
                statusText: error.response?.statusText,
                errorData: error.response?.data,
                errorResponse: error.response,
                fullError: error
            });
            
            // Extract error message for user feedback
            const errorMsg = error.response?.data?.message 
                || error.response?.data?.error 
                || error.message 
                || 'An error occurred while performing this action.';
            
            console.error('[MOD ACTION] Showing error message to user:', errorMsg);
            showModalMessage('Action Failed', errorMsg);
        }
    }, [authToken]);


    useEffect(() => {
        // Fetch current user profile if authenticated
        const fetchUserProfile = async () => {
            if (authToken) {
                try {
                    const response = await axios.get(`${API_BASE_URL}/users/profile`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    setUserProfile(response.data);
                } catch (error) {
                    console.error('Error fetching user profile:', error);
                }
            }
        };
        fetchUserProfile();
    }, [authToken]);

    useEffect(() => {
        const fetchProfile = async () => {
            try {
                const response = await axios.get(`${API_BASE_URL}/public/profile/${userId}`);
                setProfile(response.data);
                setLoading(false);
            } catch (error) {
                console.error('Profile not found or not public:', error);
                setNotFound(true);
                setLoading(false);
            }
        };
        fetchProfile();
    }, [userId]);

    if (loading) {
        return (
            <div className="min-h-screen bg-page-bg flex items-center justify-center p-6">
                <Loader2 className="animate-spin text-primary" size={48} />
            </div>
        );
    }

    if (notFound) {
        return (
            <div className="min-h-screen bg-page-bg flex flex-col items-center justify-center p-6">
                <div className="bg-white rounded-xl shadow-lg p-8 max-w-md text-center">
                    <XCircle size={64} className="text-red-500 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">Profile Not Found</h1>
                    <p className="text-gray-600 mb-6">
                        This profile either doesn't exist or is not publicly visible.
                    </p>
                    <button
                        onClick={() => navigate('/')}
                        className="w-full px-4 py-2 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition"
                    >
                        {authToken ? 'Go to Dashboard' : 'Login / Register'}
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-page-bg flex flex-col items-center p-6">
            <header className="w-full max-w-5xl bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <CustomAppLogo size="w-10 h-10" />
                <button
                    onClick={() => navigate('/')}
                    className="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition"
                >
                    {authToken ? 'Dashboard' : 'Home'}
                </button>
            </header>
            <PublicProfileView
                profile={profile}
                onBack={() => navigate('/')}
                onViewAnimal={(animal) => navigate(`/animal/${animal.id_public}`, { state: { from: `/user/${userId}` } })}
                API_BASE_URL={API_BASE_URL}
                authToken={authToken}
                setModCurrentContext={setModCurrentContext}
                onStartMessage={authToken ? () => {
                    // Navigate to dashboard with message param to open conversation
                    navigate(`/?message=${profile.id_public}`);
                } : null}
            />
            
            {/* Moderator Action Sidebar - Shows if user is authenticated moderator */}
            {inModeratorMode && localStorage.getItem('moderationAuthenticated') === 'true' && (
                <ModeratorActionSidebar
                    isActive={true}
                    onOpenReportQueue={() => navigate('/')}
                    onQuickFlag={(flagData) => {
                        console.log('Quick flag from public route:', flagData);
                        handleModQuickFlag(flagData);
                    }}
                    onExitModeration={() => {
                        localStorage.removeItem('moderationAuthenticated');
                        window.location.href = '/';
                    }}
                    currentPage={window.location.pathname}
                    currentContext={modCurrentContext}
                    API_BASE_URL={API_BASE_URL}
                    authToken={authToken}
                />
            )}
            
            {/* Modal for moderation action feedback */}
            {showModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">{modalContent.title}</h2>
                        <p className="text-gray-600 mb-6">{modalContent.message}</p>
                        <button
                            onClick={() => setShowModal(false)}
                            className="w-full px-4 py-2 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition"
                        >
                            OK
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

// Router Wrapper Component
const AppRouter = () => {
    // MAINTENANCE MODE LOCK - Only allow access from admin IP
    const [clientIp, setClientIp] = useState(null);

    useEffect(() => {
        const getClientIp = async () => {
            try {
                const response = await axios.get(`${API_BASE_URL}/client-ip`);
                const detectedIp = response.data.ip || response.data.clientIp;
                setClientIp(detectedIp);
                console.log('Backend detected IP:', detectedIp);
            } catch (error) {
                console.warn('Could not determine IP');
                setClientIp('unknown');
            }
        };
        getClientIp();
    }, []);

    // LOCK DOWN: Only allow 86.80.92.156 OR with admin token
    const ADMIN_IP = '86.80.92.156';
    const ADMIN_TOKEN = localStorage.getItem('crittertrack_admin_token');
    const isAdminIP = clientIp === ADMIN_IP;
    const hasAdminToken = ADMIN_TOKEN === 'emergency_access_jan5_2025_secure';
    
    console.log('Access check:', { clientIp, isAdminIP, ADMIN_IP, hasAdminToken });
    
    // If not admin IP and no token, show maintenance screen
    // DISABLED - Allow everyone to access for testing
    if (false && clientIp && !isAdminIP && !hasAdminToken) {
        return <MaintenanceMode />;
    }
    
    // If still checking IP, show loading or maintenance screen
    // DISABLED - Allow everyone to access for testing
    if (false && !clientIp) {
        return <MaintenanceMode />;
    }

    return (
        <>
            <Routes>
                <Route path="/animal/:animalId" element={<PublicAnimalPage />} />
                <Route path="/user/:userId" element={<PublicProfilePage />} />
                <Route path="/*" element={<App />} />
            </Routes>
        </>
    );
};



export default AppRouter;





